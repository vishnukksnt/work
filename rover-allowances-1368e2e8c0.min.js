sntRover.controller("rvAllowancesCtrl",["$scope","RVBillCardSrv","ngDialog",function(e,t,n){BaseCtrl.call(this,e,n),e.keys=Object.keys,e.isActivitiesTabOpen=!0,e.isGroupedByDate=!0,e.shareQuery={query:""},e.shareData=[],e.filteredShareData=[],e.selectedRooms=[],e.groupedSelectedRooms={},e.sharedAllowances={},e.statusMap={RESERVED:"arrival",PRE_CHECKIN:"pre-check-in",CHECKEDIN:"check-in",CHECKEDOUT:"check-out",NOSHOW:"",CANCELED:"cancel"},e.errorMessage="",e.successMessage="",e.toggleGrouping=function(){e.isGroupedByDate=!e.isGroupedByDate},e.switchTab=function(){e.isActivitiesTabOpen=!e.isActivitiesTabOpen,e.isActivitiesTabOpen||e.onQueryUpdate()},e.closeDialog=function(){n.close()},e.filterShareData=function(){try{e.filteredShareData=_.filter(e.shareData,function(t){return!e.hasAllAllowancesShared(t)})}catch(e){console.error(e)}},e.hasAllAllowancesShared=function(t){const n=e.selectedRooms.find(function(e){return e.id===t.id});if(!n)return!1;const r=_.filter(n.allowances,function(e){return e.checked===!0}).length;return r===t.allowances_count},e.toggleCheckedRoom=function(t,n){var r=_.findIndex(e.selectedRooms,function(e){return e.id===t}),i=_.findIndex(e.selectedRooms[r].allowances,function(e){return e.id===n});e.selectedRooms[r].allowances[i].checked=!e.selectedRooms[r].allowances[i].checked},e.isRoomChecked=function(t,n){var r=_.findIndex(e.selectedRooms,function(e){return e.id===t}),i=_.findIndex(e.selectedRooms[r].allowances,function(e){return e.id===n});return e.selectedRooms[r].allowances[i]&&e.selectedRooms[r].allowances[i].checked},e.saveSharing=function(){e.error="";var n=_.flatten(_.map(e.selectedRooms,function(e){return{id:e.id,allowances:_.filter(e.allowances,function(e){return e.checked})}})),r=_.map(n,function(e){return{to_reservation_id:e.id,allowances:_.map(e.allowances,function(e){return{id:e.id,name:e.name,description:e.description}})}}),i={shared_allowances:r};e.callAPI(t.saveAllowanceShares,{params:{reservationId:e.reservationBillData.reservation_id,data:i},successCallBack:function(t){return t.errors.length?void e.errorMessage.response.errors.join(". "):(e.onQueryUpdate(),void(t.data.length&&(e.successMessage=t.data)))},failureCallBack:function(t){e.errorMessage=t}})},e.onSelectRoom=function(t,n){const r=angular.copy(t);if(n)n.preventDefault(),n.stopImmediatePropagation(),e.selectedRooms=_.filter(e.selectedRooms,function(e){return e.id!==t.id}),r.allowances=_.map(r.allowances,function(e){return e.checked=!0,e});else{const i=_.map(r.shared_allowances,function(e){return e.allowances});r.allowances=_.map(_.flatten(i),function(e){return e.checked=!0,e})}e.selectedRooms.push(r);var a;try{a=n?_.map(e.selectedRooms,function(e){var t=e.allowances;return _.each(e.allowances,function(n,r){t[r].id=n.id,t[r].room_id=e.id,t[r].firstname=e.firstname,t[r].lastname=e.lastname,t[r].room=e.room,t[r].reservation_status=e.reservation_status.value}),t}):_.map(e.selectedRooms,function(e){var n=_.flatten(_.map(e.shared_allowances,function(e){return e.allowances}));return _.each(n,function(r,i){n[i].id=r.id,n[i].room_id=t.id,n[i].firstname=e.firstname,n[i].lastname=e.lastname,n[i].room=e.room,n[i].reservation_status=e.reservation_status.value,n[i].checked=!0}),n}),e.groupedSelectedRooms=_.groupBy(_.flatten(a),function(e){return e.id})}catch(e){console.error(e)}return e.filterShareData(),!1},e.onQueryUpdate=function(){e.callAPI(t.searchAllowanceShares,{params:{reservationId:e.reservationBillData.reservation_id,query:e.shareQuery.query},successCallBack:function(t){e.selectedRooms=[],e.shareData=t.results,e.filterShareData(),_.each(t.results,function(t){t.shared_allowances.length>0&&e.onSelectRoom(t)});const n=_.map(t.results,function(e){var t=_.flatten(_.map(e.shared_allowances,function(e){return e.allowances}));return _.each(t,function(n,r){t[r].id=n.id,t[r].room_id=e.id,t[r].firstname=e.firstname,t[r].lastname=e.lastname,t[r].room=e.room,t[r].reservation_status=e.reservation_status.value,t[r].checked=!0}),t});try{e.groupedSelectedRooms=_.groupBy(_.flatten(n),function(e){return e.id}),e.successMessage=""}catch(e){console.error(e)}},failureCallBack:function(t){e.errorMessage=t,e.groupedAllowanceData=!1,e.sharedData=[]}})},e.debounceQueryUpdate=_.debounce(e.onQueryUpdate,500),e.onQueryUpdate()}]),angular.module("sntRover").service("RVBillCardSrv",["$http","$q","BaseWebSrvV2","RVBaseWebSrv","rvBaseWebSrvV2","sntBaseWebSrv","RVGAHelperSrv",function(e,t,n,r,i,a,o){var s=this;this.fetchReservationBillData=function(e){var n=t.defer(),r="/api/reservations/"+e+"/bills_summary";return i.getJSON(r).then(function(e){n.resolve(e.data)},function(e){n.reject(e)}),n.promise},this.fetchAllowanceData=function(e,t,n){var r="/api/bills/"+t+"/allowance_transactions";return i.getJSON(r).then(function(t){t.allowance_data&&t.allowance_data.allowance_entries&&t.allowance_data.allowance_entries.length&&(_.each(t.allowance_data.allowance_entries,function(e,n){e.entriesForTheDate=_.filter(t.allowance_data.allowance_entries,function(t){return t.date===e.date}),e.amount=e.amount?parseFloat(e.amount):e.amount}),n.allowance_data=t.allowance_data),e.resolve(n)},function(t){e.reject(t)}),e.promise},this.fetchReservationAllowanceTransactions=function(e){const t="/api/reservations/"+e+"/allowance_transactions";return i.getJSON(t).then(function(e){var t={dataByAllowance:[],dataByDate:[]};return e.allowance_data&&e.allowance_data.allowance_entries&&e.allowance_data.allowance_entries.length&&(t.dataByAllowance=_.groupBy(e.allowance_data.allowance_entries,function(e){return e.addon_id}),t.dataByDate=_.groupBy(e.allowance_data.allowance_entries,function(e){return e.date})),t.amount=e.allowance_data.amount,t},function(){})},this.searchAllowanceShares=function(e){var n=t.defer(),r="/api/reservations/"+e.reservationId+"/search_reservations_for_allowance_share";return i.getJSON(r,{query:e.query}).then(function(e){n.resolve(e.data)},function(e){n.reject(e)}),n.promise},this.saveAllowanceShares=function(e){var r=t.defer(),i="/api/reservations/"+e.reservationId+"/route_allowance";return n.postJSON(i,e.data).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.fetchBillData=function(e){var n=t.defer(),r="/api/bills/"+e;return i.getJSON(r).then(function(e){n.resolve(e.data)},function(e){n.reject(e)}),n.promise},this.fetch=function(e){var n="",r=t.defer(),i="",a="";return t.when().then(function(){return s.fetchReservationBillData(e).then(function(e){n=e})}).then(function(){return i=n.bills[0].bill_id,a=parseInt(n.bills[0].bill_number)-1,s.fetchBillData(i).then(function(e){n.bills[a]=e})}).then(function(){n.groupedAllowances={},r.resolve(n)},function(e){r.reject(e)}),r.promise},this.fetchBillPrintData=function(e){var n=t.defer(),i="staff/bills/print_guest_bill";return r.postJSON(i,e).then(function(e){e.charge_details_list=[],angular.forEach(e.fee_details,function(t,n){angular.forEach(t.charge_details,function(n){n.date=t.date,n.isCredit=!1,e.charge_details_list.push(n)}),angular.forEach(t.credit_details,function(n){n.date=t.date,n.isCredit=!0,e.charge_details_list.push(n)})}),n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchRegistrationCardPrintData=function(e){var n=t.defer(),r="/api/registration_cards/"+e.reservation_id;return i.getJSON(r,e).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.movetToAnotherBill=function(e){var r=t.defer(),i="/staff/bills/transfer_transaction";return n.postJSON(i,e).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.setBillAddressType=function(e){var r=t.defer(),i="/api/bills/"+e.bill_id+"/save_address_type";return n.postJSON(i,e.parmasToApi).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.completeCheckin=function(e){var n=t.defer(),i="/staff/checkin";return r.postJSON(i,e).then(function(t){o.sendEventToGA("CHECKIN",e.reservation_id),n.resolve(t)},function(e){n.reject(e)}),n.promise},this.completeCheckout=function(e){var n=t.defer(),i="/staff/checkout";return r.postJSON(i,e).then(function(t){o.sendEventToGA("CHECKOUT",e.reservation_id),n.resolve(t)},function(e){n.reject(e)}),n.promise},this.getAdvanceBill=function(e){var n=t.defer(),i="api/reservations/"+e.id+"/advance_bill";return r.postJSON(i).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.transactionEdit=function(e){var r=t.defer(),i="api/financial_transactions/"+e.id;return n.putJSON(i,e.updatedData).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.transactionEditChargeDescription=function(e){var r=t.defer(),i="api/financial_transactions/"+e.id+"/save_custom_description";return n.postJSON(i,e.postData).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.transactionDelete=function(e){var r=t.defer(),i=e.id,a="api/financial_transactions/"+i;return n.putJSON(a,e.data).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.transactionSplit=function(e){var r=t.defer(),i=e.id,a="api/financial_transactions/"+i;return n.putJSON(a,e.data).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.fetchChargeCodes=function(){var e=t.defer(),r="/api/charge_codes?exclude_payments=true&per_page=1000";return n.getJSON(r).then(function(t){e.resolve(t)},function(t){e.reject(t)}),e.promise},this.fetchAdjustmentReasons=function(){var e=t.defer(),r="/admin/force_adjustment_reasons";return n.getJSON(r).then(function(t){e.resolve(t)},function(t){e.reject(t)}),e.promise},this.sendEmail=function(e){var r=t.defer(),i="api/reservations/email_guest_bill.json";return n.postJSON(i,e).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.createAnotherBill=function(e){var r=t.defer(),i="/api/bills/create_bill";return n.postJSON(i,e).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.changeHousekeepingStatus=function(e){var r=t.defer(),i="/house/change_house_keeping_status.json";return n.postJSON(i,e).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.completeReverseCheckout=function(e){var r=t.defer(),i="/staff/reverse_checkout";return n.postJSON(i,e).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.toggleHideRate=function(e){var r=t.defer(),i="api/reservations/"+e.reservation_id+"/hide_rates";return n.postJSON(i,e).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.getBillSettingsInfo=function(e){var r=t.defer(),i="/api/bills/get_settings_info";return n.getJSON(i,e).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.groupChargeDetailsFetch=function(e){var r=t.defer(),i="/staff/reservation/transaction_details";return n.getJSON(i,e).then(function(e){r.resolve(e.data)},function(e){r.reject(e)}),r.promise},this.hideBill=function(e){var r=t.defer(),i="/api/bills/"+e.bill_id+"/hide_bill";return n.postJSON(i).then(function(e){r.resolve(e.data)},function(e){r.reject(e)}),r.promise},this.fetchGuestLanguages=function(e){var n=t.defer(),r="/api/guest_languages";return i.getJSON(r,e).then(function(e){e.languages&&(e.languages=_.filter(e.languages,{is_show_on_guest_card:!0})),n.resolve(e)},function(e){n.reject(e)}),n.promise},this.callBlackBoxApi=function(e){var r=t.defer(),i="/api/hotel_settings/infrasec/generate_control_code";return n.postJSON(i,e).then(function(e){r.resolve(e.data)},function(e){r.reject(e)}),r.promise},this.generateFolioNumber=function(e){var r=t.defer(),i="/api/bills/"+e.bill_id+"/generate_folio_number";return n.postJSON(i,e).then(function(e){r.resolve(e.data)},function(e){r.reject(e)}),r.promise},this.generateVoidBill=function(e){var r=t.defer(),i="/api/bills/"+e.bill_id+"/void_bill";return n.postJSON(i,e.data).then(function(e){r.resolve(e.data)},function(e){r.reject(e)}),r.promise},this.settleFinalInvoice=function(e){var r=t.defer(),i="/api/bills/"+e.bill_id+"/final_invoice_settlement";return n.postJSON(i,e).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.printReceiptData=function(e){var n=t.defer(),r="/api/bills/"+e.bill_id+"/print_payment_receipt";return a.postJSON(r,e).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.emailReceiptData=function(e){var n=t.defer(),r="/api/bills/"+e.bill_id+"/email_payment_receipt";return a.postJSON(r,e).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise}}]),angular.module("sntRover").service("RVBillinginfoSrv",["$http","$q","BaseWebSrvV2","RVBaseWebSrv",function(e,t,n,r){this.fetchRoutes=function(e){var r=t.defer(),i="api/bill_routings/"+e+"/attached_entities";return n.getJSON(i).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.fetchAttachedCards=function(e){var r=t.defer(),i="api/bill_routings/"+e+"/attached_cards";return n.getJSON(i).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.fetchAvailableBillingGroups=function(e){var r=t.defer(),i="api/bill_routings/billing_groups?id="+e.id+"&to_bill="+e.to_bill+"&is_new="+e.is_new;return e.from_date&&(i=i+"&from_date="+e.from_date),e.to_date&&(i=i+"&to_date="+e.to_date),n.getJSON(i).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.fetchAvailableChargeCodes=function(e){var r=t.defer(),i="api/bill_routings/charge_codes?id="+e.id+"&to_bill="+e.to_bill+"&is_new="+e.is_new;return e.from_date&&(i=i+"&from_date="+e.from_date),e.to_date&&(i=i+"&to_date="+e.to_date),n.getJSON(i).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.fetchAllBillingGroups=function(){var e=t.defer(),r="/api/bill_routings/billing_groups?is_default_routing=true";return n.getJSON(r).then(function(t){e.resolve(t)},function(t){e.reject(t)}),e.promise},this.fetchAllChargeCodes=function(){var e=t.defer(),r="/api/bill_routings/charge_codes?is_default_routing=true";return n.getJSON(r).then(function(t){e.resolve(t)},function(t){e.reject(t)}),e.promise},this.fetchBillsForReservation=function(e){var r=t.defer(),i="api/bill_routings/"+e.id+"/bills.json";return""!==e.entity_type&&(i="api/bill_routings/"+e.id+"/bills.json?entity_type="+e.entity_type),n.getJSON(i).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.saveRoute=function(e){var r=t.defer(),i="api/bill_routings/save_routing";return n.postJSON(i,e).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.saveDefaultAccountRouting=function(e){var r=t.defer(),i="api/default_account_routings/save";return n.postJSON(i,e).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.saveAllotmentDefaultAccountRouting=function(e){var r=t.defer(),i="api/default_account_routings/save_allotment_default_billing_info";return n.postJSON(i,e).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.deleteRoute=function(e){var r=t.defer(),i="api//bill_routings/delete_routing";return n.postJSON(i,e).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.fetchDefaultAccountRouting=function(e){var r=t.defer(),i="undefined"!=typeof e.entity_type&&""!==e.entity_type?"/api/default_account_routings/"+e.id+"?entity_type="+e.entity_type:"/api/default_account_routings/"+e.id;return n.getJSON(i).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.deleteDefaultRouting=function(e){var r=t.defer(),i="api/default_account_routings/"+e.id;return n.deleteJSON(i).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise}}]),angular.module("sntRover").service("RVMoveChargeSrv",["$http","$q","BaseWebSrvV2",function(e,t,n){this.fetchSearchedItems=function(e){var r=t.defer(),i="/api/bills/search_for_associated?search_by_no="+e.number_search+"&search_by_name="+e.text_search+"&bill_id="+e.bill_id;return n.getJSON(i).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.moveChargesToTargetEntity=function(e){var r=t.defer(),i="/api/bills/move_txn_diff_accounts";return n.postJSON(i,e).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise}}]);