"use strict";angular.module("sntRover").controller("searchCompanyCardController",["$scope","RVCompanyCardSearchSrv","$stateParams","ngDialog","$timeout","RVCompanyCardSrv","$state","rvPermissionSrv",function(e,t,a,r,n,i,o,s){var c=null,d={ALL:"ALL",AR_ONLY:"AR_ONLY"},l="company_card_scroll",u=50;BaseCtrl.call(this,e),e.heading="Find Cards",e.hasArNumber=!1,e.$emit("updateRoverLeftMenu","cards");var m=function(){c&&c.selectedIds&&c.selectedIds.length>0&&e.results.forEach(function(t){var a=_.find(c.selectedIds,{id:t.id});a&&(t.selected=!0,t.isPrimary=a.isPrimary,t.isPrimary&&(e.viewState.selectedPrimaryCard=t))}),c=null},p=function(){e.viewState.selectedCardsForMerge.length>0&&e.results.forEach(function(t){var a=_.find(e.viewState.selectedCardsForMerge,{id:t.id});a&&(t.selected=!0,t.isPrimary=a.isPrimary,t.isPrimary&&(e.viewState.selectedPrimaryCard=t))})},f={tap:!0,preventDefault:!1,deceleration:1e-4,shrinkScrollbars:"clip"};e.setScroller(l,f);var v=function(){e.myScroll&&e.myScroll.hasOwnProperty(l)&&e.myScroll[l].scrollTo(0,0,100),n(function(){e.refreshScroller(l)},300)};e.escapeNull=function(e,t){var a="";"undefined"!=typeof t&&null!==t&&(a=t);var r=null===e||"undefined"==typeof e?a:e;return r};var C=600;e.queryEntered=_.debounce(function(){e.textInQueryBox.length<3?(e.results=[],v()):g();var t=e.textInQueryBox;e.textInQueryBox=t.charAt(0).toUpperCase()+t.slice(1)},C),e.clearResults=function(){e.textInQueryBox="",e.results=[]};var y=function(){var t={query:e.textInQueryBox.trim(),per_page:e.perPage,page:e.page};return t.has_ar_number=!1,e.cardFilter===d.AR_ONLY&&(t.has_ar_number=!0),e.viewState.isViewSelected||(t.account_type="COMPANY",e.viewState.isCompanyCardSelected||(t.account_type="TRAVELAGENT")),t};e.search=function(a){e.page=a||1,e.errorMessage="";var r={params:y(),successCallBack:h,failureCallBack:S};e.callAPI(t.fetch,r)};var h=function(t){e.results=t.accounts,m(),p(),e.totalResultCount=t.total_count,n(function(){e.$broadcast("updatePagination","COMPANYCARD_SEARCH"),v()},800)},S=function(t){e.errorMessage=t},g=function(){if(e.textInQueryBox.length){for(var t="",a=0,r=0;r<e.results.length;r++)t=e.results[r],e.escapeNull(t.account_first_name).toUpperCase().indexOf(e.textInQueryBox.toUpperCase())>=0||e.escapeNull(t.account_last_name).toUpperCase().indexOf(e.textInQueryBox.toUpperCase())>=0?(e.results[r].is_row_visible=!0,a++):e.results[r].is_row_visible=!1;0===a&&e.search(),v()}else{for(var r=0;r<e.results.length;r++)e.results[r].is_row_visible=!0;v()}};e.addNewCard=function(){r.open({template:"/assets/partials/companyCard/rvSelectCardType.html",controller:"selectCardTypeCtrl",className:"ngdialog-theme-default1 calendar-single1",closeByDocument:!1,scope:e})},a.textInQueryBox&&(e.textInQueryBox=a.textInQueryBox,e.queryEntered()),e.onViewChange=function(){e.viewState.isViewSelected||(e.viewState.isCompanyCardSelected=!0),e.$broadcast("RESET_SELECTIONS_FOR_MERGE"),e.viewState.canMerge=null,e.queryEntered()},e.onCardSelection=function(t){if(0===e.viewState.selectedCardsForMerge.length&&t.selected&&(t.isPrimary=!0,e.viewState.selectedPrimaryCard=t),t.selected)e.viewState.selectedCardsForMerge.push(t);else{var a=t.isPrimary;e.viewState.selectedCardsForMerge=_.reject(e.viewState.selectedCardsForMerge,function(r){return r.id===t.id&&(t.isPrimary=!1,a&&(e.viewState.selectedPrimaryCard={})),r.id===t.id}),a&&e.viewState.selectedCardsForMerge.length>0&&(e.viewState.selectedCardsForMerge[0].isPrimary=!0,e.viewState.selectedPrimaryCard=e.viewState.selectedCardsForMerge[0])}e.$broadcast("REFRESH_SELECTED_CARDS_FOR_MERGE_SCROLLER")},e.onTravelAgentCompanyCardSwitch=function(){e.$broadcast("RESET_SELECTIONS_FOR_MERGE"),e.results=[],e.viewState.canMerge=null,e.queryEntered()},e.navigateToDetails=function(t,a){return!e.viewState.hasInitiatedMergeVerification&&void o.go("rover.companycarddetails",{id:t,type:a,query:e.textInQueryBox,selectedIds:e.viewState.selectedCardsForMerge||[],isMergeViewSelected:!e.viewState.isViewSelected,activeSubView:e.viewState.isCompanyCardSelected?"CC":"TA",cardType:e.cardFilter})};var D="";e.getRateName=function(){return D},e.ratesCount=function(e){var t=!1;return e.current_contracts&&0!==e.current_contracts.length&&angular.forEach(e.current_contracts,function(e){0!==e.contract_rates.length&&(t+=e.contract_rates.length,D=e.contract_rates[0].rate_name)}),t},e.getStyleClasses=function(){var t="";return!e.viewState.isViewSelected&&(e.results.length>0||e.viewState.selectedCardsForMerge.length>0)&&(t="show-merge"),t};var A=function(){e.textInQueryBox="",e.results=[],e.cardFilter=d.ALL,e.viewState={isViewSelected:!0,isCompanyCardSelected:!0,selectedCardsForMerge:[],selectedPrimaryCard:{},mergeStatusText:"",hasInitiatedMergeVerification:!1,mergeStatusErrors:{}},c=o.transition&&o.transition.params("from"),c&&c.isMergeViewSelected&&(e.viewState.isViewSelected=!c.isMergeViewSelected,e.textInQueryBox=c.query,e.viewState.isCompanyCardSelected="CC"===c.activeSubView,e.cardFilter=c.cardType,e.viewState.selectedCardsForMerge=c.selectedIds,e.queryEntered()),e.hasMergeViewPermission=s.getPermissionValue("MERGE"),e.perPage=u,e.companyCardSearchPagination={id:"COMPANYCARD_SEARCH",api:e.search,perPage:e.perPage},e.hasCompanyCardCreatePermission=s.getPermissionValue("CREATE_COMPANY_CARD"),e.hasTravelAgentCreatePermission=s.getPermissionValue("CREATE_TRAVEL_AGENT_CARD")};A()}]),angular.module("sntRover").controller("selectCardTypeCtrl",["$scope","dateFilter","ngDialog",function(e,t,a){BaseCtrl.call(this,e)}]),sntRover.controller("RVAccountReceivableMessagePopupCtrl",["$rootScope","$scope","$state","ngDialog","$timeout","RVCompanyCardSrv","rvPermissionSrv",function(e,t,a,r,n,i,o){BaseCtrl.call(this,t),t.isCreateNewARAccountMode=!1,t.data={},t.isCreateButtonDisabled=!1,t.createAccountAction=function(){if("undefined"!=typeof t.reservationBillData&&"true"===t.reservationBillData.is_auto_assign_ar_numbers||"undefined"!=typeof t.is_auto_assign_ar_numbers&&t.is_auto_assign_ar_numbers){var e=!0;t.createAccountReceivable(e)}else t.isCreateNewARAccountMode=!0},t.successCreate=function(a){"undefined"!=typeof t.reservationBillData&&(t.reservationBillData.ar_number=a.ar_number,t.reservationBillData.bills[t.currentActiveBill].ar_number=a.ar_number,t.reservationBillData.bills[t.currentActiveBill].has_ar_account=!0),r.close(),n(function(){e.$emit("arAccountCreated")},500)},t.failureCreate=function(e){t.$emit("hideLoader"),t.errorMessage=e,t.isCreateButtonDisabled=!1,"Please complete required AR Account Information"===t.errorMessage[0]&&(t.isCreateButtonDisabled=!0)},t.createAccountReceivable=function(e){var a={id:t.reservationBillData.bills[t.currentActiveBill].account_id,ar_number:e?"":t.data.ar_number};t.invokeApi(i.saveARDetails,a,t.successCreate,t.failureCreate)},t.closeDialog=function(){r.close()},t.cancelButtonClick=function(){t.errorMessage="",t.isCreateNewARAccountMode=!1},t.hasPermissionToCreateArAccount=function(){return o.getPermissionValue("CREATE_AR_ACCOUNT")}}]),sntRover.controller("RVAddPaymentMethodCrtl",["$scope","$rootScope",function(e,t){}]),sntRover.controller("RVPaymentCompanyCardCtrl",["$rootScope","$scope","$state","RVPaymentSrv","RVCompanyCardSrv","ngDialog",function(e,t,a,r,n,i){BaseCtrl.call(this,t),t.$on("clearNotifications",function(){t.errorMessage="",t.successMessage=""});var o={data:[],paymentTypes:[]};t.paymentData=o,t.updateErrorMessage=function(e){t.errorMessage=e},t.openAddNewPaymentModel=function(){t.callAPI(r.renderPaymentScreen,{params:{direct_bill:!1},onSuccess:function(e){var a=_.find(e,function(e){return"CC"===e.name}),r={fromView:"companyTravelAgent",isFromWallet:!0,accountId:t.contactInformation.id,details:{}},n=t.paymentData;n.paymentTypes=[a],t.openPaymentDialogModal(r,n)}})},t.fetchAttachedPaymentTypes=function(){var e=function(e){t.paymentData=e,t.$parent.$emit("hideLoader")},a=function(e){t.$parent.$emit("hideLoader"),t.$emit("displayErrorMessage",e)};t.invokeApi(n.fetchCompanyPaymentData,t.contactInformation.id,e,a)},t.addListener("wallet",function(){t.fetchAttachedPaymentTypes()}),t.openDeleteSetAsPrimaryModal=function(e,a){t.paymentData.payment_id=e,t.paymentData.index=a,t.paymentData.accountId=t.contactInformation.id,t.paymentData.isFromWallet=!0,i.open({template:"/assets/partials/payment/rvDeleteSetAsPrimary.html",controller:"RVDeleteSetAsPrimaryCtrl",scope:t})},t.$on("ADDEDNEWPAYMENTTOCOTA",function(e,a){"undefined"==typeof t.paymentData.data&&(t.paymentData.data=[]),_.find(t.paymentData.data,{id:a.id})||t.paymentData.data.push(a),t.refreshScroller("paymentList")}),function(){var e={preventDefault:!1};t.setScroller("paymentList",e),t.$on("$viewContentLoaded",function(){t.refreshScroller("paymentList")}),t.$on("REFRESHLIKESSCROLL",function(){t.refreshScroller("paymentList")})}()}]),sntRover.controller("RVCreateAccountReceivableCtrl",["$rootScope","$scope","$state","RVCompanyCardSrv","ngDialog",function(e,t,a,r,n){BaseCtrl.call(this,t),t.ar_number="",t.createAccountReceivable=function(){var e={id:t.account_id,ar_number:t.ar_number};t.invokeApi(r.saveARDetails,e,t.successCreate,t.failureCreate)},t.closeDialog=function(){n.close()}}]),sntRover.controller("RVDeleteSetAsPrimaryCtrl",["$rootScope","$scope","$state","RVPaymentSrv","RVCompanyCardSrv","ngDialog",function(e,t,a,r,n,i){BaseCtrl.call(this,t),t.successSetAsPrimary=function(){angular.forEach(t.paymentData.data,function(e,t){e.is_primary=!1}),t.paymentData.data[t.paymentData.index].is_primary=!0,t.refreshScroller("paymentList"),t.$emit("hideLoader"),i.close()},t.successDelete=function(){t.paymentData.data.splice(t.paymentData.index,1),t.$emit("hideLoader"),i.close()},t.failureCallBack=function(e){t.$emit("hideLoader"),t.updateErrorMessage(e),t.refreshScroller("paymentList"),t.closeDialog()},t.setAsPrimary=function(){if(t.paymentData.isFromWallet){var e={associated_payment_method_id:t.paymentData.payment_id,account_id:t.paymentData.accountId};t.invokeApi(n.setAsPrimary,e,t.successSetAsPrimary,t.failureCallBack)}else{var e={id:t.paymentData.payment_id,user_id:t.paymentData.user_id};t.invokeApi(r.setAsPrimary,e,t.successSetAsPrimary,t.failureCallBack)}},t.deletePayment=function(){if(t.paymentData.isFromWallet){var e={associated_payment_method_id:t.paymentData.payment_id,account_id:t.paymentData.accountId};t.invokeApi(n.deletePayment,e,t.successDelete,t.failureCallBack)}else{var e={id:t.paymentData.payment_id};t.invokeApi(r.deletePayment,e,t.successDelete,t.failureCallBack)}}}]),sntRover.controller("RVPaymentGuestCtrl",["$rootScope","$scope","$state","RVPaymentSrv","ngDialog",function(e,t,a,r,n){BaseCtrl.call(this,t),t.$on("clearNotifications",function(){t.errorMessage="",t.successMessage=""}),t.updateErrorMessage=function(e){t.errorMessage=e},t.openAddNewPaymentModel=function(){t.callAPI(r.renderPaymentScreen,{params:{direct_bill:!1},onSuccess:function(e){var a=_.find(e,function(e){return"CC"===e.name}),r={guest_id:t.guestCardData.contactInfo.user_id,isFromGuestCard:!0,details:{firstName:t.guestCardData.contactInfo.first_name,lastName:t.guestCardData.contactInfo.last_name}},n=t.paymentData;n.paymentTypes=[a],t.openPaymentDialogModal(r,n)}})},t.openDeleteSetAsPrimaryModal=function(e,a){t.paymentData.payment_id=e,t.paymentData.index=a,n.open({template:"/assets/partials/payment/rvDeleteSetAsPrimary.html",controller:"RVDeleteSetAsPrimaryCtrl",scope:t})},t.$on("ADDEDNEWPAYMENTTOGUEST",function(e,a){"undefined"==typeof t.paymentData.data&&(t.paymentData.data=[]),_.find(t.paymentData.data,{id:a.id})||t.paymentData.data.push(a),t.refreshScroller("paymentList")}),function(){var e={preventDefault:!1};t.setScroller("paymentList",e),t.$on("$viewContentLoaded",function(){t.refreshScroller("paymentList")}),t.$on("REFRESHLIKESSCROLL",function(){t.refreshScroller("paymentList")})}()}]),sntRover.controller("RVShowPaymentListCtrl",["$rootScope","$scope","$state","RVPaymentSrv","ngDialog","rvPermissionSrv",function(e,t,a,r,n,i){BaseCtrl.call(this,t),t.showNoValues=!1;var o=i.getPermissionValue("REMOVE_CREDIT_CARD_FROM_STAYCARD");t.paymentListSuccess=function(e){t.$emit("hideLoader"),t.paymentListData=e,angular.forEach(t.paymentListData.existing_payments,function(e,a){if(!e.is_credit_card)return void t.paymentListData.existing_payments.splice(a,1)}),t.paymentListLength=t.paymentListData.existing_payments.length,0===t.paymentListLength&&(t.showNoValues=!0)};var s="",c=1;"billCard"===t.dataToPaymentList.currentView?(s=t.dataToPaymentList.reservation_id,c=t.dataToPaymentList.bills[t.dataToPaymentList.currentActiveBill].bill_number):s=t.dataToPaymentList.reservation_card.reservation_id;var d={reservation_id:s,bill_number:c};t.invokeApi(r.getExistingPaymentsForBill,d,t.paymentListSuccess),t.clickPaymentItem=function(a,i,o,c,d,l){var u={reservation_id:s,user_payment_type_id:a};"billCard"===t.dataToPaymentList.currentView&&(u.bill_number=t.dataToPaymentList.bills[t.dataToPaymentList.currentActiveBill].bill_number);var m=function(e){t.$emit("hideLoader"),t.errorMessage=e},p=function(a){var r;t.$emit("hideLoader"),e.$emit("UPDATECCATTACHEDBILLSTATUS",a.has_any_credit_card_attached_bill),n.close(),"billCard"===t.dataToPaymentList.currentView?(r=t.dataToPaymentList.currentActiveBill,t.dataToPaymentList.bills[r].credit_card_details.card_code=i.toLowerCase(),t.dataToPaymentList.bills[r].credit_card_details.card_number=o,t.dataToPaymentList.bills[r].credit_card_details.card_expiry=c,t.dataToPaymentList.bills[r].credit_card_details.is_swiped=d,t.dataToPaymentList.bills[r].credit_card_details.auth_color_code=l,t.dataToPaymentList.bills[r].credit_card_details.payment_id=a.id,t.dataToPaymentList.bills[r].credit_card_details.token=a.token,0===r&&e.$emit("UPDATEDPAYMENTLIST",t.dataToPaymentList.bills[r].credit_card_details)):(t.dataToPaymentList.reservation_card.payment_details.card_type_image="images/"+i.toLowerCase()+".png",t.dataToPaymentList.reservation_card.payment_details.card_number=o,t.dataToPaymentList.reservation_card.payment_details.card_expiry=c,t.dataToPaymentList.reservation_card.payment_method_used="CC",t.dataToPaymentList.reservation_card.payment_method_description="Credit Card",t.dataToPaymentList.reservation_card.payment_details.is_swiped=d,t.dataToPaymentList.reservation_card.payment_details.auth_color_code=l,t.dataToPaymentList.reservation_card.payment_details.id=a.id,t.dataToPaymentList.reservation_card.restrict_post=a.restrict_post)};t.invokeApi(r.mapPaymentToReservation,u,p,m)},t.$parent.myScrollOptions={paymentList:{scrollbars:!0,snap:!1,hideScrollbar:!1,preventDefault:!1}},t.$on("$viewContentLoaded",function(){setTimeout(function(){t.$parent.myScroll.paymentList.refresh()},3e3)}),t.openAddNewPaymentModel=function(){t.closeDialog(),e.$broadcast("OPENPAYMENTMODEL")},t.deleteCreditCard=function(e){var a=function(){t.closeDialog()},n=function(e){t.errorMessage=e};t.callAPI(r.deleteCreditCard,{onSuccess:a,onFailure:n,params:{reservation_id:s,payment_method_id:e}})},t.shouldShowCreditCardDeleteBtn=function(){return e.isStandAlone&&o&&"rover.reservation.staycard.reservationcard.reservationdetails"===a.current.name}}]),sntRover.controller("RVPleaseSwipeCtrl",["$rootScope","$scope","sntPaymentSrv",function(e,t,a){BaseCtrl.call(this,t),t.state={numAttempts:0},t.addCardOWS=function(){t.$emit("SHOW_SIX_PAY_LOADER"),t.callAPI(a.getSixPaymentToken,{params:{reservation_id:t.reservationBillData.reservation_id,workstation_id:t.workstation_id},successCallBack:function(){t.$emit("REFRESH_BILLCARD_VIEW"),t.$emit("HIDE_SIX_PAY_LOADER"),t.closeDialog()},failureCallBack:function(e){t.state.numAttempts++,t.errorMessage=e,t.$emit("HIDE_SIX_PAY_LOADER")}})}}]),sntRover.controller("reservationPaymentController",["$scope","$rootScope","RVReservationSummarySrv","rvPermissionSrv",function(e,t,a,r){e.getHasButtonClass=function(){var t=e.reservationData.reservation_card.has_any_credit_card_attached_bill,a="has-button";return t&&e.showCCAuthButton()&&(a="has-buttons"),a},e.displayButton=function(){var t=e.reservationData.reservation_card.reservation_status,a=!0;return"NOSHOW"!==t&&"CHECKEDOUT"!==t&&"CANCELED"!==t||(a=!1),a},e.showCCAuthButton=function(){return!(!e.reservationData.reservation_card.has_any_credit_card_attached_bill||!e.isStandAlone)};var n=function(){e.reservationData.reservation_card.restrict_post=!e.reservationData.reservation_card.restrict_post};e.setAllowPostWithNoCredit=function(){if(r.getPermissionValue("ALLOW_POST_WHEN_RESTRICTED")){var t={restrict_post:!e.reservationData.reservation_card.restrict_post,reservationId:e.reservationData.reservation_card.reservation_id},i={params:t,successCallBack:n};e.callAPI(a.updateRestrictPost,i)}},e.showPostWithNoCreditButton=function(){var a=!0;return t.isStandAlone&&""!==e.reservationData.reservation_card.payment_method_used&&null!==e.reservationData.reservation_card.payment_method_used||(a=!1),a},t.$on("UPDATEDPAYMENTLIST",function(t,a){e.reservationData.reservation_card.payment_details.card_type_image=a.card_code+".png",e.reservationData.reservation_card.payment_details.card_number=a.card_number,e.reservationData.reservation_card.payment_details.card_expiry=a.card_expiry,e.reservationData.reservation_card.payment_details.is_swiped=a.is_swiped}),t.$on("UPDATECCATTACHEDBILLSTATUS",function(t,a){e.reservationData.reservation_card.has_any_credit_card_attached_bill=a})}]),sntRover.controller("RVPaymentAddPaymentCtrl",["$rootScope","$scope",function(e,t){BaseCtrl.call(this,t),t.savePayment={},t.isFromGuestCard=!("undefined"==typeof t.passData.isFromGuestCard||!t.passData.isFromGuestCard),t.initCardSwipeRenderData=function(){t.isNewCardAdded=!1,t.shouldShowIframe=!1,t.addmode=!0,t.isGiftCard=!1,t.useDepositGiftCard=!1,t.hideCancelCard=!1,t.depositWithGiftCard=!1,setTimeout(function(){t.$broadcast("addNewCardClicked"),t.$broadcast("hidePayCardToggles",{isFromSwipe:!0})},100)},t.$on("CLOSE_DIALOG",function(){t.closeDialog()}),t.getAddActionType=function(){return t.isFromGuestCard?"ADD_PAYMENT_GUEST_CARD":t.paymentData.isFromBillCard||"billcard"===t.passData.fromView?"ADD_PAYMENT_BILL":"companyTravelAgent"===t.passData.fromView?"ADD_PAYMENT_CO_TA":"ADD_PAYMENT_STAY_CARD"};var a=function(a,r,n){var i=t.billNumber-1;"CC"===r?(_.extend(t.paymentData.bills[i].credit_card_details,{card_code:n.card_code,card_number:n.ending_with,card_expiry:n.expiry_date,payment_id:a.id,is_swiped:n.is_swiped,auth_color_code:n.auth_color_code,token:n.token}),t.paymentData.bills[i].credit_card_details.payment_type=r,1===t.billNumber&&e.$emit("UPDATEDPAYMENTLIST",t.paymentData.bills[i].credit_card_details),e.$broadcast("BALANCECHANGED",{balance:a.reservation_balance,confirm_no:t.paymentData.confirm_no}),e.$broadcast("paymentChangedToCC"),t.$emit("UPDATECCATTACHEDBILLSTATUS",a.has_any_credit_card_attached_bill),a.addToGuestCard&&e.$broadcast("ADDEDNEWPAYMENTTOGUEST",{card_code:n.card_code,mli_token:n.ending_with,card_expiry:n.expiry_date,card_name:n.card_name,id:a.guest_payment_method_id,isSelected:!0,is_primary:!1,payment_type:r||"CC",payment_type_id:1})):(t.paymentData.bills[i].credit_card_details.payment_type=r,t.paymentData.bills[i].credit_card_details.payment_type_description=a.payment_type),t.closeDialog(t.ngDialogId)},r=function(a,r,n){e.$broadcast("ADDEDNEWPAYMENTTOGUEST",{card_code:n.card_code,mli_token:n.ending_with,card_expiry:n.expiry_date,card_name:n.card_name,id:a.id,isSelected:!0,is_primary:!1,payment_type:r||"CC",payment_type_id:1}),t.closeDialog()},n=function(a,r,n){"CC"===r?(t.paymentData.reservation_card.payment_method_used=r,_.extend(t.paymentData.reservation_card.payment_details,{card_type_image:"images/"+n.card_code+".png",card_number:n.ending_with,card_expiry:n.expiry_date,is_swiped:n.is_swiped,auth_color_code:n.auth_color_code})):(t.paymentData.reservation_card.payment_method_description=a.payment_type,t.paymentData.reservation_card.payment_method_used=r),t.paymentData.reservation_card.restrict_post=a.restrict_post,e.$broadcast("UPDATERESERVATIONTYPE",a.reservation_type_id,a.id),t.$emit("UPDATECCATTACHEDBILLSTATUS",a.has_any_credit_card_attached_bill||a.usedEMV&&"CC"===r),a.addToGuestCard&&e.$broadcast("ADDEDNEWPAYMENTTOGUEST",{card_code:n.card_code,mli_token:n.ending_with,card_expiry:n.expiry_date,card_name:n.card_name,id:a.guest_payment_method_id,isSelected:!0,is_primary:!1,payment_type:r||"CC",payment_type_id:1}),t.closeDialog()},i=function(a,r,n){e.$broadcast("ADDEDNEWPAYMENTTOCOTA",{card_code:n.card_code,mli_token:n.ending_with,card_expiry:n.expiry_date,card_name:n.card_name,id:a.id,isSelected:!0,is_primary:!1,payment_type:r||"CC",payment_type_id:1}),t.closeDialog()};t.$on("SUCCESS_LINK_PAYMENT",function(e,o){switch(t.getAddActionType()){case"ADD_PAYMENT_BILL":a(o.response,o.selectedPaymentType,o.cardDetails);break;case"ADD_PAYMENT_GUEST_CARD":r(o.response,o.selectedPaymentType,o.cardDetails);break;case"ADD_PAYMENT_CO_TA":i(o.response,o.selectedPaymentType,o.cardDetails);break;default:n(o.response,o.selectedPaymentType,o.cardDetails)}}),t.$on("ERROR_OCCURED",function(e,a){t.errorMessage=a}),t.$on("PAYMENT_FAILED",function(e,a){t.errorMessage=a}),function(){isEmptyObject(t.passData.details.swipedDataToRenderInScreen)||(t.selectedPaymentType="CC",t.swipedCardData=t.passData.details.swipedDataToRenderInScreen),t.billNumber=t.passData.fromBill||1}()}]),sntRover.controller("RVCardOptionsCtrl",["$rootScope","$scope","$state","ngDialog","$location","$document","RVPaymentSrv","RVReservationCardSrv",function(e,t,a,r,n,i,o,s){BaseCtrl.call(this,t),t.showAddtoGuestCard=!1,t.renderDataFromSwipe=function(a){t.cardData.cardNumber=a.cardNumber,t.cardData.userName=a.nameOnCard,t.cardData.expiryMonth=a.cardExpiryMonth,t.cardData.expiryYear=a.cardExpiryYear,t.cardData.cardType=a.cardType,"guestCard"===a.swipeFrom&&e.$broadcast("swipeAtGuestCard"),"guestCard"===a.swipeFrom?t.showAddtoGuestCard=!1:t.showAddtoGuestCard=!0,"guestCard"!==a.swipeFrom&&"stayCard"!==a.swipeFrom||setTimeout(function(){t.clickedAddNewCard()},100)},t.refreshIframe=function(){if($("#sixIframe").length){var e=document.getElementById("sixIframe");e.src=e.src}},t.$on("REFRESH_IFRAME",function(e){t.refreshIframe()}),e.$on("depositModalAllowGiftCard",function(){t.allowPmtWithGiftCard=!0}),t.checkForGiftCard=function(){t.isGiftCard=!1,e.isStandAlone||t.invokeApi(o.fetchAvailPayments,{},t.cardsListSuccess)},t.hideCardToggles=function(){return!!(t.isFromGuestCard||t.hasAccompanyguest||t.cardsList&&0===t.cardsList.length)},t.$on("isFromGuestCardFalse",function(){t.showAddtoGuestCard=!0,t.isFromGuestCard=!0}),t.$on("hidePayCardToggles",function(e,a){t.isFromGuestCard=!0,a&&a.isFromSwipe&&"guestCard"!==a.swipeFrom&&(t.isFromGuestCard=!1)}),t.$on("giftCardSelectedFromGroups",function(){t.clickedGiftCardToggle()}),t.$on("CLICK_ADD_NEW_CARD",function(){t.clickedAddNewCard()}),t.$on("SHOW_SWIPED_DATA_ON_PAY_SCREEN",function(){t.clickedAddNewCard(),t.$$phase?"":t.$apply()}),t.$on("SHOW_SWIPED_DATA_ON_BILLING_SCREEN",function(){t.clickedAddNewCard(),t.$$phase?"":t.$apply()}),t.$on("SHOW_SWIPED_DATA_ON_DEPOSIT_BALANCE_SCREEN",function(){t.clickedAddNewCard(),t.$$phase?"":t.$apply()}),t.clickedAddNewCard=function(){t.shouldShowIframe=!1,t.addmode=!0,t.isGiftCard=!1,t.useDepositGiftCard=!1,t.hideCancelCard=!1,t.depositWithGiftCard=!1},t.clickedExistingCard=function(){t.shouldShowIframe=!0,t.addmode=!1,t.isGiftCard=!1,t.useDepositGiftCard=!1,t.hideCancelCard=!1,t.depositWithGiftCard=!1},t.clickedGiftCardToggle=function(){t.shouldShowIframe=!0,t.useDepositGiftCard=!0,t.addmode=!1,t.isGiftCard=!0,t.depositWithGiftCard=!0},t.showExistingCards=function(){return!t.addmode&&!t.useDepositGiftCard},t.showGiftCardToggle=function(){return!(t.isStandAlone||!t.allowPmtWithGiftCard)},t.existingSelected=function(){return!t.addmode&&!t.isGiftCard},t.addNewSelected=function(){return!(!t.addmode||t.isGiftCard)},t.hideMLINewCard=function(){return!!("sixpayments"===t.paymentGateway&&t.addmode||t.isManual||t.isGiftCard||t.depositWithGiftCard||t.shouldShowIframe)},t.showAddToGuestCardBox=function(){return t.existingSelected()||t.isGiftCard?t.showAddtoGuestCard=!1:t.addNewSelected()&&(t.showAddtoGuestCard=!0),!!t.showAddtoGuestCard},t.showMLIAddNewCC=function(){return!!t.addNewSelected()||!(!t.isGiftCard||t.showingDepositModal||t.depositWithGiftCard||t.useDepositGiftCard)},e.$on("giftCardSelected",function(){t.shouldShowIframe=!1,e.isStandAlone&&$("#cc-new-card").addClass("ng-hide")}),e.$on("creditCardSelected",function(){e.isStandAlone||(t.shouldShowIframe=!0,$("#cc-new-card").removeClass("ng-hide")),e.isStandAlone&&($("#cc-new-card").removeClass("ng-hide"),t.clickedAddNewCard())}),t.hideIfFromStayCardDirect=function(){e.isStandAlone||(t.swippedCard?t.shouldShowIframe=!1:t.shouldShowIframe=!0)},e.$on("validatedGiftCardPmt",function(e,a){a?t.validPayment=!0:t.validPayment=!1}),t.showMakePaymentButtonStatus=function(){var e="";return e=t.depositBalanceMakePaymentData&&"undefined"!=typeof t.depositBalanceMakePaymentData.payment_type?t.depositBalanceMakePaymentData.payment_type.length>0&&t.validPayment?"green":"grey":t.validPayment?"grey":"grey overlay"},t.useDepositGiftCard=!1,t.cardsListSuccess=function(a){t.allowPmtWithGiftCard=!1,e.allowPmtWithGiftCard=!1,t.$emit("hideLoader");for(var r in a)"GIFT_CARD"===a[r].name&&(t.allowPmtWithGiftCard=!0,t.$parent.allowPmtWithGiftCard=!0,t.$parent.$parent.allowPmtWithGiftCard=!0,t.$parent.$parent.$parent.allowPmtWithGiftCard=!0,e.allowPmtWithGiftCard=!0,e.$broadcast("depositModalAllowGiftCard",!0));e.initFromCashDeposit?t.initFromCashDeposit=!0:t.initFromCashDeposit=!1},t.isGiftCard=!1,t.allowPmtWithGiftCard=!1,e.$on("depositUsingGiftCardChange",function(a,r){e.depositUsingGiftCard?(t.isGiftCard=!0,t.hideCancelCard=!0):(t.isGiftCard=!1,t.hideCancelCard=!1)}),t.refreshIframeWithGuestData=function(e){var t=(new Date).getTime(),a=e.fname,r=e.lname;iFrameUrl=domainUrl+"/api/ipage/index.html?card_holder_first_name="+a+"&card_holder_last_name="+r+"&service_action=createtoken&time="+t;var n=document.getElementById("sixIframe");try{n.src=iFrameUrl}catch(e){console.warn(e.name,e.message)}},t.$on("refreshIframe",function(e,a){t.refreshIframeWithGuestData(a)});var c=n.$$absUrl;domainUrl=c.split("/staff#/")[0],t.cardData={},t.cardData.addToGuestCard=!1,t.cardData.cardNumber="",t.cardData.CCV="",t.cardData.expiryMonth="",t.cardData.expiryYear="",t.cardData.userName="";var d=(new Date).getTime();if(t.shouldShowAddNewCard=!0,"undefined"!=typeof t.passData)var l="undefined"==typeof t.passData.details.firstName?"":t.passData.details.firstName,u="undefined"==typeof t.passData.details.lastName?"":t.passData.details.lastName;if(t.iFrameUrl=domainUrl+"/api/ipage/index.html?card_holder_first_name="+l+"&card_holder_last_name="+u+"&service_action=createtoken&time="+d,"sixpayments"===e.paymentGateway){t.shouldShowAddNewCard=!1;var m=i.find("sixIframe");m.attr("src",t.iFrameUrl),t.showAddtoGuestCard=!1}else t.isFromGuestCard||(t.showAddtoGuestCard=!0);"undefined"==typeof t.passData||isEmptyObject(t.passData.details.swipedDataToRenderInScreen)||t.renderDataFromSwipe(t.passData.details.swipedDataToRenderInScreen),t.shouldShowIframe=!1,t.changeOnsiteCallIn=function(){t.shouldShowIframe=!t.shouldShowIframe,t.isFromGuestCard||(t.shouldShowIframe?(t.showAddtoGuestCard=!0,t.refreshIframe()):t.showAddtoGuestCard=!1)};var p=function(){t.cardData.cardNumber="",t.cardData.CCV="",t.cardData.expiryMonth="",t.cardData.expiryYear=""};t.$on("clearCardDetails",function(){p()});var f=function(e){var a={};a.cardDetails=angular.copy(t.cardData),a.tokenDetails=e,t.$emit("TOKEN_CREATED",a),t.$digest(),t.refreshIframe()},_=function(e){t.$emit("MLI_ERROR",e)},v=function(){var e={};return e.cardNumber=t.cardData.cardNumber,e.cardSecurityCode=t.cardData.CCV,e.cardExpiryMonth=t.cardData.expiryMonth,e.cardExpiryYear=t.cardData.expiryYear,e};t.getToken=function(e){if(e.preventDefault(),isEmptyObject(t.passData.details.swipedDataToRenderInScreen)){var a=v(),r=function(e){e.isSixPayment=!1,f(e)},n=function(e){_(e)};t.fetchMLI(a,r,n)}else{var i=new SwipeOperation,o=i.createSWipedDataToSave(t.passData.details.swipedDataToRenderInScreen);o.addToGuestCard=t.cardData.addToGuestCard,o.card_name&&""!==o.card_name||(o.card_name=t.cardData.userName),t.$emit("SWIPED_DATA_TO_SAVE",o)}},t.$on("six_token_recived",function(e,a){a.six_payment_data.isSixPayment=!0,t.shouldShowAddNewCard=!1,f(a.six_payment_data)}),t.setCreditCardFromList=function(e){t.$emit("cardSelected",{index:e}),t.cardselectedIndex=e},t.setToShowCancelCard=function(){t.hideCancelCard=!1,t.depositWithGiftCard=!1},t.setToHideCancelCard=function(){t.hideCancelCard=!0},t.showCancelCardSelection=function(){return!t.hideCancelCard&&!t.depositWithGiftCard},t.isSixPayPayment=function(){return!!("sixpayments"===t.paymentGateway&&t.addmode||t.isManual)},t.cancelCardSelection=function(){e.isStandAlone?(t.$emit("cancelCardSelection"),t.cardselectedIndex=-1,t.refreshIframe()):r.close()},t.$on("cancelCardSelection",function(){t.depositWithGiftCard=!1,t.isGiftCard=!1,t.hideCancelCard=!1}),t.$on("showCancelCreditCardButton",function(){t.setToShowCancelCard()}),t.giftCardAmountAvailable=!1,t.giftCardAvailableBalance=0,t.$on("giftCardAvailableBalance",function(e,a){t.giftCardAvailableBalance=a.amount}),t.timer=null,t.cardNumberInput=function(a,r,n){if(n?(t.isGiftCard=!0,t.useDepositGiftCard=!0,e.useDepositGiftCard=!0):e.useDepositGiftCard=!1,t.isGiftCard||n){var i=a.length;t.num=a,i>=8&&i<=22?$("[name=card-number]").keydown(function(){clearTimeout(t.timer),t.timer=setTimeout(t.fetchGiftCardBalance,1500)}):t.giftCardAmountAvailable=!1}},t.num,t.fetchGiftCardBalance=function(){if(t.isGiftCard){var e=function(e){t.giftCardAvailableBalance=e.amount,t.giftCardAmountAvailable=!0,t.$emit("giftCardAvailableBalance",e),t.$emit("hideLoader")};t.invokeApi(s.checkGiftCardBalance,{card_number:t.num},e)}else t.giftCardAmountAvailable=!1},t.$on("addNewCardClicked",function(){t.clickedAddNewCard()}),t.$on("existingCardClicked",function(){t.clickedExistingCard()}),t.$on("RENDER_SWIPED_DATA",function(e,a){t.swippedCard=!0,t.renderDataFromSwipe(a),t.passData.details.swipedDataToRenderInScreen=a,setTimeout(function(){t.clickedAddNewCard()},100)})}]),angular.module("sntRover").service("RVCompanyCardSearchSrv",["$q","rvBaseWebSrvV2",function(e,t){this.fetch=function(a){var r=e.defer(),n="/api/accounts";return t.getJSON(n,a).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise}}]),angular.module("sntRover").service("RVCompanyCardSrv",["$q","rvBaseWebSrvV2",function(e,t){var a=this,r={},n=6e4;a.companyTaArDetailsCached=[],a.companyTaNotes=[],a.cachedTime="",this.DEFAULT_PER_PAGE=10,this.DEFAULT_PAGE=1;var i={},o=this;this.fetchContactInformation=function(a){var r=a.id,n=e.defer(),i="/api/accounts/"+r,o=["is_eod_failed","is_eod_in_progress","is_eod_manual_started","is_eod_process_running"];return t.getJSON(i).then(function(e){n.resolve(_.omit(e,o))},function(e){n.reject(e)}),n.promise},this.fetchCompanyPaymentData=function(a){var r=e.defer(),n="/staff/payments/payment.json?account_id="+a;return t.getJSON(n).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.setAsPrimary=function(a){var r=e.defer(),n="api/accounts/"+a.account_id+"/set_wallet_payment_method_primary";return t.postJSON(n,a).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.deletePayment=function(a){var r=e.defer(),n="api/accounts/"+a.account_id+"/delete_wallet_payment_methods";return t.postJSON(n,a).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.fetchContactInformationMandatoryFields=function(){var a=e.defer(),r="/admin/co_ta_settings/current_settings.json";return t.getJSON(r).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.fetchAccountPaymentData=function(a){var r=e.defer(),n="/staff/payments/payment.json?account_id="+a;return t.getJSON(n).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.fetchContactInformationAndMandatoryFields=function(t){var a=e.defer(),r={};return e.when().then(function(){
return o.fetchContactInformation(t).then(function(e){r=e})}).then(function(){return o.fetchContactInformationMandatoryFields().then(function(e){r.mandatoryFields=e})}).then(function(){a.resolve(r)},function(e){a.reject(e)}),a.promise},this.fetchCommissionDetail=function(){var a=e.defer(),r=" /api/hotel_settings/default_agent_commission_details";return t.getJSON(r).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.fetchCommissionDetailsAndMandatoryFields=function(){var t=e.defer(),a={};return e.when().then(function(){return o.fetchCommissionDetail().then(function(e){a=e})}).then(function(){return o.fetchContactInformationMandatoryFields().then(function(e){a.mandatoryFields=e})}).then(function(){t.resolve(a)},function(e){t.reject(e)}),t.promise},this.fetchMultiProperties=function(a){var r=e.defer(),n="/api/accounts/"+a.accountId+"/subscribed_properties";return t.getJSON(n).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise};var s=[];this.fetchCountryList=function(){var a=e.defer(),r="/ui/country_list";return s.length?a.resolve(s):t.getJSON(r).then(function(e){s=e,a.resolve(e)},function(e){a.reject(e)}),a.promise},this.saveContactInformation=function(a){var r,n,o=e.defer(),s="api/accounts/save.json",c=parseInt(a.id,10),d=_.omit(a,["workstation_id"]),l={data:d,deferred:o};return i[c]=i[c]||[],r=i[c],(n=r.find(function(e){return angular.equals(e.data,d)&&!e.resolved}))?n.deferred.promise:(r.push(l),t.postJSON(s,a).then(function(e){l.resolved=!0,o.resolve(e)},function(e){l.resolved=!0,o.reject(e)}),o.promise)},this.fetchRates=function(a){var r=e.defer(),n="/api/rates/contract_rates";return t.getJSON(n,a).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.replaceCard=function(a){var r={old:{type:a.cardType},new:{type:a.cardType,id:a.id,use_card_rate:a.useCardRate},change_all_reservations:a.future},n=e.defer(),i="/api/reservations/"+a.reservation+"/cards/replace";return t.putJSON(i,r).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.removeCard=function(a){var r={type:a.cardType,id:a.cardId},n=e.defer(),i="/api/reservations/"+a.reservation+"/cards/remove";return t.deleteJSON(i,r).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchArAccountDetails=function(r){var i=r.id,o=e.defer(),s="/api/accounts/"+i+"/ar_details";if(!a.companyTaArDetailsCached[i]||a.companyTaArDetailsCached[i].expiry&&Date.now()>a.companyTaArDetailsCached[i].expiry)a.companyTaArDetailsCached[i]=o,t.getJSON(s).then(function(e){a.companyTaArDetailsCached[i]={response:e,expiry:Date.now()+n},o.resolve(e)},function(e){o.reject(e)});else{if(!a.companyTaArDetailsCached[i].response)return a.companyTaArDetailsCached[i].promise;o.resolve(a.companyTaArDetailsCached[i].response)}return o.promise},this.fetchArAccountNotes=function(r){var i=r.id,o=e.defer(),s="/api/accounts/"+i+"/ar_notes";if(!a.companyTaNotes[i]||a.companyTaNotes[i].expiry&&Date.now()>a.companyTaNotes[i].expiry)a.companyTaNotes[i]=o,t.getJSON(s).then(function(e){a.companyTaNotes[i]={response:e,expiry:Date.now()+n},o.resolve(e)},function(e){o.reject(e)});else{if(!a.companyTaNotes[i].response)return a.companyTaNotes[i].promise;o.resolve(a.companyTaNotes[i].response)}return o.promise},this.saveARNote=function(r){var n=e.defer(),i="/api/accounts/save_ar_note",o=r.id;return t.postJSON(i,r).then(function(e){a.companyTaNotes[o]=null,n.resolve(e)},function(e){n.reject(e)}),n.promise},this.saveARDetails=function(r){var n=e.defer(),i="api/accounts/save_ar_details",o=r.id;return t.postJSON(i,r).then(function(e){a.companyTaArDetailsCached[o]=null,n.resolve(e)},function(e){n.reject(e)}),n.promise},this.deleteARNote=function(r){var n=e.defer(),i="/api/accounts/delete_ar_note",o=r.id;return t.postJSON(i,r).then(function(e){a.companyTaNotes[o]=null,n.resolve(e)},function(e){n.reject(e)}),n.promise},this.deleteArAccount=function(r){var n=r.id,i=e.defer(),o="api/accounts/"+n+"/delete_ar_detail";return t.deleteJSON(o).then(function(e){a.companyTaArDetailsCached[n]=null,i.resolve(e)},function(e){i.reject(e)}),i.promise},this.fetchArAccountsList=function(a){var r=e.defer(),n="/api/accounts/"+a.id+"/ar_transactions?paid="+a.paid+"&from_date="+a.from_date+"&to_date="+a.to_date+"&query="+a.query+"&page="+a.page_no+"&per_page="+a.per_page+"&transaction_type="+a.transaction_type;return t.getJSON(n).then(function(e){e.ar_transactions&&e.ar_transactions.length>0&&angular.forEach(e.ar_transactions,function(e){"DEBIT"===e.transaction_type&&(e.active=!1)}),r.resolve(e)},function(e){r.reject(e)}),r.promise},this.addCreditAmount=function(a){var r=e.defer(),n="api/accounts/"+a.id+"/ar_transactions";return t.postJSON(n,a).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.payForReservation=function(a){var r=e.defer(),n="api/accounts/"+a.id+"/ar_transactions/"+a.transaction_id+"/pay";return t.postJSON(n).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.openForReservation=function(a){var r=e.defer(),n="api/accounts/"+a.id+"/ar_transactions/"+a.transaction_id+"/open";return t.postJSON(n).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.payAll=function(a){var r=e.defer(),n="api/accounts/"+a.id+"/ar_transactions/pay_all";return t.postJSON(n).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},a.fetchHotelLoyaltiesHlps=function(){var a=e.defer(),n="/staff/user_memberships/get_available_hlps.json";return r.fetchHotelLoyaltiesHlps?a.resolve(r.fetchHotelLoyaltiesHlps):t.getJSON(n).then(function(e){r.fetchHotelLoyaltiesHlps=e,a.resolve(e)},function(e){a.reject(e)}),a.promise},a.fetchHotelLoyaltiesFfp=function(){var a=e.defer(),n="/staff/user_memberships/get_available_ffps.json";return r.fetchHotelLoyaltiesFfp?a.resolve(r.fetchHotelLoyaltiesFfp):t.getJSON(n).then(function(e){r.fetchHotelLoyaltiesFfp=e,a.resolve(e)},function(e){a.reject(e)}),a.promise},this.fetchTACommissionDetails=function(a){var r=e.defer(),n=" api/accounts/"+a.accountId+"/commission_details";return t.getJSON(n,a.params).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.saveTACommissionDetails=function(a){var r=e.defer(),n={};n.reservations=a.commissionDetails;var i="api/accounts/"+a.accountId+"/save_commission_details";return t.postJSON(i,n).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.fetchTransactionDetails=function(a){var r=e.defer(),n=" /api/bills/"+a.bill_id+"/transactions";return t.getJSON(n,a).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.fetchArStatementPrintData=function(a){var r=e.defer(),n="/api/ar_transactions/print";return t.postJSON(n,a).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.emailArStatement=function(a){var r=e.defer(),n="/api/ar_transactions/email";return t.postJSON(n,a).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.fetchArStatementData=function(a){var r=e.defer(),n="/api/ar_transactions/get_email?id="+a.id;return t.getJSON(n).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.groupChargeDetailsFetch=function(a){var r=e.defer(),n="/staff/reservation/transaction_details";return t.getJSON(n,a).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.recalculateCommission=function(a){var r=e.defer(),n="/api/reservations/recalculate_commission_details";return t.postJSON(n,a).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.fetchCompanyTravelAgentStatisticsSummary=function(a){var r=e.defer(),n="/api/accounts/"+a.accountId+"/statistics?view=SUMMARY";return delete a.accountId,t.getJSON(n,a).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.fetchCompanyTravelAgentStatisticsDetails=function(a){var r=e.defer(),n="/api/accounts/"+a.accountId+"/statistics?view=DETAILED";return delete a.accountId,t.getJSON(n,a).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.fetchCompanyTravelAgentMonthlyReservations=function(a){var r=e.defer(),n="/api/accounts/"+a.accountId+"/statistics?view=RESERVATIONS";return delete a.accountId,t.getJSON(n,a).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.verifyTravelAgentCompanyCardMerge=function(a){var r=e.defer(),n="/api/accounts/validate_card_merge";return t.postJSON(n,a).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.mergeCards=function(a){var r=e.defer(),n="/api/accounts/merge_cards";return t.postJSON(n,a).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise}}]),angular.module("sntRover").service("RVMergeCardsSrv",["$q","rvBaseWebSrvV2",function(e,t){this.verifyCardMerge=function(a){var r=e.defer(),n="/api/accounts/validate_card_merge";return a.isGuestCard&&(n="/api/guest_details/validate_card_merge",delete a.isGuestCard),t.postJSON(n,a).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.mergeCards=function(a){var r=e.defer(),n="/api/accounts/merge_cards";return a.isGuestCard&&(n="/api/guest_details/merge_cards",delete a.isGuestCard,delete a.card_type),t.postJSON(n,a).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise}}]),angular.module("sntRover").controller("mergeCardsController",["$scope","RVMergeCardsSrv","$timeout",function(e,t,a){var r=this,n={ALL:"ALL",AR_ONLY:"AR_ONLY"},i={VERIFYING_MERGE:"Verifying Merge",OK_TO_MERGE:"Ok to Merge",MERGE_NOT_POSSIBLE:"Merge not possible"},o="selected_cards_for_merge_scroll";e.setScroller(o,{tap:!0,preventDefault:!1,deceleration:1e-4,shrinkScrollbars:"clip"}),r.refreshSelectedCardsScroller=function(){a(function(){e.refreshScroller(o)},300)},e.onPrimaryGuestSelectionChange=function(t){e.viewState.selectedCardsForMerge.forEach(function(a){a.id===t?(a.isPrimary=!0,e.viewState.selectedPrimaryCard=a):a.isPrimary=!1})},e.getMergeActionClassName=function(){var t="";return 1===e.viewState.selectedCardsForMerge.length||e.showVerifyMergeProcessActivityIndicator||!e.isEmpty(e.viewState.mergeStatusErrors)?t="grey":e.viewState.selectedCardsForMerge.length>1&&(t="purple"),t},e.verifyMerge=function(){var a=function(t){t.can_merge?(e.viewState.canMerge=t.can_merge,e.viewState.mergeStatusText=i.OK_TO_MERGE):(e.viewState.mergeStatusErrors=t.errors,e.viewState.mergeStatusText=i.MERGE_NOT_POSSIBLE),e.showVerifyMergeProcessActivityIndicator=!1,r.refreshSelectedCardsScroller()},n=function(){};e.showVerifyMergeProcessActivityIndicator=!0;var o={card_ids:r.getNonPrimaryCardIds(),isGuestCard:e.isGuestCard};e.viewState.mergeStatusText=i.VERIFYING_MERGE,e.viewState.hasInitiatedMergeVerification=!0,e.callAPI(t.verifyCardMerge,{params:o,onSuccess:a,onFailure:n})},e.hasMergeVerificationErrors=function(t){if(_.isEmpty(e.viewState.mergeStatusErrors))return!1;var a=e.viewState.mergeStatusErrors[t.id];return a&&a.length>0},e.getErrorMsg=function(t){if(_.isEmpty(e.viewState.mergeStatusErrors))return"";var a=e.viewState.mergeStatusErrors[t.id];return a=a?a.join(","):""},e.cancelSelections=function(){var t=_.pluck(e.viewState.selectedCardsForMerge,"id");e.results.forEach(function(e){t.indexOf(e.id)!==-1&&(e.selected=!1,e.isPrimary=!1)}),r.resetSelectionsForMerge(),e.viewState.isViewSelected=!0,e.cardFilter=n.ALL,e.queryEntered()},e.mergeCards=function(){var a={card_ids:r.getNonPrimaryCardIds(),primary_card_id:e.viewState.selectedPrimaryCard.id,card_type:e.viewState.isCompanyCardSelected?"COMPANY":"TRAVELAGENT",isGuestCard:e.isGuestCard},n=function(){r.resetSelectionsForMerge(),e.queryEntered()},i=function(t){e.viewState.mergeStatusText=t,e.viewState.canMerge=!1};e.callAPI(t.mergeCards,{params:a,onSuccess:n,onFailure:i})},e.removeSelectedCard=function(t){e.viewState.selectedCardsForMerge=_.reject(e.viewState.selectedCardsForMerge,function(e){return e.id===t.id});var a=!!t.isPrimary;t.isPrimary&&(t.isPrimary=!1,e.viewState.selectedPrimaryCard={});var r=_.find(e.results,{id:t.id});r&&(r.selected=!1),a&&e.viewState.selectedCardsForMerge.length>0&&(e.viewState.selectedCardsForMerge[0].isPrimary=!0,e.viewState.selectedPrimaryCard=e.viewState.selectedCardsForMerge[0]),e.viewState.mergeStatusErrors&&e.viewState.mergeStatusErrors[t.id]&&delete e.viewState.mergeStatusErrors[t.id],e.isEmpty(e.viewState.mergeStatusErrors)&&e.viewState.selectedCardsForMerge.length>1&&(e.viewState.canMerge=!0,e.viewState.mergeStatusText=i.OK_TO_MERGE),1===e.viewState.selectedCardsForMerge.length&&(e.viewState.hasInitiatedMergeVerification=!1)},r.resetSelectionsForMerge=function(){e.viewState.selectedPrimaryCard={},e.viewState.selectedCardsForMerge=[],e.viewState.mergeStatusText=[],e.viewState.mergeStatusErrors={},e.viewState.hasInitiatedMergeVerification=!1},r.getNonPrimaryCardIds=function(){var t=_.reject(e.viewState.selectedCardsForMerge,function(e){return e.isPrimary}),a=[];return t.length>0&&(a=_.pluck(t,"id")),a},e.addListener("RESET_SELECTIONS_FOR_MERGE",function(){r.resetSelectionsForMerge()}),e.addListener("REFRESH_SELECTED_CARDS_FOR_MERGE_SCROLLER",function(){r.refreshSelectedCardsScroller()})}]),sntRover.controller("rvArBillFormatPopupCtrl",["$scope","$rootScope","$filter","RVBillCardSrv","RVContactInfoSrv","rvAccountsArTransactionsSrv","ngDialog","$timeout",function(e,t,a,r,n,i,o,s){var c=200,d=500;BaseCtrl.call(this,e),e.isCompanyCardInvoice=!0,e.disableCompanyCardInvoice=!1,e.hideCompanyCardInvoiceToggle=!0,e.billFormat.isInformationalInvoice=!e.shouldGenerateFinalInvoice,e.billFormat.isInformationalInvoiceDisabled=!e.disableInformationCheckBox;var l=function(){var t={};return t.is_type="ArAccount",t.id=e.item.transaction_id,t};e.closeDialog=function(){t.modalOpened=!1,s(function(){o.close()},c)};var u=function(t){t.languages&&(t.languages=_.filter(t.languages,{is_show_on_guest_card:!0})),e.languageData=t,e.data.locale=t.selected_language_code},m=function(){var t={params:{},successCallBack:u};e.callAPI(n.fetchGuestLanguages,t)},p=function(){var t=l(),a=function(t){m(),t.data&&t.data.default_bill_settings&&(t.data.default_bill_settings=t.data.default_bill_settings.toString()),e.data=t.data,e.setEmailAddress()},n={params:t,successCallBack:a};e.callAPI(r.getBillSettingsInfo,n)},f=function(){var t={};return t.id=e.item.transaction_id,t.account_id=e.arTransactionsData.accountId,t.locale=e.data.locale,t};e.printBill=function(t){var a=f();a.is_locked=t,e.$emit("UPDATE_INFORMATIONAL_INVOICE",e.billFormat.isInformationalInvoice),a.bill_layout=e.data.default_bill_settings,a.is_informational_invoice=e.billFormat.isInformationalInvoice,e.clickedPrint(a)},e.clickedContinueButtonPrintOrEmail=function(){var t={},a=!1;t.id=e.item.transaction_id,t.account_id=e.arTransactionsData.accountId;var r=function(){e.is_bill_lock_enabled&&(a=!0),e.isClickedPrint?e.printBill(a):e.sendEmail(a)},n=function(t){a=!1,e.errorMessage=t},o={params:t,successCallBack:r,failureCallBack:n};e.callAPI(i.lockBill,o)},e.clickedPrintBill=function(){!e.shouldGenerateFinalInvoice||e.billFormat.isInformationalInvoice||e.item.is_locked?e.printBill():(e.isClickedPrint=!0,e.isInvoiceStepThreeActive=!1,s(function(){e.isInvoiceStepFourActive=!0},d))},e.sendEmail=function(t){var a=f();a.is_locked=t,a.bill_layout=e.data.default_bill_settings,a.to_address=e.data.mailto_address,a.is_informational_invoice=e.billFormat.isInformationalInvoice,e.clickedEmail(a)},e.emailBill=function(){!e.shouldGenerateFinalInvoice||e.billFormat.isInformationalInvoice||e.item.is_locked?e.sendEmail():(e.isClickedPrint=!1,e.isInvoiceStepThreeActive=!1,s(function(){e.isInvoiceStepFourActive=!0},d))},e.clickedFinalInvoiceButton=function(){e.isInvoiceStepOneActive=!1,s(function(){e.isInvoiceStepTwoActive=!0},d)},e.clickedProceedButton=function(){e.isInvoiceStepTwoActive=!1,e.isInvoiceStepFourActive=!1,s(function(){e.isInvoiceStepThreeActive=!0},d)},e.clickedCancelButtonProceedScreen=function(){e.isInvoiceStepTwoActive=!1,s(function(){e.isInvoiceStepOneActive=!0},d)};var v=e.$on("UPDATE_WINDOW",function(){e.isInvoiceStepFourActive=!1,s(function(){e.item.is_locked||(e.isInvoiceStepFiveActive=!0)},d)});e.getPrintButtonClass=function(){var t="blue";return 0===parseInt(e.item.print_counter,10)&&0===parseInt(e.transactionsDetails.no_of_original_invoices,10)&&e.roverObj.noReprintReEmailInvoice?t="blue":!e.billFormat.isInformationalInvoice&&parseInt(e.item.print_counter,10)>0&&0===parseInt(e.transactionsDetails.no_of_original_invoices,10)&&e.roverObj.noReprintReEmailInvoice?t="grey":!e.billFormat.isInformationalInvoice&&parseInt(e.item.print_counter,10)>=parseInt(e.transactionsDetails.no_of_original_invoices,10)&&e.roverObj.noReprintReEmailInvoice&&(t="grey"),t},e.isPrintButtonDisabled=function(){var t=!1;return 0===parseInt(e.item.print_counter,10)&&0===parseInt(e.transactionsDetails.no_of_original_invoices,10)&&e.roverObj.noReprintReEmailInvoice?t=!1:!e.billFormat.isInformationalInvoice&&parseInt(e.item.print_counter,10)>0&&0===parseInt(e.transactionsDetails.no_of_original_invoices,10)&&e.roverObj.noReprintReEmailInvoice?t=!0:!e.billFormat.isInformationalInvoice&&parseInt(e.item.print_counter,10)>=parseInt(e.transactionsDetails.no_of_original_invoices,10)&&e.roverObj.noReprintReEmailInvoice&&(t=!0),t},e.getEmailButtonClass=function(){var t="blue";return e.data.mailto_address?0===parseInt(e.item.email_counter,10)&&0===parseInt(e.transactionsDetails.no_of_original_emails,10)&&e.roverObj.noReprintReEmailInvoice?t="blue":!e.billFormat.isInformationalInvoice&&parseInt(e.item.email_counter,10)>0&&0===parseInt(e.transactionsDetails.no_of_original_emails,10)&&e.roverObj.noReprintReEmailInvoice?t="grey":!e.billFormat.isInformationalInvoice&&parseInt(e.item.email_counter,10)>=parseInt(e.transactionsDetails.no_of_original_emails,10)&&e.roverObj.noReprintReEmailInvoice&&0!==parseInt(e.transactionsDetails.no_of_original_emails,10)&&(t="grey"):t="grey",t},e.isEmailButtonDisabled=function(){var t=!1;return e.data.mailto_address?0===parseInt(e.item.email_counter,10)&&0===parseInt(e.transactionsDetails.no_of_original_emails,10)&&e.roverObj.noReprintReEmailInvoice?t=!1:!e.billFormat.isInformationalInvoice&&parseInt(e.item.email_counter,10)>0&&0===parseInt(e.transactionsDetails.no_of_original_emails,10)&&e.roverObj.noReprintReEmailInvoice?t=!0:!e.billFormat.isInformationalInvoice&&parseInt(e.item.email_counter,10)>=parseInt(e.transactionsDetails.no_of_original_emails,10)&&e.roverObj.noReprintReEmailInvoice&&0!==parseInt(e.transactionsDetails.no_of_original_emails,10)&&(t=!0):t=!0,t},e.clickedInformationalButton=function(){e.billFormat.isInformationalInvoice=!0,e.isInvoiceStepOneActive=!1,s(function(){e.isInvoiceStepThreeActive=!0},d)},e.setEmailAddress=function(){e.isCompanyCardInvoice?e.data.mailto_address=e.data.company_address?e.data.company_address:e.data.to_address:e.data.mailto_address=e.data.travel_agent_address?e.data.travel_agent_address:e.data.to_address};var C=function(){e.data={},p()};e.changeCompanyCardInvoiceToggle=function(){e.isCompanyCardInvoice=!e.isCompanyCardInvoice},e.$on("$destroy",v),C()}]);