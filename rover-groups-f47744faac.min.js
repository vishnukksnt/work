function getLengthChangedNumber(e,t){"number"==typeof t&&(t=t.toString());var a=e-t.length;if(a<=0)return t;for(var n="",o=1;o<=a;o++)n+="0";return n+t}angular.module("sntRover").controller("rvGroupConfigurationCtrl",["$scope","$rootScope","rvGroupSrv","$filter","$stateParams","rvGroupConfigurationSrv","summaryData","holdStatusList","$state","rvPermissionSrv","$timeout","rvAccountTransactionsSrv","ngDialog","hotelSettings","taxExempts","countries",function(e,t,a,n,o,r,i,s,c,u,l,d,p,m,f,g){BaseCtrl.call(this,e);var v=function(){e.$$phase||e.$digest()},h="rover.reservation.staycard.mainCard.room-rates";e.isInAddMode=function(){return"NEW_GROUP"===o.id},e.isInAddonSelectionMode=function(){return e.groupConfigData.selectAddons};var y=function(){var t=n("translate")("GROUP_DETAILS");e.isInAddMode()&&(t=n("translate")("NEW_GROUP")),e.setHeadingTitle(t)},D=function(){var t=e.groupConfigData.summary,a=!!(t.group_name&&t.hold_status&&t.block_from&&t.block_to&&t.release_date);return a};e.shouldShowRoomingListTab=function(){return!e.isInAddMode()};var C=function(e){var a=typeof e,o="";switch(a){case"string":o=n("date")(new tzIndependentDate(e),t.dateFormatForAPI);break;case"object":o=n("date")(e,t.dateFormatForAPI)}return o};e.formatDateForUI=function(e){var a=typeof e,o="";switch(a){case"string":o=n("date")(new tzIndependentDate(e),t.dateFormat);break;case"object":o=n("date")(e,t.dateFormat)}return o},function(){var t=null,a=null,n=null,o=null,i=null,s=function(e){var a=["DEFAULT","CHANGE_DATES","COMPLETE_MOVE"];e&&null!==e&&(e=e.toString().toUpperCase(),t=a.indexOf(e)>=0?e:null)},c=function(){var t=e.groupConfigData.summary,a=parseInt(t.rooms_total)>0,n=!t.is_a_past_group;return a&&n},d=function(){var t=e.groupConfigData.summary,a=parseInt(t.rooms_total)>0,n=0===parseInt(t.total_checked_in_reservations),o=!t.is_a_past_group;return a&&n&&o},m=function(t){p.open({template:"/assets/partials/groups/summary/popups/changeDates/arrivalDate/rvConfirmArrivalDateChangeToEarlier.html",className:"",closeByDocument:!1,closeByEscape:!1,scope:e,data:JSON.stringify(t)})},f=function(t){p.open({template:"/assets/partials/groups/summary/popups/changeDates/arrivalDate/rvConfirmArrivalDateChangeLater.html",className:"",closeByDocument:!1,closeByEscape:!1,scope:e,data:JSON.stringify(t)})},g=function(e){a=e.successCallBack?e.successCallBack:null,n=e.failureCallBack?e.failureCallBack:null,i=e.cancelPopupCallBack?e.cancelPopupCallBack:null;var t={dataset:{fromDate:e.fromDate?e.fromDate:null,oldFromDate:e.oldFromDate?e.oldFromDate:null,changeInArr:!0}};m(t)},v=function(e){a=e.successCallBack?e.successCallBack:null,n=e.failureCallBack?e.failureCallBack:null,i=e.cancelPopupCallBack?e.cancelPopupCallBack:null;var t={dataset:{fromDate:e.fromDate?e.fromDate:null,oldFromDate:e.oldFromDate?e.oldFromDate:null,changeInArr:!0}};f(t)},h=function(){var t=e.groupConfigData.summary,a=parseInt(t.rooms_total)>0;return a},y=function(){var t=e.groupConfigData.summary,a=parseInt(t.rooms_total)>0;return a},D=function(t){p.open({template:"/assets/partials/groups/summary/popups/changeDates/departureDate/rvConfirmDepartureDateChangeToEarlier.html",className:"",closeByDocument:!1,closeByEscape:!1,scope:e,data:JSON.stringify(t)})},A=function(t){p.open({template:"/assets/partials/groups/summary/popups/changeDates/departureDate/rvConfirmDepartureDateChangeLater.html",className:"",closeByDocument:!1,closeByEscape:!1,scope:e,data:JSON.stringify(t)})},S=function(e){a=e.successCallBack?e.successCallBack:null,n=e.failureCallBack?e.failureCallBack:null,i=e.cancelPopupCallBack?e.cancelPopupCallBack:null;var t={dataset:{toDate:e.toDate?e.toDate:null,oldToDate:e.oldToDate?e.oldToDate:null,changeInDep:!0}};D(t)},b=function(e){a=e.successCallBack?e.successCallBack:null,n=e.failureCallBack?e.failureCallBack:null,i=e.cancelPopupCallBack?e.cancelPopupCallBack:null;var t={dataset:{toDate:e.toDate?e.toDate:null,oldToDate:e.oldToDate?e.oldToDate:null,changeInDep:!0}};A(t)},P=function(e){a=e.successCallBack?e.successCallBack:null,n=e.failureCallBack?e.failureCallBack:null,i=e.cancelPopupCallBack?e.cancelPopupCallBack:null;var t={dataset:{message:e.message?e.message:""}};I(t)},I=function(t){p.open({template:"/assets/partials/groups/summary/popups/changeDates/rvGroupChangeDatesInvalidWarningPopup.html",className:"",closeByDocument:!1,closeByEscape:!1,scope:e,data:JSON.stringify(t)})},E=function(t){e.closeDialog(),e.groupConfigData.summary.posting_account_billing_info?l(function(){G()},750):a()},R=function(){return u.getPermissionValue("OVERBOOK_ROOM_TYPE")},O=function(){return u.getPermissionValue("OVERBOOK_HOUSE")};e.shouldShowProceedButtonInNoAvailaility=function(){return R()},e.forcefullyOverbook=function(){var t=o;return _.isObject(t)?void(J()?e.callMoveDatesAPI(t[0],!0):e.callChangeDatesAPI(t[0],t[1],!0)):(console.log("there is something wrong in the flow"),!1)};var T=function(e){var t=!e.is_house_available,a=!e.room_type_available,n=O(),o=R(),r=n&&o,i="";return i=t&&a&&r?"HOUSE_AND_ROOMTYPE_OVERBOOK":a&&o&&(!t||t&&n)?"ROOMTYPE_OVERBOOK":t&&n&&(!a||a&&o)?"HOUSE_OVERBOOK":"NO_PERMISSION_TO_OVERBOOK"},k=function(t,a){var n={message:t,proceedOverbook:a};p.open({template:"/assets/partials/groups/summary/popups/changeDates/rvGroupChangeSellLimitPopup.html",className:"",scope:e,closeByDocument:!1,closeByEscape:!1,data:JSON.stringify(n)})},N=function(){l(function(){e.$broadcast("DATE_CHANGE_FAILED"),e.reloadPage(e.groupConfigData.activeTab)},500)},B=function(t){if(e.closeDialog(),t.hasOwnProperty("httpStatus"))switch(t.httpStatus){case 470:l(function(){var e=T(t),a=!1;"NO_PERMISSION_TO_OVERBOOK"!==e&&(a=!0),k(e,a)},2e3);break;default:e.errorMessage=t,n(t),N()}else e.errorMessage=t,n(t),N()};e.setCallBacks=function(e){a=e.successCallBack,n=e.failureCallBack},e.callChangeDatesAPI=function(t,a,n){var i=t&&t.dataset,s="changeInArr"in i&&i.changeInArr,c="changeInDep"in i&&i.changeInDep,u={},n="undefined"!=typeof n&&n;o=_.extend({},arguments);var l={group_id:e.groupConfigData.summary.group_id,change_reservation_dates:a,force_fully_over_book:n};s?u={from_date:i.fromDate?C(i.fromDate):null,is_change_in_from_date:!0}:c&&(u={to_date:i.toDate?C(i.toDate):null,is_change_in_to_date:!0}),_.extend(l,u);var t={params:l,successCallBack:E,failureCallBack:B};e.callAPI(r.changeDates,t)};var M=function(){var t=e.groupConfigData.summary,a=parseInt(t.rooms_total)>0,n=0===parseInt(t.total_checked_in_reservations),o=!t.is_a_past_group;return a&&n&&o&&!J()},w=function(t){p.open({template:"/assets/partials/groups/summary/popups/changeDates/moveDates/rvGroupMoveDatesConfirmationPopup.html",className:"",closeByDocument:!1,closeByEscape:!1,scope:e,data:JSON.stringify(t)})},L=function(e){a=e.successCallBack?e.successCallBack:null,n=e.failureCallBack?e.failureCallBack:null,i=e.cancelPopupCallBack?e.cancelPopupCallBack:null;var t={dataset:{fromDate:e.fromDate?e.fromDate:null,toDate:e.toDate?e.toDate:null,oldFromDate:e.oldFromDate?e.oldFromDate:null,oldToDate:e.oldToDate?e.oldToDate:null}};w(t)},G=function(){p.open({template:"/assets/partials/groups/summary/warnBillingInfoPresent.html",className:"",scope:e,closeByDocument:!1,closeByEscape:!1})},$=function(){p.open({template:"/assets/partials/groups/summary/popups/changeDates/moveDates/rvGroupMoveInvalidRateNotAvailable.html",className:"",scope:e,closeByDocument:!1,closeByEscape:!1})},F=function(t){e.closeDialog(),e.groupConfigData.summary.posting_account_billing_info?l(function(){G()},750):a()},x=function(t){if(e.closeDialog(),t.hasOwnProperty("httpStatus"))switch(t.httpStatus){case 470:l(function(){var e=t.rate_available;if(e===!1)return void $();var a=T(t),n=!1;"NO_PERMISSION_TO_OVERBOOK"!==a&&(n=!0),k(a,n)},750);break;default:e.errorMessage=t,n(t)}else e.errorMessage=t,n(t)};e.callMoveDatesAPI=function(t,a){var n=t&&t.dataset,i=n.fromDate?C(n.fromDate):null,s=n.toDate?C(n.toDate):null,c=e.groupConfigData.summary,a="undefined"!=typeof a&&a;o=_.extend({},arguments);var u={group_id:c.group_id,from_date:i,to_date:s,force_fully_over_book:a},t={params:u,successCallBack:F,failureCallBack:x};e.callAPI(r.completeMoveGroup,t)};var U=function(){s("COMPLETE_MOVE")},j=function(){s("CHANGE_DATES")},V=function(){s("DEFAULT")},J=function(){return"COMPLETE_MOVE"===t},H=function(){return"CHANGE_DATES"===t},W=function(){l(function(){V()},100)};e.cancelChangeDatesAction=function(){e.closeDialog(),i&&i(),l(function(){V()},100)},e.getMoveDatesActions=function(){return{shouldShowMoveButton:M,clickedOnMoveButton:U,triggerEarlierArrDateChange:g,triggerLaterArrDateChange:v,arrDateLeftChangeAllowed:c,arrDateRightChangeAllowed:d,triggerEarlierDepDateChange:S,triggerLaterDepDateChange:b,depDateLeftChangeAllowed:h,depDateRightChangeAllowed:y,showDateChangeInvalidWarning:P,isInCompleteMoveMode:J,isInChangeDatesMode:H,clickedOnMoveSaveButton:L,cancelMoveAction:W,setToDefaultMode:V,triggerdChangeDateActions:j}}}();var A=function(t){var a=e.groupConfigData.summary;a=_.extend(a,t.groupSummary),"-1"===a.rate&&(a.uniqId="-1"),a.release_date||(a.release_date=a.block_from),e.isInAddMode()||(a.block_from=new tzIndependentDate(a.block_from),a.block_to=new tzIndependentDate(a.block_to)),e.$broadcast("UPDATED_GROUP_INFO")},S=function(){var t={groupId:e.groupConfigData.summary.group_id},a={successCallBack:A,params:t};e.callAPI(r.getGroupSummary,a)};e.$on("FETCH_SUMMARY",function(e){e.stopPropagation(),S()}),e.initializeDataModelForSummaryScreen=function(){e.groupConfigData={activeTab:o.activeTab,summary:i.groupSummary,holdStatusList:s.data.hold_status,selectAddons:!1,addons:{},selectedAddons:[],activeScreen:"GROUP_ACTUAL"},e.isInAddMode()?e.groupConfigData.summary.is_tax_exempt=!1:(e.groupConfigData.summary.is_tax_exempt=i.groupSummary.is_tax_exempt,e.groupConfigData.summary.tax_exempt_type_id=i.groupSummary.tax_exempt_type.id);var t=e.groupConfigData.summary;"-1"===t.rate&&(t.uniqId="-1"),t.release_date||(t.release_date=t.block_from),e.isInAddMode()||(t.block_from=new tzIndependentDate(t.block_from),t.block_to=new tzIndependentDate(t.block_to),t.shoulder_from_date=new tzIndependentDate(t.shoulder_from_date),t.shoulder_to_date=new tzIndependentDate(t.shoulder_to_date)),o.newGroupName&&(t.group_name=o.newGroupName),l(function(){e.groupSummaryMemento=angular.copy(t)},500),e.accountConfigData={summary:i.accountSummary}};var b=e.$on("GROUP_SUMMARY_UNIQUE_ID_SET",function(t,a){e.groupSummaryMemento&&(e.groupSummaryMemento.uniqId=a.uniqId)});e.hasPermissionToViewTransactionsTab=function(){return u.getPermissionValue("ACCESS_GROUP_ACCOUNT_TRANSACTIONS")},e.switchTabTo=function(t){if(e.errorMessage="",e.actionStatus.isMoveBtnClicked&&(e.$broadcast("RESET_DATE_PICKERS"),e.actionStatus.isMoveBtnClicked=!1),"TRANSACTIONS"===t&&!e.hasPermissionToViewTransactionsTab())return void(e.errorMessage=["Sorry, you don't have the permission to access the transactions"]);var a="SUMMARY"===e.groupConfigData.activeTab,n=a&&"SUMMARY"!==t;return e.isInAddMode()&&n?void(e.errorMessage=["Sorry, Please save the entered information and try to switch the tab"]):(e.groupConfigData.activeTab=t,void l(function(){e.$broadcast("GROUP_TAB_SWITCHED",e.groupConfigData.activeTab)},100))};e.reloadPage=function(t){t=t||"SUMMARY",c.go("rover.groups.config",{id:e.groupConfigData.summary.group_id,activeTab:t},{reload:!0})},e.closeGroupAddonsScreen=function(){e.groupConfigData.selectAddons=!1,e.reloadPage()},e.openGroupAddonsScreen=function(){e.groupConfigData.selectAddons=!0},e.getCurrentTabUrl=function(){var t={SUMMARY:"/assets/partials/groups/summary/rvGroupConfigurationSummaryTab.html",ROOM_BLOCK:"/assets/partials/groups/roomBlock/rvGroupConfigurationRoomBlockTab.html",ROOMING:"/assets/partials/groups/rooming/rvGroupRoomingListTab.html",ACCOUNT:"/assets/partials/accounts/accountsTab/rvAccountsSummary.html",TRANSACTIONS:"/assets/partials/accounts/transactions/rvAccountTransactions.html",ACTIVITY:"/assets/partials/groups/activity/rvGroupConfigurationActivityTab.html"};return t[e.groupConfigData.activeTab]},e.saveNewGroup=function(){if(e.closeDialog(),e.errorMessage="",u.getPermissionValue("CREATE_GROUP_SUMMARY")&&!e.groupConfigData.summary.group_id)if(D()){var t=function(t){e.groupConfigData.summary.group_id=t.group_id,e.groupConfigData.summary.commission_details=t.commission_details,c.go("rover.groups.config",{id:t.group_id}),o.id=t.group_id},a=function(t){e.errorMessage=t};e.groupConfigData.summary.rate||(e.groupConfigData.summary.rate=-1,e.groupConfigData.summary.uniqId="-1",e.groupConfigData.summary.contract_id=null),""!==e.groupConfigData.summary.tax_exempt_type_id&&null!==e.groupConfigData.summary||(e.groupConfigData.summary.is_tax_exempt=!1),e.groupConfigData.summary.shoulder_from_date=e.setShoulderDatesInAPIFormat(e.groupConfigData.summary.block_from,-1*e.groupConfigData.summary.shoulder_from),e.groupConfigData.summary.shoulder_to_date=e.setShoulderDatesInAPIFormat(e.groupConfigData.summary.block_to,e.groupConfigData.summary.shoulder_to),e.callAPI(r.saveGroupSummary,{successCallBack:t,failureCallBack:a,params:{summary:e.groupConfigData.summary}})}else e.errorMessage=["Group's name, from date, to date, room release date and hold status are mandatory"];else e.$emit("showErrorMessage",["Sorry, you don't have enough permission to save the details"])};var P=function(t){var a={errorMessages:t.errorMessage};l(function(){p.open({template:"/assets/partials/groups/summary/popups/detachCardsAPIErrorPopup.html",className:"ngdialog-theme-default stay-card-alerts",scope:e,closeByDocument:!1,closeByEscape:!1,data:JSON.stringify(a)})},500),e.groupConfigData.activeTab="SUMMARY"},I=!1,E=function(e){var t=["selected_room_types_and_bookings","selected_room_types_and_occupanies","selected_room_types_and_rates","group_room_types_count","rooms_pickup","rooms_total","revenue_actual","revenue_potential","shoulder_from_date","shoulder_to_date"],a=JSON.parse(JSON.stringify(e));return dclone(a,t)};e.updateGroupSummary=function(a,o){if(u.getPermissionValue("EDIT_GROUP_SUMMARY")){if(null!==e.groupConfigData.summary.tax_exempt_type_id&&""!==e.groupConfigData.summary.tax_exempt_type_id||(e.groupConfigData.summary.is_tax_exempt=!1),angular.equals(E(e.groupSummaryMemento),E(e.groupConfigData.summary))||I)return o&&c.go(O.name,O.param),!1;var i=function(t){return e.groupConfigData.summary.commission_details=t.commission_details,I=!1,e.groupConfigData.summary.shoulder_from_date=e.setShoulderDatesInAPIFormat(e.groupConfigData.summary.block_from,-1*e.groupConfigData.summary.shoulder_from),e.groupConfigData.summary.shoulder_to_date=e.setShoulderDatesInAPIFormat(e.groupConfigData.summary.block_to,e.groupConfigData.summary.shoulder_to),e.$broadcast("UPDATED_GROUP_INFO",angular.copy(e.groupConfigData.summary)),e.groupSummaryMemento=angular.copy(e.groupConfigData.summary),a&&S(),o&&c.go(O.name,O.param),!0},s=function(t){if(I=!1,!t.hasOwnProperty("httpStatus"))return e.groupConfigData.summary.shoulder_from_date=e.groupSummaryMemento.shoulder_from_date,e.groupConfigData.summary.shoulder_to_date=e.groupSummaryMemento.shoulder_to_date,e.groupConfigData.summary.uniqId=e.groupSummaryMemento.uniqId,e.groupConfigData.summary.rate=e.groupSummaryMemento.rate,e.$broadcast("FAILED_TO_UPDATE_GROUP_INFO",t),e.errorMessage=t,!1;switch(t.httpStatus){case 470:P(t);break;default:e.errorMessage=t.errorMessage}},l=JSON.parse(JSON.stringify(e.groupConfigData.summary));l.company&&delete l.company,l.block_from=n("date")(l.block_from,t.dateFormatForAPI),l.block_to=n("date")(l.block_to,t.dateFormatForAPI),l.release_date=n("date")(l.release_date,t.dateFormatForAPI),l.shoulder_from_date=e.setShoulderDatesInAPIFormat(l.block_from,-1*l.shoulder_from),l.shoulder_to_date=e.setShoulderDatesInAPIFormat(l.block_to,l.shoulder_to),l.rate||(l.rate=-1,l.contract_id=null),I=!0,e.callAPI(r.updateGroupSummary,{successCallBack:i,failureCallBack:s,params:{summary:l}})}else e.$emit("showErrorMessage",["Sorry, the changes will not get saved as you don't have enough permission to update the details"])},e.setShoulderDatesInAPIFormat=function(e,a){"string"==typeof a&&(a=parseInt(a));var o=new tzIndependentDate(e),r=o.addDays(a);return n("date")(r,t.dateFormatForAPI)},e.duplicateGroup=function(){},e.discardNewGroup=function(){e.groupConfigData.summary=angular.copy(r.baseConfigurationSummary),e.groupConfigData.summary.selected_room_types_and_bookings=[],e.groupConfigData.summary.selected_room_types_and_rates=[],e.groupConfigData.summary.selected_room_types_and_occupanies=[],e.groupConfigData.summary.release_date=""},e.shouldShowCompanyCardNavigationButton=function(){return!e.isInAddMode()&&e.groupConfigData.summary.company&&!!e.groupConfigData.summary.company.id},e.shouldShowTravelAgentNavigationButton=function(){return!e.isInAddMode()&&e.groupConfigData.summary.travel_agent&&!!e.groupConfigData.summary.travel_agent.id},e.goToTACard=function(){c.go("rover.companycarddetails",{id:i.groupSummary.travel_agent.id,type:"TRAVELAGENT"})},e.goToCompanyCard=function(){c.go("rover.companycarddetails",{id:i.groupSummary.company.id,type:"COMPANY"})},e.onCompanyCardChange=function(){e.groupConfigData.summary;e.groupConfigData.summary.company&&""===e.groupConfigData.summary.company.name&&(e.groupConfigData.summary.company=null)},e.onTravelAgentCardChange=function(){e.groupConfigData.summary;e.groupConfigData.summary.travel_agent&&""===e.groupConfigData.summary.travel_agent.name&&(e.groupConfigData.summary.travel_agent=null)},e.detachCardFromGroup=function(t){var a={cardType:t};p.open({template:"/assets/partials/groups/summary/popups/detachCardWarningPopup.html",scope:e,closeByDocument:!1,closeByEscape:!1,data:JSON.stringify(a)})},e.$on("TOGGLE_PAYMET_POPUP_STATUS",function(t,a){e.paymentModalOpened=a});var R=function(){var t={focus:function(e,t){return!1}};e.companyAutoCompleteOptions=angular.extend({source:function(e,t){r.searchCompanyCards(e.term).then(function(e){var a=[],n={};$.map(e,function(e){n={label:e.account_name,value:e.id,address:e.account_address,type:e.account_type,contract_access_code:e.current_contracts.length>0?e.current_contracts[0].access_code:null},a.push(n)}),t(a)})},select:function(t,a){return this.value=a.item.label,e.groupConfigData.summary.company.name=a.item.label,e.groupConfigData.summary.company.id=a.item.value,e.isInAddMode()||N(),e.$broadcast("COMPANY_CARD_CHANGED"),v(),!1},change:function(){e.isInAddMode()||e.groupConfigData.summary.company&&e.groupConfigData.summary.company.name||e.paymentModalOpened||(e.groupConfigData.summary.company=e.groupSummaryMemento.company,e.detachCardFromGroup("company")),e.$broadcast("COMPANY_CARD_CHANGED")}},t),e.travelAgentAutoCompleteOptions=angular.extend({source:function(e,t){r.searchTravelAgentCards(e.term).then(function(e){var a=[],n={};$.map(e,function(e){n={label:e.account_name,value:e.id,address:e.account_address,type:e.account_type,contract_access_code:e.current_contracts.length>0?e.current_contracts[0].access_code:null},a.push(n)}),t(a)})},select:function(t,a){return this.value=a.item.label,e.groupConfigData.summary.travel_agent.name=a.item.label,e.groupConfigData.summary.travel_agent.id=a.item.value,e.isInAddMode()||e.updateGroupSummary(),e.$broadcast("TA_CARD_CHANGED"),v(),!1},change:function(){e.isInAddMode()||e.groupConfigData.summary.travel_agent&&e.groupConfigData.summary.travel_agent.name||e.paymentModalOpened||(e.groupConfigData.summary.travel_agent=e.groupSummaryMemento.travel_agent,e.detachCardFromGroup("travel_agent")),e.$broadcast("TA_CARD_CHANGED")}},t)};e.computeAddonsCount=function(){var t=0;angular.forEach(e.groupConfigData.selectedAddons,function(e){t+=parseInt(e.addon_count)}),t>0?e.groupConfigData.summary.addons_count=t:e.groupConfigData.summary.addons_count=null};var O=function(e){var t="GROUPS",a="rover.groups.search",n={},o=e.getPrevStateTitle(),r=e.getPrevStateName(),i=e.getPrevStateParam()||{},s={forRoutes:[h,"rover.reservation.staycard.mainCard.addons","rover.reservation.staycard.mainCard.summaryAndConfirm","rover.reservation.staycard.mainCard.reservationConfirm"],goBackTo:"rover.reservation.search",backTitle:"FIND RESERVATION"},c=["rover.reservation.staycard.reservationcard.reservationdetails","rover.actionsManager"];return _.indexOf(s.forRoutes,r)>=0?(t=s.backTitle,a=s.goBackTo):_.indexOf(c,r)>=0&&(t=o,a=r,n=i),{title:t,name:a,param:n}}(t);e.updateAndBack=function(){return"rover.groups.search"===O.name&&(O.param.origin="BACK_TO_GROUP_SEARCH_LIST"),e.isInAddMode()||"SUMMARY"!==e.groupConfigData.activeTab?("ACCOUNT"===e.groupConfigData.activeTab&&e.$broadcast("UPDATE_ACCOUNT_SUMMARY"),void c.go(O.name,O.param)):void e.updateGroupSummary(!1,!0)};var T=function(){t.setPrevState={title:O.title,callback:"updateAndBack",scope:e},y()};e.$on("showErrorMessage",function(t,a){e.errorMessage=a,v()}),e.parseCurrency=function(e){return e?t.currencySymbol+n("number")(e,2):""};var k=function(){var t=e.isInAddMode()?"menuCreateGroup":"menuManageGroup";e.$emit("updateRoverLeftMenu",t)};e.$on("SAVE_GROUP",function(){e.saveNewGroup()}),e.createGroup=function(){e.$broadcast("CREATE_GROUP")},e.shouldShowTaxExempt=function(){return u.getPermissionValue("TAX_EXEMPT")&&e.taxExemptTypes.length};var N=function(){var t=function(t){if(I=!1,!t.hasOwnProperty("httpStatus"))return e.groupConfigData.summary.shoulder_from_date=e.groupSummaryMemento.shoulder_from_date,e.groupConfigData.summary.shoulder_to_date=e.groupSummaryMemento.shoulder_to_date,e.$broadcast("FAILED_TO_UPDATE_GROUP_INFO",t),e.errorMessage=t,!1;switch(t.httpStatus){case 470:P(t);break;default:e.errorMessage=t.errorMessage}};e.callAPI(r.updateCompanyCard,{successCallBack:S,failureCallBack:t,params:{id:e.groupConfigData.summary.group_id,company_card_id:e.groupConfigData.summary.company?e.groupConfigData.summary.company.id:""}})};e.detachCard=function(t){"company"===t?(e.groupConfigData.summary.company={id:""},e.$broadcast("COMPANY_CARD_CHANGED"),N()):(e.groupConfigData.summary.travel_agent={id:""},e.$broadcast("TA_CARD_CHANGED"),e.updateGroupSummary(!0))},e.cancelDetachment=function(t){"company"===t?e.groupConfigData.summary.company=e.groupSummaryMemento.company:e.groupConfigData.summary.travel_agent=e.groupSummaryMemento.travel_agent},e.cancelGroupMoveAction=function(){p.close(),e.$broadcast("DATE_MOVE_FAILED",{activeTab:e.groupConfigData.activeTab})};var B=function(){e.hotelSettings=m,e.taxExemptTypes=f.results;var t=_.findWhere(e.taxExemptTypes,{is_default:!0});e.defaultTaxExemptTypeId="","undefined"!=typeof t&&(e.defaultTaxExemptTypeId=t.id),e.initializeDataModelForSummaryScreen(),R(),T(),k(),e.countries=g,e.actionStatus={isMoveBtnClicked:!1}};B(),e.$on("$destroy",b)}]),angular.module("sntRover").controller("rvGroupRootCtrl",["$scope","$rootScope","$filter","$timeout","$interval","$log",function(e,t,a,n,o,r){BaseCtrl.call(this,e),e.setHeadingTitle=function(t){e.heading=t,e.setTitle(a("translate")(t))},t.disableObserveForSwipe||(CardReaderCtrl.call(this,e,t,n,o,r),e.observeForSwipe()),e.addListener("UPDATE_HEADING",function(t,a){e.heading=a})}]),angular.module("sntRover").controller("rvActivityCtrl",["$scope","$rootScope","$filter","$stateParams","$timeout",function(e,t,a,n,o){BaseCtrl.call(this,e);var r=50;e.init=function(){e.page=1,e.perPage=r,e.errorMessage="",e.accountActivityLogPagination={id:"ACCOUNT_ACTIVITY_LOG",api:e.updateReport,perPage:r},e.setScroller("report_content")},e.$on("PopulateLogData",function(t,a){e.count=a.total_count,e.activityLogData=a.results,e.$emit("hideLoader"),e.refreshScroller("report_content"),o(function(){e.$broadcast("updatePagination","ACCOUNT_ACTIVITY_LOG")},800)}),e.isOldValue=function(e){return""!==e&&"undefined"!=typeof e&&null!==e},e.initSort=function(){e.sortOrderOfUserASC=!1,e.sortOrderOfDateASC=!1,e.sortOrderOfActionASC=!1,e.sortOrderOfUserDSC=!1,e.sortOrderOfDateDSC=!1,e.sortOrderOfActionDSC=!1},e.sortByUserName=function(){e.sort_field="USERNAME",e.sortOrderOfUserASC?(e.initSort(),e.sortOrderOfUserDSC=!0,e.sort_order="desc"):(e.initSort(),e.sortOrderOfUserASC=!0,e.sort_order="asc"),e.updateReport()},e.sortByDate=function(){e.sort_field="DATE",e.sortOrderOfDateASC?(e.initSort(),e.sortOrderOfDateDSC=!0,e.sort_order="desc"):(e.initSort(),e.sortOrderOfDateASC=!0,e.sort_order="asc"),e.updateReport()},e.sortByAction=function(){e.sort_field="ACTION",e.sortOrderOfActionASC?(e.initSort(),e.sortOrderOfActionDSC=!0,e.sort_order="desc"):(e.initSort(),e.sortOrderOfActionASC=!0,e.sort_order="asc"),e.updateReport()},e.updateReport=function(t){var a={page:t||1,per_page:e.perPage};a.sort_order=e.sort_order,a.sort_field=e.sort_field,e.$emit("updateLogdata",a)};var i=function(){$("head").append("<style id='print-orientation'>@page { size: landscape; }</style>")},s=function(){$("#print-orientation").remove()};e.print=function(){$("header h1").addClass("text-hide"),$(".cards-header").css({marginBottom:"2%"}),i();var e=$("#print-orientation"),t=e.css("background-image"),a=t.replace(/(^url\()|(\)$|[\"\'])/g,"");$("<img>").attr("src",a).on("load",function(){$(this).off("load"),$(this).remove();var e=function(){o(function(){$("header h1").removeClass("text-hide"),$(".cards-header").css({marginBottom:"0"}),s()},1200)};o(function(){sntapp.cordovaLoaded?cordova.exec(e,function(){e()},"RVCardPlugin","printWebView",["","0","","L"]):(window.print(),e())},300)})},e.init()}]),angular.module("sntRover").controller("rvGroupActivityCtrl",["$scope","$rootScope","$filter","$stateParams","rvGroupAccountActivitySrv",function(e,t,a,n,o){BaseCtrl.call(this,e),e.init=function(){e.selectedGroupOrAccountId=e.groupConfigData?e.groupConfigData.summary.group_id:e.accountConfigData.summary.posting_account_id;var t={id:e.selectedGroupOrAccountId,page:1,type:e.groupConfigData?"group":"account",per_page:50},a=function(t){e.$broadcast("PopulateLogData",t)};e.invokeApi(o.fetchActivityLog,t,a)},e.$on("updateLogdata",function(t,a){a.id=e.selectedGroupOrAccountId,a.type=e.groupConfigData?"group":"account";var n=function(t){e.$broadcast("PopulateLogData",t)};e.invokeApi(o.fetchActivityLog,a,n)}),e.$on("GROUP_TAB_SWITCHED",function(t,a){"ACTIVITY"===a&&e.init()}),e.$on("ACCOUNT_TAB_SWITCHED",function(t,a){"ACTIVITY"===a&&e.init()})}]),angular.module("sntRover").controller("rvGroupAddRoomsAndRatesPopupCtrl",["$scope","$rootScope","$filter","rvPermissionSrv","ngDialog","$timeout","rvUtilSrv","rvGroupConfigurationSrv",function(e,t,a,n,o,r,i,s){var c;(function(){BaseCtrl.call(this,e),e.setScroller("room_type_scroller"),e.defaultRoomTypeDetails={best_available_rate_amount:"",single_rate:"",double_rate:"",extra_adult_rate:"",rate_id:""},e.selectedRoomTypeAndRates=i.deepCopy(e.groupConfigData.summary.selected_room_types_and_rates),angular.forEach(e.selectedRoomTypeAndRates,function(e){e.is_configured_in_group&&(e.update_existing_reservations_rate=!1,e.old_single_rate=e.single_rate,e.old_double_rate=e.double_rate,e.old_extra_adult_rate=e.extra_adult_rate)});var a=["room_type_id","room_type_name","best_available_rate_amount","rate_id","best_available_rate_id","update_existing_reservations_rate"];e.roomTypes=i.getListOfKeyValuesFromAnArray(e.selectedRoomTypeAndRates,a),e.roomTypes=_.map(e.roomTypes,function(e){return e.best_available_rate_amount=t.currencySymbol+e.best_available_rate_amount,e}),e.selectedRoomTypeAndRates=_.where(e.selectedRoomTypeAndRates,{is_configured_in_group:!0}),e.originalConfiguredRoomTypeAndRates=i.deepCopy(e.selectedRoomTypeAndRates),0===e.selectedRoomTypeAndRates.length&&(e.selectedRoomTypeAndRates=[],e.selectedRoomTypeAndRates.push(i.deepCopy(e.groupConfigData.summary.selected_room_types_and_rates[0]))),_.each(e.selectedRoomTypeAndRates,function(e){e.room_type_id=e.room_type_id.toString()}),e.selectedRoomTypeAndRates=_.map(e.selectedRoomTypeAndRates,function(e){return e.best_available_rate_amount=(null!==e.rate_currency?e.rate_currency:t.currencySymbol)+e.best_available_rate_amount,e})})();e.changeBestAvailableRate=function(t){var a=_.find(e.roomTypes,function(e){return e.room_type_id==t.room_type_id});if(a){if(t.best_available_rate_amount=a.best_available_rate_amount,t.best_available_rate_id=a.best_available_rate_id,t.rate_id=a.rate_id,e.groupConfigData.summary.rate!==-1){var n=_.findWhere(e.groupConfigData.summary.selected_room_types_and_rates,{room_type_id:parseInt(a.room_type_id,10)});t.single_rate=n.single_rate,t.double_rate=n.double_rate,t.extra_adult_rate=n.extra_adult_rate,t.room_type_name=n.room_type_name}}else t.best_available_rate_amount=""},e.shouldShowAddNewButton=function(t){return!i.isEmpty(t.room_type_id)&&_.pluck(e.selectedRoomTypeAndRates,"room_type_id").length<e.roomTypes.length&&!e.groupConfigData.summary.is_cancelled},e.shouldShowDeleteButton=function(){return e.selectedRoomTypeAndRates.length>=2&&!e.groupConfigData.summary.is_cancelled},e.addNewRoomTypeAndRatesRow=function(){e.selectedRoomTypeAndRates.push(i.deepCopy(e.defaultRoomTypeDetails)),e.refreshScroller("room_type_scroller"),u()};var u=function(){var t=e.$parent.myScroll.room_type_scroller;r(function(){t.scrollTo(t.maxScrollX,t.maxScrollY,500)},300)};e.deleteRoomTypeAndRatesRow=function(t){e.selectedRoomTypeAndRates.splice(t,1),e.refreshScroller("room_type_scroller")},e.clickedOnCancelButton=function(){e.closeDialog()};var l=function(){e.isRoomViewActive?e.fetchCurrentSetOfRoomBlockData():e.fetchRoomTypesDailyRates(),e.closeDialog()},d=function(t){e.errorMessage=t},p=function(){var t=_.filter(e.selectedRoomTypeAndRates,function(e){return"undefined"!=typeof e.room_type_id&&""!==e.room_type_id}),a=["room_type_id","single_rate","double_rate","extra_adult_rate","rate_id","best_available_rate_id","update_existing_reservations_rate"];t=i.getListOfKeyValuesFromAnArray(t,a);var n={group_id:e.groupConfigData.summary.group_id,room_type_and_rates:t};return n},m=function(){var t=_.every(e.selectedRoomTypeAndRates,function(e){return null!==e.single_rate});return t};e.checkIfGroupCustomRateChanged=function(){var t={isGroupDailyRatesEnabled:e.isGroupDailyRatesEnabled};if(!m())return void(e.errorMessage=[a("translate")("NO_SINGLE_RATE_CONFIGURED")]);if(f())e.confirmUpdateRatesWithPickedReservations(e.selectedRoomTypeAndRates,t);else{var n={params:p(),successCallBack:l,failureCallBack:d};e.callAPI(s.updateSelectedRoomTypesAndRates,n)}};var f=function(){return c=!1,angular.forEach(e.selectedRoomTypeAndRates,function(e){e.total_reservations_count>0&&(e.single_rate===e.old_single_rate&&e.double_rate===e.old_double_rate&&e.extra_adult_rate===e.old_extra_adult_rate||(c=!0,e.update_existing_reservations_rate=!0))}),c};e.hideRoomType=function(t,a){if(parseInt(t)===parseInt(a.room_type_id))return!1;var n=_.pluck(e.selectedRoomTypeAndRates,"room_type_id"),o=_.find(n,function(e){return e==a.room_type_id});return!!o},e.shouldDisableRateEdit=function(t){return e.groupConfigData.summary.is_cancelled||t.isRateConfigured&&e.isGroupDailyRatesEnabled}}]),angular.module("sntRover").controller("rvGroupRoomBlockCtrl",["$scope","$rootScope","$filter","rvPermissionSrv","ngDialog","rvGroupConfigurationSrv","$timeout","rvUtilSrv","$interval","$q","dateFilter","Toggles",function(e,t,a,n,o,r,i,s,c,u,l,d){var p,m,f=!1,g=!1,v=null,h=864e5;e.isEmpty=s.isEmpty,e.shouldHideHoldStatus=function(){var t=!e.shouldHideCreateBlockButton()&&e.isInAddMode(),a=e.isInAddMode();return t||a},e.shouldHideRoomsAndPickUpArea=function(){var t=!e.shouldHideCreateBlockButton()&&e.isInAddMode(),a=e.isInAddMode();return t||a};var y=function(){var t=(e.isEmpty(e.startDate.toString()),e.isEmpty(e.endDate.toString()));return t&&t};e.shouldDisableCreateBlockButton=function(){return y()},e.shouldDisableUpdateBlockButton=function(){return!D()},e.shouldHideCreateBlockButton=function(){return e.createButtonClicked},e.shouldHideUpdateButton=function(){return!e.createButtonClicked},e.shouldHideAddRoomsButton=function(){return e.groupConfigData.summary.is_cancelled||e.isRoomViewActive&&e.groupConfigData.summary.selected_room_types_and_bookings.length>0||!e.isRoomViewActive&&e.groupConfigData.summary.selected_room_types_and_daily_rates.length>0},e.shouldShowRoomsRates=function(){return e.isRoomViewActive?e.groupConfigData.summary.selected_room_types_and_bookings.length>0:e.groupConfigData.summary.selected_room_types_and_daily_rates.length>0;
},e.shouldChangeTotalPickUpToReadOnly=function(){return!e.isInAddMode()},e.shouldChangeTotalRoomsToReadOnly=function(){return!e.isInAddMode()};var D=function(){return n.getPermissionValue("EDIT_GROUP_SUMMARY")},C=function(){return n.getPermissionValue("OVERBOOK_ROOM_TYPE")},A=function(){return n.getPermissionValue("OVERBOOK_HOUSE")};e.shouldDisableStartDate=function(){var t=e.groupConfigData.summary,a=t.total_checked_in_reservations>0,n=t.is_cancelled,o=t.is_a_past_group,r=!e.isInAddMode(),i=t.total_checked_out_reservations_count>0;return r&&(a||n||o||i)},e.shouldDisableHoldStatusChange=function(){return!D()||!!e.groupConfigData.summary.is_cancelled},e.shouldShowSaveButton=function(){return e.hasBookingDataChanged&&e.shouldHideAddRoomsButton()},e.shouldShowDiscardButton=function(){return e.hasBookingDataChanged&&e.shouldHideAddRoomsButton()},e.shouldShowRoomBlockActions=function(){return!e.groupConfigData.summary.is_cancelled&&e.shouldHideAddRoomsButton()},e.shouldDisableEndDate=function(){var a=e.groupConfigData.summary,n=new tzIndependentDate(a.block_to)<new tzIndependentDate(t.businessDate),o=a.is_cancelled,r=!e.isInAddMode();return r&&(n||o)};var S=function(){return n.getPermissionValue("CREATE_GROUP_ROOM_BLOCK")},b=function(){return n.getPermissionValue("EDIT_GROUP_ROOM_BLOCK")};e.shouldDisableAddRoomsAndRate=function(){return!S()&&!b()||!e.isRoomViewActive&&0===e.groupConfigData.summary.selected_room_types_and_daily_rates.length},e.shouldHideSingleEntryRow=function(){var t=!!e.roomtype_rate&&e.groupConfigData;return t&&!!e.roomtype_rate.can_edit&&!e.groupConfigData.summary.rate!==-1&&!e.roomtype_rate.rate_config.is_single_rate_configured},e.shouldHideDoubleEntryRow=function(){var t=!!e.roomtype_rate&&e.groupConfigData;return t&&!!e.roomtype_rate.can_edit&&!e.groupConfigData.summary.rate!==-1&&!e.roomtype_rate.rate_config.is_double_rate_configured},e.shouldShowTripleEntryRow=function(t){var a=parseInt(e.groupConfigData.summary.rate)===-1,n=t.can_edit===!1;if(e.shouldShowQuadrupleEntryRow(t))return!0;if(a||n){var o=_.pluck(t.dates,"triple");return o=_.filter(o,function(e){return"undefined"!=typeof e}),o.length>0}return t.rate_config.is_extra_adult_rate_configured&&t.rate_config.is_double_rate_configured},e.shouldShowQuadrupleEntryRow=function(t){var a=parseInt(e.groupConfigData.summary.rate)===-1,n=t.can_edit===!1;if(a||n){var o=_.pluck(t.dates,"quadruple");return o=_.filter(o,function(e){return"undefined"!=typeof e}),o.length>0}return t.rate_config.is_extra_adult_rate_configured&&t.rate_config.is_double_rate_configured},e.addTripleEntryRow=function(t){return!(e.groupConfigData.summary.is_cancelled||!t.can_edit)&&(_.each(t.dates,function(e){e.triple=0,e.triple_pickup=0}),e.bookingDataChanging(),void pe())},e.addQuadrupleEntryRow=function(t){return!(e.groupConfigData.summary.is_cancelled||!t.can_edit)&&(_.each(t.dates,function(e){e.quadruple=0,e.quadruple_pickup=0}),e.bookingDataChanging(),void pe())},e.shouldDisableSingleEntryBox=function(t,a){return!a.can_edit||!!e.groupConfigData.summary.is_cancelled||!t.isModifiable},e.shouldDisableDoubleEntryBox=function(t,a){return!a.can_edit||!!e.groupConfigData.summary.is_cancelled||!t.isModifiable},e.shouldDisableTripleEntryBox=function(t,a){return!a.can_edit||!!e.groupConfigData.summary.is_cancelled||!t.isModifiable},e.shouldDisableQuadrupleEntryBox=function(t,a){return!a.can_edit||!!e.groupConfigData.summary.is_cancelled||!t.isModifiable},e.shouldDisableAddTripleButton=function(t){return!t.can_edit||!!e.groupConfigData.summary.is_cancelled},e.shouldDisableAddQuadrupleButton=function(t){return!t.can_edit||!!e.groupConfigData.summary.is_cancelled},e.copySingleValueToOtherBlocks=function(t,a){_.each(a.dates,function(e){e.is_shoulder_date||(e.single=t.single,e.single_pickup=t.single_pickup)});var n={occupancy:"single",value:t.single};e.selectedRoomType=a,e.showMassUpdateEndDateConfirmation(n),e.bookingDataChanging()},e.copyDoubleValueToOtherBlocks=function(t,a){_.each(a.dates,function(e){e.double=t.double,e.double_pickup=t.double_pickup});var n={occupancy:"double",value:t.double};e.selectedRoomType=a,e.showMassUpdateEndDateConfirmation(n),e.bookingDataChanging()},e.copyTripleValueToOtherBlocks=function(t,a){_.each(a.dates,function(e){e.triple=t.triple,e.triple_pickup=t.triple_pickup});var n={occupancy:"triple",value:t.triple};e.selectedRoomType=a,e.showMassUpdateEndDateConfirmation(n),e.bookingDataChanging()},e.copyQuadrupleValueToOtherBlocks=function(t,a){_.each(a.dates,function(e){e.quadruple=t.quadruple,e.quadruple_pickup=t.quadruple_pickup});var n={occupancy:"quadruple",value:t.quadruple};e.selectedRoomType=a,e.showMassUpdateEndDateConfirmation(n),e.bookingDataChanging()},e.showMassUpdateEndDateConfirmation=function(t){e.overBookingMessage="",L(),o.open({template:"/assets/partials/groups/roomBlock/rvGroupConfirmMassUpdatePopup.html",scope:e,className:"",closeByDocument:!1,closeByEscape:!1,data:JSON.stringify(t)})},e.shouldShowLoadNextSetButton=function(){var t=new tzIndependentDate(e.timeLineStartDate),a=e.groupConfigData.summary.shoulder_to_date||e.groupConfigData.summary.block_to;t.setDate(t.getDate()+14);var n=t<new tzIndependentDate(a);return f&&n&&e.shouldShowRoomsRates()},e.fetchNextSetOfRoomBlockData=function(){e.timeLineStartDate.setDate(e.timeLineStartDate.getDate()+14),e.fetchCurrentSetOfRoomBlockData()};var P=function(){var t=e.groupConfigData.summary,a=14;e.timeLineStartDate<t.shoulder_from_date||e.timeLineStartDate<tzIndependentDate(t.shoulder_from_date)?e.timeLineStartDate=t.shoulder_from_date:(e.timeLineStartDate>t.shoulder_to_date||e.timeLineStartDate>tzIndependentDate(t.shoulder_to_date))&&(e.timeLineStartDate=t.shoulder_to_date),e.timeLineEndDate=moment(e.timeLineStartDate).add(a,"days"),e.timeLineEndDate=e.timeLineEndDate.toDate(),(e.timeLineEndDate>t.shoulder_to_date||e.timeLineEndDate>tzIndependentDate(t.shoulder_to_date))&&(e.timeLineEndDate=t.shoulder_to_date)};e.fetchCurrentSetOfRoomBlockData=function(){P(),e.fetchRoomBlockGridDetails({start_date:I(e.timeLineStartDate),end_date:I(e.timeLineEndDate)})};var I=function(e){return a("date")(e,t.dateFormatForAPI)};e.onTimeLineStartDatePicked=function(t,a){e.timeLineStartDate=new tzIndependentDate(s.get_date_from_date_picker(a)),e.isRoomViewActive?e.fetchCurrentSetOfRoomBlockData():e.fetchRoomTypesDailyRates()},e.onMassUpdateEndDatePicked=function(t,a){e.massUpdateEndDate=new tzIndependentDate(s.get_date_from_date_picker(a))},e.onMassRateUpdateEndDatePicked=function(t,a){e.massRateUpdateEndDate=new tzIndependentDate(s.get_date_from_date_picker(a))},e.bookingDataChanging=function(){e.hasBookingDataChanged=!0,E(),e.getTotalBookedRooms()};var E=function(){e.$$phase||e.$digest()},R=function(t,a){e.startDate=new tzIndependentDate(s.get_date_from_date_picker(a)),e.groupConfigData.summary.block_from=e.startDate;var n=e.groupConfigData.summary,o=n.block_from,r=new tzIndependentDate(p.block_from),c=e.changeDatesActions;if(""===n.release_date.toString().trim()&&(e.groupConfigData.summary.release_date=n.block_from),e.changeDatesActions.isInCompleteMoveMode()){var u=s.getDatesBetweenTwoDates(new tzIndependentDate(s.deepCopy(p.block_from)),new tzIndependentDate(s.deepCopy(p.block_to))).length-1;e.groupConfigData.summary.block_to=new tzIndependentDate(s.get_date_from_date_picker(a)),e.groupConfigData.summary.block_to.setDate(n.block_to.getDate()+u),e.endDate=e.groupConfigData.summary.block_to,e.timeLineStartDate=e.groupConfigData.summary.block_from,e.timeLineEndDate=e.endDate,e.massUpdateEndDate=new tzIndependentDate(e.endDate-864e5)}else o<r&&c.arrDateLeftChangeAllowed()?Se():o>r&&c.arrDateRightChangeAllowed()?new tzIndependentDate(n.first_dep_date)<o?Pe():Ie():e.isInAddMode()||n.is_a_past_group||i(function(){var t={},a={};a.changeInArr=!0,a.oldFromDate=r,a.fromDate=o,t.dataset=a,t.successCallBack=Ce,t.failureCallBack=Ae,e.setCallBacks(t),e.callChangeDatesAPI(t)},100);e.startDate>e.endDate&&(e.endDate=""),e.endDateOptions.minDate=e.startDate,E()},O=function(){var a=tzIndependentDate(t.businessDate),n=e.groupConfigData.summary.shoulder_to_date;return("string"==typeof n||n instanceof String)&&(n=new tzIndependentDate(n)),n<=a},T=function(n,o){e.endDate=new tzIndependentDate(s.get_date_from_date_picker(o)),e.groupConfigData.summary.block_to=e.endDate;var r=e.endDate.addDays(parseInt(e.groupConfigData.summary.shoulder_to));e.groupConfigData.summary.shoulder_to_date=a("date")(r,t.dateFormatForAPI);var c=e.groupConfigData.summary,u=c.block_to,l=new tzIndependentDate(p.block_to),d=e.changeDatesActions;u<l&&d.depDateLeftChangeAllowed()?new tzIndependentDate(c.last_arrival_date)>u?be():Oe():u>l&&d.depDateRightChangeAllowed()?Ne():e.isInAddMode()||O()||i(function(){var t={},a={};a.changeInDep=!0,a.oldToDate=l,a.toDate=u,t.dataset=a,t.successCallBack=Te,t.failureCallBack=ke,e.setCallBacks(t),e.callChangeDatesAPI(t),e.hasBlockDataUpdated=!0},100),e.startDateOptions.maxDate=e.endDate,E()},k=function(){var t=e.groupConfigData.summary,a=t.total_checked_in_reservations>0,n=t.is_cancelled,o=t.is_a_past_group,r=!e.isInAddMode();return r&&(a||n||o)},N=function(){var a=e.groupConfigData.summary,n=new tzIndependentDate(a.block_to)<new tzIndependentDate(t.businessDate),o=a.is_cancelled,r=!e.isInAddMode();return r&&(n||o)},B=function(){var a,n=new tzIndependentDate(e.groupConfigData.summary.shoulder_from_date);return n&&(a=n),a||(a=new tzIndependentDate(t.businessDate)),a},M=function(){var t,a=new tzIndependentDate(e.groupConfigData.summary.shoulder_to_date);return a&&(t=new tzIndependentDate(a-864e5)),t||(t=new tzIndependentDate(e.endDate-864e5)),t},w=function(e){var a=e;return(!e||e<tzIndependentDate(t.businessDate))&&(a=new tzIndependentDate(t.businessDate)),a},L=function(){e.startDate="",e.endDate="";var a="",n=e.groupConfigData.summary;e.timeLineStartDate||(e.timeLineStartDate=""!==n.block_from?new tzIndependentDate(n.block_from):new tzIndependentDate(t.businessDate)),e.timeLineEndDate=new tzIndependentDate(n.block_to),e.isEmpty(n.block_from.toString())||(e.startDate=n.block_from),e.isEmpty(n.block_to.toString())||(e.endDate=n.block_to,a=new tzIndependentDate(e.endDate-864e5)),e.massUpdateEndDate=a;var o={dateFormat:t.jqDateFormat,numberOfMonths:1};e.startDateOptions=_.extend({minDate:new tzIndependentDate(t.businessDate),maxDate:e.groupConfigData.summary.block_to,disabled:k(),onSelect:R},o),e.endDateOptions=_.extend({minDate:w(e.startDate),disabled:N(),onSelect:T},o),e.timeLineStartDateOptions=_.extend({minDate:B(),maxDate:M(),onSelect:e.onTimeLineStartDatePicked},o),e.massUpdateEndDateOptions=_.extend({minDate:""!==n.block_from?new tzIndependentDate(n.block_from):new tzIndependentDate(t.businessDate),maxDate:a,onSelect:e.onMassUpdateEndDatePicked},o);var r=function(){var e=new tzIndependentDate(t.businessDate),a=e;return""!==n.shoulder_from_date&&tzIndependentDate(n.shoulder_from_date)>e&&(a=new tzIndependentDate(n.shoulder_from_date)),a},i=new tzIndependentDate(n.shoulder_to_date-h);e.massRateUpdateEndDateOptions=_.extend({minDate:r(),maxDate:i,onSelect:e.onMassRateUpdateEndDatePicked},o),e.massRateUpdateEndDate=i};e.clickedOnCreateButton=function(){e.createButtonClicked=!0},e.clickedOnSaveButton=function(){e.$emit("showLoader"),e.saveRoomBlock(!1)},e.clickedOnDiscardButton=function(){e.groupConfigData.summary.selected_room_types_and_bookings=s.deepCopy(e.copy_selected_room_types_and_bookings),e.hasBookingDataChanged=!1},e.checkOverBooking=function(e){var t=e.is_house_overbooked,a=e.is_room_type_overbooked,n=A(),o=C(),r=n&&o;return!(!a&&!t)&&(t&&a&&r?"HOUSE_AND_ROOMTYPE_OVERBOOK":a&&o&&(!t||t&&n)?"ROOMTYPE_OVERBOOK":t&&n&&(!a||a&&o)?"HOUSE_OVERBOOK":"NO_PERMISSION_TO_OVERBOOK")};var G=function(t){return t.saved_room_block?(e.copy_selected_room_types_and_bookings=angular.copy(e.groupConfigData.summary.selected_room_types_and_bookings),e.hasBookingDataChanged=!1,e.groupConfigData.summary.rooms_total=e.getMaxOfBookedRooms(),void e.fetchCurrentSetOfRoomBlockData()):(e.saveRoomBlock(!0),!1)},$=function(t){if(t.hasOwnProperty("httpStatus")){if(470===t.httpStatus){var a=e.checkOverBooking(t);a?"NO_PERMISSION_TO_OVERBOOK"===a?F():x(a):e.saveRoomBlock(!0)}}else e.errorMessage=t};e.saveRoomBlock=function(t,a){t=t||!1,i(function(){var n={group_id:e.groupConfigData.summary.group_id,results:e.groupConfigData.summary.selected_room_types_and_bookings,forcefully_overbook_and_assign_rooms:t,overbook_chosen:a},o={params:n,successCallBack:G,failureCallBack:$};e.callAPI(r.saveRoomBlockBookings,o)},0)};var F=function(){o.open({template:"/assets/partials/groups/roomBlock/rvGroupNoPermissionOverBookingPopup.html",className:"",scope:e,closeByDocument:!1,closeByEscape:!1})},x=function(t){var a={message:t};o.open({template:"/assets/partials/groups/roomBlock/rvGroupWarnOverBookingPopup.html",className:"",scope:e,closeByDocument:!1,closeByEscape:!1,data:JSON.stringify(a)})},U=function(){t.$broadcast("UPDATE_POPUP_STATE",{isActive:!0}),o.open({template:"/assets/partials/groups/roomBlock/rvGroupAddRoomAndRatesPopup.html",scope:e,controller:"rvGroupAddRoomsAndRatesPopupCtrl",preCloseCallback:function(){t.$broadcast("UPDATE_POPUP_STATE",{isActive:!1})}})};e.getRoomTypeName=function(t){t=parseInt(t);var a=_.findWhere(e.roomTypes,{id:t});return a?a.name:""},e.getTotalBookedOfIndividualRoomType=function(e){var t=s.convertToInteger;e.single=""!==e.single?t(e.single):"",e.double=""!==e.double?t(e.double):"";var a=0;e.quadruple&&(e.quadruple=t(e.quadruple),a=e.quadruple);var n=0;e.triple&&(e.triple=t(e.triple),n=e.triple);var o=t(e.single)+t(e.double)+n+a;return o},e.getTotalPickedUpOfIndividualRoomType=function(e){var t=s.convertToInteger;e.single_pickup=""!==e.single_pickup?t(e.single_pickup):"",e.double_pickup=""!==e.double_pickup?t(e.double_pickup):"";var a=0;e.quadruple_pickup&&(e.quadruple_pickup=t(e.quadruple_pickup),a=e.quadruple_pickup);var n=0;return e.triple_pickup&&(e.triple_pickup=t(e.triple_pickup),n=e.triple_pickup),t(e.single_pickup)+t(e.double_pickup)+n+a},e.getMaxOfBookedRooms=function(){var t=e.groupConfigData.summary.selected_room_types_and_bookings,a=[],n=[],o={},r=0;if(!t.length)return 0;_.each(t,function(e){_.each(e.dates,function(e){n.push(e)})}),o=_.groupBy(n,"date"),_.each(o,function(t){r=0,_.each(t,function(t){r+=e.getTotalBookedOfIndividualRoomType(t)}),a.push(r)});var i=_.max(a);return i};var j=function(t){e.groupConfigData.summary.selected_room_types_and_rates=t.room_type_and_rates,_.each(e.groupConfigData.summary.selected_room_types_and_rates,function(e){e.isRateConfigured=e.single_rate||e.double_rate||e.extra_adult_rate})},V=function(){e.$emit("hideLoader"),U()},J=function(t){e.errorMessage=t,e.$emit("hideLoader")};e.clickedOnAddRoomsAndRatesButton=function(){var t=e.shouldDisableAddRoomsAndRate();if(!t){var a=[];e.$emit("showLoader");var n={id:e.groupConfigData.summary.group_id};a.push(r.getSelectedRoomTypesAndRates(n).then(j)),u.all(a).then(V,J)}},e.confirmUpdateRatesWithPickedReservations=function(t,a){m=t;var a=a||{};o.open({template:"/assets/partials/groups/roomBlock/rvGroupRoomBlockPickedupReservationsPopup.html",scope:e,className:"",closeByDocument:!1,closeByEscape:!1,data:JSON.stringify(a)})},e.checkIfInhouseReservationsExists=function(t){o.close();var a=!1;angular.forEach(m,function(e){e.total_inhouse_reservations_count>0&&(a=!0)}),a?H(t):t.isBulkUpdate?W(t,!0):t.isGroupDailyRatesEnabled?e.saveRoomTypesDailyRates():e.saveNewRoomTypesAndRates()};var H=function(t){var a=t||{};o.open({template:"/assets/partials/groups/roomBlock/rvGroupInhouseReservationsExistsPopup.html",scope:e,className:"",closeByDocument:!1,closeByEscape:!1,data:JSON.stringify(a)})};e.updateIfInHouseReservationExists=function(t){t.isBulkUpdate?W(t,!0):t.isGroupDailyRatesEnabled?e.saveRoomTypesDailyRates():e.saveNewRoomTypesAndRates()},e.updateRateToNewReservations=function(t){o.close(),angular.forEach(m,function(e){e.is_configured_in_group&&(e.update_existing_reservations_rate=!1)}),t.isBulkUpdate?W(t,!1):t.isGroupDailyRatesEnabled?e.saveRoomTypesDailyRates():e.saveNewRoomTypesAndRates()};var W=function(t,a){var n=t.amount,o=e.groupConfigData.summary.shoulder_from_date,r=e.timeLineStartDate<o?o:e.timeLineStartDate,i={start_date:I(r),end_date:I(e.massRateUpdateEndDate),bulk_updated_for:t.occupancy.toUpperCase(),room_type_id:e.selectedRoomType.room_type_id,amount:n,groupId:e.groupConfigData.summary.group_id,update_existing_reservations_rate:a};e.processMassRateUpdate(i)};e.saveNewRoomTypesAndRates=function(){o.close();var t={params:Y(m),successCallBack:z};e.callAPI(r.updateSelectedRoomTypesAndRates,t)};var z=function(){e.isRoomViewActive?e.fetchCurrentSetOfRoomBlockData():e.fetchRoomTypesDailyRates()},Y=function(t){var a=_.filter(t,function(e){return"undefined"!=typeof e.room_type_id&&""!==e.room_type_id}),n=["room_type_id","single_rate","double_rate","extra_adult_rate","rate_id","best_available_rate_id","update_existing_reservations_rate"];a=s.getListOfKeyValuesFromAnArray(a,n);var o={group_id:e.groupConfigData.summary.group_id,room_type_and_rates:a};return o};e.clickedOnUpdateButton=function(){e.groupConfigData.summary.selected_room_types_and_bookings=[],e.groupConfigData.summary.selected_room_types_and_occupanies=[],e.copy_selected_room_types_and_bookings=[],_.extend(e.groupConfigData.summary,{block_from:e.startDate,block_to:e.endDate,hold_status:e.selectedHoldStatus}),e.updateGroupSummary(),e.hasBlockDataUpdated=!0};var q=function(){e.timeLineStartDateOptions.minDate=B(),e.timeLineStartDateOptions.maxDate=M()},K=function(a){var n=new tzIndependentDate(t.businessDate);e.hasBookingDataChanged=!1,_.each(a.results,function(t){t.start_date=I(e.timeLineStartDate),_.each(t.dates,function(t){var a=new tzIndependentDate(t.date);t.isModifiable=a>=n,t.old_total=e.getTotalBookedOfIndividualRoomType(t)})}),e.groupConfigData.summary.selected_room_types_and_bookings=a.results,e.groupConfigData.summary.selected_room_types_and_occupanies=a.occupancy,e.totalPickups=a.total_picked_count,e.totalBlockedCount=a.total_blocked,e.groupConfigData.summary.rooms_total=a.total_blocked,e.copy_selected_room_types_and_bookings=s.deepCopy(a.results),e.eventsCount=a.eventsCount,e.getTotalBookedRooms(),q(),pe()};e.$on("NG_REPEAT_COMPLETED_RENDERING",function(){i(function(){pe()},0)}),e.fetchRoomBlockGridDetails=function(t){t=t||{};var a=S()&&b();if(a){var n=_.extend(t,{group_id:e.groupConfigData.summary.group_id}),o={params:n,successCallBack:K};e.callAPI(r.getRoomBlockGridDetails,o)}};e.clickedOnMassUpdateSaveButton=function(t,a){var n=t.value,o=e.groupConfigData.summary.block_from,r=e.timeLineStartDate<o?o:e.timeLineStartDate,i=(e.massUpdateEndDate,e.selectedRoomType),s=t.occupancy,c=_.omit(i,["dates"]);c=_.extend(c,i.dates[0]),c[s]=n;var u=_.extend(c,{start_date:I(r),end_date:I(e.massUpdateEndDate),bulk_updated_for:s.toUpperCase(),overbook_chosen:a});e.saveMassUpdate(g,u)};var Q=function(t){return t.saved_room_block?(e.fetchCurrentSetOfRoomBlockData(),void e.closeDialog()):(e.saveMassUpdate(!0,v),!1)},X=function(t){if(t.hasOwnProperty("httpStatus")){if(470===t.httpStatus){var a=e.checkOverBooking(t);a?"NO_PERMISSION_TO_OVERBOOK"===a?(e.overBookingMessage=a,e.disableButtons=!0):(e.overBookingMessage=a,g=!0):e.saveMassUpdate(!0,v)}}else e.errorMessage=t,e.closeDialog()};e.saveMassUpdate=function(t,a){t=t||!1,a=a||{},a=_.pick(a,["group_id","overbook_chosen","forcefully_overbook_and_assign_rooms","start_date","end_date","bulk_updated_for","room_type_id","room_type_name","single","double","quadruple","triple","old_total"]);var n=_.extend(a,{group_id:e.groupConfigData.summary.group_id,forcefully_overbook_and_assign_rooms:t,results:a.data}),o={params:n,successCallBack:Q,failureCallBack:X};e.callAPI(r.saveMassUpdate,o),v=a,g=!1};var Z=function(){var a=new tzIndependentDate(t.businessDate).getDate(),n=new tzIndependentDate(e.groupConfigData.summary.block_from).getDate(),o=new tzIndependentDate(e.groupConfigData.summary.block_to).getDate();o===a&&n!==a?e.timeLineStartDate=new tzIndependentDate(new tzIndependentDate(t.businessDate)-864e5):e.timeLineStartDate=new tzIndependentDate(t.businessDate)},ee=function(){e.fetchCurrentSetOfRoomBlockData()};e.$on("GROUP_TAB_SWITCHED",function(t,a){"ROOM_BLOCK"===a&&(e.isRoomViewActive=!0,e.hasRateChanged=!1,L(),Z(),ee(),_.extend(e.endDateOptions,{disabled:N()}),ge())}),e.$on("UPDATED_GROUP_INFO",function(t){var a=parseInt(e.groupConfigData.summary.shoulder_from)!==parseInt(p.shoulder_from),n=parseInt(e.groupConfigData.summary.shoulder_to)!==parseInt(p.shoulder_to);p=_.extend({},e.groupConfigData.summary),(e.hasBlockDataUpdated||a||n)&&e.fetchCurrentSetOfRoomBlockData()}),e.$on("FAILED_TO_UPDATE_GROUP_INFO",function(t,a){var n=parseInt(e.groupConfigData.summary.shoulder_from)!==parseInt(p.shoulder_from),o=parseInt(e.groupConfigData.summary.shoulder_to)!==parseInt(p.shoulder_to);e.$parent.errorMessage=a,"ROOM_BLOCK"===e.groupConfigData.activeTab&&(n||o)&&e.fetchCurrentSetOfRoomBlockData()}),e.formatDateForUI=function(e,n){var o=typeof e,r="",n=n?n:t.dateFormat;switch(o){case"string":r=a("date")(new tzIndependentDate(e),n);break;case"object":r=a("date")(e,n)}return r},e.getDayOfWeek=function(e,n){var o=typeof e,r="",n=n?n:t.dateFormat;switch(o){case"string":r=a("date")(new tzIndependentDate(e),n);break;case"object":r=a("date")(e,n)}return r},e.getWidthForRoomBlockTimeLine=function(){var t;return t=e.isRoomViewActive?180*e.groupConfigData.summary.selected_room_types_and_occupanies.length+40:180*e.groupConfigData.summary.selected_room_types_rate_view_occupancies.length+40,e.shouldShowLoadNextSetButton()&&(t+=80),t+"px"};var te,ae=function(){e.accordionInitiallyNotCollapsedOptions={header:"p.line-toggle",heightStyle:"content",collapsible:!0,activate:function(e,t){isEmpty(t.newHeader)&&isEmpty(t.newPanel)?t.oldHeader.removeClass("open"):isEmpty(t.oldHeader)&&t.newHeader.addClass("open"),pe()}}},ne=function(){e.createButtonClicked=!0,e.totalPickups=e.totalRooms=0,e.hasBlockDataUpdated=!1,e.selectedHoldStatus="";var t=!e.isInAddMode(),a=e.groupConfigData;e.roomBlockGridTimeLine=[],e.hasBookingDataChanged=!1,_.extend(e.groupConfigData.summary,{selected_room_types_and_bookings:[],selected_room_types_and_occupanies:[],selected_room_types_and_rates:[],selected_room_types_and_daily_rates:[],selected_room_types_rate_view_occupancies:[]}),t&&(e.createButtonClicked=!0,e.totalPickups=a.summary.rooms_pickup,e.totalRooms=a.summary.rooms_total,e.selectedHoldStatus=s.convertToInteger(a.summary.hold_status)),e.holdStatusList=a.holdStatusList},oe="room_rates_grid_scroller",re="room_block_scroller",ie="room_rates_timeline_scroller",se=function(t){var a=e.$parent.myScroll&&e.$parent.myScroll[t];return _.isUndefined(a)&&(a=e.myScroll[t]),a},ce=function(){var t={tap:!0,preventDefault:!1,probeType:3};e.setScroller(re,t);var a=_.extend({scrollX:!0,scrollY:!1,scrollbars:!1},s.deepCopy(t));e.setScroller(ie,a);var n=_.extend({scrollY:!0,scrollX:!0},s.deepCopy(t));e.setScroller(oe,n)},ue=function(){te&&(c.cancel(te),te=void 0)},le=function(){e.$parent.myScroll.hasOwnProperty(ie)?(pe(),te=c(pe,1e3),e.$parent.myScroll[ie].on("scroll",function(){var t=this.x,a=e.$parent.myScroll[oe];ue(),a.scrollTo(t,a.y),Math.abs(this.maxScrollX)-Math.abs(this.x)<=150?f||(f=!0,E()):f&&(f=!1,E())}),e.$parent.myScroll[re].on("scroll",function(){var t=this.y,a=e.$parent.myScroll[oe];a.scrollTo(a.x,t)}),e.$parent.myScroll[oe].on("scroll",function(){var t=this.x,a=this.y;e.$parent.myScroll[ie].scrollTo(t,0),e.$parent.myScroll[re].scrollTo(0,a),Math.abs(this.maxScrollX)-Math.abs(this.x)<=150?f||(f=!0,E()):f&&(f=!1,E())})):i(le,1e3)},de=e.$on("ALL_RENDERED",le);e.$on("$destroy",de),e.$on("$destroy",ue);var pe=function(){e.refreshScroller(re),e.refreshScroller(ie),e.refreshScroller(oe)},me=function(){var t=e.isInAddMode()?"menuCreateGroup":"menuManageGroup";e.$emit("updateRoverLeftMenu",t)},fe=function(){e.groupConfigData.summary.block_from=new tzIndependentDate(p.block_from),e.groupConfigData.summary.block_to=new tzIndependentDate(p.block_to),e.startDate=e.groupConfigData.summary.block_to,e.endDate=e.groupConfigData.summary.block_to,e.endDateOptions.minDate=e.groupConfigData.summary.block_from,e.startDateOptions.maxDate=e.groupConfigData.summary.block_to},_e=function(){e.changeDatesActions={},p=_.extend({},e.groupConfigData.summary),e.isUpdateInProgress=!1,e.isRoomViewActive=!0},ge=function(){e.changeDatesActions=e.getMoveDatesActions(),e.changeDatesActions.setToDefaultMode()},ve=function(){e.reloadPage("ROOM_BLOCK")},he=function(e){};e.clickedOnSaveMoveButton=function(){var t=e.groupConfigData.summary,a=p,n={fromDate:t.block_from,toDate:t.block_to,oldFromDate:a.block_from,oldToDate:a.block_to,successCallBack:ve,failureCallBack:he,cancelPopupCallBack:De};e.changeDatesActions.clickedOnMoveSaveButton(n)},e.clickedOnMoveButton=function(){_.extend(e.endDateOptions,{disabled:!0}),fe(),e.startDateOptions.maxDate="",e.changeDatesActions.clickedOnMoveButton(),e.actionStatus.isMoveBtnClicked=!0};var ye=function(t){var a=0,n=0,o=s.convertToInteger;angular.forEach(e.groupConfigData.summary.selected_room_types_and_bookings,function(e,r){angular.forEach(e.dates,function(e,r){e.date===t&&(a=a+o(e.single)+o(e.double)+o(e.triple)+o(e.quadruple),n=n+o(e.single_pickup)+o(e.double_pickup)+o(e.triple_pickup)+o(e.quadruple_pickup))})});var r=[];return r.totalBlocked=a,r.totalPicked=n,r};e.getTotalBookedRooms=function(){angular.forEach(e.groupConfigData.summary.selected_room_types_and_occupanies,function(e,t){e.totalRoomsBlockedCountPerDay=ye(e.date).totalBlocked,e.totalRoomsPickedCountPerDay=ye(e.date).totalPicked})},e.clickedOnCancelMoveButton=function(){_.extend(e.endDateOptions,{disabled:!1}),e.reloadPage("ROOM_BLOCK")};var De=function(){fe()},Ce=function(){e.reloadPage("ROOM_BLOCK")},Ae=function(t){e.reloadPage("ROOM_BLOCK")},Se=function(){var t=e.groupConfigData.summary,a=p,n={fromDate:t.block_from,oldFromDate:a.block_from,successCallBack:Ce,failureCallBack:Ae,cancelPopupCallBack:De};e.changeDatesActions.triggerdChangeDateActions(),e.changeDatesActions.triggerEarlierArrDateChange(n)},be=function(){var t={cancelPopupCallBack:De,message:"GROUP_EARLIER_DEP_DATE_CHANGE_WARNING"};e.changeDatesActions.triggerdChangeDateActions(),e.changeDatesActions.showDateChangeInvalidWarning(t)},Pe=function(){var t={cancelPopupCallBack:De,message:"GROUP_LATER_ARR_DATE_CHANGE_WARNING"};e.changeDatesActions.triggerdChangeDateActions(),e.changeDatesActions.showDateChangeInvalidWarning(t)},Ie=function(){var t=e.groupConfigData.summary,a=p,n={fromDate:t.block_from,oldFromDate:a.block_from,successCallBack:Ce,failureCallBack:Ae,cancelPopupCallBack:De};e.changeDatesActions.triggerdChangeDateActions(),e.changeDatesActions.triggerLaterArrDateChange(n)},Ee=function(){e.reloadPage("ROOM_BLOCK")},Re=function(e){},Oe=function(){var t=e.groupConfigData.summary,a=p,n={toDate:t.block_to,oldToDate:a.block_to,successCallBack:Ee,failureCallBack:Re,cancelPopupCallBack:De};e.changeDatesActions.triggerdChangeDateActions(),e.changeDatesActions.triggerEarlierDepDateChange(n)},Te=function(){e.reloadPage("ROOM_BLOCK")},ke=function(e){},Ne=function(){var t=e.groupConfigData.summary,a=p,n={toDate:t.block_to,oldToDate:a.block_to,successCallBack:Te,failureCallBack:ke,cancelPopupCallBack:De};e.changeDatesActions.triggerdChangeDateActions(),e.changeDatesActions.triggerLaterDepDateChange(n)},Be=function(){Z(),ee(),L()};(function(){BaseCtrl.call(this,e),me(),_e(),ge(),L(),ce(),ae(),ne(),"ROOM_BLOCK"===e.groupConfigData.activeTab&&Be(),e.isGroupDailyRatesEnabled=d.isEnabled("group_daily_rates")})();e.shouldShowAddTrippleButton=function(t){var a=e.groupConfigData.summary.rate==-1&&t.can_edit&&t.rate_config.is_extra_adult_rate_configured&&!e.shouldShowTripleEntryRow(t);return a},e.shouldShowAddQuadrupleButton=function(t){var a=e.groupConfigData.summary.rate==-1&&t.can_edit&&t.rate_config.is_extra_adult_rate_configured&&!e.shouldShowQuadrupleEntryRow(t)&&e.shouldShowTripleEntryRow(t);return a},e.shouldShowCopyButton=function(t,a){var n;switch(typeof t){case"string":n=new tzIndependentDate(t);break;case"object":n=new tzIndependentDate(t.date)}return n.getTime()===e.groupConfigData.summary.block_from.getTime()||!a&&!t.is_shoulder_date},e.showHouseEventsListPopup=function(t,a){se(ie).disable(),t&&(e.selectedEventDisplayDate=a,o.open({template:"/assets/partials/popups/rvHouseEventsListPopup.html",scope:e,controller:"rvHouseEventsListPopupCtrl",className:"ngdialog-theme-default",closeByDocument:!1,closeByEscape:!0}))},e.toggleRoomRateBtn=function(){e.isRoomViewActive=!e.isRoomViewActive,e.isRoomViewActive?(L(),ee(),pe()):e.fetchRoomTypesDailyRates()};var Me=function(){return P(),{start_date:I(e.timeLineStartDate),end_date:I(e.timeLineEndDate)}};e.fetchNextSetOfRoomTypesRateData=function(){e.timeLineStartDate.setDate(e.timeLineStartDate.getDate()+14),e.fetchRoomTypesDailyRates()},e.addListener("RENDERING_COMPLETE",le),e.rateChanging=function(){e.hasRateChanged=!0,E()};var we=function(e){var t=!0;return _.each(e,function(e){_.each(e.dates,function(e){""===e.single_amount&&(t=!1)})}),t};e.checkIfGroupCustomRateChanged=function(){var t=e.groupConfigData.summary.selected_room_types_and_daily_rates,n={isGroupDailyRatesEnabled:e.isGroupDailyRatesEnabled};return we(t)?void(Le(t)?e.confirmUpdateRatesWithPickedReservations(t,n):e.saveRoomTypesDailyRates()):void(e.errorMessage=[a("translate")("NO_SINGLE_RATE_CONFIGURED")])};var Le=function(e){var t=!1;return angular.forEach(e,function(e){e.total_reservations_count>0&&_.each(e.dates,function(a){a.single_amount===a.old_single_amount&&a.double_amount===a.old_double_amount&&a.extra_adult_amount===a.old_extra_adult_amount||(t=!0,e.update_existing_reservations_rate=!0)})}),t};e.processMassRateUpdate=function(t){var a=function(){e.fetchRoomTypesDailyRates(),e.closeDialog()},n=function(t){e.errorMessage=t,e.closeDialog()},o={params:t,successCallBack:a,failureCallBack:n};e.callAPI(r.performRateMassUpdate,o)},e.clickedOnMassRateUpdateButton=function(t){var a=t.value,n=e.groupConfigData.summary.shoulder_from_date,o=e.timeLineStartDate<n?n:e.timeLineStartDate,r={start_date:I(o),end_date:I(e.massRateUpdateEndDate),bulk_updated_for:t.occupancy.toUpperCase(),room_type_id:e.selectedRoomType.room_type_id,amount:a,groupId:e.groupConfigData.summary.group_id};if(Le(e.groupConfigData.summary.selected_room_types_and_daily_rates)){var i={amount:a,isBulkUpdate:!0,occupancy:t.occupancy};e.confirmUpdateRatesWithPickedReservations(e.groupConfigData.summary.selected_room_types_and_daily_rates,i)}else e.processMassRateUpdate(r)},e.clickedOnCancelButton=function(){e.closeDialog()},e.copySingleCellRateValueToOtherBlocks=function(t,a,n){var o={};_.each(a.dates,function(e){switch(n){case"single_amount":e.single_amount=t.single_amount,o.value=t.single_amount;break;case"double_amount":e.double_amount=t.double_amount,o.value=t.double_amount;break;case"extra_adult_amount":e.extra_adult_amount=t.extra_adult_amount,o.value=t.extra_adult_amount}}),o.occupancy=n,e.selectedRoomType=a,e.showMassUpdateEndDateConfirmation(o),e.rateChanging()},e.shouldDisableRateEntryBox=function(t,a){return!!e.groupConfigData.summary.is_cancelled||!t.isModifiable||!a.can_edit},e.clickedOnSaveRatesButton=function(){e.$emit("showLoader"),e.saveRoomBlock(!1)},e.clickedOnDiscardButtonInRatesView=function(){e.groupConfigData.summary.selected_room_types_and_daily_rates=s.deepCopy(e.copy_selected_room_types_and_daily_rates),e.hasRateChanged=!1},e.saveRoomTypesDailyRates=function(){var t=function(){e.copy_selected_room_types_and_daily_rates=angular.copy(e.groupConfigData.summary.selected_room_types_and_bookings),e.hasRateChanged=!1,e.fetchRoomTypesDailyRates(),e.closeDialog()},a=function(t){e.errorMessage=t,e.closeDialog()};i(function(){var n={group_id:e.groupConfigData.summary.group_id,room_types_and_rates:e.groupConfigData.summary.selected_room_types_and_daily_rates},o={params:n,successCallBack:t,failureCallBack:a};e.callAPI(r.saveRoomTypesDailyRates,o)},0)},e.fetchRoomTypesDailyRates=function(){
var a=function(a){var n=new tzIndependentDate(t.businessDate);_.each(a.results.data.daily_rates,function(t){t.start_date=I(e.timeLineStartDate),t.update_existing_reservations_rate=!1,_.each(t.dates,function(e){var t=new tzIndependentDate(e.date);e.isModifiable=t>=n,e.old_single_amount=e.single_amount,e.old_double_amount=e.double_amount,e.old_extra_adult_amount=e.extra_adult_amount})}),e.groupConfigData.summary.selected_room_types_and_daily_rates=a.results.data.daily_rates,e.groupConfigData.summary.selected_room_types_rate_view_occupancies=a.results.data.occupancy,e.eventsCount=a.eventsCount,e.copy_selected_room_types_and_daily_rates=s.deepCopy(a.results.data.daily_rates),e.hasRateChanged=!1,c(pe,1e3)},n=function(t){e.errorMessage=t},o=S()&&b();if(o){var i=_.extend(Me(),{group_id:e.groupConfigData.summary.group_id}),u={params:i,successCallBack:a,failureCallBack:n};e.callAPI(r.getRoomTypesOccupancyRateDetailsAndEventsCount,u)}},e.shouldDisableRoomRatesToggleBtn=function(){return!e.isGroupDailyRatesEnabled||e.groupConfigData.summary.is_cancelled},e.shouldDisableBulkUpdateButton=function(a){var n=new tzIndependentDate(a.date)<new tzIndependentDate(t.businessDate);return!!e.groupConfigData.summary.is_cancelled||n},e.shouldDisableBulkRateUpdateButton=function(a){var n=new tzIndependentDate(a.date)<new tzIndependentDate(t.businessDate);return!!e.groupConfigData.summary.is_cancelled||n||e.groupConfigData.summary.rate!=-1},e.addListener("RESET_DATE_PICKERS",function(){fe()}),e.shouldShowCopyRateButton=function(e,t){return!t},e.addListener("DATE_MOVE_FAILED",function(t,a){a&&"ROOM_BLOCK"===a.activeTab&&e.clickedOnCancelMoveButton()})}]),angular.module("sntRover").controller("rvGroupRoomingListCtrl",["$scope","$rootScope","rvGroupRoomingListSrv","$filter","$timeout","rvUtilSrv","rvPermissionSrv","$q","ngDialog","rvGroupConfigurationSrv","$state","$window","$stateParams","RVContactInfoSrv",function(e,t,a,n,o,r,i,s,c,u,l,d,p,m){BaseCtrl.call(this,e),e.isPrintClicked=!1,e.isAnyPopupOpen=!1;var f="GROUP_ROOMING_LIST";const g=92;var v=function(){e.emailPrintFilters={excludeRoomNumber:!1,excludeAccompanyingGuests:!1,excludeRoomType:!1}},h=function(){return i.getPermissionValue("CREATE_ROOMING_LIST")},y=function(){return i.getPermissionValue("EDIT_ROOMING_LIST")},D=function(){return i.getPermissionValue("EDIT_RESERVATION")},C=function(){return i.getPermissionValue("CHECK_IN_RESERVATION")},A=function(){return i.getPermissionValue("CHECK_OUT_RESERVATION")};e.shouldShowNoReservations=function(){return 0===e.reservations.length},e.shouldShowAutoRoomAssignmentButton=function(){return!e.shouldShowNoReservations()},e.shouldShowCheckInCheckoutButton=function(){return!e.shouldShowNoReservations()&&!e.groupConfigData.summary.is_cancelled},e.shouldDisableCheckinButton=function(){return 0===e.selected_reservations.length||!C()},e.shouldDisableCheckoutButton=function(){return 0===e.selected_reservations.length||!A()},e.shouldDisableAutoRoomAssignButton=function(){return 0===e.selected_reservations.length||!D()},e.shouldShowThisOccupancyAgainstRoomType=function(t){var a=_.findWhere(e.roomTypesAndData,{room_type_id:parseInt(e.selectedRoomType)});return"undefined"!=typeof a&&a[t]},e.isGuestBlank=function(e){return r.isEmpty(e.guest_card_id)},e.getTimeConverted=function(e){if(null===e||void 0===e)return"";if(e.indexOf("AM")>-1||e.indexOf("PM")>-1)return e;var t=tConvert(e);return t.hh+":"+t.mm+" "+t.ampm},e.isRoomUnAssigned=function(e){return r.isEmpty(e.room_no)},e.toggleDisplayingMode=function(){e.isAddingMode=!e.isAddingMode},e.isEmpty=r.isEmpty,e.formatDateForUI=function(e){var a=typeof e,o="";switch(a){case"string":o=n("date")(new tzIndependentDate(e),t.dateFormat);break;case"object":o=n("date")(e,t.dateFormat)}return o},e.getReservationClass=function(e){var t="";switch(e.toUpperCase()){case"RESERVED":t="arrival";break;case"CHECKING_IN":t="check-in";break;case"CHECKEDIN":t="inhouse";break;case"CHECKING_OUT":t="check-out";break;case"CHECKEDOUT":t="departed";break;case"CANCELED":t="cancel";break;case"NOSHOW":case"NOSHOW_CURRENT":t="no-show";break;default:t=""}return t},e.getRoomStatusClass=function(e){var t="";if(e.room_service_status&&("OUT_OF_SERVICE"===e.room_service_status||"OUT_OF_ORDER"===e.room_service_status))return"room-grey";if("CHECKING_IN"!==e.reservation_status)return t;if(""===e.room_ready_status)return t;if("VACANT"!==e.fostatus)return t+=" room-red";switch(e.room_ready_status){case"INSPECTED":t+=" room-green";break;case"CLEAN":t+="true"===e.checkin_inspected_only?" room-orange":" room-green";break;case"PICKUP":t+=" room-orange";break;case"DIRTY":t+=" room-red"}return t};var S=function(){e.$$phase||e.$digest()};e.gotoRoomBlockTab=function(){e.closeDialogBox(),e.switchTabTo("ROOM_BLOCK")};var b=function(t){c.open({template:"/assets/partials/groups/rooming/popups/general/rvGroupRoomingNoRoomTypeAttachedPopUp.html",className:"",scope:e,closeByDocument:!1,closeByEscape:!1})},P=function(t){r.convertToInteger;e.roomTypesAndData=_.map(t.result,function(e){return e.availableRoomCount=e.availability,e}),e.selectedRoomType=e.roomTypesAndData.length>0?e.roomTypesAndData[0].room_type_id:void 0,e.changedSelectedRoomType()},I=function(t){e.selected_reservations=t.results,e.updateGroupReservationsGuestData()};e.addReservations=function(){if(0===e.roomTypesAndData.length)return b();if(!e.possibleNumberOfRooms.length)return void(e.errorMessage=["No Rooms have been added for the selected Room in the Room Block."]);e.errorMessage="";var o={group_id:e.groupConfigData.summary.group_id,room_type_id:e.selectedRoomType,from_date:""!==e.fromDate?n("date")(e.fromDate,t.dateFormatForAPI):"",to_date:""!==e.toDate?n("date")(e.toDate,t.dateFormatForAPI):"",occupancy:e.selectedOccupancy,no_of_reservations:e.numberOfRooms},r={params:o,successCallBack:I};e.callAPI(a.addReservations,r)};var E=function(e){return n("date")(e,t.dateFormatForAPI)};e.fetchRoomingDetails=function(){var t=h()&&y();if(!t)return void(e.errorMessage=["Sorry, You dont have enough permission to proceed!!"]);var n={id:e.groupConfigData.summary.group_id,from_date:E(e.fromDate),to_date:E(e.toDate)},o={params:n,successCallBack:P};e.callAPI(a.getRoomTypesConfiguredAgainstGroup,o)},e.$on("GROUP_TAB_SWITCHED",function(t,a){"ROOMING"===a&&(e.errorMessage="",M(),oe())});var R=function(){e.roomTypesAndData=[],e.reservations=[],e.resevationsBeforePrint=[],e.occupancyTextMap={1:"Single",2:"Double",3:"Triple",4:"Quadruple"},e.totalResultCount=0,e.totalPickUpCount=0,e.numberOfRooms="1",e.selectedOccupancy="1",e.possibleNumberOfRooms=[],e.isAddingMode=!1,e.sort_field="room_no",e.sort_dir="ASC",e.selected_reservations=[],e.qualifiedReservations=[],e.messageForMassCheckin="",e.roomingListState={editedReservationStart:"",editedReservationEnd:""}};e.shouldShowPagination=function(){return e.totalResultCount>e.perPage};var O=function(){e.perPage=a.DEFAULT_PER_PAGE,e.start=1,e.end=void 0,e.page=1};e.addOrRemoveFromSelectedReservation=function(t){var a=_.findWhere(e.selected_reservations,{id:t.id,is_accompanying_guest:!1}),n=JSON.parse(JSON.stringify(t));if(a){var o=_.indexOf(_.pluck(e.selected_reservations,"id"),t.id);e.selected_reservations.splice(o,1)}else t.is_accompanying_guest&&(t=_.find(e.reservations,{id:t.id,is_accompanying_guest:!1}),t||(t=n,t.is_accompanying_guest=!1)),e.selected_reservations.push(t),e.selected_reservations=_.sortBy(e.selected_reservations,"confirm_no"),e.selected_reservations=_.sortBy(e.selected_reservations,e.sort_field),"DESC"===e.sort_dir&&(e.selected_reservations=e.selected_reservations.reverse())},e.isReservationInSelectedReservation=function(t){var a=_.findWhere(e.selected_reservations,{id:t.id});return"undefined"!=typeof a},e.whetherAllReservationsSelected=function(){var t=_.uniq(e.reservations,function(e){return e.id});return e.selected_reservations.length===t.length},e.selectOrUnSelectAllReservation=function(){var t=e.whetherAllReservationsSelected();if(t)e.selected_reservations=[];else{var a=JSON.parse(JSON.stringify(e.reservations)),n=_.uniq(a,function(e){return e.id});_.each(n,function(e){e.is_accompanying_guest=!1}),e.selected_reservations=_.extend([],n)}},e.whetherReservationsArePartiallySelected=function(){return e.selected_reservations.length<e.reservations.length&&e.selected_reservations.length>0},e.sortBy=function(t){e.sort_field===t?e.sort_dir="ASC"===e.sort_dir?"DESC":"ASC":(e.sort_field=t,e.sort_dir="ASC"),e.fetchReservations()},e.getSortClass=function(t){var a="";return e.sort_field===t&&(a="ASC"===e.sort_dir?"sorting-asc":"sorting-desc"),a},e.changedSelectedRoomType=function(){var t=_.findWhere(e.roomTypesAndData,{room_type_id:parseInt(e.selectedRoomType)}),a="undefined"!=typeof t;e.possibleNumberOfRooms=a?_.range(1,r.convertToInteger(t.availability)+1):[],e.selectedOccupancy="1",a||(e.selectedOccupancy="-1"),"undefined"==typeof e.numberOfRooms&&e.possibleNumberOfRooms.length>0&&(e.numberOfRooms=e.possibleNumberOfRooms[0]),_.max(e.possibleNumberOfRooms)<e.numberOfRooms&&(e.numberOfRooms=e.possibleNumberOfRooms[0])};var T=function(t){e.reservations=t.results,e.totalResultCount=t.total_count,e.totalPickUpCount=t.total_pickup_count,void 0===e.end&&(e.end=e.reservations.length),S(),L(),o(function(){e.$broadcast("updatePagination",f)},100),e.totalResultCount>e.perPage&&(e.selected_reservations=[]),_.each(e.selected_reservations,function(a,n){var o=_.findIndex(t.results,{id:a.id});if(o!=-1){var r=JSON.parse(JSON.stringify(e.reservations[o]));r.is_accompanying_guest=!1,e.selected_reservations[n]=r}})},k=function(t){t=t||1;var a={group_id:e.groupConfigData.summary.group_id,per_page:e.perPage,page:t,sort_field:e.sort_field,sort_dir:e.sort_dir,arrival_date:E(e.arrival_date),dep_date:E(e.dep_date),query:e.query,exclude_cancel:e.exclude_cancel,show_pending_only:e.show_pending_only};return a};e.clearQuery=function(){e.query="",S(),O(),o(e.fetchReservations,500)},e.fetchReservations=function(t){var n=k(t),o={params:n,successCallBack:T};e.callAPI(a.fetchReservations,o)},e.filterReservation=function(){O(),o(e.fetchReservations,10)},e.fiterByQuery=function(){var t,n,o=e.query.trim();(!o.length||o.length>2)&&(O(),t=k(),n={params:t,successCallBack:T},e.callAPI(a.fetchReservations,n))},e.debounceFetchReservations=_.debounce(e.fiterByQuery,500),e.clearDate=function(t){e[t]="",S(),O(),o(e.fetchReservations,500)};var N=function(t,a){e.fromDate=new tzIndependentDate(r.get_date_from_date_picker(a)),e.fromDate>e.toDate?e.toDate="":e.fetchRoomingDetails(),S()},B=function(t,a){e.toDate=new tzIndependentDate(r.get_date_from_date_picker(a)),e.fromDate>e.toDate?e.fromDate="":e.fetchRoomingDetails(),S()},M=function(){var a=e.groupConfigData.summary,n={dateFormat:t.jqDateFormat,numberOfMonths:1};e.isInAddMode()||_.extend(n,{minDate:new tzIndependentDate(a.block_from),maxDate:new tzIndependentDate(a.block_to)}),e.fromDateOptions=_.extend({onSelect:N},n),e.arrivalDateOptions=_.extend({},n),e.toDateOptions=_.extend({onSelect:B},n),e.departureDateOptions=_.extend({},n),e.fromDate=a.block_from,e.toDate=a.block_to},w=function(){var t={tap:!0,preventDefault:!1,deceleration:1e-4,shrinkScrollbars:"clip"};e.setScroller("rooming_list",t)},L=function(){e.refreshScroller("rooming_list")},G=function(){c.open({template:"/assets/partials/groups/rooming/popups/massCheckin/rvGroupMassCheckinSomeResReadyPopUp.html",className:"",scope:e,closeByDocument:!1,closeByEscape:!1})},F=function(){c.open({template:"/assets/partials/groups/rooming/popups/massCheckin/rvGroupMassCheckinNoResMeetCriteria.html",className:"",scope:e,closeByDocument:!1,closeByEscape:!1})},x=function(){c.open({template:"/assets/partials/groups/rooming/popups/autoAssignRooms/rvGroupAutoRoomAssignSomeResReadyPopUp.html",className:"",scope:e,closeByDocument:!1,closeByEscape:!1})},U=function(){c.open({template:"/assets/partials/groups/rooming/popups/autoAssignRooms/rvGroupAutoRoomAssignNoResMeetCriteria.html",className:"",scope:e,closeByDocument:!1,closeByEscape:!1})};e.autoAssignRooms=function(){var t,a,n,o,r,i=e.selected_reservations.length;n=_.filter(e.selected_reservations,function(e){return t=e.reservation_status.toUpperCase(),"RESERVED"===t||"CHECKING_IN"===t}),o=_.filter(n,function(e){return a=e.room_no,null===a||""===a}),r=o.length,r>0?(e.qualifiedReservations=o,e.messageForAutoRoomAssignment=i===r?"":"GROUP_AUTO_ROOM_ASSIGN_CONFIRMATION_PARTIALLY_OKEY",x()):U()};var j=function(t){c.open({template:"/assets/partials/groups/rooming/popups/autoAssignRooms/rvGroupResAutoRoomAssignmentSuccessPopUp.html",className:"",scope:e,closeByDocument:!1,closeByEscape:!1,data:JSON.stringify(t),controller:"rvGroupRoomingAutoRoomAssignPopUpCtrl"})},V=function(t){var a={errorMessage:t};c.open({template:"/assets/partials/groups/rooming/popups/autoAssignRooms/rvGroupResAutoAssignRoomsFailedPopup.html",className:"",scope:e,closeByDocument:!1,closeByEscape:!1,data:JSON.stringify(a)})};e.closeAutoRoomAssignSuccessPopup=function(){e.closeDialogBox(),e.selected_reservations=[],o(function(){oe()},800)};var J=function(t){var a=t.failure_reservation_ids;a.length>0&&(t.failedReservations=[],_.each(t.failure_reservation_ids,function(a){t.failedReservations.push(_.findWhere(e.selected_reservations,{id:a}))})),j(t)},H=function(e){V(e)};e.autoRoomAssignQualifiedReservations=function(){e.closeDialogBox(),o(function(){var t={group_id:e.groupConfigData.summary.group_id,reservation_ids:_.pluck(e.qualifiedReservations,"id")},n={params:t,successCallBack:J,failureCallBack:H};e.callAPI(a.performAutoRoomAssignment,n)},800)};var W=function(t){c.open({template:"/assets/partials/groups/rooming/popups/massCheckin/rvGroupResMassCheckinSuccessPopUp.html",className:"",scope:e,closeByDocument:!1,closeByEscape:!1,data:JSON.stringify(t),controller:"rvGroupRoomingMassCheckinPopUpCtrl"})},z=function(t){var a={errorMessage:t};c.open({template:"/assets/partials/groups/rooming/popups/massCheckin/rvGroupResMassCheckinFailedPopup.html",className:"",scope:e,closeByDocument:!1,closeByEscape:!1,data:JSON.stringify(a)})};e.groupCheckin=function(){var t=_.where(e.selected_reservations,{can_checkin:!0}),a=t.length,n=e.selected_reservations.length;a>0?(e.qualifiedReservations=t,e.messageForMassCheckin=n===a?"":"GROUP_MASS_CHECKIN_CONFIRMATION_PARTIALLY_OKEY",G()):F()},e.closeMassCheckinSuccessPopup=function(){e.closeDialogBox(),e.selected_reservations=[],o(function(){oe()},800)};var Y=function(t){var a=t.failure_reservation_ids;a.length>0&&(t.failedReservations=[],_.each(t.failure_reservation_ids,function(a){t.failedReservations.push(_.findWhere(e.selected_reservations,{id:a}))})),W(t)},q=function(e){z(e)};e.checkInQualifiedReservations=function(){e.closeDialogBox(),o(function(){var t={group_id:e.groupConfigData.summary.group_id,reservation_ids:_.pluck(e.qualifiedReservations,"id")},n={params:t,successCallBack:Y,failureCallBack:q};e.callAPI(a.performMassCheckin,n)},800)};var K=function(){c.open({template:"/assets/partials/groups/rooming/popups/massCheckout/rvGroupMassCheckoutSomeResReadyPopUp.html",className:"",scope:e,closeByDocument:!1,closeByEscape:!1})},Q=function(){c.open({template:"/assets/partials/groups/rooming/popups/massCheckout/rvGroupMassCheckoutNoResMeetCriteria.html",className:"",scope:e,closeByDocument:!1,closeByEscape:!1})},X=function(t){c.open({template:"/assets/partials/groups/rooming/popups/massCheckout/rvGroupResMassCheckoutSuccessPopUp.html",className:"",scope:e,closeByDocument:!1,closeByEscape:!1,data:JSON.stringify(t),controller:"rvGroupRoomingMassCheckoutPopUpCtrl"})},Z=function(t){var a={errorMessage:t};c.open({template:"/assets/partials/groups/rooming/popups/massCheckout/rvGroupResMassCheckoutFailedPopup.html",className:"",scope:e,closeByDocument:!1,closeByEscape:!1,data:JSON.stringify(a)})};e.checkOutQualifiedReservations=function(){e.closeDialogBox(),o(function(){var t={group_id:e.groupConfigData.summary.group_id,reservation_ids:_.pluck(e.qualifiedReservations,"id")},n={params:t,successCallBack:ee,failureCallBack:te};e.callAPI(a.performMassCheckout,n)},800)},e.groupCheckout=function(){var t=_.where(e.selected_reservations,{can_checkout:!0}),a=t.length,n=e.selected_reservations.length;a>0?(e.qualifiedReservations=t,e.messageForMassCheckout=n===a?"":"GROUP_MASS_CHECKOUT_CONFIRMATION_PARTIALLY_OKEY",K()):Q()},e.closeMassCheckoutSuccessPopup=function(){e.closeDialogBox(),e.selected_reservations=[],o(function(){oe()},800)};var ee=function(t){var a=t.failure_reservation_ids;a.length>0&&(t.failedReservations=[],_.each(t.failure_reservation_ids,function(a){t.failedReservations.push(_.findWhere(e.selected_reservations,{id:a}))})),X(t)},te=function(e){Z(e)},ae=function(t){e.$emit("hideLoader"),0===e.roomTypesAndData.length&&b()},ne=function(t){e.$emit("hideLoader"),e.errorMessage=t},oe=function(){var t=h()&&y();if(!t)return void(e.errorMessage=["Sorry, You dont have enough permission to proceed!!"]);var n=[];e.$emit("showLoader");var o={id:e.groupConfigData.summary.group_id,from_date:E(e.fromDate),to_date:E(e.toDate)};n.push(a.getRoomTypesConfiguredAgainstGroup(o).then(P));var r=k();n.push(a.fetchReservations(r).then(T)),n.push(a.fetchHotelReservationSettings().then(function(t){e.maxStayLength=t.max_stay_length||g})),s.all(n).then(ae,ne)};!function(){var t,n=function(e){var a=t.room_id,n=[];t.roomsAvailableToAssign=[],null!==a&&""!==a&&(n=[{id:a,room_number:t.room_no}]),t.roomsAvailableToAssign=n.concat(e.rooms)},o=function(){var a=angular.copy(t),n=null,o=null,i=null,s=null;_.extend(e.roomingListState,{editedReservationStart:t.arrival_date,editedReservationEnd:t.departure_date}),n=_.pluck(e.roomTypesAndData,"room_type_id"),o=!_.contains(n,parseInt(t.room_type_id)),o?(i=[{room_type_id:t.room_type_id,room_type_name:t.room_type_name}],s=_.union(i,r.deepCopy(e.roomTypesAndData))):s=r.deepCopy(e.roomTypesAndData),_.extend(a,{arrival_date:tzIndependentDate(a.arrival_date),departure_date:tzIndependentDate(a.departure_date),roomsFreeToAssign:t.roomsAvailableToAssign,allowedRoomTypes:s}),null===a.room_id&&(a.room_id=""),e.$emit("hideLoader"),l(a)},i=function(t){e.$emit("hideLoader"),e.errorMessage=t},u=function(t){var r=[];e.$emit("showLoader");var c={reserevation_id:t.id,num_of_rooms_to_fetch:5,room_type_id:t.room_type_id};r.push(a.getFreeAvailableRooms(c).then(n)),s.all(r).then(o,i)},l=function(t){c.open({template:"/assets/partials/groups/rooming/popups/editReservation/rvGroupEditRoomingListItem.html",className:"",scope:e,closeByDocument:!1,closeByEscape:!1,controller:"rvGroupReservationEditCtrl",data:JSON.stringify(t)})};e.clickedOnReservation=function(e){t=e,u(e)}}(),e.checkoutReservation=function(e){},e.$on("NG_REPEAT_COMPLETED_RENDERING",function(t){o(function(){"rooming_list"===e.print_type&&re()},500)});var re=function(){ie();var t=$("#print-orientation"),a=t.css("background-image"),n=a.replace(/(^url\()|(\)$|[\"\'])/g,"");$("<img>").attr("src",n).on("load",function(){$(this).off("load"),$(this).remove();var t=function(){o(function(){e.print_type="",se(),e.translations={},e.reservations=r.deepCopy(e.resevationsBeforePrint),e.resevationsBeforePrint=[],e.$emit("UPDATE_HEADING",e.headingBeforePrint),e.headingBeforePrint=""},1200),o(function(){e.isPrintClicked=!1},200)};o(function(){sntapp.cordovaLoaded?cordova.exec(t,function(){t()},"RVCardPlugin","printWebView",["","0","","L"]):(window.print(),t())},300)})},ie=function(){$("body").append("<style id='print-orientation'>@page { size: landscape; }</style>")},se=function(){$("#print-orientation").remove()},ce=function(t){e.isPrintClicked=!0,e.resevationsBeforePrint=r.deepCopy(e.reservations),e.reservations=t.results,e.translations=t.translations,e.print_type="rooming_list",e.headingBeforePrint=e.heading,e.$emit("UPDATE_HEADING",e.translations.group_details)};e.fetchReservationsForPrintingRoomingList=function(){var t={group_id:e.groupConfigData.summary.group_id,per_page:1e3,exclude_cancel:e.exclude_cancel,sort_field:e.sort_field,sort_dir:e.sort_dir,locale:e.printEmailConfig.locale},n={params:t,successCallBack:ce};e.callAPI(a.fetchReservations,n)},e.openEmailPrintPopup=function(){e.isAnyPopupOpen=!0,v();var t=function(t){e.ngData={},e.languageData=t,e.printEmailConfig={locale:t.selected_language_code,showLanguageField:t.show_language_field},c.open({template:"/assets/partials/groups/rooming/popups/general/rvRoomingListEmailPrompt.html",className:"",scope:e,closeByDocument:!1,closeByEscape:!1})},a={onSuccess:t};e.errorMessage="",e.callAPI(m.fetchGuestLanguages,a)},e.sendEmail=function(t){if(!t)return void(e.errorMessage=["Please enter email!!"]);e.errorMessage="";var n=function(t){e.closeDialogBox(),e.isAnyPopupOpen=!1},o=function(t){e.errorMessage=t},r={to_address:t,group_id:e.groupConfigData.summary.group_id,is_include_rate:!e.groupConfigData.summary.hide_rates,exclude_cancel:e.exclude_cancel,exclude_room_no:e.emailPrintFilters.excludeRoomNumber,exclude_accompany_guests:e.emailPrintFilters.excludeAccompanyingGuests,exclude_room_type:e.emailPrintFilters.excludeRoomType,locale:e.printEmailConfig.locale};e.callAPI(a.emailInvoice,{successCallBack:n,failureCallBack:o,params:r})},e.closeDialogBox=function(){e.closeDialog(),e.isAnyPopupOpen=!1},e.printRegistrationCards=function(){e.closeDialog();var n,r,i=function(){$("#print-orientation").remove()},s=function(){$("head").append("<style id='print-orientation'>@page { size: portrait; }</style>")},c=function(a){if(e.$emit("hideLoader"),e.printRegCardData=a,e.isRegistrationCardEnabledFor={austria:!!e.printRegCardData&&e.printRegCardData.austrian_registration_card_enabled,arabia:!!e.printRegCardData&&e.printRegCardData.arabic_registration_card_enabled},_.each(e.printRegCardData.reservations_data,function(e){e.rowspanAustrianRegCardChild=e.guest_details.accompanying_children&&e.guest_details.accompanying_children.length>4?3:2}),0===e.printRegCardData.reservations_data.length)e.errorMessage=["No registration cards to print as there are no future reservations selected"];else{$("header .logo").addClass("logo-hide"),$("header .h2").addClass("text-hide"),s(),e.isPrintRegistrationCard=!0,t.addNoPrintClass=!0;var n=function(){o(function(){e.isPrintRegistrationCard=!1,t.addNoPrintClass=!1,$("header .logo").removeClass("logo-hide"),$("header .h2").addClass("text-hide"),i()},100)};o(function(){sntapp.cordovaLoaded?cordova.exec(n,function(){n()},"RVCardPlugin","printWebView",[]):(d.print(),n())},100)}},u=function(t){e.isPrintRegistrationCard=!1,e.$emit("hideLoader"),e.errorMessage=t};switch(e.errorMessage="",e.sortOptions.sortOrder){case"roomNumberAscending":n="room_no",r="ASC";break;case"roomNumberDescending":n="room_no",r="DESC";break;case"lastNameAscending":n="last_name",r="ASC";break;case"lastNameDescending":n="last_name",r="DESC";break;default:n="room_no",r="ASC"}var l={group_id:e.groupConfigData.summary.group_id,arrival_date:E(e.arrival_date),dep_date:E(e.dep_date),show_pending_only:e.show_pending_only,sort_field:n,sort_dir:r};l["reservation_id[]"]=[],e.selected_reservations.length>0&&e.selected_reservations.length!==e.totalResultCount&&e.selected_reservations.forEach(function(e){l["reservation_id[]"].push(e.id)}),e.callAPI(a.fetchRegistrationCardPrintData,{onSuccess:c,onFailure:u,params:l})},e.sortOptions={sortOrder:""},e.selectSortTypeForPrinting=function(){e.sortOptions.sortOrder="roomNumberAscending",c.open({template:"/assets/controllers/groups/rooming/popups/rvSelectSortTypePopup.html",controller:"",className:"",scope:e})};var ue=function(t){e.groupConfigData.summary.hide_rates=!e.groupConfigData.summary.hide_rates,e.errorMessage=""},le=function(t){e.errorMessage=t};e.clickedShowRate=function(){var t={group_id:e.groupConfigData.summary.group_id,hide_rates:!e.groupConfigData.summary.hide_rates};e.callAPI(u.toggleHideRate,{successCallBack:ue,failureCallBack:le,params:t})},e.updateGroupReservationsGuestData=function(){e.isUpdateReservation=!0;var t=_.uniq(e.selected_reservations,function(e){return e.id});e.totalCountForUpdate=t.length,c.open({template:"/assets/partials/groups/rooming/popups/editReservation/rvAddEditReservationGuestData.html",className:"",scope:e,closeByDocument:!1,closeByEscape:!1,controller:"rvReservationGuestDataPopupCtrl"})};var de=function(){var t=e.isInAddMode()?"menuCreateGroup":"menuManageGroup";e.$emit("updateRoverLeftMenu",t)},pe=function(){e.pageOptions={id:f,perPage:e.perPage,api:e.fetchReservations}};(function(){de(),M(),w(),R(),O(),pe();var t="ROOMING"===e.groupConfigData.activeTab,a="ROOMING"===p.activeTab;"NEW_GROUP"!==p.id?t&&a&&o(function(){oe()},10):(e.groupConfigData.activeTab="SUMMARY",p.activeTab="SUMMARY"),v(),e.translations={}})();e.$on("REFRESH_GROUP_ROOMING_LIST_DATA",function(e){oe()}),e.shouldShowAssignedRoom=function(t){return e.isPrintClicked?!!t.room_no&&!e.emailPrintFilters.excludeRoomNumber:!e.isRoomUnAssigned(t)},e.shouldShowUnAssigned=function(t){return e.isPrintClicked?!t.room_no&&!e.emailPrintFilters.excludeRoomNumber:e.isRoomUnAssigned(t)},e.shouldHideAccompanyGuests=function(t){return!!e.isPrintClicked&&(!!t.is_accompanying_guest&&e.emailPrintFilters.excludeAccompanyingGuests)},e.exportRoomingList=function(){e.errorMessage="";var t=function(t){e.errorMessage=t},n={group_id:e.groupConfigData.summary.group_id,exclude_rate:e.groupConfigData.summary.hide_rates,exclude_cancel:e.exclude_cancel,exclude_room_number:e.emailPrintFilters.excludeRoomNumber,exclude_accompanying_guests:e.emailPrintFilters.excludeAccompanyingGuests,exclude_room_type:e.emailPrintFilters.excludeRoomType,locale:e.printEmailConfig.locale};e.callAPI(a.exportRoomingList,{failureCallBack:t,params:n})}}]),angular.module("sntRover").controller("rvGroupSearchCtrl",["$scope","$rootScope","rvGroupSrv","initialGroupListing","businessDate","$filter","$timeout","$state","rvUtilSrv","rvPermissionSrv","$stateParams",function(e,t,a,n,o,r,i,s,c,u,l){BaseCtrl.call(this,e);var d="GROUP_LIST";e.isEmpty=c.isEmpty,e.groupStatusObj={isExpanded:!1,list:[]},e.getClassAgainstHoldStatus=function(e){return"true"===e.is_take_from_inventory?"":"tentative"};var p=function(e){return"cancel"===e.hold_status.toLowerCase()};e.getClassAgainstPickedStatus=function(e){var t="";return e.total_picked_count>0&&(t="green"),p(e)&&(t+=" red"),t},e.getGuestClassForArrival=function(e){var t=p(e)?"cancel":"check-in";return t},e.getGuestClassForDeparture=function(e){var t=p(e)?"cancel":"check-out";return t},e.clearFromDate=function(){e.fromDate="",e.fromDateForAPI="",m(),e.search()},e.clearToDate=function(){e.toDate="",e.toDateForAPI="",m(),e.search()},e.clearSearchQuery=function(){e.query="",m(),e.search()},e.stringify=c.stringify;var m=function(){e.$$phase||e.$digest()},f=function(t,a){e.fromDate=t,e.fromDateForAPI=tzIndependentDate(c.get_date_from_date_picker(a)),m(),e.search()},g=function(t,a){e.toDate=t,e.toDateForAPI=tzIndependentDate(c.get_date_from_date_picker(a)),m(),e.search()};e.$on("NG_REPEAT_STARTED_RENDERING",function(t){e.$emit("showLoader")}),e.$on("NG_REPEAT_COMPLETED_RENDERING",function(t){i(function(){S()},300),e.$emit("hideLoader")}),e.hasPermissionToAddNewGroup=function(){return u.getPermissionValue("CREATE_GROUP_SUMMARY")},e.searchQueryChanged=function(){return!e.isEmpty(e.query)&&void e.search()};var v=function(){var t=[];return e.groupStatusObj.list.length>0&&_.each(e.groupStatusObj.list,function(e){e.active&&t.push(e.id)}),t},h=function(a){var n={query:e.query,from_date:""!==e.fromDateForAPI?r("date")(e.fromDateForAPI,t.dateFormatForAPI):"",to_date:""!==e.toDateForAPI?r("date")(e.toDateForAPI,t.dateFormatForAPI):"",per_page:e.perPage,page:a,status_ids:v()};return n};e.search=function(t){e.amFirstTimeHere=!1,t=t||1;var n=h(t),o={params:n,successCallBack:y,successCallBackParameters:t,failureCallBack:D};e.callAPI(a.getGroupList,o)};var y=function(t,a){e.groupList=t.groups,e.totalResultCount=t.total_count,S(),e.refreshPagination(d),setTimeout(function(){e.$broadcast("updatePageNo",a)},150)},D=function(t){e.errorMessage=t},C=function(){var a={showOn:"button",dateFormat:t.jqDateFormat,numberOfMonths:1};e.fromDateOptions=_.extend({onSelect:f},a),e.toDateOptions=_.extend({onSelect:g},a),e.fromDate=r("date")(tzIndependentDate(o.business_date),t.dateFormat),e.fromDateForAPI=tzIndependentDate(o.business_date),e.toDate="",e.toDateForAPI=""},A=function(){var t={tap:!0,preventDefault:!1,deceleration:1e-4,shrinkScrollbars:"clip"};e.setScroller("result_showing_area",t)},S=function(){e.refreshScroller("result_showing_area")},b=function(){e.perPage=a.DEFAULT_PER_PAGE,e.start=1,e.end=n.groups.length,e.page=1};e.formatDateForUI=function(e){var a=typeof e,n="";switch(a){case"string":n=r("date")(new tzIndependentDate(e),t.dateFormat);break;case"object":n=r("date")(e,t.dateFormat)}return n},e.shouldShowPagination=function(){return e.totalResultCount>=e.perPage};var P=function(){return e.groupList&&e.groupList.length>0};e.isFirstTimeWithNoResult=function(){return e.amFirstTimeHere&&!P()},e.shouldShowNoResult=function(){return!e.amFirstTimeHere&&!P()},e.gotoAddNewGroup=function(){s.go("rover.groups.config",{id:"NEW_GROUP",newGroupName:e.query})};var I=function(){return{fromDate:e.fromDate,fromDateForAPI:e.fromDateForAPI,toDate:e.toDate,toDateForAPI:e.toDateForAPI,query:e.query,page:e.pageOptions.currentPage,groupStatusObj:e.groupStatusObj}},E=function(){var t=a.getCache();t&&"BACK_TO_GROUP_SEARCH_LIST"===l.origin?(C(),e.fromDate=t.fromDate,e.fromDateForAPI=t.fromDateForAPI,e.toDate=t.toDate,e.toDateForAPI=t.toDateForAPI,e.query=t.query,e.groupStatusObj=t.groupStatusObj,e.search(t.page),a.clearCache()):(C(),e.groupList=n.groups,e.totalResultCount=n.total_count,O(),e.refreshPagination(d))};e.gotoEditGroupConfiguration=function(e){var t=I();a.updateCache(t),s.go("rover.groups.config",{id:e,activeTab:"SUMMARY"})};var R=function(){e.pageOptions={id:d,perPage:e.perPage,api:e.search}},O=function(){var t=function(t){e.groupStatusObj.list=t.hold_status},n={params:{is_group:!0},successCallBack:t};e.callAPI(a.getHoldStatusList,n)};e.clickedGroupStatus=function(){e.groupStatusObj.isExpanded=!e.groupStatusObj.isExpanded},e.clickedGroupStatusItem=function(t){var a=e.groupStatusObj.list[t];a.active=!a.active,e.search()};(function(){e.setHeadingTitle("GROUPS"),e.$emit("updateRoverLeftMenu","menuManageGroup"),e.amFirstTimeHere=!0,A(),b(),R(),E()})()}]),sntRover.controller("rvGroupActionsCtrl",["$scope","$filter","$rootScope","ngDialog","rvGroupActionsSrv","rvUtilSrv","dateFilter","rvPermissionSrv","rvActionTasksSrv",function(e,t,a,n,o,r,i,s,c){e.errorMessage="",e.actionsCount="none",e.actions={},e.newAction={},e.actions.totalCount=0,e.actions.arrivalDateString="",e.actions.departureDateString="",e.selectedAction={},e.selectedAction.created_by_null=!1,e.selectedAction.created_at,e.selectedAction.created_at_time,e.selectedAction.created_by,e.selectedAction.description,e.selectedAction.department,e.selectedAction.id,e.selectedAction.assigned,e.selectedAction.due_at_date,e.selectedAction.due_at_time,e.openingPopup=!1,e.refreshing=!1,e.refreshToEmpty=!1,e.newAction.department={value:""},e.hotel_time="4:00 A.M",e.departmentSelect={},e.departmentSelect.selected,e.timeSelectorList=r.getListForTimeSelector(15,12),e.selectedActionMessage="",e.selectedDepartment="",e.actionsSyncing=!1,e.groupId="",e.isStandAlone=!0,e.editingDescriptionInline=!1;var u=function(){a.isStandAlone?e.isStandAlone=!0:e.isStandAlone=!1,e.groupConfigData.summary.group_id&&(e.groupId=e.groupConfigData.summary.group_id),e.populateTimeFieldValue(),e.setScroller("rvActionListScroller",{click:!0,preventDefault:!1}),e.setUpData(),e.fetchDepartments(),d(e.ngDialogData)};e.lastSavedDescription="",e.updateActionDescription=function(t,a){var n={group_id:e.groupConfigData.summary.group_id,action_task:{id:e.selectedAction.id}};n.action_task.description=a;var r=function(t){e.lastSavedDescription=t.data.description,e.savingDescription=!1,e.$emit("hideLoader")},i=function(t){e.savingDescription=!1,e.$emit("hideLoader")};e.savingDescription&&e.lastSavedDescription!==a&&(a&&""!==a?e.invokeApi(o.updateNewAction,n,r,i):(e.selectedAction.description=e.lastSavedDescription,e.editingDescriptionValue=e.lastSavedDescription));
},e.savingDescription=!1,e.stopEditClick=function(t){!e.starting||t?setTimeout(function(){e.editingDescriptionInline=!1,e.isStandAlone||e.lastSavedDescription!==e.selectedAction.description&&(e.savingDescription||(e.savingDescription=!0,e.updateActionDescription(e.editingDescriptionValue,e.selectedAction.description)))},250):e.startEditDescription()},e.starting=!1,e.startEditDescription=function(){e.starting=!0,e.isStandAlone?(e.starting=!1,e.editingDescriptionInline=!1):(e.isTrace(e.selectedAction.action_task_type)&&(e.editingDescriptionInline=!0),e.starting=!1,e.editingDescriptionValue=e.selectedAction.description)},e.actionsSyncd=!1,e.syncActions=function(t){var a=function(t){e.actions.totalCount=t.total_count,e.actions.pendingCount=t.pending_count,e.actionsSyncd=!0,e.$emit("hideLoader")},n=function(t){e.actionsSyncd=!0};e.invokeApi(o.syncActionCount,t,a,n)},e.setInitialActionsCount=function(t){if(t){e.actions.totalCount=t.action_count,e.actions.pendingCount=t.pending_action_count;var a=e.actions.pendingCount,n=e.actions.totalCount;0===n?e.actionsCount="none":n>0&&0===a?e.actionsCount="all-completed":n>0&&n===a?e.actionsCount="only-pending":e.actionsCount="pending"}};var l=function(){e.refreshScroller("rvActionListScroller")};e.hasArrivalDate=!1,e.hasDepartureDate=!1,e.getArDeDateStr=function(n,o){n||(n=" "),o||(o=" ");var r=e.getDateFromDate(n),i=" ";if(r&&(r=r.toLowerCase(),i=r.substring(0,1).toUpperCase()+r.substring(1,3)+" ")," "!==o){var s=o.split(":"),c=s[0],u=parseInt(c);c<10&&(o="0"+u+":"+s[1])}return n?i+t("date")(new tzIndependentDate(n),a.dateFormat)+"  "+o:o},e.setActionsHeaderInfo=function(){var t=e.groupConfigData.summary.block_from,a=e.groupConfigData.summary.block_to,n=e.getArDeDateStr(t);n?e.hasArrivalDate=!0:e.hasArrivalDate=!1;var o=e.getArDeDateStr(a);o?e.hasDepartureDate=!0:e.hasDepartureDate=!1,e.actions.arrivalDateString=n,e.actions.departureDateString=o},e.getActionsCountStatus=function(t){e.actions.pendingCount=t.pending_group_action_tasks_count;var a=e.actions.pendingCount,n=e.actions.totalCount;return 0===n&&0===a?e.actionsCount="none":n>0&&0===a?e.actionsCount="all-completed":n>0&&n===a?e.actionsCount="only-pending":e.actionsCount="pending",e.actionsCount},e.fetchActionsCount=function(){var t=function(t){e.isRefreshing?setTimeout(function(){e.refreshing=!1,e.$emit("hideLoader"),e.$apply()},500):e.refreshing=!1,e.$emit("hideLoader"),t&&0!==t.total_group_action_tasks_count||e.setRightPane("none"),e.actions.totalCount=t.total_group_action_tasks_count,t||(e.actions.totalCount=0),e.actionsCount=e.getActionsCountStatus(t),e.recountAfterDelete&&(1===e.actions.totalCount&&e.actions[0].is_deleted&&(e.actions.totalCount=0,"none"===e.actionSelected,e.setRightPane("none")),e.recountAfterDelete=!1)},a=function(t){e.$emit("hideLoader"),e.refreshing=!1};e.isRefreshing&&(e.refreshing=!0);var n={id:e.groupConfigData.summary.group_id};e.invokeApi(o.getTasksCount,n,t,a)},e.departments=[],e.fetchDepartments=function(){var t=function(t){e.$emit("hideLoader"),e.departments=t.data.departments,e.departmentsCount=e.departments.length},a=function(t){e.departmentsCount=0,e.$emit("hideLoader")},n={id:e.groupConfigData.summary.group_id};e.invokeApi(o.fetchDepartments,n,t,a)},e.selectAction=function(t){var a=t;a&&(e.selectedAction=a,a.description&&(e.lastSavedDescription=a.description)),e.setRightPane("selected"),e.clearAssignSection()},e.setRightPane=function(t){e.actionSelected=t},e.clearNewAction=function(){e.closeSelectedCalendar(),e.closeNewCalendar(),e.newAction.notes="",e.newAction.department={value:""},e.newAction.time_due="",e.actionsSelectedDate=a.businessDate,e.newAction.hasDate=!1,e.setFreshDate()},e.departmentSelected=!1,e.$watch("newAction.department",function(t,a){t&&null!==t?""===t.value?e.departmentSelected=!1:e.departmentSelected=!0:e.departmentSelected=!1}),e.clearErrorMessage=function(){e.errorMessage=[]},e.postAction=function(){e.selectedAction="selected";var n=function(t){"failure"===t.status&&t.errors&&t.errors[0]&&(e.errorMessage=t.errors[0]),e.fetchActionsList(),e.$emit("SET_ACTIONS_COUNT","new"),e.refreshScroller("rvActionListScroller")},r=function(t){t[0]&&(e.errorMessage=t[0]),e.$emit("hideLoader")},i={group_id:e.groupConfigData.summary.group_id,action_task:{description:e.newAction.notes}};if(e.newAction.department&&e.newAction.department.value&&(i.assigned_to=e.newAction.department.value),e.newAction.date_due){var s=e.newAction.dueDateObj;i.due_at=t("date")(s,a.dateFormatForAPI)+(e.newAction.time_due?"T"+e.newAction.time_due+":00":"")}e.invokeApi(o.postNewAction,i,n,r)},e.reformatDateOption=function(e,t,a){var t=e.split(t),n=t[0],o=t[1],r=t[2];return n+a+o+a+r},e.setUpData=function(){var t=tzIndependentDate(a.businessDate),n=new Date(t),o=("0"+n.getDate()).slice(-2),r=("0"+(n.getMonth()+1)).slice(-2),i=n.getFullYear()+"-"+r+"-"+o;e.fromDate=i},e.setFreshDate=function(){e.newAction.hasDate=!0;var n=new tzIndependentDate(a.businessDate),o=new tzIndependentDate(e.groupConfigData.summary.block_from);e.newAction.dueDateObj=n>o?n:o,e.newAction.date_due=t("date")(e.newAction.dueDateObj,a.dateFormat),e.newAction.time_due||(e.newAction.time_due=t("date")(e.hotel_time,"HH:mm"),e.newAction.time_due=r.roundToNextQuarter(parseInt(t("date")(e.hotel_time,"HH"),10),parseInt(t("date")(e.hotel_time,"mm"),10)))},e.actionsDateOptions={firstDay:1,changeYear:!0,changeMonth:!0,dateFormat:a.jqDateFormat,minDate:tzIndependentDate(a.businessDate),yearRange:"0:+10",onSelect:function(n,o){var i=new tzIndependentDate(r.get_date_from_date_picker(o));null!==e.dateSelection&&("select"===e.dateSelection?(e.selectedAction.due_at_date=t("date")(i,a.dateFormat),e.selectedAction.dueDateObj=i,e.selectedAction.hasDate=!0,e.usingCalendar&&e.updateAction(),e.closeSelectedCalendar()):(e.newAction.hasDate=!0,e.newAction.date_due=t("date")(i,a.dateFormat),e.newAction.dueDateObj=i,e.newAction.time_due||(e.newAction.time_due=e.timeFieldValue[0]),e.closeNewCalendar()))}},e.onTimeChange=function(){e.updateAction()},e.updateAction=function(){var n=function(){e.$emit("hideLoader"),e.refreshActionList(),e.refreshScroller("rvActionListScroller")},r=function(t){t[0]&&(e.errorMessage="Internal Error Occured"),e.$emit("hideLoader")},i={group_id:e.groupConfigData.summary.group_id,action_task:{id:e.selectedAction.id}};if(e.lastSelectedItemId=e.selectedAction.id,"string"==typeof e.selectedAction.due_at_date||"number"==typeof e.selectedAction.due_at_date){var s=e.selectedAction.dueDateObj||new tzIndependentDate(e.selectedAction.due_at_str);i.due_at=t("date")(s,a.dateFormatForAPI)+(e.selectedAction.due_at_time?"T"+e.selectedAction.due_at_time+":00":""),e.invokeApi(o.updateNewAction,i,n,r)}},e.getBasicDateInMilli=function(e,t){"string"!=typeof t&&(t="/");var a=e.split(t),n=new Date;return n.setFullYear(a[2]),n.setMonth(a[0]-1),n.setDate(a[1]),n.valueOf()},e.showCalendar=function(){n.open({template:"/assets/partials/reservationCard/Actions/rvReservationCardActionsCalendar.html"})},e.usingCalendar=!1,e.getDateObj=function(e,t){var a,n,o,r=e.split(t);return o=r[1],n=r[0],a=r[2],{day:o,month:n,year:a}},e.showSelectCalendar=function(){var a=tzIndependentDate(e.selectedAction.due_at_str);e.actionsSelectedDate=t("date")(a,"yyyy-MM-dd"),e.usingCalendar=!0,e.dateSelection="select",e.selectCalendarShow=!0},e.closeSelectedCalendar=function(){e.usingCalendar=!1,e.dateSelection=null,e.selectCalendarShow=!1},e.showNewCalendar=function(){e.dateSelection="new",e.newCalendarShow=!0,e.usingCalendar=!0},e.closeNewCalendar=function(){e.dateSelection=null,e.newCalendarShow=!1,e.usingCalendar=!1},e.initNewAction=function(){e.clearNewAction(),e.setRightPane("new")},e.getDefaultDueDate=function(){return new Date},e.cancelNewAction=function(){e.actions.totalCount>0?(e.lastSelectedItemId&&e.selectAction(e.actions[e.lastSelectedItemId]),e.setRightPane("selected")):e.setRightPane("none"),e.clearNewAction()},e.cancelAssign=function(){e.setRightPane("selected"),e.clearAssignSection()};e.refreshingList=function(){return e.refreshing||e.refreshToEmpty?(e.$emit("showLoader"),!0):(setTimeout(function(){e.$emit("hideLoader")},1200),!1)},e.refreshingToNonEmpty=function(){return!(!e.refreshing||e.refreshToEmpty)},e.showActionsList=function(){return!(!(e.actions.totalCount>0||e.refreshing)||e.refreshToEmpty)},e.showErrMsg=function(){return""!=e.errorMessage},e.isOverlayRequest=function(t){return!(e.isStandAlone||!e.isRequest(t.action_task_type))},e.isStandAloneAction=function(t){return!(!t||e.isTrace(t.action_task_type)||e.isRequest(t.action_task_type)||e.isAlert(t.action_task_type))},e.showActionSummary=function(){return!!("selected"===e.actionSelected||"selected"===e.actionSelected&&e.refreshing)},e.showNewAction=function(){return!("new"!==e.actionSelected&&!e.refreshing)},e.showNewActionOnly=function(){return 0===e.actions.totalCount&&"new"===e.actionSelected&&!e.refreshToEmpty},e.showEmptyActions=function(){return!!(0===e.actions.totalCount&&"none"===e.actionSelected||e.refreshToEmpty)},e.postActionEnabled=function(){return!e.newAction.hasDate||!e.newAction.notes||!e.departmentSelected&&!e.isStandAlone},e.showAssignScreen=function(){return!!("assign"===e.actionSelected||"assign"===e.actionSelected&&e.refreshing)},e.lastSelectedItemId="",e.refreshActionList=function(n,r){e.fetchDepartments();var s=function(o){var s=o.business_date_time.split("T");e.hotel_time=s[0]+"T"+s[1].split(/[+-]/)[0];var c=o.data;for(var u in c){if(null!==c[u].assigned_to?c[u].assigned=!0:c[u].assigned=!1,c[u].due_at_time=c[u].time_due?t("date")(c[u].due_at_str,"HH:mm"):"00:00","string"==typeof c[u].due_at){var d=c[u].due_at_str.split("T");c[u].due_at_time=i(d[0]+"T"+d[1].split(/[+-]/)[0],"HH:mm"),c[u].due_at_time_str=i(d[0]+"T"+d[1].split(/[+-]/)[0],"hh:mm a"),c[u].due_at_date=i(d[0],a.dateFormat),c[u].hasDate=!0}else c[u].hasDate=!1;c[u].created_at&&(c[u].created_at_time=m(c[u].created_at,"created_at_time"),c[u].created_at_date=v(c[u].created_at)),"COMPLETED"===c[u].action_status&&(c[u].isCompleted=!0,c[u].date_completed=g(c[u].completed_at),c[u].time_completed=f(c[u].completed_at))}var p,_,h=!1;if(c.length>=e.actions.length)for(var u in c){p=c[u],h=!1;for(var y in e.actions)_=e.actions[y],_.id===p.id&&(e.isStandAlone?(e.actions[y]=p,h=!0):e.isStandAlone||("delete"===n&&r?r.id===p.id&&(h=!0):(e.actions[y]=p,h=!0)));h||e.actions.push(p)}for(var D in e.actions)r&&e.actions[D].id===r.id&&(e.actions[D].is_deleted=!0,l());e.fetchActionsCount(),e.setActionsHeaderInfo();var C=e.isStandAlone;if(e.lastSelectedItemId){for(var A in e.actions)if(C)e.lastSelectedItemId===e.actions[A].id&&e.selectAction(e.actions[A]);else if(!e.isStandAlone)if(e.lastSelectedItemId!==e.actions[A].id||n)if(e.actions[0].is_deleted)if(e.actions[A].is_deleted){for(var y in e.actions)if(!e.actions[y].is_deleted){e.selectAction(e.actions[y]),e.$emit("hideLoader");break}}else e.selectAction(e.actions[A]);else e.selectAction(e.actions[0]);else e.selectAction(e.actions[A])}else e.setDefaultActionSelected(0);e.refreshToEmpty&&(e.refreshToEmpty=!1),e.refreshing&&(e.refreshing=!1)},c=function(t){e.$emit("hideLoader"),e.refreshToEmpty=!1,e.refreshing=!1},u={id:e.groupConfigData.summary.group_id};e.invokeApi(o.getActionsTasksList,u,s,c)},e.hasActionStatus=function(){return!!e.actions&&("none"===e.actionSelected||"new"===e.actionSelected||!!((e.actions.totalCount>0||e.refreshing)&&!e.refreshToEmpty||0===e.actions.totalCount&&"none"===e.actionSelected||e.refreshToEmpty))},e.isDeletePending=function(e,t){for(var a in t)if(t[a]===e)return!0;return!1},e.capped=function(e){if(e){var t=e.toLowerCase();t[0].toUpperCase()}return t},e.eitherString=function(t,a){return!!a&&(t===a||(t===a.toUpperCase()||(t===a.toLowerCase()||t===e.capped(a))))},e.isAlert=function(t){var a="ALERT";return!!e.eitherString(a,t)},e.isRequest=function(t){var a="REQUEST";return!!e.eitherString(a,t)},e.isTrace=function(t){var a="TRACE";return!!e.eitherString(a,t)};var d=function(n){var o=n.business_date_time.split("T");e.hotel_time=o[0]+"T"+o[1].split(/[+-]/)[0];var r=n.data;for(var s in r){if(null!==r[s].assigned_to?r[s].assigned=!0:r[s].assigned=!1,"string"==typeof r[s].due_at){var c=r[s].due_at_str.split("T");r[s].due_at_time=i(c[0]+"T"+c[1].split(/[+-]/)[0],"HH:mm"),r[s].due_at_time_str=i(c[0]+"T"+c[1].split(/[+-]/)[0],"hh:mm a"),r[s].due_at_date=i(c[0],a.dateFormat),r[s].hasDate=!0}else r[s].hasDate=!1;"COMPLETED"===r[s].action_status&&(r[s].isCompleted=!0,r[s].date_completed=g(r[s].completed_at,"date_completed"),r[s].time_completed=f(r[s].completed_at,"time_completed")),r[s].created_at&&(r[s].created_at_time=t("date")(r[s].created_at,"hh:mm a"),r[s].created_at_date=t("date")(r[s].created_at,a.dateFormat))}e.actions=r,e.actions.totalCount=r.length,0===r.length&&(e.actionSelected="none"),e.setActionsHeaderInfo(),e.actions[0]&&e.selectAction(e.actions[0]),l()},p=function(t){e.$emit("hideLoader"),e.setActionsHeaderInfo()};e.fetchActionsList=function(){e.fetchDepartments();var t={id:e.groupConfigData.summary.group_id};e.invokeApi(o.getActionsTasksList,t,d,p)};var m=function(e,t){var a=new Date(e);return y(a.valueOf(),t)},f=function(e,t){return"string"==typeof e?h(parseInt(e),t):"number"==typeof e?h(e,t):void 0};e.setDefaultActionSelected=function(t){t||(t=0),setTimeout(function(){e.actions[t]&&e.selectAction(e.actions[t])},100)};var g=function(e,n){var o,r,i,s;if("string"==typeof e){var c=parseInt(e);o=new Date(c)}else"number"==typeof e&&(o=new Date(e));return r=o.getDate(),i=o.getMonth()+1,s=o.getFullYear(),r<10&&(r="0"+r),i<10&&(i="0"+i),t("date")(new tzIndependentDate(s+"-"+i+"-"+r),a.dateFormat)},v=function(e){if(e){var n,o,r,i=e.split("T"),s=i[0].split("-");return r=s[0],n=s[1],o=s[2],t("date")(new tzIndependentDate(r+"-"+n+"-"+o),a.dateFormat)}};e.getDateFromDate=function(e){var a=new Date(e),n=a.getDay();switch(a.getDay()){case 0:return t("translate")("SUNDAY");case 1:return t("translate")("MONDAY");case 2:return t("translate")("TUESDAY");case 3:return t("translate")("WEDNESDAY");case 4:return t("translate")("THURSDAY");case 5:return t("translate")("FRIDAY");case 6:return t("translate")("SATURDAY")}return n};var h=function(e,t){var a=new Date(e),n=a.getHours(),o=a.getMinutes(),r=a.getSeconds();return n<10&&(n="0"+n),o<10&&(o="0"+o),r<10&&(r="0"+r),D(n+""+o)},y=function(e,t){var a,n,o,r=new Date(e);return"created_at_time"===t?(a=r.getHours(),n=r.getMinutes(),o=r.getSeconds()):(a=r.getHours(),n=r.getMinutes(),o=r.getSeconds()),a<10&&(a="0"+a),n<10&&(n="0"+n),o<10&&(o="0"+o),D(a+""+n)},D=function(e){var t=parseInt(e.substring(0,2)),a=(t+11)%12+1,n=t>11?" PM":" AM",o=e.substring(2);return"number"==typeof a&&a<10&&(a="0"+a),a+":"+o+n};e.populateTimeFieldValue=function(){var t=function(e){var t=parseInt(e.substring(0,2)),a=(t+11)%12+1,n=t>11?" PM":" AM",o=e.substring(2);return parseInt(a)<10&&(a="0"+a),a+":"+o+n};e.timeFieldValue=[];for(var a in e.timeFieldValues)e.timeFieldValue.push({value:t(e.timeFieldValues[a]),core_time:e.timeFieldValues[a]})},e.timeFieldValue=[],e.timeFieldValues=["0000","0015","0030","0045","0100","0115","0130","0145","0200","0215","0230","0245","0300","0315","0330","0345","0400","0415","0430","0445","0500","0515","0530","0545","0600","0615","0630","0645","0700","0715","0730","0745","0800","0815","0830","0845","0900","0915","0930","0945","1000","1015","1030","1045","1100","1115","1130","1145","1200","1215","1230","1245","1300","1315","1330","1345","1400","1415","1430","1445","1500","1515","1530","1545","1600","1615","1630","1645","1700","1715","1730","1745","1800","1815","1830","1845","1900","1915","1930","1945","2000","2015","2030","2045","2100","2115","2130","2145","2200","2215","2230","2245","2300","2315","2330","2345"],e.clearAssignSection=function(){e.departmentSelect.selected={},e.closeSelectedCalendar(),e.closeNewCalendar()},e.departmentSelect={},e.assignDepartment=function(){var t=e.getBaseParams();if(e.departmentSelect.selected){t.assigned_to=e.departmentSelect.selected.value,t.action_task.id=e.selectedAction.id;var a=function(){e.actionSelected="selected",e.lastSelectedItemId=t.action_task.id,e.refreshActionList(),e.clearAssignSection()},n=function(t){t[0]&&(e.errorMessage="Internal Error Occured"),e.$emit("hideLoader")};e.invokeApi(o.updateNewAction,t,a,n)}},e.initRefresh=function(t){e.isRefreshing=!0;var a=!1;"delete"===t&&(a=!0);var n=e.actions.totalCount-1<=0;a&&n?(e.refreshToEmpty=!0,e.actionSelected="none",e.actions.totalCount=0,e.recountAfterDelete=!0):(e.refreshing=!0,e.refreshToEmpty=!1,e.actionSelected="selected")},e.endRefresh=function(){e.isRefreshing=!1},e.isRefreshing=!0,e.completeAction=function(t,a){var n=e.getBaseParams();n.action_task.id=e.selectedAction.id,n.is_complete=!0,e.initRefresh(t);var r=function(){"delete"===t&&e.actions.totalCount--,e.lastSelectedItemId=n.action_task.id,e.refreshActionList(t,a),e.actions.totalCount-1<=1&&"delete"!==t&&(e.actionSelected="selected"),e.isRefreshing=!1,e.$emit("SET_ACTIONS_COUNT","complete")},i=function(t){t[0]&&(e.errorMessage=t[0]),e.$emit("hideLoader"),e.endRefresh()};e.invokeApi(o.completeAction,n,r,i)},e.assignAction=function(){e.actionSelected="assign"},e.reassignAction=function(){var t=e.selectedAction.assigned_to.id+"",a=_.findWhere(e.departments,{value:t});e.departmentSelect.selected=a,e.actionSelected="assign"},e.getBaseParams=function(){var t={group_id:e.groupConfigData.summary.group_id,action_task:{}};return t},e.sortActionsList=function(e){var t=[],a=[];for(var n in e)e[n].date_completed?t.push(e[n]):a.push(e[n])},e.closeDialog=function(){n.close()};var C=function(t){var a=function(){e.actionSelected="selected",e.lastSelectedItemId=t.action_task.id,e.refreshActionList(),e.clearAssignSection()},n=function(t){t[0]&&(e.errorMessage="Internal Error Occured"),e.$parent.$emit("hideLoader")};e.invokeApi(o.updateNewAction,t,a,n)};e.getActionStatusInfo=function(e){var t=e.action_status;return"delete"===t?t="Delete Action?":e.over_due&&"COMPLETED"!==t&&(t="OVERDUE"),t},e.shouldShowEditAndCompleteBtns=function(e){return["UNASSIGNED","ASSIGNED"].indexOf(e.action_status)>-1},e.shouldShowDeleteBtn=function(e){return["UNASSIGNED","ASSIGNED","COMPLETED"].indexOf(e.action_status)>-1},e.prepareEditAction=function(t){e.actionSelected="edit";var a=t.assigned_to,n="";a&&a.id&&(n=_.findWhere(e.departments,{value:a.id+""})),e.newAction={department:n,time_due:t.due_at_time,date_due:t.due_at_date,hasDate:!0,notes:t.description,actionId:t.id}};var A=function(){var n={group_id:e.groupConfigData.summary.group_id,action_task:{id:e.newAction.actionId}};if(e.newAction.department?n.assigned_to=e.newAction.department.value:n.assigned_to="",e.newAction.date_due){var o=e.newAction.dueDateObj;if(!o){var r=e.newAction.date_due.split("-");o=getTZIndependentDateFromDayMonthYear(r[0],r[1],r[2])}n.due_at=t("date")(o,a.dateFormatForAPI)+(e.newAction.time_due?"T"+e.newAction.time_due+":00":"")}return e.newAction.notes&&(n.action_task.description=e.newAction.notes),n};e.handleActionUpdate=function(){var e=A();C(e)},e.cancel=function(){0===e.actions.totalCount?e.setRightPane("none"):e.setRightPane("selected")},e.hasPermissionToEditAction=function(){return s.getPermissionValue("EDIT_ACTION")},e.prepareDeletAction=function(){e.selectedAction.originalStatus=e.selectedAction.action_status,e.selectedAction.action_status="delete"},e.deleteAction=function(){var t=function(){e.fetchActionsList(),e.refreshScroller("rvActionListScroller"),e.$emit("SET_ACTIONS_COUNT",{deletedActionStatus:e.selectedAction.action_status})},a=function(t){t[0]&&(e.errorMessage="Internal Error Occured")},n={params:e.selectedAction.id,onSuccess:t,onFailure:a};e.callAPI(c.deleteActionTask,n)},e.hasPermissionToDeleteAction=function(){return s.getPermissionValue("DELETE_ACTION")},e.cancelDelete=function(){e.selectedAction.action_status=e.selectedAction.originalStatus},e.getActionStatusClass=function(e){var t=e.action_status;return"delete"===t&&(t=e.originalStatus),t},u()}]),angular.module("sntRover").controller("rvGroupConfigurationAddonsCtrl",["$scope","$rootScope","RVReservationAddonsSrv","rvGroupConfigurationSrv","ngDialog",function(e,t,a,n,o){BaseCtrl.call(this,e),e.setScroller("enhanceGroupStays"),t.setPrevState={title:"GROUP DETAILS",name:"rover.groups.config",callback:"backToGroupDetails",scope:e},e.setHeadingTitle("Add-ons & Packages");var r=function(){e.refreshScroller("enhanceGroupStays")};e.activeAddonCategoryId=-1,e.addons=[],e.selectAddonCategory=function(t,a){a.stopPropagation(),""!==t?(e.activeAddonCategoryId=t.id,e.fetchAddons(t.id)):(e.activeAddonCategoryId=-1,e.fetchAddons())},e.backToGroupDetails=function(){e.closeGroupAddonsScreen()},e.fetchAddons=function(t){var n=function(t){var a=[];angular.forEach(t.rate_addons,function(e){e.is_inclusive&&a.push(e)}),e.groupConfigData.addons.inclusiveAddons=a,e.addons=[],e.$emit("hideLoader"),angular.forEach(t.results,function(t){if(null!==t){var a={};a.id=t.id,a.isBestSeller=t.bestseller,a.category=t.charge_group.name,a.title=t.name,a.description=t.description,a.price=t.amount,a.taxes=t.taxes,a.stay="",""!==t.amount_type&&(a.stay=t.amount_type.description),""!==t.post_type&&(""!==a.stay?a.stay+=" / "+t.post_type.description:a.stay=t.post_type.description),a.amountType=t.amount_type,a.postType=t.post_type,a.amountTypeDesc=t.amount_type.description,a.postTypeDesc=t.post_type.description,a.custom_nightly_selected_post_days=t.custom_nightly_selected_post_days,e.addons.push(a)}}),r()},o=void 0===t?"":t,i=void 0===t;e.callAPI(a.fetchAddons,{successCallBack:n,params:{charge_group_id:o,is_bestseller:i,from_date:e.groupConfigData.summary.block_from,to_date:e.groupConfigData.summary.block_to,is_active:!0,is_not_rate_only:!0,no_pagination:!0}})},e.isInAddonSelectionMode()&&e.fetchAddons(),e.openAddonsPopup=function(){e.addonPopUpData={addonPostingMode:"create_group",cancelLabel:"Cancel",saveLabel:"Save",number_of_adults:1,number_of_children:1,duration_of_stay:1},e.packageData={existing_packages:e.groupConfigData.selectedAddons},_.each(e.packageData.existing_packages,function(e){e.totalAmount=e.amount*e.addon_count}),o.open({template:"/assets/partials/packages/showPackages.html",controller:"RVReservationPackageController",scope:e,closeByDocument:!1,closeByEscape:!1})},e.selectAddon=function(t,a){var o=function(t){e.groupConfigData.selectedAddons=t,e.computeAddonsCount(),e.openAddonsPopup()},r=function(t){e.errorMessage=t};e.callAPI(n.addGroupEnhancement,{successCallBack:o,failureCallBack:r,params:{addon_id:t.id,addon_count:parseInt(a),id:e.groupConfigData.summary.group_id}})},e.removeAddon=function(t){var a=function(t){e.groupConfigData.selectedAddons=t,e.packageData.existing_packages=t,_.each(e.packageData.existing_packages,function(e){e.totalAmount=e.amount*e.addon_count}),e.computeAddonsCount()},o=function(t){e.errorMessage=t};e.callAPI(n.removeGroupEnhancement,{successCallBack:a,failureCallBack:o,params:{addon_id:t.id,id:e.groupConfigData.summary.group_id}})},e.saveAddonsPosting=function(){var t=function(){e.$emit("hideLoader"),e.reloadPage()},a={group_id:e.groupConfigData.summary.group_id,addon_id:e.selectedPurchesedAddon.id,post_instances:e.selectedPurchesedAddon.post_instances,start_date:e.selectedPurchesedAddon.start_date,end_date:e.selectedPurchesedAddon.end_date,selected_post_days:e.selectedPurchesedAddon.selected_post_days};e.invokeApi(n.updateAddonPosting,a,t)};var i=t.$on("REMOVE_ADDON",function(t,a){"create_group"===a.addonPostingMode&&e.removeAddon(a.addon)}),s=e.$on("PROCEED_BOOKING",function(t,a){"create_group"===a.addonPostingMode&&(e.selectedPurchesedAddon=a.selectedPurchesedAddon,e.saveAddonsPosting())});e.addListener("CLOSE_ADDON_POPUP",function(t,a){"create_group"===a.addonPostingMode&&e.reloadPage()}),e.$on("$destroy",s),e.$on("$destroy",i)}]),angular.module("sntRover").controller("rvGroupConfigurationSummaryTab",["$scope","$q","jsMappings","$rootScope","rvGroupSrv","$filter","$stateParams","rvGroupConfigurationSrv","dateFilter","RVReservationSummarySrv","ngDialog","RVReservationAddonsSrv","RVReservationCardSrv","rvUtilSrv","$state","rvPermissionSrv","$timeout","rvGroupActionsSrv","RVContactInfoSrv",function(e,t,a,n,o,r,i,s,c,u,l,d,p,m,f,g,v,h,y){var D,C,A=function(){var t=e.groupConfigData.summary;D=_.omit(D,["rooms_total","selected_room_types_and_bookings","selected_room_types_and_occupanies"]);for(var a in D)if(!_.isEqual(t[a],D[a]))return!1;return!0},S=function(){e.$$phase||e.$digest()},b=function(){e.groupConfigData.summary.block_from=new tzIndependentDate(D.block_from),e.groupConfigData.summary.block_to=new tzIndependentDate(D.block_to),e.groupConfigData.summary.shoulder_from_date=new tzIndependentDate(D.shoulder_from_date),e.toDateOptions.minDate=e.groupConfigData.summary.block_from,e.fromDateOptions.maxDate=e.groupConfigData.summary.block_to},P=function(){e.changeDatesActions=e.getMoveDatesActions(),e.changeDatesActions.setToDefaultMode()},I=function(){e.reloadPage()},E=function(t){e.errorMessage=t,e.$emit("hideLoader")};e.clickedOnSaveMoveButton=function(){var t=e.groupConfigData.summary,a=D,n={fromDate:t.block_from,toDate:t.block_to,oldFromDate:a.block_from,oldToDate:a.block_to,successCallBack:I,failureCallBack:E,cancelPopupCallBack:R};e.actionStatus.isMoveBtnClicked=!1,e.changeDatesActions.clickedOnMoveSaveButton(n)},e.clickedOnMoveButton=function(){_.extend(e.toDateOptions,{disabled:!0}),b(),e.fromDateOptions.maxDate="",e.changeDatesActions.clickedOnMoveButton(),e.isShoulderDateDisabled=!0,e.actionStatus.isMoveBtnClicked=!0},e.clickedOnCancelMoveButton=function(){_.extend(e.toDateOptions,{disabled:!1}),e.actionStatus.isMoveBtnClicked=!1,e.reloadPage()};var R=function(){b()},O=function(){e.reloadPage()},T=function(t){e.errorMessage=t,e.groupConfigData.summary.block_from=D.block_from,e.groupConfigData.summary.shoulder_from_date=D.shoulder_from_date,e.groupConfigData.summary.uniqId=D.uniqId,e.groupConfigData.summary.rate=D.rate,e.$emit("hideLoader")},k=function(){var t=e.groupConfigData.summary,a=D,n={fromDate:t.block_from,oldFromDate:a.block_from,successCallBack:O,failureCallBack:T,cancelPopupCallBack:R};e.changeDatesActions.triggerdChangeDateActions(),e.changeDatesActions.triggerEarlierArrDateChange(n)},N=function(){e.reloadPage()},B=function(t){e.errorMessage=t,e.groupConfigData.summary.block_from=D.block_from,e.groupConfigData.summary.shoulder_from_date=D.shoulder_from_date,e.groupConfigData.summary.uniqId=D.uniqId,e.groupConfigData.summary.rate=D.rate,e.$emit("hideLoader")},M=function(){var t=e.groupConfigData.summary,a=D,n={fromDate:t.block_from,oldFromDate:a.block_from,successCallBack:N,failureCallBack:B,cancelPopupCallBack:R};e.changeDatesActions.triggerdChangeDateActions(),e.changeDatesActions.triggerLaterArrDateChange(n)},w=function(){e.reloadPage()},L=function(t){e.errorMessage=t,e.groupConfigData.summary.block_to=D.block_to,e.groupConfigData.summary.shoulder_to_date=D.shoulder_to_date,e.groupConfigData.summary.uniqId=D.uniqId,e.groupConfigData.summary.rate=D.rate,e.$emit("hideLoader")},G=function(){var t=e.groupConfigData.summary,a=D,n={toDate:t.block_to,oldToDate:a.block_to,successCallBack:w,failureCallBack:L,cancelPopupCallBack:R};e.changeDatesActions.triggerdChangeDateActions(),e.changeDatesActions.triggerEarlierDepDateChange(n)},$=function(){e.reloadPage()},F=function(t){e.errorMessage=t,e.groupConfigData.summary.block_to=D.block_to,e.groupConfigData.summary.shoulder_to_date=D.shoulder_to_date,e.groupConfigData.summary.uniqId=D.uniqId,e.groupConfigData.summary.rate=D.rate,e.$emit("hideLoader")},x=function(){var t=e.groupConfigData.summary,a=D,n={toDate:t.block_to,oldToDate:a.block_to,successCallBack:$,failureCallBack:F,cancelPopupCallBack:R};e.changeDatesActions.triggerdChangeDateActions(),e.changeDatesActions.triggerLaterDepDateChange(n)},U=function(){var t={cancelPopupCallBack:R,message:"GROUP_EARLIER_DEP_DATE_CHANGE_WARNING"};e.changeDatesActions.triggerdChangeDateActions(),e.changeDatesActions.showDateChangeInvalidWarning(t)},j=function(){var t={cancelPopupCallBack:R,message:"GROUP_LATER_ARR_DATE_CHANGE_WARNING"};e.changeDatesActions.triggerdChangeDateActions(),e.changeDatesActions.showDateChangeInvalidWarning(t)};e.shouldShowMoveButton=function(){return!e.isInStaycardScreen()&&(e.changeDatesActions&&e.changeDatesActions.shouldShowMoveButton())},e.shouldShowMoveCancelButton=function(){return!e.isInStaycardScreen()&&(e.changeDatesActions&&e.changeDatesActions.isInCompleteMoveMode())},e.shouldShowMoveSaveButton=function(){return!e.isInStaycardScreen()&&(e.changeDatesActions&&e.changeDatesActions.isInCompleteMoveMode())},e.shouldDisableHoldStatusChange=function(){return e.groupConfigData.summary.is_cancelled||e.isInStaycardScreen()},e.shouldDisableRateChange=function(){return e.groupConfigData.summary.is_cancelled||e.isInStaycardScreen()},e.shouldShowGroupActionsButton=function(){return e.isStandAlone&&!e.isInStaycardScreen()&&!e.isInAddMode()},e.$on("OUTSIDECLICKED",function(t,a){"undefined"!=typeof a&&a instanceof Element&&(!e.updateGroupSummary||e.isInAddMode()||"summary"===a.id||"cancel-action"===a.id||e.focusedCompanyCard||e.focusedTravelAgent||A()||e.groupSummaryData.isDemographicsPopupOpen||e.isUpdateInProgress||e.changeDatesActions.isInCompleteMoveMode()||e.changeDatesActions.isInChangeDatesMode()||e.hasAnyActivePopups||(e.isUpdateInProgress=!0,e.updateGroupSummary()))}),e.$on("UPDATED_GROUP_INFO",function(t){Pe(),D=angular.copy(e.groupConfigData.summary),e.isUpdateInProgress=!1});var V=function(t,a){e.groupConfigData.summary.block_from=new tzIndependentDate(m.get_date_from_date_picker(a)),e.groupConfigData.summary.shoulder_from_date=e.setShoulderDatesInAPIFormat(e.groupConfigData.summary.block_from,-1*e.groupConfigData.summary.shoulder_from);var n=e.groupConfigData.summary,o=n.block_from,r=new tzIndependentDate(D.block_from);if(""===n.release_date.toString().trim()&&(n.release_date=n.block_from),e.groupConfigData.summary.block_from&&e.groupConfigData.summary.block_to&&(Se(),e.computeSegment()),e.changeDatesActions.isInCompleteMoveMode()){var i=m.getDatesBetweenTwoDates(new tzIndependentDate(m.deepCopy(D.block_from)),new tzIndependentDate(m.deepCopy(D.block_to))).length-1;n.block_to=new tzIndependentDate(m.get_date_from_date_picker(a)),n.block_to.setDate(n.block_to.getDate()+i)}else o<r&&e.changeDatesActions.arrDateLeftChangeAllowed()?k():o>r&&e.changeDatesActions.arrDateRightChangeAllowed()?new tzIndependentDate(n.first_dep_date)<o?j():M():e.isInAddMode()||n.is_a_past_group||v(function(){e.updateGroupSummary()},100);o<new tzIndependentDate(n.release_date)&&(e.groupConfigData.summary.release_date=o),e.toDateOptions.minDate=n.block_from,S()};e.computeSegment=function(){var t=function(t){e.groupSummaryData.demographics=t.demographics,n()},a=function(t){e.errorMessage=t,e.emit("hideLoader")},n=function(){var t="",a=e.groupConfigData.summary.block_from,n=e.groupConfigData.summary.block_to;if(e.forceDemographics=e.shouldShowDemographics(),a&&n){var o=Math.floor((new tzIndependentDate(n)-new tzIndependentDate(a))/864e5),r=_.sortBy(e.groupSummaryData.demographics.segments,function(e){return e.los});angular.forEach(r,function(a){o<a.los&&(t||(t=a.value,e.groupConfigData.summary.demographics.segment_id=t))})}return e.groupSummaryData.isComputedSegment=!!t,e.groupSummaryData.isComputedSegment};null===e.groupSummaryData.demographics?e.callAPI(u.fetchInitialData,{successCallBack:t,failureCallBack:a}):n()};var J=function(t,a){e.groupConfigData.summary.block_to=new tzIndependentDate(m.get_date_from_date_picker(a)),e.groupConfigData.summary.shoulder_to_date=e.setShoulderDatesInAPIFormat(e.groupConfigData.summary.block_to,e.groupConfigData.summary.shoulder_to);var n=e.groupConfigData.summary,o=n.block_to,r=new tzIndependentDate(D.block_to),i=e.changeDatesActions;e.groupConfigData.summary.block_from&&e.groupConfigData.summary.block_to&&(Se(),e.computeSegment()),o<r&&i.depDateLeftChangeAllowed()?new tzIndependentDate(n.last_arrival_date)>o?U():G():o>r&&i.depDateRightChangeAllowed()?x():e.isInAddMode()||n.is_a_past_group||v(function(){e.updateGroupSummary();
},100),o<new tzIndependentDate(n.release_date)&&(e.groupConfigData.summary.release_date=n.block_from),e.releaseDateOptions.maxDate=o,e.fromDateOptions.maxDate=o,S()},H=function(t,a){e.groupConfigData.summary.release_date=new tzIndependentDate(m.get_date_from_date_picker(a)),S()},W=function(t,a){e.groupConfigData.summary.payment_date=new tzIndependentDate(m.get_date_from_date_picker(a)),S()},z=function(){var t=e.groupConfigData.summary,a=t.total_checked_in_reservations>0,n=t.is_cancelled,o=t.is_a_past_group,r=!e.isInAddMode(),i=t.total_checked_out_reservations_count>0;return e.isInStaycardScreen()||r&&(a||n||o||i)},Y=function(){var t=e.groupConfigData.summary,a=new tzIndependentDate(t.block_to)<new tzIndependentDate(n.businessDate),o=t.is_cancelled,r=!e.isInAddMode();return e.isInStaycardScreen()||r&&(a||o)},q=function(){return e.isInStaycardScreen()||e.groupConfigData.summary.is_cancelled},K=function(){var t={dateFormat:n.jqDateFormat,numberOfMonths:1},a=e.groupConfigData.summary;if(e.fromDateOptions=_.extend({onSelect:V,disabled:z(),maxDate:e.groupConfigData.summary.block_to,minDate:tzIndependentDate(n.businessDate)},t),a.block_from instanceof Date&&tzIndependentDate(a.block_from)<tzIndependentDate(n.businessDate)&&(e.fromDateOptions=_.extend({minDate:tzIndependentDate(a.block_from)},e.fromDateOptions)),e.toDateOptions=_.extend({onSelect:J,disabled:Y()},t),""!==e.groupConfigData.summary.block_from){var o=tzIndependentDate(e.groupConfigData.summary.block_from),r=tzIndependentDate(n.businessDate);e.toDateOptions=_.extend({minDate:r>o?r:o},e.toDateOptions)}e.releaseDateOptions=_.extend({onSelect:H,disabled:q(),minDate:tzIndependentDate(n.businessDate),maxDate:e.groupConfigData.summary.block_to},t),e.paymentDateOptions=_.extend({onSelect:W,minDate:tzIndependentDate(n.businessDate)},t),D=_.extend({},e.groupConfigData.summary)};e.getActionsButtonClass=function(){var t=parseInt(e.groupConfigData.summary.total_group_action_tasks_count),a=parseInt(e.groupConfigData.summary.pending_group_action_tasks_count);return a>0?"icon-new-actions":0===t?"icon-no-actions":"icon-actions"};var Q=function(t){l.open({template:"/assets/partials/groups/summary/rvGroupActions.html",controller:"rvGroupActionsCtrl",scope:e,closeByDocument:!1,closeByEscape:!1,data:JSON.stringify(t)})},X=function(t){e.errorMessage=t},Z=function(){var a=t.defer(),n={};return n.params={id:e.groupConfigData.summary.group_id},n.successCallBack=a.resolve,n.failureCallBack=a.reject,e.callAPI(h.getActionsTasksList,n),a.promise};e.openGroupActionsPopup=function(){Z().then(Q,X)};var ee=function(e){return e.is_use_markets&&e.markets.length>0},te=function(e){return e.is_use_sources&&e.sources.length>0},ae=function(e){return e.is_use_origins&&e.origins.length>0},ne=function(e){return e.is_use_segments&&e.segments.length>0},oe=function(t){var a=!0;return ee(t)&&e.hotelSettings.force_market_code&&(a=!!e.groupConfigData.summary.demographics.market_segment_id),te(t)&&e.hotelSettings.force_source_code&&a&&(a=!!e.groupConfigData.summary.demographics.source_id),ae(t)&&e.hotelSettings.force_origin_of_booking&&a&&(a=!!e.groupConfigData.summary.demographics.booking_origin_id),ne(t)&&e.hotelSettings.force_segments&&a&&(a=!!e.groupConfigData.summary.demographics.segment_id),a};e.isDemographicsFormValid=function(t){var a=!0;return t&&(a=oe(e.groupSummaryData.demographics)),a},e.openDemographicsPopup=function(t,a){if(e.isInAddMode()&&(!e.forceDemographics||a))return void(e.errorMessage=["Please save the group first"]);e.errorMessage="";var n=function(){e.groupSummaryData.isDemographicsPopupOpen=!0,C=angular.copy(e.groupConfigData.summary.demographics),l.open({template:"/assets/partials/groups/summary/groupDemographicsPopup.html",className:"",scope:e,closeByDocument:!1,closeByEscape:!1,preCloseCallback:function(){e.groupSummaryData.isDemographicsPopupOpen=!1}})},o=function(a){e.groupSummaryData.demographics=a.demographics,e.setDemographicFields(t),n()},r=function(t){e.errorMessage=t,e.emit("hideLoader")};null===e.groupSummaryData.demographics?e.callAPI(u.fetchInitialData,{successCallBack:o,failureCallBack:r}):(e.setDemographicFields(t),n())},e.openBillingInformation=function(){if(e.isInAddMode())return void(e.errorMessage=["Please save the group first"]);var t=e.groupConfigData.summary;e.billingEntity="GROUP_DEFAULT_BILLING",e.billingInfoModalOpened=!0,e.attachedEntities={},e.attachedEntities.posting_account=_.extend({},{id:t.group_id,name:e.accountConfigData.summary.posting_account_name,logo:"GROUP_DEFAULT"}),e.$emit("showLoader"),a.fetchAssets(["addBillingInfo","directives"]).then(function(){e.$emit("hideLoader"),n.UPDATED_BI_ENABLED_ON.ACCOUNTS?(console.log("##Billing-info updated version"),l.open({template:"/assets/partials/billingInformation/accounts/rvBillingInfoAccountsMain.html",controller:"rvBillingInfoAccountsMainCtrl",className:"",scope:e})):(console.log("##Billing-info old version"),l.open({template:"/assets/partials/bill/rvBillingInformationPopup.html",controller:"rvBillingInformationPopupCtrl",className:"",scope:e}))})},e.showGroupBillingInfoDeleteConfirmPopup=function(){l.close(),v(function(){l.open({template:"/assets/partials/groups/rvGroupBillingInfoDeleteConfirmPopup.html",className:"",scope:e})},100)},e.deleteGroupBillingInfo=function(){var t=function(){e.$emit("hideLoader"),e.groupConfigData.summary.posting_account_billing_info=!1,l.close()},a=function(){e.$emit("hideLoader"),l.close()},n={};n.group_id=e.groupConfigData.summary.group_id,e.invokeApi(s.deleteBillingInfo,n,t,a)},e.openSendConfirmationPopup=function(){var t=function(t){return e.isInAddMode()?void(e.errorMessage=["Please save the group first"]):(e.ngData={},e.languageData=t,e.groupConfirmationData={contact_email:e.groupConfigData.summary.contact_email,is_salutation_enabled:!1,is_include_rooming_list:!1,personal_salutation:"",locale:t.selected_language_code,showLanguageField:t.show_language_field},void l.open({template:"/assets/partials/groups/summary/groupSendConfirmationPopup.html",className:"",scope:e}))},a={onSuccess:t};e.callAPI(y.fetchGuestLanguages,a)},e.sendGroupConfirmation=function(){var t=function(t){e.$emit("hideLoader"),e.ngData.successMessage=t.message,e.ngData.failureMessage=""},a=function(t){e.$emit("hideLoader"),e.ngData.failureMessage=t[0],e.ngData.successMessage=""},n={postData:e.groupConfirmationData,groupId:e.groupSummaryMemento.group_id};e.invokeApi(s.sendGroupConfirmationEmail,n,t,a)},e.$on("BILLINGINFOADDED",function(){e.groupConfigData.summary.posting_account_billing_info=!0}),e.saveDemographicsData=function(){return e.isInAddMode()?void(e.errorMessage=["Please save the group to save Demographics"]):(e.updateGroupSummary(),void e.closeDialog())};var re=function(){l.open({template:"/assets/partials/groups/summary/warnChangeRateNotPossible.html",className:"",scope:e,closeByDocument:!1,closeByEscape:!1})},ie=function(t){e.addonNames=t.join(", "),l.open({template:"/assets/partials/groups/summary/warnAddonOverBooked.html",className:"",scope:e,closeByDocument:!1,closeByEscape:!1})},se=function(t){e.$emit("hideLoader"),e.groupConfigData.summary.commission_details=t.commission_details,t.is_changed||t.is_room_rate_available?(D.rate=e.groupConfigData.summary.rate,D.contract_id=e.groupConfigData.summary.contract_id,D.uniqId=e.groupConfigData.summary.uniqId,e.$emit("FETCH_SUMMARY"),t.overbooked_addons.length>0&&ie(t.overbooked_addons)):(re(),e.groupConfigData.summary.rate=D.rate,e.groupConfigData.summary.contract_id=D.contract_id,e.groupConfigData.summary.uniqId=D.uniqId)},ce=function(t){e.$emit("hideLoader"),e.errorMessage=t,e.$emit("showErrorMessage",t),e.groupConfigData.summary.rate=D.rate,e.groupConfigData.summary.contract_id=D.contract_id,e.groupConfigData.summary.uniqId=D.uniqId};e.updateRate=function(t){l.close();var a=e.groupConfigData.summary,n=a.uniqId,o=n&&n.split(":")[0],r=n&&n.split(":")[1],i={group_id:a.group_id,rate_id:o,contract_id:r};t&&(i.update_existing_reservations_rate=!0);var c={successCallBack:se,failureCallBack:ce,params:i};e.callAPI(s.updateRate,c)};var ue=function(){l.open({template:"/assets/partials/groups/roomBlock/rvGroupInhouseReservationsExistsPopup.html",scope:e,className:"",closeByDocument:!1,closeByEscape:!1})};e.updateRateToNewAndExistingReservations=function(){l.close(),e.groupConfigData.summary.total_checked_in_reservations>0?ue():e.updateRate(!0)},e.updateRateToNewReservations=function(){l.close(),e.updateRate(!1)};var le=function(){e.isFromSummary=!0,l.open({template:"/assets/partials/groups/roomBlock/rvGroupRoomBlockPickedupReservationsPopup.html",scope:e,className:"",closeByDocument:!1,closeByEscape:!1})};e.onRateChange=function(){var t=e.groupConfigData.summary,a=t.uniqId,n=a&&a.split(":")[0],o=a&&a.split(":")[1];return e.groupConfigData.summary.rate=n,e.groupConfigData.summary.contract_id=o,!(!t.group_id||!a)&&void(t.rooms_total>0?le():e.updateRate(!1))},e.cancelDemographicChanges=function(){e.groupConfigData.summary.demographics=C},e.warnReleaseRooms=function(){e.groupConfigData.summary.is_cancelled||e.isInAddMode()||l.open({template:"/assets/partials/groups/summary/warnReleaseRoomsPopup.html",className:"",scope:e,closeByDocument:!1,closeByEscape:!1})};var de=function(t){e.closeDialog(),e.$emit("FETCH_SUMMARY")},pe=function(t){e.errorMessage=t};e.releaseRooms=function(){var t={groupId:e.groupConfigData.summary.group_id},a={params:t,successCallBack:de,failureCallBack:pe};e.callAPI(s.releaseRooms,a)},e.abortCancelGroup=function(){e.groupConfigData.summary.hold_status=e.groupSummaryData.existingHoldStatus,e.closeDialog()};var me=function(t){e.closeDialog(),e.reloadPage()},fe=function(t){e.errorMessage=t,e.abortCancelGroup()};e.cancelGroup=function(t){var a={group_id:e.groupConfigData.summary.group_id,reason:t},n={params:a,successCallBack:me,failureCallBack:fe};e.callAPI(s.cancelGroup,n)};var _e=function(){e.callAPI(s.updateHoldStatus,{params:{hold_status_id:e.groupConfigData.summary.hold_status,id:e.groupConfigData.summary.group_id},onSuccess:function(){e.groupSummaryMemento.hold_status=e.groupConfigData.summary.hold_status},onFailure:function(t){e.$emit("showErrorMessage",t),e.groupConfigData.summary.hold_status=e.groupSummaryMemento.hold_status}})};e.onHoldStatusChange=function(){if(!e.isInAddMode()){var t=_.findWhere(e.groupConfigData.holdStatusList,{id:parseInt(e.groupConfigData.summary.hold_status)});t&&"Cancel"===t.name&&t.is_system?l.open({template:"/assets/partials/groups/summary/warnCancelGroupPopup.html",className:"",scope:e,closeByDocument:!1,closeByEscape:!1}):(_e(),e.groupSummaryData.existingHoldStatus=parseInt(e.groupConfigData.summary.hold_status))}},e.isCancellable=function(){var t=e.groupConfigData.summary,a=g.getPermissionValue("CANCEL_GROUP"),n=!!t.is_cancelled,o=0===t.total_checked_in_reservations,r=0===parseFloat(t.balance);return a&&n||o&&r};var ge=function(t){e.groupConfigData.selectedAddons=t,e.groupConfigData.selectedAddons.length>0||e.isInStaycardScreen()?e.openAddonsPopup():e.manageAddons()},ve=function(t){e.errorMessage=t};e.viewAddons=function(){var t={id:e.groupConfigData.summary.group_id},a={params:t,successCallBack:ge,failureCallBack:ve};e.callAPI(s.getGroupEnhancements,a)},e.getRevenue=function(){var t=e.groupConfigData.summary;return e.isInAddMode()?"":n.currencySymbol+r("number")(t.revenue_actual,2)+"/ "+n.currencySymbol+r("number")(t.revenue_potential,2)},e.openAddonsPopup=function(){e.addonPopUpData={addonPostingMode:"group",cancelLabel:"Cancel",saveLabel:"Save",number_of_adults:1,number_of_children:1,duration_of_stay:1},e.packageData={existing_packages:e.groupConfigData.selectedAddons},_.each(e.packageData.existing_packages,function(e){e.totalAmount=e.amount*e.addon_count}),l.open({template:"/assets/partials/packages/showPackages.html",controller:"RVReservationPackageController",scope:e,closeByDocument:!1,closeByEscape:!1})},e.manageAddons=function(){if(e.isInAddMode())return void(e.errorMessage=["Please save the group to manage Add-ons"]);e.errorMessage="";var t=function(t){e.groupConfigData.addons=t,e.openGroupAddonsScreen()},a=function(t){e.errorMessage=t,e.emit("hideLoader")};e.callAPI(d.fetchAddonData,{successCallBack:t,failureCallBack:a,params:{from_date:e.groupConfigData.summary.block_from,to_date:e.groupConfigData.summary.block_to,is_active:!0,is_not_rate_only:!0}})},e.removeAddon=function(t){var a=function(t){e.groupConfigData.selectedAddons=t,e.packageData.existing_packages=t,_.each(e.packageData.existing_packages,function(e){e.totalAmount=e.amount*e.addon_count}),e.computeAddonsCount()},n=function(t){e.errorMessage=t};e.callAPI(s.removeGroupEnhancement,{successCallBack:a,failureCallBack:n,params:{addon_id:t.id,id:e.groupConfigData.summary.group_id}})},e.saveGroupNote=function(){if(e.isInAddMode())return void(e.errorMessage=["Please save the group to Post Note"]);if(e.errorMessage="",e.groupSummaryData.newNote){var t=function(t){e.groupConfigData.summary.notes=t.notes,e.groupSummaryData.newNote="",e.refreshScroller("groupSummaryScroller")},a=function(t){e.errorMessage=t};e.callAPI(s.saveGroupNote,{successCallBack:t,failureCallBack:a,params:{notes:e.groupSummaryData.newNote,group_id:e.groupConfigData.summary.group_id}})}},e.removeGroupNote=function(t,a){var n=function(t,a){e.groupConfigData.summary.notes=_.without(e.groupConfigData.summary.notes,_.findWhere(e.groupConfigData.summary.notes,{note_id:a.noteId})),e.refreshScroller("groupSummaryScroller"),e.cancelEditModeGroupNote()},o=function(t){e.errorMessage=t};t.stopPropagation(),e.callAPI(s.removeGroupNote,{successCallBack:n,failureCallBack:o,params:{note_id:a},successCallBackParameters:{noteId:a}})},e.updateActiveGroupNote=function(){if(!e.groupSummaryData.editingNote)return void(e.errorMessage=["Something went wrong, please switch tab and comeback"]);if(e.errorMessage="",e.groupSummaryData.newNote){var t=function(t){e.groupSummaryData.editingNote.description=e.groupSummaryData.newNote;var a=_.findIndex(e.groupConfigData.summary.notes,{note_id:t.note_id});e.groupConfigData.summary.notes[a]=e.groupSummaryData.editingNote,e.refreshScroller("groupSummaryScroller"),e.cancelEditModeGroupNote()},a=function(t){e.errorMessage=t};e.callAPI(s.updateGroupNote,{successCallBack:t,failureCallBack:a,params:{id:e.groupSummaryData.editingNote.note_id,text:e.groupSummaryData.newNote,associated_id:e.groupConfigData.summary.group_id,associated_type:"Group"}})}},e.clickedOnNote=function(t){e.groupSummaryData.editingNote=t,e.groupSummaryData.newNote=t.description.replace(new RegExp("<br/>","g"),"\n")},e.cancelEditModeGroupNote=function(){e.groupSummaryData.editingNote=null,e.groupSummaryData.newNote=""};var he=function(){var e={is_swiped:!1,details:{firstName:"",lastName:""}};return e};e.$on("HANDLE_MODAL_OPENED",function(t){e.billingInfoModalOpened=!1});var ye=function(t){var a=he(),n=new SwipeOperation,o=n.createSWipedDataToRender(t);a.details.swipedDataToRenderInScreen=o,e.$broadcast("SHOW_SWIPED_DATA_ON_BILLING_SCREEN",o)};e.$on("SWIPE_ACTION",function(t,a){if(e.billingInfoModalOpened){var n=new SwipeOperation,o=n.createDataToTokenize(a),r=function(t){e.$emit("hideLoader"),a.token=t,ye(a),e.swippedCard=!0};e.invokeApi(p.tokenize,o,r)}});var De=function(e,t){var a;return a=t?_.isDate(t)?r("date")(t,"yyyy-MM-dd"):t:r("date")(tzIndependentDate(e),"yyyy-MM-dd")},Ce=function(t,a,n){var o=e.groupConfigData.summary.rate,r=!0;"-1"!==o&&(r=_.find(t,function(e){return e.id===o})),r||"-1"===o||(r=_.find(a,function(e){return e.id===o})),r||"-1"===o||(r=_.find(n,function(e){return e.id===o})),r||l.open({template:"/assets/partials/groups/summary/rvGroupRateNotValidForShoulderDatesWarning.html",className:"",scope:e,closeByDocument:!1,closeByEscape:!1})},Ae=function(){e.$emit("GROUP_SUMMARY_UNIQUE_ID_SET",{uniqId:e.groupConfigData.summary.uniqId})},Se=function(t){var a=function(a){var n=e.groupSummaryData;n.rateSelectDataObject=[],n.rateSelectDataObject.push({id:"-1",name:"Custom Rate",uniqId:"-1"});var o=function(t,a){angular.forEach(t,function(t){t.groupName=a,t.is_contracted?(t.uniqId=t.id+":"+t.contract_id,t.name=t.name+" ("+t.contract_name+")",t.id===e.groupConfigData.summary.rate&&t.contract_id===e.groupConfigData.summary.contract_id&&(e.groupConfigData.summary.uniqId=t.uniqId,Ae())):(t.uniqId=t.id+":",t.id===e.groupConfigData.summary.rate&&(e.groupConfigData.summary.uniqId=t.uniqId,Ae())),n.rateSelectDataObject.push(t)})};0!==a.group_rates.length&&o(a.group_rates,"Group Rates"),0!==a.company_rates.length&&o(a.company_rates,"Company Contract"),0!==a.travel_agent_rates.length&&o(a.travel_agent_rates,"Travel Agent Contract"),"-1"===e.groupConfigData.summary.rate&&(e.groupConfigData.summary.uniqId="-1",Ae()),D.uniqId=e.groupConfigData.summary.uniqId,t&&Ce(a.group_rates,a.company_rates,a.travel_agent_rates)},n=function(t){e.errorMessage=t};e.groupConfigData.summary.block_from&&e.groupConfigData.summary.block_to&&e.callAPI(s.getRates,{successCallBack:a,failureCallBack:n,params:{from_date:De(e.groupConfigData.summary.block_from,e.groupConfigData.summary.shoulder_from_date),to_date:De(e.groupConfigData.summary.block_to,e.groupConfigData.summary.shoulder_to_date),company_id:e.groupConfigData.summary.company&&e.groupConfigData.summary.company.id||null,travel_agent_id:e.groupConfigData.summary.travel_agent&&e.groupConfigData.summary.travel_agent.id||null}})};e.$on("GROUP_TAB_SWITCHED",function(t,a){"SUMMARY"===a&&(e.isShoulderDateDisabled=!1,e.isInAddMode()||(e.$emit("FETCH_SUMMARY"),K(),P(),e.isUpdateInProgress=!1,e.computeSegment()))}),e.$on("REFRESH_ALL_CARD_SCROLLERS",function(t){v(function(){e.refreshScroller("groupSummaryScroller")},100)}),e.$on("COMPANY_CARD_CHANGED",function(e){Se()}),e.$on("TA_CARD_CHANGED",function(e){Se()});var be=function(t){e.groupSummaryData={releaseOnDate:n.businessDate,demographics:null,promptMandatoryDemographics:!1,isComputedSegment:!1,isDemographicsPopupOpen:!1,newNote:"",editingNote:null,existingHoldStatus:parseInt(e.groupConfigData.summary.hold_status),computedSegment:!1,rates:[],contractedRates:[],rateSelectDataObject:[]},e.changeDatesActions={},e.billingInfoModalOpened=!1,D=_.extend({},e.groupConfigData.summary),C={},e.isUpdateInProgress=!1,e.hasAnyActivePopups=!1};e.$on("SET_ACTIONS_COUNT",function(t,a){"new"===a?(e.groupConfigData.summary.total_group_action_tasks_count=parseInt(e.groupConfigData.summary.total_group_action_tasks_count)+parseInt(1),e.groupConfigData.summary.pending_group_action_tasks_count=parseInt(e.groupConfigData.summary.pending_group_action_tasks_count)+parseInt(1)):"complete"===a&&(e.groupConfigData.summary.pending_group_action_tasks_count=parseInt(e.groupConfigData.summary.pending_group_action_tasks_count)-parseInt(1)),_.isObject(a)&&(e.groupConfigData.summary.total_group_action_tasks_count=parseInt(e.groupConfigData.summary.total_group_action_tasks_count)-parseInt(1),"COMPLETED"!==a.deletedActionStatus&&(e.groupConfigData.summary.pending_group_action_tasks_count=parseInt(e.groupConfigData.summary.pending_group_action_tasks_count)-parseInt(1)))}),e.isInStaycardScreen=function(){var t=e.groupConfigData;return"activeScreen"in t&&"STAY_CARD"===t.activeScreen},e.$on("UPDATE_POPUP_STATE",function(t,a){e.hasAnyActivePopups=a.isActive}),e.shouldShowDemographics=function(){var t=!1;if(e.groupSummaryData.demographics&&e.hotelSettings){var a=ee(e.groupSummaryData.demographics)&&e.hotelSettings.force_market_code,n=te(e.groupSummaryData.demographics)&&e.hotelSettings.force_source_code,o=ae(e.groupSummaryData.demographics)&&e.hotelSettings.force_origin_of_booking,r=ne(e.groupSummaryData.demographics)&&e.hotelSettings.force_segments;t=a||n||o||r}return t},e.setDemographicFields=function(t){e.shouldShowReservationType=e.groupSummaryData.demographics.reservationTypes.length>0,e.shouldShowMarket=ee(e.groupSummaryData.demographics),e.shouldShowSource=te(e.groupSummaryData.demographics),e.shouldShowOriginOfBooking=ae(e.groupSummaryData.demographics),e.shouldShowSegments=ne(e.groupSummaryData.demographics),t&&(e.shouldShowReservationType=!1,e.shouldShowMarket=e.shouldShowMarket&&e.hotelSettings.force_market_code,e.shouldShowSource=e.shouldShowSource&&e.hotelSettings.force_source_code,e.shouldShowOriginOfBooking=e.shouldShowOriginOfBooking&&e.hotelSettings.force_origin_of_booking,e.shouldShowSegments=e.shouldShowSegments&&e.hotelSettings.force_segments)},e.clickedTaxExemptToggle=function(){e.groupConfigData.summary.is_tax_exempt?null!==e.groupConfigData.summary.tax_exempt_type_id&&""!==e.groupConfigData.summary.tax_exempt_type_id&&void 0!==e.groupConfigData.summary.tax_exempt_type_id||(e.groupConfigData.summary.tax_exempt_type_id=e.defaultTaxExemptTypeId):(e.groupConfigData.summary.tax_exempt_type_id="",e.groupConfigData.summary.tax_exempt_ref_text="")},e.clickedShowRate=function(){e.groupConfigData.summary.hide_rates=!e.groupConfigData.summary.hide_rates;var t={group_id:e.groupConfigData.summary.group_id,hide_rates:e.groupConfigData.summary.hide_rates};e.callAPI(s.toggleHideRate,{successCallBack:function(){e.errorMessage=""},failureCallBack:function(t){e.errorMessage=t},params:t})},e.saveAddonsPosting=function(){var t=function(t){e.$emit("hideLoader")},a={group_id:e.groupConfigData.summary.group_id,addon_id:e.selectedPurchesedAddon.id,post_instances:e.selectedPurchesedAddon.post_instances,start_date:e.selectedPurchesedAddon.start_date,end_date:e.selectedPurchesedAddon.end_date,selected_post_days:e.selectedPurchesedAddon.selected_post_days};e.invokeApi(s.updateAddonPosting,a,t)},e.$on("CREATE_GROUP",function(){e.shouldShowDemographics()?(e.forceDemographics=!0,e.groupSummaryData.promptMandatoryDemographics=!0,e.openDemographicsPopup(!0,!1)):e.$emit("SAVE_GROUP")});var Pe=function(){var t=e.groupConfigData.summary,a=moment(t.shoulder_from_date||t.block_from).startOf("day"),n=moment(t.shoulder_to_date||t.block_to).startOf("day"),o=moment(t.block_from).startOf("day"),r=moment(t.block_to).startOf("day");t.shoulder_from=""+o.diff(a,"days"),t.shoulder_to=""+n.diff(r,"days"),t.shoulder_from_date=a.toDate(),t.shoulder_to_date=n.toDate()};(function(){var t=this;BaseCtrl.call(t,e),e.setScroller("groupSummaryScroller",{tap:!0,preventDefault:!1}),e.isShoulderDateDisabled=!1,e.groupConfigData.summary.shoulder_from="0",e.groupConfigData.summary.shoulder_to="0",e.isInAddMode()||Pe(),be(),e.groupConfigData.summary.block_from&&e.groupConfigData.summary.block_to&&Se(!0),e.$on("CARDS_CHANGED",function(){e.groupConfigData.summary.block_from&&e.groupConfigData.summary.block_to&&Se()});var a=n.$on("NAVIGATE_TO_ADDONS",function(t,a){"group"===a.addonPostingMode&&e.manageAddons()}),o=n.$on("REMOVE_ADDON",function(t,a){"group"===a.addonPostingMode&&e.removeAddon(a.addon)}),r=e.$on("PROCEED_BOOKING",function(t,a){"group"===a.addonPostingMode&&(e.selectedPurchesedAddon=a.selectedPurchesedAddon,e.saveAddonsPosting())});e.$on("$destroy",r),e.$on("$destroy",o),e.$on("$destroy",a),P(),K(),e.computeSegment()})();e.onShoulderDateChange=function(t){"from"===t&&(e.groupConfigData.summary.shoulder_from_date=e.setShoulderDatesInAPIFormat(e.groupConfigData.summary.block_from,-1*e.groupConfigData.summary.shoulder_from)),"to"===t&&(e.groupConfigData.summary.shoulder_to_date=e.setShoulderDatesInAPIFormat(e.groupConfigData.summary.block_to,e.groupConfigData.summary.shoulder_to));var a=e.groupConfigData.summary;e.groupConfigData.summary.block_from&&e.groupConfigData.summary.block_to&&Se(),e.isInAddMode()||a.is_a_past_group||v(function(){e.updateGroupSummary()},100)},e.closeRateChangePromptPopup=function(){var t=D.uniqId,a=t&&t.split(":")[0],n=t&&t.split(":")[1];e.groupConfigData.summary.uniqId=t,e.groupConfigData.summary.contract_id=n,e.groupConfigData.summary.rate=a,l.close()},e.shouldDisableShoulderFrom=function(){return e.isShoulderDateDisabled||new tzIndependentDate(e.groupConfigData.summary.block_from)<=new tzIndependentDate(n.businessDate)||e.groupConfigData.summary.is_cancelled},e.shouldDisableShoulderTo=function(){return e.isShoulderDateDisabled||new tzIndependentDate(e.groupConfigData.summary.block_to)<new tzIndependentDate(n.businessDate)||e.groupConfigData.summary.is_cancelled},e.addListener("DATE_CHANGE_FAILED",function(){Se()}),e.addListener("RESET_DATE_PICKERS",function(){b()}),e.addListener("DATE_MOVE_FAILED",function(t,a){a&&"SUMMARY"===a.activeTab&&e.clickedOnCancelMoveButton()})}]),angular.module("sntRover").controller("rvGroupRoomingAutoRoomAssignPopUpCtrl",["$scope",function(e){BaseCtrl.call(this,e);(function(){var t={};e.setScroller("failed_reservations_scroller",t)})();e.$on("NG_REPEAT_COMPLETED_RENDERING",function(t){e.refreshScroller("failed_reservations_scroller")})}]),angular.module("sntRover").controller("rvGroupReservationCheckinCtrl",["$rootScope","$scope","$timeout","rvGroupRoomingListSrv","$state",function(e,t,a,n,o){var r=function(e){t.$emit("REFRESH_GROUP_ROOMING_LIST_DATA"),t.$emit("FETCH_SUMMARY"),a(function(){t.closeDialog()},700)},i=function(e){};t.completeCheckIn=function(e,a){var o={group_id:e,reservation_ids:[a]},s={params:o,successCallBack:r,failureCallBack:i};t.callAPI(n.performMassCheckin,s)}}]),angular.module("sntRover").controller("rvGroupReservationCheckoutCtrl",["$rootScope","$scope","$timeout","RVBillCardSrv","ngDialog",function(e,t,a,n,o){var r=function(e){t.$emit("REFRESH_GROUP_ROOMING_LIST_DATA"),a(function(){t.closeDialog()},700)},i=function(e){t.$emit("showErrorMessage",e[0]),o.close()};t.completeCheckOut=function(e){var a={reservation_id:e},o={params:a,successCallBack:r,failureCallBack:i};t.callAPI(n.completeCheckout,o)}}]),angular.module("sntRover").controller("rvGroupReservationEditCtrl",["$rootScope","$scope","rvGroupRoomingListSrv","$filter","$timeout","rvUtilSrv","rvGroupConfigurationSrv","RVBillCardSrv","$state","ngDialog","rvPermissionSrv",function(e,t,a,n,o,r,i,s,c,u,l){BaseCtrl.call(this,t);var d,p,m,f=t.$parent,g={},v={date:!0,room:!0,occupancy:!0,roomType:!0},h=470;t.hasOverBookRoomTypePermission=l.getPermissionValue("OVERBOOK_ROOM_TYPE"),t.hasOverBookHousePermission=l.getPermissionValue("OVERBOOK_HOUSE"),t.hasBorrowFromHousePermission=l.getPermissionValue("GROUP_HOUSE_BORROW");var y=function(e,t){v[e]=t;for(var a in v)a!==e&&(v[a]=!t)};t.shouldDisableChangeRoom=function(e){var t=e.reservation_status,a=["RESERVED","CHECKING_IN"];return!(v.room&&_.contains(a,t))},t.shouldDisableFromDateChange=function(e){var t=e.reservation_status,a=["RESERVED","CHECKING_IN"];return!(v.date&&_.contains(a,t))},t.shouldDisableToDateChange=function(e){var t=e.reservation_status,a=["RESERVED","CHECKING_IN","CHECKEDIN","CHECKING_OUT"];return!(v.date&&_.contains(a,t))},t.shouldShowCheckoutButton=function(e){return!t.reservationStatusFlags.isExpected&&t.reservationStatusFlags.isPastArrival},t.shouldDisableCheckoutButton=function(e){return!t.reservationStatusFlags.isStaying||t.reservationStatusFlags.isUneditable||!e.can_checkout},t.shouldShowCheckinButton=function(e){return!t.reservationStatusFlags.isExpected&&t.reservationStatusFlags.isPastArrival},t.shouldDisableCheckinButton=function(e){return!t.reservationStatusFlags.canChekin||t.reservationStatusFlags.isUneditable||!e.can_checkin},t.shouldDisableStaycardButton=function(e){return!t.reservationStatusFlags.isGuestAttached},t.shouldDisableRemoveButton=function(e){return!t.reservationStatusFlags.isExpected},t.shouldDisableNameField=function(e){return t.reservationStatusFlags.isUneditable},t.shouldDisableReservationRoomTypeChange=function(e){var a=_.pluck(t.roomTypesAndData,"room_type_id"),n=!_.contains(a,parseInt(e.room_type_id)),o=e.reservation_status,r=!("RESERVED"===o||"CHECKING_IN"===o)||n;return!v.roomType||r},t.shouldDisableReservationOccuppancyChange=function(e){var a=t.reservationStatusFlags.isUneditable||t.reservationStatusFlags.isCheckedOut;return!v.occupancy||a},t.shouldShowThisOccupancyAgainstRoomType=function(e){var a=_.findWhere(t.ngDialogData.allowedRoomTypes,{room_type_id:parseInt(t.ngDialogData.room_type_id)});return"undefined"!=typeof a&&a[e]},t.isEmptyRoomNumber=function(e){return null===e||""===e};var D=function(){t.$$phase||t.$digest()},C=function(t){return n("date")(tzIndependentDate(t),e.dateFormatForAPI)},A=function(e){t.closeDialog(),t.$emit("REFRESH_GROUP_ROOMING_LIST_DATA"),t.$emit("FETCH_SUMMARY")};t.updateReservation=function(e,a){t.errorMessage="",_.extend(e,{group_id:t.groupConfigData.summary.group_id,arrival_date:C(t.roomingListState.editedReservationStart),departure_date:C(t.roomingListState.editedReservationEnd),room_type_id:parseInt(e.room_type_id),room_id:parseInt(e.room_id)}),a&&(e.forcefully_overbook=!0),angular.forEach(e.accompanying_guests_details,function(e,t){e.first_name||e.last_name||(e.first_name=null,e.last_name=null)});var n=function(a){if(a.status===h&&a.results.is_borrowed_from_house){var n=a.results;t.borrowData={},t.borrowData.currentReservation=e,n.room_overbooked||n.house_overbooked||(t.borrowData.isBorrowFromHouse=!0),n.room_overbooked&&!n.house_overbooked?(t.borrowData.shouldShowOverBookBtn=t.hasOverBookRoomTypePermission,t.borrowData.isRoomTypeOverbooked=!0):!n.room_overbooked&&n.house_overbooked?(t.borrowData.shouldShowOverBookBtn=t.hasOverBookHousePermission,t.borrowData.isHouseOverbooked=!0):n.room_overbooked&&n.house_overbooked&&(t.borrowData.shouldShowOverBookBtn=t.hasOverBookRoomTypePermission&&t.hasOverBookHousePermission,t.borrowData.isHouseAndRoomTypeOverbooked=!0),p=u.open({template:"/assets/partials/common/group/rvGroupBorrowPopup.html",className:"",closeByDocument:!1,closeByEscape:!0,scope:t})}else t.errorMessage=a},o={params:e,successCallBack:A,failureCallBack:n};t.callAPI(i.updateRoomingListItem,o)},t.performBorrowFromHouse=function(){t.borrowData.isBorrowFromHouse?(t.updateReservation(t.borrowData.currentReservation,!0),t.closeBorrowPopup(!0)):(t.closeBorrowPopup(),m=u.open({template:"/assets/partials/common/group/rvGroupOverbookPopup.html",className:"",closeByDocument:!1,closeByEscape:!0,scope:t}))},t.closeBorrowPopup=function(e){e&&(t.borrowData={}),p.close()},t.closeOverbookPopup=function(){t.borrowData={},m.close()},t.performOverBook=function(){t.updateReservation(t.borrowData.currentReservation,!0),t.closeOverbookPopup()};var S=function(e){u.open({template:"/assets/partials/groups/rooming/popups/editReservation/rvGroupEditRoomingListItemCheckoutConfirmation.html",className:"",scope:f,closeByDocument:!1,closeByEscape:!1,controller:"rvGroupReservationCheckoutCtrl",data:JSON.stringify(e)})},b=function(e){u.open({template:"/assets/partials/groups/rooming/popups/editReservation/rvGroupEditRoomingListItemCheckinConfirmation.html",className:"",scope:f,closeByDocument:!1,closeByEscape:!1,controller:"rvGroupReservationCheckinCtrl",data:JSON.stringify(e)})};t.checkoutReservation=function(e){if(e.is_bulk_checkout_in_progress){var a={message:"BULK_CHECKOUT_PROCESS_IN_PROGRESS",isFailure:!0};return void(d=u.open({template:"/assets/partials/popups/rvInfoPopup.html",closeByDocument:!0,scope:t,data:JSON.stringify(a)}))}var n=t.groupConfigData.summary,r={group_name:n.group_name,group_id:n.group_id,reservation_id:e.id};t.closeDialog(),o(function(){S(r)},800)},t.checkinReservation=function(e){var a=t.groupConfigData.summary,n={group_name:a.group_name,group_id:a.group_id,reservation_id:e.id};t.closeDialog(),o(function(){b(n)},800)},t.navigateStayCard=function(e){t.reservationStatusFlags.isGuestAttached&&(t.closeDialog(),o(function(){c.go("rover.reservation.staycard.reservationcard.reservationdetails",{id:e.id,confirmationId:e.confirm_no,isrefresh:!0})},750))};var P=function(e){var a=g.room_id,n=[],o=g.room_type_id===t.ngDialogData.room_type_id;null!==a&&""!==a&&o&&(n=[{id:a,room_number:g.room_no}]),t.ngDialogData.roomsFreeToAssign=n.concat(e.rooms)};t.changedReservationRoomType=function(){var e=t.ngDialogData,n={reserevation_id:e.id,num_of_rooms_to_fetch:5,room_type_id:e.room_type_id},o={params:n,successCallBack:P};y("roomType",!0),t.callAPI(a.getFreeAvailableRooms,o)},t.changedReservationOccupancy=function(){y("occupancy",!0)},t.changedReservationRoom=function(){y("room",!0)};var I=function(e){t.$emit("REFRESH_GROUP_ROOMING_LIST_DATA"),
o(function(){t.closeDialog()},700)};t.removeReservation=function(e){var a=t.reservationStatusFlags,n=null,o=null;return!!a.isExpected&&(o={id:e.id,group_id:t.groupConfigData.summary.group_id},n={params:o,successCallBack:I},t.callAPI(i.removeRoomingListItem,n),void 0)};var E=function(e,a){y("date",!0),t.roomingListState.editedReservationStart=new tzIndependentDate(r.get_date_from_date_picker(a)),t.reservationToDateOptions.maxDate=N(t.roomingListState.editedReservationStart),t.reservationToDateOptions.minDate=t.roomingListState.editedReservationStart,D()},R=function(e,a){y("date",!0),t.roomingListState.editedReservationEnd=new tzIndependentDate(r.get_date_from_date_picker(a)),t.reservationFromDateOptions.minDate=k(t.roomingListState.editedReservationEnd),t.reservationFromDateOptions.maxDate=t.roomingListState.editedReservationEnd,D()},O=function(t){var a=t.reservation_status;return{isCheckedOut:"CHECKEDOUT"===a,isUneditable:"CANCELED"===a,isExpected:"RESERVED"===a||"CHECKING_IN"===a,isStaying:"CHECKEDIN"===a||"CHECKING_OUT"===a,canChekin:!!t.room_no&&"CHECKING_IN"===a,isNoShow:"NOSHOW"===a,isGuestAttached:!!t.lastname,isPastArrival:new tzIndependentDate(e.businessDate)>=new tzIndependentDate(t.arrival_date.split("T")[0])}},T=function(){_.extend(g,t.ngDialogData),t.reservationStatusFlags=O(t.ngDialogData)},k=function(a){var o=tzIndependentDate(t.groupConfigData.summary.shoulder_from_date),r=tzIndependentDate(a),i=tzIndependentDate(e.businessDate),s=n("date")(r,"yyyy-MM-dd"),c=s.match(/(\d+)/g),u=new Date(c[0],parseInt(c[1])-1,parseInt(c[2],10)-t.maxStayLength),l=o>i?o:i;return l=u>l?u:l},N=function(e){var a=tzIndependentDate(e),o=tzIndependentDate(t.groupConfigData.summary.shoulder_to_date),r=n("date")(a,"yyyy-MM-dd"),i=r.match(/(\d+)/g),s=new Date(i[0],parseInt(i[1])-1,parseInt(i[2],10)+t.maxStayLength),c=o<s?o:s;return c},B=function(){var a={dateFormat:e.jqDateFormat,numberOfMonths:1,beforeShow:function(e,t){$("#ui-datepicker-div").addClass("reservation hide-arrow"),$('<div id="ui-datepicker-overlay">').insertAfter("#ui-datepicker-div"),setTimeout(function(){$("body").find("#ui-datepicker-overlay").on("click",function(){$("#room-out-from").blur(),$("#room-out-to").blur()})},100)},onClose:function(e){$("#ui-datepicker-div").removeClass("reservation hide-arrow"),$("#ui-datepicker-overlay").off("click").remove()}};t.reservationFromDateOptions=_.extend({onSelect:E,minDate:k(t.ngDialogData.departure_date),maxDate:new tzIndependentDate(t.ngDialogData.departure_date)},a),t.reservationToDateOptions=_.extend({onSelect:R,minDate:tzIndependentDate(t.ngDialogData.arrival_date)<tzIndependentDate(e.businessDate)?tzIndependentDate(e.businessDate):tzIndependentDate(t.ngDialogData.arrival_date),maxDate:N(t.ngDialogData.arrival_date)},a)};t.closeErrorDialog=function(){d&&d.close()},function(){T(),B()}()}]),angular.module("sntRover").controller("rvReservationGuestDataPopupCtrl",["$rootScope","$scope","$timeout","rvGroupRoomingListSrv","$state",function(e,t,a,n,o){t.title=t.isUpdateReservation?"Edit":"Add",_.each(t.selected_reservations,function(e){e.isOpenAccompanyingGuest=!1;var t=0;angular.forEach(e.accompanying_guests_details,function(e,a){(""!==e.first_name&&null!==e.first_name||""!==e.last_name&&null!==e.last_name)&&(t+=1)}),e.accompanyingLength=t;var a="";1===e.occupancy?a="Single":2===e.occupancy?a="Double":3===e.occupancy?a="Triple":4===e.occupancy&&(a="Quadruple"),e.occupancyName=a}),t.setScroller("guest-data-scroll");var r=function(){a(function(){t.refreshScroller("guest-data-scroll")},1500)};r(),t.toggleAccompanyingGuest=function(e){var a=event.target;return"text"!==a.type&&(_.each(t.selected_reservations,function(t,a){a!==e&&(t.isOpenAccompanyingGuest=!1)}),t.selected_reservations[e].isOpenAccompanyingGuest=!t.selected_reservations[e].isOpenAccompanyingGuest,void r())};var i=function(){t.closeDialog(),t.$emit("REFRESH_GROUP_ROOMING_LIST_DATA"),t.$emit("FETCH_SUMMARY")},s=function(e){t.errorMessage=e};t.updateCompleteGuestData=function(){var e=["confirm_no","reservation_status","arrival_date","departure_date","guest_card_id","rate_id","room_type_id","room_type_name","room_rate_amount","can_checkin","can_checkout","is_guest_name_added","is_room_number_present","is_room_ready","due_in","room_id","room_no","fostatus","roomstatus","checkin_inspected_only","room_ready_status","isOpenAccompanyingGuest","accompanyingLength","occupancyName"],a=[];_.each(t.selected_reservations,function(t,n){t.is_accompanying_guest||(angular.forEach(t.accompanying_guests_details,function(e){e.first_name||e.last_name||(e.first_name=null,e.last_name=null)}),a.push(dclone(t,e)))});var o={};o.guest_data=a,t.errorMessage="";var r={params:o,successCallBack:i,failureCallBack:s};t.callAPI(n.updateGuestData,r)},t.refreshScreenWithNewReservations=function(){t.closeDialog(),t.$emit("REFRESH_GROUP_ROOMING_LIST_DATA")},t.isDataEditable=function(e){var t=e.reservation_status,a=!1;return"CANCELED"===t&&(a=!0),a}}]),angular.module("sntRover").controller("rvGroupRoomingMassCheckoutPopUpCtrl",["$scope",function(e){BaseCtrl.call(this,e);(function(){var t={};e.setScroller("failed_reservations_scroller",t)})();e.$on("NG_REPEAT_COMPLETED_RENDERING",function(t){e.refreshScroller("failed_reservations_scroller")})}]),angular.module("sntRover").controller("rvGroupRoomingMassCheckinPopUpCtrl",["$scope",function(e){BaseCtrl.call(this,e);(function(){var t={};e.setScroller("failed_reservations_scroller",t)})();e.$on("NG_REPEAT_COMPLETED_RENDERING",function(t){e.refreshScroller("failed_reservations_scroller")})}]),sntRover.controller("rvAccountsConfigurationCtrl",["$scope","$rootScope","rvGroupSrv","$filter","$stateParams","rvAccountsConfigurationSrv","rvGroupConfigurationSrv","accountData","$state","rvPermissionSrv","rvAccountTransactionsSrv","$vault","$timeout","transitions",function(e,t,a,n,o,r,i,s,c,u,l,d,p,m){BaseCtrl.call(this,e);var f=function(){e.$$phase||e.$digest()};e.isInAddMode=function(){return"NEW_ACCOUNT"===o.id};var _=function(){var t=n("translate")("ACCOUNT_DETAILS");e.isInAddMode()&&(t=n("translate")("NEW_ACCOUNT")),e.setHeadingTitle(t)};e.updateAndBackFlag=!1,e.updateAndBack=function(){e.isInAddMode?c.go("rover.accounts.search"):(e.$broadcast("UPDATE_ACCOUNT_SUMMARY"),e.updateAccountSummary(),e.updateAndBackFlag=!0)};var g=function(){if(o.isFromCards)t.setPrevState={title:n("translate")("ACCOUNTS"),callback:"updateAndBack",scope:e};else if(o.isFromArTransactions){var a=o.isFromArTab;t.setPrevState={title:"AR Transactions",name:"rover.companycarddetails",param:{id:d.get("cardId"),type:d.get("type"),query:d.get("query"),isBackFromStaycard:!0,isBackFromStaycardToARTab:a}}}else"rover.financials.invoiceSearch"===e.previousState.name?t.setPrevState={title:"INVOICE SEARCH",name:"rover.financials.invoiceSearch",param:{isFromStayCard:!0}}:m.get().from().name.match(/rover\.reports/)&&(t.setPrevState={title:"REPORTS",name:m.get().from().name,param:angular.extend(angular.copy(m.get().params("from")),{action:"report.show.last"})});_()},v=function(){var t=e.accountConfigData.summary;return!!t.posting_account_name};e.initializeDataModelForSummaryScreen=function(){e.accountConfigData={activeTab:o.activeTab,summary:s}},e.hasPermissionToViewTransactionsTab=function(){return u.getPermissionValue("ACCESS_GROUP_ACCOUNT_TRANSACTIONS")},e.switchTabTo=function(t){if(e.errorMessage="","TRANSACTIONS"===t&&!e.hasPermissionToViewTransactionsTab())return void(e.errorMessage=["Sorry, you don't have the permission to access the transactions"]);var a="ACCOUNT"===e.accountConfigData.activeTab,n=a&&"ACCOUNT"!==t;return e.isInAddMode()&&n?void(e.errorMessage=["Sorry, Please save the entered information and try to switch the tab"]):(a&&!e.isInAddMode(),"ACCOUNT"===t||"TRANSACTIONS"===t||e.$broadcast("UPDATE_ACCOUNT_SUMMARY"),e.accountConfigData.activeTab=t,void p(function(){e.$broadcast("ACCOUNT_TAB_SWITCHED",e.accountConfigData.activeTab)},100))},e.saveNewAccount=function(){if(e.errorMessage="",u.getPermissionValue("CREATE_ACCOUNT"))if(v()){var t=function(t){e.accountConfigData.summary.posting_account_id=t.posting_account_id,c.go("rover.accounts.config",{id:t.posting_account_id}),o.id=t.posting_account_id},a=function(t){e.errorMessage=t};e.callAPI(r.saveAccountSummary,{successCallBack:t,failureCallBack:a,params:{summary:e.accountConfigData.summary}})}else e.errorMessage=["Account's name is mandatory"];else console.warn("No Permission for CREATE_GROUP_SUMMARY")},e.discardNewAccount=function(){e.accountConfigData.summary=angular.copy(r.baseAccountSummaryData)};var h=function(){var t={focus:function(e,t){return!1}};e.companyAutoCompleteOptions=angular.extend({source:function(e,t){i.searchCompanyCards(e.term).then(function(e){var a=[],n={};$.map(e,function(e){n={label:e.account_name,value:e.id,address:e.account_address,type:e.account_type,contract_access_code:e.current_contracts.length>0?e.current_contracts[0].access_code:null},a.push(n)}),t(a)})},select:function(t,a){return this.value=a.item.label,e.accountConfigData.summary.company.name=a.item.label,e.accountConfigData.summary.company.id=a.item.value,e.isInAddMode()||e.updateAccountSummary(),f(),!1},change:function(){e.isInAddMode()||e.accountConfigData.summary.company.name||(e.accountConfigData.summary.company.id="",e.updateAccountSummary())}},t),e.travelAgentAutoCompleteOptions=angular.extend({source:function(e,t){i.searchTravelAgentCards(e.term).then(function(e){var a=[],n={};$.map(e,function(e){n={label:e.account_name,value:e.id,address:e.account_address,type:e.account_type,contract_access_code:e.current_contracts.length>0?e.current_contracts[0].access_code:null},a.push(n)}),t(a)})},select:function(t,a){return this.value=a.item.label,e.accountConfigData.summary.travel_agent.name=a.item.label,e.accountConfigData.summary.travel_agent.id=a.item.value,e.isInAddMode()||e.updateAccountSummary(),f(),!1},change:function(){e.isInAddMode()||e.accountConfigData.summary.travel_agent.name||(e.accountConfigData.summary.travel_agent.id="",e.updateAccountSummary())}},t)};e.updateAccountSummary=function(){if(u.getPermissionValue("EDIT_ACCOUNT")){var t=function(t){e.$broadcast("UPDATED_ACCOUNT_INFO"),e.updateAndBackFlag?c.go("rover.accounts.search"):e.$emit("hideLoader")},a=function(t){e.$broadcast("FAILED_TO_UPDATE_ACCOUNT_INFO"),e.$emit("showErrorMessage",t),e.$emit("hideLoader")};e.callAPI(r.updateAccountSummary,{successCallBack:t,failureCallBack:a,params:{summary:e.accountConfigData.summary}})}else e.$emit("showErrorMessage",["Sorry, Changes will not get saved as you don't have enough permission"])},e.$on("showErrorMessage",function(t,a){e.errorMessage=a,f()}),e.shouldShowCompanyCardNavigationButton=function(){return!e.isInAddMode()&&e.accountConfigData.summary.company&&!!e.accountConfigData.summary.company.id},e.shouldShowTravelAgentNavigationButton=function(){return!e.isInAddMode()&&e.accountConfigData.summary.travel_agent&&!!e.accountConfigData.summary.travel_agent.id},e.goToTACard=function(){c.go("rover.companycarddetails",{id:e.accountConfigData.summary.travel_agent.id,type:"TRAVELAGENT"})},e.goToCompanyCard=function(){c.go("rover.companycarddetails",{id:e.accountConfigData.summary.company.id,type:"COMPANY"})};var y=function(){e.initializeDataModelForSummaryScreen(),h(),g(),"rover.financials.invoiceSearch"===e.previousState.name&&e.switchTabTo("TRANSACTIONS")};y()}]),sntRover.controller("rvAccountsRootCtrl",["$scope","$rootScope","$filter","$timeout","$interval","$log",function(e,t,a,n,o,r){e.setHeadingTitle=function(t){e.heading=t,e.setTitle(a("translate")(t))},t.disableObserveForSwipe||(CardReaderCtrl.call(this,e,t,n,o,r),e.observeForSwipe())}]),sntRover.controller("rvAccountActivityCtrl",["$scope","$rootScope","$filter","$stateParams","rvGroupAccountActivitySrv",function(e,t,a,n,o){BaseCtrl.call(this,e),e.init=function(){e.selectedGroupOrAccountId=e.$parent.accountConfigData.summary.posting_account_id;var t={id:e.selectedGroupOrAccountId,page:1,type:"account",per_page:50},a=function(t){e.$broadcast("PopulateLogData",t)};e.invokeApi(o.fetchActivityLog,t,a)},e.$on("updateLogdata",function(t,a){a.id=e.selectedGroupOrAccountId,a.type="account";var n=function(t){e.$broadcast("PopulateLogData",t)};e.invokeApi(o.fetchActivityLog,a,n)}),e.$on("ACCOUNT_TAB_SWITCHED",function(t,a){"ACTIVITY"===a&&e.init()})}]),sntRover.controller("rvAccountsSearchCtrl",["$scope","$rootScope","rvAccountsSrv","initialAccountsListing","$filter","$timeout","$state","rvUtilSrv","rvPermissionSrv",function(e,t,a,n,o,r,i,s,c){BaseCtrl.call(this,e),e.isEmpty=s.isEmpty,e.getClassAgainstBalance=function(e){var t="";return s.convertToDouble(e.balance)>0&&(t="red"),t},e.getClassAgainstAccountStatus=function(e){var t="";return e.status&&"open"===e.status.toLowerCase()&&(t="green"),t},e.clearSearchQuery=function(t){t.preventDefault(),t.stopPropagation(),e.query="",e.search()},e.stringify=s.stringify,e.$on("NG_REPEAT_STARTED_RENDERING",function(t){e.$emit("showLoader")}),e.$on("NG_REPEAT_COMPLETED_RENDERING",function(t){r(function(){m()},300),e.$emit("hideLoader")}),e.hasPermissionToAddNewAccount=function(){return c.getPermissionValue("CREATE_ACCOUNT")},e.searchQueryChanged=function(){return!e.isEmpty(e.query)&&(!(e.query.length<3)&&void e.search())};var u=function(){var t={query:e.query,status:e.status,to_date:e.toDate,per_page:e.perPage,page:e.page,account_type:e.accountType,is_non_zero:e.isNonZero};return t};e.search=function(t){e.amFirstTimeHere=!1,e.page=t||1,e.errorMessage="";var n=u(),o={params:n,successCallBack:l,failureCallBack:d};e.callAPI(a.getAccountsList,o)};var l=function(t){e.accountList=t.posting_accounts,e.totalResultCount=t.total_count,r(function(){e.$broadcast("updatePagination","ACCOUNT_SEARCH")},800),m()},d=function(t){e.errorMessage=t},p=function(){var t={tap:!0,preventDefault:!1,deceleration:1e-4,shrinkScrollbars:"clip"};e.setScroller("result_showing_area",t)},m=function(){e.refreshScroller("result_showing_area")};e.shouldShowPagination=function(){return e.totalResultCount>=e.perPage};var f=function(){return e.accountList.length>0};e.isFirstTimeWithNoResult=function(){return e.amFirstTimeHere&&!f()},e.shouldShowNoResult=function(){return!e.amFirstTimeHere&&!f()},e.shouldShowAddNewButton=function(){return e.hasPermissionToAddNewAccount()},e.gotoEditAccountConfiguration=function(e){i.go("rover.accounts.config",{id:e,activeTab:"ACCOUNT",isFromCards:!0})},e.gotoAddNewAccount=function(){i.go("rover.accounts.config",{id:"NEW_ACCOUNT",isFromCards:!0})};(function(){e.setHeadingTitle("MENU_ACCOUNTS"),e.$emit("updateRoverLeftMenu","accounts"),e.accountList=n.posting_accounts,e.totalResultCount=n.total_count,e.amFirstTimeHere=!0,e.query="",e.isNonZero=!1,e.status="OPEN",p(),e.perPage=a.DEFAULT_PER_PAGE,e.accountSearchPagination={id:"ACCOUNT_SEARCH",api:e.search,perPage:a.DEFAULT_PER_PAGE},e.search()})()}]),sntRover.controller("rvAccountSummaryCtrl",["$scope","$rootScope","$filter","$stateParams","RVPaymentSrv","RVDepositBalanceSrv","rvAccountsConfigurationSrv","RVReservationSummarySrv","ngDialog","rvPermissionSrv","RVReservationCardSrv",function(e,t,a,n,o,r,i,s,c,u,l){BaseCtrl.call(this,e);var d={};e.updateAccountSummary=function(){if(u.getPermissionValue("EDIT_ACCOUNT")){var t=function(t){e.$broadcast("UPDATED_ACCOUNT_INFO"),e.$emit("hideloader")},a=function(t){e.$broadcast("FAILED_TO_UPDATE_ACCOUNT_INFO"),e.$emit("showErrorMessage",t),e.$emit("hideloader")};e.callAPI(i.updateAccountSummary,{successCallBack:t,failureCallBack:a,params:{summary:e.accountConfigData.summary}})}else e.$emit("showErrorMessage",["Sorry, Changes will not get saved as you don't have enough permission"])};var p=function(){var t,a=e.accountConfigData.summary;for(t in d)if(!angular.equals(a[t],d[t]))return!1;return!0},m=function(){e.setScroller("rvAccountSummaryScroller"),e.accountSummaryData={promptMandatoryDemographics:!1,isDemographicsPopupOpen:!1,newNote:"",editingNote:null,demographics:null},d=angular.copy(e.accountConfigData.summary);var t=function(){p()||e.accountSummaryData.isDemographicsPopupOpen||(d=angular.copy(e.accountConfigData.summary),e.updateAccountSummary())};e.isInAddMode()||(e.$on("OUTSIDECLICKED",function(e,a){"AccountTab"!==a.id&&t()}),e.$on("UPDATE_ACCOUNT_SUMMARY",function(e,a){t()}))};e.getBalanceAmount=function(e){return"undefined"==typeof e?"":t.currencySymbol+a("number")(e,2)};var f=e.$on("BALANCE_AFTER_PAYMENT",function(t,a){e.accountConfigData.summary.balance=a});e.isDemographicsFormValid=function(){return!0},e.closeDemographicsPopup=function(){e.accountSummaryData.isDemographicsPopupOpen=!1,e.closeDialog()};var g={};e.openDemographicsPopup=function(){e.errorMessage="";var t=function(){e.accountSummaryData.isDemographicsPopupOpen=!0,g=angular.copy(e.accountConfigData.summary.demographics),c.open({template:"/assets/partials/accounts/accountsTab/rvAccountDemographics.html",className:"",scope:e,closeByDocument:!1,closeByEscape:!1})},a=function(a){e.accountSummaryData.demographics=a.demographics,t()},n=function(e){};null===e.accountSummaryData.demographics?e.callAPI(s.fetchInitialData,{successCallBack:a,failureCallBack:n}):t()},e.saveDemographicsData=function(){return e.isInAddMode()?void(e.errorMessage=["Account needs to be saved first"]):(e.updateAccountSummary(),void e.closeDemographicsPopup())},e.cancelDemographicChanges=function(){e.accountConfigData.summary.demographics=g},e.saveAccountNote=function(){if(e.isInAddMode())return void(e.errorMessage=["Account needs to be saved first'"]);if(e.errorMessage="",e.accountSummaryData.newNote){var t=function(t){e.accountConfigData.summary.notes=t.notes,e.accountSummaryData.newNote="",e.refreshScroller("rvAccountSummaryScroller")},a=function(t){e.errorMessage=t};e.callAPI(i.saveAccountNote,{successCallBack:t,failureCallBack:a,params:{notes:e.accountSummaryData.newNote,posting_account_id:e.accountConfigData.summary.posting_account_id}})}},e.removeAccountNote=function(t,a){var n=function(t,a){e.accountConfigData.summary.notes=_.without(e.accountConfigData.summary.notes,_.findWhere(e.accountConfigData.summary.notes,{note_id:a.noteId})),e.refreshScroller("rvAccountSummaryScroller"),e.cancelEditModeAccountNote()},o=function(t){e.errorMessage=t};t.stopPropagation(),e.callAPI(i.removeAccountNote,{successCallBack:n,failureCallBack:o,params:{note_id:a},successCallBackParameters:{noteId:a}})},e.updateActiveAccountNote=function(){if(!e.accountSummaryData.editingNote)return void(e.errorMessage=["Something went wrong, please switch tab and comeback"]);if(e.errorMessage="",e.accountSummaryData.newNote){var t=function(t){e.accountSummaryData.editingNote.description=e.accountSummaryData.newNote;var a=_.findIndex(e.accountConfigData.summary.notes,{note_id:t.note_id});e.accountConfigData.summary.notes[a]=e.accountSummaryData.editingNote,e.refreshScroller("rvAccountSummaryScroller"),e.cancelEditModeAccountNote()},a=function(t){e.errorMessage=t};e.callAPI(i.updateAccountNote,{successCallBack:t,failureCallBack:a,params:{id:e.accountSummaryData.editingNote.note_id,text:e.accountSummaryData.newNote,associated_id:e.accountConfigData.summary.posting_account_id,associated_type:"PostingAccount"}})}},e.clickedOnNote=function(t){e.accountSummaryData.editingNote=t,e.accountSummaryData.newNote=t.description.replace(new RegExp("<br/>","g"),"\n")},e.cancelEditModeAccountNote=function(){e.accountSummaryData.editingNote=null,e.accountSummaryData.newNote=""},e.onCloseWarningPopup=function(){e.accountConfigData.summary.posting_account_status="OPEN",e.closeDialog()},e.onAccountTypeModification=function(){"GROUP"===e.accountConfigData.summary.posting_account_type&&(e.accountConfigData.summary.posting=!1),e.accountConfigData.summary.posting_account_id&&e.updateAccountSummary()},e.onAccountStatusModification=function(){parseFloat(e.accountConfigData.summary.balance)&&"CLOSED"===e.accountConfigData.summary.posting_account_status?c.open({template:"/assets/partials/accounts/accountsTab/rvAccountAlertCloseWithBalance.html",className:"",scope:e,closeByDocument:!1,closeByEscape:!1}):e.updateAccountSummary()};var v=function(t){e.accountConfigData.summary=t,d=angular.copy(e.accountConfigData.summary)},h=function(){var t={accountId:e.accountConfigData.summary.posting_account_id},a={params:t,successCallBack:v};e.callAPI(i.getAccountSummary,a)};m(),e.$on("ACCOUNT_TAB_SWITCHED",function(e,t){"ACCOUNT"===t&&(m(),h())}),e.$on("GROUP_TAB_SWITCHED",function(e,t){"ACCOUNT"===t&&(m(),h())}),e.paymentTypes=[],e.creditCardTypes=[];var y=function(t){e.$emit("hideLoader"),e.paymentTypes=t,angular.forEach(e.paymentTypes,function(t,a){"CC"==t.name&&(e.creditCardTypes=t.values)})};e.invokeApi(o.fetchAvailPayments,{},y),e.openDepositBalanceModal=function(){e.$emit("showErrorMessage",[]);var t={posting_account_id:e.accountConfigData.summary.posting_account_id},a=function(t){e.$emit("showErrorMessage",t)};e.callAPI(r.getRevenueDetails,{params:t,onSuccess:e.successCallBackFetchDepositBalance,onFailure:a})},e.successCallBackFetchDepositBalance=function(t){e.$emit("hideLoader"),e.depositBalanceData=t,e.$emit("TOGGLE_PAYMET_POPUP_STATUS",!0),e.passData={origin:"GROUP",details:{firstName:"",lastName:"",paymentTypes:e.paymentTypes,accountId:e.accountConfigData.summary.posting_account_id}},c.open({template:"/assets/partials/depositBalance/rvModifiedDepositBalanceModal.html",controller:"RVDepositBalanceAccountsCtrl",className:"ngdialog-theme-default1",closeByDocument:!1,scope:e})};var D=function(t){var a=new SwipeOperation,n=a.createSWipedDataToRender(t);e.$broadcast("SHOW_SWIPED_DATA_ON_DEPOSIT_BALANCE_SCREEN",n)};e.$on("SWIPE_ACTION",function(t,a){var n=new SwipeOperation,o=n.createDataToTokenize(a),r=function(t){e.$emit("hideLoader"),a.token=t,D(a)};e.invokeApi(l.tokenize,o,r)}),e.$on("$destroy",f)}]),sntRover.controller("rvAccountDatepickerCtrl",["$scope","ngDialog",function(e,t){e.date=e.ngDialogData.activeDate,e.setUpData=function(){e.dateOptions={changeYear:!0,changeMonth:!0,minDate:tzIndependentDate(e.ngDialogData.minDate),maxDate:tzIndependentDate(e.ngDialogData.maxDate),yearRange:"-100:+5",onSelect:function(){e.$emit("DATE_CHANGED",e.date),t.close()}}},e.setUpData()}]),sntRover.controller("rvAccountTransactionsCtrl",["$scope","$rootScope","$filter","$stateParams","ngDialog","rvAccountsConfigurationSrv","RVReservationSummarySrv","rvAccountTransactionsSrv","RVPaymentSrv","RVReservationCardSrv","RVBillCardSrv","rvPermissionSrv","RVAutomaticEmailSrv","$timeout","$window","$q","jsMappings","sntActivity",function(e,t,a,n,o,r,i,s,c,u,l,d,p,m,f,g,v,h){BaseCtrl.call(this,e),SharedMethodsBaseCtrl.call(this,e,t,p,o);var y=this;e.stateParams=n,e.perPage=50,e.maxNoOfDaysToShow=15,e.businessDate=t.businessDate,e.isFromBillCard=!1,e.reservationBillData={},e.groupId=null,e.type="SUMMARY"===n.activeTab?"Group":"Account";var D=function(t){var a=e.transactionsDetails.bills[e.currentActiveBill].days,n=_.find(a,function(e){return e.date===t});if(!n.show){var o=0,r=!1;angular.forEach(a,function(a){a.date===t&&(r=!0),r&&o<e.maxNoOfDaysToShow?(a.show=!0,o++):a.show=!1})}e.transactionsDetails.bills[e.currentActiveBill].activeDate=t},C=function(){var t=e.transactionsDetails.bills[e.currentActiveBill],a=t.days.length;a>0&&a<=e.maxNoOfDaysToShow?angular.forEach(t.days,function(e){e.show=!0}):a>0&&angular.forEach(t.days,function(t,n){t.show=n>=a-e.maxNoOfDaysToShow})},A=function(t,a){var n=e.transactionsDetails.bills[e.currentActiveBill];t.transactions.length>0?(e.errorMessage="",n.transactions=[],_.each(t.transactions,function(e){e.description=null!==e.card_number&&""!==e.card_number?e.description+"-"+e.card_number:e.description}),n.transactions=t.transactions,n.total_count=t.total_count,Z(),angular.forEach(n.transactions,function(e,t){e.billValue=n.bill_number,e.oldBillValue=n.bill_number}),P(!1),m(function(){e.$broadcast("updatePagination",n.bill_number)},1e3),a?D(a):C()):0===t.transactions.length&&n.transactions.length>0?O():e.errorMessage=["The date selected has no transactions, please select a new date"]},S=function(t){e.errorMessage=t},b=function(t,a){var n=e.transactionsDetails.bills[e.currentActiveBill];n.page_no=t||1;var o={bill_id:n.bill_id,date:a?a:n.activeDate,page:n.page_no,per_page:e.perPage},r={successCallBack:A,failureCallBack:S,successCallBackParameters:a,params:o};e.callAPI(s.fetchBillTransactionDetails,r)};e.hasMoveToOtherBillPermission=function(){return t.isStandAlone&&d.getPermissionValue("MOVE_CHARGES_RESERVATION_ACCOUNT")},e.clickedVoidBillButton=function(){e.isFromAccounts=!0,o.open({template:"/assets/partials/bill/rvVoidBillPopup.html",controller:"RVVoidBillPopupCtrl",className:"",scope:e})},e.shouldShowVoidBill=function(){return!e.transactionsDetails.bills[e.currentActiveBill].is_active&&0===parseInt(e.transactionsDetails.bills[e.currentActiveBill].balance_amount)&&!e.transactionsDetails.bills[e.currentActiveBill].is_db_payment_exists&&e.transactionsDetails.is_void_bill_enabled&&!e.transactionsDetails.bills[e.currentActiveBill].is_voided&&!e.transactionsDetails.bills[e.currentActiveBill].is_void_bill},e.addListener("VOID_BILL_GENERATED",function(){e.closeDialog(),O()});var P=function(t){var a=e.transactionsDetails.bills,n=a[e.currentActiveBill].transactions;_.each(n,function(e){e.isSelected=t}),e.transactionsDetails.isAllChargeCodeSelected=t};e.isAllChargeCodesSelected=function(){var a=!0,n=e.transactionsDetails.bills;if(t.isStandAlone){var o=n[e.currentActiveBill].transactions;o&&o.length>0?_.each(o,function(e){e.isSelected||(a=!1)}):a=!1}else a=!1;return a},e.isAnyOneChargeCodeIsExcluded=function(){var t=!1,a=!1,n=e.transactionsDetails.bills,o=n[e.currentActiveBill].transactions;return o&&o.length>0?_.each(o,function(e,n){e.isSelected?a=!0:t=!0}):(t=!1,a=!1),t&&a},e.selectAllChargeCodeToggle=function(){P(e.transactionsDetails.isAllChargeCodeSelected?!0:!1)},e.moveChargesClicked=function(){h.start("MOVE_CHARGES_CLICKED"),v.fetchAssets(["addBillingInfo","directives"]).then(function(){h.stop("MOVE_CHARGES_CLICKED");var t=e.transactionsDetails.bills,a=t[e.currentActiveBill].transactions;e.moveChargeData={},e.moveChargeData.selectedTransactionIds=[];var n="undefined"!=typeof e.accountConfigData.summary.posting_account_name?e.accountConfigData.summary.posting_account_name:"";e.moveChargeData.displayName=n,e.moveChargeData.currentActiveBillNumber=parseInt(e.currentActiveBill)+parseInt(1),e.moveChargeData.fromBillId=t[e.currentActiveBill].bill_id,e.moveChargeData.isMoveAllCharges=!1,e.moveChargeData.totalCount=e.transactionsDetails.bills[e.currentActiveBill].total_count,e.moveChargeData.date=e.invoiceDate,a.length>0&&(_.each(a,function(t,a){if(t.isSelected)if(t.is_group_by_ref){var n=e.moveChargeData.selectedTransactionIds.concat(t.item_ids);e.moveChargeData.selectedTransactionIds=n}else e.moveChargeData.selectedTransactionIds.push(t.id)}),e.origin="ACCOUNT",o.open({template:"/assets/partials/bill/rvMoveTransactionPopup.html",controller:"RVMoveChargeCtrl",className:"",scope:e}))})},e.hasPermissionToMoveCharges=function(){return d.getPermissionValue("GROUP_MOVE_CHARGES_BILL")};var I=(function(){e.currentActiveBill=0,e.dayRates=-1,e.isStandAlone=t.isStandAlone,e.setScroller("registration-content"),e.setScroller("bill-tab-scroller",{scrollX:!0}),e.setScroller("billDays",{scrollX:!0,scrollY:!1}),e.showMoveCharges=e.hasPermissionToMoveCharges(),e.renderData={},e.paymentModalOpened=!1,e.isFromGroups="undefined"!=typeof e.groupConfigData&&"TRANSACTIONS"===e.groupConfigData.activeTab,e.invoiceDate=t.businessDate}(),function(){var t=function(t){e.transactionsDetails.is_bill_lock_enabled&&(e.transactionsDetails.bills[e.currentActiveBill].is_active=!1)},a=function(t){e.errorMessage=t},n={bill_id:e.transactionsDetails.bills[e.currentActiveBill].bill_id},o={params:n,successCallBack:t,failureCallBack:a};e.callAPI(l.callBlackBoxApi,o)});y.generateFolioNumber=function(t,a,n,o){if(e.shouldGenerateFolioNumber=!1,0===parseInt(a)&&!n){var r=function(t){e.transactionsDetails.is_bill_lock_enabled&&(e.transactionsDetails.bills[o].is_active=!1),e.transactionsDetails.bills[o].is_folio_number_exists=!0},i={bill_id:t},s={params:i,successCallBack:r};e.callAPI(l.generateFolioNumber,s)}};var E=function(a){e.hasPrintFolioEnabled=a.is_print_folio_enabled,e.transactionsDetails=a;var n=e.transactionsDetails.bills[e.currentActiveBill];0===parseInt(n.balance_amount)&&e.isFromPaymentScreen&&(e.isFromPaymentScreen=!1,t.isInfrasecActivated&&t.isInfrasecActivatedForWorkstation&&I()),0===parseInt(n.balance_amount)&&e.shouldGenerateFolioNumber&&y.generateFolioNumber(n.bill_id,n.balance_amount,n.is_folio_number_exists,e.currentActiveBill),X(),e.shouldGenerateFolioNumber=!1,e.refreshScroller("bill-tab-scroller"),e.refreshScroller("billDays")},R=e.$on("moveChargeSuccsess",function(t,a){var n=function(e){E(e)},r={account_id:e.accountConfigData.summary.posting_account_id},i={params:r,successCallBack:n};a.is_move_charges_inprogress?o.open({template:"/assets/partials/bill/rvMoveAllChargesInprogress.html",className:"",scope:e}):e.callAPI(s.fetchTransactionDetails,i)});e.$on("$destroy",R);var O=function(){var t=function(e){E(e)},a={account_id:e.accountConfigData.summary.posting_account_id},n={successCallBack:t,params:a};e.callAPI(s.fetchTransactionDetails,n)};e.$on("AUTO_TRIGGER_EMAIL_AFTER_PAYMENT",function(t,a){e.sendAutomaticEmails(a)}),e.UPDATE_TRANSACTION_DATA=function(){O()};var T=e.$on("UPDATE_TRANSACTION_DATA",function(a,n){n.response_data&&n.response_data.message&&k(n.response_data),e.isFromPaymentScreen=n.isFromPaymentSuccess,(e.isFromPaymentScreen&&!e.transactionsDetails.is_bill_lock_enabled||"DB"===n.selectedPaymentType)&&(e.shouldGenerateFolioNumber=!0),O(),e.currentPaymentBillId=n.bill_id,e.currentPaymentTransactionId=n.transaction_id,e.isFromGroups&&t.autoEmailPayReceipt&&e.isFromPaymentScreen&&e.autoTriggerPaymentReceiptActions()}),k=function(t){e.message=t.message,m(function(){o.open({template:"/assets/partials/bill/rvShowMessagePopup.html",className:"",closeByDocument:!1,scope:e})},1e3)};e.$on("$destroy",T),e.createNewBill=function(){var t={account_id:e.accountConfigData.summary.posting_account_id},a=function(e){O()},n={params:t,successCallBack:a};e.callAPI(s.createAnotherBill,n)},e.moveToBillActionfetchSuccessCallback=function(t){e.fetchSuccessCallback(t)},e.moveToBillAction=function(t,a){var n=parseInt(t)-1,o=e.transactionsDetails.bills[n].transactions[a],r=o.billValue,i=o.id?o.id:null,c=o.item_ids?o.item_ids:[],u={to_bill:r,from_bill:t,transaction_id:i,item_ids:c,account_id:e.accountConfigData.summary.posting_account_id},l=function(t){e.$emit("hideLoader"),u.toBill=parseInt(t.bill_id),e.transactionsDetails.bills[t.bill_number-1]={bill_id:t.bill_id,bill_number:t.bill_number},O(u)},d=function(t){e.$emit("hideLoader"),e.errorMessage=t};e.invokeApi(s.moveToAnotherBill,u,l,d)},e.getWidthForBillTabsScroll=function(){var t=0;if(void 0!==e.transactionsDetails)var t=$("#registration-summary ul li").width()*(e.transactionsDetails.bills.length+1);return t},e.showActiveBill=function(t){var a=e.transactionsDetails.bills[t],n="",o=e.transactionsDetails.bills.length,r=a.is_transactions_exist;return 0===t||t!==e.currentActiveBill||o-1!==t||r?t===e.currentActiveBill&&(n="ui-tabs-active ui-state-active"):n="ui-tabs-active ui-state-active with-button",n},e.setActiveBill=function(t){e.currentActiveBill=t;var a=e.transactionsDetails.bills[t];a.activeDate=a.days.length>0?_.last(a.days).date:null,X()},e.callAPI(l.fetchAdjustmentReasons,{successCallBack:function(t){e.adjustmentReasonOptions=t.force_adjustment_reasons,e.showAdjustmentReason=t.force_adjustment_reason_enabled}}),e.openPostCharge=function(t){h.start("OPEN_POST_CHARGE"),v.fetchAssets(["postcharge","directives"]).then(function(){h.stop("OPEN_POST_CHARGE"),e.account_id=e.accountConfigData.summary.posting_account_id,e.billNumber=t;for(var a=[],n=0;n<e.transactionsDetails.bills.length;n++)a.push(n+1);e.fetchedData={},e.fetchedData.bill_numbers=a,e.isOutsidePostCharge=!1,e.shouldShowChargesForMobile=!1,o.open({template:"/assets/partials/postCharge/rvPostChargeV2.html",className:"",
scope:e})})};var N=function(){var t={account_id:e.accountConfigData.summary.posting_account_id,is_swiped:!1,details:{firstName:"",lastName:""}};return t};e.showPayemntModal=function(){h.start("SHOW_PAYMENT_MODEL"),v.fetchAssets(["addBillingInfo","directives"]).then(function(){h.stop("SHOW_PAYMENT_MODEL"),e.passData=N(),e.paymentModalOpened=!0,e.$emit("TOGGLE_PAYMET_POPUP_STATUS",!0),o.open({template:"/assets/partials/accounts/transactions/rvAccountPaymentModal.html",className:"",controller:"RVAccountsTransactionsPaymentCtrl",closeByDocument:!1,scope:e})})},e.$on("showValidationErrorPopup",function(t,a){e.status="error",e.popupMessage=a,m(function(){o.open({template:"/assets/partials/validateCheckin/rvShowValidation.html",controller:"",scope:e})},100)}),e.okButtonClicked=function(){B()};var B=function(){o.close()},M=e.$on("HANDLE_MODAL_OPENED",function(t){e.paymentModalOpened=!1,e.$emit("TOGGLE_PAYMET_POPUP_STATUS",!1)});e.$on("$destroy",M);var w=function(t){var a=N(),n=new SwipeOperation,o=n.createSWipedDataToRender(t);a.details.swipedDataToRenderInScreen=o,e.$broadcast("SHOW_SWIPED_DATA_ON_PAY_SCREEN",o)};e.$on("SWIPE_ACTION",function(t,a){if(e.paymentModalOpened){var n=new SwipeOperation,o=n.createDataToTokenize(a),r=function(t){e.$emit("hideLoader"),a.token=t,w(a)};e.invokeApi(u.tokenize,o,r)}});var L=function(e){var t="PAYMENT"!==e,a=d.getPermissionValue("SPLIT_CHARGES"),n=d.getPermissionValue("EDIT_CHARGES"),o=d.getPermissionValue("DELETE_CHARGES");return t&&(n||o)||a};e.hasPermissionToEditChargeCodeDescription=function(){return d.getPermissionValue("EDIT_CHARGECODE_DESCRIPTION")},e.hasPermissionToSplitCharges=function(){return d.getPermissionValue("SPLIT_CHARGES")},e.hasPermissionToEditCharges=function(){return d.getPermissionValue("EDIT_CHARGES")},e.hasPermissionToDeleteCharges=function(){return d.getPermissionValue("DELETE_CHARGES")},e.showEditChargeButton=function(e){return t.isStandAlone&&"TAX"!==e&&L()},e.splitTypeisAmount=!0,e.chargeCodeActive=!1,e.selectedChargeCode={},e.getAllchargeCodes=function(t){t(e.chargeCodeData)},e.setchargeCodeActive=function(t){e.chargeCodeActive=t},e.HIDE_LOADER_FROM_POPUP=function(){e.$emit("hideLoader")},e.openActionsPopup=function(t,a,n,r,i,s,c,u){e.errorMessage="",e.hideRemoveAndEdit="PAYMENT"===r,e.selectedTransaction={},e.selectedTransaction.id=t,e.selectedTransaction.desc=a,e.reference_text=s,e.show_ref_on_invoice=c,e.show_split_payment=u,n?e.selectedTransaction.amount=n:i&&(e.selectedTransaction.amount=i),o.open({template:"/assets/partials/bill/rvBillActionsPopup.html",className:"",scope:e})},e.callActionsPopupAction=function(t){o.close(),"custom_description"===t?e.openEditChargeDescPopup():"remove"===t?e.openRemoveChargePopup():"split"===t?e.openSplitChargePopup():"edit"===t&&e.openEditChargePopup()},e.openRemoveChargePopup=function(){o.open({template:"/assets/partials/bill/rvRemoveChargePopup.html",controller:"RVAccountTransactionsPopupCtrl",className:"",scope:e})},e.openEditChargeDescPopup=function(){o.open({template:"/assets/partials/bill/rvEditChargePopup.html",controller:"RVAccountTransactionsPopupCtrl",className:"",scope:e})},e.openSplitChargePopup=function(){o.open({template:"/assets/partials/bill/rvSplitChargePopup.html",controller:"RVAccountTransactionsPopupCtrl",className:"",scope:e})},e.openEditChargePopup=function(){e.selectedChargeCode={id:"",name:"",description:"",associcated_charge_groups:[]},o.open({template:"/assets/partials/bill/rvEditPostingPopup.html",className:"",controller:"RVAccountTransactionsPopupCtrl",scope:e}),e.setScroller("chargeCodesList")},e.sendEmail=function(t){if(e.shouldGenerateFinalInvoice&&!e.billFormat.isInformationalInvoice)G(t,!1);else{e.closeDialog();var n=function(t){t.is_invoice_issued?(e.statusMsg=a("translate")("EMAIL_SENT_SUCCESSFULLY"),e.status="success",e.shouldGenerateFinalInvoice&&!e.billFormat.isInformationalInvoice?e.$broadcast("UPDATE_WINDOW"):e.showEmailSentStatusPopup(),e.switchTabTo("TRANSACTIONS")):m(function(){F()},500)},o=function(t){e.statusMsg=a("translate")("EMAIL_SEND_FAILED"),e.status="alert",e.showEmailSentStatusPopup()};e.callAPI(r.emailInvoice,{successCallBack:n,failureCallBack:o,params:t})}};var G=function(t,a){var n=function(){e.shouldGenerateFinalInvoice=!1,O(),a?U(t):e.sendEmail(t)},o={params:{bill_id:e.transactionsDetails.bills[e.currentActiveBill].bill_id,bill_address_type:t.type},successCallBack:n};e.callAPI(l.settleFinalInvoice,o)},F=function(){o.open({template:"/assets/partials/popups/billFormat/rvInvoicePendingInfoPopup.html",className:"",scope:e})};e.clickedEmail=function(t){e.sendEmail(t)},e.clickedPrint=function(t){e.closeDialog(),h.start("PRINT_STARTED"),U(t)};var x=function(){e.invoiceActive=!1,e.printGroupProfomaActive=!1,$(".nav-bar").removeClass("no-print"),$(".cards-header").removeClass("no-print"),$(".card-tabs-nav").removeClass("no-print"),e.shouldGenerateFinalInvoice&&!e.billFormat.isInformationalInvoice?e.$broadcast("UPDATE_WINDOW"):e.closeDialog(),$("body #loading").html('<div id="loading-spinner" ></div>'),e.switchTabTo("TRANSACTIONS")},U=function(t){if(e.shouldGenerateFinalInvoice&&!e.billFormat.isInformationalInvoice)G(t,!0);else{var a=function(e){var t="";return e.is_copy_counter&&(t=parseInt(e.print_counter)-parseInt(e.no_of_original_invoices)),t},n=function(t){h.stop("PRINT_STARTED");var n=t.data,o="",r=700,i=moment(n.print_ar_invoice_number_activated_at,"YYYY-MM-DD"),s=moment(n.ar_transaction_date,"YYYY-MM-DD"),c=s.diff(i,"days"),u="";e.shouldShowArInvoiceNumber=!0,c<0&&(e.shouldShowArInvoiceNumber=!1),n.is_group&&n.is_proforma_invoice&&(e.invoiceActive=!1,e.printGroupProfomaActive=!0),e.billFormat.isInformationalInvoice?n.invoiceLabel=n.translation.information_invoice:null!==n.no_of_original_invoices||e.transactionsDetails.bills[e.currentActiveBill].is_void_bill?e.transactionsDetails.bills[e.currentActiveBill].is_void_bill?null===n.no_of_original_invoices||parseInt(n.print_counter,10)<=parseInt(n.no_of_original_invoices,10)?n.invoiceLabel=n.translation.void_invoice:parseInt(n.print_counter,10)>parseInt(n.no_of_original_invoices,10)&&(o=a(n),n.invoiceLabel=n.translation.copy_of_void_invoice.replace("#count",o)):parseInt(n.print_counter,10)<=parseInt(n.no_of_original_invoices,10)?n.invoiceLabel=n.posting_account_invoice_label||n.translation.invoice:parseInt(n.print_counter,10)>parseInt(n.no_of_original_invoices,10)&&(o=a(n),u=n.posting_account_invoice_copy_label||n.translation.copy_of_invoice,n.invoiceLabel=u.replace("#count",o)):n.invoiceLabel=n.posting_account_invoice_label||n.translation.invoice,n.is_invoice_issued?(e.invoiceActive=!0,e.printData=n,e.errorMessage="",$(".nav-bar").addClass("no-print"),$(".cards-header").addClass("no-print"),$(".card-tabs-nav").addClass("no-print"),$("body #loading").html(""),m(function(){sntapp.cordovaLoaded?cordova.exec(x,function(e){x()},"RVCardPlugin","printWebView",[]):m(function(){window.print(),x()},r)},100)):F()},o=function(t){e.$emit("hideLoader"),e.errorMessage=t};e.invokeApi(s.fetchAccountBillsForPrint,t,n,o)}},j=function(t){var a=function(){e.$emit("hideLoader"),O(),e.diretBillpaymentData={}};e.callAPI(s.submitPaymentOnBill,{successCallBack:a,params:e.diretBillpaymentData})},V=t.$on("arAccountCreated",function(){e.diretBillpaymentData.data_to_pass.is_new_ar_account=!0,j()}),J=e.$on("arAccountWillBeCreated",function(t,a){e.account_id=a.account_id,e.is_auto_assign_ar_numbers=a.is_auto_assign_ar_numbers,e.diretBillpaymentData=a.paymentDetails,o.open({template:"/assets/partials/payment/rvAccountReceivableMessagePopup.html",controller:"RVAccountReceivableMessagePopupCtrl",className:"",scope:e})});e.$on("$destroy",J),e.$on("$destroy",V);var H=function(t){e.chargeCodeData=t.results,e.availableChargeCodes=t.results},W=function(t){e.isFromGroups="undefined"!=typeof e.groupConfigData&&"TRANSACTIONS"===e.groupConfigData.activeTab};e.getInvoiceButtonClass=function(){var t="blue";return!e.transactionsDetails.bills[e.currentActiveBill].is_active&&e.transactionsDetails.bills[e.currentActiveBill].is_folio_number_exists&&e.roverObj.noReprintReEmailInvoice&&e.transactionsDetails.bills[e.currentActiveBill].is_printed_once&&e.transactionsDetails.bills[e.currentActiveBill].is_emailed_once&&(t="grey"),t},e.isInvoiceButtonDisabled=function(){var t=!1;return!e.transactionsDetails.bills[e.currentActiveBill].is_active&&e.transactionsDetails.bills[e.currentActiveBill].is_folio_number_exists&&e.roverObj.noReprintReEmailInvoice&&e.transactionsDetails.bills[e.currentActiveBill].is_printed_once&&e.transactionsDetails.bills[e.currentActiveBill].is_emailed_once&&(t=!0),t};var z=function(t){e.$emit("hideLoader")};e.hasPermissionToViewTransactionsTab=function(){return d.getPermissionValue("ACCESS_GROUP_ACCOUNT_TRANSACTIONS")};var Y=function(){if(!e.hasPermissionToViewTransactionsTab())return void(e.errorMessage=["Sorry, You dont have enough permission to proceed!!"]);var t=[];e.$emit("showLoader");var a={account_id:e.accountConfigData.summary.posting_account_id};t.push(s.fetchTransactionDetails(a).then(E)),t.push(l.fetchChargeCodes().then(H)),g.all(t).then(W,z)};e.changeBillingReferenceNumber=function(){e.isBillingReferenceNumberChanged=!0},e.$on("ACCOUNT_TAB_SWITCHED",function(t,a){"TRANSACTIONS"===a?Y():e.isBillingReferenceNumberChanged&&q()});var q=function(){if(d.getPermissionValue("EDIT_ACCOUNT")){var t=function(t){e.isBillingRefernceNumberChanged=!1,e.$broadcast("UPDATED_ACCOUNT_INFO"),e.$emit("hideloader")},a=function(t){e.$broadcast("FAILED_TO_UPDATE_ACCOUNT_INFO"),e.$emit("showErrorMessage",t),e.$emit("hideloader")};e.callAPI(r.updateBillingRefNumber,{successCallBack:t,failureCallBack:a,params:{summary:e.accountConfigData.summary,custom_reference_number:e.transactionsDetails.custom_reference_number}})}else e.$emit("showErrorMessage",["Sorry, Changes will not get saved as you don't have enough permission"])},K=e.$on("GROUP_TAB_SWITCHED",function(t,a){"TRANSACTIONS"===a?Y():e.isBillingReferenceNumberChanged&&q()});e.$on("$destroy",K);var Q=e.$on("UPDATE_INFORMATIONAL_INVOICE",function(t,a){e.billFormat.isInformationalInvoice=a});e.$on("$destroy",Q),e.showFormatBillPopup=function(t,a){e.billNo=t,e.isSettledBill=a,e.billFormat={},e.billFormat.isInformationalInvoice=!1,e.isFolioNumberExists=e.transactionsDetails.bills[e.currentActiveBill].is_folio_number_exists,e.reservationBillData=e.transactionsDetails,e.transactionsDetails.bills[e.currentActiveBill].is_transactions_exist&&0===parseInt(e.transactionsDetails.bills[e.currentActiveBill].balance_amount)&&e.transactionsDetails.is_bill_lock_enabled&&e.transactionsDetails.bills[e.currentActiveBill].is_active?(e.isInvoiceStepOneActive=!0,e.isInvoiceStepThreeActive=!1,e.shouldGenerateFinalInvoice=!0):(e.isInvoiceStepOneActive=!1,e.isInvoiceStepThreeActive=!0,e.shouldGenerateFinalInvoice=!1),e.isInvoiceStepTwoActive=!1,e.isInvoiceStepFourActive=!1,e.isInvoiceStepFiveActive=!1,o.open({template:"/assets/partials/popups/billFormat/rvBillFormatPopup.html",controller:"rvBillFormatPopupCtrl",className:"",scope:e})},e.showEmailSentStatusPopup=function(t){o.open({template:"/assets/partials/popups/rvEmailSentStatusPopup.html",className:"",scope:e})};var X=function(){var t=e.transactionsDetails.bills[e.currentActiveBill];t.activeDate&&t.days.length>0?(m(function(){t.pageOptions={id:t.bill_number,perPage:e.perPage,api:b}},100),b()):(e.$emit("hideLoader"),Z())},Z=function(){m(function(){e.refreshScroller("registration-content")},500)};e.clickedSummaryDate=function(t){var a=e.transactionsDetails.bills[e.currentActiveBill];a.activeDate=t,b(null,t)},e.expandGroupedCharge=function(t){var a=function(a){t.light_speed_data=a.data,t.isExpanded=!0,e.$emit("hideLoader"),Z()},n=function(t){e.errorMessage=t,e.emit("hideLoader")};if(t.isExpanded)t.isExpanded=!1,Z();else{var o={reference_number:t.reference_number,bill_id:e.transactionsDetails.bills[e.currentActiveBill].bill_id,date:t.date};e.invokeApi(s.groupChargeDetailsFetch,o,a,n)}},e.clickedRemoveBill=function(t){var a=function(){O(),e.currentActiveBill=t-1},n=function(t){e.errorMessage=t},o={params:{bill_id:e.transactionsDetails.bills[t].bill_id},successCallBack:a,failureCallBack:n};e.callAPI(l.hideBill,o)};var ee=function(){e.printReceiptActive=!1,$("header .logo").removeClass("logo-hide"),$("header .h2").removeClass("text-hide"),$("body #loading").html('<div id="loading-spinner" ></div>')};e.addListener("PRINT_RECEIPT",function(t,a){e.printReceiptActive=!0,e.receiptPrintData=a,e.errorMessage="",$(".nav-bar").addClass("no-print"),$(".cards-header").addClass("no-print"),$(".card-tabs-nav").addClass("no-print"),$("body #loading").html(""),m(function(){sntapp.cordovaLoaded?cordova.exec(ee,function(e){ee()},"RVCardPlugin","printWebView",[]):m(function(){window.print(),ee()},500)},100)}),e.openReceiptDialog=function(t){var a=e.transactionsDetails.bills[e.currentActiveBill].transactions[t];e.transactionId=a.id?a.id:null,e.billId=e.transactionsDetails.bills[e.currentActiveBill].bill_id,e.entityType="PostingAccount",o.open({template:"/assets/partials/popups/rvReceiptPopup.html",controller:"RVReceiptPopupController",className:"",scope:e})},e.clickedGotoDate=function(){var t=e.transactionsDetails.bills[e.currentActiveBill],a={minDate:t.days[0].date,maxDate:_.last(t.days).date,activeDate:t.activeDate};o.open({template:"/assets/partials/accounts/transactions/rvAccountDatePicker.html",controller:"rvAccountDatepickerCtrl",className:"single-date-picker",scope:e,data:a})},e.openAllowances=function(){e.$emit("showLoader"),v.fetchAssets(["rover.group.allowances","directives"]).then(function(){e.groupId=n.id,e.callAPI(s.fetchGroupAllowances,{params:{id:n.id,type:e.type},successCallBack:function(t){try{e.reservationBillData.groupedAllowances=t,o.open({template:"/assets/partials/groupAllowances/rvGroupAllowances.html",controller:"rvGroupAllowancesCtrl",className:"",scope:e})}catch(e){console.error(e)}},failureCallBack:function(t){e.groupedAllowanceData=!1}})}).then(function(){e.$emit("hideLoader")})},e.addListener("DATE_CHANGED",function(e,t){b(null,t)});var te=t.$on("CLICKED_VIEW_CHARGES",function(){e.shouldShowChargesForMobile=!0}),ae=t.$on("BACK_TO_CHARGES_LIST",function(){e.shouldShowChargesForMobile=!1});e.$on("$destroy",te),e.$on("$destroy",ae)}]),sntRover.controller("RVAccountTransactionsPopupCtrl",["$scope","$rootScope","$filter","rvAccountTransactionsSrv","ngDialog","$timeout",function(e,t,a,n,o,r){BaseCtrl.call(this,e),e.warningMessage="",e.adjustmentData={};var i=function(){r(function(){e.UPDATE_TRANSACTION_DATA&&e.UPDATE_TRANSACTION_DATA()},1)},s=function(){o.close(),r(function(){e.HIDE_LOADER_FROM_POPUP&&e.HIDE_LOADER_FROM_POPUP(),i()},1e3)};e.removeCharge=function(t){e.$emit("showLoader");var a={data:{reason:t,process:"delete"},id:e.selectedTransaction.id},o={params:a,loader:"NONE",successCallBack:s};e.callAPI(n.transactionDelete,o)},e.showSpiltValues=function(){var t=e.selectedTransaction;e.splitTypeisAmount?(e.displayFirstValue=t.amount-e.splitValue,e.displaySecondValue=e.splitValue):(e.displaySecondValue=parseFloat(t.amount*e.splitValue/100).toFixed(2),e.displayFirstValue=t.amount-e.displaySecondValue)},e.splitCharge=function(a,o){e.$emit("showLoader");var r=o?t.currencySymbol:"%",i={id:e.selectedTransaction.id,data:{split_type:r,split_value:a}},c={params:i,loader:"NONE",successCallBack:s};e.callAPI(n.transactionSplit,c)},e.selectedAdjReason=function(){e.warningMessage=""},e.clearWarningMessage=function(){e.warningMessage=""},e.editCharge=function(){if(!e.adjustmentData.adjustmentReason&&e.showAdjustmentReason)return void(e.warningMessage="Please fill adjustment reason");e.$emit("showLoader");var t={updatedDate:{new_amount:e.newAmount,charge_code_id:e.selectedChargeCode.id,adjustment_reason:e.adjustmentData.adjustmentReason,reference_text:e.reference_text,show_ref_on_invoice:e.show_ref_on_invoice},id:e.selectedTransaction.id},a={params:t,loader:"NONE",successCallBack:s};e.callAPI(n.transactionEdit,a)},e.editChargeDescription=function(t){var a={postData:{custom_charge_description:t},id:e.selectedTransaction.id},o={params:a,loader:"NONE",successCallBack:s};e.callAPI(n.transactionEditChargeDescription,o)},e.chargecodeData={},e.chargecodeData.chargeCodeSearchText="";var c={click:!0,preventDefault:!1};e.setScroller("chargeCodesList",c),e.selectChargeCode=function(t){for(var a=0;a<e.availableChargeCodes.length;a++)e.availableChargeCodes[a].id===t&&(e.selectedChargeCode=e.availableChargeCodes[a]);e.showChargeCodes=!1,e.chargecodeData.chargeCodeSearchText=""};var u=function(){if(e.chargecodeData.chargeCodeSearchText.length<3){for(var t=0;t<e.availableChargeCodes.length;t++)e.availableChargeCodes[t].is_row_visible=!0,e.availableChargeCodes[t].is_selected=!0;e.refreshScroller("chargeCodesList")}else{for(var a="",t=0;t<e.availableChargeCodes.length;t++)a=e.availableChargeCodes[t],e.escapeNull(a.name).toUpperCase().indexOf(e.chargecodeData.chargeCodeSearchText.toUpperCase())>=0||e.escapeNull(a.description).toUpperCase().indexOf(e.chargecodeData.chargeCodeSearchText.toUpperCase())>=0?e.availableChargeCodes[t].is_row_visible=!0:e.availableChargeCodes[t].is_row_visible=!1;e.refreshScroller("chargeCodesList")}};e.clearResults=function(){e.chargecodeData.chargeCodeSearchText=""},e.showAvailableChargeCodes=function(){e.clearResults(),u(),e.showChargeCodes=!e.showChargeCodes},e.chargeCodeEntered=function(){e.showChargeCodes=!1,u();var t=e.chargecodeData.chargeCodeSearchText;e.chargecodeData.chargeCodeSearchText=t.charAt(0).toUpperCase()+t.slice(1)},e.isShowChargeCodeList=function(){var t=!1,a=e.availableChargeCodes.length,n=e.chargecodeData.chargeCodeSearchText.length;if(e.showChargeCodes)t=!0;else if(n>2&&0!==a)for(var o=0;o<a;o++)if(e.availableChargeCodes[o].is_row_visible){t=!0;break}return t},e.getEditChargeButtonText=function(){return e.chargeCodeActive?"CHANGE_CHARGE_CODE":"CHANGE_AMOUNT"}}]),sntRover.controller("RVAccountsTransactionsPaymentCtrl",["$scope","$rootScope","RVPaymentSrv","ngDialog","$filter","$timeout","rvAccountTransactionsSrv","rvPermissionSrv","RVReservationCardSrv",function(e,t,a,n,o,r,i,s,c){BaseCtrl.call(this,e),BasePaymentCtrl.call(this,e);var u=!1,l={},d={},p=parseFloat("0.00"),m=function(){var t=function(t){e.ArDetails=t,t.company_present&&t.travel_agent_present?e.showArSelection=!0:t.company_present?t.company_ar_attached?y("company"):S(e.ArDetails.company_id):t.travel_agent_present?t.travel_agent_ar_attached?y("travel_agent"):S(e.ArDetails.travel_agent_id):(e.showErrorPopup(o("translate")("ACCOUNT_ID_NIL_MESSAGE_PAYMENT")),r(function(){n.close()},100))},a={account_id:e.accountConfigData.summary.posting_account_id};e.callAPI(i.checkForArAccount,{successCallBack:t,params:a})},f=function(t){e.$emit("hideLoader"),e.errorMessage=t,e.showArSelection=!1},g=function(){var n=function(t){e.renderData.paymentTypes=t,D()},o=function(t){e.errorMessage=t};if(e.callAPI(a.renderPaymentScreen,{successCallBack:n,failureCallBack:o,params:{direct_bill:!0}}),"tax_payment_receipt"===t.selectedReceiptTypeValue){var r={bill_holder_id:e.accountConfigData.summary.posting_account_id,bill_holder_type:"PostingAccount"};e.invokeApi(a.getReceiptsList,r,e.getReceiptsListSuccess)}},v=function(){return s.getPermissionValue("POST_PAYMENT")},h=function(){return s.getPermissionValue("POST_REFUND")},y=function(a){e.errorMessage="";var n=b(a);"sixpayments"!==t.paymentGateway||e.isManual||"CC"!==e.saveData.paymentType?e.callAPI(i.submitPaymentOnBill,{successCallBack:I,failureCallBack:f,params:n}):(n.data_to_pass.is_emv_request=!0,e.shouldShowWaiting=!0,i.submitPaymentOnBill(n).then(function(t){e.shouldShowWaiting=!1,I(t)},function(t){e.errorMessage=t,e.shouldShowWaiting=!1}))},D=function(){var t=e.billsArray[e.currentActiveBill].balance_amount?e.billsArray[e.currentActiveBill].balance_amount:p,a=e.billsArray[e.currentActiveBill].default_payment_amount?e.billsArray[e.currentActiveBill].default_payment_amount:p;e.renderData.defaultPaymentAmount=parseFloat(t).toFixed(2),e.renderData.defaultPaymentCurrencyAmount=a,e.defaultRefundAmount=-1*parseFloat(e.renderData.defaultPaymentAmount),e.renderData.defaultPaymentAmount<0?(e.defaultRefundAmount=-1*parseFloat(e.renderData.defaultPaymentAmount),e.shouldShowMakePaymentButton=!1):e.shouldShowMakePaymentButton=!0},C=function(){e.$$phase||e.$digest()},A=function(t){u=angular.copy(e.newPaymentInfo.tokenDetails.isSixPayment),l=angular.copy(e.newPaymentInfo.tokenDetails),d=angular.copy(e.newPaymentInfo.cardDetails);var a=u?t.tokenDetails.token_no:l.session,n=u?l.expiry.substring(2,4):d.expiryMonth,o=u?l.expiry.substring(0,2):d.expiryYear,r=n&&o?"20"+o+"-"+n+"-01":"",s=u?getSixCreditCardType(l.card_type).toLowerCase():d.cardType;e.callAPI(i.savePaymentDetails,{successCallBack:P,params:{bill_id:e.billsArray[e.renderData.billNumberSelected-1].bill_id,data_to_pass:{card_expiry:r,name_on_card:e.newPaymentInfo.cardDetails.userName,payment_type:"CC",token:a,card_code:s}}})},S=function(t,a){n.close();var o=b(a),r={account_id:t,is_auto_assign_ar_numbers:e.ArDetails.is_auto_assign_ar_numbers,paymentDetails:o};e.$emit("arAccountWillBeCreated",r)},b=function(t){var a={data_to_pass:{bill_number:e.renderData.billNumberSelected,payment_type:e.saveData.paymentType,amount:e.renderData.defaultPaymentAmount,payment_method_id:"CC"===e.saveData.paymentType?e.saveData.payment_type_id:null,reference_text:e.renderData.referanceText},bill_id:e.billsArray[e.renderData.billNumberSelected-1].bill_id};return"undefined"!=typeof t&&""!==t&&(a.data_to_pass.ar_type=t),e.isShowFees()&&(e.feeData.calculatedFee&&(a.data_to_pass.fees_amount=e.feeData.calculatedFee),e.feeData.feesInfo&&(a.data_to_pass.fees_charge_code_id=e.feeData.feesInfo.charge_code_id)),a},P=function(t){e.$emit("hideLoader");var a="",n="",o="",r=angular.copy(e.swipedCardDataToSave);isEmptyObject(r)?(a=retrieveCardtype(u,l,d),n=retrieveCardNumber(u,l,d),o=retrieveCardExpiryDate(u,l,d)):(a=r.cardType.toLowerCase(),n=r.cardNumber.slice(-4),o=r.cardExpiryMonth+"/"+r.cardExpiryYear,e.saveData.paymentType="CC"),e.defaultPaymentTypeCard=a,e.defaultPaymentTypeCardNumberEndingWith=n,e.defaultPaymentTypeCardExpiry=o,checkReferencetextAvailableForCC(),_.each(e.renderData.paymentTypes,function(t){"CC"===t.name&&_.each(t.values,function(t){a.toUpperCase()===t.cardcode&&(e.feeData.feesInfo=t.charge_code.fees_information,setupFeeData())})}),e.saveData.payment_type_id=t.id,e.showCCPage=!1,e.swippedCard=!1,e.showCreditCardInfo=!0,e.newCardAdded=!0,e.swipedCardDataToSave={}},I=function(t){e.$emit("hideLoader"),e.depositPaidSuccesFully=!0,e.authorizedCode=t.authorization_code,t.isFromPaymentSuccess=!0,e.$emit("UPDATE_TRANSACTION_DATA",t),e.showArSelection=!1};e.billPaymentReceiptData={},e.billPaymentReceiptData.allBillReceiptsList={},e.feeData={},e.renderData={},e.showArSelection=!1,e.swipedCardDataToSave={},e.saveData={},e.renderData={},e.errorMessage="",e.saveData.payment_type_id="",e.newPaymentInfo={},e.renderData.billNumberSelected="",e.renderData.defaultPaymentAmount="",e.renderData.defaultPaymentCurrencyAmount="",e.defaultRefundAmount=0,e.currentActiveBillNumber=parseInt(e.currentActiveBill)+parseInt(1),e.renderData.billNumberSelected=e.currentActiveBillNumber,e.renderData.billNumberSelected=e.currentActiveBillNumber,e.billsArray=e.transactionsDetails.bills,e.passData={},e.passData.details={},e.renderData.referanceText="",e.swipedCardDataToSave={},e.cardData={},e.newCardAdded=!1,e.shouldShowWaiting=!1,e.depositPaidSuccesFully=!1,e.saveData.paymentType="",e.defaultPaymentTypeOfBill="",e.shouldShowMakePaymentButton=!0,e.hasPermissionToMakePayment=v(),e.hasPermissionToRefundPayment=h(),e.billNumberChanged=function(){e.currentActiveBill=parseInt(e.renderData.billNumberSelected)-parseInt(1),e.billPaymentReceiptData.receiptsList=_.find(e.billPaymentReceiptData.allBillReceiptsList.payment_receipts,{bill_number:e.billsArray[e.currentActiveBill].bill_number.toString()}),D()},e.changeOnsiteCallIn=function(){e.showCCPage=!!e.isManual},e.closeDialog=function(){e.paymentModalOpened=!1,e.$emit("HANDLE_MODAL_OPENED"),n.close()},e.getReceiptsListSuccess=function(t){e.billPaymentReceiptData.allBillReceiptsList=t.data,e.billPaymentReceiptData.receiptsList=_.find(e.billPaymentReceiptData.allBillReceiptsList.payment_receipts,{bill_number:e.billsArray[e.currentActiveBill].bill_number.toString()})},e.hasPermissionToMakePayment=function(){return s.getPermissionValue("MAKE_PAYMENT")},e.showErrorPopup=function(t){e.$emit("showValidationErrorPopup",t)},e.submitPayment=function(){e.renderData.defaultPaymentAmount>0||e.renderData.defaultPaymentAmount<0?"DB"===e.saveData.paymentType?m():y():r(function(){e.errorMessage=["Please enter amount to pay"]},200)},e.selectArAccount=function(t){e.$broadcast("CONTINUE_DIRECT_BILL_PAYMENT",{ar_type:t,arDetails:e.ArDetails}),e.showArSelection=!1},e.$on("cancelCardSelection",function(t,a){e.showCCPage=!1,e.swippedCard=!1,e.isManual=!1,e.saveData.paymentType=""}),e.$on("changeOnsiteCallIn",function(t){e.isManual=!e.isManual,e.changeOnsiteCallIn()}),e.$on("CLOSE_DIALOG",e.closeDialog),e.$on("MLI_ERROR",function(t,a){e.errorMessage=a}),e.$on("PAYMENT_FAILED",function(e,t){f(t)}),e.$on("PAYMENT_SUCCESS",function(e,t){I(t)}),e.$on("PAYMENT_TYPE_CHANGED",function(t,a){e.showCCPage="CC"===a}),e.$on("SHOW_AR_SELECTION",function(t,a){e.ArDetails=a,e.showArSelection=!0}),e.$on("SHOW_SWIPED_DATA_ON_PAY_SCREEN",function(t,a){e.showCCPage=!0,e.swippedCard=!0,e.addmode=!0,e.$broadcast("RENDER_SWIPED_DATA",a)}),e.$on("SWIPED_DATA_TO_SAVE",function(t,a){e.swipedCardDataToSave=a;var n=a;n.payment_credit_type=a.cardType,n.credit_card=a.cardType,n.card_expiry="20"+a.cardExpiryYear+"-"+a.cardExpiryMonth+"-01",e.callAPI(i.savePaymentDetails,{successCallBack:P,params:{bill_id:e.billsArray[e.renderData.billNumberSelected-1].bill_id,data_to_pass:n}})}),e.$on("TOKEN_CREATED",function(t,a){e.newPaymentInfo=a,e.showCCPage=!1,e.swippedCard=!1,setTimeout(function(){A(a)},200),C()}),function(){g()}()}]);var BasePaymentCtrl=function(e){BaseCtrl.call(this,e);var t=function(){e.isFromAccounts=!0,e.shouldShowWaiting=!1,e.addmode=!0,e.savePayment={},e.isNewCardAdded=!1,e.isManual=!1,e.dataToSave={},e.showCCPage=!1,e.swippedCard=!1,e.cardsList=[],e.errorMessage=""};t(),e.changePaymentType=function(){return"sixpayments"===e.paymentGateway?void(e.isNewCardAdded="CC"===e.dataToSave.paymentType&&!e.isManual):(e.showCCPage="CC"===e.dataToSave.paymentType,e.swippedCard="CC"===e.dataToSave.paymentType,e.showCCPage="CC"===e.dataToSave.paymentType,e.addmode=!0,void 0)},e.changeOnsiteCallIn=function(){e.showCCPage=!!e.isManual,e.swippedCard=!!e.isManual,e.addmode=!0}};angular.module("sntRover").filter("makeRange",function(){return function(e){var t,a,n=1,o=0;switch(e.length){case 1:t=0,a=parseInt(e[0])-1;break;case 2:t=parseInt(e[0]),a=parseInt(e[1]);break;case 3:t=parseInt(e[0]),a=parseInt(e[1]),n=parseInt(e[2]);break;case 4:t=parseInt(e[0]),a=parseInt(e[1]),n=parseInt(e[2]),o=parseInt(e[3]);break;default:return e}for(var r=[],i="",s=t;s<=a;s+=n)i=getLengthChangedNumber(o,s),r.push(i);return r}}),sntRover.controller("RVDepositBalanceAccountsCtrl",["$scope","ngDialog","$rootScope","RVDepositBalanceSrv","RVPaymentSrv","$stateParams","$filter","$timeout","rvPermissionSrv","RVReservationCardSrv",function(e,t,a,n,o,r,i,s,c,u){BaseCtrl.call(this,e),e.pageloadingOver=!1,s(function(){e.pageloadingOver=!0},3500),e.shouldShowWaiting=!1,e.depositWithGiftCard=!1,e.depositPaidSuccesFully=!1,e.shouldShowExistingCards=!0,e.shouldShowAddNewCard=!0,e.authorizedCode="",e.showExistingAndAddNewPayments=!0,e.showOnlyAddCard=!1,e.cardsList=[],e.shouldShowMakePaymentButton=!0,e.shouldShowMakePaymentScreen=!0,e.showAddtoGuestCard=!0,e.shouldCardAvailable=!1,e.depositBalanceMakePaymentData={},e.depositBalanceMakePaymentData.amount=parseFloat(e.depositBalanceData.current_balance).toFixed(2),e.depositBalanceMakePaymentData.payment_amount=parseFloat(e.depositBalanceData.current_payment_balance).toFixed(2),e.refundAmount=0,e.depositBalanceMakePaymentData.amount<0&&(e.refundAmount=-1*parseFloat(e.depositBalanceMakePaymentData.amount),e.shouldShowMakePaymentButton=!1),e.depositBalanceMakePaymentData.add_to_guest_card=!1,e.makePaymentButtonDisabled=!0,e.isDisplayReference=!1,e.referanceText="",e.isAddToGuestCardVisible=!1,e.isSwipedCardSave=!1,e.isManual=!1,e.setScroller("cardsList",{click:!0,tap:!0}),e.setScroller("deopositdue");var l=function(){s(function(){e.refreshScroller("deopositdue")},1500)},l=function(){s(function(){e.refreshScroller("cardsList")},1500)},d=function(){setTimeout(function(){e.refreshScroller("payment-deposit-scroll")},500)};e.validPayment=!0,e.disableMakePayment=function(){return!!e.validPayment&&("undefined"==typeof e.depositBalanceMakePaymentData.payment_type||!(e.depositBalanceMakePaymentData.payment_type.length>0))},e.showingDepositModal=!1,e.giftCardAmountAvailable=!1,e.giftCardAvailableBalance=0,e.$on("giftCardAvailableBalance",function(t,a){e.giftCardAvailableBalance=a.amount}),e.timer=null,e.hasPermissionToMakePayment=function(){return c.getPermissionValue("MAKE_PAYMENT")},"sixpayments"===a.paymentGateway&&(e.shouldCardAvailable=!1,e.makePaymentButtonDisabled=!1),e.hideCreditCardFields=function(){e.addmode=!1,e.shouldShowExistingCards=!1,e.shouldCardAvailable=!1},e.changeOnsiteCallIn=function(){e.shouldShowMakePaymentScreen=!e.isManual,e.shouldShowExistingCards=e.cardsList.length>0,e.addmode=!(e.cardsList.length>0),e.shouldCardAvailable=!e.shouldShowMakePaymentScreen,l()},e.$on("changeOnsiteCallIn",function(t){e.isManual=!e.isManual,e.changeOnsiteCallIn()}),e.$on("TOKEN_CREATED",function(t,a){e.cardValues=a;var n="";if(e.cardValues.tokenDetails.isSixPayment){n=""!==e.cardValues.tokenDetails.expiry?"20"+e.cardValues.tokenDetails.expiry.substring(0,2)+"-"+e.cardValues.tokenDetails.expiry.substring(2,4)+"-01":"",e.shouldShowIframe=!1,e.shouldShowMakePaymentScreen=!0,e.showAddtoGuestCard=!1,e.shouldShowExistingCards=!1,e.addmode=!1,e.makePaymentButtonDisabled=!1,e.shouldCardAvailable=!0,e.depositBalanceMakePaymentData.card_code=getSixCreditCardType(e.cardValues.tokenDetails.card_type).toLowerCase(),e.depositBalanceMakePaymentData.ending_with=e.cardValues.tokenDetails.token_no.substr(e.cardValues.tokenDetails.token_no.length-4);var r={token:e.cardValues.tokenDetails.token_no,card_name:e.passData.details.firstName+" "+e.passData.details.lastName,card_expiry:n,payment_type:"CC"}}else{n=""!==e.cardValues.cardDetails.expiryMonth&&""!==e.cardValues.cardDetails.expiryYear?"20"+e.cardValues.cardDetails.expiryYear+"-"+e.cardValues.cardDetails.expiryMonth+"-01":"",e.depositBalanceMakePaymentData.card_code=getCreditCardType(e.cardValues.cardDetails.cardType).toLowerCase(),e.depositBalanceMakePaymentData.ending_with=e.cardValues.cardDetails.cardNumber.substr(e.cardValues.cardDetails.cardNumber.length-4);var r={token:e.cardValues.tokenDetails.session,card_name:e.cardValues.cardDetails.userName,card_expiry:n,payment_type:"CC"}}r.card_code=e.cardValues.tokenDetails.isSixPayment?getSixCreditCardType(e.cardValues.tokenDetails.card_type).toLowerCase():e.cardValues.cardDetails.cardType,e.depositBalanceMakePaymentData.card_expiry=e.cardValues.tokenDetails.isSixPayment?e.cardValues.tokenDetails.expiry.substring(2,4)+" / "+e.cardValues.tokenDetails.expiry.substring(0,2):e.cardValues.cardDetails.expiryMonth+" / "+e.cardValues.cardDetails.expiryYear,e.invokeApi(o.savePaymentDetails,r,e.successSavePayment)}),e.$on("MLI_ERROR",function(t,a){e.errorMessage=a}),e.feeData={};parseFloat("0.00");e.isShowFees=function(){var t=!1,n=e.feeData;return"undefined"==typeof n||"undefined"==typeof n.feesInfo||null===n.feesInfo?t=!1:n.defaultAmount>=n.minFees&&e.isStandAlone&&n.feesInfo.amount&&e.depositBalanceMakePaymentData.amount>=0&&(t=!("sixpayments"===a.paymentGateway&&!e.isManual&&"CC"===e.depositBalanceMakePaymentData.payment_type||""===e.depositBalanceMakePaymentData.payment_type)),t},e.emitCancelCardSelection=function(){if(a.isStandAlone||t.close(),e.depositWithGiftCard=!1,e.$emit("cancelCardSelection"),
e.cardselectedIndex=-1,$("#sixIframe").length){var n=document.getElementById("sixIframe");n.src=n.src}},e.clickedMakePayment=function(){var t={postData:{payment_type:e.depositBalanceMakePaymentData.payment_type,amount:e.depositBalanceMakePaymentData.amount,payment_method_id:e.paymentId},bill_id:e.depositBalanceData.primary_bill_id};e.isShowFees()&&(e.feeData.calculatedFee&&(t.postData.fees_amount=e.feeData.calculatedFee),e.feeData.feesInfo&&(t.postData.fees_charge_code_id=e.feeData.feesInfo.charge_code_id)),e.invokeApi(n.submitPaymentOnBill,t,e.successMakePayment)},e.giftCardAvailableBalance="",e.$on("giftCardAvailableBalance",function(t,a){e.giftCardAvailableBalance=a.amount,e.giftCardAmountAvailable=!0}),a.$on("validatedGiftCardPmt",function(t,a){a?e.validPayment=!0:e.validPayment=!1}),e.updatedAmountToPay=function(t){if("GIFT_CARD"===e.depositBalanceMakePaymentData.payment_type){var n=e.giftCardAvailableBalance;if(n){var o=parseFloat(n).toFixed(2),r=parseFloat(t).toFixed(2);o=parseFloat(o),r=parseFloat(r),o<r?e.validPayment=!1:e.validPayment=!0}}else e.validPayment=!0;a.$broadcast("validatedGiftCardPmt",e.validPayment)},e.successSavePayment=function(t){e.$emit("hideLoader"),e.shouldShowIframe=!1,e.shouldShowMakePaymentScreen=!0,e.showAddtoGuestCard=!1,e.shouldShowExistingCards=!1,e.addmode=!1,e.makePaymentButtonDisabled=!1,e.paymentId=t.id,e.shouldCardAvailable=!0},e.closeDepositModal=function(){e.$emit("UPDATE_DEPOSIT_BALANCE_FLAG",!1),e.$emit("TOGGLE_PAYMET_POPUP_STATUS",!1),e.closeDialog()},e.$on("CLOSE_DIALOG",e.closeDepositModal),e.successMakePayment=function(t){e.$emit("hideLoader"),"sixpayments"===a.paymentGateway&&e.isManual&&(e.authorizedCode=t.authorization_code),e.depositPaidSuccesFully=!0,e.$emit("BALANCE_AFTER_PAYMENT",t.current_balance)},e.setCreditCardFromList=function(t){e.shouldShowIframe=!1,e.shouldShowMakePaymentScreen=!0,e.showAddtoGuestCard=!1,e.shouldShowExistingCards=!1,e.addmode=!1,e.makePaymentButtonDisabled=!1,e.shouldCardAvailable=!0,e.paymentId=e.depositBalanceData.data.existing_payments[t].value,e.depositBalanceMakePaymentData.card_code=e.depositBalanceData.data.existing_payments[t].card_code,e.depositBalanceMakePaymentData.ending_with=e.depositBalanceData.data.existing_payments[t].ending_with,e.depositBalanceMakePaymentData.card_expiry=e.depositBalanceData.data.existing_payments[t].card_expiry,e.isStandAlone},e.$on("cardSelected",function(t,a){e.shouldCardAvailable=!0,e.setCreditCardFromList(a.index)}),e.showAddCardSection=function(){e.shouldShowIframe=!1,e.shouldShowMakePaymentScreen=!1,e.showAddtoGuestCard=!1,e.shouldShowExistingCards=!0,e.addmode=!1,e.makePaymentButtonDisabled=!1,l()},e.$on("cancelCardSelection",function(t,a){e.shouldShowMakePaymentScreen=!0,e.addmode=!1,e.depositBalanceMakePaymentData.payment_type="",e.isManual=!1}),e.$on("SHOW_SWIPED_DATA_ON_DEPOSIT_BALANCE_SCREEN",function(t,n){e.shouldShowMakePaymentScreen=!1,e.addmode=!0,a.$broadcast("RENDER_SWIPED_DATA",n),e.swipedCardHolderName=n.nameOnCard}),e.$on("SWIPED_DATA_TO_SAVE",function(t,a){e.depositBalanceMakePaymentData.card_code=a.cardType.toLowerCase(),e.depositBalanceMakePaymentData.ending_with=a.cardNumber.slice(-4),e.depositBalanceMakePaymentData.card_expiry=a.cardExpiryMonth+"/"+a.cardExpiryYear,e.depositBalanceMakePaymentData.payment_type="CC",e.isSwipedCardSave=!0;var n=a;n.payment_credit_type=a.cardType,n.credit_card=a.cardType,n.card_expiry="20"+a.cardExpiryYear+"-"+a.cardExpiryMonth+"-01",e.invokeApi(o.savePaymentDetails,n,e.successSavePayment)}),e.isBalanceAmountShown=function(){return!0},e.$on("PAYMENT_SUCCESS",function(t,a){e.successMakePayment(a),d()}),e.$on("PAYMENT_FAILED",function(t,a){e.errorMessage=a}),function(){e.setScroller("payment-deposit-scroll")}()}]),sntRover.controller("RVCardOptionsCtrl",["$rootScope","$scope","$state","ngDialog","$location","$document","RVPaymentSrv","RVReservationCardSrv",function(e,t,a,n,o,r,i,s){BaseCtrl.call(this,t),t.showAddtoGuestCard=!1,t.renderDataFromSwipe=function(a){t.cardData.cardNumber=a.cardNumber,t.cardData.userName=a.nameOnCard,t.cardData.expiryMonth=a.cardExpiryMonth,t.cardData.expiryYear=a.cardExpiryYear,t.cardData.cardType=a.cardType,"guestCard"===a.swipeFrom&&e.$broadcast("swipeAtGuestCard"),"guestCard"===a.swipeFrom?t.showAddtoGuestCard=!1:t.showAddtoGuestCard=!0,"guestCard"!==a.swipeFrom&&"stayCard"!==a.swipeFrom||setTimeout(function(){t.clickedAddNewCard()},100)},t.refreshIframe=function(){if($("#sixIframe").length){var e=document.getElementById("sixIframe");e.src=e.src}},t.$on("REFRESH_IFRAME",function(e){t.refreshIframe()}),e.$on("depositModalAllowGiftCard",function(){t.allowPmtWithGiftCard=!0}),t.checkForGiftCard=function(){t.isGiftCard=!1,e.isStandAlone||t.invokeApi(i.fetchAvailPayments,{},t.cardsListSuccess)},t.hideCardToggles=function(){return!!(t.isFromGuestCard||t.hasAccompanyguest||t.cardsList&&0===t.cardsList.length)},t.$on("isFromGuestCardFalse",function(){t.showAddtoGuestCard=!0,t.isFromGuestCard=!0}),t.$on("hidePayCardToggles",function(e,a){t.isFromGuestCard=!0,a&&a.isFromSwipe&&"guestCard"!==a.swipeFrom&&(t.isFromGuestCard=!1)}),t.$on("giftCardSelectedFromGroups",function(){t.clickedGiftCardToggle()}),t.$on("CLICK_ADD_NEW_CARD",function(){t.clickedAddNewCard()}),t.$on("SHOW_SWIPED_DATA_ON_PAY_SCREEN",function(){t.clickedAddNewCard(),t.$$phase?"":t.$apply()}),t.$on("SHOW_SWIPED_DATA_ON_BILLING_SCREEN",function(){t.clickedAddNewCard(),t.$$phase?"":t.$apply()}),t.$on("SHOW_SWIPED_DATA_ON_DEPOSIT_BALANCE_SCREEN",function(){t.clickedAddNewCard(),t.$$phase?"":t.$apply()}),t.clickedAddNewCard=function(){t.shouldShowIframe=!1,t.addmode=!0,t.isGiftCard=!1,t.useDepositGiftCard=!1,t.hideCancelCard=!1,t.depositWithGiftCard=!1},t.clickedExistingCard=function(){t.shouldShowIframe=!0,t.addmode=!1,t.isGiftCard=!1,t.useDepositGiftCard=!1,t.hideCancelCard=!1,t.depositWithGiftCard=!1},t.clickedGiftCardToggle=function(){t.shouldShowIframe=!0,t.useDepositGiftCard=!0,t.addmode=!1,t.isGiftCard=!0,t.depositWithGiftCard=!0},t.showExistingCards=function(){return!t.addmode&&!t.useDepositGiftCard},t.showGiftCardToggle=function(){return!(t.isStandAlone||!t.allowPmtWithGiftCard)},t.existingSelected=function(){return!t.addmode&&!t.isGiftCard},t.addNewSelected=function(){return!(!t.addmode||t.isGiftCard)},t.hideMLINewCard=function(){return!!("sixpayments"===t.paymentGateway&&t.addmode||t.isManual||t.isGiftCard||t.depositWithGiftCard||t.shouldShowIframe)},t.showAddToGuestCardBox=function(){return t.existingSelected()||t.isGiftCard?t.showAddtoGuestCard=!1:t.addNewSelected()&&(t.showAddtoGuestCard=!0),!!t.showAddtoGuestCard},t.showMLIAddNewCC=function(){return!!t.addNewSelected()||!(!t.isGiftCard||t.showingDepositModal||t.depositWithGiftCard||t.useDepositGiftCard)},e.$on("giftCardSelected",function(){t.shouldShowIframe=!1,e.isStandAlone&&$("#cc-new-card").addClass("ng-hide")}),e.$on("creditCardSelected",function(){e.isStandAlone||(t.shouldShowIframe=!0,$("#cc-new-card").removeClass("ng-hide")),e.isStandAlone&&($("#cc-new-card").removeClass("ng-hide"),t.clickedAddNewCard())}),t.hideIfFromStayCardDirect=function(){e.isStandAlone||(t.swippedCard?t.shouldShowIframe=!1:t.shouldShowIframe=!0)},e.$on("validatedGiftCardPmt",function(e,a){a?t.validPayment=!0:t.validPayment=!1}),t.showMakePaymentButtonStatus=function(){var e="";return e=t.depositBalanceMakePaymentData&&"undefined"!=typeof t.depositBalanceMakePaymentData.payment_type?t.depositBalanceMakePaymentData.payment_type.length>0&&t.validPayment?"green":"grey":t.validPayment?"grey":"grey overlay"},t.useDepositGiftCard=!1,t.cardsListSuccess=function(a){t.allowPmtWithGiftCard=!1,e.allowPmtWithGiftCard=!1,t.$emit("hideLoader");for(var n in a)"GIFT_CARD"===a[n].name&&(t.allowPmtWithGiftCard=!0,t.$parent.allowPmtWithGiftCard=!0,t.$parent.$parent.allowPmtWithGiftCard=!0,t.$parent.$parent.$parent.allowPmtWithGiftCard=!0,e.allowPmtWithGiftCard=!0,e.$broadcast("depositModalAllowGiftCard",!0));e.initFromCashDeposit?t.initFromCashDeposit=!0:t.initFromCashDeposit=!1},t.isGiftCard=!1,t.allowPmtWithGiftCard=!1,e.$on("depositUsingGiftCardChange",function(a,n){e.depositUsingGiftCard?(t.isGiftCard=!0,t.hideCancelCard=!0):(t.isGiftCard=!1,t.hideCancelCard=!1)}),t.refreshIframeWithGuestData=function(e){var t=(new Date).getTime(),a=e.fname,n=e.lname;iFrameUrl=domainUrl+"/api/ipage/index.html?card_holder_first_name="+a+"&card_holder_last_name="+n+"&service_action=createtoken&time="+t;var o=document.getElementById("sixIframe");try{o.src=iFrameUrl}catch(e){console.warn(e.name,e.message)}},t.$on("refreshIframe",function(e,a){t.refreshIframeWithGuestData(a)});var c=o.$$absUrl;domainUrl=c.split("/staff#/")[0],t.cardData={},t.cardData.addToGuestCard=!1,t.cardData.cardNumber="",t.cardData.CCV="",t.cardData.expiryMonth="",t.cardData.expiryYear="",t.cardData.userName="";var u=(new Date).getTime();if(t.shouldShowAddNewCard=!0,"undefined"!=typeof t.passData)var l="undefined"==typeof t.passData.details.firstName?"":t.passData.details.firstName,d="undefined"==typeof t.passData.details.lastName?"":t.passData.details.lastName;if(t.iFrameUrl=domainUrl+"/api/ipage/index.html?card_holder_first_name="+l+"&card_holder_last_name="+d+"&service_action=createtoken&time="+u,"sixpayments"===e.paymentGateway){t.shouldShowAddNewCard=!1;var p=r.find("sixIframe");p.attr("src",t.iFrameUrl),t.showAddtoGuestCard=!1}else t.isFromGuestCard||(t.showAddtoGuestCard=!0);"undefined"==typeof t.passData||isEmptyObject(t.passData.details.swipedDataToRenderInScreen)||t.renderDataFromSwipe(t.passData.details.swipedDataToRenderInScreen),t.shouldShowIframe=!1,t.changeOnsiteCallIn=function(){t.shouldShowIframe=!t.shouldShowIframe,t.isFromGuestCard||(t.shouldShowIframe?(t.showAddtoGuestCard=!0,t.refreshIframe()):t.showAddtoGuestCard=!1)};var m=function(){t.cardData.cardNumber="",t.cardData.CCV="",t.cardData.expiryMonth="",t.cardData.expiryYear=""};t.$on("clearCardDetails",function(){m()});var f=function(e){var a={};a.cardDetails=angular.copy(t.cardData),a.tokenDetails=e,t.$emit("TOKEN_CREATED",a),t.$digest(),t.refreshIframe()},_=function(e){t.$emit("MLI_ERROR",e)},g=function(){var e={};return e.cardNumber=t.cardData.cardNumber,e.cardSecurityCode=t.cardData.CCV,e.cardExpiryMonth=t.cardData.expiryMonth,e.cardExpiryYear=t.cardData.expiryYear,e};t.getToken=function(e){if(e.preventDefault(),isEmptyObject(t.passData.details.swipedDataToRenderInScreen)){var a=g(),n=function(e){e.isSixPayment=!1,f(e)},o=function(e){_(e)};t.fetchMLI(a,n,o)}else{var r=new SwipeOperation,i=r.createSWipedDataToSave(t.passData.details.swipedDataToRenderInScreen);i.addToGuestCard=t.cardData.addToGuestCard,i.card_name&&""!==i.card_name||(i.card_name=t.cardData.userName),t.$emit("SWIPED_DATA_TO_SAVE",i)}},t.$on("six_token_recived",function(e,a){a.six_payment_data.isSixPayment=!0,t.shouldShowAddNewCard=!1,f(a.six_payment_data)}),t.setCreditCardFromList=function(e){t.$emit("cardSelected",{index:e}),t.cardselectedIndex=e},t.setToShowCancelCard=function(){t.hideCancelCard=!1,t.depositWithGiftCard=!1},t.setToHideCancelCard=function(){t.hideCancelCard=!0},t.showCancelCardSelection=function(){return!t.hideCancelCard&&!t.depositWithGiftCard},t.isSixPayPayment=function(){return!!("sixpayments"===t.paymentGateway&&t.addmode||t.isManual)},t.cancelCardSelection=function(){e.isStandAlone?(t.$emit("cancelCardSelection"),t.cardselectedIndex=-1,t.refreshIframe()):n.close()},t.$on("cancelCardSelection",function(){t.depositWithGiftCard=!1,t.isGiftCard=!1,t.hideCancelCard=!1}),t.$on("showCancelCreditCardButton",function(){t.setToShowCancelCard()}),t.giftCardAmountAvailable=!1,t.giftCardAvailableBalance=0,t.$on("giftCardAvailableBalance",function(e,a){t.giftCardAvailableBalance=a.amount}),t.timer=null,t.cardNumberInput=function(a,n,o){if(o?(t.isGiftCard=!0,t.useDepositGiftCard=!0,e.useDepositGiftCard=!0):e.useDepositGiftCard=!1,t.isGiftCard||o){var r=a.length;t.num=a,r>=8&&r<=22?$("[name=card-number]").keydown(function(){clearTimeout(t.timer),t.timer=setTimeout(t.fetchGiftCardBalance,1500)}):t.giftCardAmountAvailable=!1}},t.num,t.fetchGiftCardBalance=function(){if(t.isGiftCard){var e=function(e){t.giftCardAvailableBalance=e.amount,t.giftCardAmountAvailable=!0,t.$emit("giftCardAvailableBalance",e),t.$emit("hideLoader")};t.invokeApi(s.checkGiftCardBalance,{card_number:t.num},e)}else t.giftCardAmountAvailable=!1},t.$on("addNewCardClicked",function(){t.clickedAddNewCard()}),t.$on("existingCardClicked",function(){t.clickedExistingCard()}),t.$on("RENDER_SWIPED_DATA",function(e,a){t.swippedCard=!0,t.renderDataFromSwipe(a),t.passData.details.swipedDataToRenderInScreen=a,setTimeout(function(){t.clickedAddNewCard()},100)})}]),sntRover.controller("rvBillFormatPopupCtrl",["$scope","$rootScope","$filter","RVBillCardSrv","RVContactInfoSrv","ngDialog","$timeout",function(e,t,a,n,o,r,i){var s=200,c=500;BaseCtrl.call(this,e),e.isCompanyCardInvoice=!0,e.disableCompanyCardInvoice=!1,e.disableCompanyGuestToggle=!1,e.hideCompanyCardInvoiceToggle=!0,e.billFormat.isInformationalInvoice=!e.shouldGenerateFinalInvoice&&e.isSettledBill&&e.reservationBillData.is_bill_lock_enabled,e.billFormat.isInformationalInvoiceDisabled=e.isSettledBill&&e.reservationBillData.is_bill_lock_enabled,e.disableToggleAccount=!1;var u=function(){var t={};return e.reservationBillData&&e.reservationBillData.reservation_id?(t.id=e.reservationBillData.reservation_id,t.is_type="Reservation"):(e.hideCompanyCardInvoiceToggle=!1,e.isFromInvoiceSearchScreen&&(null===e.clickedInvoiceData.associated_item.company_card&&null===e.clickedInvoiceData.associated_item.travel_agent_card?e.hideCompanyCardInvoiceToggle=!0:null===e.clickedInvoiceData.associated_item.company_card&&null!==e.clickedInvoiceData.associated_item.travel_agent_card?(e.isCompanyCardInvoice=!1,e.disableCompanyCardInvoice=!0):null!==e.clickedInvoiceData.associated_item.company_card&&null===e.clickedInvoiceData.associated_item.travel_agent_card&&(e.disableCompanyCardInvoice=!0)),e.groupConfigData?(t.id=e.groupConfigData.summary.group_id,t.is_group=!0,t.is_type="Account",l(e.groupConfigData.summary)):(t.id=e.accountConfigData?e.accountConfigData.summary.posting_account_id:e.clickedInvoiceData.associated_item.item_id,t.is_group=!1,t.is_type="Account",e.accountConfigData&&l(e.accountConfigData.summary))),t.bill_no=e.billNo,t};e.closeDialog=function(){t.modalOpened=!1,i(function(){r.close()},s)};var l=function(t){(d(t.company)||d(t.travel_agent))&&(d(t.company)&&d(t.travel_agent)?e.hideCompanyCardInvoiceToggle=!0:!d(t.company)&&d(t.travel_agent)?(e.isCompanyCardInvoice=!0,e.disableCompanyCardInvoice=!0):(e.isCompanyCardInvoice=!1,e.disableCompanyCardInvoice=!0))},d=function(e){return!e||0===e.length},p=function(t){e.$emit("hideLoader"),t.languages&&(t.languages=_.filter(t.languages,{is_show_on_guest_card:!0})),e.languageData=t,e.data.locale=t.selected_language_code},m=function(){var t={};e.reservationBillData&&e.reservationBillData.reservation_id&&(t.reservation_id=e.reservationBillData.reservation_id),e.invokeApi(o.fetchGuestLanguages,t,p)},f=function(){var t=u(),a=function(t){m(),t.data&&t.data.default_bill_settings&&(t.data.default_bill_settings=t.data.default_bill_settings.toString());var a=t.data&&t.data.bill_paid_account_type;"COMPANY"===a?(e.isCompanyCardInvoice=!0,e.disableToggleAccount=!0):"TRAVELAGENT"===a&&(e.isCompanyCardInvoice=!1,e.disableToggleAccount=!0),e.data=t.data,e.setEmailAddress()};e.invokeApi(n.getBillSettingsInfo,t,a)},g=function(){var t={};return e.reservationBillData&&e.reservationBillData.reservation_id?t.reservation_id=e.reservationBillData.reservation_id:(e.groupConfigData?(t.group_id=e.groupConfigData.summary.group_id,t.is_group=!0):(t.account_id=e.isFromInvoiceSearchScreen?e.clickedInvoiceData.associated_item.item_id:e.accountConfigData.summary.posting_account_id,t.is_group=!1),t.type=e.isCompanyCardInvoice?"COMPANY":"TRAVELAGENT"),t.bill_number=e.billNo,t.locale=e.data.locale,e.$emit("hideLoader"),t};e.printBill=function(){var t=g();e.$emit("UPDATE_INFORMATIONAL_INVOICE",e.billFormat.isInformationalInvoice),t.bill_layout=e.data.default_bill_settings,t.is_informational_invoice=e.billFormat.isInformationalInvoice,e.clickedPrint(t)},e.clickedContinueButtonPrintOrEmail=function(){e.isClickedPrint?e.printBill():e.sendEmail()},e.clickedPrintBill=function(){e.shouldGenerateFinalInvoice&&!e.billFormat.isInformationalInvoice?(e.isClickedPrint=!0,e.isInvoiceStepThreeActive=!1,i(function(){e.isInvoiceStepFourActive=!0},c)):e.printBill()},e.sendEmail=function(){var t=g();t.bill_layout=e.data.default_bill_settings,t.to_address=e.data.mailto_address,t.is_informational_invoice=e.billFormat.isInformationalInvoice,e.clickedEmail(t)},e.emailBill=function(){e.shouldGenerateFinalInvoice&&!e.billFormat.isInformationalInvoice?(e.isClickedPrint=!1,e.isInvoiceStepThreeActive=!1,i(function(){e.isInvoiceStepFourActive=!0},c)):e.sendEmail()},e.clickedFinalInvoiceButton=function(){e.isInvoiceStepOneActive=!1,i(function(){e.isInvoiceStepTwoActive=!0},c)},e.clickedProceedButton=function(){e.isInvoiceStepTwoActive=!1,e.isInvoiceStepFourActive=!1,i(function(){e.isInvoiceStepThreeActive=!0},c)},e.clickedCancelButtonProceedScreen=function(){e.isInvoiceStepTwoActive=!1,i(function(){e.isInvoiceStepOneActive=!0},c)};var v=e.$on("UPDATE_WINDOW",function(){e.isInvoiceStepFourActive=!1,i(function(){e.isInvoiceStepFiveActive=!0},c)});e.getPrintButtonClass=function(){var t="blue";return!e.billFormat.isInformationalInvoice&&parseInt(e.reservationBillData.bills[e.currentActiveBill].print_counter,10)>=parseInt(e.reservationBillData.no_of_original_invoices,10)&&e.roverObj.noReprintReEmailInvoice&&0!==parseInt(e.reservationBillData.no_of_original_invoices,10)&&(t="grey"),t},e.isPrintButtonDisabled=function(){var t=!1;return!e.billFormat.isInformationalInvoice&&parseInt(e.reservationBillData.bills[e.currentActiveBill].print_counter,10)>=parseInt(e.reservationBillData.no_of_original_invoices,10)&&e.roverObj.noReprintReEmailInvoice&&0!==parseInt(e.reservationBillData.no_of_original_invoices,10)&&(t=!0),t},e.getEmailButtonClass=function(){var t="blue";return e.data.mailto_address?!e.billFormat.isInformationalInvoice&&parseInt(e.reservationBillData.bills[e.currentActiveBill].email_counter,10)>=parseInt(e.reservationBillData.no_of_original_emails,10)&&e.roverObj.noReprintReEmailInvoice&&0!==parseInt(e.reservationBillData.no_of_original_invoices,10)&&(t="grey"):t="grey",t},e.isEmailButtonDisabled=function(){var t=!1;return e.data.mailto_address?!e.billFormat.isInformationalInvoice&&parseInt(e.reservationBillData.bills[e.currentActiveBill].email_counter,10)>=parseInt(e.reservationBillData.no_of_original_emails,10)&&e.roverObj.noReprintReEmailInvoice&&0!==parseInt(e.reservationBillData.no_of_original_invoices,10)&&(t=!0):t=!0,t},e.clickedInformationalButton=function(){e.billFormat.isInformationalInvoice=!0,e.isInvoiceStepOneActive=!1,i(function(){e.isInvoiceStepThreeActive=!0},c)},e.setEmailAddress=function(){e.isCompanyCardInvoice?e.data.mailto_address=e.data.company_address?e.data.company_address:e.data.to_address:e.data.mailto_address=e.data.travel_agent_address?e.data.travel_agent_address:e.data.to_address};var h=function(){e.data={},f()};e.changeCompanyCardInvoiceToggle=function(){e.isCompanyCardInvoice=!e.isCompanyCardInvoice,e.setEmailAddress()},e.$on("$destroy",v),h()}]),sntRover.controller("rvRouteDetailsCtrl",["$scope","$rootScope","$filter","RVBillinginfoSrv","RVCompanyCardSrv","rvPermissionSrv","RVGuestCardSrv","ngDialog","RVBillCardSrv","RVPaymentSrv",function(e,t,a,n,o,r,i,s,c,u){e.routeDetailsState={newCard:null},BaseCtrl.call(this,e),e.isAddPayment=!1,e.chargeCodeToAdd="",e.showPayment=!1,e.first_bill_id="",e.showChargeCodes=!1,e.isBillingGroup=!0,e.paymentDetails=null,e.swipedCardDataToSave={},e.showCreditCardDropDown=!1,e.isShownExistingCCPayment=!1,e.isCompanyTravelAgent=!1,e.billNumberOnAddCC="",null!==e.selectedEntity.credit_card_details&&void 0!==e.selectedEntity.credit_card_details&&e.selectedEntity.credit_card_details.hasOwnProperty("payment_type_description")&&(e.renderAddedPayment=e.selectedEntity.credit_card_details,e.renderAddedPayment.cardExpiry=e.selectedEntity.credit_card_details.card_expiry,e.renderAddedPayment.endingWith=e.selectedEntity.credit_card_details.card_number,e.renderAddedPayment.creditCardType=e.selectedEntity.credit_card_details.card_code,e.showPayment=!0,e.showCreditCardDropDown=!1,e.isShownExistingCCPayment=!0,setTimeout(function(){e.$broadcast("UPDATE_FLAG")},1e3)),e.passData={},e.passData.details={},"undefined"==typeof e.guestCardData||"undefined"==typeof e.guestCardData.contactInfo?(e.passData.details.firstName="",e.passData.details.lastName=""):(e.passData.details.firstName=e.guestCardData.contactInfo.first_name,e.passData.details.lastName=e.guestCardData.contactInfo.last_name),e.setScroller("cardsList");var l={preventDefault:!1};e.setScroller("paymentList",l),e.setScroller("billingGroups",l),e.setScroller("chargeCodes",l),e.setScroller("routeDetails",l);var d={click:!0};e.setScroller("chargeCodesList",d),e.chargeCodesListDivHgt=250,e.chargeCodesListDivTop=0,e.selectedEntity.credit_limit&&(e.selectedEntity.credit_limit=parseFloat(e.selectedEntity.credit_limit).toFixed(2));var p=function(){e.refreshScroller("paymentList"),e.refreshScroller("billingGroups"),e.refreshScroller("chargeCodes"),e.refreshScroller("chargeCodesList"),e.refreshScroller("routeDetails")};setTimeout(p,500),e.editPaymentMethod=function(){e.oldPayment=e.renderAddedPayment,e.renderAddedPayment=null,isAddPayment=!1},e.checkBillStatus=function(){return e.reservationBillData&&!e.reservationBillData.bills[0].is_active},e.showPaymentList=function(){e.isAddPayment=!1,e.refreshScroller("paymentList")},e.$on("CANCELLED_PAYMENT",function(){e.renderAddedPayment=e.oldPayment});var m=function(){var t=e.cardData.tokenDetails.isSixPayment?e.cardData.tokenDetails.expiry.substring(2,4)+" / "+e.cardData.tokenDetails.expiry.substring(0,2):e.cardData.cardDetails.expiryMonth+" / "+e.cardData.cardDetails.expiryYear;return t},f=function(){var t=e.cardData.tokenDetails.isSixPayment?e.cardData.tokenDetails.token_no.substr(e.cardData.tokenDetails.token_no.length-4):e.cardData.cardDetails.cardNumber.slice(-4);return t};e.paymentAdded=function(t){e.selectedEntity.selected_payment="",e.cardData=t,e.renderAddedPayment={},e.renderAddedPayment.payment_type="CC",e.isAddPayment=!1,e.showPayment=!0,e.renderAddedPayment.creditCardType=e.cardData.tokenDetails.isSixPayment?getSixCreditCardType(e.cardData.tokenDetails.card_type).toLowerCase():getCreditCardType(e.cardData.cardDetails.cardType).toLowerCase(),e.renderAddedPayment.cardExpiry=m(),e.renderAddedPayment.endingWith=f()},e.paymentAddedThroughMLISwipe=function(t){e.renderAddedPayment={},e.renderAddedPayment.payment_type="CC",e.swipedCardDataToSave=t,e.renderAddedPayment.creditCardType=t.cardType.toLowerCase(),e.renderAddedPayment.cardExpiry=t.cardExpiryMonth+"/"+t.cardExpiryYear,e.renderAddedPayment.endingWith=t.cardNumber.slice(-4)},e.onSaveNewCard=function(t){e.selectedEntity.selected_payment="",e.cardData=t.cardDetails,e.renderAddedPayment={},e.renderAddedPayment.payment_type="CC",e.isAddPayment=!1,e.showPayment=!0,e.renderAddedPayment.creditCardType=t.cardDetails.card_code,e.renderAddedPayment.cardExpiry=t.cardDetails.expiry_date,e.renderAddedPayment.endingWith=t.cardDetails.ending_with,e.routeDetailsState.newCard=t.cardDetails.expiry_date+t.cardDetails.ending_with+t.cardDetails.card_code},e.showAddPayment=function(){if(t.isManualCCEntryEnabled)e.billNumberOnAddCC=e.selectedEntity.is_new?e.newBillNumber:e.selectedEntity.bill_no,e.isAddPayment=!0,e.showCreditCardDropDown=!0,e.renderAddedPayment={},e.renderAddedPayment.creditCardType="",e.renderAddedPayment.cardExpiry="",e.renderAddedPayment.endingWith="",e.renderAddedPayment.payment_type="",e.isShownExistingCCPayment=!1,e.$broadcast("showaddpayment"),e.refreshScroller("routeDetails");else{e.isManualCCEntryEnabled=!1;s.open({template:"/assets/partials/payment/rvPaymentModal.html",controller:"",scope:e})}},e.$on("SHOW_SWIPED_DATA_ON_BILLING_SCREEN",function(t,a){e.isAddPayment=!0,e.$broadcast("showaddpayment"),setTimeout(function(){e.saveData.payment_type="CC",e.showCreditCardDropDown=!0,e.swippedCard=!0,e.$broadcast("RENDER_DATA_ON_BILLING_SCREEN",a),e.$digest()},2e3)}),e.$on("ngDialog.opened",function(t,a){e.ngDialogID=a[0].id}),e.closeDialog=function(){s.close(e.ngDialogID)},e.toggleChargeType=function(){e.isBillingGroup=!e.isBillingGroup,e.isBillingGroup?e.refreshScroller("billingGroups"):e.refreshScroller("chargeCodes"),e.showChargeCodes=!1},e.isBillingGroupSelected=function(t){for(var a=0;a<e.selectedEntity.attached_billing_groups.length;a++)if(e.selectedEntity.attached_billing_groups[a].id===t.id)return!0;return!1},e.toggleSelectionForBillingGroup=function(t){for(var a=0;a<e.selectedEntity.attached_billing_groups.length;a++)if(e.selectedEntity.attached_billing_groups[a].id===t.id)return void e.selectedEntity.attached_billing_groups.splice(a,1);e.selectedEntity.attached_billing_groups.push(t),e.refreshScroller("billingGroups")},e.removeChargeCode=function(t){for(var a=0;a<e.selectedEntity.attached_charge_codes.length;a++)if(e.selectedEntity.attached_charge_codes[a].id===t.id)return void e.selectedEntity.attached_charge_codes.splice(a,1)},e.showAvailableChargeCodes=function(){e.clearResults(),g(),e.showChargeCodes=!e.showChargeCodes},e.addChargeCode=function(){for(var t=0;t<e.availableChargeCodes.length;t++)if(e.availableChargeCodes[t].id===e.chargeCodeToAdd){for(var a=0;a<e.selectedEntity.attached_charge_codes.length;a++)if(e.selectedEntity.attached_charge_codes[a].id===e.chargeCodeToAdd)return;return e.selectedEntity.attached_charge_codes.push(e.availableChargeCodes[t]),void e.refreshScroller("chargeCodes")}},e.selectChargeCode=function(t){e.chargeCodeToAdd=t,e.addChargeCode(),e.chargeCodeSearchText="",e.showChargeCodes=!1},e.fetchAvailableChargeCodes=function(){var t=function(t){e.availableChargeCodes=t,e.fetchAvailableBillingGroups()},o=function(t){e.$parent.$emit("hideLoader"),e.$emit("displayErrorMessage",t)},r={};r.id=e.reservationData.reservation_id,e.reservationData.reservation_id!==e.selectedEntity.id&&"RESERVATION"===e.selectedEntity.entity_type?r.to_bill=e.first_bill_id:r.to_bill=e.selectedEntity.to_bill,r.is_new=e.selectedEntity.is_new,r.from_date=a("date")(tzIndependentDate(e.routeDates.from),"yyyy-MM-dd"),r.to_date=a("date")(tzIndependentDate(e.routeDates.to),"yyyy-MM-dd"),e.invokeApi(n.fetchAvailableChargeCodes,r,t,o)},e.showPaymentOption=function(){return!e.isAddPayment&&e.showPayment&&null==e.renderAddedPayment},e.fetchAvailableBillingGroups=function(){var t=function(t){e.availableBillingGroups=t,0===t.length&&(e.isBillingGroup=!1),"ALLOTMENT"===e.selectedEntity.entity_type||"GROUP"===e.selectedEntity.entity_type||"HOUSE"===e.selectedEntity.entity_type?(e.showPayment=!1,e.$parent.$emit("hideLoader")):"COMPANY_CARD"===e.selectedEntity.entity_type||"TRAVEL_AGENT"===e.selectedEntity.entity_type?(e.showPayment=!0,e.isCompanyTravelAgent=!0,e.accountId=e.selectedEntity.id,e.fetchAttachedPaymentTypes()):e.reservationData.reservation_id!==e.selectedEntity.id&&"RESERVATION"===e.selectedEntity.entity_type?e.$parent.$emit("hideLoader"):e.reservationData.reservation_id!==e.selectedEntity.id&&"RESERVATION"!==e.selectedEntity.entity_type?(e.showPayment=!0,e.attachedPaymentTypes=[],e.$parent.$emit("hideLoader")):e.selectedEntity.has_accompanying_guests?(e.showPayment=!0,e.$parent.$emit("hideLoader")):(e.showPayment=!0,e.fetchAttachedPaymentTypes())},o=function(t){e.$parent.$emit("hideLoader"),e.$emit("displayErrorMessage",t)},r={};r.id=e.reservationData.reservation_id,e.reservationData.reservation_id!==e.selectedEntity.id&&"RESERVATION"===e.selectedEntity.entity_type?r.to_bill=e.first_bill_id:r.to_bill=e.selectedEntity.to_bill,r.is_new=e.selectedEntity.is_new,r.from_date=a("date")(tzIndependentDate(e.routeDates.from),"yyyy-MM-dd"),r.to_date=a("date")(tzIndependentDate(e.routeDates.to),"yyyy-MM-dd"),e.invokeApi(n.fetchAvailableBillingGroups,r,t,o)},e.fetchAttachedPaymentTypes=function(){var t=function(t){e.$parent.$emit("hideLoader"),e.$emit("displayErrorMessage",t)};if(e.isCompanyTravelAgent){var a=function(t){e.attachedPaymentTypes=t.data,e.$parent.$emit("hideLoader"),p()};e.invokeApi(o.fetchAccountPaymentData,e.accountId,a,t)}else{var a=function(t){e.attachedPaymentTypes=t,e.$parent.$emit("hideLoader"),p()};e.invokeApi(i.fetchGuestPaymentData,e.reservationData.user_id,a,t)}},e.excludeExistingBills=function(t){for(var a=0;a<e.routes.length;a++)for(var n=0;n<t.length;n++)if(t[n].id===e.routes[a].to_bill&&e.selectedEntity.id!==e.routes[a].id){t.splice(n,1);break}return t},e.fetchBillsForReservation=function(){var t=function(t){e.bills=[],e.$parent.bills=[],e.first_bill_id="undefined"!=typeof t[0]?t[0].id:"";var a="undefined"!=typeof t[0]?t[0].id:"";if(e.newBillNumber=t.length+1,"undefined"!=typeof e.reservationData&&e.reservationData.reservation_id!==e.selectedEntity.id&&"RESERVATION"===e.selectedEntity.entity_type)e.bills.push(t[0]),e.bills=e.excludeExistingBills(e.bills),e.$parent.bills=e.bills;else{t.splice(0,1),e.bills=e.excludeExistingBills(t);var n={};n.id="new",n.is_active=!0,n.bill_number=""+e.newBillNumber+"(new)",e.bills.push(n),e.$parent.bills=e.bills}if(e.selectedEntity.to_bill=e.selectedEntity.is_new?e.bills[0].id:e.selectedEntity.to_bill,"GROUP_DEFAULT_BILLING"===e.billingEntity||"ALLOTMENT_DEFAULT_BILLING"===e.billingEntity)return void e.fetchAllChargeCodes();var o=e.selectedEntity.bill_no;"ALLOTMENT"===e.selectedEntity.entity_type||"GROUP"===e.selectedEntity.entity_type||"HOUSE"===e.selectedEntity.entity_type?e.selectedEntity.to_bill=a:""===o?e.selectedEntity.to_bill=_.last(e.bills).id:e.selectedEntity.to_bill=e.selectedEntity.to_bill,e.fetchAvailableChargeCodes()},a=function(t){e.$parent.$emit("hideLoader"),e.$emit("displayErrorMessage",t)},o="undefined"!=typeof e.reservationData?e.reservationData.reservation_id:"",r="";"ALLOTMENT"===e.selectedEntity.entity_type||"GROUP"===e.selectedEntity.entity_type||"HOUSE"===e.selectedEntity.entity_type?(o=e.selectedEntity.id,r=e.selectedEntity.entity_type):"RESERVATION"===e.selectedEntity.entity_type&&(o=e.selectedEntity.id);var i={id:o,entity_type:r};e.invokeApi(n.fetchBillsForReservation,i,t,a)},e.fetchDefaultAccountRouting=function(){var t=function(t){"ALLOTMENT_DEFAULT_BILLING"!==e.billingEntity&&(t.from_date&&(e.arrivalDate=t.from_date,e.departureDate=t.to_date),A()),e.selectedEntityChanged||void 0===t.charge_routes_recipient||("TRAVELAGENT"===t.type?t.type="TRAVEL_AGENT":"COMPANY"===t.type?t.type="COMPANY_CARD":t.posting_account_type?t.type=t.posting_account_type:(t.type=t.charge_routes_recipient.type,t.reservation_status=t.status,t.images&&(t.images[0].guest_image=t.images[0].image)),e.selectedEntity=_.extend(e.selectedEntity,t),e.selectedEntity.entity_type=t.type,e.attachedEntities=[e.selectedEntity]),e.selectedEntity.attached_billing_groups=t.billing_groups,e.selectedEntity.isBillingGroupsPresent=t.billing_groups.length>0,t.credit_limit&&(e.selectedEntity.credit_limit=parseFloat(t.credit_limit).toFixed(2)),e.selectedEntity.reference_number=t.reference_number,"undefined"==typeof e.selectedEntity.is_allow_direct_debit&&(e.selectedEntity.is_allow_direct_debit=t.is_allow_direct_debit),e.selectedEntity.attached_charge_codes=t.attached_charge_codes,e.selectedEntity.isChargeCodesPresent=t.attached_charge_codes.length>0,isEmptyObject(t.credit_card_details)||(e.renderAddedPayment=t.credit_card_details,e.saveData.payment_type=t.credit_card_details.payment_type,e.renderAddedPayment.cardExpiry=t.credit_card_details.card_expiry,e.renderAddedPayment.endingWith=t.credit_card_details.card_number,e.renderAddedPayment.creditCardType=t.credit_card_details.card_code,e.isAddPayment=!1,"CC"!==t.credit_card_details.payment_type?e.showCreditCardDropDown=!0:(e.showCreditCardDropDown=!1,e.isShownExistingCCPayment=!0)),e.selectedEntity.split_charge_by_guests=t.split_charge_by_guests,e.$parent.$emit("hideLoader");
},a={};a.id=e.selectedEntity.id,a.entity_type=e.selectedEntity.entity_type,"ALLOTMENT_DEFAULT_BILLING"===e.billingEntity&&(a.entity_type="ALLOTMENT"),e.invokeApi(n.fetchDefaultAccountRouting,a,t)},e.fetchAttachedPayments=function(){var t=function(t){e.attachedPaymentTypes=t.data,e.$parent.$emit("hideLoader")},a=function(t){e.$parent.$emit("hideLoader"),e.$emit("displayErrorMessage",t)};e.invokeApi(o.fetchCompanyPaymentData,e.contactInformation.id,t,a)},e.fetchAllBillingGroups=function(){var t=function(t){e.availableBillingGroups=t,0===t.length&&(e.isBillingGroup=!1),e.$parent.$emit("hideLoader"),e.fetchDefaultAccountRouting(),e.fetchAttachedPayments()},a=function(t){e.$parent.$emit("hideLoader"),e.$emit("displayErrorMessage",t)};e.invokeApi(n.fetchAllBillingGroups,"",t,a)},e.fetchAllChargeCodes=function(){var t=function(t){e.availableChargeCodes=t,e.fetchAllBillingGroups()},a=function(t){e.$parent.$emit("hideLoader"),e.$emit("displayErrorMessage",t)};e.invokeApi(n.fetchAllChargeCodes,"",t,a)},"TRAVEL_AGENT_DEFAULT_BILLING"!==e.billingEntity&&"COMPANY_CARD_DEFAULT_BILLING"!==e.billingEntity&&"GROUP_DEFAULT_BILLING"!==e.billingEntity&&"ALLOTMENT_DEFAULT_BILLING"!==e.billingEntity?e.fetchBillsForReservation():e.fetchAllChargeCodes(),"TRAVEL_AGENT_DEFAULT_BILLING"!==e.billingEntity&&"COMPANY_CARD_DEFAULT_BILLING"!==e.billingEntity&&"GROUP_DEFAULT_BILLING"!==e.billingEntity&&"ALLOTMENT_DEFAULT_BILLING"!==e.billingEntity||(e.showPayment=!0),e.chargeCodeEntered=function(){e.showChargeCodes=!1,g();var t=e.chargeCodeSearchText;e.chargeCodeSearchText=t.charAt(0).toUpperCase()+t.slice(1)},e.clearResults=function(){e.chargeCodeSearchText=""};var g=function(){if(e.chargeCodeSearchText.length<3){for(var t=0;t<e.availableChargeCodes.length;t++)e.isChargeCodeSelected(e.availableChargeCodes[t])?(e.availableChargeCodes[t].is_row_visible=!1,e.availableChargeCodes[t].is_selected=!1):(e.availableChargeCodes[t].is_row_visible=!0,e.availableChargeCodes[t].is_selected=!0);e.refreshScroller("chargeCodesList")}else{for(var a="",t=0;t<e.availableChargeCodes.length;t++)a=e.availableChargeCodes[t],(e.escapeNull(a.code).toUpperCase().indexOf(e.chargeCodeSearchText.toUpperCase())>=0||e.escapeNull(a.description).toUpperCase().indexOf(e.chargeCodeSearchText.toUpperCase())>=0)&&!e.isChargeCodeSelected(e.availableChargeCodes[t])?e.availableChargeCodes[t].is_row_visible=!0:e.availableChargeCodes[t].is_row_visible=!1;e.refreshScroller("chargeCodesList")}};e.escapeNull=function(e,t){return escapeNull(e,t)},e.isChargeCodeSelected=function(t){if(e.selectedEntity.attached_charge_codes)for(var a=0;a<e.selectedEntity.attached_charge_codes.length;a++)if(e.selectedEntity.attached_charge_codes[a].id===t.id)return!0;return!1};var v=e.$on("CALL_SAVE_ROUTE",function(t){t.preventDefault(),t.stopPropagation&&t.stopPropagation(),e.saveRoute()});e.$on("$destroy",v),e.updateCardInfo=function(){("COMPANY_CARD"!==e.selectedEntity.entity_type||"undefined"!=typeof e.reservationDetails.companyCard.id&&""!==e.reservationDetails.companyCard.id)&&("TRAVEL_AGENT"!==e.selectedEntity.entity_type||"undefined"!==e.reservationDetails.travelAgent.id&&""!==e.reservationDetails.travelAgent.id)||t.$broadcast("CardInfoUpdated",e.selectedEntity.id,e.selectedEntity.entity_type)},e.saveRoute=function(){return 0===e.selectedEntity.attached_charge_codes.length&&0===e.selectedEntity.attached_billing_groups.length?void e.$emit("displayErrorMessage",[a("translate")("ERROR_CHARGES_EMPTY")]):("TRAVEL_AGENT_DEFAULT_BILLING"!==e.billingEntity&&"COMPANY_CARD_DEFAULT_BILLING"!==e.billingEntity&&"GROUP_DEFAULT_BILLING"!==e.billingEntity&&"ALLOTMENT_DEFAULT_BILLING"!==e.billingEntity&&(e.selectedEntity.reservation_id=e.reservationData.reservation_id),"TRAVEL_AGENT_DEFAULT_BILLING"!==e.billingEntity&&"COMPANY_CARD_DEFAULT_BILLING"!==e.billingEntity&&"ALLOTMENT_DEFAULT_BILLING"!==e.billingEntity&&(e.selectedEntity.from_date=a("date")(tzIndependentDate(e.routeDates.from),"yyyy-MM-dd"),e.selectedEntity.to_date=a("date")(tzIndependentDate(e.routeDates.to),"yyyy-MM-dd")),void("new"===e.selectedEntity.to_bill?e.createNewBill():null===e.saveData.payment_type||""===e.saveData.payment_type||e.isShownExistingCCPayment||e.routeDetailsState.newCard?y():e.savePayment()))};var h=function(){s.open({template:"/assets/partials/bill/rvBillingInfoCreditLimitExceededPopup.html",className:"",closeByDocument:!1,scope:e})},y=function(){e.saveSuccessCallback=function(t){if(e.$parent.$emit("hideLoader"),e.reservationBillData&&t.bill_number&&(e.reservationBillData.bills[t.bill_number-1]={bill_id:t.id,bill_number:t.bill_number,total_amount:0,routed_entity_type:t.routed_entity_type,guest_image:t.guest_image}),null!==t.tax_exempt_warning&&t.tax_exempt_warning.length>0){var a=[];a.push(t.tax_exempt_warning),e.$emit("displayErrorMessage",a)}t.has_crossed_credit_limit?h():(e.$parent.$emit("BILLINGINFOADDED"),e.setReloadOption(!0),e.headerButtonClicked(),e.updateCardInfo(),e.$parent.$emit("REFRESH_BILLCARD_VIEW"))};var t=function(t){e.$parent.$emit("hideLoader"),e.$emit("displayErrorMessage",t)},a=function(){e.$parent.$emit("hideLoader"),e.$parent.$emit("BILLINGINFOADDED"),s.close()};if("TRAVEL_AGENT_DEFAULT_BILLING"===e.billingEntity||"COMPANY_CARD_DEFAULT_BILLING"===e.billingEntity||"GROUP_DEFAULT_BILLING"===e.billingEntity||"ALLOTMENT_DEFAULT_BILLING"===e.billingEntity){var o=angular.copy(e.selectedEntity);"GROUP_DEFAULT_BILLING"!==e.billingEntity||"GROUP"!==e.selectedEntity.entity_type&&"HOUSE"!==e.selectedEntity.entity_type||(o.entity_type=e.selectedEntity.entity_type),"ALLOTMENT_DEFAULT_BILLING"===e.billingEntity?(o.entity_type="ALLOTMENT",e.invokeApi(n.saveAllotmentDefaultAccountRouting,o,a,t)):(o.attached_payment_method_id=e.selectedEntity.selected_payment,e.invokeApi(n.saveDefaultAccountRouting,o,a,t))}else{var o=angular.copy(e.selectedEntity);e.invokeApi(n.saveRoute,o,e.saveSuccessCallback,t)}};e.hasPermissionToEditCreditLimit=function(){return r.getPermissionValue("OVERWRITE_DIRECT_BILL_MAXIMUM_AMOUNT")},e.createNewBill=function(){if("ALLOTMENT"===e.selectedEntity.entity_type||"GROUP"===e.selectedEntity.entity_type||"HOUSE"===e.selectedEntity.entity_type)var t={entity_type:e.selectedEntity.entity_type,entity_id:e.selectedEntity.id};else var t={reservation_id:e.reservationData.reservation_id};var a=function(t){e.$emit("hideLoader"),e.reservationBillData&&(e.reservationBillData.bills[t.bill_number-1]={bill_id:t.id,bill_number:t.bill_number,total_amount:0}),e.selectedEntity.to_bill=t.id,e.bills[e.bills.length-1].id=t.id,e.bills[e.bills.length-1].bill_number=t.bill_number,null!==e.saveData.payment_type&&""!==e.saveData.payment_type?e.savePayment():y()};e.invokeApi(c.createAnotherBill,t,a,e.errorCallback)};var D=function(){var t=e.cardData.tokenDetails.isSixPayment?e.passData.details.firstName+" "+e.passData.details.lastName:e.cardData.cardDetails.userName;return t},C=function(){var t=e.cardData.tokenDetails.isSixPayment?e.cardData.tokenDetails.expiry.substring(2,4):e.cardData.cardDetails.expiryMonth,a=e.cardData.tokenDetails.isSixPayment?e.cardData.tokenDetails.expiry.substring(0,2):e.cardData.cardDetails.expiryYear,n=t&&a?"20"+a+"-"+t+"-01":"";return n};e.savePayment=function(){e.saveSuccessCallback=function(t){e.$parent.$emit("hideLoader"),e.$parent.$emit("BILLINGINFOADDED")},e.errorCallback=function(t){e.$parent.$emit("hideLoader"),e.$emit("displayErrorMessage",t)},void 0!==e.reservationData&&null!==e.reservationData.reservation_id?e.savePaymentToReservationOrAccount("reservation"):"TRAVEL_AGENT_DEFAULT_BILLING"===e.billingEntity||"COMPANY_CARD_DEFAULT_BILLING"===e.billingEntity?e.savePaymentToReservationOrAccount("companyOrTA"):"GROUP_DEFAULT_BILLING"===e.billingEntity?e.savePaymentToReservationOrAccount("account"):"ALLOTMENT_DEFAULT_BILLING"===e.billingEntity?e.savePaymentToReservationOrAccount("allotment"):y()},e.savePaymentToReservationOrAccount=function(a){e.saveSuccessCallback=function(t){e.$parent.$emit("hideLoader"),t.has_crossed_credit_limit?h():(e.setReloadOption(!0),e.headerButtonClicked(),e.$parent.$emit("BILLINGINFOADDED"),e.$parent.$emit("REFRESH_BILLCARD_VIEW")),e.reservationBillData&&t.bill_number&&(e.reservationBillData.bills[t.bill_number-1]={bill_id:t.id,bill_number:t.bill_number,total_amount:0,routed_entity_type:t.routed_entity_type,guest_image:t.guest_image})},e.errorCallback=function(t){e.$parent.$emit("hideLoader"),e.$emit("displayErrorMessage",t)};var o=function(){e.$parent.$emit("hideLoader"),e.$parent.$emit("BILLINGINFOADDED"),s.close()},r=function(t){if(e.$parent.$emit("hideLoader"),"TRAVEL_AGENT_DEFAULT_BILLING"===e.billingEntity||"COMPANY_CARD_DEFAULT_BILLING"===e.billingEntity||"GROUP_DEFAULT_BILLING"===e.billingEntity||"ALLOTMENT_DEFAULT_BILLING"===e.billingEntity){var a=angular.copy(e.selectedEntity);"ALLOTMENT_DEFAULT_BILLING"===e.billingEntity?(a.entity_type="ALLOTMENT",e.invokeApi(n.saveAllotmentDefaultAccountRouting,a,o,e.errorCallback)):e.invokeApi(n.saveDefaultAccountRouting,a,o,e.errorCallback)}else e.invokeApi(n.saveRoute,e.selectedEntity,e.saveSuccessCallback,e.errorCallback)},i=function(t){e.$parent.$emit("hideLoader"),e.$emit("displayErrorMessage",t)},c=function(t){var n={token:t.token,is_swiped:!0};"reservation"===a?n.reservation_id=e.reservationData.reservation_id:"companyOrTA"===a?n.account_id=e.selectedEntity.id:"allotment"===a?n.allotment_id=e.selectedEntity.allotment_id:n.group_id=e.selectedEntity.id,e.invokeApi(u.savePaymentDetails,n,r,i)};if("CC"===e.saveData.payment_type)if("sixpayments"!==t.paymentGateway||e.sixIsManual)if(isEmptyObject(e.swipedCardDataToSave)){var l={add_to_guest_card:!1};"reservation"===a?l.reservation_id=e.reservationData.reservation_id:"companyOrTA"===a?l.account_id=e.selectedEntity.id:"allotment"===a?l.allotment_id=e.selectedEntity.allotment_id:l.group_id=e.selectedEntity.id,l.payment_type=e.saveData.payment_type,creditCardType=e.cardData.tokenDetails.isSixPayment?getSixCreditCardType(e.cardData.tokenDetails.card_type).toLowerCase():getCreditCardType(e.cardData.cardDetails.cardType),l.token=e.cardData.tokenDetails.isSixPayment?e.cardData.tokenDetails.token_no:e.cardData.tokenDetails.session,l.card_name=D(),l.bill_number=e.getSelectedBillNumber(),l.card_expiry=C(),l.card_code=e.cardData.tokenDetails.isSixPayment?getSixCreditCardType(e.cardData.tokenDetails.card_type).toLowerCase():e.cardData.cardDetails.cardType,e.invokeApi(u.savePaymentDetails,l,r,i)}else{var l=e.swipedCardDataToSave;"reservation"===a?l.reservation_id=e.reservationData.reservation_id:"companyOrTA"===a?l.account_id=e.selectedEntity.id:"allotment"===a?l.allotment_id=e.selectedEntity.allotment_id:l.group_id=e.selectedEntity.id,l.bill_number=e.getSelectedBillNumber(),l.payment_credit_type=e.swipedCardDataToSave.cardType,l.credit_card=e.swipedCardDataToSave.cardType,l.card_expiry="20"+e.swipedCardDataToSave.cardExpiryYear+"-"+e.swipedCardDataToSave.cardExpiryMonth+"-01",e.invokeApi(u.savePaymentDetails,l,r,i)}else{var l={};"reservation"===a?l.reservation_id=e.reservationData.reservation_id:"companyOrTA"===a?l.account_id=e.selectedEntity.id:"allotment"===a?l.allotment_id=e.selectedEntity.allotment_id:l.group_id=e.selectedEntity.id,l.add_to_guest_card=!1,l.bill_number=e.getSelectedBillNumber(),e.$emit("UPDATE_SHOULD_SHOW_WAITING",!0),u.chipAndPinGetToken(l).then(function(t){e.$emit("UPDATE_SHOULD_SHOW_WAITING",!1),c(t)},function(t){e.errorMessage=t,e.$emit("UPDATE_SHOULD_SHOW_WAITING",!1)})}else{var l={payment_type:e.saveData.payment_type};"reservation"===a?l.reservation_id=e.reservationData.reservation_id:"companyOrTA"===a?l.account_id=e.selectedEntity.id:"allotment"===a?l.allotment_id=e.selectedEntity.allotment_id:l.group_id=e.selectedEntity.id,l.bill_number=e.getSelectedBillNumber(),e.invokeApi(u.savePaymentDetails,l,r,i)}},e.getSelectedBillNumber=function(){for(var t=0;t<e.bills.length;t++)if(parseInt(e.bills[t].id)===parseInt(e.selectedEntity.to_bill))return e.bills[t].bill_number},e.shouldHideSplitCharge=function(){return e.isHourlyRateOn||"GROUP_DEFAULT_BILLING"===e.billingEntity||"GROUP"===e.selectedEntity.entity_type||"TRAVEL_AGENT_DEFAULT_BILLING"===e.billingEntity||"COMPANY_CARD_DEFAULT_BILLING"===e.billingEntity||"ALLOTMENT_DEFAULT_BILLING"===e.billingEntity},e.sixIsManual=!1,e.$on("CHANGE_IS_MANUAL",function(t,a){e.sixIsManual=a});var A=function(){"GROUP_DEFAULT_BILLING"==e.billingEntity&&(e.routeDates={from:e.arrivalDate,to:e.departureDate},e.routingDateFromOptions={dateFormat:t.jqDateFormat,minDate:tzIndependentDate(e.groupConfigData.summary.block_from),maxDate:tzIndependentDate(e.groupConfigData.summary.block_to)},e.routingDateToOptions={dateFormat:t.jqDateFormat,minDate:tzIndependentDate(e.groupConfigData.summary.block_from),maxDate:tzIndependentDate(e.groupConfigData.summary.block_to)})};e.onRouteDateChange=function(){e.fetchAvailableChargeCodes()},e.$on("PAYMENT_SAVE_CARD_SUCCESS",function(){p(),e.selectedPayment=""}),e.$on("PAYMENT_TYPE_CHANGED",function(){setTimeout(p,300)}),e.shouldShowSplitChargeAccompanyGuests=function(){return"GROUP_DEFAULT_BILLING"===e.billingEntity}}]),sntRover.controller("RVReservationPackageController",["$scope","$rootScope","$state","$timeout","$filter","ngDialog","RVReservationStateService",function(e,t,a,n,o,r,i){e.showRightContentForMobile=!1;var s=!1;e.setScroller("resultDetails",{click:!0}),setTimeout(function(){e.refreshScroller("resultDetails")},2e3),e.closeAddOnPopup=function(){t.modalOpened=!1,e.$emit("CLOSE_ADDON_POPUP",{addonPostingMode:e.addonPopUpData.addonPostingMode}),n(function(){s&&a.reload(a.current.name),r.close(),e.showRightContentForMobile=!1},300)},e.shouldHideCount=function(t){var a=t.post_type.value.toUpperCase();return!("WEEKDAY"!==a&&"WEEKEND"!==a&&"CUSTOM"!==a||"undefined"!=typeof t.post_instances||!e.showCustomPosting()||"reservation"!==e.addonPopUpData.addonPostingMode)};var c=function(e,t,a,n){return"PERSON"===e?(t+a)*n:"ADULT"===e?t*n:"CHILD"===e?a*n:"FLAT"===e||"ROOM"===e?n:void 0},u=function(e,t,a){for(var n=moment(e,"DD-MM-YYYY"),o=moment(t,"DD-MM-YYYY"),r=o.diff(n,a),i=[],s=0;s<r;s++){var c,u=moment(e,"DD-MM-YYYY").add(s,a),l=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];c=l[u.day()],i.push(c)}return i};e.getAddonCount=function(t){var a=t.post_type.frequency,n=t.post_type.value.toUpperCase(),o=t.amount_type.value.toUpperCase(),r=e.addonPopUpData.number_of_adults,s=e.addonPopUpData.number_of_children,l=e.addonPopUpData.duration_of_stay,d=0,p=t.charge_full_weeks_only,m=e.addonPopUpData.addonPostingMode,f=e.selectedPurchesedAddon.startDateObj?e.selectedPurchesedAddon.startDateObj:tzIndependentDate(t.start_date),g=e.selectedPurchesedAddon.endDateObj?e.selectedPurchesedAddon.endDateObj:tzIndependentDate(t.end_date);if(e.showCustomPosting()&&"undefined"!=typeof t.post_instances)l=_.filter(t.post_instances,{active:!0}).length,d=c(o,r,s,l);else{if(e.showCustomPosting()&&"undefined"!=typeof t.custom_nightly_selected_post_days&&("reservation"===m||"staycard"===m)){var v=u(f,g,"days"),h=0;angular.forEach(v,function(e){t.custom_nightly_selected_post_days.includes(e)&&h++}),l=h}a||("WEEK"===n||"EVERY WEEK"===n||"WEEKLY"===n||"WEEKDAY"===n||"WEEKEND"===n?a=7:"STAY"===n||"NIGHTLY"===n?a=1:"NIGHT"!==n&&"First Night"!==n&&"LAST_NIGHT"!==n&&"CUSTOM"!==n&&"POST ON LAST NIGHT"!==n||(a=0)),d=i.getApplicableAddonsCount(o,n,a,r,s,l,p,m)}return d*t.addon_count},e.getAddonTotal=function(t){return e.shouldHideCount(t)?t.amount:e.getAddonCount(t)*t.amount},e.selectedPurchesedAddon="",e.selectedDaysFromAdmin=[],e.selectPurchasedAddon=function(a){if(e.errorMessage=[],e.previousPostDays={},e.daysOfWeek=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],t.featureToggles.addons_custom_posting)if(a.is_rate_addon||a.is_allowance)e.errorMessage=["Custom posting cannot be configured for "+(a.is_allowance?"allowance":"rate")+" addons"],e.selectedPurchesedAddon="";else if("STAY"===a.post_type.value){var r=e.addonPopUpData.addonPostingMode;e.selectedPurchesedAddon=a,"staycard"===r?e.addonPostingDate={startDate:tzIndependentDate(e.reservationData.reservation_card.arrival_date),endDate:tzIndependentDate(e.reservationData.reservation_card.departure_date)}:"reservation"===r?e.addonPostingDate={startDate:tzIndependentDate(e.reservationData.arrivalDate),endDate:tzIndependentDate(e.reservationData.departureDate)}:"allotments"===r||"create_allotment"===r?e.addonPostingDate={startDate:tzIndependentDate(e.allotmentConfigData.summary.block_from),endDate:tzIndependentDate(e.allotmentConfigData.summary.block_to)}:e.addonPostingDate={startDate:tzIndependentDate(e.groupConfigData.summary.block_from),endDate:tzIndependentDate(e.groupConfigData.summary.block_to)},e.selectedPurchesedAddon.start_date=e.addonPostingDate.startDate,e.selectedPurchesedAddon.end_date=e.addonPostingDate.endDate,e.selectedDaysFromAdmin=e.selectedPurchesedAddon.custom_nightly_selected_post_days,"undefined"==typeof e.selectedPurchesedAddon.adminConfiguredDays&&(e.selectedPurchesedAddon.adminConfiguredDays={},e.toggleAdminConfigDaysSelectionForAddon(!0)),"undefined"==typeof e.selectedPurchesedAddon.selected_post_days&&(e.selectedPurchesedAddon.selected_post_days={},e.togglePostDaysSelectionForAddon(!0)),e.selectedPurchesedAddon.startDateObj=tzIndependentDate(e.selectedPurchesedAddon.start_date),e.selectedPurchesedAddon.endDateObj=tzIndependentDate(e.selectedPurchesedAddon.end_date),m();var i=o("date")(e.selectedPurchesedAddon.start_date,t.dateFormat),s=o("date")(e.selectedPurchesedAddon.end_date,t.dateFormat);e.selectedPurchesedAddon.start_date=i,e.selectedPurchesedAddon.end_date=s,e.selectedPurchesedAddon.nameCharLimit=e.selectedPurchesedAddon.name.length>23?20:23,angular.forEach(e.selectedPurchesedAddon.post_instances,function(t){var a,n=moment(t.post_date),o=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];a=o[n.day()],e.selectedDaysFromAdmin.includes(a)?(e.selectedPurchesedAddon.selected_post_days[a]=t.active,e.selectedPurchesedAddon.adminConfiguredDays[a]=!0):(e.selectedPurchesedAddon.selected_post_days[a]=!1,e.selectedPurchesedAddon.adminConfiguredDays[a]=!1)}),angular.copy(e.selectedPurchesedAddon.selected_post_days,e.previousPostDays),n(function(){e.showRightContentForMobile=!0},10)}else e.selectedPurchesedAddon=a,n(function(){e.showRightContentForMobile=!0},10)};var l=function(e){var t=e%10,a=e%100;return 1===t&&11!==a?e+"st":2===t&&12!==a?e+"nd":3===t&&13!==a?e+"rd":e+"th"};e.getCustomPostingInfo=function(){var t="";return t="undefined"==typeof e.selectedPurchesedAddon.frequency_type||"undefined"==typeof e.selectedPurchesedAddon.frequency?"Posts daily":"days"===e.selectedPurchesedAddon.frequency_type?1===e.selectedPurchesedAddon.frequency?"Posts daily":"Posts on every "+e.selectedPurchesedAddon.frequency+" days.":"weeks"===e.selectedPurchesedAddon.frequency_type?1===e.selectedPurchesedAddon.frequency?"Posts weekly, on "+e.selectedPurchesedAddon.post_day_of_the_week:"Posts every "+e.selectedPurchesedAddon.frequency+" weeks, on "+e.selectedPurchesedAddon.post_day_of_the_week:"months"===e.selectedPurchesedAddon.frequency_type?1===e.selectedPurchesedAddon.frequency?"Posts every month, on "+l(e.selectedPurchesedAddon.post_day_of_the_month):"Posts every "+e.selectedPurchesedAddon.frequency+" months, on "+l(e.selectedPurchesedAddon.post_day_of_the_month):"Posts daily"},e.showCustomPosting=function(){return t.featureToggles.addons_custom_posting},e.shouldShowSelectAllDaysOfWeek=function(){var t=!1;return e.selectedPurchesedAddon&&angular.forEach(e.daysOfWeek,function(a){e.selectedDaysFromAdmin.includes(a)&&e.selectedPurchesedAddon.selected_post_days&&(e.selectedPurchesedAddon.selected_post_days[a]||(t=!0))}),t},e.shouldShowSelectNoDaysOfWeek=function(){var t=!0;return e.selectedPurchesedAddon&&angular.forEach(e.daysOfWeek,function(a){e.selectedDaysFromAdmin.includes(a)&&e.selectedPurchesedAddon.selected_post_days&&(e.selectedPurchesedAddon.selected_post_days[a]||(t=!1))}),t},e.togglePostDaysSelectionForAddon=function(t){angular.forEach(e.daysOfWeek,function(a){e.selectedDaysFromAdmin.includes(a)&&(e.selectedPurchesedAddon.selected_post_days[a]=t)})},e.toggleAdminConfigDaysSelectionForAddon=function(t){angular.forEach(e.daysOfWeek,function(a){e.selectedDaysFromAdmin.includes(a)&&(e.selectedPurchesedAddon.adminConfiguredDays[a]=t)})};var d;e.clickedOnDatePicker=function(t){e.datePickerFor=t,d=r.open({template:"/assets/partials/common/rvDatePicker.html",controller:"RVAddonDatePickerController",className:"",scope:e,closeByDocument:!0})},e.dateSelected=function(a){"start_date"===e.datePickerFor?e.selectedPurchesedAddon.start_date=o("date")(a,t.dateFormat):e.selectedPurchesedAddon.end_date=o("date")(a,t.dateFormat),m()},e.closePopup=function(){r.close(),e.showRightContentForMobile=!1},e.goBackToAddonsList=function(){e.showRightContentForMobile=!1},e.closeCalendar=function(){d.close()},e.goToAddons=function(){e.closePopup(),t.$broadcast("NAVIGATE_TO_ADDONS",{addonPostingMode:e.addonPopUpData.addonPostingMode})},e.removeChosenAddons=function(a,n,o){a.stopPropagation(),e.selectedPurchesedAddon="",o.is_allowance&&o.is_consumed_allowance?e.errorMessage=["Cannot remove consumed allowance from staycard"]:(1===e.packageData.existing_packages.length&&e.closePopup(),t.$broadcast("REMOVE_ADDON",{addonPostingMode:e.addonPopUpData.addonPostingMode,index:n,addon:o}))},e.proceedBooking=function(){for(var t=e.selectedPurchesedAddon.custom_nightly_selected_post_days,a=t.length,n=0,o=0,r=u(e.selectedPurchesedAddon.startDateObj,e.selectedPurchesedAddon.endDateObj,"days"),i=0;i<a;i++){var s=t[i];r.includes(s)&&(o++,e.selectedPurchesedAddon.selected_post_days[s]===!1&&n++)}n===o?e.errorMessage=["Please remove the addon if deselecting all the available days"]:(p(),e.$emit("PROCEED_BOOKING",{addonPostingMode:e.addonPopUpData.addonPostingMode,selectedPurchesedAddon:e.selectedPurchesedAddon}),e.closePopup())},e.setDeafultDisplay=function(){angular.copy(e.previousPostDays,e.selectedPurchesedAddon.selected_post_days),e.selectedPurchesedAddon=""},e.shouldShowAddMoreButton=function(){var t=e.addonPopUpData.addonPostingMode;return"staycard"===t||"group"===t||"allotments"===t};var p=function(){angular.forEach(e.packageData.existing_packages,function(a){a.startDateObj?a.start_date=o("date")(tzIndependentDate(a.startDateObj),t.dateFormatForAPI):a.start_date=o("date")(tzIndependentDate(a.start_date),t.dateFormatForAPI),a.endDateObj?a.end_date=o("date")(tzIndependentDate(a.endDateObj),t.dateFormatForAPI):a.end_date=o("date")(tzIndependentDate(a.end_date),t.dateFormatForAPI),angular.forEach(a.post_instances,function(t){var a=new Date(t.post_date),n=e.daysOfWeek[a.getDay()];t.active=e.selectedPurchesedAddon.selected_post_days[n]})})},m=function(){e.daysOfWeek=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];var t,a,n=e.selectedPurchesedAddon.startDateObj,o=e.selectedPurchesedAddon.endDateObj;if(t=(moment(o)-moment(n))/864e5,t--,t<=6){e.daysOfWeekCopy=[],a=n.getDay(),e.selectedPurchesedAddon.is_allowance&&e.selectedPurchesedAddon.is_consume_next_day&&a++;for(var r=0;r<=t;r++)a<7?(e.daysOfWeekCopy.push(e.daysOfWeek[a]),a++):(e.daysOfWeekCopy.push(e.daysOfWeek[a-7]),a++);angular.copy(e.daysOfWeekCopy,e.daysOfWeek)}}}]),sntRover.controller("RVAddonDatePickerController",["$scope",function(e){var t="",a="";e.data={},"start_date"===e.datePickerFor?(e.data.selectedDate=tzIndependentDate(e.selectedPurchesedAddon.startDateObj),t=tzIndependentDate(e.addonPostingDate.startDate),a=tzIndependentDate(e.selectedPurchesedAddon.endDateObj)):(e.data.selectedDate=tzIndependentDate(e.selectedPurchesedAddon.endDateObj),t=tzIndependentDate(e.selectedPurchesedAddon.startDateObj),a=tzIndependentDate(e.addonPostingDate.endDate)),e.setUpData=function(){e.dateOptions={changeYear:!0,changeMonth:!0,yearRange:"0:+10",minDate:t,maxDate:a,onSelect:function(){"start_date"===e.datePickerFor?e.selectedPurchesedAddon.startDateObj=tzIndependentDate(e.data.selectedDate):e.selectedPurchesedAddon.endDateObj=tzIndependentDate(e.data.selectedDate),e.dateSelected(e.data.selectedDate),e.closeCalendar()}}},e.setUpData()}]),sntRover.controller("RVReceiptPopupController",["$scope","$rootScope","RVBillCardSrv","RVContactInfoSrv","ngDialog","$filter",function(e,t,a,n,o,r){BaseCtrl.call(this,e),e.getEmailButtonClass=function(){var t="blue";return e.data.mailto_address||(t="grey"),t},e.isEmailButtonDisabled=function(){var t=!1;return e.data.mailto_address||(t=!0),t},e.printReceipt=function(){var t=function(t){var a=t.data;if(a.is_copy_of_receipt){var n=a.copy_counter||"";a.receiptHeading=a.receipt_translations.copy_of_receipt.replace("#count",n)}else a.receiptHeading=a.receipt_translations.payment_receipt;e.$emit("PRINT_RECEIPT",a)},n={params:{bill_id:e.billId,transaction_id:e.transactionId,locale:e.data.locale},successCallBack:t};e.callAPI(a.printReceiptData,n)},e.closeDialog=function(){o.close()},e.showEmailSentStatusPopup=function(){o.open({template:"/assets/partials/popups/rvEmailSentStatusPopup.html",className:"",scope:e})},e.emailReceipt=function(){var t=function(){e.statusMsg=r("translate")("EMAIL_SEND_FAILED"),e.status="alert",e.showEmailSentStatusPopup()},n=function(t){e.statusMsg=r("translate")("EMAIL_SENT_SUCCESSFULLY"),e.status="success",e.showEmailSentStatusPopup()},o={params:{bill_id:e.billId,transaction_id:e.transactionId,to_address:e.data.mailto_address,locale:e.data.locale},successCallBack:n,failureCallBack:t};e.callAPI(a.emailReceiptData,o)};var i=function(t){t.languages&&(t.languages=_.filter(t.languages,{is_show_on_guest_card:!0})),e.languageData=t,e.data.locale=t.selected_language_code},s=function(){e.data={};var t={successCallBack:i};e.callAPI(n.fetchGuestLanguages,t)};s()}]),angular.module("sntRover").service("rvGroupAccountActivitySrv",["$q","rvBaseWebSrvV2",function(e,t){this.cacheReportList={},this.fetchActivityLog=function(a){var n=e.defer(),o="/api/group_actions/"+a.id;return a=_.omit(a,"id"),t.getJSON(o,a).then(function(e){this.cacheReportList=e,n.resolve(this.cacheReportList)}.bind(this),function(e){n.reject(e)}),n.promise}}]),angular.module("sntRover").service("rvGroupActionsSrv",["$q","BaseWebSrvV2",function(e,t){var a=this,n=null;a.searchPerPage=50,a.page=1,a.to_date="",this.getTasksCount=function(a){var n=e.defer(),o="/api/groups/"+a.id;return t.getJSON(o).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.getActionsTasksList=function(a){var n=e.defer(),o="/api/action_tasks?associated_id="+a.id+"&associated_type=Group";return t.getJSON(o).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.getActionsManagerTasksList=function(a){var n=e.defer(),o="/api/action_tasks?associated_type=Reservation";return t.getJSON(o).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.syncActionCount=function(a){var n=e.defer(),o="/api/action_tasks/sync_with_external_pms?reservation_id="+a;return t.getJSON(o).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.postNewAction=function(a){var n=e.defer(),o="/api/action_tasks.json";return t.postJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.updateNewAction=function(a){var n=e.defer(),o="/api/action_tasks/"+a.action_task.id+".json";return t.putJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.completeAction=function(a){var n=e.defer(),o="/api/action_tasks/"+a.action_task.id;return t.putJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchDepartments=function(){var n=e.defer(),o="admin/departments.json";return null===a.cache.responses.departments||Date.now()>a.cache.responses.departments.expiryDate?t.getJSON(o).then(function(e){a.cache.responses.departments={data:e,expiryDate:Date.now()+1e3*a.cache.config.lifeSpan},n.resolve(e)},function(e){n.reject(e)}):n.resolve(a.cache.responses.departments.data),n.promise},this.fetchGuestInfo=function(n){var o=e.defer();n&&(n.fakeDataToAvoidCache=new Date),a.toDate=void 0===a.toDate?"":a.toDate;var r="search.json?per_page="+a.searchPerPage+"&page="+a.page;return t.getJSON(r,n).then(function(e){e.data.results;if(n.query){var t,a,r,i=n.query.toLowerCase(),s=0;for(var c in e.data.results)e.data.results[c].is_row_visible=!1,e.data.results[c].firstname&&(t=e.data.results[c].firstname.toLowerCase(),t.indexOf(i)!==-1&&(e.data.results[c].is_row_visible=!0,s++)),e.data.results[c].lastname&&(a=e.data.results[c].lastname.toLowerCase(),a.indexOf(i)!==-1&&(e.data.results[c].is_row_visible=!0,s++)),e.data.results[c].room&&(r=e.data.results[c].room.toLowerCase(),r.indexOf(i)!==-1&&(e.data.results[c].is_row_visible=!0,s++))}e.queryTime=n.queryTime,e.visibleRowCount=s,e.querySent=n.query,o.resolve(e)},function(e){o.reject(e)}),o.promise},this.fetchActions=function(a){var n=e.defer(),o="api/action_tasks/hotel_actions";return t.getJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.getActionDetails=function(a){var n=e.defer(),o="api/action_tasks/"+a;return t.getJSON(o).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.cache={config:{lifeSpan:900},responses:{departments:null}},a.setFilterState=function(e){n=angular.copy(e)},a.getFilterState=function(e){return n},a.clearFilterState=function(e){n=null}}]),angular.module("sntRover").service("rvGroupActivitySrv",["$q","rvBaseWebSrvV2",function(e,t){this.cacheReportList={},this.fetchActivityLog=function(a){var n=e.defer(),o="/ui/show?format=json&json_input=activityLog/activity_log.json";return t.getJSON(o,a).then(function(e){this.cacheReportList=e,n.resolve(this.cacheReportList)}.bind(this),function(e){n.reject(e)}),n.promise},this.fetchActivityLog1=function(a){var n=e.defer(),o="/ui/show?format=json&json_input=activityLog/activity_log1.json";return t.getJSON(o,a).then(function(e){this.cacheReportList=e,n.resolve(this.cacheReportList)}.bind(this),function(e){n.reject(e)}),n.promise}}]),angular.module("sntRover").service("rvGroupConfigurationSrv",["$q","rvBaseWebSrvV2","rvAccountsConfigurationSrv","rvHouseEventsListSrv",function(e,t,a,n){var o=this;this.baseConfigurationSummary={group_id:null,group_name:"",group_code:null,first_name:"",last_name:"",contact_phone:null,contact_email:null,demographics:{reservation_type_id:"",market_segment_id:"",source_id:"",booking_origin_id:"",segment_id:""},travel_agent:null,company:null,hold_status:"",block_from:"",block_to:"",revenue_actual:null,revenue_potential:null,rooms_total:null,rooms_pickup:null,rate:"",addons_count:null,notes:[]},this.lastFetchedGroup={group_id:null,demographics:null},this.getHoldStatusList=function(a){var n=e.defer(),o="/api/group_hold_statuses";return t.getJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.saveRoomBlockBookings=function(a){var n=e.defer(),o="/api/groups/save_inventories";return t.postJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.saveMassUpdate=function(a){var n=e.defer(),o="/api/groups/save_bulk_inventories";return t.postJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.getGroupInventories=function(a){var n=e.defer(),o="/api/groups/"+a.group_id+"/inventories";return t.getJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.getRoomBlockGridDetails=function(t){var a=[],r=e.defer();return a.push(o.getGroupInventories(t)),a.push(n.fetchHouseEventsCount(t)),e.all(a).then(function(e){var t=e[0];t.eventsCount=e[1],r.resolve(t)},function(){r.reject({})}),r.promise},this.getAllRoomTypes=function(){var a=e.defer(),n="/api/room_types.json?is_exclude_pseudo=true";return t.getJSON(n).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.getSelectedRoomTypesAndRates=function(a){var n=e.defer(),o=a.id,r="/api/groups/"+o+"/room_type_and_rates";return t.getJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.updateSelectedRoomTypesAndRates=function(a){var n=e.defer(),o="/api/groups/update_room_type_and_rates";
return t.postJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.cancelGroup=function(a){var n=e.defer(),o="/api/groups/"+a.group_id+"/cancel";return t.postJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.sendGroupConfirmationEmail=function(a){var n=e.defer(),o=a.postData,r=" api/groups/"+a.groupId+"/group_email_confirmation";return t.postJSON(r,o).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.getRoomTypeBestAvailableRateAndOccupancyCount=function(a){var n=e.defer(),o="/api/groups/availability";return t.getJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise};this.getGroupSummary=function(n){var r=e.defer(),i="";if("NEW_GROUP"===n.groupId)r.resolve(angular.copy({groupSummary:o.baseConfigurationSummary}));else{var i="api/groups/"+n.groupId;t.getJSON(i).then(function(e){var n,i=e.posting_account_id;null===e.rate&&(e.rate=-1),e.country_id=e.country_id?e.country_id:"",e.nationality=e.nationality?e.nationality:"",o.lastFetchedGroup={id:e.group_id,demographics:angular.copy(e.demographics)},"NEW_ACCOUNT"===i?r.resolve({accountSummary:angular.copy(a.baseAccountSummaryData)}):(n="api/posting_accounts/"+i,t.getJSON(n).then(function(t){_.defer(r.resolve,{groupSummary:e,accountSummary:t})},function(e){r.reject(e)}))},function(e){r.reject(e)})}return r.promise},this.searchCompanyCards=function(a){var n=e.defer(),o="api/accounts?account_type=COMPANY&query="+a;return t.getJSON(o).then(function(e){n.resolve(e.accounts)},function(e){n.reject(e)}),n.promise},this.searchTravelAgentCards=function(a){var n=e.defer(),o="api/accounts?account_type=TRAVELAGENT&query="+a;return t.getJSON(o).then(function(e){n.resolve(e.accounts)},function(e){n.reject(e)}),n.promise},this.updateGroupSummary=function(a){var n=e.defer(),r="api/groups/"+a.summary.group_id;return o.processGroupUpdatePostData(a.summary),t.putJSON(r,a.summary).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.saveGroupSummary=function(a){var n=e.defer(),o="api/groups";return t.postJSON(o,a.summary).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.addGroupEnhancement=function(a){var n=e.defer(),o="/api/groups/"+a.id+"/addons";return t.postJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.removeGroupEnhancement=function(a){var n=e.defer(),o="/api/groups/"+a.id+"/addons";return t.deleteJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.getGroupEnhancements=function(a){var n=e.defer(),o="/api/groups/"+a.id+"/addons";return t.getJSON(o).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.saveGroupNote=function(a){var n=e.defer(),o="api/groups/save_group_note";return t.postJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.updateGroupNote=function(a){var n=e.defer(),o="api/notes/"+a.id;return t.putJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.removeGroupNote=function(a){var n=e.defer(),o="api/groups/delete_group_note";return t.deleteJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.updateRoomingListItem=function(a){var n=e.defer(),o="api/group_reservations/"+a.id;return t.putJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.removeRoomingListItem=function(a){var n=e.defer(),o="api/group_reservations/"+a.id+"/cancel";return t.postJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.releaseRooms=function(a){var n=e.defer(),o="api/groups/"+a.groupId+"/release_now";return t.getJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.getRates=function(a){var n=e.defer(),o="api/groups/rates";return t.getJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.toggleHideRate=function(a){var n=e.defer(),o="api/groups/"+a.group_id+"/hide_rates";return t.postJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.updateRate=function(a){var n=e.defer(),o="api/groups/"+a.group_id+"/change_rate";return t.postJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.completeMoveGroup=function(a){var n=e.defer(),o="/api/groups/"+a.group_id+"/move_dates",r={from_date:a.from_date,to_date:a.to_date,old_from_date:a.old_from_date,old_to_date:a.old_to_date,force_fully_over_book:a.force_fully_over_book};return t.postJSON(o,r).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.changeDates=function(a){var n=e.defer(),o="/api/groups/"+a.group_id+"/change_dates",r=_.omit(a,"group_id");return t.postJSON(o,r).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.deleteBillingInfo=function(a){var n=e.defer(),o="/api/groups/"+a.group_id+"/remove_routing";return t.postJSON(o,{}).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.processGroupUpdatePostData=function(e){var t=isObjectAllValuesEmpty(e.company),a=isObjectAllValuesEmpty(e.travel_agent);t&&(e.company={}),a&&(e.travel_agent={}),e=replaceValueWithinObject(e,"",null)},this.updateAddonPosting=function(a){var n=e.defer(),o="/api/groups/"+a.group_id+"/update_addon_posting";return t.postJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.updateCompanyCard=function(a){var n=e.defer(),o="/api/groups/"+a.id+"/update_company_card";return t.postJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.updateHoldStatus=function(a){var n=e.defer(),o="/api/groups/"+a.id+"/hold_status";return t.putJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchRoomTypesRates=function(a){var n=e.defer(),o="/api/groups/"+a.group_id+"/daily_rates";return t.getJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.getRoomTypesOccupancyRateDetailsAndEventsCount=function(t){var a=[],r=e.defer();return a.push(o.fetchRoomTypesRates(t)),a.push(n.fetchHouseEventsCount(t)),e.all(a).then(function(e){var t={results:e[0],eventsCount:e[1]};r.resolve(t)},function(e){r.reject(e)}),r.promise},this.performRateMassUpdate=function(a){var n=e.defer(),o="/api/groups/"+a.groupId+"/daily_rates/bulk_update";return delete a.groupId,t.putJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.saveRoomTypesDailyRates=function(a){var n=e.defer(),o="/api/groups/"+a.group_id+"/daily_rates";return t.putJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise}}]),angular.module("sntRover").service("rvGroupRoomingListSrv",["$q","rvBaseWebSrvV2","rvUtilSrv","sntBaseWebSrv",function(e,t,a,n){var o=this;this.DEFAULT_PER_PAGE=50,this.DEFAULT_PAGE=1,this.addReservations=function(a){var n=e.defer(),o=(a.id,"/api/group_reservations/"),a={group_id:a.group_id,reservations_data:{room_type_id:a.room_type_id,from_date:a.from_date,to_date:a.to_date,occupancy:a.occupancy,no_of_reservations:a.no_of_reservations}};return t.postJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchReservations=function(a){var n=e.defer(),o="/api/group_reservations/"+a.group_id+"/list",r=$.extend({},{per_page:a.per_page,page:a.page,locale:a.locale||"en"}),i=["sort_field","sort_dir","arrival_date","dep_date","query","exclude_cancel","show_pending_only"];return _.each(i,function(e){typeof a[e]!=typeof!0&&a[e]&&(r[e]=a[e]),typeof a[e]==typeof!0&&(r[e]=a[e])}),t.getJSON(o,r).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.performMassCheckin=function(a){var n=e.defer(),o=(a.id,"/api/group_checkins/"),a={group_id:a.group_id,reservation_ids:a.reservation_ids};return t.postJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.performMassCheckout=function(a){var n=e.defer(),o=(a.id,"/api/group_checkouts/"),a={group_id:a.group_id,reservation_ids:a.reservation_ids};return t.postJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.performAutoRoomAssignment=function(a){var n=e.defer(),o=(a.id,"/api/groups/auto_room_assignment"),a={group_id:a.group_id,reservation_ids:a.reservation_ids};return t.postJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.getFreeAvailableRooms=function(a){var n="/api/reservations/"+a.reserevation_id+"/ready_to_assign_rooms/",o=e.defer(),r={count:a.num_of_rooms_to_fetch,room_type_id:a.room_type_id};return t.getJSON(n,r).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.getRoomTypesConfiguredAgainstGroup=function(a){var n=e.defer(),o=a.id,r="api/group_rooms/"+o;return t.getJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.checkDefaultChargeRoutings=function(a){var n=e.defer(),o=a.id,r="/api/groups/"+o+"/check_default_charge_routings";return t.getJSON(r).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.attachBillingInfoToReservations=function(a){var n=e.defer(),o="/api/default_account_routings/attach_reservation";return t.postJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.emailInvoice=function(a){var n=e.defer(),o="/api/group_reservations/email_rooming_list";return t.postJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchRegistrationCardPrintData=function(a){var n=e.defer(),o="/api/registration_cards/";return t.getJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.updateGuestData=function(a){var n=e.defer(),o="/api/group_reservations/update_guest_details";return t.postJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.exportRoomingList=function(e){var t="/api/group_reservations/"+e.group_id+"/list.csv";return delete e.group_id,n.download(t,e,"GET")},this.fetchHotelReservationSettings=function(){var a=e.defer(),n="/api/hotel_settings/show_hotel_reservation_settings";return o.reservationSettings?a.resolve(o.reservationSettings):t.getJSON(n).then(function(e){o.reservationSettings=e,a.resolve(e)},function(e){a.reject(e)}),a.promise}}]),angular.module("sntRover").service("rvGroupSrv",["$q","rvBaseWebSrvV2",function(e,t){this.DEFAULT_PER_PAGE=50,this.DEFAULT_PAGE=1,this.getGroupList=function(a){var n=e.defer(),o="/api/groups/search";return a.q=a.q||a.query,t.postJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.searchGroupCard=function(a){var n=e.defer(),o="/api/groups/group_search",r={name:a.name,code:a.code,from_date:a.from_date,to_date:a.to_date,per_page:a.per_page,page:a.page};return a.is_take_from_inventory&&(r.is_take_from_inventory=!0),t.getJSON(o,r).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.attachGroupToReservation=function(a){var n=e.defer(),o="/api/reservations/"+a.reservation_id+"/add_group",r={group_id:a.group_id};return a.forcefully_overbook&&(r.forcefully_overbook=a.forcefully_overbook),t.postJSON(o,r).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.detachGroupFromReservation=function(a){var n=e.defer(),o="/api/reservations/"+a.reservation_id+"/remove_group",r={group_id:a.group_id};return t.postJSON(o,r).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchHotelBusinessDate=function(){var a=e.defer(),n="/api/business_dates/active";return t.getJSON(n).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise};var a=function(e){return"cancel"===e.hold_status.toLowerCase()};this.getClassAgainstPickedStatus=function(e){var t="";return e.total_picked_count>0&&(t="green"),a(e)&&(t+=" red"),t},this.getGuestClassForArrival=function(e){var t=a(e)?"cancel":"check-in";return t},this.getGuestClassForDeparture=function(e){var t=a(e)?"cancel":"check-out";return t},this.getClassAgainstHoldStatus=function(e){return"true"===e.is_take_from_inventory?"":"tentative"},this.getHoldStatusList=function(a){var n=e.defer(),o="/api/group_hold_statuses";return t.getJSON(o,a).then(function(e){_.each(e.data.hold_status,function(e){e.active=!0}),n.resolve(e.data)},function(e){n.reject(e)}),n.promise},this.updateCache=function(e){this.filterParams=e},this.getCache=function(){return this.filterParams},this.clearCache=function(){this.filterParams={}}}]),angular.module("sntRover").service("RVReservationSummarySrv",["$q","rvBaseWebSrvV2",function(e,t){var a=this;this.reservationData={},this.reservationData.demographics={};var n={},o={},r={},i={},s={};this.fetchPaymentMethods=function(){var a=e.defer(),n="/staff/payments/addNewPayment.json";return t.getJSON(n).then(function(e){a.resolve(e.data)},function(e){a.reject(e)}),a.promise},this.fetchLengthSegments=function(){var a=e.defer();if(isEmpty(s)){var n="/api/segments?is_active=true";t.getJSON(n).then(function(e){s=e,a.resolve(e)},function(e){a.reject(e)})}else a.resolve(s);return a.promise},this.fetchDemographicMarketSegments=function(){var a=e.defer();if(isEmpty(n)){var o="/api/market_segments?is_active=true";t.getJSON(o).then(function(e){n=e,a.resolve(n)},function(e){a.reject(e)})}else a.resolve(n);return a.promise},this.fetchDemographicSources=function(){var a=e.defer();if(isEmpty(o)){var n="/api/sources?is_active=true";t.getJSON(n).then(function(e){o=e,a.resolve(o)},function(e){a.reject(e)})}else a.resolve(o);return a.promise},this.fetchDemographicOrigins=function(){var a=function(e){r.is_use_origins=e.is_use_origins,r.origins=[];for(var t in e.booking_origins)e.booking_origins[t].is_active&&r.origins.push(e.booking_origins[t]);n.resolve(r)},n=e.defer();if(isEmpty(r)){var o="/api/booking_origins";t.getJSON(o).then(function(e){a(e)},function(e){n.reject(e)})}else n.resolve(r);return n.promise},this.fetchDemographicReservationTypes=function(){var n=function(e){i=[],a.reservationData.demographics.reservationTypes=[];for(var t in e.reservation_types)e.reservation_types[t].is_active&&i.push(e.reservation_types[t]);o.resolve(i)},o=e.defer();if(isEmpty(i)){var r="/api/reservation_types.json?is_active=true";t.getJSON(r).then(function(e){n(e)},function(e){o.reject(e)})}else o.resolve(i);return o.promise},this.fetchInitialData=function(){var t=e.defer(),n={};return n.marketsData=a.fetchDemographicMarketSegments(),n.originsData=a.fetchDemographicOrigins(),n.sourcesData=a.fetchDemographicSources(),n.reservationTypesData=a.fetchDemographicReservationTypes(),n.segmentsData=a.fetchLengthSegments(),e.all(n).then(function(e){a.reservationData.demographics.is_use_markets=e.marketsData.is_use_markets,a.reservationData.demographics.markets=e.marketsData.markets,a.reservationData.demographics.is_use_origins=e.originsData.is_use_origins,a.reservationData.demographics.origins=e.originsData.origins,a.reservationData.demographics.is_use_sources=e.sourcesData.is_use_sources,a.reservationData.demographics.sources=e.sourcesData.sources,a.reservationData.demographics.is_use_segments=e.segmentsData.is_use_segments,a.reservationData.demographics.segments=e.segmentsData.segments,a.reservationData.demographics.reservationTypes=e.reservationTypesData,t.resolve(a.reservationData)},function(e){t.reject(e)}),t.promise},this.saveReservation=function(a){var n=e.defer(),o="/api/reservations";return t.postJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.updateBillingInformation=function(a){var n=e.defer(),o="api/bill_routings/update_dates";return t.postJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.sendConfirmationEmail=function(a){var n=e.defer(),o="/api/reservations/"+a.reservationId+"/email_confirmation";return delete a.reservationId,t.postJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.sendHourlyConfirmationEmail=function(a){var n=e.defer(),o="/api/reservations/hourly_confirmation_emails?";return _.each(a.reservation_ids,function(e){o+="reservation_ids[]="+e+"&"}),_.each(a.emails,function(e){o+="emails[]="+encodeURIComponent(e)+"&"}),delete a.reservation_ids,delete a.emails,t.postJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.updateReservation=function(a){var n=e.defer(),o="/api/reservations/"+a.reservationId;return t.putJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.paymentAction=function(a){var n=e.defer(),o="/api/ipage/store_payments";return t.postJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.startPayment=function(a){var n=e.defer(),o="/api/cc/get_token";return t.postJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchRooms=function(){var a=e.defer(),n="/api/rooms";return t.getJSON(n).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.getRateName=function(a){var n=e.defer(),o="/api/rates/"+a.id;return t.getJSON(o).then(function(e){n.resolve(e.name)},function(e){n.reject(e)}),n.promise},this.getRateDetails=function(a){var n=e.defer(),o="/api/rates/"+a.id;return t.getJSON(o).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.getTaxDetails=function(a){var n=e.defer(),o="/api/rates/tax_information/";return t.getJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchDefaultRoutingInfo=function(a){var n=e.defer(),o="/api/default_account_routings/routings_count/";return t.postJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.applyDefaultRoutingToReservation=function(a){var n=e.defer(),o="/api/default_account_routings/attach_reservation";return t.postJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchResservationConfirmationPrintData=function(a){var n=e.defer(),o="/api/reservations/"+a.reservation_id+"/confirmation_email_data";return t.getJSON(o,a).then(function(e){e.data.addons_list=e.data.addons?e.data.addons.toString():"",n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchResservationCancellationPrintData=function(a){var n=e.defer(),o="/api/reservations/"+a.reservation_id+"/cancellation_email_data";return t.getJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.updateNoRoomMove=function(a){var n=e.defer(),o="/api/reservations/"+a.reservationId+"/update_no_room_move_flag";return t.postJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.updateRestrictPost=function(a){var n=e.defer(),o="/api/reservations/"+a.reservationId+"/update_restrict_post_flag";return t.postJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.saveTaxExempt=function(a){var n=e.defer(),o="/api/reservations/save_tax_exempt";return t.postJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.checkUpsellAvailability=function(a){var n=e.defer(),o="/api/reservations/"+a+"/upsell_availability";return t.getJSON(o).then(function(e){n.resolve(e.is_upsell_available)},function(e){n.reject(e)}),n.promise},this.updateCommission=function(a){var n=e.defer(),o="/api/reservations/"+a.reservationId+"/update_commission";return t.putJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.retrieveRoomPin=function(a){var n=e.defer(),o="/staff/reservation/get_room_pin";return t.getJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.updateBookerEmail=function(a){var n=e.defer(),o="/api/reservations/"+a.reservationId+"/update_booker_email";return t.putJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise}}]),angular.module("sntRover").service("RVReservationAddonsSrv",["$q","rvBaseWebSrvV2",function(e,t){var a=this;this.addonData={},this.fetchAddonData=function(n){var o=e.defer(),r="/api/charge_groups/for_addons";return t.getJSON(r,n).then(function(e){a.addonData.addonCategories=e.results,o.resolve(a.addonData)},function(e){o.reject(e)}),o.promise},this.fetchAddons=function(a){var n=e.defer(),o="api/addons";return t.getJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.checkInventory=function(a){var n=e.defer(),o="/api/addons/"+a.addon_id+"/inventory_details";return t.getJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise}}]),angular.module("sntRover").service("RVDepositBalanceSrv",["$q","BaseWebSrvV2","rvBaseWebSrvV2","$rootScope",function(e,t,a,n){this.getDepositBalanceData=function(a){var n=e.defer(),o="staff/reservations/"+a.reservationId+"/deposit_and_balance.json";return t.getJSON(o).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.getRevenueDetails=function(a){var n=e.defer(),o="api/posting_accounts/"+a.posting_account_id+"/deposit_and_balance";return t.getJSON(o).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.submitPaymentOnBill=function(t){var o=0,r=function(){o++},i=setInterval(r,1e3),s=e.defer(),c="/api/bills/"+t.bill_id+"/submit_payment",u=function(e){if(o>=n.emvTimeout){var t=["Request timed out. Unable to process the transaction"];s.reject(t)}else a.getJSONWithSpecialStatusHandling(e).then(function(t){t.status&&"processing_not_completed"===t.status||"null"===t?setTimeout(function(){console.info("POLLING::-> for emv terminal response"),u(e)},5e3):(clearInterval(i),s.resolve(t))},function(t){"undefined"==typeof t?u(e):(clearInterval(i),s.reject(t))})};return a.postJSONWithSpecialStatusHandling(c,t.postData).then(function(e){t.is_emv_request&&e.status&&"processing_not_completed"===e.status?u(e.location_header):(clearInterval(i),s.resolve(e))},function(e){clearInterval(i),s.reject(e)}),s.promise}}]),angular.module("sntRover").service("RVBillCardSrv",["$http","$q","BaseWebSrvV2","RVBaseWebSrv","rvBaseWebSrvV2","sntBaseWebSrv","RVGAHelperSrv",function(e,t,a,n,o,r,i){var s=this;this.fetchReservationBillData=function(e){var a=t.defer(),n="/api/reservations/"+e+"/bills_summary";return o.getJSON(n).then(function(e){a.resolve(e.data)},function(e){a.reject(e)}),a.promise},this.fetchAllowanceData=function(e,t,a){var n="/api/bills/"+t+"/allowance_transactions";return o.getJSON(n).then(function(t){t.allowance_data&&t.allowance_data.allowance_entries&&t.allowance_data.allowance_entries.length&&(_.each(t.allowance_data.allowance_entries,function(e,a){e.entriesForTheDate=_.filter(t.allowance_data.allowance_entries,function(t){return t.date===e.date}),e.amount=e.amount?parseFloat(e.amount):e.amount}),a.allowance_data=t.allowance_data),e.resolve(a)},function(t){e.reject(t)}),e.promise},this.fetchReservationAllowanceTransactions=function(e){const t="/api/reservations/"+e+"/allowance_transactions";return o.getJSON(t).then(function(e){var t={dataByAllowance:[],dataByDate:[]};return e.allowance_data&&e.allowance_data.allowance_entries&&e.allowance_data.allowance_entries.length&&(t.dataByAllowance=_.groupBy(e.allowance_data.allowance_entries,function(e){return e.addon_id}),t.dataByDate=_.groupBy(e.allowance_data.allowance_entries,function(e){return e.date})),t.amount=e.allowance_data.amount,t},function(){})},this.searchAllowanceShares=function(e){var a=t.defer(),n="/api/reservations/"+e.reservationId+"/search_reservations_for_allowance_share";return o.getJSON(n,{query:e.query}).then(function(e){a.resolve(e.data)},function(e){a.reject(e)}),a.promise},this.saveAllowanceShares=function(e){var n=t.defer(),o="/api/reservations/"+e.reservationId+"/route_allowance";return a.postJSON(o,e.data).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchBillData=function(e){var a=t.defer(),n="/api/bills/"+e;return o.getJSON(n).then(function(e){a.resolve(e.data)},function(e){a.reject(e)}),a.promise},this.fetch=function(e){var a="",n=t.defer(),o="",r="";return t.when().then(function(){return s.fetchReservationBillData(e).then(function(e){a=e})}).then(function(){return o=a.bills[0].bill_id,r=parseInt(a.bills[0].bill_number)-1,s.fetchBillData(o).then(function(e){a.bills[r]=e})}).then(function(){a.groupedAllowances={},n.resolve(a)},function(e){n.reject(e)}),n.promise},this.fetchBillPrintData=function(e){var a=t.defer(),o="staff/bills/print_guest_bill";return n.postJSON(o,e).then(function(e){e.charge_details_list=[],angular.forEach(e.fee_details,function(t,a){angular.forEach(t.charge_details,function(a){a.date=t.date,a.isCredit=!1,e.charge_details_list.push(a)}),angular.forEach(t.credit_details,function(a){a.date=t.date,a.isCredit=!0,e.charge_details_list.push(a)})}),a.resolve(e)},function(e){a.reject(e)}),a.promise},this.fetchRegistrationCardPrintData=function(e){var a=t.defer(),n="/api/registration_cards/"+e.reservation_id;return o.getJSON(n,e).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.movetToAnotherBill=function(e){var n=t.defer(),o="/staff/bills/transfer_transaction";return a.postJSON(o,e).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.setBillAddressType=function(e){var n=t.defer(),o="/api/bills/"+e.bill_id+"/save_address_type";return a.postJSON(o,e.parmasToApi).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.completeCheckin=function(e){var a=t.defer(),o="/staff/checkin";return n.postJSON(o,e).then(function(t){i.sendEventToGA("CHECKIN",e.reservation_id),a.resolve(t)},function(e){a.reject(e)}),a.promise},this.completeCheckout=function(e){var a=t.defer(),o="/staff/checkout";return n.postJSON(o,e).then(function(t){i.sendEventToGA("CHECKOUT",e.reservation_id),a.resolve(t)},function(e){a.reject(e)}),a.promise},this.getAdvanceBill=function(e){var a=t.defer(),o="api/reservations/"+e.id+"/advance_bill";return n.postJSON(o).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.transactionEdit=function(e){var n=t.defer(),o="api/financial_transactions/"+e.id;return a.putJSON(o,e.updatedData).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.transactionEditChargeDescription=function(e){var n=t.defer(),o="api/financial_transactions/"+e.id+"/save_custom_description";return a.postJSON(o,e.postData).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.transactionDelete=function(e){var n=t.defer(),o=e.id,r="api/financial_transactions/"+o;return a.putJSON(r,e.data).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.transactionSplit=function(e){var n=t.defer(),o=e.id,r="api/financial_transactions/"+o;return a.putJSON(r,e.data).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchChargeCodes=function(){var e=t.defer(),n="/api/charge_codes?exclude_payments=true&per_page=1000";return a.getJSON(n).then(function(t){e.resolve(t)},function(t){e.reject(t)}),e.promise},this.fetchAdjustmentReasons=function(){var e=t.defer(),n="/admin/force_adjustment_reasons";return a.getJSON(n).then(function(t){e.resolve(t)},function(t){e.reject(t)}),e.promise},this.sendEmail=function(e){var n=t.defer(),o="api/reservations/email_guest_bill.json";return a.postJSON(o,e).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.createAnotherBill=function(e){var n=t.defer(),o="/api/bills/create_bill";return a.postJSON(o,e).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.changeHousekeepingStatus=function(e){var n=t.defer(),o="/house/change_house_keeping_status.json";return a.postJSON(o,e).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.completeReverseCheckout=function(e){var n=t.defer(),o="/staff/reverse_checkout";return a.postJSON(o,e).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.toggleHideRate=function(e){var n=t.defer(),o="api/reservations/"+e.reservation_id+"/hide_rates";return a.postJSON(o,e).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.getBillSettingsInfo=function(e){var n=t.defer(),o="/api/bills/get_settings_info";return a.getJSON(o,e).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.groupChargeDetailsFetch=function(e){var n=t.defer(),o="/staff/reservation/transaction_details";return a.getJSON(o,e).then(function(e){n.resolve(e.data)},function(e){n.reject(e)}),n.promise},this.hideBill=function(e){var n=t.defer(),o="/api/bills/"+e.bill_id+"/hide_bill";return a.postJSON(o).then(function(e){n.resolve(e.data)},function(e){n.reject(e)}),n.promise},this.fetchGuestLanguages=function(e){var a=t.defer(),n="/api/guest_languages";return o.getJSON(n,e).then(function(e){e.languages&&(e.languages=_.filter(e.languages,{is_show_on_guest_card:!0})),a.resolve(e)},function(e){a.reject(e)}),a.promise},this.callBlackBoxApi=function(e){var n=t.defer(),o="/api/hotel_settings/infrasec/generate_control_code";return a.postJSON(o,e).then(function(e){n.resolve(e.data)},function(e){n.reject(e)}),n.promise},this.generateFolioNumber=function(e){var n=t.defer(),o="/api/bills/"+e.bill_id+"/generate_folio_number";return a.postJSON(o,e).then(function(e){n.resolve(e.data)},function(e){n.reject(e)}),n.promise},this.generateVoidBill=function(e){var n=t.defer(),o="/api/bills/"+e.bill_id+"/void_bill";return a.postJSON(o,e.data).then(function(e){n.resolve(e.data)},function(e){n.reject(e)}),n.promise},this.settleFinalInvoice=function(e){var n=t.defer(),o="/api/bills/"+e.bill_id+"/final_invoice_settlement";return a.postJSON(o,e).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.printReceiptData=function(e){var a=t.defer(),n="/api/bills/"+e.bill_id+"/print_payment_receipt";return r.postJSON(n,e).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.emailReceiptData=function(e){var a=t.defer(),n="/api/bills/"+e.bill_id+"/email_payment_receipt";return r.postJSON(n,e).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise}}]),angular.module("sntRover").service("RVReservationCardSrv",["$http","$q","RVBaseWebSrv","rvBaseWebSrvV2","RVGAHelperSrv","$rootScope",function(e,t,a,n,o,r){this.reservationData={};var i=this;this.fetch=function(e){var n=t.defer(),o=e.reservationId,r=e.isRefresh,s=!1;if(angular.forEach(i.reservationIdsArray,function(e,t){r&&null!==r&&""!==r||e===o&&(s=!0)}),s)n.resolve(i.reservationData[o]);else{i.storeReservationIds(o);var c="api/reservations/"+o+".json";a.getJSON(c).then(function(e){i.reservationData[o]=e,n.resolve(e)},function(e){n.reject(e)})}return n.promise},this.reservationDetails={},this.confirmationNumbersArray=[],this.reservationIdsArray=[];var i=this;this.emptyConfirmationNumbers=function(){i.confirmationNumbersArray=[],i.reservationDetails={}},this.storeConfirmationNumbers=function(e){i.confirmationNumbersArray.push(e)},this.storeReservationIds=function(e){i.reservationIdsArray.push(e)},this.fetchReservationDetails=function(e){var n=e.confirmationNumber,r=e.isRefresh,s=!1,c=!0;angular.forEach(i.confirmationNumbersArray,function(e,t){r&&null!==r||e===n&&(s=!0)});var u=t.defer();if(s)u.resolve(i.reservationDetails[n]);else{i.storeConfirmationNumbers(n);var l="/staff/staycards/reservation_details.json?reservation="+n+"&is_dep_date_allowed="+c;a.getJSON(l).then(function(e){i.reservationDetails[n]=e,o.sendEventToGA("LOAD_RESERVATION",n),u.resolve(e)},function(e){u.reject(e)})}return u.promise},this.updateResrvationForConfirmationNumber=function(e,t){i.reservationDetails[e]=t},this.getResrvationForConfirmationNumber=function(e){return i.reservationDetails[e]},this.guestData="",this.setGuestData=function(e){this.guestData=e},this.getGuestData=function(){return this.guestData},this.fetchGuestcardData=function(e){var n=t.defer(),o="/staff/guestcard/show.json";return a.getJSON(o,e).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchCancellationPolicies=function(e){var a=t.defer(),o="/api/reservations/"+e.id+"/cancellation_policies";return n.getJSON(o,e).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.cancelReservation=function(e){var a=t.defer(),o="/api/reservations/"+e.id+"/cancel";return n.postJSON(o,e).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.tokenize=function(e){var n=t.defer(),o="/staff/payments/tokenize";
return a.postJSON(o,e).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.getLastRateAdjustmentReason=function(e){var a=t.defer(),o="api/reservations/"+e.reservation_id+"/reason_for_last_adjusted_rate";return n.getJSON(o).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.saveReservationNote=function(e){var n=t.defer(),o="/reservation_notes";return a.postJSON(o,e).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.deleteReservationNote=function(e){var n=t.defer(),o="/reservation_notes/"+e;return a.deleteJSON(o,"").then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.updateReservationNote=function(e){var a=t.defer(),o="/reservation_notes/"+e.id;return n.putJSON(o,e).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.getGuestDetails=function(e){var a=t.defer(),o="/api/guest_details/"+e.id;return null===e.id?a.reject([""]):n.getJSON(o).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.modifyRoomQueueStatus=function(e){var a=t.defer(),o={status:e.status};e.viaAdvancedQueue&&(o.signature=e.signature,o.is_promotions_and_email_set=e.is_promotions_and_email_set);var r="/api/reservations/"+e.reservationId+"/queue";return n.postJSON(r,o).then(function(t){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.fetchDepositDetails=function(e){var a=t.defer(),o="api/reservations/"+e+"/deposit_policy";return n.getJSON(o).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.sendConfirmationEmail=function(e){var a=t.defer(),o="/api/reservations/"+e.reservationId+"/email_confirmation";return n.postJSON(o,e.postData).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.validateStayDateChange=function(e){var a=t.defer(),o="/staff/change_stay_dates/validate_stay_dates_change";return n.postJSON(o,e).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.detachGroupReservation=function(e){var a=t.defer(),o="/api/group_reservations/"+e.id+"/detach_group_reservation";return n.postJSON(o,e).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.reinstateReservation=function(e){var a=t.defer(),o="/api/reservations/"+e.reservationId+"/reinstate";return n.postJSON(o,e).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.checkReinstationAvailbility=function(e){var a=t.defer(),o="/api/reservations/"+e+"/check_reinstate_availability";return n.getJSON(o).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.checkGiftCardBalance=function(e){var a={card_number:e.card_number},o=t.defer(),r="/api/gift_cards/balance_inquiry";return n.postJSON(r,a).then(function(e){e&&"number"==typeof e.amount&&(e.amount=parseFloat(e.amount).toFixed(2)),o.resolve(e)},function(e){o.reject(e)}),o.promise},this.fetchGuestIdentity=function(e){var a=t.defer(),o="/api/guest_identity/"+e.reservation_id;return n.getJSON(o,e).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.reverseCheckIn=function(e){var a=t.defer(),o="/api/reservations/"+e.reservationId+"/reverse_check_in";return n.postJSON(o).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.attachGuestToReservation=function(e){var a=t.defer(),o="/api/reservations/"+e.reservation_id+"/reservations_guest_details/attach_guest_details";return delete e.reservation_id,n.postJSON(o,e).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.getConfirmationData=function(e){var a=t.defer(),o="/api/reservations/"+e.reservation_id+"/confirmation_data";return n.getJSON(o).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.createActivityLog=function(e){var a=t.defer();return n.postJSON("/api/reservation_actions",e).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise}}]),angular.module("sntRover").service("RVCompanyCardSrv",["$q","rvBaseWebSrvV2",function(e,t){var a=this,n={},o=6e4;a.companyTaArDetailsCached=[],a.companyTaNotes=[],a.cachedTime="",this.DEFAULT_PER_PAGE=10,this.DEFAULT_PAGE=1;var r={},i=this;this.fetchContactInformation=function(a){var n=a.id,o=e.defer(),r="/api/accounts/"+n,i=["is_eod_failed","is_eod_in_progress","is_eod_manual_started","is_eod_process_running"];return t.getJSON(r).then(function(e){o.resolve(_.omit(e,i))},function(e){o.reject(e)}),o.promise},this.fetchCompanyPaymentData=function(a){var n=e.defer(),o="/staff/payments/payment.json?account_id="+a;return t.getJSON(o).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.setAsPrimary=function(a){var n=e.defer(),o="api/accounts/"+a.account_id+"/set_wallet_payment_method_primary";return t.postJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.deletePayment=function(a){var n=e.defer(),o="api/accounts/"+a.account_id+"/delete_wallet_payment_methods";return t.postJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchContactInformationMandatoryFields=function(){var a=e.defer(),n="/admin/co_ta_settings/current_settings.json";return t.getJSON(n).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.fetchAccountPaymentData=function(a){var n=e.defer(),o="/staff/payments/payment.json?account_id="+a;return t.getJSON(o).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchContactInformationAndMandatoryFields=function(t){var a=e.defer(),n={};return e.when().then(function(){return i.fetchContactInformation(t).then(function(e){n=e})}).then(function(){return i.fetchContactInformationMandatoryFields().then(function(e){n.mandatoryFields=e})}).then(function(){a.resolve(n)},function(e){a.reject(e)}),a.promise},this.fetchCommissionDetail=function(){var a=e.defer(),n=" /api/hotel_settings/default_agent_commission_details";return t.getJSON(n).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.fetchCommissionDetailsAndMandatoryFields=function(){var t=e.defer(),a={};return e.when().then(function(){return i.fetchCommissionDetail().then(function(e){a=e})}).then(function(){return i.fetchContactInformationMandatoryFields().then(function(e){a.mandatoryFields=e})}).then(function(){t.resolve(a)},function(e){t.reject(e)}),t.promise},this.fetchMultiProperties=function(a){var n=e.defer(),o="/api/accounts/"+a.accountId+"/subscribed_properties";return t.getJSON(o).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise};var s=[];this.fetchCountryList=function(){var a=e.defer(),n="/ui/country_list";return s.length?a.resolve(s):t.getJSON(n).then(function(e){s=e,a.resolve(e)},function(e){a.reject(e)}),a.promise},this.saveContactInformation=function(a){var n,o,i=e.defer(),s="api/accounts/save.json",c=parseInt(a.id,10),u=_.omit(a,["workstation_id"]),l={data:u,deferred:i};return r[c]=r[c]||[],n=r[c],(o=n.find(function(e){return angular.equals(e.data,u)&&!e.resolved}))?o.deferred.promise:(n.push(l),t.postJSON(s,a).then(function(e){l.resolved=!0,i.resolve(e)},function(e){l.resolved=!0,i.reject(e)}),i.promise)},this.fetchRates=function(a){var n=e.defer(),o="/api/rates/contract_rates";return t.getJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.replaceCard=function(a){var n={old:{type:a.cardType},new:{type:a.cardType,id:a.id,use_card_rate:a.useCardRate},change_all_reservations:a.future},o=e.defer(),r="/api/reservations/"+a.reservation+"/cards/replace";return t.putJSON(r,n).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.removeCard=function(a){var n={type:a.cardType,id:a.cardId},o=e.defer(),r="/api/reservations/"+a.reservation+"/cards/remove";return t.deleteJSON(r,n).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.fetchArAccountDetails=function(n){var r=n.id,i=e.defer(),s="/api/accounts/"+r+"/ar_details";if(!a.companyTaArDetailsCached[r]||a.companyTaArDetailsCached[r].expiry&&Date.now()>a.companyTaArDetailsCached[r].expiry)a.companyTaArDetailsCached[r]=i,t.getJSON(s).then(function(e){a.companyTaArDetailsCached[r]={response:e,expiry:Date.now()+o},i.resolve(e)},function(e){i.reject(e)});else{if(!a.companyTaArDetailsCached[r].response)return a.companyTaArDetailsCached[r].promise;i.resolve(a.companyTaArDetailsCached[r].response)}return i.promise},this.fetchArAccountNotes=function(n){var r=n.id,i=e.defer(),s="/api/accounts/"+r+"/ar_notes";if(!a.companyTaNotes[r]||a.companyTaNotes[r].expiry&&Date.now()>a.companyTaNotes[r].expiry)a.companyTaNotes[r]=i,t.getJSON(s).then(function(e){a.companyTaNotes[r]={response:e,expiry:Date.now()+o},i.resolve(e)},function(e){i.reject(e)});else{if(!a.companyTaNotes[r].response)return a.companyTaNotes[r].promise;i.resolve(a.companyTaNotes[r].response)}return i.promise},this.saveARNote=function(n){var o=e.defer(),r="/api/accounts/save_ar_note",i=n.id;return t.postJSON(r,n).then(function(e){a.companyTaNotes[i]=null,o.resolve(e)},function(e){o.reject(e)}),o.promise},this.saveARDetails=function(n){var o=e.defer(),r="api/accounts/save_ar_details",i=n.id;return t.postJSON(r,n).then(function(e){a.companyTaArDetailsCached[i]=null,o.resolve(e)},function(e){o.reject(e)}),o.promise},this.deleteARNote=function(n){var o=e.defer(),r="/api/accounts/delete_ar_note",i=n.id;return t.postJSON(r,n).then(function(e){a.companyTaNotes[i]=null,o.resolve(e)},function(e){o.reject(e)}),o.promise},this.deleteArAccount=function(n){var o=n.id,r=e.defer(),i="api/accounts/"+o+"/delete_ar_detail";return t.deleteJSON(i).then(function(e){a.companyTaArDetailsCached[o]=null,r.resolve(e)},function(e){r.reject(e)}),r.promise},this.fetchArAccountsList=function(a){var n=e.defer(),o="/api/accounts/"+a.id+"/ar_transactions?paid="+a.paid+"&from_date="+a.from_date+"&to_date="+a.to_date+"&query="+a.query+"&page="+a.page_no+"&per_page="+a.per_page+"&transaction_type="+a.transaction_type;return t.getJSON(o).then(function(e){e.ar_transactions&&e.ar_transactions.length>0&&angular.forEach(e.ar_transactions,function(e){"DEBIT"===e.transaction_type&&(e.active=!1)}),n.resolve(e)},function(e){n.reject(e)}),n.promise},this.addCreditAmount=function(a){var n=e.defer(),o="api/accounts/"+a.id+"/ar_transactions";return t.postJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.payForReservation=function(a){var n=e.defer(),o="api/accounts/"+a.id+"/ar_transactions/"+a.transaction_id+"/pay";return t.postJSON(o).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.openForReservation=function(a){var n=e.defer(),o="api/accounts/"+a.id+"/ar_transactions/"+a.transaction_id+"/open";return t.postJSON(o).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.payAll=function(a){var n=e.defer(),o="api/accounts/"+a.id+"/ar_transactions/pay_all";return t.postJSON(o).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},a.fetchHotelLoyaltiesHlps=function(){var a=e.defer(),o="/staff/user_memberships/get_available_hlps.json";return n.fetchHotelLoyaltiesHlps?a.resolve(n.fetchHotelLoyaltiesHlps):t.getJSON(o).then(function(e){n.fetchHotelLoyaltiesHlps=e,a.resolve(e)},function(e){a.reject(e)}),a.promise},a.fetchHotelLoyaltiesFfp=function(){var a=e.defer(),o="/staff/user_memberships/get_available_ffps.json";return n.fetchHotelLoyaltiesFfp?a.resolve(n.fetchHotelLoyaltiesFfp):t.getJSON(o).then(function(e){n.fetchHotelLoyaltiesFfp=e,a.resolve(e)},function(e){a.reject(e)}),a.promise},this.fetchTACommissionDetails=function(a){var n=e.defer(),o=" api/accounts/"+a.accountId+"/commission_details";return t.getJSON(o,a.params).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.saveTACommissionDetails=function(a){var n=e.defer(),o={};o.reservations=a.commissionDetails;var r="api/accounts/"+a.accountId+"/save_commission_details";return t.postJSON(r,o).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchTransactionDetails=function(a){var n=e.defer(),o=" /api/bills/"+a.bill_id+"/transactions";return t.getJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchArStatementPrintData=function(a){var n=e.defer(),o="/api/ar_transactions/print";return t.postJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.emailArStatement=function(a){var n=e.defer(),o="/api/ar_transactions/email";return t.postJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchArStatementData=function(a){var n=e.defer(),o="/api/ar_transactions/get_email?id="+a.id;return t.getJSON(o).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.groupChargeDetailsFetch=function(a){var n=e.defer(),o="/staff/reservation/transaction_details";return t.getJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.recalculateCommission=function(a){var n=e.defer(),o="/api/reservations/recalculate_commission_details";return t.postJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchCompanyTravelAgentStatisticsSummary=function(a){var n=e.defer(),o="/api/accounts/"+a.accountId+"/statistics?view=SUMMARY";return delete a.accountId,t.getJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchCompanyTravelAgentStatisticsDetails=function(a){var n=e.defer(),o="/api/accounts/"+a.accountId+"/statistics?view=DETAILED";return delete a.accountId,t.getJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchCompanyTravelAgentMonthlyReservations=function(a){var n=e.defer(),o="/api/accounts/"+a.accountId+"/statistics?view=RESERVATIONS";return delete a.accountId,t.getJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.verifyTravelAgentCompanyCardMerge=function(a){var n=e.defer(),o="/api/accounts/validate_card_merge";return t.postJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.mergeCards=function(a){var n=e.defer(),o="/api/accounts/merge_cards";return t.postJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise}}]),angular.module("sntRover").service("RVPaymentSrv",["$http","$q","RVBaseWebSrv","rvBaseWebSrvV2","$rootScope","sntBaseWebSrv",function(e,t,a,n,o,r){var i={PAYMENT_TYPES:{}};this.renderPaymentScreen=function(e){var n=t.defer(),o="/staff/payments/addNewPayment.json",r=angular.toJson(e||"default");return i.PAYMENT_TYPES[r]?n.resolve(i.PAYMENT_TYPES[r]):a.getJSON(o,e).then(function(e){i.PAYMENT_TYPES[r]=e,n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchAvailPayments=function(e){var n=t.defer(),o="/staff/payments/addNewPayment.json";return a.getJSON(o,e).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.savePaymentDetails=function(e){var n=t.defer(),o="staff/reservation/save_payment";return a.postJSON(o,e).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.saveGuestPaymentDetails=function(e){var n=t.defer(),o="staff/payments/save_new_payment";return a.postJSON(o,e).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.setAsPrimary=function(e){var n=t.defer(),o="/staff/payments/setCreditAsPrimary";return a.postJSON(o,e).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.deletePayment=function(e){var n=t.defer(),o="/staff/payments/deleteCreditCard";return a.postJSON(o,e).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.getPaymentList=function(e){var n=t.defer(),o="/staff/staycards/get_credit_cards.json?reservation_id="+e;return a.getJSON(o).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.getReceiptsList=function(e){var a=t.defer(),o="/api/bills/payment_receipts";return n.getJSON(o,e).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.getExistingPaymentsForBill=function(e){var n=t.defer(),o="/staff/staycards/get_credit_cards.json";return a.getJSON(o,e).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.mapPaymentToReservation=function(e){var n=t.defer(),o="/staff/reservation/link_payment";return a.postJSON(o,e).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.submitPaymentOnBill=function(e){var a=0,r=function(){a++},i=setInterval(r,1e3),s=t.defer(),c="api/reservations/"+e.reservation_id+"/submit_payment",u=function(e){if(a>=o.emvTimeout){var t=["Request timed out. Unable to process the transaction"];s.reject(t)}else n.getJSONWithSpecialStatusHandling(e).then(function(t){t.status&&"processing_not_completed"===t.status||"null"===t?setTimeout(function(){console.info("POLLING::-> for emv terminal response"),u(e)},5e3):(clearInterval(i),s.resolve(t))},function(t){"undefined"==typeof t?u(e):(clearInterval(i),s.reject(t))})};return n.postJSONWithSpecialStatusHandling(c,e.postData).then(function(t){e.postData.is_emv_request&&t.status&&"processing_not_completed"===t.status?u(t.location_header):(clearInterval(i),s.resolve(t))},function(e){clearInterval(i),s.reject(e)}),s.promise},this.makePaymentOnDepositBalance=function(e){var n=t.defer(),o="staff/reservation/post_payment";return a.postJSON(o,e).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.chipAndPinGetToken=function(e){var a=0,r=function(){a++},i=setInterval(r,1e3),s=t.defer(),c="/api/cc/get_token.json",u=function(e){if(a>=o.emvTimeout){var t=["Request timed out. Unable to process the transaction"];s.reject(t)}else n.getJSONWithSpecialStatusHandling(e).then(function(t){t.status&&"processing_not_completed"===t.status||"null"===t?setTimeout(function(){console.info("POLLING::-> for emv terminal response"),u(e)},5e3):(clearInterval(i),s.resolve(t))},function(t){"undefined"==typeof t?u(e):(clearInterval(i),s.reject(t))})};return n.postJSONWithSpecialStatusHandling(c,e).then(function(e){e.status&&"processing_not_completed"===e.status?u(e.location_header):(clearInterval(i),s.resolve(e))},function(e){clearInterval(i),s.reject(e)}),s.promise},this.deleteCreditCard=function(e){var a=t.defer(),n="api/reservations/"+e.reservation_id+"/delete_credit_card";return delete e.reservation_id,r.postJSON(n,e).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise}}]),angular.module("sntRover").service("rvAccountsArTransactionsSrv",["$q","rvBaseWebSrvV2",function(e,t){this.fetchTransactionDetails=function(a){var n=e.defer(),o="/api/accounts/"+a.account_id+"/ar_transactions";return t.getJSON(o,a.getParams).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchBillPrintData=function(a){var n=e.defer(),o="/api/accounts/"+a.account_id+"/ar_transactions/"+a.id+"/print_ar_invoice";return t.postJSON(o,a).then(function(e){e.charge_details_list=[],e.credit_details_list=[],angular.forEach(e.fee_details,function(t,a){angular.forEach(t.charge_details,function(a,n){a.date=t.date,e.charge_details_list.push(a)}),angular.forEach(t.credit_details,function(a,n){a.date=t.date,e.credit_details_list.push(a)})}),n.resolve(e)},function(e){n.reject(e)}),n.promise},this.sendEmail=function(a){var n=e.defer(),o="/api/accounts/"+a.account_id+"/ar_transactions/"+a.id+"/email_ar_invoice";return t.postJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.saveArBalance=function(a){var n=e.defer(),o="/api/accounts/"+a.account_id+"/ar_transactions/create_manual_balances";return t.postJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchPaymentMethods=function(a){var n=e.defer(),o="api/accounts/"+a.id+"/ar_transactions/payments_for_allocation";return t.getJSON(o).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.paySelected=function(a){var n=e.defer(),o="/api/accounts/"+a.account_id+"/ar_transactions/allocate_payment";return t.postJSON(o,a.data).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.holdSelectedInvoices=function(a){var n=e.defer(),o="/api/accounts/"+a.account_id+"/ar_transactions/add_hold";return t.putJSON(o,a.data).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.releaseSelectedInvoices=function(a){var n=e.defer(),o="/api/accounts/"+a.account_id+"/ar_transactions/release_hold";return t.putJSON(o,a.data).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.expandPaidAndUnpaidList=function(a){var n=e.defer(),o="/api/accounts/"+a.account_id+"/ar_transactions/"+a.id+"/invoice_details";return t.getJSON(o).then(function(e){n.resolve(e.data)},function(e){n.reject(e)}),n.promise},this.fetchArStatementData=function(a){var n=e.defer(),o="/api/ar_transactions/get_email?id="+a.id;return t.getJSON(o).then(function(e){n.resolve(e.data)},function(e){n.reject(e)}),n.promise},this.fetchArStatementPrintData=function(a){var n=e.defer(),o="/api/ar_transactions/print";return t.postJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.emailArStatement=function(a){var n=e.defer(),o="/api/ar_transactions/email";return t.postJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.expandPaidAndUnpaidList=function(a){var n=e.defer(),o="/api/accounts/"+a.account_id+"/ar_transactions/"+a.id+"/invoice_details";return t.getJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.expandAllocateAndUnallocatedList=function(a){var n=e.defer(),o="/api/accounts/"+a.account_id+"/ar_transactions/"+a.id+"/payment_details";return t.getJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.getUnAllocateDetails=function(a){var n=e.defer(),o="/api/accounts/"+a.account_id+"/ar_transactions/"+a.id+"/payment_details";return t.getJSON(o).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.unAllocateSelectedPayment=function(a){var n=e.defer(),o="/api/accounts/"+a.account_id+"/ar_transactions/unallocate_payment";return t.postJSON(o,a.data).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.unAllocateData=function(a){var n=e.defer(),o="/api/accounts/"+a.account_id+"/ar_transactions/unallocate_info";return t.getJSON(o,a.data).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchAccountsReceivables=function(a){var n=e.defer(),o="/api/accounts/ar_overview";return t.getJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.moveInvoice=function(a){var n=e.defer(),o="/api/accounts/"+a.account_id+"/ar_transactions/move_invoice";return t.postJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.getAdjustmentInfo=function(a){var n=e.defer(),o="api/accounts/"+a.accountId+"/ar_transactions/"+a.arTransactionId+"/adjustment_info";return t.postJSON(o,a.requestParams).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.postAdjustmentInfo=function(a){var n=e.defer(),o="api/accounts/"+a.accountId+"/ar_transactions/"+a.arTransactionId+"/post_adjustment";return t.postJSON(o,a.postData).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.moveToCreditInvoice=function(a){var n=e.defer(),o="/api/accounts/"+a.account_id+"/ar_transactions/post_manual_credit";return t.postJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.lockBill=function(a){var n=e.defer(),o="/api/accounts/"+a.account_id+"/ar_transactions/"+a.id+"/ar_final_invoice_settlement";return t.postJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.moveZeroInvoiceAsPaid=function(a){var n=e.defer(),o="/api/accounts/"+a.account_id+"/ar_transactions/move_zero_invoices_as_paid";return t.postJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise}}]),angular.module("sntRover").service("rvAccountsConfigurationSrv",["$q","rvBaseWebSrvV2",function(e,t){var a=this;this.baseAccountSummaryData={posting_account_id:"",posting_account_name:"",posting_account_number:"",posting_account_type:"HOUSE",posting_account_status:"OPEN",demographics:{market_segment_id:"",source_id:"",booking_origin_id:""},notes:[],travel_agent:null,company:null},this.getAccountSummary=function(n){var o=e.defer();if("NEW_ACCOUNT"===n.accountId)o.resolve(angular.copy(a.baseAccountSummaryData));else{var r="api/posting_accounts/"+n.accountId;t.getJSON(r).then(function(e){o.resolve(e)},function(e){o.reject(e)})}return o.promise},this.updateAccountSummary=function(a){var n=e.defer(),o="api/posting_accounts/"+a.summary.posting_account_id;return t.putJSON(o,a.summary).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.updateBillingRefNumber=function(a){var n=e.defer(),o="api/posting_accounts/"+a.summary.posting_account_id;return a.summary.custom_reference_number=a.custom_reference_number,t.putJSON(o,a.summary).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.saveAccountSummary=function(a){var n=e.defer(),o="api/posting_accounts";return t.postJSON(o,a.summary).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.saveAccountNote=function(a){var n=e.defer(),o="api/posting_accounts/save_posting_account_note";return t.postJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.updateAccountNote=function(a){var n=e.defer(),o="api/notes/"+a.id;return t.putJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.removeAccountNote=function(a){var n=e.defer(),o="api/posting_accounts/delete_posting_account_note";return t.deleteJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.emailInvoice=function(a){var n=e.defer(),o="api/posting_accounts/email_bill_card";return t.postJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise}}]),angular.module("sntRover").service("rvAccountsSrv",["$q","rvBaseWebSrvV2",function(e,t){this.DEFAULT_PER_PAGE=50,this.DEFAULT_PAGE=1,this.getAccountsList=function(a){var n=e.defer(),o="/api/posting_accounts/search",r={q:a.query,status:a.status,per_page:a.per_page,page:a.page,account_type:a.account_type,is_non_zero:a.is_non_zero};return t.getJSON(o,r).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise}}]),angular.module("sntRover").service("rvAccountTransactionsSrv",["$q","rvBaseWebSrvV2","$rootScope",function(e,t,a){this.fetchGroupAllowances=function(e){const a="/api/groups/"+e.id+"/group_allowance_transactions";return t.getJSON(a,{associated_type:e.type}).then(function(e){var t={dataByAllowance:[],dataByDate:[]};e.allowance_data=_.map(e.allowance_data,function(e){return e.ptime=parseInt(e.time.replace(":",""),10),e});try{e.allowance_data&&e.allowance_data.length&&(t.dataByAllowance=_.groupBy(e.allowance_data,function(e){return e.addon_id}),t.dataByDate=_.groupBy(e.allowance_data,function(e){return e.date}),_.each(t.dataByAllowance,function(e,a){t.dataByAllowance[a]=_.sortBy(e,function(e){return e.ptime})}),_.each(t.dataByDate,function(e,a){t.dataByDate[a]=_.sortBy(e,function(e){return e.ptime})}))}catch(e){console.error(e)}return t},function(){})},this.searchAllowanceShares=function(a){var n=e.defer(),o="/api/groups/"+a.groupId+"/group_allowance_search";return t.getJSON(o,{query:a.query,associated_type:a.type}).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.saveAllowanceShares=function(a){var n=e.defer(),o="/api/groups/"+a.groupId+"/group_allowance_share";return t.postJSON(o,{shared_allowances:a.data,associated_type:a.type}).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchTransactionDetails=function(a){var n=e.defer(),o="/api/posting_accounts/"+a.account_id+"/bill_card";return t.getJSON(o).then(function(e){angular.forEach(e.bills,function(e){e.page_no=1,e.transactions=[],e.activeDate=e.days.length>0?_.last(e.days).date:null}),n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchBillTransactionDetails=function(a){var n=e.defer(),o="/api/bills/"+a.bill_id+"/transactions?date="+a.date+"&page="+a.page+"&per_page="+a.per_page;return t.getJSON(o).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.createAnotherBill=function(a){var n=e.defer(),o="api/bills/create_bill";return t.postJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.moveToAnotherBill=function(a){var n=e.defer(),o="api/bills/transfer_transaction";return t.postJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.transactionEdit=function(a){var n=e.defer(),o=a.id,r=a.updatedDate,i="api/financial_transactions/"+o;return t.putJSON(i,r).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.transactionEditChargeDescription=function(a){var n=e.defer(),o="api/financial_transactions/"+a.id+"/save_custom_description";return t.postJSON(o,a.postData).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.transactionDelete=function(a){var n=e.defer(),o=a.id,r="api/financial_transactions/"+o;return t.putJSON(r,a.data).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.transactionSplit=function(a){var n=e.defer(),o=a.id,r="api/financial_transactions/"+o;return t.putJSON(r,a.data).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.savePaymentDetails=function(a){var n=e.defer(),o="/api/bills/"+a.bill_id+"/add_payment_method";return t.postJSON(o,a.data_to_pass).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.submitPaymentOnBill=function(n){var o=0,r=function(){o++},i=setInterval(r,1e3),s=e.defer(),c="/api/bills/"+n.bill_id+"/submit_payment",u=function(e){if(o>=a.emvTimeout){var n=["Request timed out. Unable to process the transaction"];s.reject(n)}else t.getJSONWithSpecialStatusHandling(e).then(function(t){t.status&&"processing_not_completed"===t.status||"null"===t?setTimeout(function(){console.info("POLLING::-> for emv terminal response"),u(e)},5e3):(clearInterval(i),s.resolve(t))},function(t){"undefined"==typeof t?u(e):(clearInterval(i),s.reject(t))})};return t.postJSONWithSpecialStatusHandling(c,n.data_to_pass).then(function(e){n.data_to_pass.is_emv_request&&e.status&&"processing_not_completed"===e.status?u(e.location_header):(clearInterval(i),s.resolve(e))},function(e){clearInterval(i),s.reject(e)}),s.promise},this.postCharges=function(a){var n=e.defer(),o="/staff/items/post_items_to_bill";return t.postJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.checkForArAccount=function(a){var n=e.defer(),o="/api/posting_accounts/"+a.account_id+"/check_ar_account_attached";return t.getJSON(o).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchAccountBillsForPrint=function(a){var n=e.defer(),o="/api/posting_accounts/print_bill_card";return t.postJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.groupChargeDetailsFetch=function(a){var n=e.defer(),o="/api/posting_accounts/transaction_details";return t.getJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise}}]),angular.module("sntRover").service("RVReservationBaseSearchSrv",["$q","rvBaseWebSrvV2","sntBaseWebSrv","dateFilter",function(e,t,a,n){var o=this;this.reservation={settings:{},roomTypes:{},businessDate:{}},this.rateDetailsList={},this.cache={config:{lifeSpan:3600},responses:{restrictionTypes:null,rateDetails:null,sortOrder:null,taxMeta:null,customMeta:null}},this.getRoomRatesDefaultView=function(){var e="ROOM_TYPE";return o.reservation.settings&&o.reservation.settings.default_rate_display_name&&("Recommended"===o.reservation.settings.default_rate_display_name?e="RECOMMENDED":"By Rate"===o.reservation.settings.default_rate_display_name&&(e="RATE")),e},this.getRoomTypeLevel=function(e){var t=-1;if(o.reservation.roomTypes){var a=_.find(o.reservation.roomTypes,{id:e});t=a.level}return t},this.timeSlots=[{value:"12:00 AM",label:"12:00 AM",fullDayValue:0},{value:"12:15 AM",label:"12:15 AM",fullDayValue:15},{value:"12:30 AM",label:"12:30 AM",fullDayValue:30},{value:"12:45 AM",label:"12:45 AM",fullDayValue:45},{value:"01:00 AM",label:"01:00 AM",
fullDayValue:100},{value:"01:15 AM",label:"01:15 AM",fullDayValue:115},{value:"01:30 AM",label:"01:30 AM",fullDayValue:130},{value:"01:45 AM",label:"01:45 AM",fullDayValue:145},{value:"02:00 AM",label:"02:00 AM",fullDayValue:200},{value:"02:15 AM",label:"02:15 AM",fullDayValue:215},{value:"02:30 AM",label:"02:30 AM",fullDayValue:230},{value:"02:45 AM",label:"02:45 AM",fullDayValue:245},{value:"03:00 AM",label:"03:00 AM",fullDayValue:300},{value:"03:15 AM",label:"03:15 AM",fullDayValue:315},{value:"03:30 AM",label:"03:30 AM",fullDayValue:330},{value:"03:45 AM",label:"03:45 AM",fullDayValue:345},{value:"04:00 AM",label:"04:00 AM",fullDayValue:400},{value:"04:15 AM",label:"04:15 AM",fullDayValue:415},{value:"04:30 AM",label:"04:30 AM",fullDayValue:430},{value:"04:45 AM",label:"04:45 AM",fullDayValue:445},{value:"05:00 AM",label:"05:00 AM",fullDayValue:500},{value:"05:15 AM",label:"05:15 AM",fullDayValue:515},{value:"05:30 AM",label:"05:30 AM",fullDayValue:530},{value:"05:45 AM",label:"05:45 AM",fullDayValue:545},{value:"06:00 AM",label:"06:00 AM",fullDayValue:600},{value:"06:15 AM",label:"06:15 AM",fullDayValue:615},{value:"06:30 AM",label:"06:30 AM",fullDayValue:630},{value:"06:45 AM",label:"06:45 AM",fullDayValue:645},{value:"07:00 AM",label:"07:00 AM",fullDayValue:700},{value:"07:15 AM",label:"07:15 AM",fullDayValue:715},{value:"07:30 AM",label:"07:30 AM",fullDayValue:730},{value:"07:45 AM",label:"07:45 AM",fullDayValue:745},{value:"08:00 AM",label:"08:00 AM",fullDayValue:800},{value:"08:15 AM",label:"08:15 AM",fullDayValue:815},{value:"08:30 AM",label:"08:30 AM",fullDayValue:830},{value:"08:45 AM",label:"08:45 AM",fullDayValue:845},{value:"09:00 AM",label:"09:00 AM",fullDayValue:900},{value:"09:15 AM",label:"09:15 AM",fullDayValue:915},{value:"09:30 AM",label:"09:30 AM",fullDayValue:930},{value:"09:45 AM",label:"09:45 AM",fullDayValue:945},{value:"10:00 AM",label:"10:00 AM",fullDayValue:1e3},{value:"10:15 AM",label:"10:15 AM",fullDayValue:1015},{value:"10:30 AM",label:"10:30 AM",fullDayValue:1030},{value:"10:45 AM",label:"10:45 AM",fullDayValue:1045},{value:"11:00 AM",label:"11:00 AM",fullDayValue:1100},{value:"11:15 AM",label:"11:15 AM",fullDayValue:1115},{value:"11:30 AM",label:"11:30 AM",fullDayValue:1130},{value:"11:45 AM",label:"11:45 AM",fullDayValue:1145},{value:"12:00 PM",label:"12:00 PM",fullDayValue:1200},{value:"12:15 PM",label:"12:15 PM",fullDayValue:1215},{value:"12:30 PM",label:"12:30 PM",fullDayValue:1230},{value:"12:45 PM",label:"12:45 PM",fullDayValue:1245},{value:"01:00 PM",label:"01:00 PM",fullDayValue:1300},{value:"01:15 PM",label:"01:15 PM",fullDayValue:1315},{value:"01:30 PM",label:"01:30 PM",fullDayValue:1330},{value:"01:45 PM",label:"01:45 PM",fullDayValue:1345},{value:"02:00 PM",label:"02:00 PM",fullDayValue:1400},{value:"02:15 PM",label:"02:15 PM",fullDayValue:1415},{value:"02:30 PM",label:"02:30 PM",fullDayValue:1430},{value:"02:45 PM",label:"02:45 PM",fullDayValue:1445},{value:"03:00 PM",label:"03:00 PM",fullDayValue:1500},{value:"03:15 PM",label:"03:15 PM",fullDayValue:1515},{value:"03:30 PM",label:"03:30 PM",fullDayValue:1530},{value:"03:45 PM",label:"03:45 PM",fullDayValue:1545},{value:"04:00 PM",label:"04:00 PM",fullDayValue:1600},{value:"04:15 PM",label:"04:15 PM",fullDayValue:1615},{value:"04:30 PM",label:"04:30 PM",fullDayValue:1630},{value:"04:45 AM",label:"04:45 PM",fullDayValue:1645},{value:"05:00 PM",label:"05:00 PM",fullDayValue:1700},{value:"05:15 PM",label:"05:15 PM",fullDayValue:1715},{value:"05:30 PM",label:"05:30 PM",fullDayValue:1730},{value:"05:45 PM",label:"05:45 PM",fullDayValue:1745},{value:"06:00 PM",label:"06:00 PM",fullDayValue:1800},{value:"06:15 PM",label:"06:15 PM",fullDayValue:1815},{value:"06:30 PM",label:"06:30 PM",fullDayValue:1830},{value:"06:45 PM",label:"06:45 PM",fullDayValue:1845},{value:"07:00 PM",label:"07:00 PM",fullDayValue:1900},{value:"07:15 PM",label:"07:15 PM",fullDayValue:1915},{value:"07:30 PM",label:"07:30 PM",fullDayValue:1930},{value:"07:45 PM",label:"07:45 PM",fullDayValue:1945},{value:"08:00 PM",label:"08:00 PM",fullDayValue:2e3},{value:"08:15 PM",label:"08:15 PM",fullDayValue:2015},{value:"08:30 PM",label:"08:30 PM",fullDayValue:2030},{value:"08:45 PM",label:"08:45 PM",fullDayValue:2045},{value:"09:00 PM",label:"09:00 PM",fullDayValue:2100},{value:"09:15 PM",label:"09:15 PM",fullDayValue:2115},{value:"09:30 PM",label:"09:30 PM",fullDayValue:2130},{value:"09:45 PM",label:"09:45 PM",fullDayValue:2145},{value:"10:00 PM",label:"10:00 PM",fullDayValue:2200},{value:"10:15 PM",label:"10:15 PM",fullDayValue:2215},{value:"10:30 PM",label:"10:30 PM",fullDayValue:2230},{value:"10:45 PM",label:"10:45 PM",fullDayValue:2245},{value:"11:00 PM",label:"11:00 PM",fullDayValue:2300},{value:"11:15 PM",label:"11:15 PM",fullDayValue:2315},{value:"11:30 PM",label:"11:30 PM",fullDayValue:2330},{value:"11:45 PM",label:"11:45 PM",fullDayValue:2345}],this.fetchBaseSearchData=function(){var a=e.defer();if(o.fetchBussinessDate=function(){var e="/api/business_dates/active";return t.getJSON(e).then(function(e){o.reservation.businessDate=e.business_date,a.resolve(o.reservation)},function(e){a.reject(e)}),a.promise},o.fetchRoomTypes=function(){var e="api/room_types.json?exclude_pseudo=true&per_page=100";return t.getJSON(e).then(function(e){o.reservation.roomTypes=e.results,o.fetchBussinessDate()},function(e){a.reject(e)}),a.promise},isEmpty(o.reservation.settings)&&isEmpty(o.reservation.roomTypes)&&isEmpty(o.reservation.businessDate)){var n="/api/hotel_settings/show_hotel_reservation_settings";t.getJSON(n).then(function(e){o.reservation.settings=e,o.fetchRoomTypes()},function(e){a.reject(e)})}else a.resolve(o.reservation);return a.promise},this.fetchCompanyCard=function(a){var n=e.defer(),o="/api/accounts";return t.getJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.autoCompleteCodes=function(a){var n=e.defer(),o="/api/code_search";return t.getJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchCurrentTime=function(a){var n=e.defer(),o="/api/hotel_current_time";return t.getJSON(o).then(function(e){a&&"string"==typeof a&&(e.hotel_time.date=a),n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchAvailability=function(a){var n=e.defer(),o="/api/availability?from_date="+a.from_date+"&to_date="+a.to_date+"&override_restrictions=true";return a.company_id&&(o+="&company_id="+a.company_id),a.travel_agent_id&&(o+="&travel_agent_id="+a.travel_agent_id),a.group_id&&(o+="&group_id="+a.group_id),a.promotion_code&&(o+="&promotion_code="+encodeURI(a.promotion_code)),a.allotment_id&&(o+="&allotment_id="+encodeURI(a.allotment_id)),t.getJSON(o).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchMinTime=function(){var a=e.defer(),n="/api/hourly_rate_min_hours";return t.getJSON(n).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.fetchSortPreferences=function(){var a=e.defer(),n="/api/sort_preferences/list_selections";return null===o.cache.responses.sortOrder||Date.now()>o.cache.responses.sortOrder.expiryDate?t.getJSON(n).then(function(e){o.cache.responses.sortOrder={data:e.room_rates,expiryDate:Date.now()+1e3*o.cache.config.lifeSpan},a.resolve(e.room_rates)},function(e){a.reject(e)}):a.resolve(o.cache.responses.sortOrder.data),a.promise},this.fetchAddonsForRates=function(a){var n=e.defer(),o="/api/addons/rate_addons";return t.getJSON(o,a).then(function(e){n.resolve(e.rate_addons)},function(e){n.reject(e)}),n.promise},this.hasAnyConfiguredAddons=function(a){var n=e.defer(),o="/api/addons/configured";return t.getJSON(o,a).then(function(e){n.resolve(e.addons_configured)},function(e){n.reject(e)}),n.promise},this.getActivePromotions=function(){var a=e.defer(),n="/api/promotions?is_active=true";return t.getJSON(n).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.fetchUserMemberships=function(a){var n=e.defer(),o="/staff/user_memberships.json?user_id="+a;return t.getJSON(o).then(function(e){n.resolve(e.data)},function(e){n.reject(e)}),n.promise},this.checkOverbooking=function(a){var n=e.defer(),o="/api/availability/overbooking_check";return t.getJSON(o,a).then(function(e){n.resolve(e.results)},function(e){n.reject(e)}),n.promise},this.checkDiaryAvailability=function(a){var n=e.defer(),o="/api/nightly_diary/availability";return t.postJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchOrdinaryRates=function(a){var n=e.defer(),o="/api/availability/rates";return t.getJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchContractRates=function(a){var n=e.defer(),o="/api/availability/contracts";return t.getJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchGroupRates=function(a){var n=e.defer(),o=a.group_id||a.allotment_id,r="/api/availability/groups/"+o;return t.getJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchRates=function(t){var a=e.defer(),n=[];return o.rates=[],t.group_id?n.push(o.fetchGroupRates(t).then(function(e){_.each(e.rates,function(e){null===e.id&&(e.id="_CUSTOM_"+t.group_id)}),o.rates=o.rates.concat(e.rates)})):(n.push(o.fetchOrdinaryRates(t).then(function(e){o.rates=o.rates.concat(e.rates)})),(t.company_id||t.travel_agent_id)&&n.push(o.fetchContractRates(t).then(function(e){_.each(e.rates,function(e){e.isCorporate=!0}),o.rates=o.rates.concat(e.rates)}))),e.all(n).then(function(){a.resolve(o.rates)},function(e){a.reject(e)}),a.promise},this.fetchRestricitonTypes=function(){var a=e.defer(),n="/api/restriction_types";return null===o.cache.responses.restrictionTypes||Date.now()>o.cache.responses.restrictionTypes.expiryDate?t.getJSON(n).then(function(e){e.results.push({id:98,value:"INVALID_PROMO",description:"PROMOTION INVALID",activated:!0}),e.results.push({id:99,activated:!0,value:"HOUSE_FULL",description:"NO HOUSE AVAILABILITY"});var t={};_.each(e.results,function(e){t[e.id]={key:e.value,value:["CLOSED","CLOSED_ARRIVAL","CLOSED_DEPARTURE","HOUSE_FULL","INVALID_PROMO"].indexOf(e.value)>-1?e.description:e.description+":"}}),o.cache.responses.restrictionTypes={data:t,expiryDate:Date.now()+1e3*o.cache.config.lifeSpan},a.resolve(t)},function(e){a.reject(e)}):a.resolve(o.cache.responses.restrictionTypes.data),a.promise};var r=function(e){var t=_.reject(e.rate_ids,function(e){return!!(o.rateDetailsList[e]&&Date.now()<o.rateDetailsList[e].expiryDate)});return t};this.fetchRatesDetails=function(a){var n=r(a),i=e.defer(),s="/api/rates/search.json",c={};return c.rate_ids=n,0===n.length?i.resolve({}):t.postJSON(s,c).then(function(e){_.each(e.results,function(e){o.rateDetailsList[e.id]={expiryDate:Date.now()+1e3*o.cache.config.lifeSpan,details:e}}),i.resolve(e.results)},function(e){i.reject(e)}),i.promise},this.fetchCustomRateConfig=function(){var a=e.defer(),n="api/rates/custom_group_rate_taxes";return null===o.cache.responses.customMeta||Date.now()>o.cache.responses.customMeta.expiryDate?t.getJSON(n).then(function(e){var t=e;o.cache.responses.customMeta={data:t,expiryDate:Date.now()+1e3*o.cache.config.lifeSpan},a.resolve(t)},function(e){a.reject(e)}):a.resolve(o.cache.responses.customMeta.data),a.promise},this.fetchRatesMeta=function(t){var a=e.defer(),n=[];return o["rates-restrictions"]={},n.push(o.fetchRestricitonTypes(t).then(function(e){o["rates-restrictions"].restrictions=e})),n.push(o.fetchCustomRateConfig().then(function(e){o["rates-restrictions"].customRates=e})),e.all(n).then(function(){a.resolve(o["rates-restrictions"])},function(e){a.reject(e)}),a.promise},this.fetchTaxInformation=function(){var a=e.defer(),n="api/rates/tax_information";return null===o.cache.responses.taxMeta||Date.now()>o.cache.responses.taxMeta.expiryDate?t.getJSON(n).then(function(e){var t=e.tax_codes;o.cache.responses.taxMeta={data:t,expiryDate:Date.now()+1e3*o.cache.config.lifeSpan},a.resolve(t)},function(e){a.reject(e)}):a.resolve(o.cache.responses.taxMeta.data),a.promise},this.fetchHouseAvailability=function(a){var n=e.defer(),o="api/availability/house";return t.getJSON(o,a).then(function(e){var t={};_.each(e.results,function(e){t[e.date]=e.availability}),n.resolve(t)},function(e){n.reject(e)}),n.promise},this.fetchHouseRestrictions=function(a){var n=e.defer(),o="/api/availability/house_restrictions";return t.getJSON(o,a).then(function(e){n.resolve(e.restrictions)},function(e){n.reject(e)}),n.promise},this.fetchTaxRateAddonMeta=function(t){var a=e.defer(),n=[];return o.meta={},n.push(o.fetchTaxInformation().then(function(e){o.meta.taxInfo=e})),n.push(o.fetchAddonsForRates(t).then(function(e){o.meta.rateAddons=e})),e.all(n).then(function(){a.resolve(o.meta)},function(e){a.reject(e)}),a.promise},this.fetchHotelReservationSettings=function(){var a=e.defer(),n="/api/hotel_settings/show_hotel_reservation_settings";return t.getJSON(n).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.searchForRates=function(a){var n=e.defer(),o={},r="/api/rates.json?&sort_dir=true&sort_field=rate";return o.query=a.query,o.per_page=25,o.page=1,t.getJSON(r,o).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchRateDetailsForIds=function(a){var n=r(a),i=e.defer(),s="/api/rates/search.json",c={};return c.rate_ids=n,0===n.length?i.resolve({}):t.postJSON(s,c).then(function(e){_.each(e.results,function(e){o.rateDetailsList[e.id]={expiryDate:Date.now()+1e3*o.cache.config.lifeSpan,details:e}});var t=_.difference(a.rate_ids,n);_.each(t,function(t){e.results.push(o.rateDetailsList[t].details)}),i.resolve(e.results)},function(e){i.reject(e)}),i.promise},this.checkTimeBasedAvailabilityAPI=function(t){var n=e.defer(),o="api/availability/time_based_room_type_and_house_avl";return a.postJSON(o,t).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise}}]),angular.module("sntRover").service("RVContactInfoSrv",["$q","RVBaseWebSrv","rvBaseWebSrvV2",function(e,t,a){var n=this;n.saveContactInfo=function(a){var n=e.defer(),o=a.data,r=a.userId,i="/staff/guest_cards/"+r;return t.putJSON(i,o).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},n.createGuest=function(t){var n=e.defer(),o=t.data,r="/api/guest_details";return a.postJSON(r,o).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},n.updateGuest=function(t){var n=e.defer(),o="/api/guest_details/"+t.userId;return t.check_validation_only&&(o+="?check_validation_only=true"),a.putJSON(o,t.data).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},n.fetchGuestLanguages=function(t){var n=e.defer(),o="/api/guest_languages";return a.getJSON(o,t).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},n.removeGuestDetails=function(t){var n=e.defer(),o="/api/guest_details/"+t+"/anonymize";return a.putJSON(o).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},n.getGuestDetailsById=function(t){var n=e.defer(),o="/api/guest_details/"+t;return null===t?n.reject([""]):a.getJSON(o).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},n.parseGuestData=function(e,t){var a={};return a.id=t,a.firstName=e.first_name,a.lastName=e.last_name,a.image=e.image_url,a.vip=e.vip,e.address&&(a.address={},a.address.city=e.address.city,a.address.state=e.address.state,a.address.postalCode=e.address.postal_code),a.stayCount=e.stay_count,a.lastStay={},a.phone=e.home_phone,a.email=e.email,e.last_stay&&(a.lastStay.date=e.last_stay.date,a.lastStay.room=e.last_stay.room,a.lastStay.roomType=e.last_stay.room_type),a},n.deleteGuest=function(t){var n=e.defer(),o="/api/guest_details/"+t;return a.deleteJSON(o).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},n.checkIfCommisionWasRecalculated=function(t){var n=e.defer(),o="/api/reservations/"+t.reservation_id+"/commission_transaction_info";return a.getJSON(o).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise}}]),angular.module("sntRover").service("rvActionTasksSrv",["$q","BaseWebSrvV2","rvUtilSrv","$rootScope","dateFilter","$filter",function(e,t,a,n,o,r){var i=this,s=null,c=[r("translate")("SUNDAY"),r("translate")("MONDAY"),r("translate")("TUESDAY"),r("translate")("WEDNESDAY"),r("translate")("THURSDAY"),r("translate")("FRIDAY"),r("translate")("SATURDAY")];i.searchPerPage=50,i.page=1,i.to_date="",this.getTasksCount=function(a){var n=e.defer(),o="/api/reservations/"+a.id+".json";return t.getJSON(o).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.getActionsTasksList=function(a){var s=e.defer(),c="/api/action_tasks?associated_id="+a.id+"&associated_type=Reservation";return t.getJSON(c).then(function(e){e.data.forEach(function(e){var t,a,i;e.assigned=null!==e.assigned_to,"string"==typeof e.due_at?(a=e.due_at_str.split("T"),e.due_at_time_str=o(a[0]+"T"+a[1].split(/[+-]/)[0],"hh:mm a"),e.due_at_time=o(a[0]+"T"+a[1].split(/[+-]/)[0],"HH:mm"),e.due_at_date=o(a[0],n.dateFormat),e.hasDate=!0):e.hasDate=!1,"COMPLETED"===e.action_status&&(e.isCompleted=!0,t=moment(e.completed_at),i=e.completed_at.split("T"),e.date_completed=t.format(n.dateFormat.toUpperCase()),e.time_completed=t.format("HH:MM:A"),e.completed_date=o(i[0],n.dateFormat)),e.created_at&&(e.created_at_time=r("date")(e.created_at,"hh:mm a"),e.created_at_date=r("date")(e.created_at,n.dateFormat))}),e.action_count=e.data.length,e.pending_action_count=_.countBy(e.data,"completed_at").null,e.pending_action_count=e.pending_action_count||0,e.className=i.getActionsClassName(e.action_count,e.pending_action_count),s.resolve(e)},function(e){s.reject(e)}),s.promise},this.fetchReportDetails=function(a){var n=e.defer(),o="/api/reports/action_manager_report";return t.postJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.getActionsClassName=function(e,t){var a="";return 0===e?"none":a=0===t?"all-completed":e===t?"only-pending":"pending"},this.syncActionCount=function(a){var n=e.defer(),o="/api/action_tasks/sync_with_external_pms?reservation_id="+a;return t.getJSON(o).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.postNewAction=function(a){var n=e.defer(),o="/api/action_tasks.json";return t.postJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.updateNewAction=function(a){var n=e.defer(),o="/api/action_tasks/"+a.action_task.id+".json";return t.putJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.completeAction=function(a){var n=e.defer(),o="/api/action_tasks/"+a.action_task.id;return t.putJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchDepartments=function(){var a=e.defer(),n="admin/departments.json";return null===i.cache.responses.departments||Date.now()>i.cache.responses.departments.expiryDate?t.getJSON(n).then(function(e){i.cache.responses.departments={data:e,expiryDate:Date.now()+1e3*i.cache.config.lifeSpan},a.resolve(e)},function(e){a.reject(e)}):a.resolve(i.cache.responses.departments.data),a.promise},this.fetchGuestInfo=function(a){var n=e.defer();a&&(a.fakeDataToAvoidCache=new Date),i.toDate=void 0===i.toDate?"":i.toDate;var o="search.json?per_page="+i.searchPerPage+"&page="+i.page;return t.getJSON(o,a).then(function(e){e.data.results;if(a.query){var t,o,r,i=a.query.toLowerCase(),s=0;for(var c in e.data.results)e.data.results[c].is_row_visible=!1,e.data.results[c].firstname&&(t=e.data.results[c].firstname.toLowerCase(),t.indexOf(i)!==-1&&(e.data.results[c].is_row_visible=!0,s++)),e.data.results[c].lastname&&(o=e.data.results[c].lastname.toLowerCase(),o.indexOf(i)!==-1&&(e.data.results[c].is_row_visible=!0,s++)),e.data.results[c].room&&(r=e.data.results[c].room.toLowerCase(),r.indexOf(i)!==-1&&(e.data.results[c].is_row_visible=!0,s++))}e.queryTime=a.queryTime,e.visibleRowCount=s,e.querySent=a.query,n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchActions=function(a){var n=e.defer(),o="api/action_tasks/hotel_actions";return t.getJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.getActionDetails=function(a){var n=e.defer(),o="api/action_tasks/"+a;return t.getJSON(o).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchCurrentTime=function(){var n=e.defer(),o="/api/hotel_current_time";return t.getJSON(o).then(function(e){n.resolve(a.roundToNextQuarter(parseInt(e.hotel_time.hh,10),parseInt(e.hotel_time.mm,10)))},function(e){n.reject(e)}),n.promise},this.fetchGroupActions=function(a){var n=e.defer(),o="api/action_tasks/hotel_group_actions";return t.getJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.deleteActionTask=function(a){var n=e.defer(),o="/api/action_tasks/"+a;return t.deleteJSON(o).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.cache={config:{lifeSpan:900},responses:{departments:null}},i.setFilterState=function(e){s=angular.copy(e)},i.getFilterState=function(){return s},i.clearFilterState=function(){s=null},i.getDateFromDate=function(e){var t=new tzIndependentDate(e),a=t.getDay();return c[t.getDay()]||a},i.getTimeFieldValues=function(){return["0000","0015","0030","0045","0100","0115","0130","0145","0200","0215","0230","0245","0300","0315","0330","0345","0400","0415","0430","0445","0500","0515","0530","0545","0600","0615","0630","0645","0700","0715","0730","0745","0800","0815","0830","0845","0900","0915","0930","0945","1000","1015","1030","1045","1100","1115","1130","1145","1200","1215","1230","1245","1300","1315","1330","1345","1400","1415","1430","1445","1500","1515","1530","1545","1600","1615","1630","1645","1700","1715","1730","1745","1800","1815","1830","1845","1900","1915","1930","1945","2000","2015","2030","2045","2100","2115","2130","2145","2200","2215","2230","2245","2300","2315","2330","2345"]}}]),angular.module("sntRover").service("RVDropdownDataSrv",["$q","rvBaseWebSrvV2",function(e,t){var a=[];this.fetchCountryList=function(){var n=e.defer(),o="/ui/country_list";return a.length?n.resolve(a):t.getJSON(o).then(function(e){a=e,n.resolve(e)},function(e){n.reject(e)}),n.promise}}]),angular.module("sntRover").service("RVReservationStateService",[function(){var e=this;e.metaData={rateAddons:[],taxDetails:[]},e.reservationFlags={outsideStaydatesForGroup:!1,borrowForGroups:!1,RATE_CHANGED:!1,RATE_CHANGE_FAILED:!1},e.bookMark={lastPostedRate:null},e.fetchAssociatedAddons=function(t){_.isArray(t)&&(t=t[0]);var a=_.findWhere(e.metaData.rateAddons,{rate_id:t});return a&&a.associated_addons?a.associated_addons:null},e.updateRateAddonsMeta=function(t){if(0===t.length)return!1;var a=_.findWhere(e.metaData.rateAddons,{rate_id:t[0].rateId});a?a[0]=t[0]:e.metaData.rateAddons.push(t[0])},e.getCustomRateModel=function(e,t,a){var n=a&&"ALLOTMENT"===a,o="_CUSTOM_"+e,r=n?"Custom Rate for Allotment "+t:"Custom Rate for Group "+t,i=n?"Custom Allotment Rate":"Custom Group Rate";return{id:o,name:r,description:i,is_suppress_rate_on:!1,is_discount_allowed_on:!0,rate_type:{id:null,name:n?"Allotment Rate":"Group Rate"},deposit_policy:{id:null,name:"",description:""},cancellation_policy:{id:null,name:"",description:""},market_segment:{id:null,name:""},source:{id:null,name:""},is_member:!1,linked_promotion_ids:[]}},e.getAddonAmount=function(e,t,a,n){return"PERSON"===e?t*parseInt(parseInt(a,10)+parseInt(n,10),10):"CHILD"===e?t*parseInt(n,10):"ADULT"===e?t*parseInt(a,10):t},e.calculateRate=function(e,t,a){var n=t>=2?e.double:e.single,o=t>=2?t-2:0;return n+o*e.extra_adult+a*e.child},e.calculateMultiplier=function(e,t,a){var n=1;return"ADULT"===e?n=t:"CHILD"===e?n=a:"PERSON"===e&&(n=parseInt(a,10)+parseInt(t,10)),n},e.getApplicableAddonsCount=function(e,t,a,n,o,r,i,s){var c=function(e,t){return 0===a?t:1===a?t*r:"undefined"!=typeof i&&i?t*parseInt(r/a,10):t*(parseInt(r/a,10)+1)},u=function(e,t){return"create_group"===t||"create_allotment"===t||"group"===t||"allotments"===t?0:e};return"PERSON"===e?c(t,n+u(o,s)):"ADULT"===e?c(t,n):"CHILD"===e?c(t,o):"FLAT"===e||"ROOM"===e?c(t,1):void 0},e.computeBaseAmount=function(t,a,n,o){var r=0,i=0;return _.each(a,function(t){var a=t.is_inclusive,s=_.findWhere(e.metaData.taxDetails,{id:parseInt(t.charge_code_id,10)}),c=s.amount_type,u=e.calculateMultiplier(c,n,o);a&&("%"===s.amount_symbol?r+=u*parseFloat(s.amount):i+=u*parseFloat(s.amount))}),100*t/(100+r)-i},e.setReservationFlag=function(t,a){e.reservationFlags[t]=a},e.getReservationFlag=function(t){return e.reservationFlags[t]},e.shouldPostAddon=function(e,t,a,n,o){if(0===e&&t===a)return!0;var r=864e5,i=parseInt((new tzIndependentDate(t)-new tzIndependentDate(a))/r,10),s=parseInt((new tzIndependentDate(n)-new tzIndependentDate(t))/r,0);return i%e===0&&(!o||o&&s>=e)},e.isPostDaySelected=function(e,t){if(!t)return!0;var a,n=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],o=new tzIndependentDate(e);return a=o.getDay(),t[n[a]]},e.applyDiscount=function(e,t,a){return 0===a&&(a=1),parseFloat(e)<=0?0:"amount"===t.type?e-t.value/a:e-e*(t.value/100)};e.getAddonAmounts=function(t,a,n,o){var r={};return _.each(o,function(o,i){var s=o.guests.adults,c=o.guests.children,u=i;r[u]={},_.each(t,function(t){var o=t.rate_id;_.each(t.associated_addons,function(t){var i=parseFloat(e.getAddonAmount(t.amount_type.value,parseFloat(t.amount),s,c)),l=e.shouldPostAddon(t.post_type.frequency,u,a,n,t.charge_full_weeks_only);!t.is_inclusive&&l&&(void 0===r[u][o]?r[u][o]=i:r[u][o]=parseFloat(r[u][o])+i)})})}),r},this.setForceOverbookFlagForGroup=function(e){this.forceOverbookForGroups=e},this.getForceOverbookForGroup=function(){return this.forceOverbookForGroups}}]),sntRover.controller("rvGroupAllowancesCtrl",["$scope","rvAccountTransactionsSrv","ngDialog",function(e,t,a){BaseCtrl.call(this,e,a),e.keys=Object.keys,e.isActivitiesTabOpen=!0,e.isGroupedByDate=!0,e.shareQuery={query:""},e.shareData=[],e.filteredShareData=[],e.shared=[],e.groupedSharedAllowances={},e.sharedAllowances={},e.errorMessage="",e.successMessage="",e.statusMap={RESERVED:"arrival",PRE_CHECKIN:"pre-check-in",CHECKEDIN:"check-in",CHECKEDOUT:"check-out",NOSHOW:"no-show",CANCELED:"cancel"},e.toggleMode=function(){e.isActivitiesTabOpen=!e.isActivitiesTabOpen,e.isActivitiesTabOpen||e.onQueryUpdate()},e.toggleGrouping=function(){e.isGroupedByDate=!e.isGroupedByDate},e.toggleChecked=function(t,a){var n=_.findIndex(e.shared,function(e){return e.id===t}),o=_.findIndex(e.shared[n].allowances,function(e){return e.id===a});e.shared[n].allowances[o].checked=!e.shared[n].allowances[o].checked},e.closeDialog=function(){a.close()},e.filterShareData=function(){e.filteredShareData=_.filter(e.shareData,function(t){return["CHECKEDIN","RESERVED"].indexOf(t.reservation_status.value)!==-1&&!e.hasAllAllowancesShared(t.id,t.allowances_count)})},e.hasAllAllowancesShared=function(t,a){const n=_.flatten(Array.from(Object.values(e.groupedSharedAllowances))),o=_.filter(n,function(e){return e.item_id===t&&e.checked===!0}).length;return o===a},e.saveSharing=function(){e.errorMessage="";const a={};_.each(e.groupedSharedAllowances,function(t){a[t[0].id]={to_reservation_ids:_.map(_.filter(t,function(t){return e.isChecked(t.item_id,t.id)}),function(e){return e.item_id}),allowance:{id:t[0].id,name:t[0].name,description:t[0].description}}}),e.callAPI(t.saveAllowanceShares,{params:{groupId:e.groupId,type:e.type,data:a},successCallBack:function(t){return t.allowance_data.errors.length?void(e.errorMessage=t.allowance_data.errors.join(". ")):(e.onQueryUpdate(),void(t.allowance_data.success_messages.length&&(e.successMessage=t.allowance_data.success_messages.join(". "))))},failureCallBack:function(t){e.error=t}})},e.onSelect=function(t,a){a&&(a.preventDefault(),a.stopImmediatePropagation(),e.shared=_.filter(e.shared,function(e){return e.id!==t.id})),t.allowances=_.map(t.allowances,function(e){return e.checked=!0,e});var n;e.shared.push(t);try{n=a?_.map(e.shared,function(e){var t=e.allowances;return _.each(t,function(a,n){t[n].id=a.id,t[n].item_id=e.id,t[n].firstname=e.firstname,t[n].lastname=e.lastname,t[n].room=e.room,t[n].reservation_status=e.reservation_status.value}),t}):_.map(e.shared,function(e){var t=_.flatten(_.map(e.shared_allowances,function(e){return e.allowances}));return _.each(t,function(a,n){t[n].id=a.id,t[n].firstname=e.firstname,t[n].lastname=e.lastname,t[n].item_id=e.id,t[n].room=e.room,t[n].reservation_status=e.reservation_status.value,t[n].checked=!0}),t}),e.groupedSharedAllowances=_.groupBy(_.flatten(n),function(e){return e.id})}catch(e){console.error(e)}return e.filterShareData(),!1},e.isChecked=function(t,a){var n=_.findIndex(e.shared,function(e){return e.id===t});if(n===-1)return!1;var o=_.findIndex(e.shared[n].allowances,function(e){return e.id===a});return e.shared[n].allowances[o]&&e.shared[n].allowances[o].checked},e.onQueryUpdate=function(){e.callAPI(t.searchAllowanceShares,{params:{groupId:e.groupId,query:e.shareQuery.query,type:e.type},successCallBack:function(t){e.shared=[],e.shareData=t.allowance_data.results,e.filterShareData(),_.each(t.allowance_data.results,function(t){t.shared_allowances.length>0&&e.onSelect(t)});var a=_.map(t.allowance_data.results,function(e){var t=_.flatten(_.map(e.shared_allowances,function(e){return e.allowances}));return _.each(t,function(a,n){t[n].id=a.id,t[n].firstname=e.firstname,t[n].lastname=e.lastname,t[n].item_id=e.id,t[n].room=e.room,t[n].reservation_status=e.reservation_status.value,t[n].checked=!0}),t});try{e.groupedSharedAllowances=_.groupBy(_.flatten(a),function(e){return e.id}),e.successMessage=""}catch(e){console.error(e)}},failureCallBack:function(){e.groupedAllowanceData=!1,e.sharedData=[],e.shared=[]}})},e.debounceQueryUpdate=_.debounce(e.onQueryUpdate,500),e.onQueryUpdate()}]),angular.module("snt.utils").service("Toggles",["$q","sntBaseWebSrv",function(e,t){var a,n=this;n.initialize=function(){var n=e.defer();return t.getJSON("/api/features/list").then(function(e){a=e,n.resolve(e)}),n.promise},n.isEnabled=function(e){if(!a)throw new Error("Attempt to access feature toggles without initializing");return a[e]===!0||angular.isUndefined(a[e])}}]);