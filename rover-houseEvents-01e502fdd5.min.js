angular.module("houseEventsModule").service("RVHouseEventsSrv",["$q","rvBaseWebSrvV2",function(e,t){var n,a=this;a.getEventTypes=function(){var s=e.defer(),r="/api/house_event_types";return n?s.resolve(a.eventTypes):t.getJSON(r).then(function(e){a.eventTypes=e.results,s.resolve(a.eventTypes)},function(e){s.reject(e)}),s.promise},a.addEvent=function(n){var a=e.defer(),s="/api/house_events";return t.postJSON(s,n).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},a.updateEvent=function(n){var a=e.defer(),s="/api/house_events/"+n.id;return t.putJSON(s,n).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},a.deleteEvent=function(n){var a=e.defer(),s="/api/house_events/"+n.id;return t.deleteJSON(s).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},a.searchEvents=function(n){var a=e.defer(),s="/api/house_events/search";return t.getJSON(s,n).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise}}]),angular.module("houseEventsModule").controller("houseEventsController",["$scope","$filter","RVHouseEventsSrv","eventTypes","$rootScope","ngDialog","$timeout",function(e,t,n,a,s,r,i){BaseCtrl.call(this,e);var o=this,l=50,d="events_list_scroller",D="event_details_scroller",v=255,u="Some mandatory fields are missing - please fill them in.";o.startDateSelected=function(){e.filter.startDate=e.filterStartDate,e.endDateOptions.minDate=e.filter.startDate,e.search()},o.endDateSelected=function(){e.filter.endDate=e.filterEndDate,e.startDateOptions.maxDate=e.filter.endDate,e.search()},o.getCommonDateOptions=function(){var e={showOn:"button",dateFormat:s.jqDateFormat,numberOfMonths:1};return e},o.setDatePickerOptions=function(){e.startDateOptions=_.extend({onSelect:o.startDateSelected},o.getCommonDateOptions()),e.endDateOptions=_.extend({onSelect:o.endDateSelected,minDate:tzIndependentDate(s.businessDate)},o.getCommonDateOptions()),e.filterStartDate=tzIndependentDate(s.businessDate),e.filter.startDate=e.filterStartDate},o.resetEventMinMaxDates=function(){e.eventStartDateOptions.minDate=tzIndependentDate(s.businessDate),e.eventStartDateOptions.maxDate=null,e.eventEndDateOptions.minDate=tzIndependentDate(s.businessDate),e.eventEndDateOptions.maxDate=null},e.setEventDetailsDateOptions=function(){e.eventStartDateOptions=angular.extend({onSelect:function(){e.eventEndDateOptions.minDate=e.eventDates.start,e.eventData.startDate=e.eventDates.start,null!==e.eventDates.end&&e.eventData.startDate>e.eventDates.end&&(e.eventData.endDate=e.eventData.startDate,e.eventDates.end=e.eventData.startDate)}},o.getCommonDateOptions()),e.eventEndDateOptions=angular.extend({onSelect:function(){e.eventStartDateOptions.maxDate=e.eventDates.end,e.eventData.endDate=e.eventDates.end}},o.getCommonDateOptions())},o.setErrorFields=function(){e.fieldErrors={eventType:!1,eventName:!1,startDate:!1,endDate:!1}},e.addEvent=function(){e.eventData={eventType:"",eventName:"",startDate:null,endDate:null,description:""},o.setErrorFields(),e.errorMsg="",e.eventDates.start=null,e.eventDates.end=null,o.resetEventMinMaxDates(),e.lastSelectedEvent.active=!1,e.shouldShowEventDetails=!1,r.open({template:"/assets/partials/houseEvents/rvAddHouseEventPopup.html",className:"",scope:e})},o.getParams=function(e){var n={id:e.id?e.id:void 0,name:e.eventName,description:e.description,house_event_type_id:e.eventType,start_date:e.startDate?t("date")(tzIndependentDate(e.startDate),s.dateFormatForAPI):null,end_date:e.endDate?t("date")(tzIndependentDate(e.endDate),s.dateFormatForAPI):null};return n},e.onCreateEvent=function(){e.errorMsg="",o.isEventValid(e.eventData)?e.callAPI(n.addEvent,{params:o.getParams(e.eventData),onSuccess:function(){r.close(),e.eventData={},e.errorMsg="",e.search()},onFailure:function(t){e.errorMsg=t&&t[0]}}):e.errorMsg=u},o.refreshPagination=function(){i(function(){e.$broadcast("updatePagination","EVENTS_SEARCH")},500)},e.search=function(a){var r=_.isEmpty(e.filter.startDate)?e.filter.startDate:tzIndependentDate(e.filter.startDate),i=_.isEmpty(e.filter.endDate)?e.filter.endDate:tzIndependentDate(e.filter.endDate);e.shouldShowEventDetails=!1,e.page=a||1,e.callAPI(n.searchEvents,{params:{name:e.filter.eventName,house_event_type_id:e.filter.eventType,start_date:t("date")(r,s.dateFormatForAPI),end_date:t("date")(i,s.dateFormatForAPI),per_page:l,page:e.page},onSuccess:function(t){var n,a=[];t.results.forEach(function(t){n={},n.id=t.id,n.eventTypeDesc=_.find(e.eventTypes,{id:t.house_event_type_id}).description,n.startDate=new tzIndependentDate(t.start_date),n.endDate=new tzIndependentDate(t.end_date),n.eventName=t.name,n.description=t.description,n.eventType=t.house_event_type_id,a.push(n)}),e.events=a,e.totalResultCount=t.total_count,o.refreshPagination(),o.refreshListScroller()},onFailure:function(){e.events=[],e.totalResultCount=0,o.refreshPagination()}})},o.initializePagination=function(){e.eventsSearchPagination={id:"EVENTS_SEARCH",api:e.search,perPage:l}},o.setScroller=function(){var t={tap:!0,preventDefault:!1,shrinkScrollbars:"clip"};e.setScroller(d,t),e.setScroller(D,t)},o.refreshListScroller=function(){e.refreshScroller(d)},o.refreshEventDetailsScroller=function(){i(function(){e.refreshScroller(D)},200)},e.shouldShowPagination=function(){return e.totalResultCount>l},e.showEventDetails=function(t){e.lastSelectedEvent&&(e.lastSelectedEvent.active=!1),t.active=!0,e.lastSelectedEvent=t,e.eventDates.start=new tzIndependentDate(t.startDate),e.eventDates.end=new tzIndependentDate(t.endDate),e.eventData=dclone(t),e.eventData.disableStartDate=e.eventDates.start<tzIndependentDate(s.businessDate),e.eventData.disableEndDate=e.eventDates.end<tzIndependentDate(s.businessDate),e.errorMsg="",o.setErrorFields(),e.eventData.disableStartDate?(e.eventStartDateOptions.minDate=null,e.eventStartDateOptions.maxDate=null):(e.eventStartDateOptions.minDate=tzIndependentDate(s.businessDate),e.eventStartDateOptions.maxDate=null),e.eventData.disableEndDate?(e.eventEndDateOptions.minDate=null,e.eventEndDateOptions.maxDate=null):(e.eventEndDateOptions.minDate=tzIndependentDate(s.businessDate),e.eventEndDateOptions.maxDate=null),e.shouldShowEventDetails=!0,o.refreshEventDetailsScroller()},o.isEventValid=function(t){var n=t.eventType;return e.fieldErrors={eventType:!1,eventName:!1,startDate:!1,endDate:!1,description:!1},t.eventType||(e.fieldErrors.eventType=!0),n=n&&t.eventName,t.eventName||(e.fieldErrors.eventName=!0),n=n&&t.startDate,t.startDate||(e.fieldErrors.startDate=!0),n=n&&t.endDate,t.endDate||(e.fieldErrors.endDate=!0),t.description&&t.description.length>v&&(n=!1,e.fieldErrors.description=!0),n},e.updateEvent=function(){e.errorMessage=[],o.isEventValid(e.eventData)?e.callAPI(n.updateEvent,{params:o.getParams(e.eventData),onSuccess:function(){e.eventData={},e.shouldShowEventDetails=!1,e.errorMsg="",e.search()},onFailure:function(t){e.errorMsg=t&&t[0],o.refreshEventDetailsScroller()}}):(e.errorMsg=u,o.refreshEventDetailsScroller())},e.discardEdit=function(){e.eventData={},e.shouldShowEventDetails=!1,e.lastSelectedEvent.active=!1},e.showDeleteConfirmationPopup=function(){r.open({template:"/assets/partials/houseEvents/rvDeleteHouseEventConfirmationPopup.html",className:"",scope:e})},e.deleteEvent=function(){e.callAPI(n.deleteEvent,{params:{id:e.eventData.id},onSuccess:function(){e.shouldShowEventDetails=!1,e.lastSelectedEvent.active=!1,e.closeDialog(),e.search()},onFailure:function(t){e.errorMessage=t}})},e.closeDialog=function(){e.errorMessage=[],e.errorMsg="",r.close()},o.resetFilterMinMaxDates=function(){e.startDateOptions.minDate=null,e.startDateOptions.maxDate=null,e.endDateOptions.minDate=null,e.endDateOptions.maxDate=null},e.clearFilter=function(t,n,a,s,r,i){t.preventDefault(),a[n]=void 0,"startDate"===s?(e.filterStartDate=null,e.filterStartDate||e.filterEndDate||o.resetFilterMinMaxDates()):"endDate"===s?(e.filterEndDate=null,e.filterStartDate||e.filterEndDate||o.resetFilterMinMaxDates()):"start"===s?e.eventDates.start=null:"end"===s&&(e.eventDates.end=null),i&&e.onFieldChange(a[n],n),r&&e.search()},e.onEventNameSearch=_.debounce(e.search,1e3),e.onFieldChange=function(t,n){"description"===n?e.fieldErrors[n]=t&&t.length>v:t?e.fieldErrors[n]=!1:e.fieldErrors[n]=!0},e.refreshEventsList=function(){e.lastSelectedEvent.active=!1,e.shouldShowEventDetails=!1,e.search(1)},o.init=function(){e.heading=t("translate")("MENU_EVENTS"),e.setTitle(t("translate")("MENU_EVENTS")),e.$emit("updateRoverLeftMenu","events"),e.eventTypes=a,e.filter={eventType:"",eventName:"",startDate:"",endDate:""},e.eventDates={start:null,end:null},e.events=[],o.setDatePickerOptions(),o.initializePagination(),o.setScroller(),e.setEventDetailsDateOptions(),e.eventData={},e.lastSelectedEvent={},e.search()},o.init()}]);