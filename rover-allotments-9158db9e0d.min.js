sntRover.controller("rvAllotmentConfigurationCtrl",["$scope","$rootScope","rvAllotmentSrv","$filter","$stateParams","rvAllotmentConfigurationSrv","summaryData","holdStatusList","$state","rvPermissionSrv","$timeout","rvAccountTransactionsSrv","hotelSettings","ngDialog",function(e,t,a,o,n,r,s,i,l,c,u,d,m,f){BaseCtrl.call(this,e),e.isDisabledDatePicker="NEW_ALLOTMENT"!==n.id;var p=function(){e.$$phase||e.$digest()};e.isInAddMode=function(){return"NEW_ALLOTMENT"===n.id},e.isInAddonSelectionMode=function(){return e.allotmentConfigData.selectAddons};var v=function(){var t=o("translate")("ALLOTMENT_DETAILS");e.isInAddMode()&&(t=o("translate")("NEW_ALLOTMENT")),e.setHeadingTitle(t)};e.shouldShowRoomingListTab=function(){return!e.isInAddMode()};var g=function(){var t=e.allotmentConfigData.summary;return!!(t.allotment_name&&t.hold_status&&t.block_from&&t.block_to)},h=function(t){var a=e.allotmentConfigData.summary;a=_.extend(a,t.allotmentSummary),"-1"===a.rate&&(a.uniqId="-1"),e.isInAddMode()||(a.block_from=new tzIndependentDate(a.block_from),a.block_to=new tzIndependentDate(a.block_to)),e.$broadcast("UPDATED_ALLOTMENT_INFO")},y=function(){var t={allotmentId:e.allotmentConfigData.summary.allotment_id},a={successCallBack:h,params:t};e.callAPI(r.getAllotmentSummary,a)};e.$on("FETCH_SUMMARY",function(e){e.stopPropagation(),y()}),e.initializeDataModelForSummaryScreen=function(){e.allotmentConfigData={activeTab:n.activeTab,summary:s.allotmentSummary,roomblock:{},holdStatusList:i.data.hold_status,selectAddons:!1,addons:{},selectedAddons:[]},u(function(){e.allotmentSummaryMemento=angular.copy(e.allotmentConfigData.summary)},500),e.accountConfigData={summary:s.accountSummary},e.isInAddMode()||(e.allotmentConfigData.summary.block_from=new tzIndependentDate(e.allotmentConfigData.summary.block_from),e.allotmentConfigData.summary.block_to=new tzIndependentDate(e.allotmentConfigData.summary.block_to),e.allotmentConfigData.summary.release_date=e.allotmentConfigData.summary.release_date?new tzIndependentDate(e.allotmentConfigData.summary.release_date):""),n.newAllotmentName&&(e.allotmentConfigData.summary.allotment_name=n.newAllotmentName)},e.hasPermissionToViewTransactionsTab=function(){return c.getPermissionValue("ACCESS_GROUP_ACCOUNT_TRANSACTIONS")},e.switchTabTo=function(t){if(e.errorMessage="","TRANSACTIONS"===t&&!e.hasPermissionToViewTransactionsTab())return void(e.errorMessage=["Sorry, you don't have the permission to access the transactions"]);var a="SUMMARY"===e.allotmentConfigData.activeTab,o=a&&"SUMMARY"!==t;return e.isInAddMode()&&o?void(e.errorMessage=["Sorry, Please save the entered information and try to switch the tab"]):(e.allotmentConfigData.activeTab=t,void u(function(){e.$broadcast("ALLOTMENT_TAB_SWITCHED",e.allotmentConfigData.activeTab)},100))};e.reloadPage=function(t){t=t||"SUMMARY",l.go("rover.allotments.config",{id:e.allotmentConfigData.summary.allotment_id,activeTab:t},{reload:!0})},e.closeAllotmentAddonsScreen=function(){e.allotmentConfigData.selectAddons=!1,e.reloadPage()},e.openAllotmentAddonsScreen=function(){e.allotmentConfigData.selectAddons=!0},e.getCurrentTabUrl=function(){var t={SUMMARY:"/assets/partials/allotments/summary/rvAllotmentConfigurationSummaryTab.html",ROOM_BLOCK:"/assets/partials/allotments/details/rvAllotmentConfigurationRoomBlockTab.html",RESERVATIONS:"/assets/partials/allotments/reservations/rvAllotmentReservationsListTab.html",ACTIVITY:"/assets/partials/allotments/activity/rvAllotmentActivityTab.html"};return t[e.allotmentConfigData.activeTab]};var D=function(t){e.allotmentConfigData.summary.allotment_id=t.allotment_id,e.allotmentConfigData.summary.commission_details=t.commission_details,l.go("rover.allotments.config",{id:t.allotment_id}),n.id=t.allotment_id},A=function(t){e.errorMessage=t};e.saveNewAllotment=function(){if(e.closeDialog(),e.errorMessage="",c.getPermissionValue("CREATE_ALLOTMENT_SUMMARY")&&!e.allotmentConfigData.summary.allotment_id)if(g()){e.allotmentConfigData.summary.rate||(e.allotmentConfigData.summary.rate=-1,e.allotmentConfigData.summary.uniqId="-1",e.allotmentConfigData.summary.contract_id=null);var t={successCallBack:D,failureCallBack:A,params:{summary:e.allotmentConfigData.summary}};e.callAPI(r.saveAllotmentSummary,t)}else e.errorMessage=["Allotment's name, from date, to date and hold status are mandatory"];else e.$emit("showErrorMessage",["Sorry, you don't have enough permission to save the details"])};var C=!1,S=!1,R=function(t){return e.allotmentConfigData.summary.commission_details=t.commission_details,S=!1,e.$broadcast("UPDATED_ALLOTMENT_INFO",angular.copy(e.allotmentConfigData.summary)),e.allotmentSummaryMemento=angular.copy(e.allotmentConfigData.summary),C&&(y(),C=!1),!0},b=function(t){return e.$broadcast("FAILED_TO_UPDATE_ALLOTMENT_INFO",t),e.errorMessage=t,C=!1,S=!1,!1};e.updateAllotmentSummary=function(a){if(a=a||!1,c.getPermissionValue("EDIT_ALLOTMENT_SUMMARY")){if(angular.equals(e.allotmentSummaryMemento,e.allotmentConfigData.summary)||S)return!1;a&&(C=!0);var n=_.extend({},e.allotmentConfigData.summary);n.block_from=o("date")(n.block_from,t.dateFormatForAPI),n.block_to=o("date")(n.block_to,t.dateFormatForAPI),n.release_date=o("date")(n.release_date,t.dateFormatForAPI),n.rate||(n.rate=-1,n.contract_id=null,n.uniqId="-1"),S=!0,e.callAPI(r.updateAllotmentSummary,{successCallBack:R,failureCallBack:b,params:{summary:n}})}else e.$emit("showErrorMessage",["Sorry, the changes will not get saved as you don't have enough permission to update the details"])},e.duplicateAllotment=function(){},e.shouldShowCompanyCardNavigationButton=function(){return!e.isInAddMode()&&null!==e.allotmentConfigData.summary.company&&!!e.allotmentConfigData.summary.company.id},e.shouldShowTravelAgentNavigationButton=function(){return!e.isInAddMode()&&null!==e.allotmentConfigData.summary.travel_agent&&!!e.allotmentConfigData.summary.travel_agent.id},e.goToTACard=function(){l.go("rover.companycarddetails",{id:s.allotmentSummary.travel_agent.id,type:"TRAVELAGENT"})},e.goToCompanyCard=function(){l.go("rover.companycarddetails",{id:s.allotmentSummary.company.id,type:"COMPANY"})},e.discardNewAllotment=function(){e.allotmentConfigData.summary=angular.copy(r.baseConfigurationSummary)},e.onCompanyCardChange=function(){var t=e.allotmentConfigData.summary;t.company&&""===t.company.name&&(t.company=null)},e.onTravelAgentCardChange=function(){var t=e.allotmentConfigData.summary;t.travel_agent&&""===t.travel_agent.name&&(t.travel_agent=null)};var O=function(){var t={focus:function(e,t){return!1}};e.companyAutoCompleteOptions=angular.extend({source:function(e,t){r.searchCompanyCards(e.term).then(function(e){var a=[],o={};$.map(e,function(e){o={label:e.account_name,value:e.id,address:e.account_address,type:e.account_type,contract_access_code:e.current_contracts.length>0?e.current_contracts[0].access_code:null},a.push(o)}),t(a)})},select:function(t,a){return this.value=a.item.label,e.allotmentConfigData.summary.company.name=a.item.label,e.allotmentConfigData.summary.company.id=a.item.value,e.isInAddMode()||e.updateAllotmentSummary(!0),e.$broadcast("COMPANY_CARD_CHANGED"),p(),!1},change:function(){e.isInAddMode()||e.allotmentConfigData.summary.company&&e.allotmentConfigData.summary.company.name?e.$broadcast("COMPANY_CARD_CHANGED"):(e.allotmentConfigData.summary.company=e.allotmentSummaryMemento.company,e.detachCardFromAllotment("company"))}},t),e.travelAgentAutoCompleteOptions=angular.extend({source:function(e,t){r.searchTravelAgentCards(e.term).then(function(e){var a=[],o={};$.map(e,function(e){o={label:e.account_name,value:e.id,address:e.account_address,type:e.account_type,contract_access_code:e.current_contracts.length>0?e.current_contracts[0].access_code:null},a.push(o)}),t(a)})},select:function(t,a){return this.value=a.item.label,e.allotmentConfigData.summary.travel_agent.name=a.item.label,e.allotmentConfigData.summary.travel_agent.id=a.item.value,e.isInAddMode()||e.updateAllotmentSummary(!0),e.$broadcast("TA_CARD_CHANGED"),p(),!1},change:function(){e.isInAddMode()||e.allotmentConfigData.summary.travel_agent&&e.allotmentConfigData.summary.travel_agent.name?e.$broadcast("TA_CARD_CHANGED"):(e.allotmentConfigData.summary.travel_agent=e.allotmentSummaryMemento.travel_agent,e.detachCardFromAllotment("travel_agent"))}},t)};e.detachCardFromAllotment=function(t){var a={cardType:t};f.open({template:"/assets/partials/groups/summary/popups/detachCardWarningPopup.html",scope:e,closeByDocument:!1,closeByEscape:!1,data:JSON.stringify(a)})},e.detachCard=function(t){"company"===t?(e.allotmentConfigData.summary.company={id:"",name:""},e.$broadcast("COMPANY_CARD_CHANGED")):(e.allotmentConfigData.summary.travel_agent={id:"",name:""},e.$broadcast("TA_CARD_CHANGED")),e.updateAllotmentSummary(!0)},e.cancelDetachment=function(t){"company"===t?e.allotmentConfigData.summary.company=angular.copy(e.allotmentSummaryMemento.company):e.allotmentConfigData.summary.travel_agent=angular.copy(e.allotmentSummaryMemento.travel_agent)},e.computeAddonsCount=function(){var t=0;angular.forEach(e.allotmentConfigData.selectedAddons,function(e){t+=parseInt(e.addon_count)}),t>0?e.allotmentConfigData.summary.addons_count=t:e.allotmentConfigData.summary.addons_count=null},e.updateAndBack=function(){e.isInAddMode()||"SUMMARY"!==e.allotmentConfigData.activeTab?"ACCOUNT"===e.allotmentConfigData.activeTab&&e.$broadcast("UPDATE_ACCOUNT_SUMMARY"):e.updateAllotmentSummary(),l.go("rover.allotments.search",{origin:"BACK_TO_ALLOTMENT_SEARCH_LIST"})};var T=function(){t.setPrevState={title:o("translate")("ALLOTMENTS"),callback:"updateAndBack",scope:e},v()};e.$on("showErrorMessage",function(t,a){e.errorMessage=a,p()}),e.parseCurrency=function(e){return e?t.currencySymbol+o("number")(e,2):""},e.createNewAllotment=function(){e.$broadcast("CREATE_ALLOTMENT")},e.$on("SAVE_ALLOTMENT",function(){e.saveNewAllotment()});var P=function(){e.hotelSettings=m,e.initializeDataModelForSummaryScreen(),O(),T()};P()}]),angular.module("sntRover").controller("rvAllotmentRootCtrl",["$scope","$rootScope","$filter","$timeout","$interval","$log",function(e,t,a,o,n,r){e.setHeadingTitle=function(t){e.heading=t,e.setTitle(a("translate")(t))},t.disableObserveForSwipe||(CardReaderCtrl.call(this,e,t,o,n,r),e.observeForSwipe())}]),sntRover.controller("rvAllotmentActivityCtrl",["$scope","$rootScope","$filter","$stateParams","rvAllotmentAccountActivitySrv",function(e,t,a,o,n){BaseCtrl.call(this,e),e.init=function(){var t=!!e.allotmentConfigData;e.selectedAllotmentOrAccountId=t?e.allotmentConfigData.summary.allotment_id:e.accountConfigData.summary.posting_account_id;var a={id:e.selectedAllotmentOrAccountId,page:1,type:t?"allotment":"account",per_page:50},o=function(t){e.$broadcast("PopulateLogData",t)};e.invokeApi(n.fetchActivityLog,a,o)},e.$on("updateLogdata",function(t,a){a.id=e.selectedAllotmentOrAccountId,a.type=e.allotmentConfigData?"allotment":"account";var o=function(t){e.$broadcast("PopulateLogData",t)};e.invokeApi(n.fetchActivityLog,a,o)}),e.$on("ALLOTMENT_TAB_SWITCHED",function(t,a){"ACTIVITY"===a&&e.init()}),e.$on("ACCOUNT_TAB_SWITCHED",function(t,a){"ACTIVITY"===a&&e.init()})}]),sntRover.controller("rvAllotmentReservationsListCtrl",["$scope","$rootScope","rvAllotmentReservationsListSrv","$filter","$timeout","rvUtilSrv","rvPermissionSrv","$q","ngDialog","rvAllotmentConfigurationSrv","$state","$window","$stateParams","rvGroupRoomingListSrv",function(e,t,a,o,n,r,s,i,l,c,u,d,m,f){BaseCtrl.call(this,e);var p,v="ALLOTMENT_RESERVATION_LIST";e.isEmpty=r.isEmpty,e.stringify=r.stringify;var g=function(){return s.getPermissionValue("CREATE_ALLOTMENT_ROOMING_LIST")},h=function(){return s.getPermissionValue("EDIT_ALLOTMENT_ROOMING_LIST")},y=function(){return s.getPermissionValue("EDIT_RESERVATION")},D=function(e){return o("date")(new tzIndependentDate(e),t.dateFormatForAPI)};e.shouldDisableAutoRoomAssignButton=function(){return 0===e.selected_reservations.length||!y()},e.shouldShowNoReservations=function(){return 0===e.reservations.length},e.shouldShowThisOccupancyAgainstRoomType=function(t){var a=_.findWhere(e.roomTypesAndData,{room_type_id:parseInt(e.selectedRoomType)});return"undefined"!=typeof a&&a[t]},e.clearReservationAddFromDate=function(){e.reservationAddFromDate="",X()},e.clearReservationAddToDate=function(){e.reservationAddToDate="",X()},e.clearReservationSearchFromDate=function(){e.reservationSearchFromDate="",X()},e.clearReservationSearchToDate=function(){e.reservationSearchToDate="",X()};var A=function(t,a){e.reservationAddFromDate=new tzIndependentDate(r.get_date_from_date_picker(a)),e.reservationAddToDateOptions.minDate=new tzIndependentDate(r.get_date_from_date_picker(a)),e.reservationAddToDate&&e.reservationAddFromDate>e.reservationAddToDate&&(e.reservationAddToDate=new tzIndependentDate(r.get_date_from_date_picker(a))),X(),e.fetchConfiguredRoomTypeDetails()},C=function(t,a){e.reservationAddToDate=new tzIndependentDate(r.get_date_from_date_picker(a)),e.reservationAddFromDate>=e.reservationAddToDate&&(e.reservationAddFromDate=new tzIndependentDate(r.get_date_from_date_picker(a))),X(),e.fetchConfiguredRoomTypeDetails()},S=function(t,a){e.reservationSearchFromDate=new tzIndependentDate(r.get_date_from_date_picker(a)),e.reservationSearchFromDate>e.reservationSearchToDate&&(e.reservationSearchToDate=e.reservationSearchFromDate),e.fetchReservations(!0),X()},R=function(t,a){e.reservationSearchToDate=new tzIndependentDate(r.get_date_from_date_picker(a)),e.reservationSearchFromDate>e.reservationSearchToDate&&(e.reservationSearchFromDate=e.reservationSearchToDate),e.fetchReservations(!0),X()},b=function(){var a=e.allotmentConfigData.summary,o={dateFormat:t.jqDateFormat,numberOfMonths:1},n=a.block_from;n instanceof Date||(n=new tzIndependentDate(n)),n<new tzIndependentDate(t.businessDate)&&(n=new tzIndependentDate(t.businessDate)),e.isInAddMode()||_.extend(o,{minDate:new tzIndependentDate(t.businessDate),maxDate:new tzIndependentDate(a.block_to)}),e.reservationAddFromDate=n,e.reservationAddToDate=new tzIndependentDate(a.block_to),e.reservationSearchFromDate=n,e.reservationSearchToDate=new tzIndependentDate(a.block_to),e.reservationAddFromDateOptions=_.extend({onSelect:A},o),e.reservationAddToDateOptions=_.extend({onSelect:C},o),e.reservationSearchFromDateOptions=_.extend({onSelect:S},o),e.reservationSearchToDateOptions=_.extend({onSelect:R},o),e.isInAddMode()||(e.reservationAddToDateOptions.minDate=n,e.reservationSearchFromDateOptions.minDate=new tzIndependentDate(a.block_from),e.reservationSearchToDateOptions.minDate=new tzIndependentDate(a.block_from))};e.shouldShowSearchReservationFields=function(){return k()&&!e.isCancelledAllotment()},e.shouldShowAddReservationFields=function(){return N()&&!e.isCancelledAllotment()},e.isCancelledAllotment=function(){return!!e.allotmentConfigData.summary.is_cancelled},e.toggleAddMode=function(){N()?(P(),e.fetchReservations()):O()},e.toggleSearchMode=function(){k()?(P(),e.fetchReservations()):T()};var O=function(){p="ADD",e.searchQuery=""},T=function(){e.searchQuery="",p="SEARCH"},P=function(){e.searchQuery="",p="DEFAULT"},k=function(){return"SEARCH"===p},N=function(){return"ADD"===p};e.clearSearchQuery=function(){e.searchQuery="",e.page=1,e.fetchReservations(!0)};var M=function(a){e.printRegCardData=a,e.errorMessage="",$("header .logo").addClass("logo-hide"),$("header .h2").addClass("text-hide"),q(),e.isPrintRegistrationCard=!0,t.addNoPrintClass=!0;var o=function(){n(function(){e.isPrintRegistrationCard=!1,t.addNoPrintClass=!1,$("header .logo").removeClass("logo-hide"),$("header .h2").addClass("text-hide"),G()},100)};n(function(){sntapp.cordovaLoaded?cordova.exec(o,function(){o()},"RVCardPlugin","printWebView",["","0","","L"]):(window.print(),o())},100)},I=function(t){e.isPrintRegistrationCard=!1,e.errorMessage=t};e.printRegistrationCards=function(){var t={id:e.allotmentConfigData.summary.allotment_id},o={params:t,successCallBack:M,failureCallBack:I};e.callAPI(a.fetchRegistrationCardPrintData,o)};var E=function(){l.open({template:"/assets/partials/allotments/reservations/popups/general/rvAllotmentReservationsListEmailPrompt.html",className:"",scope:e,closeByDocument:!1,closeByEscape:!1})};e.sendRoomingList=function(){e.allotmentConfigData.summary.contact_email?e.sendEmail(e.allotmentConfigData.summary.contact_email):E()};var B=function(t){e.successMessage="Email sent successfully",e.closeDialog()},L=function(t){e.errorMessage=t,e.closeDialog()};e.sendEmail=function(t){var o={to_address:t,allotment_id:e.allotmentConfigData.summary.allotment_id},n={params:o,successCallBack:B,failureCallBack:L};e.callAPI(a.emailInvoice,n)};var w=function(){l.open({template:"/assets/partials/allotments/reservations/popups/autoAssignRooms/rvAllotmentAutoRoomAssignSomeResReadyPopUp.html",className:"",scope:e,closeByDocument:!1,closeByEscape:!1})},F=function(){l.open({template:"/assets/partials/allotments/reservations/popups/autoAssignRooms/rvAllotmentAutoRoomAssignNoResMeetCriteria.html",className:"",scope:e,closeByDocument:!1,closeByEscape:!1})};e.autoAssignRooms=function(){var t,a,o,n,r,s=e.selected_reservations.length;o=_.filter(e.selected_reservations,function(e){return t=e.status.toUpperCase(),"RESERVED"===t||"CHECKING_IN"===t}),n=_.filter(o,function(e){return a=e.room_number,null===a||""===a}),r=n.length,r>0?(e.qualifiedReservations=n,e.messageForAutoRoomAssignment=s===r?"":"ALLOTMENT_AUTO_ROOM_ASSIGN_CONFIRMATION_PARTIALLY_OKEY",w()):F()};var j=function(t){l.open({template:"/assets/partials/allotments/reservations/popups/autoAssignRooms/rvAllotmentResAutoRoomAssignmentSuccessPopUp.html",className:"",scope:e,closeByDocument:!1,closeByEscape:!1,data:JSON.stringify(t)})},V=function(t){var a={errorMessage:t};l.open({template:"/assets/partials/allotments/reservations/popups/autoAssignRooms/rvAllotmentResAutoAssignRoomsFailedPopup.html",className:"",scope:e,closeByDocument:!1,closeByEscape:!1,data:JSON.stringify(a)})};e.closeAutoRoomAssignSuccessPopup=function(){e.closeDialog(),e.selected_reservations=[],n(function(){ie()},800)};var J=function(t){var a=t.failure_reservation_ids;a.length>0&&(t.failedReservations=[],_.each(t.failure_reservation_ids,function(a){t.failedReservations.push(_.findWhere(e.selected_reservations,{id:a}))})),j(t)},U=function(e){V(e)};e.autoRoomAssignQualifiedReservations=function(){e.closeDialog(),n(function(){var t={id:e.allotmentConfigData.summary.allotment_id,reservation_ids:_.pluck(e.qualifiedReservations,"id")},o={params:t,successCallBack:J,failureCallBack:U};e.callAPI(a.performAutoRoomAssignment,o)},800)};var x=function(){$(this).off("load"),$(this).remove();var t=function(){n(function(){e.print_type="",G(),e.reservations=r.deepCopy(e.resevationsBeforePrint),e.resevationsBeforePrint=[]},1200)};n(function(){sntapp.cordovaLoaded?cordova.exec(t,function(){t()},"RVCardPlugin","printWebView",["","0","","L"]):(window.print(),t())},300)},H=function(){q();var e=$("#print-orientation"),t=e.css("background-image"),a=t.replace(/(^url\()|(\)$|[\"\'])/g,"");$("<img>").attr("src",a).on("load",x)};e.$on("NG_REPEAT_COMPLETED_RENDERING",function(t){n(function(){"rooming_list"===e.print_type&&H()},500)});var q=function(){$("body").append("<style id='print-orientation'>@page { size: landscape; }</style>")},G=function(){$("#print-orientation").remove()},z=function(t){e.resevationsBeforePrint=r.deepCopy(e.reservations),e.reservations=t.results,e.print_type="rooming_list"};e.fetchReservationsForPrintingRoomingList=function(){var t={id:e.allotmentConfigData.summary.allotment_id,per_page:1e3},o={params:t,successCallBack:z};e.callAPI(a.fetchReservations,o)},e.$on("ALLOTMENT_TAB_SWITCHED",function(e,t){"RESERVATIONS"===t&&(b(),ie())});var W=function(){e.roomTypesAndData=[],e.reservations=[],e.resevationsBeforePrint=[],e.occupancyTextMap={1:"Single",2:"Double",3:"Triple",4:"Quadruple"},e.totalResultCount=0,e.totalPickUpCount=0,e.numberOfRooms="1",e.selectedOccupancy="1",e.possibleNumberOfRooms=[],p="DEFAULT",e.sorting_field="room_number",e.sort_dir="ASC",e.selected_reservations=[],e.qualifiedReservations=[],e.searchQuery="",e.roomingListState={editedReservationStart:"",editedReservationEnd:""}},Y=function(){var t={tap:!0,preventDefault:!1,deceleration:1e-4,shrinkScrollbars:"clip"};e.setScroller("rooming_list",t)},K=function(){e.refreshScroller("rooming_list")},Q=function(){var t=e.isInAddMode()?"menuCreateAllotment":"menuManageAllotment";e.$emit("updateRoverLeftMenu",t)},X=function(){e.$$phase||e.$digest()};e.gotoRoomBlockTab=function(){e.closeDialog(),e.switchTabTo("ROOM_BLOCK")};var Z=function(t){e.reservations=[],e.page=1,e.start=1,e.end=void 0,ie()};e.addReservations=function(){if(0===e.roomTypesAndData.length)return ne();if(!e.possibleNumberOfRooms.length)return void(e.errorMessage=["No Rooms have been added for the selected Room in the Room Block."]);e.errorMessage="";var t={group_id:e.allotmentConfigData.summary.allotment_id,room_type_id:e.selectedRoomType,from_date:""!==e.reservationAddFromDate?D(e.reservationAddFromDate):"",to_date:""!==e.reservationAddToDate?D(e.reservationAddToDate):"",occupancy:e.selectedOccupancy,no_of_reservations:e.numberOfRooms},a={params:t,successCallBack:Z};e.callAPI(f.addReservations,a)},e.changedSelectedRoomType=function(){var t=_.findWhere(e.roomTypesAndData,{room_type_id:parseInt(e.selectedRoomType)}),a="undefined"!=typeof t;e.possibleNumberOfRooms=a?_.range(1,r.convertToInteger(t.availability)+1):[],e.selectedOccupancy="1",a||(e.selectedOccupancy="-1"),"undefined"==typeof e.numberOfRooms&&e.possibleNumberOfRooms.length>0&&(e.numberOfRooms=e.possibleNumberOfRooms[0]),_.max(e.possibleNumberOfRooms)<e.numberOfRooms&&(e.numberOfRooms=e.possibleNumberOfRooms[0])};var ee=function(){return{id:e.allotmentConfigData.summary.allotment_id,from_date:D(e.reservationAddFromDate?e.reservationAddFromDate:e.reservationAddToDate),to_date:D(e.reservationAddToDate?e.reservationAddToDate:e.reservationAddFromDate)}};e.fetchConfiguredRoomTypeDetails=function(){var t=g()&&h();if(!t)return void(e.errorMessage=["Sorry, You dont have enough permission to proceed!!"]);var o=ee(),n={params:o,successCallBack:te};e.callAPI(a.getRoomTypesConfiguredAgainstGroup,n)};var te=function(t){var a=r.convertToInteger;e.roomTypesAndData=_.map(t.result,function(e){return e.availableRoomCount=a(e.total_rooms)-a(e.total_pickedup_rooms),e}),e.selectedRoomType=e.roomTypesAndData.length>0?e.roomTypesAndData[0].room_type_id:void 0,e.changedSelectedRoomType()},ae=function(t){e.reservations=t.results,e.totalResultCount=t.total_result,e.totalPickUpCount=t.total_picked_count,void 0===e.end&&(e.end=e.reservations.length),X(),K(),n(function(){e.$broadcast("updatePagination",v)},100)},oe=function(t,a){a=a||1;var o={id:e.allotmentConfigData.summary.allotment_id,payLoad:{per_page:e.perPage,page:a,sort_by:e.sorting_field,sort_dir:e.sort_dir}};return t&&_.extend(o.payLoad,{start_date:D(e.reservationSearchFromDate),end_date:D(e.reservationSearchToDate),query:e.searchQuery}),o};e.fetchReservations=function(t,o){var n=oe(t,o),r={params:n,successCallBack:ae};e.callAPI(a.fetchReservations,r)};var ne=function(t){l.open({template:"/assets/partials/allotments/reservations/popups/general/rvAllotmentRoomingNoRoomTypeAttachedPopUp.html",className:"",scope:e,closeByDocument:!1,closeByEscape:!1})},re=function(t){e.$emit("hideLoader"),0===e.roomTypesAndData.length&&ne()},se=function(t){e.$emit("hideLoader"),e.errorMessage=t},ie=function(){var t=g()&&h();if(!t)return void(e.errorMessage=["Sorry, You dont have enough permission to proceed!!"]);var o=[];e.$emit("showLoader");var n=ee();o.push(a.getRoomTypesConfiguredAgainstGroup(n).then(te));var r=oe();o.push(a.fetchReservations(r).then(ae)),o.push(a.fetchHotelReservationSettings().then(function(t){e.maxStayLength=t.max_stay_length||92})),i.all(o).then(re,se)};e.searchAllotmentReservations=function(){switch(e.searchQuery.length){case 0:console.log("reset");break;case 1:case 2:console.log("do nothing");break;default:e.fetchReservations(!0)}},e.formatDateForUI=function(e){var a=typeof e,n="";switch(a){case"string":n=o("date")(new tzIndependentDate(e),t.dateFormat);break;case"object":n=o("date")(e,t.dateFormat)}return n},e.shouldShowPagination=function(){return e.totalResultCount>=e.perPage};var le=function(){e.perPage=a.DEFAULT_PER_PAGE,e.page=1},ce=function(t){e.allotmentConfigData.summary.hide_rates=!e.allotmentConfigData.summary.hide_rates},ue=function(t){e.errorMessage=t};e.clickedShowRate=function(){var t={id:e.allotmentConfigData.summary.allotment_id,hide_rates:!e.allotmentConfigData.summary.hide_rates},o={params:t,successCallBack:ce,failureCallBack:ue};e.callAPI(a.toggleHideRate,o)},e.addOrRemoveFromSelectedReservation=function(t){var a=_.findWhere(e.selected_reservations,{id:t.id});if(a){var o=_.indexOf(_.pluck(e.selected_reservations,"id"),t.id);e.selected_reservations.splice(o,1)}else e.selected_reservations.push(t)},e.getReservationClass=function(e){var t="",a=e.status.toUpperCase(),o=e.is_opted_late_checkout,n=e.is_pre_checkin;switch(a){case"RESERVED":t="arrival";break;case"CHECKING_IN":t="check-in";break;case"CHECKEDIN":t="inhouse";break;case"CHECKING_OUT":t="check-out",o&&(t="late-check-out");break;case"CHECKEDOUT":t="departed";break;case"CANCELED":t="cancel";break;case"NOSHOW":case"NOSHOW_CURRENT":t="no-show";break;default:t=""}return n&&(t="pre-check-in"),t},e.isGuestBlank=function(e){return r.isEmpty(e.guest_card_id)},e.isRoomUnAssigned=function(e){return r.isEmpty(e.room_number)},e.getRoomStatusClass=function(e){var t="";if(e.room_service_status&&("OUT_OF_SERVICE"===e.room_service_status||"OUT_OF_ORDER"===e.room_service_status))return"room-grey";if("CHECKING_IN"!==e.reservation_status)return t;if(""===e.room_ready_status)return t;if("VACANT"!==e.fostatus)return t+=" room-red";switch(e.room_ready_status){case"INSPECTED":t+=" room-green";break;case"CLEAN":t+="true"===e.checkin_inspected_only?" room-orange":" room-green";break;case"PICKUP":t+=" room-orange";break;case"DIRTY":t+=" room-red"}return t},e.isReservationInSelectedReservation=function(t){var a=_.findWhere(e.selected_reservations,{id:t.id});return"undefined"!=typeof a},e.whetherAllReservationsSelected=function(){return e.selected_reservations.length===e.reservations.length},e.toggleAllSelection=function(){var t=e.whetherAllReservationsSelected();t?e.selected_reservations=[]:e.selected_reservations=_.extend([],e.reservations)},e.whetherReservationsArePartiallySelected=function(){return e.selected_reservations.length<e.reservations.length&&e.selected_reservations.length>0},e.sortBy=function(t){e.sorting_field===t?e.sort_dir="ASC"===e.sort_dir?"DESC":"ASC":(e.sorting_field=t,e.sort_dir="ASC"),e.fetchReservations()},e.getSortClass=function(t){var a="";return e.sorting_field===t&&(a="ASC"===e.sort_dir?"sorting-asc":"sorting-desc"),a},function(){var t,o=function(t){l.open({template:"/assets/partials/allotments/reservations/popups/editReservation/rvAllotmentEditRoomingListItem.html",className:"",scope:e,closeByDocument:!1,closeByEscape:!1,controller:"rvAllotmentReservationEditCtrl",data:JSON.stringify(t)})},n=function(a){var n=t.room_id,s=[];t.roomsAvailableToAssign=[],null!==n&&""!==n&&(s=[{id:n,room_number:t.room_number}]),t.roomsAvailableToAssign=s.concat(a.rooms);var i=angular.copy(t),l=null,c=null,u=null,d=null;_.extend(e.roomingListState,{editedReservationStart:t.arrival_date,editedReservationEnd:t.departure_date}),l=_.pluck(e.roomTypesAndData,"room_type_id"),c=!_.contains(l,parseInt(t.room_type_id)),c?(u=[{room_type_id:t.room_type_id,room_type_name:t.room_type_name}],d=_.union(u,r.deepCopy(e.roomTypesAndData))):d=r.deepCopy(e.roomTypesAndData),_.extend(i,{arrival_date:new tzIndependentDate(i.arrival_date),departure_date:new tzIndependentDate(i.departure_date),roomsFreeToAssign:t.roomsAvailableToAssign,allowedRoomTypes:d}),null===i.room_id&&(i.room_id=""),e.$emit("hideLoader"),o(i)},s=function(t){e.$emit("hideLoader"),e.errorMessage=errorMessage};e.onClickReservation=function(o){t=o,e.callAPI(a.getFreeAvailableRooms,{params:{reserevation_id:o.id,num_of_rooms_to_fetch:5,room_type_id:o.room_type_id},successCallBack:n,failureCallBack:s})}}(),e.$on("REFRESH_ALLOTMENT_RESERVATIONS_LIST_DATA",function(e){ie()});var de=function(){e.pageOptions={id:v,perPage:e.perPage,api:[e.fetchReservations,!1]}};(function(){Q(),b(),Y(),W(),le(),de();var t="RESERVATIONS"===e.allotmentConfigData.activeTab,a="RESERVATIONS"===m.activeTab;t&&a&&n(function(){ie()},10)})()}]),sntRover.controller("rvAllotmentAddRoomsAndRatesPopupCtrl",["$scope","$rootScope","$filter","rvPermissionSrv","ngDialog","$timeout","rvUtilSrv","rvAllotmentConfigurationSrv",function(e,t,a,o,n,r,s,i){var l;(function(){BaseCtrl.call(this,e),e.setScroller("room_type_scroller"),e.defaultRoomTypeDetails={best_available_rate_amount:"",single_rate:"",double_rate:"",extra_adult_rate:"",rate_id:""},e.selectedRoomTypeAndRates=s.deepCopy(e.allotmentConfigData.roomblock.selected_room_types_and_rates),angular.forEach(e.selectedRoomTypeAndRates,function(e){e.is_configured_in_allotment&&(e.update_existing_reservations_rate=!1,e.old_single_rate=e.single_rate,e.old_double_rate=e.double_rate,e.old_extra_adult_rate=e.extra_adult_rate)});var a=["room_type_id","room_type_name","best_available_rate_amount","rate_id","best_available_rate_id","update_existing_reservations_rate"];e.roomTypes=s.getListOfKeyValuesFromAnArray(e.selectedRoomTypeAndRates,a),e.roomTypes=_.map(e.roomTypes,function(e){return e.best_available_rate_amount=t.currencySymbol+e.best_available_rate_amount,e}),e.selectedRoomTypeAndRates=_.where(e.selectedRoomTypeAndRates,{is_configured_in_allotment:!0}),0===e.selectedRoomTypeAndRates.length&&(e.selectedRoomTypeAndRates=[],e.selectedRoomTypeAndRates.push(s.deepCopy(e.allotmentConfigData.roomblock.selected_room_types_and_rates[0]))),_.each(e.selectedRoomTypeAndRates,function(e){e.room_type_id=e.room_type_id.toString()}),e.selectedRoomTypeAndRates=_.map(e.selectedRoomTypeAndRates,function(e){return e.best_available_rate_amount=(e.rate_currency?e.rate_currency:t.currencySymbol)+e.best_available_rate_amount,e})})();e.changeBestAvailableRate=function(t){var a=_.find(e.roomTypes,function(e){return e.room_type_id==t.room_type_id});if(a){if(t.best_available_rate_amount=a.best_available_rate_amount,t.best_available_rate_id=a.best_available_rate_id,t.rate_id=a.rate_id,e.allotmentConfigData.summary.rate!==-1){var o=_.findWhere(e.allotmentConfigData.roomblock.selected_room_types_and_rates,{room_type_id:parseInt(a.room_type_id,10)});t.single_rate=o.single_rate,t.double_rate=o.double_rate,t.extra_adult_rate=o.extra_adult_rate}}else t.best_available_rate_amount=""},e.shouldShowAddNewButton=function(t){return!s.isEmpty(t.room_type_id)&&_.pluck(e.selectedRoomTypeAndRates,"room_type_id").length<e.roomTypes.length&&!e.allotmentConfigData.summary.is_cancelled},e.shouldShowDeleteButton=function(){return e.selectedRoomTypeAndRates.length>=2&&!e.allotmentConfigData.summary.is_cancelled},e.addNewRoomTypeAndRatesRow=function(){e.selectedRoomTypeAndRates.push(s.deepCopy(e.defaultRoomTypeDetails)),e.refreshScroller("room_type_scroller"),c()};var c=function(){var t=e.$parent.myScroll.room_type_scroller;r(function(){t.scrollTo(t.maxScrollX,t.maxScrollY,500)},300)};e.deleteRoomTypeAndRatesRow=function(t){e.selectedRoomTypeAndRates.splice(t,1),e.refreshScroller("room_type_scroller")},e.clickedOnCancelButton=function(){e.closeDialog()};var u=function(t){e.fetchCurrentSetOfRoomBlockData(),e.closeDialog()},d=function(t){e.errorMessage=t},m=function(){var t=_.filter(e.selectedRoomTypeAndRates,function(e){return"undefined"!=typeof e.room_type_id&&""!==e.room_type_id}),a=["room_type_id","single_rate","double_rate","extra_adult_rate","rate_id","best_available_rate_id","update_existing_reservations_rate"];t=s.getListOfKeyValuesFromAnArray(t,a);var o={allotment_id:e.allotmentConfigData.summary.allotment_id,room_type_and_rates:t};return o};e.checkIfAllotmentCustomRateChanged=function(){if(f())n.close(),r(function(t){e.confirmUpdateRatesWithPickedReservations(e.selectedRoomTypeAndRates);
},700);else{var t={params:m(),successCallBack:u,failureCallBack:d};e.callAPI(i.updateSelectedRoomTypesAndRates,t)}};var f=function(){return l=!1,angular.forEach(e.selectedRoomTypeAndRates,function(e){e.total_reservations_count>0&&(e.single_rate===e.old_single_rate&&e.double_rate===e.old_double_rate&&e.extra_adult_rate===e.old_extra_adult_rate||(l=!0,e.update_existing_reservations_rate=!0))}),l};e.hideRoomType=function(t,a){if(parseInt(t)===parseInt(a.room_type_id))return!1;var o=_.pluck(e.selectedRoomTypeAndRates,"room_type_id");return _.indexOf(o,a.room_type_id)>=0}}]),sntRover.controller("rvAllotmentRoomBlockCtrl",["$scope","$rootScope","$filter","rvPermissionSrv","ngDialog","rvAllotmentConfigurationSrv","$timeout","rvUtilSrv","$q","dateFilter",function(e,t,a,o,n,r,s,i,l,c){BaseCtrl.call(this,e);var u,d,m=!1,f=!1,p=!1;e.isEmpty=i.isEmpty,e.shouldHideAddRoomsButton=function(){return e.allotmentConfigData.summary.is_cancelled||e.allotmentConfigData.roomblock.selected_room_types_and_bookings.length>0},e.shouldShowRoomsRates=function(){return e.allotmentConfigData.roomblock.selected_room_types_and_bookings.length>0};var v=function(){return o.getPermissionValue("OVERBOOK_ROOM_TYPE")},g=function(){return o.getPermissionValue("OVERBOOK_HOUSE")},h=function(){return o.getPermissionValue("CREATE_ALLOTMENT_ROOM_BLOCK")},y=function(){return o.getPermissionValue("EDIT_ALLOTMENT_ROOM_BLOCK")};e.shouldDisableAddRoomsAndRate=function(){return!h()&&!y()},e.shouldDisableGridViewSwitch=function(){var t=e.allotmentConfigData.roomblock.selected_room_types_and_bookings.length>0;return!t},e.shouldDisableApplyToHeldToContractButton=function(){return!f},e.shouldDisableApplyToCurrrentButton=function(){return f},e.shouldShowDiscardButton=function(){return e.hasBookingDataChanged&&e.shouldHideAddRoomsButton()},e.shouldShowRoomBlockActions=function(){return!e.allotmentConfigData.summary.is_cancelled&&e.shouldHideAddRoomsButton()},e.shouldShowApplyToHeldCountsButton=function(){return"CONTRACT"===e.activeGridView},e.shouldShowApplyToContractButton=function(){var t=e.hasBookingDataChanged,a="CONTRACT"===e.activeGridView;return t&&a},e.shouldShowApplyToCurrentButton=function(){var t=e.hasBookingDataChanged,a="CURRENT"===e.activeGridView;return t&&a},e.shouldShowTripleEntryRow=function(t){if(e.allotmentConfigData.summary.rate===-1){var a=_.pluck(t.dates,"triple");return a=_.filter(a,function(e){return"undefined"!=typeof e}),a.length>0}return t.rate_config.is_extra_adult_rate_configured&&t.rate_config.is_double_rate_configured},e.shouldShowQuadrupleEntryRow=function(t){if(e.allotmentConfigData.summary.rate===-1){var a=_.pluck(t.dates,"quadruple");return a=_.filter(a,function(e){return"undefined"!=typeof e}),a.length>0&&e.shouldShowTripleEntryRow(t)}return t.rate_config.is_extra_adult_rate_configured&&t.rate_config.is_double_rate_configured},e.addTripleEntryRow=function(t){return!(e.allotmentConfigData.summary.is_cancelled||!t.can_edit)&&(_.each(t.dates,function(e){e.triple=0,e.triple_pickup=0}),e.bookingDataChanging(),void J())},e.addQuadrupleEntryRow=function(t){return!(e.allotmentConfigData.summary.is_cancelled||!t.can_edit)&&(_.each(t.dates,function(e){e.quadruple=0,e.quadruple_pickup=0}),e.bookingDataChanging(),void J())},e.shouldShowAddTrippleButton=function(t){var a=e.allotmentConfigData.summary.rate===-1&&!e.shouldShowTripleEntryRow(t);return a},e.shouldShowAddQuadrupleButton=function(t){var a=e.allotmentConfigData.summary.rate===-1&&!e.shouldShowQuadrupleEntryRow(t)&&e.shouldShowTripleEntryRow(t);return a},e.shouldDisableSingleEntryBox=function(t,a){return!a.can_edit||!!e.allotmentConfigData.summary.is_cancelled||!t.isModifiable},e.shouldDisableDoubleEntryBox=function(t,a){return!a.can_edit||!!e.allotmentConfigData.summary.is_cancelled||!t.isModifiable},e.shouldDisableTripleEntryBox=function(t,a){return!a.can_edit||!!e.allotmentConfigData.summary.is_cancelled||!t.isModifiable},e.shouldDisableQuadrupleEntryBox=function(t,a){return!a.can_edit||!!e.allotmentConfigData.summary.is_cancelled||!t.isModifiable},e.isValueConfigured=function(e){return _.isNumber(e)||parseInt(e)>=0},e.shouldDisableAddTripleButton=function(t){return!t.can_edit||!!e.allotmentConfigData.summary.is_cancelled},e.shouldDisableAddQuadrupleButton=function(t){return!t.can_edit||!!e.allotmentConfigData.summary.is_cancelled},e.copySingleContractValueToOtherBlocks=function(t,a){var o={occupancy:"single_contract",value:t.single_contract,isContract:!0};e.selectedRoomType=a,e.showMassUpdateEndDateConfirmation(o)},e.copySingleHeldValueToOtherBlocks=function(t,a){var o={occupancy:"single",value:t.single};e.selectedRoomType=a,e.showMassUpdateEndDateConfirmation(o)},e.copyDoubleContractValueToOtherBlocks=function(t,a){var o={occupancy:"double_contract",value:t.double_contract,isContract:!0};e.selectedRoomType=a,e.showMassUpdateEndDateConfirmation(o)},e.copyDoubleHeldValueToOtherBlocks=function(t,a){var o={occupancy:"double",value:t.double};e.selectedRoomType=a,e.showMassUpdateEndDateConfirmation(o)},e.copyTripleContractValueToOtherBlocks=function(t,a){var o={occupancy:"triple_contract",value:t.triple_contract,isContract:!0};e.selectedRoomType=a,e.showMassUpdateEndDateConfirmation(o)},e.copyTripleHeldValueToOtherBlocks=function(t,a){var o={occupancy:"triple",value:t.triple};e.selectedRoomType=a,e.showMassUpdateEndDateConfirmation(o)},e.copyQuadrupleContractValueToOtherBlocks=function(t,a){var o={occupancy:"quadruple_contract",value:t.quadruple_contract,isContract:!0};e.selectedRoomType=a,e.showMassUpdateEndDateConfirmation(o)},e.copyQuadrupleHeldValueToOtherBlocks=function(t,a){var o={occupancy:"quadruple",value:t.quadruple};e.selectedRoomType=a,e.showMassUpdateEndDateConfirmation(o)},e.showMassUpdateEndDateConfirmation=function(t){n.open({template:"/assets/partials/allotments/details/rvAllotmentConfirmMassUpdatePopup.html",scope:e,className:"",closeByDocument:!1,closeByEscape:!1,data:JSON.stringify(t),controller:"rvAllotmentRoomBlockMassUpdatePopupCtrl"})},e.shouldShowLoadNextSetButton=function(){var t=new tzIndependentDate(e.timeLineStartDate);t.setDate(t.getDate()+14);var a=t<e.allotmentConfigData.summary.block_to;return p&&a},e.fetchNextSetOfRoomBlockData=function(){e.timeLineStartDate.setDate(e.timeLineStartDate.getDate()+14),e.fetchCurrentSetOfRoomBlockData()},e.fetchCurrentSetOfRoomBlockData=function(){var t=e.allotmentConfigData.summary.block_from,a=e.allotmentConfigData.summary.block_to;t>e.timeLineStartDate&&(e.timeLineStartDate=new tzIndependentDate(t)),e.timeLineEndDate=new tzIndependentDate(e.timeLineStartDate),e.timeLineEndDate.setDate(e.timeLineStartDate.getDate()+14),e.timeLineStartDate>a&&(e.timeLineStartDate=new tzIndependentDate(a)),e.timeLineEndDate>a&&(e.timeLineEndDate=new tzIndependentDate(a));var o={start_date:F(e.timeLineStartDate),end_date:F(e.timeLineEndDate)};e.fetchRoomBlockGridDetails(o)},e.onTimeLineStartDatePicked=function(t,a){e.timeLineStartDate=new tzIndependentDate(i.get_date_from_date_picker(a)),e.fetchCurrentSetOfRoomBlockData()},e.bookingDataChanging=function(){e.hasBookingDataChanged=!0,m=!1,f=!1,D()};var D=function(){e.$$phase||e.$digest()};!function(){var t={CONTRACT:"/assets/partials/allotments/details/grids/rvAllotmentConfigurationContractGrid.html",CURRENT:"/assets/partials/allotments/details/grids/rvAllotmentConfigurationCurrentGrid.html",RELEASE:"/assets/partials/allotments/details/grids/rvAllotmentConfigurationReleaseGrid.html"};e.getGridViewTemplateurl=function(e){return t[e]||t.CONTRACT}}(),e.setActiveGridView=function(t){e.activeGridView=t,e.gridViewTemplateUrl=e.getGridViewTemplateurl(e.activeGridView),s(W,500)},e.activeGridViewChanged=function(){e.$emit("showLoader"),s(function(){e.shouldShowDiscardButton()&&e.clickedOnDiscardButton(),e.gridViewTemplateUrl=e.getGridViewTemplateurl(e.activeGridView),e.$emit("hideLoader"),s(W,100)},0),f=!1,m=!1,e.hasBookingDataChanged=!1},e.clickedOnCreateButton=function(){e.createButtonClicked=!0},e.clickedOnSaveButton=function(){e.saveRoomBlock(!1)},e.clickedOnApplyToHeldCountsButton=function(){var t={allotment_id:e.allotmentConfigData.summary.allotment_id,forcefully_overbook_and_assign_rooms:!0},a=function(){e.fetchCurrentSetOfRoomBlockData()},o=function(t){e.errorMessage=t},n={params:t,successCallBack:a,failureCallBack:o};e.callAPI(r.copyContactToHeld,n)},e.clickedOnUpdateContractButton=function(){e.saveRoomBlock(!1,!0)},e.clickedOnUpdateCurrentButton=function(){e.saveRoomBlock(!1)},e.clickedOnDiscardButton=function(){_.each(e.allotmentConfigData.roomblock.selected_room_types_and_bookings,function(e){_.each(e.dates,function(e){e.double=e.old_double,e.double_contract=e.old_double_contract,e.double_pickup=e.old_double_pickup,e.release_days=e.old_release_days,e.single=e.old_single,e.single_contract=e.old_single_contract,e.single_pickup=e.old_single_pickup,e.triple=e.old_triple,e.triple_contract=e.old_triple_contract,e.triple_pickup=e.old_triple_pickup,e.quadruple=e.old_quadruple,e.quadruple_contract=e.old_quadruple_contract,e.quadruple_pickup=e.old_quadruple_pickup})}),e.hasBookingDataChanged=!1,m=!1,f=!1};var A=function(t){return t.saved_room_block?(m=!m,f=!f,_.each(e.allotmentConfigData.roomblock.selected_room_types_and_bookings,function(e){_.each(e.dates,function(e){e.old_double=e.double,e.old_double_contract=e.double_contract,e.old_double_pickup=e.double_pickup,e.old_release_days=e.release_days,e.old_single=e.single,e.old_single_contract=e.single_contract,e.old_single_pickup=e.single_pickup,e.old_triple=e.triple,e.old_triple_contract=e.triple_contract,e.old_triple_pickup=e.triple_pickup,e.old_quadruple=e.quadruple,e.old_quadruple_contract=e.quadruple_contract,e.old_quadruple_pickup=e.quadruple_pickup})}),e.hasBookingDataChanged=!1,e.allotmentConfigData.summary.rooms_total=e.getMaxOfBookedRooms(),void e.fetchCurrentSetOfRoomBlockData()):(e.saveRoomBlock(!0),!1)};e.checkOverBooking=function(e){var t=e.is_house_overbooked,a=e.is_room_type_overbooked,o=g(),n=v(),r=o&&n;return!(!a&&!t)&&(t&&a&&r?"HOUSE_AND_ROOMTYPE_OVERBOOK":t&&o?"HOUSE_OVERBOOK":a&&n?"ROOMTYPE_OVERBOOK":"NO_PERMISSION")};var C=function(t){if(t.hasOwnProperty("httpStatus")){if(470===t.httpStatus){var a=e.checkOverBooking(t);a?"NO_PERMISSION"===a?S():R(a):e.saveRoomBlock(!0)}}else e.errorMessage=t};e.saveRoomBlock=function(t,a,o){t=t||!1,a=a||!1;var n=e.allotmentConfigData.roomblock.selected_room_types_and_bookings,s={allotment_id:e.allotmentConfigData.summary.allotment_id,results:n,forcefully_overbook_and_assign_rooms:t,is_contract_save:a,overbook_chosen:o},i={params:s,successCallBack:A,failureCallBack:C};e.callAPI(r.saveRoomBlockBookings,i)},e.saveReleaseDays=function(a,o){var n={allotment_id:e.allotmentConfigData.summary.allotment_id,results:e.allotmentConfigData.roomblock.selected_room_types_and_bookings},s=e.allotmentConfigData.summary.block_from,i=new tzIndependentDate(t.businessDate);a&&(n.start_date=s,s<i&&(n.start_date=i),n.start_date=F(n.start_date),n.release_days=parseInt(a),n.end_date=F(o));var l={params:n,successCallBack:A,failureCallBack:C};e.callAPI(r.saveRoomBlockReleaseDays,l)};var S=function(){n.open({template:"/assets/partials/allotments/details/rvAllotmentNoPermissionOverBookingPopup.html",className:"",scope:e,closeByDocument:!1,closeByEscape:!1})},R=function(t){var a={message:t};n.open({template:"/assets/partials/allotments/details/rvAllotmentWarnOverBookingPopup.html",className:"",scope:e,closeByDocument:!1,closeByEscape:!1,data:JSON.stringify(a)})},b=function(){n.open({template:"/assets/partials/allotments/details/rvAllotmentAddRoomAndRatesPopup.html",scope:e,controller:"rvAllotmentAddRoomsAndRatesPopupCtrl"})};e.getRoomTypeName=function(t){t=parseInt(t);var a=_.findWhere(e.roomTypes,{id:t});return a?a.name:""},e.getTotalContractedOfDay=function(t){var a=(i.convertToInteger,0),o=e.allotmentConfigData.roomblock.selected_room_types_and_bookings;return _.each(o,function(o){var n=o.dates[t],r=e.getTotalContractedOfIndividualRoomType(n);a+=r}),a},e.getTotalHeldOfDay=function(t){var a=(i.convertToInteger,0),o=e.allotmentConfigData.roomblock.selected_room_types_and_bookings;return _.each(o,function(o){var n=o.dates[t],r=e.getTotalHeldOfIndividualRoomType(n);a+=r}),a},e.getTotalPickedUpOfDay=function(t){var a=(i.convertToInteger,0),o=e.allotmentConfigData.roomblock.selected_room_types_and_bookings;return _.each(o,function(o){var n=o.dates[t],r=e.getTotalPickedUpOfIndividualRoomType(n);a+=r}),a},e.getTotalContractedOfIndividualRoomType=function(e){var t=i.convertToInteger;e.single_contract=""!==e.single_contract?t(e.single_contract):"",e.double_contract=""!==e.double_contract?t(e.double_contract):"";var a=0;e.quadruple_contract&&(e.quadruple_contract=t(e.quadruple_contract),a=e.quadruple_contract);var o=0;return e.triple_contract&&(e.triple_contract=t(e.triple_contract),o=e.triple_contract),t(e.single_contract)+t(e.double_contract)+o+a},e.getTotalHeldOfIndividualRoomType=function(e){var t=i.convertToInteger;e.single=""!==e.single?t(e.single):"",e.double=""!==e.double?t(e.double):"";var a=0;e.quadruple&&(e.quadruple=t(e.quadruple),a=e.quadruple);var o=0;return e.triple&&(e.triple=t(e.triple),o=e.triple),t(e.single)+t(e.double)+o+a},e.getTotalPickedUpOfIndividualRoomType=function(e){var t=i.convertToInteger;e.single_pickup=""!==e.single_pickup?t(e.single_pickup):"",e.double_pickup=""!==e.double_pickup?t(e.double_pickup):"";var a=0;e.quadruple_pickup&&(e.quadruple_pickup=t(e.quadruple_pickup),a=e.quadruple_pickup);var o=0;return e.triple_pickup&&(e.triple_pickup=t(e.triple_pickup),o=e.triple_pickup),t(e.single_pickup)+t(e.double_pickup)+o+a},e.getMaxOfBookedRooms=function(){var t=e.allotmentConfigData.roomblock.selected_room_types_and_bookings,a=[],o=[],n={},r=0;if(!t.length)return 0;_.each(t,function(e){_.each(e.dates,function(e){o.push(e)})}),n=_.groupBy(o,"date"),_.each(n,function(t){r=0,_.each(t,function(t){r+=e.getTotalHeldOfIndividualRoomType(t)}),a.push(r)});var s=_.max(a);return s};var O=function(t){e.allotmentConfigData.roomblock.selected_room_types_and_rates=t.room_type_and_rates},T=function(){e.$emit("hideLoader"),b()},P=function(t){e.errorMessage=t,e.$emit("hideLoader")};e.clickedOnAddRoomsAndRatesButton=function(){var t=e.shouldDisableAddRoomsAndRate();if(!t){var a=[];e.$emit("showLoader");var o={id:e.allotmentConfigData.summary.allotment_id};a.push(r.getSelectedRoomTypesAndRates(o).then(O)),l.all(a).then(T,P)}},e.confirmUpdateRatesWithPickedReservations=function(t){d=t,n.open({template:"/assets/partials/allotments/details/rvAllotmentRoomBlockPickedupReservationsPopup.html",scope:e,className:"",closeByDocument:!1,closeByEscape:!1})},e.checkIfInhouseReservationsExists=function(){n.close();var t=!1;angular.forEach(d,function(e){e.total_inhouse_reservations_count>0&&(t=!0)}),t?k():e.saveNewRoomTypesAndRates()};var k=function(){n.open({template:"/assets/partials/allotments/details/rvAllotmentInhouseReservationsExistsPopup.html",scope:e,className:"",closeByDocument:!1,closeByEscape:!1})};e.updateRateToNewReservations=function(){n.close(),angular.forEach(d,function(e){e.is_configured_in_allotment&&(e.update_existing_reservations_rate=!1)}),e.saveNewRoomTypesAndRates()},e.saveNewRoomTypesAndRates=function(){n.close();var t={params:M(d),successCallBack:N};e.callAPI(r.updateSelectedRoomTypesAndRates,t)};var N=function(){e.fetchCurrentSetOfRoomBlockData()},M=function(t){var a=_.filter(t,function(e){return"undefined"!=typeof e.room_type_id&&""!==e.room_type_id}),o=["room_type_id","single_rate","double_rate","extra_adult_rate","rate_id","best_available_rate_id","update_existing_reservations_rate"];a=i.getListOfKeyValuesFromAnArray(a,o);var n={allotment_id:e.allotmentConfigData.summary.allotment_id,room_type_and_rates:a};return n},I=function(a){e.$emit("showLoader"),s(function(){var o=(e.allotmentConfigData.roomblock,new tzIndependentDate(t.businessDate));e.hasBookingDataChanged=!1,_.each(a.results,function(t){t.copy_values_to_all=!1,t.start_date=F(e.timeLineStartDate),_.each(t.dates,function(t){var a=new tzIndependentDate(t.date);t.isModifiable=a>=o,t.old_total=e.getTotalHeldOfIndividualRoomType(t),t.old_double=t.double,t.old_double_contract=t.double_contract,t.old_double_pickup=t.double_pickup,t.old_release_days=t.release_days,t.old_single=t.single,t.old_single_contract=t.single_contract,t.old_single_pickup=t.single_pickup,t.old_triple=t.triple,t.old_triple_contract=t.triple_contract,t.old_triple_pickup=t.triple_pickup,t.old_quadruple=t.quadruple,t.old_quadruple_contract=t.quadruple_contract,t.old_quadruple_pickup=t.quadruple_pickup})}),_.each(a.occupancy,function(e){e.ui_release_days=""}),_.extend(e.allotmentConfigData.roomblock,{common_ui_release_days:"",selected_room_types_and_bookings:a.results,selected_room_types_and_occupanies:a.occupancy}),e.totalPickups=a.total_picked_count,e.eventsCount=a.eventsCount,J(),e.$emit("hideLoader");var n="room_block_scroller",r="room_rates_timeline_scroller",s="room_rates_grid_scroller",i=U(r),l=U(s),c=U(n);i.scrollTo(9999,0),l.scrollTo(9999,0),c.scrollTo(9999,0),D()},0)};e.$on("NG_REPEAT_COMPLETED_RENDERING",function(e){s(function(){J()},0)}),e.releaseDaysEdited=!1,e.copyReleaseRangeDown=function(t,a){var o=1*t;""==t||isNaN(o)||_.each(e.allotmentConfigData.roomblock.selected_room_types_and_bookings,function(t){t.hasOwnProperty("dates")&&t.dates[a]&&(t.dates[a].release_days=o,e.releaseDaysEdited=!0)})},e.copyReleaseRangeToAllBlocks=function(t){var a=1*t;if(""!=t&&!isNaN(a)){var o={value:t,isReleaseDays:!0};e.showMassUpdateEndDateConfirmation(o)}},e.releaseDateChanging=function(){e.releaseDaysEdited=!0,D()},e.resetReleaseDaysEdit=function(){var t=e.allotmentConfigData.roomblock;t.common_ui_release_days="",_.each(t.selected_room_types_and_occupanies,function(e){e.ui_release_days=""}),_.each(t.selected_room_types_and_bookings,function(e){_.each(e.dates,function(e){e.release_days=e.old_release_days})}),e.releaseDaysEdited=!1},e.saveReleaseDaysEdit=function(){e.saveReleaseDays(),e.releaseDaysEdited=!1};var E=function(t){e.errorMessage=t};e.fetchRoomBlockGridDetails=function(t){t=t||{};var a=h()&&y();if(a){var o=_.extend(t,{allotment_id:e.allotmentConfigData.summary.allotment_id}),n={params:o,successCallBack:I,failureCallBack:E};e.callAPI(r.getRoomBlockGridDetails,n)}};var B=e.$on("ALLOTMENT_TAB_SWITCHED",function(a,o){"ROOM_BLOCK"===o&&(e.$emit("FETCH_SUMMARY"),e.timeLineStartDate=new tzIndependentDate(t.businessDate),e.fetchCurrentSetOfRoomBlockData(),0===e.allotmentConfigData.summary.rooms_total?e.setActiveGridView("CONTRACT"):e.setActiveGridView("CURRENT"))}),L=e.$on("UPDATED_ALLOTMENT_INFO",function(t){u=_.extend({},e.allotmentConfigData.summary),e.hasBlockDataUpdated&&e.fetchCurrentSetOfRoomBlockData(),q()}),w=e.$on("FAILED_TO_UPDATE_ALLOTMENT_INFO",function(t,a){e.$parent.errorMessage=a});e.$on("$destroy",B),e.$on("$destroy",L),e.$on("$destroy",w),e.formatDateForUI=function(e,o){var n=typeof e,r="",o=o?o:t.dateFormat;switch(n){case"string":r=a("date")(new tzIndependentDate(e),o);break;case"object":r=a("date")(e,o)}return r};var F=function(e){return a("date")(e,t.dateFormatForAPI)};e.getWidthForContractViewTimeLine=function(){var t=280*e.allotmentConfigData.roomblock.selected_room_types_and_occupanies.length+140;return e.shouldShowLoadNextSetButton()&&(t+=80),t+"px"},e.getWidthForCurrentViewTimeLine=function(){var t=180*e.allotmentConfigData.roomblock.selected_room_types_and_occupanies.length+40;return e.shouldShowLoadNextSetButton()&&(t+=80),t+"px"},e.getWidthForReleaseViewTimeLine=function(){var t=180*e.allotmentConfigData.roomblock.selected_room_types_and_occupanies.length+40;return e.shouldShowLoadNextSetButton()&&(t+=80),t+"px"};var j=function(){e.accordionInitiallyNotCollapsedOptions={header:"p.line-toggle",heightStyle:"content",collapsible:!0,activate:function(e,t){isEmpty(t.newHeader)&&isEmpty(t.newPanel)?t.oldHeader.removeClass("open"):isEmpty(t.oldHeader)&&t.newHeader.addClass("open"),J()}}},V=function(){e.createButtonClicked=!0,e.totalPickups=e.totalRooms=0,e.hasBlockDataUpdated=!1,e.selectedHoldStatus="";var t=!e.isInAddMode(),a=e.allotmentConfigData;e.detailsGridTimeLine=[],e.hasBookingDataChanged=!1,_.extend(e.allotmentConfigData.roomblock,{selected_room_types_and_bookings:[],selected_room_types_and_occupanies:[],selected_room_types_and_rates:[]}),t&&(e.createButtonClicked=!0,e.totalPickups=a.summary.rooms_pickup,e.totalRooms=a.summary.rooms_total,e.selectedHoldStatus=i.convertToInteger(a.summary.hold_status)),e.holdStatusList=a.holdStatusList},J=function(){U("room_block_scroller")&&U("room_block_scroller").refresh(),U("room_rates_timeline_scroller")&&U("room_rates_timeline_scroller").refresh(),U("room_rates_grid_scroller")&&U("room_rates_grid_scroller").refresh()},U=function(t){var a=e.$parent.myScroll&&e.$parent.myScroll[t];return _.isUndefined(a)&&(a=e.myScroll[t]),a},x=function(){var t="room_block_scroller",a="room_rates_timeline_scroller",o="room_rates_grid_scroller",n={tap:!0,preventDefault:!1,probeType:3,mouseWheel:!0},r=_.extend({scrollX:!0,scrollY:!1,scrollbars:!1},i.deepCopy(n)),l=_.extend({scrollY:!0,scrollX:!0},i.deepCopy(n));e.setScroller(t,n),e.setScroller(a,r),e.setScroller(o,l),$("#allotment-room-block-content input").on("focus",function(e){U(a).disable()}),$("#allotment-room-block-content").on("scroll",function(e){var t=e.currentTarget.scrollLeft;t>0&&$(this).scrollLeft(0)}),s(function(){U(a).on("scroll",function(){var e=this.x,t=U(o);t.scrollTo(e,t.y),Math.abs(this.maxScrollX)-Math.abs(this.x)<=150?p||(p=!0,D()):p&&(p=!1,D())}),U(t).on("scroll",function(){var e=this.y,t=U(o);t.scrollTo(t.x,e)}),U(o).on("scroll",function(){var e=this.x,o=this.y;U(a).scrollTo(e,0),U(t).scrollTo(0,o),Math.abs(this.maxScrollX)-Math.abs(this.x)<=150?p||(p=!0,D()):p&&(p=!1,D())})},1e3)},H=function(){var t=e.isInAddMode()?"menuCreateAllotment":"menuManageAllotment";e.$emit("updateRoverLeftMenu",t)},q=function(){var a=e.allotmentConfigData.summary,o=new tzIndependentDate(t.businessDate);e.timeLineStartDate=new tzIndependentDate(a.block_from),a.block_from<o&&(e.timeLineStartDate=o),e.timeLineEndDate=new tzIndependentDate(a.block_to);var n=(e.allotmentConfigData.summary,{dateFormat:t.jqDateFormat,numberOfMonths:1}),r=new tzIndependentDate(a.block_to);r.setDate(r.getDate()-1),e.timeLineStartDateOptions=_.extend({minDate:a.block_from,maxDate:r,onSelect:e.onTimeLineStartDatePicked},n)},G=function(){0===e.allotmentConfigData.summary.rooms_total?e.setActiveGridView("CONTRACT"):e.setActiveGridView("CURRENT"),u=_.extend({},e.allotmentConfigData.summary),e.isUpdateInProgress=!1},z=function(){e.timeLineStartDate=new tzIndependentDate(t.businessDate),e.fetchCurrentSetOfRoomBlockData()};e.showHouseEventsListPopup=function(t,a){t&&(e.selectedEventDisplayDate=a,n.open({template:"/assets/partials/popups/rvHouseEventsListPopup.html",scope:e,controller:"rvHouseEventsListPopupCtrl",className:"ngdialog-theme-default",closeByDocument:!1,closeByEscape:!0}))};var W=(function(){H(),G(),e.isInAddMode()||q(),x(),j(),V(),"ROOM_BLOCK"===e.allotmentConfigData.activeTab&&z()}(),function(){x(),j()});e.$on("UPDATE_ERR_MSG",function(t,a){e.errorMessage=a}),e.shouldShowCopyButton=function(t){var a;switch(typeof t){case"string":a=new tzIndependentDate(t);break;case"object":a=new tzIndependentDate(t.date)}return a.getTime()===e.allotmentConfigData.summary.block_from.getTime()}}]),sntRover.controller("rvAllotmentRoomBlockMassUpdatePopupCtrl",["$scope","$rootScope","$filter","rvPermissionSrv","ngDialog","$timeout","rvUtilSrv","rvAllotmentConfigurationSrv",function(e,t,a,o,n,r,s,i){var l=!1,c=function(e){return a("date")(e,t.dateFormatForAPI)},u=function(t){var a=new tzIndependentDate(t);return a<=e.massUpdateEndDate},d=function(e,t,a){e.every(function(e){return!!u(e.date)&&(e[t]=parseInt(a),!0)})};e.clickedOnSaveButton=function(t){var a=e.allotmentConfigData.roomblock,o=e.ngDialogData.isReleaseDays||!1,n=e.ngDialogData.value,s=e.massUpdateStartDate;e.massUpdateEndDate;if(o)d(a.selected_room_types_and_occupanies,"ui_release_days",n),_.each(a.selected_room_types_and_bookings,function(e){d(e.dates,"release_days",n),e.copy_values_to_all=!0}),e.saveReleaseDays(n,e.massUpdateEndDate),r(e.closeDialog,100);else{var i=e.selectedRoomType,u=e.ngDialogData.occupancy,m=e.ngDialogData.isContract||!1,f=_.omit(i,["dates"]);f=_.extend(f,i.dates[0]),f[u]=n;var p=_.extend(f,{start_date:c(s),end_date:c(e.massUpdateEndDate),bulk_updated_for:u.toUpperCase(),overbook_chosen:t});e.saveMassUpdate(l,m,p)}};var m=function(t){return t.saved_room_block?(e.fetchCurrentSetOfRoomBlockData(),void e.closeDialog()):(e.saveMassUpdate(!0,!1,p),!1)},f=function(t){if(t.hasOwnProperty("httpStatus")){if(470===t.httpStatus){var a=e.checkOverBooking(t);a?"NO_PERMISSION"===a?e.disableButtons=!0:(e.overBookingMessage=a,l=!0):e.saveMassUpdate(!0,!1,p)}}else e.$emit("UPDATE_ERR_MSG",t),e.closeDialog()},p=null;e.saveMassUpdate=function(t,a,o){t=t||!1,a=a||!1,o=o||{},o=_.pick(o,["allotment_id","overbook_chosen","forcefully_overbook_and_assign_rooms","start_date","end_date","is_contract_save","bulk_updated_for","room_type_id","room_type_name","release_days","single","single_contract","double","double_contract","old_total","old_double","old_double_contract","old_release_days","old_single","old_single_contract","quadruple","quadruple_contract","triple","triple_contract","old_quadruple","old_quadruple_contract","old_triple","old_triple_contract"]);var n=_.extend(o,{allotment_id:e.allotmentConfigData.summary.allotment_id,forcefully_overbook_and_assign_rooms:t,is_contract_save:a,results:o.data}),r={params:n,successCallBack:m,failureCallBack:f};e.callAPI(i.saveMassUpdate,r),p=o,l=!1};var v=function(t,a){e.massUpdateEndDate=new tzIndependentDate(s.get_date_from_date_picker(a))},g=function(){var a=e.allotmentConfigData.summary,o={dateFormat:t.jqDateFormat,numberOfMonths:1},n=new tzIndependentDate(a.block_to);n.setDate(n.getDate()-1),e.massUpdateEndDate=new tzIndependentDate(n),e.massUpdateEndDateOptions=_.extend({minDate:e.timeLineStartDate,maxDate:n,onSelect:v},o)},h=function(){BaseCtrl.call(this,e),g(),e.massUpdateStartDate=e.timeLineStartDate,e.showSaveButton=!0,e.overBookingMessage=""};h()}]),sntRover.controller("rvAllotmentSearchCtrl",["$scope","$rootScope","rvAllotmentSrv","initialAllotmentListing","businessDate","$filter","$timeout","$state","rvUtilSrv","rvPermissionSrv","$stateParams",function(e,t,a,o,n,r,s,i,l,c,u){BaseCtrl.call(this,e);var d="ALLOTMENT_LIST";e.isEmpty=l.isEmpty,e.getClassAgainstHoldStatus=function(e){return"true"===e.is_take_from_inventory?"":"tentative"};var m=function(e){return"cancel"===e.hold_status.toLowerCase()};e.getClassAgainstPickedStatus=function(e){var t="";return e.total_picked_count>0&&(t="green"),m(e)&&(t+=" red"),t},e.getGuestClassForArrival=function(e){var t=m(e)?"cancel":"check-in";return t},e.getGuestClassForDeparture=function(e){var t=m(e)?"cancel":"check-out";return t},e.clearFromDate=function(){e.fromDate="",e.fromDateForAPI="",f(),e.search()},e.clearToDate=function(){e.toDate="",e.toDateForAPI="",f(),e.search()},e.clearSearchQuery=function(){e.query="",f(),e.search()},e.stringify=l.stringify;var f=function(){e.$$phase||e.$digest()},p=function(t,a){e.fromDate=t,e.fromDateForAPI=tzIndependentDate(l.get_date_from_date_picker(a)),f(),e.search()},v=function(t,a){e.toDate=t,e.toDateForAPI=tzIndependentDate(l.get_date_from_date_picker(a)),f(),e.search()};e.$on("NG_REPEAT_STARTED_RENDERING",function(t){e.$emit("showLoader")}),e.$on("NG_REPEAT_COMPLETED_RENDERING",function(t){s(function(){C()},300),e.$emit("hideLoader")}),e.hasPermissionToAddNewAllotment=function(){return c.getPermissionValue("CREATE_ALLOTMENT_SUMMARY")},e.searchQueryChanged=function(){return!e.isEmpty(e.query)&&void e.search()};var g=function(a){var o={query:e.query,from_date:""!==e.fromDateForAPI?r("date")(e.fromDateForAPI,t.dateFormatForAPI):"",to_date:""!==e.toDateForAPI?r("date")(e.toDateForAPI,t.dateFormatForAPI):"",per_page:e.perPage,page:a};return o};e.search=function(t){e.amFirstTimeHere=!1,t=t||1;var o=g(t),n={params:o,successCallBack:h,successCallBackParameters:t,failureCallBack:y};e.callAPI(a.getAllotmentList,n)};var h=function(t,a){e.allotmentList=t.allotments,e.totalResultCount=t.total_count,C(),e.refreshPagination(d),setTimeout(function(){e.$broadcast("updatePageNo",a)},150)},y=function(t){e.errorMessage=t},D=function(){var a={showOn:"button",dateFormat:t.jqDateFormat,numberOfMonths:1};e.fromDateOptions=_.extend({onSelect:p},a),e.toDateOptions=_.extend({onSelect:v},a),e.fromDate=r("date")(tzIndependentDate(n.business_date),t.dateFormat),e.fromDateForAPI=tzIndependentDate(n.business_date),e.toDate="",e.toDateForAPI=""},A=function(){var t={tap:!0,preventDefault:!1,deceleration:1e-4,shrinkScrollbars:"clip"};e.setScroller("result_showing_area",t)},C=function(){e.refreshScroller("result_showing_area")},S=function(){e.perPage=a.DEFAULT_PER_PAGE,e.start=1,e.end=o.allotments.length,e.page=1};e.formatDateForUI=function(e){var a=typeof e,o="";switch(a){case"string":o=r("date")(new tzIndependentDate(e),t.dateFormat);break;case"object":o=r("date")(e,t.dateFormat)}return o},e.shouldShowPagination=function(){return e.totalResultCount>=e.perPage};var R=function(){return e.allotmentList&&e.allotmentList.length>0};e.isFirstTimeWithNoResult=function(){return e.amFirstTimeHere&&!R()},e.shouldShowNoResult=function(){return!e.amFirstTimeHere&&!R()},e.gotoAddNewAllotment=function(){i.go("rover.allotments.config",{id:"NEW_ALLOTMENT",newAllotmentName:e.query})};var b=function(){return{fromDate:e.fromDate,fromDateForAPI:e.fromDateForAPI,toDate:e.toDate,toDateForAPI:e.toDateForAPI,query:e.query,page:e.pageOptions.currentPage}},O=function(){var t=a.getCache();t&&"BACK_TO_ALLOTMENT_SEARCH_LIST"===u.origin?(D(),e.fromDate=t.fromDate,e.fromDateForAPI=t.fromDateForAPI,e.toDate=t.toDate,e.toDateForAPI=t.toDateForAPI,e.query=t.query,e.search(t.page),a.clearCache()):(D(),e.allotmentList=o.allotments,e.totalResultCount=o.total_count,e.refreshPagination(d))};e.gotoEditAllotmentConfiguration=function(e){var t=b();a.updateCache(t),i.go("rover.allotments.config",{id:e,activeTab:"SUMMARY"})};var T=function(){e.pageOptions={id:d,perPage:e.perPage,api:e.search}};(function(){e.setHeadingTitle("ALLOTMENTS"),e.$emit("updateRoverLeftMenu","menuManageAllotment"),e.amFirstTimeHere=!0,A(),S(),T(),O()})()}]),sntRover.controller("rvAllotmentConfigurationAddonsCtrl",["$scope","$rootScope","RVReservationAddonsSrv","rvAllotmentConfigurationSrv","ngDialog",function(e,t,a,o,n){BaseCtrl.call(this,e),e.setScroller("enhanceAllotmentStays"),t.setPrevState={title:"ALLOTMENT DETAILS",name:"rover.allotments.config",callback:"backToAllotmentDetails",scope:e},e.setHeadingTitle("Add-ons & Packages");var r=function(){e.refreshScroller("enhanceAllotmentStays")};e.activeAddonCategoryId=-1,e.addons=[],e.selectAddonCategory=function(t,a){a.stopPropagation(),""!==t?(e.activeAddonCategoryId=t.id,e.fetchAddons(t.id)):(e.activeAddonCategoryId=-1,e.fetchAddons())},e.backToAllotmentDetails=function(){e.closeAllotmentAddonsScreen()};var s=function(t){var a=_.where(t.rate_addons,{is_inclusive:!0});e.allotmentConfigData.addons.inclusiveAddons=a,e.addons=[],e.$emit("hideLoader"),e.addons=[],e.$emit("hideLoader"),angular.forEach(t.results,function(t){if(null!==t){var a={};a.id=t.id,a.isBestSeller=t.bestseller,a.category=t.charge_group.name,a.title=t.name,a.description=t.description,a.price=t.amount,a.taxes=t.taxes,a.stay="",""!==t.amount_type&&(a.stay=t.amount_type.description),""!==t.post_type&&(""!==a.stay?a.stay+=" / "+t.post_type.description:a.stay=t.post_type.description),a.amountType=t.amount_type,a.postType=t.post_type,a.amountTypeDesc=t.amount_type.description,a.postTypeDesc=t.post_type.description,a.custom_nightly_selected_post_days=t.custom_nightly_selected_post_days,e.addons.push(a)}}),r()};e.fetchAddons=function(t){var o=void 0===t?"":t,n=void 0===t;e.callAPI(a.fetchAddons,{successCallBack:s,params:{charge_group_id:o,is_bestseller:n,from_date:e.allotmentConfigData.summary.block_from,to_date:e.allotmentConfigData.summary.block_to,
is_active:!0,is_not_rate_only:!0,no_pagination:!0}})},e.isInAddonSelectionMode()&&e.fetchAddons(),e.openAddonsPopup=function(){e.addonPopUpData={cancelLabel:"Cancel",saveLabel:"Save",number_of_adults:1,number_of_children:1,duration_of_stay:1,addonPostingMode:"create_allotment"},e.packageData={duration_of_stay:e.duration_of_stay},e.packageData.existing_packages=e.allotmentConfigData.selectedAddons,_.each(e.packageData.existing_packages,function(e){e.totalAmount=e.amount*e.addon_count}),n.open({template:"/assets/partials/packages/showPackages.html",controller:"RVReservationPackageController",className:"",scope:e,closeByDocument:!1,closeByEscape:!1})};var i=function(t){e.allotmentConfigData.selectedAddons=t,e.computeAddonsCount(),e.openAddonsPopup()},l=function(t){e.errorMessage=t};e.selectAddon=function(t,a){var n={addon_id:t.id,addon_count:parseInt(a),id:e.allotmentConfigData.summary.allotment_id},r={successCallBack:i,failureCallBack:l,params:n};e.callAPI(o.addAllotmentEnhancement,r)};var c=function(t){e.allotmentConfigData.selectedAddons=t,e.packageData.existing_packages=e.allotmentConfigData.selectedAddons,e.computeAddonsCount()},u=function(t){e.errorMessage=t};e.removeAddon=function(t){var a={addon_id:t.id,id:e.allotmentConfigData.summary.allotment_id},n={successCallBack:c,failureCallBack:u,params:a};e.callAPI(o.removeAllotmentEnhancement,n)};var d=function(){var t={id:e.allotmentConfigData.summary.allotment_id,addon_id:e.selectedPurchesedAddon.id,post_instances:e.selectedPurchesedAddon.post_instances,start_date:e.selectedPurchesedAddon.start_date,end_date:e.selectedPurchesedAddon.end_date,selected_post_days:e.selectedPurchesedAddon.selected_post_days},a={successCallBack:function(){e.$emit("hideLoader"),e.reloadPage()},params:t};e.callAPI(o.updateAddonPosting,a)},m=e.$on("PROCEED_BOOKING",function(t,a){"create_allotment"===a.addonPostingMode&&(e.selectedPurchesedAddon=a.selectedPurchesedAddon,d())}),f=t.$on("REMOVE_ADDON",function(t,a){"create_allotment"===a.addonPostingMode&&e.removeAddon(e.packageData.existing_packages[a.index])});e.addListener("CLOSE_ADDON_POPUP",function(t,a){"create_allotment"===a.addonPostingMode&&e.reloadPage()}),e.$on("$destroy",m),e.$on("$destroy",f)}]),sntRover.controller("rvAllotmentConfigurationSummaryTabCtrl",["$scope","jsMappings","$rootScope","rvAllotmentSrv","$filter","$stateParams","rvAllotmentConfigurationSrv","dateFilter","RVReservationSummarySrv","ngDialog","RVReservationAddonsSrv","RVReservationCardSrv","rvUtilSrv","$state","rvPermissionSrv","$q",function(e,t,a,o,n,r,s,i,l,c,u,d,m,f,p,v){var g,h,y=function(){var t=e.allotmentConfigData.summary;for(var a in g)if(!_.isEqual(t[a],g[a]))return!0;return!1},D=function(){e.$$phase||e.$digest()};e.$on("OUTSIDECLICKED",function(t,a){var o=e.isInAddMode(),n=a&&("summary"===a.id||"cancel-action"===a.id),r=e.allotmentSummaryData.isDemographicsPopupOpen,s=e.isUpdateInProgress;o||n||e.focusedCompanyCard||e.focusedTravelAgent||!y()||r||s||(e.isUpdateInProgress=!0,e.updateAllotmentSummary())}),e.$on("UPDATED_ALLOTMENT_INFO",function(t,a){g=angular.copy(e.allotmentConfigData.summary),e.isUpdateInProgress=!1});var A=a.$on("NAVIGATE_TO_ADDONS",function(t,a){"allotments"===a.addonPostingMode&&e.manageAddons()}),C=e.$on("PROCEED_BOOKING",function(t,a){"allotments"===a.addonPostingMode&&(e.selectedPurchesedAddon=a.selectedPurchesedAddon,R())}),S=a.$on("REMOVE_ADDON",function(t,a){"allotments"===a.addonPostingMode&&e.removeAddon(e.packageData.existing_packages[a.index])});e.$on("$destroy",C),e.$on("$destroy",S),e.$on("$destroy",A);var R=function(){var t={id:e.allotmentConfigData.summary.allotment_id,addon_id:e.selectedPurchesedAddon.id,post_instances:e.selectedPurchesedAddon.post_instances,start_date:e.selectedPurchesedAddon.start_date,end_date:e.selectedPurchesedAddon.end_date,selected_post_days:e.selectedPurchesedAddon.selected_post_days},a={successCallBack:function(){e.$emit("hideLoader")},params:t};e.callAPI(s.updateAddonPosting,a)},b=function(t,a){e.allotmentConfigData.summary.block_from=new tzIndependentDate(m.get_date_from_date_picker(a));var o=e.allotmentConfigData.summary;o.block_from>o.block_to&&(e.allotmentConfigData.summary.block_to=""),e.toDateOptions.minDate=o.block_from,e.computeSegment(),e.allotmentConfigData.summary.block_from&&e.allotmentConfigData.summary.block_to&&pe(),D()},O=function(t){e.allotmentSummaryData.demographics=t.demographics,P()},T=function(e){},P=function(){var t=e.allotmentConfigData.summary,a=e.allotmentSummaryData.demographics,o=t.block_from,n=t.block_to,r="";if(e.forceDemographics=e.shouldShowDemographics(),!n||!o)return!1;var s=Math.floor((new tzIndependentDate(n)-new tzIndependentDate(o))/864e5);_.each(a.segments,function(e){s<e.los&&(r||(r=e.value))}),e.allotmentSummaryData.computedSegment=!!r,t.demographics.segment_id=r};e.computeSegment=function(){if(null===e.allotmentSummaryData.demographics){var t={successCallBack:O,failureCallBack:T};e.callAPI(l.fetchInitialData,t)}else P()};var k=function(t,a){var o=e.allotmentConfigData.summary;o.block_to=new tzIndependentDate(m.get_date_from_date_picker(a)),e.computeSegment(),o.block_from&&o.block_to&&pe(),D()},N=function(t,a){e.allotmentConfigData.summary.release_date=new tzIndependentDate(m.get_date_from_date_picker(a)),D()},M=function(){var t={dateFormat:a.jqDateFormat,numberOfMonths:1,disabled:e.allotmentConfigData.summary.is_cancelled,minDate:tzIndependentDate(a.businessDate),beforeShow:function(e,t){$('<div id="ui-datepicker-overlay" class="transparent" />').insertAfter("#ui-datepicker-div")},onClose:function(e,t){$("#ui-datepicker-overlay").remove()}};e.fromDateOptions=_.extend({onSelect:b},t),e.toDateOptions=_.extend({onSelect:k},t),e.releaseDateOptions=_.extend({onSelect:N},t)},I=function(e){return e.is_use_markets&&e.markets.length>0},E=function(e){return e.is_use_sources&&e.sources.length>0},B=function(e){return e.is_use_origins&&e.origins.length>0},L=function(e){return e.is_use_segments&&e.segments.length>0},w=function(t){var a=!0;return I(t)&&e.hotelSettings.force_market_code&&(a=!!e.allotmentConfigData.summary.demographics.market_segment_id),E(t)&&e.hotelSettings.force_source_code&&a&&(a=!!e.allotmentConfigData.summary.demographics.source_id),B(t)&&e.hotelSettings.force_origin_of_booking&&a&&(a=!!e.allotmentConfigData.summary.demographics.booking_origin_id),L(t)&&e.hotelSettings.force_segments&&a&&(a=!!e.allotmentConfigData.summary.demographics.segment_id),a};e.isDemographicsFormValid=function(t){var a=!0;return t&&(a=w(e.allotmentSummaryData.demographics)),a};var F=function(){e.allotmentSummaryData.isDemographicsPopupOpen=!0,h=angular.copy(e.allotmentConfigData.summary.demographics),c.open({template:"/assets/partials/allotments/summary/allotmentDemographicsPopup.html",className:"",scope:e,closeByDocument:!1,closeByEscape:!1,preCloseCallback:function(){e.allotmentSummaryData.isDemographicsPopupOpen=!1}})};e.openDemographicsPopup=function(t,a){if(e.isInAddMode()&&(!e.forceDemographics||a))return void(e.errorMessage=["Please save the allotment first"]);e.errorMessage="";var o=function(a){e.allotmentSummaryData.demographics=a.demographics,e.setDemographicFields(t),F()},n=function(e){},r={successCallBack:o,failureCallBack:n};null===e.allotmentSummaryData.demographics?e.callAPI(l.fetchInitialData,r):(e.setDemographicFields(t),F())},e.cancelCopyDefaultBilling=function(){x()};var j=function(){e.$emit("hideLoader"),e.allotmentConfigData.summary.default_billing_info_present=!0,x()},V=function(t){e.errorMessage=t};e.copyDefaultBillingFromCards=function(t){var a={allotment_id:e.allotmentConfigData.summary.allotment_id,is_company_card:"COMPANY"==t,is_travel_agent:"TRAVEL_AGENT"==t},o={successCallBack:j,failureCallBack:V,params:a};e.callAPI(s.copyDefaultBillingInfo,o)};var J=function(t,a){c.open({template:"/assets/partials/allotments/summary/rvBillingInfoConfirmPopup.html",className:"ngdialog-theme-default",scope:e})},U=function(){c.open({template:"/assets/partials/allotments/summary/rvBillingInfoConflict.html",className:"ngdialog-theme-default",scope:e})},x=function(){var o=e.allotmentConfigData.summary;e.billingEntity="ALLOTMENT_DEFAULT_BILLING",e.billingInfoModalOpened=!0,e.attachedEntities={},e.billingInformationPresent=o.default_billing_info_present,e.attachedEntities.posting_account=_.extend({},{id:o.allotment_id,name:o.posting_account_name,logo:"ALLOTMENT_DEFAULT"}),e.$emit("showLoader"),t.fetchAssets(["addBillingInfo","directives"]).then(function(){e.$emit("hideLoader"),a.UPDATED_BI_ENABLED_ON.ALLOTMENT?(console.log("##Billing-info updated version"),c.open({template:"/assets/partials/billingInformation/allotment/rvBillingInfoAllotmentMain.html",controller:"rvBillingInfoAllotmentMainCtrl",className:"",scope:e})):(console.log("##Billing-info old version"),c.open({template:"/assets/partials/bill/rvBillingInformationPopup.html",controller:"rvBillingInformationPopupCtrl",className:"",scope:e}))})};e.openBillingInformation=function(){if(e.isInAddMode())return void(e.errorMessage=["Please save the allotment first"]);var t=e.allotmentConfigData.summary;if(t.default_billing_info_present)return void x();var a=t.company&&t.company.default_billing_info_present,o=t.travel_agent&&t.travel_agent.default_billing_info_present;a&&o?(e.conflctCards=[t.company.name,t.travel_agent.name],U()):a?(e.contractRoutingType="COMPANY",J()):o?(e.contractRoutingType="TRAVEL_AGENT",J()):x()},e.$on("BILLINGINFOADDED",function(){e.allotmentConfigData.summary.default_billing_info_present=!0}),e.saveDemographicsData=function(){return e.isInAddMode()?void(e.errorMessage=["Please save the allotment to save Demographics"]):(e.updateAllotmentSummary(),void e.closeDialog())};var H=function(){c.open({template:"/assets/partials/allotments/summary/warnChangeRateNotPossible.html",className:"",scope:e,closeByDocument:!1,closeByEscape:!1})},q=function(t){e.$emit("hideLoader"),e.allotmentConfigData.summary.commission_details=t.commission_details,t.is_changed||t.is_room_rate_available?(g.rate=e.allotmentConfigData.summary.rate,g.contract_id=e.allotmentConfigData.summary.contract_id,g.uniqId=e.allotmentConfigData.summary.uniqId):(H(),e.allotmentConfigData.summary.rate=g.rate,e.allotmentConfigData.summary.contract_id=g.contract_id,e.allotmentConfigData.summary.uniqId=g.uniqId)},G=function(t){e.$emit("hideLoader"),e.errorMessage=t,e.allotmentConfigData.summary.rate=g.rate,e.allotmentConfigData.summary.contract_id=g.contract_id,e.allotmentConfigData.summary.uniqId=g.uniqId};e.updateRate=function(t){c.close();var a=e.allotmentConfigData.summary,o=a.uniqId,n=o&&o.split(":")[0],r=o&&o.split(":")[1],i={allotment_id:a.allotment_id,rate_id:n,contract_id:r};t&&(i.update_existing_reservations_rate=!0);var l={successCallBack:q,failureCallBack:G,params:i};e.callAPI(s.updateRate,l)};var z=function(){c.open({template:"/assets/partials/allotments/details/rvAllotmentInhouseReservationsExistsPopup.html",scope:e,className:"",closeByDocument:!1,closeByEscape:!1})};e.updateRateToNewAndExistingReservations=function(){c.close(),e.allotmentConfigData.summary.total_checked_in_reservations>0?z():e.updateRate(!0)},e.updateRateToNewReservations=function(){c.close(),e.updateRate(!1)};var W=function(){e.isFromSummary=!0,c.open({template:"/assets/partials/allotments/details/rvAllotmentRoomBlockPickedupReservationsPopup.html",scope:e,className:"",closeByDocument:!1,closeByEscape:!1})};e.onRateChange=function(){var t=e.allotmentConfigData.summary,a=t.uniqId,o=a&&a.split(":")[0],n=a&&a.split(":")[1];return e.allotmentConfigData.summary.contract_id=n,e.allotmentConfigData.summary.rate=o,!(!t.allotment_id||!a)&&void(t.rooms_total>0?W():e.updateRate(!1))},e.cancelDemographicChanges=function(){e.allotmentConfigData.summary.demographics=h},e.warnReleaseRooms=function(){e.allotmentConfigData.summary.is_cancelled||e.isInAddMode()||c.open({template:"/assets/partials/allotments/summary/warnReleaseRoomsPopup.html",className:"",scope:e,closeByDocument:!1,closeByEscape:!1})};var Y=function(t){e.closeDialog(),e.$emit("FETCH_SUMMARY")},K=function(t){e.errorMessage=t};e.releaseRooms=function(){var t={allotmentId:e.allotmentConfigData.summary.allotment_id},a={successCallBack:Y,failureCallBack:K,params:t};e.callAPI(s.releaseRooms,a)},e.abortCancelAllotment=function(){e.allotmentConfigData.summary.hold_status=e.allotmentSummaryData.existingHoldStatus,e.closeDialog()};var Q=function(){e.closeDialog(),f.go("rover.allotments.config",{id:e.allotmentConfigData.summary.allotment_id},{reload:!0})},X=function(t){e.errorMessage=t,e.abortCancelAllotment()};e.cancelAllotment=function(t){var a={allotment_id:e.allotmentConfigData.summary.allotment_id,reason:t},o={successCallBack:Q,failureCallBack:X,params:a};e.callAPI(s.cancelAllotment,o)};var Z=function(){e.callAPI(s.updateHoldStatus,{params:{hold_status_id:e.allotmentConfigData.summary.hold_status,id:e.allotmentConfigData.summary.allotment_id},onSuccess:function(){e.allotmentSummaryMemento.hold_status=e.allotmentConfigData.summary.hold_status},onFailure:function(t){e.$emit("showErrorMessage",t),e.allotmentConfigData.summary.hold_status=e.allotmentSummaryMemento.hold_status}})};e.onHoldStatusChange=function(){if(!e.isInAddMode()){var t=_.findWhere(e.allotmentConfigData.holdStatusList,{id:parseInt(e.allotmentConfigData.summary.hold_status)});t&&"Cancel"===t.name&&t.is_system?c.open({template:"/assets/partials/allotments/summary/warnCancelAllotmentPopup.html",className:"",scope:e,closeByDocument:!1,closeByEscape:!1}):(Z(),e.allotmentSummaryData.existingHoldStatus=parseInt(e.allotmentConfigData.summary.hold_status))}},e.isCancellable=function(){return p.getPermissionValue("CANCEL_GROUP")&&!!e.allotmentConfigData.summary.is_cancelled||0===e.allotmentConfigData.summary.total_checked_in_reservations&&0===parseFloat(e.allotmentConfigData.summary.balance)};var ee=function(t){e.allotmentConfigData.selectedAddons=t,e.allotmentConfigData.selectedAddons.length>0?e.openAddonsPopup():e.manageAddons()},te=function(t){e.errorMessage=t};e.viewAddons=function(){var t={successCallBack:ee,failureCallBack:te,params:{id:e.allotmentConfigData.summary.allotment_id}};e.callAPI(s.getAllotmentEnhancements,t)},e.getRevenue=function(){return e.isInAddMode()?"":a.currencySymbol+n("number")(e.allotmentConfigData.summary.revenue_actual,2)+"/ "+a.currencySymbol+n("number")(e.allotmentConfigData.summary.revenue_potential,2)},e.openAddonsPopup=function(){e.addonPopUpData={cancelLabel:"Cancel",saveLabel:"Save",number_of_adults:1,number_of_children:1,duration_of_stay:1,addonPostingMode:"allotments"},e.packageData={duration_of_stay:e.duration_of_stay},e.packageData.existing_packages=e.allotmentConfigData.selectedAddons,_.each(e.packageData.existing_packages,function(e){e.totalAmount=e.amount*e.addon_count}),c.open({template:"/assets/partials/packages/showPackages.html",className:"",controller:"RVReservationPackageController",scope:e,closeByDocument:!1,closeByEscape:!1})};var ae=function(t){e.allotmentConfigData.addons=t,e.openAllotmentAddonsScreen()},oe=function(e){};e.manageAddons=function(){if(e.isInAddMode())return void(e.errorMessage=["Please save the allotment to manage Add-ons"]);e.errorMessage="";var t={from_date:e.allotmentConfigData.summary.block_from,to_date:e.allotmentConfigData.summary.block_to,is_active:!0,is_not_rate_only:!0},a={successCallBack:ae,failureCallBack:oe,params:t};e.callAPI(u.fetchAddonData,a)};var ne=function(t){e.allotmentConfigData.selectedAddons=t,e.packageData.existing_packages=e.allotmentConfigData.selectedAddons,e.computeAddonsCount()},re=function(t){e.errorMessage=t};e.removeAddon=function(t){var a={addon_id:t.id,id:e.allotmentConfigData.summary.allotment_id},o={successCallBack:ne,failureCallBack:re,params:a};e.callAPI(s.removeAllotmentEnhancement,o)};var se=function(t){e.allotmentConfigData.summary.notes=t.notes,e.allotmentSummaryData.newNote="",e.refreshScroller("allotmentSummaryScroller")},ie=function(t){e.errorMessage=t};e.saveAllotmentNote=function(){if(e.isInAddMode())return void(e.errorMessage=["Please save the allotment to Post Note"]);e.errorMessage="";var t={notes:e.allotmentSummaryData.newNote,allotment_id:e.allotmentConfigData.summary.allotment_id},a={successCallBack:se,failureCallBack:ie,params:t};e.allotmentSummaryData.newNote&&e.callAPI(s.saveAllotmentNote,a)};var le=function(t,a){var o=e.allotmentConfigData.summary;o.notes=_.without(o.notes,_.findWhere(o.notes,{note_id:a.noteId})),e.refreshScroller("allotmentSummaryScroller")},ce=function(t){e.errorMessage=t};e.removeAllotmentNote=function(t){var a={successCallBack:le,failureCallBack:ce,params:{note_id:t},successCallBackParameters:{noteId:t}};e.callAPI(s.removeAllotmentNote,a)};var ue=function(){var e={is_swiped:!1,details:{firstName:"",lastName:""}};return e};e.$on("HANDLE_MODAL_OPENED",function(t){e.billingInfoModalOpened=!1});var de=function(t){var a=ue(),o=new SwipeOperation,n=o.createSWipedDataToRender(t);a.details.swipedDataToRenderInScreen=n,e.$broadcast("SHOW_SWIPED_DATA_ON_BILLING_SCREEN",n)};e.$on("SWIPE_ACTION",function(t,a){if(e.swippedCard=!0,e.billingInfoModalOpened){var o=new SwipeOperation,n=o.createDataToTokenize(a),r=function(t){e.$emit("hideLoader"),a.token=t,de(a)};e.invokeApi(d.tokenize,n,r)}});var me=function(t){var a=e.allotmentSummaryData;a.rateSelectDataObject=[],a.rateSelectDataObject.push({id:"-1",name:"Custom Rate",uniqId:"-1"});var o=function(t,o){angular.forEach(t,function(t){t.groupName=o,t.is_contracted?(t.uniqId=t.id+":"+t.contract_id,t.name=t.name+" ("+t.contract_name+")",t.id===e.allotmentConfigData.summary.rate&&t.contract_id===e.allotmentConfigData.summary.contract_id&&(e.allotmentConfigData.summary.uniqId=t.uniqId)):(t.uniqId=t.id+":",t.id===e.allotmentConfigData.summary.rate&&(e.allotmentConfigData.summary.uniqId=t.uniqId)),a.rateSelectDataObject.push(t)})};0!==t.group_rates.length&&o(t.group_rates,"Group Rates"),0!==t.company_rates.length&&o(t.company_rates,"Company Contract"),0!==t.travel_agent_rates.length&&o(t.travel_agent_rates,"Travel Agent Contract"),"-1"===e.allotmentConfigData.summary.rate&&(e.allotmentConfigData.summary.uniqId="-1"),g.uniqId=e.allotmentConfigData.summary.uniqId},fe=function(t){e.errorMessage=t},pe=function(){var t=e.allotmentConfigData.summary;if(t.block_from&&t.block_to){var a={from_date:n("date")(tzIndependentDate(t.block_from),"yyyy-MM-dd"),to_date:n("date")(tzIndependentDate(t.block_to),"yyyy-MM-dd"),company_id:t.company&&t.company.id||null,travel_agent_id:t.travel_agent&&t.travel_agent.id||null},o={successCallBack:me,failureCallBack:fe,params:a};return e.callAPI(s.getRates,o),!0}return!1};e.addListener("TA_CARD_CHANGED",function(e){pe()}),e.addListener("COMPANY_CARD_CHANGED",function(e){pe()}),e.$on("ALLOTMENT_TAB_SWITCHED",function(t,a){"SUMMARY"===a&&(e.isInAddMode()||(e.$emit("FETCH_SUMMARY"),e.isUpdateInProgress=!1,e.computeSegment()))});var _e=function(t){e.allotmentSummaryData={releaseOnDate:a.businessDate,demographics:null,promptMandatoryDemographics:!1,isDemographicsPopupOpen:!1,newNote:"",existingHoldStatus:parseInt(e.allotmentConfigData.summary.hold_status),computedSegment:!1,rates:[],contractedRates:[],rateSelectDataObject:[]},e.billingInfoModalOpened=!1,g=_.extend({},e.allotmentConfigData.summary),h={},e.isUpdateInProgress=!1},ve=function(){var t=e.isInAddMode()?"menuCreateAllotment":"menuManageAllotment";e.$emit("updateRoverLeftMenu",t)};e.shouldShowDemographics=function(){var t=!1;if(e.allotmentSummaryData.demographics&&e.hotelSettings){var a=I(e.allotmentSummaryData.demographics)&&e.hotelSettings.force_market_code,o=E(e.allotmentSummaryData.demographics)&&e.hotelSettings.force_source_code,n=B(e.allotmentSummaryData.demographics)&&e.hotelSettings.force_origin_of_booking,r=L(e.allotmentSummaryData.demographics)&&e.hotelSettings.force_segments;t=a||o||n||r}return t},e.setDemographicFields=function(t){e.shouldShowReservationType=e.allotmentSummaryData.demographics.reservationTypes.length>0,e.shouldShowMarket=I(e.allotmentSummaryData.demographics),e.shouldShowSource=E(e.allotmentSummaryData.demographics),e.shouldShowOriginOfBooking=B(e.allotmentSummaryData.demographics),e.shouldShowSegments=L(e.allotmentSummaryData.demographics),t&&(e.shouldShowReservationType=!1,e.shouldShowMarket=e.shouldShowMarket&&e.hotelSettings.force_market_code,e.shouldShowSource=e.shouldShowSource&&e.hotelSettings.force_source_code,e.shouldShowOriginOfBooking=e.shouldShowOriginOfBooking&&e.hotelSettings.force_origin_of_booking,e.shouldShowSegments=e.shouldShowSegments&&e.hotelSettings.force_segments)},e.$on("CREATE_ALLOTMENT",function(){e.shouldShowDemographics()?(e.forceDemographics=!0,e.allotmentSummaryData.promptMandatoryDemographics=!0,e.openDemographicsPopup(!0,!1)):e.$emit("SAVE_ALLOTMENT")}),e.closeRateChangePromptPopup=function(){var t=g.uniqId,a=t&&t.split(":")[0],o=t&&t.split(":")[1];e.allotmentConfigData.summary.uniqId=t,e.allotmentConfigData.summary.contract_id=o,e.allotmentConfigData.summary.rate=a,c.close()};(function(){BaseCtrl.call(this,e),e.setScroller("allotmentSummaryScroller"),ve(),_e(),e.allotmentConfigData.summary.block_from&&e.allotmentConfigData.summary.block_to&&pe(),e.$on("CARDS_CHANGED",function(){e.allotmentConfigData.summary.block_from&&e.allotmentConfigData.summary.block_to&&pe()}),M(),e.computeSegment()})()}]),sntRover.controller("rvAllotmentReservationCheckinCtrl",["$rootScope","$scope","$timeout","rvAllotmentReservationsListSrv","$state",function(e,t,a,o,n){var r=function(e){t.$emit("REFRESH_ALLOTMENT_RESERVATIONS_LIST_DATA"),a(function(){t.closeDialog()},700)},s=function(e){};t.completeCheckIn=function(e,a){var n={group_id:e,reservation_ids:[a]},i={params:n,successCallBack:r,failureCallBack:s};t.callAPI(o.performMassCheckin,i)}}]),sntRover.controller("rvAllotmentReservationCheckoutCtrl",["$rootScope","$scope","$timeout","RVBillCardSrv","$state",function(e,t,a,o,n){var r=function(e){t.$emit("REFRESH_ALLOTMENT_RESERVATIONS_LIST_DATA"),a(function(){t.closeDialog()},700)},s=function(e){};t.completeCheckOut=function(e){var a={reservation_id:e},n={params:a,successCallBack:r,failureCallBack:s};t.callAPI(o.completeCheckout,n)}}]),sntRover.controller("rvAllotmentReservationEditCtrl",["$rootScope","$scope","$filter","$timeout","rvUtilSrv","$state","ngDialog","rvAllotmentConfigurationSrv","rvAllotmentReservationsListSrv",function(e,t,a,o,n,r,s,i,l){BaseCtrl.call(this,t);var c,u={},d={date:!0,room:!0,occupancy:!0,roomType:!0},m=function(e,t){d[e]=t;for(var a in d)a!==e&&(d[a]=!t)};t.shouldDisableChangeRoom=function(e){var t=e.status,a=["RESERVED","CHECKING_IN"];return!(d.room&&_.contains(a,t))},t.shouldDisableFromDateChange=function(e){var t=e.status,a=["RESERVED","CHECKING_IN"];return!(d.date&&_.contains(a,t))},t.shouldDisableToDateChange=function(e){var t=e.status,a=["RESERVED","CHECKING_IN","CHECKEDIN","CHECKING_OUT"];return!(d.date&&_.contains(a,t))},t.shouldShowCheckoutButton=function(e){return!t.reservationStatusFlags.isExpected&&t.reservationStatusFlags.isPastArrival},t.shouldDisableCheckoutButton=function(e){return!t.reservationStatusFlags.isStaying||t.reservationStatusFlags.isUneditable||!e.can_checkout},t.shouldShowCheckinButton=function(e){return!t.reservationStatusFlags.isExpected&&t.reservationStatusFlags.isPastArrival},t.shouldDisableCheckinButton=function(e){return!t.reservationStatusFlags.canChekin||t.reservationStatusFlags.isUneditable||!e.can_checkin},t.shouldDisableStaycardButton=function(e){return!t.reservationStatusFlags.isGuestAttached},t.shouldDisableRemoveButton=function(e){return!t.reservationStatusFlags.isExpected},t.shouldDisableNameField=function(e){return t.reservationStatusFlags.isUneditable},t.shouldDisableReservationRoomTypeChange=function(e){var a=_.pluck(t.roomTypesAndData,"room_type_id"),o=!_.contains(a,parseInt(e.room_type_id)),n=e.status,r=!("RESERVED"===n||"CHECKING_IN"===n)||o;return!d.roomType||r},t.shouldDisableReservationOccuppancyChange=function(e){var a=t.reservationStatusFlags.isUneditable||t.reservationStatusFlags.isCheckedOut;return!d.occupancy||a},t.shouldShowThisOccupancyAgainstRoomType=function(e){var a=_.findWhere(t.ngDialogData.allowedRoomTypes,{room_type_id:parseInt(t.ngDialogData.room_type_id)});return"undefined"!=typeof a&&a[e]},t.isEmptyRoomNumber=function(e){return null===e||""===e};var f=function(){t.$$phase||t.$digest()},p=function(t){return a("date")(tzIndependentDate(t),e.dateFormatForAPI)},v=function(e){t.closeDialog(),t.$emit("REFRESH_ALLOTMENT_RESERVATIONS_LIST_DATA")};t.updateReservation=function(e){t.errorMessage="",_.extend(e,{allotment_id:t.allotmentConfigData.summary.allotment_id,arrival_date:p(t.roomingListState.editedReservationStart),departure_date:p(t.roomingListState.editedReservationEnd),room_type_id:parseInt(e.room_type_id),room_id:parseInt(e.room_id)});var a={params:e,successCallBack:v};t.callAPI(i.updateRoomingListItem,a)};var g=function(e){s.open({template:"/assets/partials/allotments/reservations/popups/editReservation/rvAllotmentEditRoomingListItemCheckoutConfirmation.html",className:"",scope:t.$parent,closeByDocument:!1,closeByEscape:!1,controller:"rvAllotmentReservationCheckoutCtrl",data:JSON.stringify(e)})},h=function(e){s.open({template:"/assets/partials/allotments/reservations/popups/editReservation/rvAllotmentEditRoomingListItemCheckinConfirmation.html",className:"",scope:t.$parent,closeByDocument:!1,closeByEscape:!1,controller:"rvAllotmentReservationCheckinCtrl",data:JSON.stringify(e)})};t.checkoutReservation=function(e){if(e.is_bulk_checkout_in_progress){var a={message:"BULK_CHECKOUT_PROCESS_IN_PROGRESS",isFailure:!0};return void(c=s.open({template:"/assets/partials/popups/rvInfoPopup.html",closeByDocument:!0,scope:t,data:JSON.stringify(a)}))}var n=t.allotmentConfigData.summary,r={group_name:n.group_name,group_id:n.group_id,reservation_id:e.id};t.closeDialog(),o(function(){g(r)},800)},t.checkinReservation=function(e){var a=t.allotmentConfigData.summary,n={group_name:a.group_name,group_id:a.group_id,reservation_id:e.id};t.closeDialog(),o(function(){h(n)},800)},t.navigateStayCard=function(e){t.reservationStatusFlags.isGuestAttached&&(t.closeDialog(),o(function(){r.go("rover.reservation.staycard.reservationcard.reservationdetails",{id:e.id,confirmationId:e.confirm_no})},750))};var y=function(e){var a=u.room_id,o=[],n=u.room_type_id===t.ngDialogData.room_type_id;null!==a&&""!==a&&n&&(o=[{id:a,room_number:u.room_no}]),t.ngDialogData.roomsFreeToAssign=o.concat(e.rooms)};t.changedReservationRoomType=function(){var e=t.ngDialogData,a={reserevation_id:e.id,num_of_rooms_to_fetch:5,room_type_id:e.room_type_id},o={params:a,successCallBack:y};m("roomType",!0),t.callAPI(l.getFreeAvailableRooms,o)};var D=function(e){t.$emit("REFRESH_ALLOTMENT_RESERVATIONS_LIST_DATA"),o(function(){t.closeDialog()},700)};t.removeReservation=function(e){var a=t.reservationStatusFlags,o=null,n=null;return!!a.isExpected&&(n={id:e.id,group_id:t.allotmentConfigData.summary.allotment_id,is_allotment:!0},o={params:n,successCallBack:D},t.callAPI(l.removeReservation,o),void 0)};var A=function(e,a){m("date",!0),t.roomingListState.editedReservationStart=new tzIndependentDate(n.get_date_from_date_picker(a)),t.reservationToDateOptions.maxDate=b(t.roomingListState.editedReservationStart),t.reservationToDateOptions.minDate=t.roomingListState.editedReservationStart,f()},C=function(e,a){m("date",!0),t.roomingListState.editedReservationEnd=new tzIndependentDate(n.get_date_from_date_picker(a)),t.reservationFromDateOptions.minDate=O(t.roomingListState.editedReservationEnd),t.reservationFromDateOptions.maxDate=t.roomingListState.editedReservationEnd,f()},S=function(t){var a=t.status;return{isCheckedOut:"CHECKEDOUT"===a,isUneditable:"CANCELED"===a,isExpected:"RESERVED"===a||"CHECKING_IN"===a,isStaying:"CHECKEDIN"===a||"CHECKING_OUT"===a,canChekin:!!t.room_no&&"CHECKING_IN"===a,isNoShow:"NOSHOW"===a,isGuestAttached:!!t.lastname,isPastArrival:new tzIndependentDate(e.businessDate)>=new tzIndependentDate(t.arrival_date)}},R=function(){_.extend(u,t.ngDialogData),t.reservationStatusFlags=S(t.ngDialogData)};t.changedReservationOccupancy=function(){m("occupancy",!0)},t.changedReservationRoom=function(){m("room",!0)};var b=function(e){var o=tzIndependentDate(e),n=a("date")(o,"yyyy-MM-dd"),r=n.match(/(\d+)/g),s=new Date(r[0],parseInt(r[1])-1,parseInt(r[2],10)+t.maxStayLength),i=new tzIndependentDate(t.allotmentConfigData.summary.block_to);return s<i?s:i},O=function(o){var n=tzIndependentDate(e.businessDate),r=tzIndependentDate(t.allotmentConfigData.summary.block_from),s=tzIndependentDate(o),i=a("date")(s,"yyyy-MM-dd"),l=i.match(/(\d+)/g),c=new Date(l[0],parseInt(l[1])-1,parseInt(l[2],10)-t.maxStayLength),u=n>r?n:r,d=c>u?c:u;return d},T=function(){var a=(t.allotmentConfigData.summary,new tzIndependentDate(t.ngDialogData.arrival_date)),o=new tzIndependentDate(e.businessDate),n={dateFormat:e.jqDateFormat,numberOfMonths:1,beforeShow:function(e,t){$("#ui-datepicker-div").addClass("reservation hide-arrow"),$('<div id="ui-datepicker-overlay">').insertAfter("#ui-datepicker-div"),setTimeout(function(){$("body").find("#ui-datepicker-overlay").on("click",function(){$("#room-out-from").blur(),$("#room-out-to").blur()})},100)},onClose:function(e){$("#ui-datepicker-div").removeClass("reservation hide-arrow"),$("#ui-datepicker-overlay").off("click").remove()}};t.reservationFromDateOptions=_.extend({onSelect:A,minDate:O(t.ngDialogData.departure_date),maxDate:new tzIndependentDate(t.ngDialogData.departure_date)},n),t.reservationToDateOptions=_.extend({onSelect:C,minDate:a<o?o:a,maxDate:b(t.ngDialogData.arrival_date)},n)};t.closeErrorDialog=function(){c&&c.close()},function(){R(),T()}()}]),angular.module("sntRover").controller("rvActivityCtrl",["$scope","$rootScope","$filter","$stateParams","$timeout",function(e,t,a,o,n){BaseCtrl.call(this,e);var r=50;e.init=function(){e.page=1,e.perPage=r,e.errorMessage="",e.accountActivityLogPagination={id:"ACCOUNT_ACTIVITY_LOG",api:e.updateReport,perPage:r},e.setScroller("report_content")},e.$on("PopulateLogData",function(t,a){e.count=a.total_count,e.activityLogData=a.results,e.$emit("hideLoader"),e.refreshScroller("report_content"),n(function(){e.$broadcast("updatePagination","ACCOUNT_ACTIVITY_LOG")},800)}),e.isOldValue=function(e){return""!==e&&"undefined"!=typeof e&&null!==e},e.initSort=function(){e.sortOrderOfUserASC=!1,e.sortOrderOfDateASC=!1,e.sortOrderOfActionASC=!1,e.sortOrderOfUserDSC=!1,e.sortOrderOfDateDSC=!1,e.sortOrderOfActionDSC=!1},e.sortByUserName=function(){e.sort_field="USERNAME",e.sortOrderOfUserASC?(e.initSort(),e.sortOrderOfUserDSC=!0,e.sort_order="desc"):(e.initSort(),e.sortOrderOfUserASC=!0,e.sort_order="asc"),e.updateReport()},e.sortByDate=function(){e.sort_field="DATE",e.sortOrderOfDateASC?(e.initSort(),e.sortOrderOfDateDSC=!0,e.sort_order="desc"):(e.initSort(),e.sortOrderOfDateASC=!0,e.sort_order="asc"),e.updateReport()},e.sortByAction=function(){e.sort_field="ACTION",e.sortOrderOfActionASC?(e.initSort(),e.sortOrderOfActionDSC=!0,e.sort_order="desc"):(e.initSort(),e.sortOrderOfActionASC=!0,e.sort_order="asc"),e.updateReport()},e.updateReport=function(t){var a={page:t||1,per_page:e.perPage};a.sort_order=e.sort_order,a.sort_field=e.sort_field,e.$emit("updateLogdata",a)};var s=function(){$("head").append("<style id='print-orientation'>@page { size: landscape; }</style>")},i=function(){$("#print-orientation").remove()};e.print=function(){$("header h1").addClass("text-hide"),$(".cards-header").css({marginBottom:"2%"}),s();var e=$("#print-orientation"),t=e.css("background-image"),a=t.replace(/(^url\()|(\)$|[\"\'])/g,"");$("<img>").attr("src",a).on("load",function(){$(this).off("load"),$(this).remove();var e=function(){n(function(){$("header h1").removeClass("text-hide"),$(".cards-header").css({marginBottom:"0"}),i()},1200)};n(function(){sntapp.cordovaLoaded?cordova.exec(e,function(){e()},"RVCardPlugin","printWebView",["","0","","L"]):(window.print(),e())},300)})},e.init()}]),angular.module("sntRover").service("rvAccountsConfigurationSrv",["$q","rvBaseWebSrvV2",function(e,t){var a=this;this.baseAccountSummaryData={
posting_account_id:"",posting_account_name:"",posting_account_number:"",posting_account_type:"HOUSE",posting_account_status:"OPEN",demographics:{market_segment_id:"",source_id:"",booking_origin_id:""},notes:[],travel_agent:null,company:null},this.getAccountSummary=function(o){var n=e.defer();if("NEW_ACCOUNT"===o.accountId)n.resolve(angular.copy(a.baseAccountSummaryData));else{var r="api/posting_accounts/"+o.accountId;t.getJSON(r).then(function(e){n.resolve(e)},function(e){n.reject(e)})}return n.promise},this.updateAccountSummary=function(a){var o=e.defer(),n="api/posting_accounts/"+a.summary.posting_account_id;return t.putJSON(n,a.summary).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.updateBillingRefNumber=function(a){var o=e.defer(),n="api/posting_accounts/"+a.summary.posting_account_id;return a.summary.custom_reference_number=a.custom_reference_number,t.putJSON(n,a.summary).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.saveAccountSummary=function(a){var o=e.defer(),n="api/posting_accounts";return t.postJSON(n,a.summary).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.saveAccountNote=function(a){var o=e.defer(),n="api/posting_accounts/save_posting_account_note";return t.postJSON(n,a).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.updateAccountNote=function(a){var o=e.defer(),n="api/notes/"+a.id;return t.putJSON(n,a).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.removeAccountNote=function(a){var o=e.defer(),n="api/posting_accounts/delete_posting_account_note";return t.deleteJSON(n,a).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.emailInvoice=function(a){var o=e.defer(),n="api/posting_accounts/email_bill_card";return t.postJSON(n,a).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise}}]),angular.module("sntRover").service("rvAccountTransactionsSrv",["$q","rvBaseWebSrvV2","$rootScope",function(e,t,a){this.fetchGroupAllowances=function(e){const a="/api/groups/"+e.id+"/group_allowance_transactions";return t.getJSON(a,{associated_type:e.type}).then(function(e){var t={dataByAllowance:[],dataByDate:[]};e.allowance_data=_.map(e.allowance_data,function(e){return e.ptime=parseInt(e.time.replace(":",""),10),e});try{e.allowance_data&&e.allowance_data.length&&(t.dataByAllowance=_.groupBy(e.allowance_data,function(e){return e.addon_id}),t.dataByDate=_.groupBy(e.allowance_data,function(e){return e.date}),_.each(t.dataByAllowance,function(e,a){t.dataByAllowance[a]=_.sortBy(e,function(e){return e.ptime})}),_.each(t.dataByDate,function(e,a){t.dataByDate[a]=_.sortBy(e,function(e){return e.ptime})}))}catch(e){console.error(e)}return t},function(){})},this.searchAllowanceShares=function(a){var o=e.defer(),n="/api/groups/"+a.groupId+"/group_allowance_search";return t.getJSON(n,{query:a.query,associated_type:a.type}).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.saveAllowanceShares=function(a){var o=e.defer(),n="/api/groups/"+a.groupId+"/group_allowance_share";return t.postJSON(n,{shared_allowances:a.data,associated_type:a.type}).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.fetchTransactionDetails=function(a){var o=e.defer(),n="/api/posting_accounts/"+a.account_id+"/bill_card";return t.getJSON(n).then(function(e){angular.forEach(e.bills,function(e){e.page_no=1,e.transactions=[],e.activeDate=e.days.length>0?_.last(e.days).date:null}),o.resolve(e)},function(e){o.reject(e)}),o.promise},this.fetchBillTransactionDetails=function(a){var o=e.defer(),n="/api/bills/"+a.bill_id+"/transactions?date="+a.date+"&page="+a.page+"&per_page="+a.per_page;return t.getJSON(n).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.createAnotherBill=function(a){var o=e.defer(),n="api/bills/create_bill";return t.postJSON(n,a).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.moveToAnotherBill=function(a){var o=e.defer(),n="api/bills/transfer_transaction";return t.postJSON(n,a).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.transactionEdit=function(a){var o=e.defer(),n=a.id,r=a.updatedDate,s="api/financial_transactions/"+n;return t.putJSON(s,r).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.transactionEditChargeDescription=function(a){var o=e.defer(),n="api/financial_transactions/"+a.id+"/save_custom_description";return t.postJSON(n,a.postData).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.transactionDelete=function(a){var o=e.defer(),n=a.id,r="api/financial_transactions/"+n;return t.putJSON(r,a.data).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.transactionSplit=function(a){var o=e.defer(),n=a.id,r="api/financial_transactions/"+n;return t.putJSON(r,a.data).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.savePaymentDetails=function(a){var o=e.defer(),n="/api/bills/"+a.bill_id+"/add_payment_method";return t.postJSON(n,a.data_to_pass).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.submitPaymentOnBill=function(o){var n=0,r=function(){n++},s=setInterval(r,1e3),i=e.defer(),l="/api/bills/"+o.bill_id+"/submit_payment",c=function(e){if(n>=a.emvTimeout){var o=["Request timed out. Unable to process the transaction"];i.reject(o)}else t.getJSONWithSpecialStatusHandling(e).then(function(t){t.status&&"processing_not_completed"===t.status||"null"===t?setTimeout(function(){console.info("POLLING::-> for emv terminal response"),c(e)},5e3):(clearInterval(s),i.resolve(t))},function(t){"undefined"==typeof t?c(e):(clearInterval(s),i.reject(t))})};return t.postJSONWithSpecialStatusHandling(l,o.data_to_pass).then(function(e){o.data_to_pass.is_emv_request&&e.status&&"processing_not_completed"===e.status?c(e.location_header):(clearInterval(s),i.resolve(e))},function(e){clearInterval(s),i.reject(e)}),i.promise},this.postCharges=function(a){var o=e.defer(),n="/staff/items/post_items_to_bill";return t.postJSON(n,a).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.checkForArAccount=function(a){var o=e.defer(),n="/api/posting_accounts/"+a.account_id+"/check_ar_account_attached";return t.getJSON(n).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.fetchAccountBillsForPrint=function(a){var o=e.defer(),n="/api/posting_accounts/print_bill_card";return t.postJSON(n,a).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.groupChargeDetailsFetch=function(a){var o=e.defer(),n="/api/posting_accounts/transaction_details";return t.getJSON(n,a).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise}}]),angular.module("sntRover").service("RVReservationSummarySrv",["$q","rvBaseWebSrvV2",function(e,t){var a=this;this.reservationData={},this.reservationData.demographics={};var o={},n={},r={},s={},i={};this.fetchPaymentMethods=function(){var a=e.defer(),o="/staff/payments/addNewPayment.json";return t.getJSON(o).then(function(e){a.resolve(e.data)},function(e){a.reject(e)}),a.promise},this.fetchLengthSegments=function(){var a=e.defer();if(isEmpty(i)){var o="/api/segments?is_active=true";t.getJSON(o).then(function(e){i=e,a.resolve(e)},function(e){a.reject(e)})}else a.resolve(i);return a.promise},this.fetchDemographicMarketSegments=function(){var a=e.defer();if(isEmpty(o)){var n="/api/market_segments?is_active=true";t.getJSON(n).then(function(e){o=e,a.resolve(o)},function(e){a.reject(e)})}else a.resolve(o);return a.promise},this.fetchDemographicSources=function(){var a=e.defer();if(isEmpty(n)){var o="/api/sources?is_active=true";t.getJSON(o).then(function(e){n=e,a.resolve(n)},function(e){a.reject(e)})}else a.resolve(n);return a.promise},this.fetchDemographicOrigins=function(){var a=function(e){r.is_use_origins=e.is_use_origins,r.origins=[];for(var t in e.booking_origins)e.booking_origins[t].is_active&&r.origins.push(e.booking_origins[t]);o.resolve(r)},o=e.defer();if(isEmpty(r)){var n="/api/booking_origins";t.getJSON(n).then(function(e){a(e)},function(e){o.reject(e)})}else o.resolve(r);return o.promise},this.fetchDemographicReservationTypes=function(){var o=function(e){s=[],a.reservationData.demographics.reservationTypes=[];for(var t in e.reservation_types)e.reservation_types[t].is_active&&s.push(e.reservation_types[t]);n.resolve(s)},n=e.defer();if(isEmpty(s)){var r="/api/reservation_types.json?is_active=true";t.getJSON(r).then(function(e){o(e)},function(e){n.reject(e)})}else n.resolve(s);return n.promise},this.fetchInitialData=function(){var t=e.defer(),o={};return o.marketsData=a.fetchDemographicMarketSegments(),o.originsData=a.fetchDemographicOrigins(),o.sourcesData=a.fetchDemographicSources(),o.reservationTypesData=a.fetchDemographicReservationTypes(),o.segmentsData=a.fetchLengthSegments(),e.all(o).then(function(e){a.reservationData.demographics.is_use_markets=e.marketsData.is_use_markets,a.reservationData.demographics.markets=e.marketsData.markets,a.reservationData.demographics.is_use_origins=e.originsData.is_use_origins,a.reservationData.demographics.origins=e.originsData.origins,a.reservationData.demographics.is_use_sources=e.sourcesData.is_use_sources,a.reservationData.demographics.sources=e.sourcesData.sources,a.reservationData.demographics.is_use_segments=e.segmentsData.is_use_segments,a.reservationData.demographics.segments=e.segmentsData.segments,a.reservationData.demographics.reservationTypes=e.reservationTypesData,t.resolve(a.reservationData)},function(e){t.reject(e)}),t.promise},this.saveReservation=function(a){var o=e.defer(),n="/api/reservations";return t.postJSON(n,a).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.updateBillingInformation=function(a){var o=e.defer(),n="api/bill_routings/update_dates";return t.postJSON(n,a).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.sendConfirmationEmail=function(a){var o=e.defer(),n="/api/reservations/"+a.reservationId+"/email_confirmation";return delete a.reservationId,t.postJSON(n,a).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.sendHourlyConfirmationEmail=function(a){var o=e.defer(),n="/api/reservations/hourly_confirmation_emails?";return _.each(a.reservation_ids,function(e){n+="reservation_ids[]="+e+"&"}),_.each(a.emails,function(e){n+="emails[]="+encodeURIComponent(e)+"&"}),delete a.reservation_ids,delete a.emails,t.postJSON(n,a).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.updateReservation=function(a){var o=e.defer(),n="/api/reservations/"+a.reservationId;return t.putJSON(n,a).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.paymentAction=function(a){var o=e.defer(),n="/api/ipage/store_payments";return t.postJSON(n,a).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.startPayment=function(a){var o=e.defer(),n="/api/cc/get_token";return t.postJSON(n,a).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.fetchRooms=function(){var a=e.defer(),o="/api/rooms";return t.getJSON(o).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.getRateName=function(a){var o=e.defer(),n="/api/rates/"+a.id;return t.getJSON(n).then(function(e){o.resolve(e.name)},function(e){o.reject(e)}),o.promise},this.getRateDetails=function(a){var o=e.defer(),n="/api/rates/"+a.id;return t.getJSON(n).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.getTaxDetails=function(a){var o=e.defer(),n="/api/rates/tax_information/";return t.getJSON(n,a).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.fetchDefaultRoutingInfo=function(a){var o=e.defer(),n="/api/default_account_routings/routings_count/";return t.postJSON(n,a).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.applyDefaultRoutingToReservation=function(a){var o=e.defer(),n="/api/default_account_routings/attach_reservation";return t.postJSON(n,a).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.fetchResservationConfirmationPrintData=function(a){var o=e.defer(),n="/api/reservations/"+a.reservation_id+"/confirmation_email_data";return t.getJSON(n,a).then(function(e){e.data.addons_list=e.data.addons?e.data.addons.toString():"",o.resolve(e)},function(e){o.reject(e)}),o.promise},this.fetchResservationCancellationPrintData=function(a){var o=e.defer(),n="/api/reservations/"+a.reservation_id+"/cancellation_email_data";return t.getJSON(n,a).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.updateNoRoomMove=function(a){var o=e.defer(),n="/api/reservations/"+a.reservationId+"/update_no_room_move_flag";return t.postJSON(n,a).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.updateRestrictPost=function(a){var o=e.defer(),n="/api/reservations/"+a.reservationId+"/update_restrict_post_flag";return t.postJSON(n,a).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.saveTaxExempt=function(a){var o=e.defer(),n="/api/reservations/save_tax_exempt";return t.postJSON(n,a).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.checkUpsellAvailability=function(a){var o=e.defer(),n="/api/reservations/"+a+"/upsell_availability";return t.getJSON(n).then(function(e){o.resolve(e.is_upsell_available)},function(e){o.reject(e)}),o.promise},this.updateCommission=function(a){var o=e.defer(),n="/api/reservations/"+a.reservationId+"/update_commission";return t.putJSON(n,a).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.retrieveRoomPin=function(a){var o=e.defer(),n="/staff/reservation/get_room_pin";return t.getJSON(n,a).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.updateBookerEmail=function(a){var o=e.defer(),n="/api/reservations/"+a.reservationId+"/update_booker_email";return t.putJSON(n,a).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise}}]),angular.module("sntRover").service("rvGroupRoomingListSrv",["$q","rvBaseWebSrvV2","rvUtilSrv","sntBaseWebSrv",function(e,t,a,o){var n=this;this.DEFAULT_PER_PAGE=50,this.DEFAULT_PAGE=1,this.addReservations=function(a){var o=e.defer(),n=(a.id,"/api/group_reservations/"),a={group_id:a.group_id,reservations_data:{room_type_id:a.room_type_id,from_date:a.from_date,to_date:a.to_date,occupancy:a.occupancy,no_of_reservations:a.no_of_reservations}};return t.postJSON(n,a).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.fetchReservations=function(a){var o=e.defer(),n="/api/group_reservations/"+a.group_id+"/list",r=$.extend({},{per_page:a.per_page,page:a.page,locale:a.locale||"en"}),s=["sort_field","sort_dir","arrival_date","dep_date","query","exclude_cancel","show_pending_only"];return _.each(s,function(e){typeof a[e]!=typeof!0&&a[e]&&(r[e]=a[e]),typeof a[e]==typeof!0&&(r[e]=a[e])}),t.getJSON(n,r).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.performMassCheckin=function(a){var o=e.defer(),n=(a.id,"/api/group_checkins/"),a={group_id:a.group_id,reservation_ids:a.reservation_ids};return t.postJSON(n,a).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.performMassCheckout=function(a){var o=e.defer(),n=(a.id,"/api/group_checkouts/"),a={group_id:a.group_id,reservation_ids:a.reservation_ids};return t.postJSON(n,a).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.performAutoRoomAssignment=function(a){var o=e.defer(),n=(a.id,"/api/groups/auto_room_assignment"),a={group_id:a.group_id,reservation_ids:a.reservation_ids};return t.postJSON(n,a).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.getFreeAvailableRooms=function(a){var o="/api/reservations/"+a.reserevation_id+"/ready_to_assign_rooms/",n=e.defer(),r={count:a.num_of_rooms_to_fetch,room_type_id:a.room_type_id};return t.getJSON(o,r).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.getRoomTypesConfiguredAgainstGroup=function(a){var o=e.defer(),n=a.id,r="api/group_rooms/"+n;return t.getJSON(r,a).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.checkDefaultChargeRoutings=function(a){var o=e.defer(),n=a.id,r="/api/groups/"+n+"/check_default_charge_routings";return t.getJSON(r).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.attachBillingInfoToReservations=function(a){var o=e.defer(),n="/api/default_account_routings/attach_reservation";return t.postJSON(n,a).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.emailInvoice=function(a){var o=e.defer(),n="/api/group_reservations/email_rooming_list";return t.postJSON(n,a).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.fetchRegistrationCardPrintData=function(a){var o=e.defer(),n="/api/registration_cards/";return t.getJSON(n,a).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.updateGuestData=function(a){var o=e.defer(),n="/api/group_reservations/update_guest_details";return t.postJSON(n,a).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.exportRoomingList=function(e){var t="/api/group_reservations/"+e.group_id+"/list.csv";return delete e.group_id,o.download(t,e,"GET")},this.fetchHotelReservationSettings=function(){var a=e.defer(),o="/api/hotel_settings/show_hotel_reservation_settings";return n.reservationSettings?a.resolve(n.reservationSettings):t.getJSON(o).then(function(e){n.reservationSettings=e,a.resolve(e)},function(e){a.reject(e)}),a.promise}}]),angular.module("sntRover").service("RVReservationAddonsSrv",["$q","rvBaseWebSrvV2",function(e,t){var a=this;this.addonData={},this.fetchAddonData=function(o){var n=e.defer(),r="/api/charge_groups/for_addons";return t.getJSON(r,o).then(function(e){a.addonData.addonCategories=e.results,n.resolve(a.addonData)},function(e){n.reject(e)}),n.promise},this.fetchAddons=function(a){var o=e.defer(),n="api/addons";return t.getJSON(n,a).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.checkInventory=function(a){var o=e.defer(),n="/api/addons/"+a.addon_id+"/inventory_details";return t.getJSON(n,a).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise}}]),angular.module("sntRover").service("rvAllotmentAccountActivitySrv",["$q","rvBaseWebSrvV2",function(e,t){this.cacheReportList={},this.fetchActivityLog=function(a){var o=e.defer(),n="/api/group_actions/"+a.id;return a=_.omit(a,"id"),t.getJSON(n,a).then(function(e){this.cacheReportList=e,o.resolve(this.cacheReportList)}.bind(this),function(e){o.reject(e)}),o.promise}}]),angular.module("sntRover").service("rvAllotmentConfigurationSrv",["$q","rvBaseWebSrvV2","rvAccountsConfigurationSrv","rvHouseEventsListSrv",function(e,t,a,o){var n=this;this.baseConfigurationSummary={allotment_id:null,allotment_name:"",allotment_code:null,first_name:"",last_name:"",contact_phone:"",contact_email:"",demographics:{reservation_type_id:"",market_segment_id:"",source_id:"",booking_origin_id:""},travel_agent:null,company:null,hold_status:"",block_from:"",block_to:"",revenue_actual:null,revenue_potential:null,release_date:"",rooms_total:null,rooms_pickup:null,rate:"",addons_count:null,notes:[],selected_room_types_and_bookings:[],selected_room_types_and_occupanies:[],selected_room_types_and_rates:[]},this.lastFetchedAllotment={id:null,demographics:null},this.getHoldStatusList=function(a){var o=e.defer(),n="/api/group_hold_statuses";return t.getJSON(n,a).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.saveRoomBlockBookings=function(a){var o=e.defer(),n="/api/allotments/save_inventories";return t.postJSON(n,a).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.saveMassUpdate=function(a){var o=e.defer(),n="/api/allotments/save_bulk_inventories";return t.postJSON(n,a).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.saveRoomBlockReleaseDays=function(a){var o=e.defer(),n="/api/allotments/update_release_date";return t.putJSON(n,a).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.getAllotmentInventories=function(a){var o=e.defer(),n="/api/allotments/"+a.allotment_id+"/inventories";return t.getJSON(n,a).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.getRoomBlockGridDetails=function(t){var a=[],r=e.defer();return a.push(n.getAllotmentInventories(t)),a.push(o.fetchHouseEventsCount(t)),e.all(a).then(function(e){var t=e[0];t.eventsCount=e[1],r.resolve(t)},function(){r.reject({})}),r.promise},this.getAllRoomTypes=function(){var a=e.defer(),o="/api/room_types.json?is_exclude_pseudo=true";return t.getJSON(o).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.getSelectedRoomTypesAndRates=function(a){var o=e.defer(),n=a.id,r="/api/allotments/"+n+"/room_type_and_rates";return t.getJSON(r,a).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.updateSelectedRoomTypesAndRates=function(a){var o=e.defer(),n="/api/allotments/update_room_type_and_rates";return t.postJSON(n,a).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.cancelAllotment=function(a){var o=e.defer(),n="/api/allotments/"+a.allotment_id+"/cancel";return t.postJSON(n,a).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.getRoomTypeBestAvailableRateAndOccupancyCount=function(a){var o=e.defer(),n="/api/allotments/availability";return t.getJSON(n,a).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise};var r={};this.getAllotmentSummary=function(a){var o=e.defer();if("NEW_ALLOTMENT"===a.allotmentId)o.resolve(angular.copy({allotmentSummary:n.baseConfigurationSummary}));else{var s="api/allotments/"+a.allotmentId;t.getJSON(s).then(function(e){null===e.rate&&(e.rate=-1),r.allotmentSummary=e,n.lastFetchedAllotment={id:e.allotment_id,demographics:e.demographics},o.resolve(r)},function(e){o.reject(e)})}return o.promise},this.searchCompanyCards=function(a){var o=e.defer(),n="api/accounts?account_type=COMPANY&query="+a;return t.getJSON(n).then(function(e){o.resolve(e.accounts)},function(e){o.reject(e)}),o.promise},this.searchTravelAgentCards=function(a){var o=e.defer(),n="api/accounts?account_type=TRAVELAGENT&query="+a;return t.getJSON(n).then(function(e){o.resolve(e.accounts)},function(e){o.reject(e)}),o.promise},this.updateAllotmentSummary=function(a){var o=e.defer(),n="api/allotments/"+a.summary.allotment_id;return t.putJSON(n,a.summary).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.saveAllotmentSummary=function(a){var o=e.defer(),n="api/allotments";return t.postJSON(n,a.summary).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.addAllotmentEnhancement=function(a){var o=e.defer(),n="/api/allotments/"+a.id+"/addons";return t.postJSON(n,a).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.removeAllotmentEnhancement=function(a){var o=e.defer(),n="/api/allotments/"+a.id+"/addons";return t.deleteJSON(n,a).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.updateAddonPosting=function(a){var o=e.defer(),n="/api/allotments/"+a.id+"/update_addon_posting";return t.postJSON(n,a).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.getAllotmentEnhancements=function(a){var o=e.defer(),n="/api/allotments/"+a.id+"/addons";return t.getJSON(n).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.saveAllotmentNote=function(a){var o=e.defer(),n="api/allotments/save_allotment_note";return t.postJSON(n,a).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.removeAllotmentNote=function(a){var o=e.defer(),n="api/allotments/delete_allotment_note";return t.deleteJSON(n,a).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.updateRoomingListItem=function(a){var o=e.defer(),n="/api/allotments/"+a.id+"/update_reservation";return t.putJSON(n,a).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.removeRoomingListItem=function(a){var o=e.defer(),n="api/allotment_reservations/"+a.id+"/cancel";return t.postJSON(n,a).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.releaseRooms=function(a){var o=e.defer(),n="api/allotments/"+a.allotmentId+"/release_now";return t.getJSON(n,a).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.getRates=function(a){var o=e.defer(),n="api/allotments/rates";return t.getJSON(n,a).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.toggleHideRate=function(a){var o=e.defer(),n="api/allotments/"+a.allotment_id+"/hide_rates";return t.postJSON(n,a).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.updateRate=function(a){var o=e.defer(),n="api/allotments/"+a.allotment_id+"/change_rate";return t.postJSON(n,a).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.copyDefaultBillingInfo=function(a){var o=e.defer(),n="api/default_account_routings/copy_default_billing_info_to_allotments";return t.postJSON(n,a).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.copyContactToHeld=function(a){var o=e.defer(),n="api/allotments/copy_contract";return t.postJSON(n,a).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.updateHoldStatus=function(a){var o=e.defer(),n="/api/groups/"+a.id+"/hold_status";return t.putJSON(n,a).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise}}]),angular.module("sntRover").service("rvAllotmentSrv",["$q","rvBaseWebSrvV2",function(e,t){this.DEFAULT_PER_PAGE=50,this.DEFAULT_PAGE=1,this.getAllotmentList=function(a){var o=e.defer(),n="/api/allotments/search",r={q:a.query,from_date:a.from_date,to_date:a.to_date,per_page:a.per_page,page:a.page};return t.getJSON(n,r).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.fetchHotelBusinessDate=function(){var a=e.defer(),o="/api/business_dates/active";return t.getJSON(o).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.attachAllotmentToReservation=function(a){var o=e.defer(),n="/api/reservations/"+a.reservationId+"/add_allotment";return t.postJSON(n,{allotment_id:a.allotmentId}).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.detachAllotmentFromReservation=function(a){var o=e.defer(),n="/api/reservations/"+a+"/remove_allotment";return t.postJSON(n).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.updateCache=function(e){this.filterParams=e},this.getCache=function(){return this.filterParams},this.clearCache=function(){this.filterParams={}}}]),angular.module("sntRover").service("rvAllotmentReservationsListSrv",["$q","rvBaseWebSrvV2","rvUtilSrv",function(e,t,a){var o=this;this.DEFAULT_PER_PAGE=50,this.DEFAULT_PAGE=1,this.fetchReservations=function(a){var o=e.defer(),n=a.id,r="/api/allotments/"+n+"/reservations";return t.getJSON(r,a.payLoad).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.getFreeAvailableRooms=function(a){var o="/api/reservations/"+a.reserevation_id+"/ready_to_assign_rooms/",n=e.defer(),r={count:a.num_of_rooms_to_fetch,room_type_id:a.room_type_id};return t.getJSON(o,r).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.performAutoRoomAssignment=function(a){var o=e.defer(),n=a.id,r="/api/allotments/"+n+"/auto_room_assignment",a={reservation_ids:a.reservation_ids};return t.postJSON(r,a).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.getRoomTypesConfiguredAgainstGroup=function(a){var o=e.defer(),n=a.id,r=_.omit(a,"id"),s="/api/group_rooms/"+n;return t.getJSON(s,r).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.removeReservation=function(a){var o=e.defer(),n="api/group_reservations/"+a.id+"/cancel";return t.postJSON(n,a).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.emailInvoice=function(a){var o=e.defer(),n="/api/allotments/email_rooming_list";return t.postJSON(n,a).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.addReservations=function(a){var o=e.defer(),n=a.id,r="/api/allotments/"+n+"/reservations",a={reservations_data:{room_type_id:a.room_type_id,from_date:a.from_date,to_date:a.to_date,occupancy:a.occupancy,no_of_reservations:a.no_of_reservations,is_from_allotment:!0}};return t.postJSON(r,a).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.toggleHideRate=function(a){var o=e.defer(),n="api/allotments/"+a.id+"/hide_rates";return t.postJSON(n,_.without(a,"id")).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.fetchRegistrationCardPrintData=function(a){var o=e.defer(),n="/api/allotments/"+a.id+"/batch_print_registration_cards";return t.getJSON(n).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.performMassCheckin=function(a){var o=e.defer(),n=(a.id,"/api/group_checkins/"),a={group_id:a.group_id,reservation_ids:a.reservation_ids};return t.postJSON(n,a).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.performMassCheckout=function(a){var o=e.defer(),n=(a.id,"/api/group_checkouts/"),a={group_id:a.group_id,reservation_ids:a.reservation_ids};return t.postJSON(n,a).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.fetchHotelReservationSettings=function(){var a=e.defer(),n="/api/hotel_settings/show_hotel_reservation_settings";return o.reservationSettings?a.resolve(o.reservationSettings):t.getJSON(n).then(function(e){o.reservationSettings=e,a.resolve(e)},function(e){a.reject(e)}),a.promise}}]),angular.module("sntRover").service("RVReservationCardSrv",["$http","$q","RVBaseWebSrv","rvBaseWebSrvV2","RVGAHelperSrv","$rootScope",function(e,t,a,o,n,r){this.reservationData={};var s=this;this.fetch=function(e){var o=t.defer(),n=e.reservationId,r=e.isRefresh,i=!1;if(angular.forEach(s.reservationIdsArray,function(e,t){r&&null!==r&&""!==r||e===n&&(i=!0)}),i)o.resolve(s.reservationData[n]);else{s.storeReservationIds(n);var l="api/reservations/"+n+".json";a.getJSON(l).then(function(e){s.reservationData[n]=e,o.resolve(e)},function(e){o.reject(e)})}return o.promise},this.reservationDetails={},this.confirmationNumbersArray=[],this.reservationIdsArray=[];var s=this;this.emptyConfirmationNumbers=function(){s.confirmationNumbersArray=[],s.reservationDetails={}},this.storeConfirmationNumbers=function(e){s.confirmationNumbersArray.push(e)},this.storeReservationIds=function(e){s.reservationIdsArray.push(e)},this.fetchReservationDetails=function(e){var o=e.confirmationNumber,r=e.isRefresh,i=!1,l=!0;angular.forEach(s.confirmationNumbersArray,function(e,t){r&&null!==r||e===o&&(i=!0)});var c=t.defer();if(i)c.resolve(s.reservationDetails[o]);else{s.storeConfirmationNumbers(o);var u="/staff/staycards/reservation_details.json?reservation="+o+"&is_dep_date_allowed="+l;a.getJSON(u).then(function(e){s.reservationDetails[o]=e,n.sendEventToGA("LOAD_RESERVATION",o),c.resolve(e)},function(e){c.reject(e)})}return c.promise},this.updateResrvationForConfirmationNumber=function(e,t){s.reservationDetails[e]=t},this.getResrvationForConfirmationNumber=function(e){return s.reservationDetails[e]},this.guestData="",this.setGuestData=function(e){this.guestData=e},this.getGuestData=function(){return this.guestData},this.fetchGuestcardData=function(e){var o=t.defer(),n="/staff/guestcard/show.json";return a.getJSON(n,e).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.fetchCancellationPolicies=function(e){var a=t.defer(),n="/api/reservations/"+e.id+"/cancellation_policies";return o.getJSON(n,e).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.cancelReservation=function(e){var a=t.defer(),n="/api/reservations/"+e.id+"/cancel";return o.postJSON(n,e).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.tokenize=function(e){var o=t.defer(),n="/staff/payments/tokenize";return a.postJSON(n,e).then(function(e){
o.resolve(e)},function(e){o.reject(e)}),o.promise},this.getLastRateAdjustmentReason=function(e){var a=t.defer(),n="api/reservations/"+e.reservation_id+"/reason_for_last_adjusted_rate";return o.getJSON(n).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.saveReservationNote=function(e){var o=t.defer(),n="/reservation_notes";return a.postJSON(n,e).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.deleteReservationNote=function(e){var o=t.defer(),n="/reservation_notes/"+e;return a.deleteJSON(n,"").then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.updateReservationNote=function(e){var a=t.defer(),n="/reservation_notes/"+e.id;return o.putJSON(n,e).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.getGuestDetails=function(e){var a=t.defer(),n="/api/guest_details/"+e.id;return null===e.id?a.reject([""]):o.getJSON(n).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.modifyRoomQueueStatus=function(e){var a=t.defer(),n={status:e.status};e.viaAdvancedQueue&&(n.signature=e.signature,n.is_promotions_and_email_set=e.is_promotions_and_email_set);var r="/api/reservations/"+e.reservationId+"/queue";return o.postJSON(r,n).then(function(t){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.fetchDepositDetails=function(e){var a=t.defer(),n="api/reservations/"+e+"/deposit_policy";return o.getJSON(n).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.sendConfirmationEmail=function(e){var a=t.defer(),n="/api/reservations/"+e.reservationId+"/email_confirmation";return o.postJSON(n,e.postData).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.validateStayDateChange=function(e){var a=t.defer(),n="/staff/change_stay_dates/validate_stay_dates_change";return o.postJSON(n,e).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.detachGroupReservation=function(e){var a=t.defer(),n="/api/group_reservations/"+e.id+"/detach_group_reservation";return o.postJSON(n,e).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.reinstateReservation=function(e){var a=t.defer(),n="/api/reservations/"+e.reservationId+"/reinstate";return o.postJSON(n,e).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.checkReinstationAvailbility=function(e){var a=t.defer(),n="/api/reservations/"+e+"/check_reinstate_availability";return o.getJSON(n).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.checkGiftCardBalance=function(e){var a={card_number:e.card_number},n=t.defer(),r="/api/gift_cards/balance_inquiry";return o.postJSON(r,a).then(function(e){e&&"number"==typeof e.amount&&(e.amount=parseFloat(e.amount).toFixed(2)),n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchGuestIdentity=function(e){var a=t.defer(),n="/api/guest_identity/"+e.reservation_id;return o.getJSON(n,e).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.reverseCheckIn=function(e){var a=t.defer(),n="/api/reservations/"+e.reservationId+"/reverse_check_in";return o.postJSON(n).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.attachGuestToReservation=function(e){var a=t.defer(),n="/api/reservations/"+e.reservation_id+"/reservations_guest_details/attach_guest_details";return delete e.reservation_id,o.postJSON(n,e).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.getConfirmationData=function(e){var a=t.defer(),n="/api/reservations/"+e.reservation_id+"/confirmation_data";return o.getJSON(n).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.createActivityLog=function(e){var a=t.defer();return o.postJSON("/api/reservation_actions",e).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise}}]),angular.module("sntRover").service("RVCompanyCardSrv",["$q","rvBaseWebSrvV2",function(e,t){var a=this,o={},n=6e4;a.companyTaArDetailsCached=[],a.companyTaNotes=[],a.cachedTime="",this.DEFAULT_PER_PAGE=10,this.DEFAULT_PAGE=1;var r={},s=this;this.fetchContactInformation=function(a){var o=a.id,n=e.defer(),r="/api/accounts/"+o,s=["is_eod_failed","is_eod_in_progress","is_eod_manual_started","is_eod_process_running"];return t.getJSON(r).then(function(e){n.resolve(_.omit(e,s))},function(e){n.reject(e)}),n.promise},this.fetchCompanyPaymentData=function(a){var o=e.defer(),n="/staff/payments/payment.json?account_id="+a;return t.getJSON(n).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.setAsPrimary=function(a){var o=e.defer(),n="api/accounts/"+a.account_id+"/set_wallet_payment_method_primary";return t.postJSON(n,a).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.deletePayment=function(a){var o=e.defer(),n="api/accounts/"+a.account_id+"/delete_wallet_payment_methods";return t.postJSON(n,a).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.fetchContactInformationMandatoryFields=function(){var a=e.defer(),o="/admin/co_ta_settings/current_settings.json";return t.getJSON(o).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.fetchAccountPaymentData=function(a){var o=e.defer(),n="/staff/payments/payment.json?account_id="+a;return t.getJSON(n).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.fetchContactInformationAndMandatoryFields=function(t){var a=e.defer(),o={};return e.when().then(function(){return s.fetchContactInformation(t).then(function(e){o=e})}).then(function(){return s.fetchContactInformationMandatoryFields().then(function(e){o.mandatoryFields=e})}).then(function(){a.resolve(o)},function(e){a.reject(e)}),a.promise},this.fetchCommissionDetail=function(){var a=e.defer(),o=" /api/hotel_settings/default_agent_commission_details";return t.getJSON(o).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.fetchCommissionDetailsAndMandatoryFields=function(){var t=e.defer(),a={};return e.when().then(function(){return s.fetchCommissionDetail().then(function(e){a=e})}).then(function(){return s.fetchContactInformationMandatoryFields().then(function(e){a.mandatoryFields=e})}).then(function(){t.resolve(a)},function(e){t.reject(e)}),t.promise},this.fetchMultiProperties=function(a){var o=e.defer(),n="/api/accounts/"+a.accountId+"/subscribed_properties";return t.getJSON(n).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise};var i=[];this.fetchCountryList=function(){var a=e.defer(),o="/ui/country_list";return i.length?a.resolve(i):t.getJSON(o).then(function(e){i=e,a.resolve(e)},function(e){a.reject(e)}),a.promise},this.saveContactInformation=function(a){var o,n,s=e.defer(),i="api/accounts/save.json",l=parseInt(a.id,10),c=_.omit(a,["workstation_id"]),u={data:c,deferred:s};return r[l]=r[l]||[],o=r[l],(n=o.find(function(e){return angular.equals(e.data,c)&&!e.resolved}))?n.deferred.promise:(o.push(u),t.postJSON(i,a).then(function(e){u.resolved=!0,s.resolve(e)},function(e){u.resolved=!0,s.reject(e)}),s.promise)},this.fetchRates=function(a){var o=e.defer(),n="/api/rates/contract_rates";return t.getJSON(n,a).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.replaceCard=function(a){var o={old:{type:a.cardType},new:{type:a.cardType,id:a.id,use_card_rate:a.useCardRate},change_all_reservations:a.future},n=e.defer(),r="/api/reservations/"+a.reservation+"/cards/replace";return t.putJSON(r,o).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.removeCard=function(a){var o={type:a.cardType,id:a.cardId},n=e.defer(),r="/api/reservations/"+a.reservation+"/cards/remove";return t.deleteJSON(r,o).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchArAccountDetails=function(o){var r=o.id,s=e.defer(),i="/api/accounts/"+r+"/ar_details";if(!a.companyTaArDetailsCached[r]||a.companyTaArDetailsCached[r].expiry&&Date.now()>a.companyTaArDetailsCached[r].expiry)a.companyTaArDetailsCached[r]=s,t.getJSON(i).then(function(e){a.companyTaArDetailsCached[r]={response:e,expiry:Date.now()+n},s.resolve(e)},function(e){s.reject(e)});else{if(!a.companyTaArDetailsCached[r].response)return a.companyTaArDetailsCached[r].promise;s.resolve(a.companyTaArDetailsCached[r].response)}return s.promise},this.fetchArAccountNotes=function(o){var r=o.id,s=e.defer(),i="/api/accounts/"+r+"/ar_notes";if(!a.companyTaNotes[r]||a.companyTaNotes[r].expiry&&Date.now()>a.companyTaNotes[r].expiry)a.companyTaNotes[r]=s,t.getJSON(i).then(function(e){a.companyTaNotes[r]={response:e,expiry:Date.now()+n},s.resolve(e)},function(e){s.reject(e)});else{if(!a.companyTaNotes[r].response)return a.companyTaNotes[r].promise;s.resolve(a.companyTaNotes[r].response)}return s.promise},this.saveARNote=function(o){var n=e.defer(),r="/api/accounts/save_ar_note",s=o.id;return t.postJSON(r,o).then(function(e){a.companyTaNotes[s]=null,n.resolve(e)},function(e){n.reject(e)}),n.promise},this.saveARDetails=function(o){var n=e.defer(),r="api/accounts/save_ar_details",s=o.id;return t.postJSON(r,o).then(function(e){a.companyTaArDetailsCached[s]=null,n.resolve(e)},function(e){n.reject(e)}),n.promise},this.deleteARNote=function(o){var n=e.defer(),r="/api/accounts/delete_ar_note",s=o.id;return t.postJSON(r,o).then(function(e){a.companyTaNotes[s]=null,n.resolve(e)},function(e){n.reject(e)}),n.promise},this.deleteArAccount=function(o){var n=o.id,r=e.defer(),s="api/accounts/"+n+"/delete_ar_detail";return t.deleteJSON(s).then(function(e){a.companyTaArDetailsCached[n]=null,r.resolve(e)},function(e){r.reject(e)}),r.promise},this.fetchArAccountsList=function(a){var o=e.defer(),n="/api/accounts/"+a.id+"/ar_transactions?paid="+a.paid+"&from_date="+a.from_date+"&to_date="+a.to_date+"&query="+a.query+"&page="+a.page_no+"&per_page="+a.per_page+"&transaction_type="+a.transaction_type;return t.getJSON(n).then(function(e){e.ar_transactions&&e.ar_transactions.length>0&&angular.forEach(e.ar_transactions,function(e){"DEBIT"===e.transaction_type&&(e.active=!1)}),o.resolve(e)},function(e){o.reject(e)}),o.promise},this.addCreditAmount=function(a){var o=e.defer(),n="api/accounts/"+a.id+"/ar_transactions";return t.postJSON(n,a).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.payForReservation=function(a){var o=e.defer(),n="api/accounts/"+a.id+"/ar_transactions/"+a.transaction_id+"/pay";return t.postJSON(n).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.openForReservation=function(a){var o=e.defer(),n="api/accounts/"+a.id+"/ar_transactions/"+a.transaction_id+"/open";return t.postJSON(n).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.payAll=function(a){var o=e.defer(),n="api/accounts/"+a.id+"/ar_transactions/pay_all";return t.postJSON(n).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},a.fetchHotelLoyaltiesHlps=function(){var a=e.defer(),n="/staff/user_memberships/get_available_hlps.json";return o.fetchHotelLoyaltiesHlps?a.resolve(o.fetchHotelLoyaltiesHlps):t.getJSON(n).then(function(e){o.fetchHotelLoyaltiesHlps=e,a.resolve(e)},function(e){a.reject(e)}),a.promise},a.fetchHotelLoyaltiesFfp=function(){var a=e.defer(),n="/staff/user_memberships/get_available_ffps.json";return o.fetchHotelLoyaltiesFfp?a.resolve(o.fetchHotelLoyaltiesFfp):t.getJSON(n).then(function(e){o.fetchHotelLoyaltiesFfp=e,a.resolve(e)},function(e){a.reject(e)}),a.promise},this.fetchTACommissionDetails=function(a){var o=e.defer(),n=" api/accounts/"+a.accountId+"/commission_details";return t.getJSON(n,a.params).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.saveTACommissionDetails=function(a){var o=e.defer(),n={};n.reservations=a.commissionDetails;var r="api/accounts/"+a.accountId+"/save_commission_details";return t.postJSON(r,n).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.fetchTransactionDetails=function(a){var o=e.defer(),n=" /api/bills/"+a.bill_id+"/transactions";return t.getJSON(n,a).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.fetchArStatementPrintData=function(a){var o=e.defer(),n="/api/ar_transactions/print";return t.postJSON(n,a).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.emailArStatement=function(a){var o=e.defer(),n="/api/ar_transactions/email";return t.postJSON(n,a).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.fetchArStatementData=function(a){var o=e.defer(),n="/api/ar_transactions/get_email?id="+a.id;return t.getJSON(n).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.groupChargeDetailsFetch=function(a){var o=e.defer(),n="/staff/reservation/transaction_details";return t.getJSON(n,a).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.recalculateCommission=function(a){var o=e.defer(),n="/api/reservations/recalculate_commission_details";return t.postJSON(n,a).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.fetchCompanyTravelAgentStatisticsSummary=function(a){var o=e.defer(),n="/api/accounts/"+a.accountId+"/statistics?view=SUMMARY";return delete a.accountId,t.getJSON(n,a).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.fetchCompanyTravelAgentStatisticsDetails=function(a){var o=e.defer(),n="/api/accounts/"+a.accountId+"/statistics?view=DETAILED";return delete a.accountId,t.getJSON(n,a).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.fetchCompanyTravelAgentMonthlyReservations=function(a){var o=e.defer(),n="/api/accounts/"+a.accountId+"/statistics?view=RESERVATIONS";return delete a.accountId,t.getJSON(n,a).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.verifyTravelAgentCompanyCardMerge=function(a){var o=e.defer(),n="/api/accounts/validate_card_merge";return t.postJSON(n,a).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.mergeCards=function(a){var o=e.defer(),n="/api/accounts/merge_cards";return t.postJSON(n,a).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise}}]),angular.module("sntRover").service("RVReservationBaseSearchSrv",["$q","rvBaseWebSrvV2","sntBaseWebSrv","dateFilter",function(e,t,a,o){var n=this;this.reservation={settings:{},roomTypes:{},businessDate:{}},this.rateDetailsList={},this.cache={config:{lifeSpan:3600},responses:{restrictionTypes:null,rateDetails:null,sortOrder:null,taxMeta:null,customMeta:null}},this.getRoomRatesDefaultView=function(){var e="ROOM_TYPE";return n.reservation.settings&&n.reservation.settings.default_rate_display_name&&("Recommended"===n.reservation.settings.default_rate_display_name?e="RECOMMENDED":"By Rate"===n.reservation.settings.default_rate_display_name&&(e="RATE")),e},this.getRoomTypeLevel=function(e){var t=-1;if(n.reservation.roomTypes){var a=_.find(n.reservation.roomTypes,{id:e});t=a.level}return t},this.timeSlots=[{value:"12:00 AM",label:"12:00 AM",fullDayValue:0},{value:"12:15 AM",label:"12:15 AM",fullDayValue:15},{value:"12:30 AM",label:"12:30 AM",fullDayValue:30},{value:"12:45 AM",label:"12:45 AM",fullDayValue:45},{value:"01:00 AM",label:"01:00 AM",fullDayValue:100},{value:"01:15 AM",label:"01:15 AM",fullDayValue:115},{value:"01:30 AM",label:"01:30 AM",fullDayValue:130},{value:"01:45 AM",label:"01:45 AM",fullDayValue:145},{value:"02:00 AM",label:"02:00 AM",fullDayValue:200},{value:"02:15 AM",label:"02:15 AM",fullDayValue:215},{value:"02:30 AM",label:"02:30 AM",fullDayValue:230},{value:"02:45 AM",label:"02:45 AM",fullDayValue:245},{value:"03:00 AM",label:"03:00 AM",fullDayValue:300},{value:"03:15 AM",label:"03:15 AM",fullDayValue:315},{value:"03:30 AM",label:"03:30 AM",fullDayValue:330},{value:"03:45 AM",label:"03:45 AM",fullDayValue:345},{value:"04:00 AM",label:"04:00 AM",fullDayValue:400},{value:"04:15 AM",label:"04:15 AM",fullDayValue:415},{value:"04:30 AM",label:"04:30 AM",fullDayValue:430},{value:"04:45 AM",label:"04:45 AM",fullDayValue:445},{value:"05:00 AM",label:"05:00 AM",fullDayValue:500},{value:"05:15 AM",label:"05:15 AM",fullDayValue:515},{value:"05:30 AM",label:"05:30 AM",fullDayValue:530},{value:"05:45 AM",label:"05:45 AM",fullDayValue:545},{value:"06:00 AM",label:"06:00 AM",fullDayValue:600},{value:"06:15 AM",label:"06:15 AM",fullDayValue:615},{value:"06:30 AM",label:"06:30 AM",fullDayValue:630},{value:"06:45 AM",label:"06:45 AM",fullDayValue:645},{value:"07:00 AM",label:"07:00 AM",fullDayValue:700},{value:"07:15 AM",label:"07:15 AM",fullDayValue:715},{value:"07:30 AM",label:"07:30 AM",fullDayValue:730},{value:"07:45 AM",label:"07:45 AM",fullDayValue:745},{value:"08:00 AM",label:"08:00 AM",fullDayValue:800},{value:"08:15 AM",label:"08:15 AM",fullDayValue:815},{value:"08:30 AM",label:"08:30 AM",fullDayValue:830},{value:"08:45 AM",label:"08:45 AM",fullDayValue:845},{value:"09:00 AM",label:"09:00 AM",fullDayValue:900},{value:"09:15 AM",label:"09:15 AM",fullDayValue:915},{value:"09:30 AM",label:"09:30 AM",fullDayValue:930},{value:"09:45 AM",label:"09:45 AM",fullDayValue:945},{value:"10:00 AM",label:"10:00 AM",fullDayValue:1e3},{value:"10:15 AM",label:"10:15 AM",fullDayValue:1015},{value:"10:30 AM",label:"10:30 AM",fullDayValue:1030},{value:"10:45 AM",label:"10:45 AM",fullDayValue:1045},{value:"11:00 AM",label:"11:00 AM",fullDayValue:1100},{value:"11:15 AM",label:"11:15 AM",fullDayValue:1115},{value:"11:30 AM",label:"11:30 AM",fullDayValue:1130},{value:"11:45 AM",label:"11:45 AM",fullDayValue:1145},{value:"12:00 PM",label:"12:00 PM",fullDayValue:1200},{value:"12:15 PM",label:"12:15 PM",fullDayValue:1215},{value:"12:30 PM",label:"12:30 PM",fullDayValue:1230},{value:"12:45 PM",label:"12:45 PM",fullDayValue:1245},{value:"01:00 PM",label:"01:00 PM",fullDayValue:1300},{value:"01:15 PM",label:"01:15 PM",fullDayValue:1315},{value:"01:30 PM",label:"01:30 PM",fullDayValue:1330},{value:"01:45 PM",label:"01:45 PM",fullDayValue:1345},{value:"02:00 PM",label:"02:00 PM",fullDayValue:1400},{value:"02:15 PM",label:"02:15 PM",fullDayValue:1415},{value:"02:30 PM",label:"02:30 PM",fullDayValue:1430},{value:"02:45 PM",label:"02:45 PM",fullDayValue:1445},{value:"03:00 PM",label:"03:00 PM",fullDayValue:1500},{value:"03:15 PM",label:"03:15 PM",fullDayValue:1515},{value:"03:30 PM",label:"03:30 PM",fullDayValue:1530},{value:"03:45 PM",label:"03:45 PM",fullDayValue:1545},{value:"04:00 PM",label:"04:00 PM",fullDayValue:1600},{value:"04:15 PM",label:"04:15 PM",fullDayValue:1615},{value:"04:30 PM",label:"04:30 PM",fullDayValue:1630},{value:"04:45 AM",label:"04:45 PM",fullDayValue:1645},{value:"05:00 PM",label:"05:00 PM",fullDayValue:1700},{value:"05:15 PM",label:"05:15 PM",fullDayValue:1715},{value:"05:30 PM",label:"05:30 PM",fullDayValue:1730},{value:"05:45 PM",label:"05:45 PM",fullDayValue:1745},{value:"06:00 PM",label:"06:00 PM",fullDayValue:1800},{value:"06:15 PM",label:"06:15 PM",fullDayValue:1815},{value:"06:30 PM",label:"06:30 PM",fullDayValue:1830},{value:"06:45 PM",label:"06:45 PM",fullDayValue:1845},{value:"07:00 PM",label:"07:00 PM",fullDayValue:1900},{value:"07:15 PM",label:"07:15 PM",fullDayValue:1915},{value:"07:30 PM",label:"07:30 PM",fullDayValue:1930},{value:"07:45 PM",label:"07:45 PM",fullDayValue:1945},{value:"08:00 PM",label:"08:00 PM",fullDayValue:2e3},{value:"08:15 PM",label:"08:15 PM",fullDayValue:2015},{value:"08:30 PM",label:"08:30 PM",fullDayValue:2030},{value:"08:45 PM",label:"08:45 PM",fullDayValue:2045},{value:"09:00 PM",label:"09:00 PM",fullDayValue:2100},{value:"09:15 PM",label:"09:15 PM",fullDayValue:2115},{value:"09:30 PM",label:"09:30 PM",fullDayValue:2130},{value:"09:45 PM",label:"09:45 PM",fullDayValue:2145},{value:"10:00 PM",label:"10:00 PM",fullDayValue:2200},{value:"10:15 PM",label:"10:15 PM",fullDayValue:2215},{value:"10:30 PM",label:"10:30 PM",fullDayValue:2230},{value:"10:45 PM",label:"10:45 PM",fullDayValue:2245},{value:"11:00 PM",label:"11:00 PM",fullDayValue:2300},{value:"11:15 PM",label:"11:15 PM",fullDayValue:2315},{value:"11:30 PM",label:"11:30 PM",fullDayValue:2330},{value:"11:45 PM",label:"11:45 PM",fullDayValue:2345}],this.fetchBaseSearchData=function(){var a=e.defer();if(n.fetchBussinessDate=function(){var e="/api/business_dates/active";return t.getJSON(e).then(function(e){n.reservation.businessDate=e.business_date,a.resolve(n.reservation)},function(e){a.reject(e)}),a.promise},n.fetchRoomTypes=function(){var e="api/room_types.json?exclude_pseudo=true&per_page=100";return t.getJSON(e).then(function(e){n.reservation.roomTypes=e.results,n.fetchBussinessDate()},function(e){a.reject(e)}),a.promise},isEmpty(n.reservation.settings)&&isEmpty(n.reservation.roomTypes)&&isEmpty(n.reservation.businessDate)){var o="/api/hotel_settings/show_hotel_reservation_settings";t.getJSON(o).then(function(e){n.reservation.settings=e,n.fetchRoomTypes()},function(e){a.reject(e)})}else a.resolve(n.reservation);return a.promise},this.fetchCompanyCard=function(a){var o=e.defer(),n="/api/accounts";return t.getJSON(n,a).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.autoCompleteCodes=function(a){var o=e.defer(),n="/api/code_search";return t.getJSON(n,a).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.fetchCurrentTime=function(a){var o=e.defer(),n="/api/hotel_current_time";return t.getJSON(n).then(function(e){a&&"string"==typeof a&&(e.hotel_time.date=a),o.resolve(e)},function(e){o.reject(e)}),o.promise},this.fetchAvailability=function(a){var o=e.defer(),n="/api/availability?from_date="+a.from_date+"&to_date="+a.to_date+"&override_restrictions=true";return a.company_id&&(n+="&company_id="+a.company_id),a.travel_agent_id&&(n+="&travel_agent_id="+a.travel_agent_id),a.group_id&&(n+="&group_id="+a.group_id),a.promotion_code&&(n+="&promotion_code="+encodeURI(a.promotion_code)),a.allotment_id&&(n+="&allotment_id="+encodeURI(a.allotment_id)),t.getJSON(n).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.fetchMinTime=function(){var a=e.defer(),o="/api/hourly_rate_min_hours";return t.getJSON(o).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.fetchSortPreferences=function(){var a=e.defer(),o="/api/sort_preferences/list_selections";return null===n.cache.responses.sortOrder||Date.now()>n.cache.responses.sortOrder.expiryDate?t.getJSON(o).then(function(e){n.cache.responses.sortOrder={data:e.room_rates,expiryDate:Date.now()+1e3*n.cache.config.lifeSpan},a.resolve(e.room_rates)},function(e){a.reject(e)}):a.resolve(n.cache.responses.sortOrder.data),a.promise},this.fetchAddonsForRates=function(a){var o=e.defer(),n="/api/addons/rate_addons";return t.getJSON(n,a).then(function(e){o.resolve(e.rate_addons)},function(e){o.reject(e)}),o.promise},this.hasAnyConfiguredAddons=function(a){var o=e.defer(),n="/api/addons/configured";return t.getJSON(n,a).then(function(e){o.resolve(e.addons_configured)},function(e){o.reject(e)}),o.promise},this.getActivePromotions=function(){var a=e.defer(),o="/api/promotions?is_active=true";return t.getJSON(o).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.fetchUserMemberships=function(a){var o=e.defer(),n="/staff/user_memberships.json?user_id="+a;return t.getJSON(n).then(function(e){o.resolve(e.data)},function(e){o.reject(e)}),o.promise},this.checkOverbooking=function(a){var o=e.defer(),n="/api/availability/overbooking_check";return t.getJSON(n,a).then(function(e){o.resolve(e.results)},function(e){o.reject(e)}),o.promise},this.checkDiaryAvailability=function(a){var o=e.defer(),n="/api/nightly_diary/availability";return t.postJSON(n,a).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.fetchOrdinaryRates=function(a){var o=e.defer(),n="/api/availability/rates";return t.getJSON(n,a).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.fetchContractRates=function(a){var o=e.defer(),n="/api/availability/contracts";return t.getJSON(n,a).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.fetchGroupRates=function(a){var o=e.defer(),n=a.group_id||a.allotment_id,r="/api/availability/groups/"+n;return t.getJSON(r,a).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.fetchRates=function(t){var a=e.defer(),o=[];return n.rates=[],t.group_id?o.push(n.fetchGroupRates(t).then(function(e){_.each(e.rates,function(e){null===e.id&&(e.id="_CUSTOM_"+t.group_id)}),n.rates=n.rates.concat(e.rates)})):(o.push(n.fetchOrdinaryRates(t).then(function(e){n.rates=n.rates.concat(e.rates)})),(t.company_id||t.travel_agent_id)&&o.push(n.fetchContractRates(t).then(function(e){_.each(e.rates,function(e){e.isCorporate=!0}),n.rates=n.rates.concat(e.rates)}))),e.all(o).then(function(){a.resolve(n.rates)},function(e){a.reject(e)}),a.promise},this.fetchRestricitonTypes=function(){var a=e.defer(),o="/api/restriction_types";return null===n.cache.responses.restrictionTypes||Date.now()>n.cache.responses.restrictionTypes.expiryDate?t.getJSON(o).then(function(e){e.results.push({id:98,value:"INVALID_PROMO",description:"PROMOTION INVALID",activated:!0}),e.results.push({id:99,activated:!0,value:"HOUSE_FULL",description:"NO HOUSE AVAILABILITY"});var t={};_.each(e.results,function(e){t[e.id]={key:e.value,value:["CLOSED","CLOSED_ARRIVAL","CLOSED_DEPARTURE","HOUSE_FULL","INVALID_PROMO"].indexOf(e.value)>-1?e.description:e.description+":"}}),n.cache.responses.restrictionTypes={data:t,expiryDate:Date.now()+1e3*n.cache.config.lifeSpan},a.resolve(t)},function(e){a.reject(e)}):a.resolve(n.cache.responses.restrictionTypes.data),a.promise};var r=function(e){var t=_.reject(e.rate_ids,function(e){return!!(n.rateDetailsList[e]&&Date.now()<n.rateDetailsList[e].expiryDate)});return t};this.fetchRatesDetails=function(a){var o=r(a),s=e.defer(),i="/api/rates/search.json",l={};return l.rate_ids=o,0===o.length?s.resolve({}):t.postJSON(i,l).then(function(e){_.each(e.results,function(e){n.rateDetailsList[e.id]={expiryDate:Date.now()+1e3*n.cache.config.lifeSpan,details:e}}),s.resolve(e.results)},function(e){s.reject(e)}),s.promise},this.fetchCustomRateConfig=function(){var a=e.defer(),o="api/rates/custom_group_rate_taxes";return null===n.cache.responses.customMeta||Date.now()>n.cache.responses.customMeta.expiryDate?t.getJSON(o).then(function(e){var t=e;n.cache.responses.customMeta={data:t,expiryDate:Date.now()+1e3*n.cache.config.lifeSpan},a.resolve(t)},function(e){a.reject(e)}):a.resolve(n.cache.responses.customMeta.data),a.promise},this.fetchRatesMeta=function(t){var a=e.defer(),o=[];return n["rates-restrictions"]={},o.push(n.fetchRestricitonTypes(t).then(function(e){n["rates-restrictions"].restrictions=e})),o.push(n.fetchCustomRateConfig().then(function(e){n["rates-restrictions"].customRates=e})),e.all(o).then(function(){a.resolve(n["rates-restrictions"])},function(e){a.reject(e)}),a.promise},this.fetchTaxInformation=function(){var a=e.defer(),o="api/rates/tax_information";return null===n.cache.responses.taxMeta||Date.now()>n.cache.responses.taxMeta.expiryDate?t.getJSON(o).then(function(e){var t=e.tax_codes;n.cache.responses.taxMeta={data:t,expiryDate:Date.now()+1e3*n.cache.config.lifeSpan},a.resolve(t)},function(e){a.reject(e)}):a.resolve(n.cache.responses.taxMeta.data),a.promise},this.fetchHouseAvailability=function(a){var o=e.defer(),n="api/availability/house";return t.getJSON(n,a).then(function(e){var t={};_.each(e.results,function(e){t[e.date]=e.availability}),o.resolve(t)},function(e){o.reject(e)}),o.promise},this.fetchHouseRestrictions=function(a){var o=e.defer(),n="/api/availability/house_restrictions";return t.getJSON(n,a).then(function(e){o.resolve(e.restrictions)},function(e){o.reject(e)}),o.promise},this.fetchTaxRateAddonMeta=function(t){var a=e.defer(),o=[];return n.meta={},o.push(n.fetchTaxInformation().then(function(e){n.meta.taxInfo=e})),o.push(n.fetchAddonsForRates(t).then(function(e){n.meta.rateAddons=e})),e.all(o).then(function(){a.resolve(n.meta)},function(e){a.reject(e)}),a.promise},this.fetchHotelReservationSettings=function(){var a=e.defer(),o="/api/hotel_settings/show_hotel_reservation_settings";return t.getJSON(o).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.searchForRates=function(a){var o=e.defer(),n={},r="/api/rates.json?&sort_dir=true&sort_field=rate";return n.query=a.query,n.per_page=25,n.page=1,t.getJSON(r,n).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.fetchRateDetailsForIds=function(a){var o=r(a),s=e.defer(),i="/api/rates/search.json",l={};return l.rate_ids=o,0===o.length?s.resolve({}):t.postJSON(i,l).then(function(e){_.each(e.results,function(e){n.rateDetailsList[e.id]={expiryDate:Date.now()+1e3*n.cache.config.lifeSpan,details:e}});var t=_.difference(a.rate_ids,o);_.each(t,function(t){e.results.push(n.rateDetailsList[t].details)}),s.resolve(e.results)},function(e){s.reject(e)}),s.promise},this.checkTimeBasedAvailabilityAPI=function(t){var o=e.defer(),n="api/availability/time_based_room_type_and_house_avl";return a.postJSON(n,t).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise}}]),sntRover.controller("RVReservationPackageController",["$scope","$rootScope","$state","$timeout","$filter","ngDialog","RVReservationStateService",function(e,t,a,o,n,r,s){e.showRightContentForMobile=!1;var i=!1;e.setScroller("resultDetails",{click:!0}),setTimeout(function(){e.refreshScroller("resultDetails")},2e3),e.closeAddOnPopup=function(){t.modalOpened=!1,e.$emit("CLOSE_ADDON_POPUP",{addonPostingMode:e.addonPopUpData.addonPostingMode}),o(function(){i&&a.reload(a.current.name),r.close(),e.showRightContentForMobile=!1},300)},e.shouldHideCount=function(t){var a=t.post_type.value.toUpperCase();return!("WEEKDAY"!==a&&"WEEKEND"!==a&&"CUSTOM"!==a||"undefined"!=typeof t.post_instances||!e.showCustomPosting()||"reservation"!==e.addonPopUpData.addonPostingMode)};var l=function(e,t,a,o){return"PERSON"===e?(t+a)*o:"ADULT"===e?t*o:"CHILD"===e?a*o:"FLAT"===e||"ROOM"===e?o:void 0},c=function(e,t,a){for(var o=moment(e,"DD-MM-YYYY"),n=moment(t,"DD-MM-YYYY"),r=n.diff(o,a),s=[],i=0;i<r;i++){var l,c=moment(e,"DD-MM-YYYY").add(i,a),u=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];l=u[c.day()],s.push(l)}return s};e.getAddonCount=function(t){var a=t.post_type.frequency,o=t.post_type.value.toUpperCase(),n=t.amount_type.value.toUpperCase(),r=e.addonPopUpData.number_of_adults,i=e.addonPopUpData.number_of_children,u=e.addonPopUpData.duration_of_stay,d=0,m=t.charge_full_weeks_only,f=e.addonPopUpData.addonPostingMode,p=e.selectedPurchesedAddon.startDateObj?e.selectedPurchesedAddon.startDateObj:tzIndependentDate(t.start_date),v=e.selectedPurchesedAddon.endDateObj?e.selectedPurchesedAddon.endDateObj:tzIndependentDate(t.end_date);if(e.showCustomPosting()&&"undefined"!=typeof t.post_instances)u=_.filter(t.post_instances,{active:!0}).length,d=l(n,r,i,u);else{if(e.showCustomPosting()&&"undefined"!=typeof t.custom_nightly_selected_post_days&&("reservation"===f||"staycard"===f)){var g=c(p,v,"days"),h=0;angular.forEach(g,function(e){t.custom_nightly_selected_post_days.includes(e)&&h++}),u=h}a||("WEEK"===o||"EVERY WEEK"===o||"WEEKLY"===o||"WEEKDAY"===o||"WEEKEND"===o?a=7:"STAY"===o||"NIGHTLY"===o?a=1:"NIGHT"!==o&&"First Night"!==o&&"LAST_NIGHT"!==o&&"CUSTOM"!==o&&"POST ON LAST NIGHT"!==o||(a=0)),d=s.getApplicableAddonsCount(n,o,a,r,i,u,m,f)}return d*t.addon_count},e.getAddonTotal=function(t){return e.shouldHideCount(t)?t.amount:e.getAddonCount(t)*t.amount},e.selectedPurchesedAddon="",e.selectedDaysFromAdmin=[],e.selectPurchasedAddon=function(a){if(e.errorMessage=[],e.previousPostDays={},e.daysOfWeek=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],t.featureToggles.addons_custom_posting)if(a.is_rate_addon||a.is_allowance)e.errorMessage=["Custom posting cannot be configured for "+(a.is_allowance?"allowance":"rate")+" addons"],e.selectedPurchesedAddon="";else if("STAY"===a.post_type.value){var r=e.addonPopUpData.addonPostingMode;e.selectedPurchesedAddon=a,"staycard"===r?e.addonPostingDate={startDate:tzIndependentDate(e.reservationData.reservation_card.arrival_date),endDate:tzIndependentDate(e.reservationData.reservation_card.departure_date)
}:"reservation"===r?e.addonPostingDate={startDate:tzIndependentDate(e.reservationData.arrivalDate),endDate:tzIndependentDate(e.reservationData.departureDate)}:"allotments"===r||"create_allotment"===r?e.addonPostingDate={startDate:tzIndependentDate(e.allotmentConfigData.summary.block_from),endDate:tzIndependentDate(e.allotmentConfigData.summary.block_to)}:e.addonPostingDate={startDate:tzIndependentDate(e.groupConfigData.summary.block_from),endDate:tzIndependentDate(e.groupConfigData.summary.block_to)},e.selectedPurchesedAddon.start_date=e.addonPostingDate.startDate,e.selectedPurchesedAddon.end_date=e.addonPostingDate.endDate,e.selectedDaysFromAdmin=e.selectedPurchesedAddon.custom_nightly_selected_post_days,"undefined"==typeof e.selectedPurchesedAddon.adminConfiguredDays&&(e.selectedPurchesedAddon.adminConfiguredDays={},e.toggleAdminConfigDaysSelectionForAddon(!0)),"undefined"==typeof e.selectedPurchesedAddon.selected_post_days&&(e.selectedPurchesedAddon.selected_post_days={},e.togglePostDaysSelectionForAddon(!0)),e.selectedPurchesedAddon.startDateObj=tzIndependentDate(e.selectedPurchesedAddon.start_date),e.selectedPurchesedAddon.endDateObj=tzIndependentDate(e.selectedPurchesedAddon.end_date),f();var s=n("date")(e.selectedPurchesedAddon.start_date,t.dateFormat),i=n("date")(e.selectedPurchesedAddon.end_date,t.dateFormat);e.selectedPurchesedAddon.start_date=s,e.selectedPurchesedAddon.end_date=i,e.selectedPurchesedAddon.nameCharLimit=e.selectedPurchesedAddon.name.length>23?20:23,angular.forEach(e.selectedPurchesedAddon.post_instances,function(t){var a,o=moment(t.post_date),n=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];a=n[o.day()],e.selectedDaysFromAdmin.includes(a)?(e.selectedPurchesedAddon.selected_post_days[a]=t.active,e.selectedPurchesedAddon.adminConfiguredDays[a]=!0):(e.selectedPurchesedAddon.selected_post_days[a]=!1,e.selectedPurchesedAddon.adminConfiguredDays[a]=!1)}),angular.copy(e.selectedPurchesedAddon.selected_post_days,e.previousPostDays),o(function(){e.showRightContentForMobile=!0},10)}else e.selectedPurchesedAddon=a,o(function(){e.showRightContentForMobile=!0},10)};var u=function(e){var t=e%10,a=e%100;return 1===t&&11!==a?e+"st":2===t&&12!==a?e+"nd":3===t&&13!==a?e+"rd":e+"th"};e.getCustomPostingInfo=function(){var t="";return t="undefined"==typeof e.selectedPurchesedAddon.frequency_type||"undefined"==typeof e.selectedPurchesedAddon.frequency?"Posts daily":"days"===e.selectedPurchesedAddon.frequency_type?1===e.selectedPurchesedAddon.frequency?"Posts daily":"Posts on every "+e.selectedPurchesedAddon.frequency+" days.":"weeks"===e.selectedPurchesedAddon.frequency_type?1===e.selectedPurchesedAddon.frequency?"Posts weekly, on "+e.selectedPurchesedAddon.post_day_of_the_week:"Posts every "+e.selectedPurchesedAddon.frequency+" weeks, on "+e.selectedPurchesedAddon.post_day_of_the_week:"months"===e.selectedPurchesedAddon.frequency_type?1===e.selectedPurchesedAddon.frequency?"Posts every month, on "+u(e.selectedPurchesedAddon.post_day_of_the_month):"Posts every "+e.selectedPurchesedAddon.frequency+" months, on "+u(e.selectedPurchesedAddon.post_day_of_the_month):"Posts daily"},e.showCustomPosting=function(){return t.featureToggles.addons_custom_posting},e.shouldShowSelectAllDaysOfWeek=function(){var t=!1;return e.selectedPurchesedAddon&&angular.forEach(e.daysOfWeek,function(a){e.selectedDaysFromAdmin.includes(a)&&e.selectedPurchesedAddon.selected_post_days&&(e.selectedPurchesedAddon.selected_post_days[a]||(t=!0))}),t},e.shouldShowSelectNoDaysOfWeek=function(){var t=!0;return e.selectedPurchesedAddon&&angular.forEach(e.daysOfWeek,function(a){e.selectedDaysFromAdmin.includes(a)&&e.selectedPurchesedAddon.selected_post_days&&(e.selectedPurchesedAddon.selected_post_days[a]||(t=!1))}),t},e.togglePostDaysSelectionForAddon=function(t){angular.forEach(e.daysOfWeek,function(a){e.selectedDaysFromAdmin.includes(a)&&(e.selectedPurchesedAddon.selected_post_days[a]=t)})},e.toggleAdminConfigDaysSelectionForAddon=function(t){angular.forEach(e.daysOfWeek,function(a){e.selectedDaysFromAdmin.includes(a)&&(e.selectedPurchesedAddon.adminConfiguredDays[a]=t)})};var d;e.clickedOnDatePicker=function(t){e.datePickerFor=t,d=r.open({template:"/assets/partials/common/rvDatePicker.html",controller:"RVAddonDatePickerController",className:"",scope:e,closeByDocument:!0})},e.dateSelected=function(a){"start_date"===e.datePickerFor?e.selectedPurchesedAddon.start_date=n("date")(a,t.dateFormat):e.selectedPurchesedAddon.end_date=n("date")(a,t.dateFormat),f()},e.closePopup=function(){r.close(),e.showRightContentForMobile=!1},e.goBackToAddonsList=function(){e.showRightContentForMobile=!1},e.closeCalendar=function(){d.close()},e.goToAddons=function(){e.closePopup(),t.$broadcast("NAVIGATE_TO_ADDONS",{addonPostingMode:e.addonPopUpData.addonPostingMode})},e.removeChosenAddons=function(a,o,n){a.stopPropagation(),e.selectedPurchesedAddon="",n.is_allowance&&n.is_consumed_allowance?e.errorMessage=["Cannot remove consumed allowance from staycard"]:(1===e.packageData.existing_packages.length&&e.closePopup(),t.$broadcast("REMOVE_ADDON",{addonPostingMode:e.addonPopUpData.addonPostingMode,index:o,addon:n}))},e.proceedBooking=function(){for(var t=e.selectedPurchesedAddon.custom_nightly_selected_post_days,a=t.length,o=0,n=0,r=c(e.selectedPurchesedAddon.startDateObj,e.selectedPurchesedAddon.endDateObj,"days"),s=0;s<a;s++){var i=t[s];r.includes(i)&&(n++,e.selectedPurchesedAddon.selected_post_days[i]===!1&&o++)}o===n?e.errorMessage=["Please remove the addon if deselecting all the available days"]:(m(),e.$emit("PROCEED_BOOKING",{addonPostingMode:e.addonPopUpData.addonPostingMode,selectedPurchesedAddon:e.selectedPurchesedAddon}),e.closePopup())},e.setDeafultDisplay=function(){angular.copy(e.previousPostDays,e.selectedPurchesedAddon.selected_post_days),e.selectedPurchesedAddon=""},e.shouldShowAddMoreButton=function(){var t=e.addonPopUpData.addonPostingMode;return"staycard"===t||"group"===t||"allotments"===t};var m=function(){angular.forEach(e.packageData.existing_packages,function(a){a.startDateObj?a.start_date=n("date")(tzIndependentDate(a.startDateObj),t.dateFormatForAPI):a.start_date=n("date")(tzIndependentDate(a.start_date),t.dateFormatForAPI),a.endDateObj?a.end_date=n("date")(tzIndependentDate(a.endDateObj),t.dateFormatForAPI):a.end_date=n("date")(tzIndependentDate(a.end_date),t.dateFormatForAPI),angular.forEach(a.post_instances,function(t){var a=new Date(t.post_date),o=e.daysOfWeek[a.getDay()];t.active=e.selectedPurchesedAddon.selected_post_days[o]})})},f=function(){e.daysOfWeek=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];var t,a,o=e.selectedPurchesedAddon.startDateObj,n=e.selectedPurchesedAddon.endDateObj;if(t=(moment(n)-moment(o))/864e5,t--,t<=6){e.daysOfWeekCopy=[],a=o.getDay(),e.selectedPurchesedAddon.is_allowance&&e.selectedPurchesedAddon.is_consume_next_day&&a++;for(var r=0;r<=t;r++)a<7?(e.daysOfWeekCopy.push(e.daysOfWeek[a]),a++):(e.daysOfWeekCopy.push(e.daysOfWeek[a-7]),a++);angular.copy(e.daysOfWeekCopy,e.daysOfWeek)}}}]),sntRover.controller("RVAddonDatePickerController",["$scope",function(e){var t="",a="";e.data={},"start_date"===e.datePickerFor?(e.data.selectedDate=tzIndependentDate(e.selectedPurchesedAddon.startDateObj),t=tzIndependentDate(e.addonPostingDate.startDate),a=tzIndependentDate(e.selectedPurchesedAddon.endDateObj)):(e.data.selectedDate=tzIndependentDate(e.selectedPurchesedAddon.endDateObj),t=tzIndependentDate(e.selectedPurchesedAddon.startDateObj),a=tzIndependentDate(e.addonPostingDate.endDate)),e.setUpData=function(){e.dateOptions={changeYear:!0,changeMonth:!0,yearRange:"0:+10",minDate:t,maxDate:a,onSelect:function(){"start_date"===e.datePickerFor?e.selectedPurchesedAddon.startDateObj=tzIndependentDate(e.data.selectedDate):e.selectedPurchesedAddon.endDateObj=tzIndependentDate(e.data.selectedDate),e.dateSelected(e.data.selectedDate),e.closeCalendar()}}},e.setUpData()}]),angular.module("sntRover").service("RVReservationStateService",[function(){var e=this;e.metaData={rateAddons:[],taxDetails:[]},e.reservationFlags={outsideStaydatesForGroup:!1,borrowForGroups:!1,RATE_CHANGED:!1,RATE_CHANGE_FAILED:!1},e.bookMark={lastPostedRate:null},e.fetchAssociatedAddons=function(t){_.isArray(t)&&(t=t[0]);var a=_.findWhere(e.metaData.rateAddons,{rate_id:t});return a&&a.associated_addons?a.associated_addons:null},e.updateRateAddonsMeta=function(t){if(0===t.length)return!1;var a=_.findWhere(e.metaData.rateAddons,{rate_id:t[0].rateId});a?a[0]=t[0]:e.metaData.rateAddons.push(t[0])},e.getCustomRateModel=function(e,t,a){var o=a&&"ALLOTMENT"===a,n="_CUSTOM_"+e,r=o?"Custom Rate for Allotment "+t:"Custom Rate for Group "+t,s=o?"Custom Allotment Rate":"Custom Group Rate";return{id:n,name:r,description:s,is_suppress_rate_on:!1,is_discount_allowed_on:!0,rate_type:{id:null,name:o?"Allotment Rate":"Group Rate"},deposit_policy:{id:null,name:"",description:""},cancellation_policy:{id:null,name:"",description:""},market_segment:{id:null,name:""},source:{id:null,name:""},is_member:!1,linked_promotion_ids:[]}},e.getAddonAmount=function(e,t,a,o){return"PERSON"===e?t*parseInt(parseInt(a,10)+parseInt(o,10),10):"CHILD"===e?t*parseInt(o,10):"ADULT"===e?t*parseInt(a,10):t},e.calculateRate=function(e,t,a){var o=t>=2?e.double:e.single,n=t>=2?t-2:0;return o+n*e.extra_adult+a*e.child},e.calculateMultiplier=function(e,t,a){var o=1;return"ADULT"===e?o=t:"CHILD"===e?o=a:"PERSON"===e&&(o=parseInt(a,10)+parseInt(t,10)),o},e.getApplicableAddonsCount=function(e,t,a,o,n,r,s,i){var l=function(e,t){return 0===a?t:1===a?t*r:"undefined"!=typeof s&&s?t*parseInt(r/a,10):t*(parseInt(r/a,10)+1)},c=function(e,t){return"create_group"===t||"create_allotment"===t||"group"===t||"allotments"===t?0:e};return"PERSON"===e?l(t,o+c(n,i)):"ADULT"===e?l(t,o):"CHILD"===e?l(t,n):"FLAT"===e||"ROOM"===e?l(t,1):void 0},e.computeBaseAmount=function(t,a,o,n){var r=0,s=0;return _.each(a,function(t){var a=t.is_inclusive,i=_.findWhere(e.metaData.taxDetails,{id:parseInt(t.charge_code_id,10)}),l=i.amount_type,c=e.calculateMultiplier(l,o,n);a&&("%"===i.amount_symbol?r+=c*parseFloat(i.amount):s+=c*parseFloat(i.amount))}),100*t/(100+r)-s},e.setReservationFlag=function(t,a){e.reservationFlags[t]=a},e.getReservationFlag=function(t){return e.reservationFlags[t]},e.shouldPostAddon=function(e,t,a,o,n){if(0===e&&t===a)return!0;var r=864e5,s=parseInt((new tzIndependentDate(t)-new tzIndependentDate(a))/r,10),i=parseInt((new tzIndependentDate(o)-new tzIndependentDate(t))/r,0);return s%e===0&&(!n||n&&i>=e)},e.isPostDaySelected=function(e,t){if(!t)return!0;var a,o=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],n=new tzIndependentDate(e);return a=n.getDay(),t[o[a]]},e.applyDiscount=function(e,t,a){return 0===a&&(a=1),parseFloat(e)<=0?0:"amount"===t.type?e-t.value/a:e-e*(t.value/100)};e.getAddonAmounts=function(t,a,o,n){var r={};return _.each(n,function(n,s){var i=n.guests.adults,l=n.guests.children,c=s;r[c]={},_.each(t,function(t){var n=t.rate_id;_.each(t.associated_addons,function(t){var s=parseFloat(e.getAddonAmount(t.amount_type.value,parseFloat(t.amount),i,l)),u=e.shouldPostAddon(t.post_type.frequency,c,a,o,t.charge_full_weeks_only);!t.is_inclusive&&u&&(void 0===r[c][n]?r[c][n]=s:r[c][n]=parseFloat(r[c][n])+s)})})}),r},this.setForceOverbookFlagForGroup=function(e){this.forceOverbookForGroups=e},this.getForceOverbookForGroup=function(){return this.forceOverbookForGroups}}]);