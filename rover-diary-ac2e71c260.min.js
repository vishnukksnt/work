function Model(e){var t=function(e){return{enumerable:!0,writable:!0,value:e}},r=Object.prototype.hasOwnProperty;if(!(this instanceof Model))return new Model(e);Object.defineProperties(this,{isUpdating:t(!1),isResolved:t(!1),isDirty:t(!1)});for(var i in e)r.call(e,i)&&(this[i]=e[i])}function Time(e){return this instanceof Time?(e=function(e){var t={};return e.toFixed?(t.milliseconds=e%1e3,t.seconds=Math.floor(e/1e3),t.minutes=Math.floor(e/6e4),t.hours=Math.floor(e/36e5),t):e}(e),void function(e){var t=function(e){return{enumerable:!0,writable:!0,value:e}};Object.defineProperties(this,{milliseconds:t(e.milliseconds||0),seconds:t(e.seconds||0),minutes:t(e.minutes||0),hours:t(e.hours||0)})}.call(this,e)):new Time(e)}sntRover.factory("rvDiaryMetadata",function(){return Object.freeze(Object.seal({room:{id:"id",number:"room_no",type:"room_type_name",type_id:"room_type_id",row_children:"occupancy",inactive_slots:"room_inactive_slots",hk_status:"room_status",hk_status_map:{CLEAN:"clean",DIRTY:"dirty",INSPECTED:"inspected",PICKUP:"pickup",DO_NOT_DISTURB:"dnd"}},room_type:{id:"id"},maintenance:{id:"room_type_id",time_span:"housekeeping_task_completion_time"},occupancy:{id:"reservation_id",room_id:"room_id",room_type:"room_type",status:"reservation_status",room_status:"room_service_status",guest:"reservation_primary_guest_full_name",accompanying_guests:"accompanying_guests",start_date:"arrival",end_date:"departure",maintenance:"maintenance",rate:"amount",room_status:"room_service_status",tr_ag_name:"travel_agent_name",cmp_name:"company_card_name"},availability:{id:"reservation_id",room_id:"id",price:"amount",rate_type_id:"rate_type_id"},availability_count:{id:"hour"},inactive_rooms:{id:"room_id",status:"service_status",number:"room_no"}}))}),angular.module("sntRover").service("rvDiarySrv",["$q","sntBaseWebSrv","rvBaseWebSrvV2","rvDiaryUtil","rvDiaryMetadata","$vault","$rootScope",function(e,t,r,i,a,o,n){function s(){return this instanceof s?(this.bCreated=!0,void(this.creation_time=Date.now())):new s}function l(e,t,r,i,a,o,n){if(!(this instanceof l))return new l(e,t,r,i,a,o,n);for(var s in e)_.has(e,s)&&(this[s]=e[s]);this.params={descr:t||[]},this.loaded=!1,this.dataStore=a,this.normalize=o,this.merge=n,this.store={data:[],index:{values:Object.create(null),descr:r||[]},group:{values:Object.create(null),descr:i||[]}}}function u(e,t,r,i){var a=e.toComponents(),o=t.toComponents(),n={begin_time:a.time.toString(),end_time:o.time.toString(),begin_date:a.date.toDateString(),end_date:o.date.toDateString()};return r&&_.extend(n,{room_type_id:r}),i&&_.extend(n,{rate_type:i}),n}function c(e,t){var r=e.toComponents(),i=t.toComponents(),a={begin_time:"00:00",end_time:"23:59",begin_date:r.date.toDateString(),end_date:i.date.toDateString()};return a}s.prototype={constructor:s,namespace:function(e){for(var t=e.split("."),r=this,i=0,a=t.length;i<a;i++)r=r[t[i]];return r},set:function(){var e=_.toArray(arguments),t=function(e){var t=e.shift(),r=e.shift();_.isObject(r)&&_.has(r,"data")?(this[t]=r.data,this["_"+t]=r.index,this["__"+t]=r.group):this[t]=r}.bind(this);switch(e.length){case 1:_.isObject(e[0])&&_.each(_.pairs(e[0]),function(e){t(e)});break;case 2:t(e)}return this},get:function(e){var t=_.toArray(arguments);switch(t.length){case 1:return this.namespace(t[0]);default:return _.pick(this,t)}},mergeOccupancies:function(e){for(var t,r,a,o,n,s=_.keys(e),l=0,u=s.length;l<u;l++)t=+s[l],r=_.findWhere(this.get("room"),{id:t}),a=i.copyArray(r.occupancy,a),o=_.sortBy(e[t],"arrival"),0===a.length?r.occupancy=i.copyArray(a.concat(o),r.occupancy):(n=this.difference(a,o,"reservation_id"),n.length>0&&(a=this.merge(a,_.sortBy(n,"arrival"),[],"arrival"),r.occupancy=i.copyArray(a,r.occupancy)))},update:function(e,t,r){},difference:function(e,t,r){var i=_.difference(_.pluck(t,r),_.pluck(e,r)),a=[];return i.length>0&&(a=_.filter(t,function(e){return i.indexOf(e)})),a},merge:function(e,t,r,i){for(;e.length>0&&t.length>0;)r.push(t[0][i]<e[0][i]?t.shift():e.shift());return r.concat(e.length>0?e:t)}},this.data_Store=new s,l.prototype={constructor:l,apis:{GET:r.getJSON.bind(r)},read:function(e){return this.request("GET",e)()},request:function(e,t){return _.partial(this.apis[e],this.url,t)},resolve:function(e,t){var r=this,i=e?e[this.namespace]:null,a=this.store;this.key_prefix;null!==i&&(a.data=i,this.homogenizeValues(),this.generateIndex(),this.generateGroup(),this.dataStore.set(r.name,a),this.normalization(t),this.mergeData(),this.loaded=!0)},homogenizeValues:function(){var e=this.id,t=this.store,r=this.key_prefix;_.isArray(t.data)&&_.each(t.data,function(t){r&&(t.key=_.uniqueId(r+(t[e]||_.random(0,1e5))+"-"));for(var i in t)_.has(t,i)&&"room_no"!==i&&/^\d+\.?\d*$/.test(t[i])&&(t[i]=+t[i])})},mergeData:function(){var e=this.store;this.merge&&this.merge(e.data)},normalization:function(e){var t=this.store,r=this;this.normalize&&_.each(t.data,function(t){e?r.normalize.apply(r,[t].concat(e)):r.normalize.call(r,t)})},generateIndex:function(){var e=this.store;_.each(e.index.descr,function(t){e.index.values[t]=_.indexBy(e.data,t)})},generateGroup:function(){var e=this.store;_.each(e.group.descr,function(t){e.group.values[t]=_.groupBy(e.data,t)})},normalizeTime:function(e,t){var r=t.indexOf("am")>-1||t.indexOf("pm")>-1,i=t.slice(0,-3),a=t.slice(-2);return Date.parse(e+" "+(r?i+" "+a:t))},normalizeMaintenanceInterval:function(e){var t=e/15;return parseInt(t)}};var d=l({id:a.inactive_rooms.id,name:"inactiveroom",url:"api/room_services/inactive_rooms",key_prefix:"iar-",namespace:"inactive_rooms",cache:!0},["from_date","to_date"],void 0,["inactive_room_id"],this.data_Store),p=l({id:a.room.id,name:"room",url:"api/rooms",key_prefix:"rm-",namespace:"rooms",cache:!0},void 0,["id","room_no"],["room_type_id"],this.data_Store,function(e){var t=e.room_type_id,r=this.dataStore.get("_room_type.values.id")[t],i=this.dataStore.get("_maintenance.values.room_type_id")[t];i&&(r[a.maintenance.time_span]=i[a.maintenance.time_span]),e.room_type=r,e.occupancy=[],e.room_inactive_slots=[];var o=this.dataStore.get("inactiveroom"),n=null,s=null,l=null,u=null;return _.each(o,function(t,r){t.room_id===e.id&&(l=null===t.from_time?0:t.from_time.split(":")[0],u=null===t.from_time?0:t.from_time.split(":")[1],n=new tzIndependentDate(t.from_date),n.setHours(l,u,0),l=null===t.to_time?0:t.to_time.split(":")[0],u=null===t.to_time?0:t.to_time.split(":")[1],s=new tzIndependentDate(t.to_date),s.setHours(l,u,0),e.room_inactive_slots.push({startTime:n,endTime:s,status:t.service_status}))}),e[a.room.hk_status]=a.room.hk_status_map[e.hk_status],e[a.room.hk_status]+="CLEAN"!==e.hk_status||e.is_inspected?"":" not-inspected","OUT_OF_ORDER"!==e.room_service_status&&"OUT_OF_SERVICE"!==e.room_service_status||(e[a.room.hk_status]="unavailable"),e}),m=l({id:a.room_type.id,name:"room_type",url:"/api/room_types.json?is_exclude_pseudo=true",key_prefix:"rt-",namespace:"results",cache:!0},void 0,["id"],void 0,this.data_Store),v=l({id:a.maintenance.id,name:"maintenance",url:"/api/room_types_task_completion_time?exclude_pseudo=true",namespace:"results",cache:!0},void 0,["room_type_id"],void 0,this.data_Store,function(e){var t=a.maintenance;return e[t.time_span]=this.normalizeMaintenanceInterval(e[t.time_span]),e}),h=l({id:a.occupancy.id,name:"occupancy",url:"api/hourly_occupancy",key_prefix:"oc-",namespace:"reservations"},["start_date","end_date"],["reservation_id"],["room_id"],this.data_Store,function(e){var t=a.occupancy,r=(a.room,this.dataStore.get("_room.values.id")[e.room_id]),i=r.room_type;return e.arrival_date=e.arrival_date.replace(/-/g,"/"),e.departure_date=e.departure_date.replace(/-/g,"/"),e[t.start_date]||(e[t.start_date]=this.normalizeTime(e.arrival_date,e.arrival_time)),e[t.end_date]||(e[t.end_date]=this.normalizeTime(e.departure_date,e.departure_time)),e[t.maintenance]||(e[t.maintenance]=i[a.maintenance.time_span]),e[t.room_type]=i.name.toLowerCase(),e[t.status]=e[t.status].toLowerCase(),"reserved"===e[t.status]?e[t.status]="reserved":"checkedin"===e[t.status]?e[t.status]="inhouse":"checkedout"===e[t.status]?e[t.status]="departed":"checking_out"===e[t.status]?e[t.status]="check-out":"checking_in"===e[t.status]?e[t.status]="check-in":"noshow"===e[t.status]&&(e[t.status]="no-show"),r=_.findWhere(p.store.data,{id:e.room_id}),delete e.arrival_time,delete e.arrival_date,delete e.departure_time,delete e.departure_date,e},function(e){this.dataStore.mergeOccupancies(this.store.group.values.room_id)}),f=l({id:a.availability.id,name:"availability",url:"api/hourly_availability",key_prefix:"av-",namespace:"availability",observe_change:!0},["start_date","end_date","room_type_id","rate_type","account_id"],void 0,["id"],this.data_Store,function(){var e=_.toArray(arguments),t=e.shift(),r=e.shift(),i=e.shift(),o=e.shift(),n=e.shift(),s=a.occupancy,l=this.dataStore.get("_room.values.id")[t.id],u=l.room_type,c={WEBBOOKING:"blocked",AVAILABLE:"available"};return t.room_id||(t.room_id=l.id,t.reservation_status=c[t.status],t.room_service_status="",t.reservation_id=o,t.selected=n,t[s.start_date]=r.getTime(),t[s.end_date]=i.getTime(),t[s.maintenance]=u[a.maintenance.time_span],t[s.room_type]=u.name.toLowerCase()),t},function(e){this.dataStore.mergeOccupancies(this.store.group.values.id,!0)}),g=l({name:"availability_count",url:"api/hourly_availability_count",key_prefix:"ac-",namespace:"availability_count_per_hour",cache:!0},["start_date","end_date"],void 0,void 0,this.data_Store),y=l({id:"min_hours",name:"min_hours",url:"/api/hourly_rate_min_hours",namespace:"min_hours",cache:!0},void 0,void 0,void 0,this.data_Store);this.load=function(t,r){var a=this.data_Store,o=this.fetchArrivalTimes(15,[]),n=i.gridTimeComponents(t,48),s=e.defer();a.set({common_reservation_data:{company_id:void 0,travel_Agent_id:void 0,guest_first_name:void 0,guest_last_name:void 0,occupancy_data:{adults:1,children:0,infants:0}}}),r&&(n=i.gridTimeComponents(r.start_date,48),a.set({filter:{arrival_time:t.toComponents().time.toString(),min_hours:(r.end_date-r.start_date)/36e5,room_type_id:r.room_type_id},common_reservation_data:{company_id:r.company_id,travel_agent_id:r.travel_agent_id,occupancy_details:{adults:r.adults,children:r.children,infants:r.infants}}}));var l=n.toStartDate(),f=n.x_p;return l.setHours(0,0,0),f.setHours(0,0,0),e.all([v.read(),m.read(),d.read(c(n.toShijuBugStartDate(0),n.toShijuBugEndDate(23))),p.read(),h.read(c(n.toShijuBugStartDate(0),n.toShijuBugEndDate(23))),g.read(u(l,f))]).then(function(e){return _.reduce([v,m,d,p,h,g],function(t,r,i){r.resolve(e[i])},e),y.read()}).then(function(e){y.resolve(e),a.set({filter:{arrival_times:o,arrival_time:n.x_origin_start_time.toString(),rate:void 0,rate_id:void 0,rate_type:"Standard",room_type:a.get("room_type"),room_type_id:r?r.room_type_id:""},display:{x_n:n.x_n,x_n_time:n.x_n_time,x_origin:n.x_0,x_origin_start_time:n.x_origin_start_time,x_p:n.x_p,x_p_time:n.x_p_time,x_offset:n.x_offset,min_hours:a.get("min_hours")}}),s.resolve(a.get("display","filter","common_reservation_data","room","availability_count"))},function(e){s.reject(e)}),s.promise},this.isReservationMovingFromOneDateToAnother=!1,this.movingReservationData={reservation:void 0,originalRoom:void 0,originalReservation:void 0},this.callOccupancyAndAvailabilityCount=function(t,r){var a=this.data_Store,o=i.gridTimeComponents(t,48),n=e.defer(),s=this;return e.all([d.read(c(o.toShijuBugStartDate(0),o.toShijuBugEndDate(23))),p.read(),h.read(c(o.toShijuBugStartDate(0),o.toShijuBugEndDate(23))),g.read(u(o.x_n,o.x_p))]).then(function(e){if(s.isReservationMovingFromOneDateToAnother){var t,r,i=s.movingReservationData.reservation,l=new Date(i.arrival),u=new Date(i.departure),c=u.getTime()-l.getTime();t=new Date(o.x_n),t.setHours(l.getHours(),l.getMinutes(),0),r=new Date(t.getTime()+c),i.arrival_date=t.toComponents().date.toDateString(),i.arrival_time=t.toComponents().time.toHourAndMinute(":",24),i.arrival=t.getTime(),i.departure_date=r.toComponents().date.toDateString(),i.departure_time=r.toComponents().time.toHourAndMinute(":",24),i.departure=r.getTime();var m=_.findIndex(e[2].reservations,{reservation_id:i.reservation_id});e[2].reservations.push(i),m>=0&&e[2].reservations.splice(m,1)}_.reduce([d,p,h,g],function(t,r,i){r.resolve(e[i])},e),n.resolve(a.get("room","availability_count"))},function(){n.reject()}),n.promise},this.fetchArrivalTimes=function(e,t){for(var r,i,a=1440,o=0;o<a;o+=e)r=o%60,i=parseInt(o/60,10),t.push((i<10?"0"+i:i)+":"+(r<10?"0"+r:r));return t},this.Occupancy=function(t,r){var i=e.defer();return h.read(u(t,r)).then(function(e){console.log(e),h.resolve(e),i.resolve(h.store.data)},function(e){i.reject(e)}),i.promise},this.AvailabilityCount=function(t,r){var i=e.defer();return g.read(u(t,r)).then(function(e){g.resolve(e),i.resolve(g.store.data)},function(e){i.reject(e)}),i.promise},this.Availability=function(t){var r=this,i=t.start_date,a=t.end_date,o=t.room_type_id,n=t.rate_type,s=t.account_id,l=t.reservation_id,c=t.GUID,d=r.data_Store,p=e.defer(),m=c||_.uniqueId("avl-"),v=t.is_unassigned_room,t=u(i,a,o,n);return n&&s&&_.extend(t,{account_id:s}),l&&_.extend(t,{reservation_id:l}),v&&_.extend(t,{is_unassigned_room:!0}),f.read(t).then(function(e){if(e&&e.results){e.contract_id&&d.set({contractId:e.contract_id});var t,r=e.results[0].availability,o=e.results[0].room_types;_.each(r,function(e){t=_.find(o,{id:e.room_type_id}),t&&(e.physical_count=t.available_count)});var n=JSON.parse(JSON.stringify(f.store.data)),s=_.pluck(n,"id"),l=JSON.parse(JSON.stringify(e.results[0].availability)),u=_.pluck(l,"id"),c=void 0;if(s.length>0){c=_.difference(s,u);for(var v=f.store.data.length,h=0;h<v;h++)for(var g=0;g<c.length;g++)f.store.data[h]&&_.has(f.store.data[h],"id")&&f.store.data[h].id===c[g]&&(f.store.data.splice(h),delete f.store.group.values.id[c[g]],v--)}f.resolve(e.results.shift(),[i,a,m,!1]),p.resolve(f.store.data)}},function(e){p.reject(e)}),p.promise}.bind(this),this.roomAvailabilityCheckAgainstReservation=function(t){var i={room_id:t.room_id,reservation_id:t.reservation_id,begin_date:t.begin_date,begin_time:t.begin_time,end_date:t.end_date,end_time:t.end_time,rate_type:t.rate_type};"Corporate"===t.rate_type&&t.account_id&&_.extend(i,{account_id:t.account_id});var a=e.defer(),o="/api/hourly_availability/room";return r.getJSON(o,i).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.properDateTimeCreation=function(e){function t(){var t=new Date(Date.now()),r=t.getHours(),i=t.getMinutes(),a="";a=r>12?"PM":"AM",i>45&&r+1<12?(r+=1,i=0):i>45&&r+1===12?"AM"===a?(r=12,i=0,a="PM"):(r=12,i=0,a="AM"):15===i||30===i||45===i?i+=15:i=15===Math.max(i,15)?15:30===Math.max(i,30)?30:45,e.setHours(r,i)}var r,i=o.get("searchReservationData");return e=e?new tzIndependentDate(e):new tzIndependentDate(n.businessDate),i?(i=JSON.parse(i),r=getTimeFormated(i.arrivalTime.hh,i.arrivalTime.mm,i.arrivalTime.ampm),r=r.split(":"),e.setHours(parseInt(r[0]),parseInt(r[1]))):t(),e},this.checkAvailabilityForReservationToA_Date=function(t){var i={room_id:t.room_id,reservation_id:t.reservation_id,begin_date:t.begin_date,begin_time:t.begin_time,end_date:t.end_date,end_time:t.end_time,rate_type:t.rate_type};"Corporate"===t.rate_type&&t.account_id&&_.extend(i,{account_id:t.account_id});var a=e.defer(),o="/api/hourly_availability/room_move";return r.getJSON(o,i).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.ArrivalFromCreateReservation=function(){function e(e,t,r){var i,a,o=36e5*r,e=new tzIndependentDate(e).setHours(0,0,0);return i="PM"===t.ampm?36e5*(12+parseInt(t.hh,10)):36e5*parseInt(t.hh,10),a=6e4*parseInt(t.mm,10),i+a+o+e}function t(e){var t=moment(e).isDST(),r=moment(e).add(-1,"days").isDST(),i=moment(e).add(1,"days").isDST();return{hasExtraHour:t&&!i,hasLessHour:t&&!r}}var r=o.get("searchReservationData");if(r&&(r=JSON.parse(r)),r){var i=t(r.fromDate),a=i.hasExtraHour?1:i.hasLessHour?-1:0,n=e(r.fromDate,r.arrivalTime,a),s=e(r.toDate,r.departureTime,a),l=new Date(r.fromDate),u=new Date(r.toDate);return l.setHours(0),u.setHours(0),l.setMinutes(0),u.setMinutes(0),{__start_date:l,__end_date:u,start_date:n,end_date:s,adults:r.adults,children:r.children,infants:r.infants,room_type_id:r.roomTypeID,guest_first_name:r.guestFirstName,guest_last_name:r.guestLastName,company_id:r.companyID,travel_agent_id:r.TravelAgenID,minHours:parseInt(r.minHours)}}},this.fetchUnassignedRoomList=function(t){var i=e.defer(),a="/api/hourly_occupancy/unassigned_list?date="+t.date,o=n.businessDate;return r.getJSON(a).then(function(e){angular.forEach(e.reservations,function(e){e.statusClass=e.arrival_date===o?"guest check-in":"guest no-status"}),i.resolve(e.reservations)},function(e){i.reject(e)}),i.promise},this.fetchUnassignedRoomListCount=function(t){var i=e.defer(),a="/api/hourly_occupancy/unassigned_list?date="+t.date;return r.getJSON(a).then(function(e){i.resolve(e.reservations.length)},function(e){i.reject(e)}),i.promise},this.unassignRoom=function(t){var i=e.defer(),a="api/reservations/"+t.id+"/unassign_room/";return r.postJSON(a).then(function(e){i.resolve(e.reservations)},function(e){i.reject(e)}),i.promise},this.fetchAutoAssignStatus=function(){var e="api/auto_room_assign_processes/status";return t.getJSON(e)},this.unlockRoomDiary=function(){var e="api/auto_room_assign_processes/unlock_diary";return t.postJSON(e)}}]),sntRover.factory("rvDiaryUtil",["rvDiaryMetadata","$rootScope",function(e,t){var r,i,a,o,n,s,l,u,c,d,p,m,v,h,f,g,y,D,R=e,S=(R.occupancy,R.room,R.availability,Object.prototype.hasOwnProperty),M=Array.prototype.slice;return D=function(e,t,r){var i,a=36e5,o=e instanceof Date?new Date(e).toComponents().time.hours:0,n=e instanceof Date?e.setHours(new Date(e).toComponents().time.hours,new Date(e).toComponents().time.minutes,0):e,s=(t-o)*a,l=t*a-s,u=n+s,c=n-l,d=n-2*a;return i={x_offset:new tzIndependentDate(d),x_origin:new tzIndependentDate(n),x_0:new tzIndependentDate(n),x_n:new tzIndependentDate(c),x_p:new tzIndependentDate(u),toShijuBugStartDate:function(e){return new tzIndependentDate(new tzIndependentDate(c).setHours(e,0,0))},toShijuBugEndDate:function(e){return new tzIndependentDate(new tzIndependentDate(u).setHours(e,0,0))},toStartDate:function(){return new tzIndependentDate(new tzIndependentDate(c).setHours(0,0,0))},toEndDate:function(){return new tzIndependentDate(new tzIndependentDate(u).setHours(23,59,0))}},i.x_origin_start_time=i.x_origin.toComponents().time.convertToReferenceInterval(15),i.x_n_time=i.x_n.toComponents().time.convertToReferenceInterval(15),i.x_p_time=i.x_p.toComponents().time.convertToReferenceInterval(15),r&&(r.x_offset=d,r.x_origin=n,r.x_origin_start_time=i.x_origin_start_time,r.x_n=c,r.x_0=n,r.x_n_time=i.x_n_time,r.x_p=u,r.x_p_time=i.x_p_time,i.display=r),i},y=function(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e},g=function(){for(var e,t=M.call(arguments),r=0,i=t.length,a=Object.create(null);r<i;r++)for(e in t[r])S.call(t[r],e)&&(a[e]=t[r][e]);return a},f=function(e,t){var r;t=[];for(var i=0,a=e.length;i<a;i++)r=_.isObject(e[i])?h(e[i]):_.isArray(e[i])?f(e[i]):e[i],t.push(r);return t},v=function(e,t){var r;for(r in t)S.call(t,r)&&"function"!=typeof t[r]&&(e[r]=t[r]);return e},h=function(e){var t={};for(var r in e)S.call(e,r)&&(e[r]instanceof Date?t[r]=new Date(e[r].getTime()):_.isArray(e[r])?t[r]=f(e[r]):_.isObject(e[r])?t[r]=h(e[r]):t[r]=e[r]);return t},r=function(e,t){for(var r=-1,i=0,a=e.length;i<a;i++)if(e[i].id===t.id)return r=i;return r},i=function(e,t){for(var r=-1,i=e.occupancy,a=0,o=i.length;a<o;a++)if(i[a].reservation_id===t.reservation_id)return r=a;return r},a=function(e){return v({},e)},o=function(e){return h(e)},n=function(e,t){e[R.room.status]=t},s=function(e,t){var r=i(e,t);r>-1&&(e.occupancy[r]=t)},l=function(e,t){var r=i(e,t);if(r>-1)return e.occupancy.splice(r,1)},u=function(e){for(var t,r=R.occupancy.status,i=function(e){return"available"===e[r].toLowerCase()},a=0,o=e.length;a<o;a++)t=e[a],t.occupancy=_.reject(t.occupancy,i),t=h(t)},c=function(e,t,i,n){var u,c,d,p,m=e;u=o(i),t.id!==i.id?(c=o(t),l(u,n),c.occupancy.push(a(n)),d=r(e,u),p=r(e,c),d>-1&&d<m.length&&(m[d]=u),p>-1&&p<m.length&&(m[p]=c)):s(u,n)},d=function(e){var t=e;if(t)for(var r=0,i=t.length;r<i;r++)t[r]=h(t[r]),t[r][R.room.status]=""},p=function(e){if(_.isObject(e))for(var t in e)if(S.call(e,t))switch(typeof e[t]){case"function":}},m=function(e,t){var r=parseInt(t.hotel_time.hh),i=parseInt(t.hotel_time.mm),a="";a=r>12?"PM":"AM",i>45&&r+1<12?(r+=1,i=0):i>45&&r+1===12?"AM"===a?(r=12,i=0,a="PM"):(r=12,i=0,a="AM"):15===i||30===i||45===i?i+=15:i=15===Math.max(i,15)?15:30===Math.max(i,30)?30:45;var o=e,n=new tzIndependentDate(o).getTime(),s=new tzIndependentDate(n).setHours(0,0,0),l=36e5*r+6e4*i+s,u=new tzIndependentDate(o);return u.setHours(0,0,0),{start_date:l,__start_date:u,arrival_time:(r<10?"0"+r:r)+":"+(0===i?"00":i)}},{gridTimeComponents:D,clearRoomQuery:u,removeReservation:l,updateReservation:s,updateRoomStatus:n,copyRoom:o,copyReservation:a,reservationIndex:i,roomIndex:r,reservationRoomTransfer:c,clearRowClasses:d,shallowCopy:v,copyArray:f,deepCopy:h,mixin:g,correctTime:m}}]),angular.module("sntRover").service("RVReservationBaseSearchSrv",["$q","rvBaseWebSrvV2","sntBaseWebSrv","dateFilter",function(e,t,r,i){var a=this;this.reservation={settings:{},roomTypes:{},businessDate:{}},this.rateDetailsList={},this.cache={config:{lifeSpan:3600},responses:{restrictionTypes:null,rateDetails:null,sortOrder:null,taxMeta:null,customMeta:null}},this.getRoomRatesDefaultView=function(){var e="ROOM_TYPE";return a.reservation.settings&&a.reservation.settings.default_rate_display_name&&("Recommended"===a.reservation.settings.default_rate_display_name?e="RECOMMENDED":"By Rate"===a.reservation.settings.default_rate_display_name&&(e="RATE")),e},this.getRoomTypeLevel=function(e){var t=-1;if(a.reservation.roomTypes){var r=_.find(a.reservation.roomTypes,{id:e});t=r.level}return t},this.timeSlots=[{value:"12:00 AM",label:"12:00 AM",fullDayValue:0},{value:"12:15 AM",label:"12:15 AM",fullDayValue:15},{value:"12:30 AM",label:"12:30 AM",fullDayValue:30},{value:"12:45 AM",label:"12:45 AM",fullDayValue:45},{value:"01:00 AM",label:"01:00 AM",fullDayValue:100},{value:"01:15 AM",label:"01:15 AM",fullDayValue:115},{value:"01:30 AM",label:"01:30 AM",fullDayValue:130},{value:"01:45 AM",label:"01:45 AM",fullDayValue:145},{value:"02:00 AM",label:"02:00 AM",fullDayValue:200},{value:"02:15 AM",label:"02:15 AM",fullDayValue:215},{value:"02:30 AM",label:"02:30 AM",fullDayValue:230},{value:"02:45 AM",label:"02:45 AM",fullDayValue:245},{value:"03:00 AM",label:"03:00 AM",fullDayValue:300},{value:"03:15 AM",label:"03:15 AM",fullDayValue:315},{value:"03:30 AM",label:"03:30 AM",fullDayValue:330},{value:"03:45 AM",label:"03:45 AM",fullDayValue:345},{value:"04:00 AM",label:"04:00 AM",fullDayValue:400},{value:"04:15 AM",label:"04:15 AM",fullDayValue:415},{value:"04:30 AM",label:"04:30 AM",fullDayValue:430},{value:"04:45 AM",label:"04:45 AM",fullDayValue:445},{value:"05:00 AM",label:"05:00 AM",fullDayValue:500},{value:"05:15 AM",label:"05:15 AM",fullDayValue:515},{value:"05:30 AM",label:"05:30 AM",fullDayValue:530},{value:"05:45 AM",label:"05:45 AM",fullDayValue:545},{value:"06:00 AM",label:"06:00 AM",fullDayValue:600},{value:"06:15 AM",label:"06:15 AM",fullDayValue:615},{value:"06:30 AM",label:"06:30 AM",fullDayValue:630},{value:"06:45 AM",label:"06:45 AM",fullDayValue:645},{value:"07:00 AM",label:"07:00 AM",fullDayValue:700},{value:"07:15 AM",label:"07:15 AM",fullDayValue:715},{value:"07:30 AM",label:"07:30 AM",fullDayValue:730},{value:"07:45 AM",label:"07:45 AM",fullDayValue:745},{value:"08:00 AM",label:"08:00 AM",fullDayValue:800},{value:"08:15 AM",label:"08:15 AM",fullDayValue:815},{value:"08:30 AM",label:"08:30 AM",fullDayValue:830},{value:"08:45 AM",label:"08:45 AM",fullDayValue:845},{value:"09:00 AM",label:"09:00 AM",fullDayValue:900},{value:"09:15 AM",label:"09:15 AM",fullDayValue:915},{value:"09:30 AM",label:"09:30 AM",fullDayValue:930},{value:"09:45 AM",label:"09:45 AM",fullDayValue:945},{value:"10:00 AM",label:"10:00 AM",fullDayValue:1e3},{value:"10:15 AM",label:"10:15 AM",fullDayValue:1015},{value:"10:30 AM",label:"10:30 AM",fullDayValue:1030},{value:"10:45 AM",label:"10:45 AM",fullDayValue:1045},{value:"11:00 AM",label:"11:00 AM",fullDayValue:1100},{value:"11:15 AM",label:"11:15 AM",fullDayValue:1115},{value:"11:30 AM",label:"11:30 AM",fullDayValue:1130},{value:"11:45 AM",label:"11:45 AM",fullDayValue:1145},{value:"12:00 PM",label:"12:00 PM",fullDayValue:1200},{value:"12:15 PM",label:"12:15 PM",fullDayValue:1215},{value:"12:30 PM",label:"12:30 PM",fullDayValue:1230},{value:"12:45 PM",label:"12:45 PM",fullDayValue:1245},{value:"01:00 PM",label:"01:00 PM",fullDayValue:1300},{value:"01:15 PM",label:"01:15 PM",fullDayValue:1315},{value:"01:30 PM",label:"01:30 PM",fullDayValue:1330},{value:"01:45 PM",label:"01:45 PM",fullDayValue:1345},{value:"02:00 PM",label:"02:00 PM",fullDayValue:1400},{value:"02:15 PM",label:"02:15 PM",fullDayValue:1415},{value:"02:30 PM",label:"02:30 PM",fullDayValue:1430},{value:"02:45 PM",label:"02:45 PM",fullDayValue:1445},{value:"03:00 PM",label:"03:00 PM",fullDayValue:1500},{value:"03:15 PM",label:"03:15 PM",fullDayValue:1515},{value:"03:30 PM",label:"03:30 PM",fullDayValue:1530},{value:"03:45 PM",label:"03:45 PM",fullDayValue:1545},{value:"04:00 PM",label:"04:00 PM",fullDayValue:1600},{value:"04:15 PM",label:"04:15 PM",fullDayValue:1615},{value:"04:30 PM",label:"04:30 PM",fullDayValue:1630},{value:"04:45 AM",label:"04:45 PM",fullDayValue:1645},{value:"05:00 PM",label:"05:00 PM",fullDayValue:1700},{value:"05:15 PM",label:"05:15 PM",fullDayValue:1715},{value:"05:30 PM",label:"05:30 PM",fullDayValue:1730},{value:"05:45 PM",label:"05:45 PM",fullDayValue:1745},{value:"06:00 PM",label:"06:00 PM",fullDayValue:1800},{value:"06:15 PM",label:"06:15 PM",fullDayValue:1815},{value:"06:30 PM",label:"06:30 PM",fullDayValue:1830},{value:"06:45 PM",label:"06:45 PM",fullDayValue:1845},{value:"07:00 PM",label:"07:00 PM",fullDayValue:1900},{value:"07:15 PM",label:"07:15 PM",fullDayValue:1915},{value:"07:30 PM",label:"07:30 PM",fullDayValue:1930},{value:"07:45 PM",label:"07:45 PM",fullDayValue:1945},{value:"08:00 PM",label:"08:00 PM",fullDayValue:2e3},{value:"08:15 PM",label:"08:15 PM",fullDayValue:2015},{value:"08:30 PM",label:"08:30 PM",fullDayValue:2030},{value:"08:45 PM",label:"08:45 PM",fullDayValue:2045},{value:"09:00 PM",label:"09:00 PM",fullDayValue:2100},{value:"09:15 PM",label:"09:15 PM",fullDayValue:2115},{value:"09:30 PM",label:"09:30 PM",fullDayValue:2130},{value:"09:45 PM",label:"09:45 PM",fullDayValue:2145},{value:"10:00 PM",label:"10:00 PM",fullDayValue:2200},{value:"10:15 PM",label:"10:15 PM",fullDayValue:2215},{value:"10:30 PM",label:"10:30 PM",fullDayValue:2230},{value:"10:45 PM",label:"10:45 PM",fullDayValue:2245},{value:"11:00 PM",label:"11:00 PM",fullDayValue:2300},{value:"11:15 PM",label:"11:15 PM",fullDayValue:2315},{value:"11:30 PM",label:"11:30 PM",fullDayValue:2330},{value:"11:45 PM",label:"11:45 PM",fullDayValue:2345}],this.fetchBaseSearchData=function(){var r=e.defer();if(a.fetchBussinessDate=function(){var e="/api/business_dates/active";return t.getJSON(e).then(function(e){a.reservation.businessDate=e.business_date,r.resolve(a.reservation)},function(e){r.reject(e)}),r.promise},a.fetchRoomTypes=function(){var e="api/room_types.json?exclude_pseudo=true&per_page=100";return t.getJSON(e).then(function(e){a.reservation.roomTypes=e.results,a.fetchBussinessDate()},function(e){r.reject(e)}),r.promise},isEmpty(a.reservation.settings)&&isEmpty(a.reservation.roomTypes)&&isEmpty(a.reservation.businessDate)){var i="/api/hotel_settings/show_hotel_reservation_settings";t.getJSON(i).then(function(e){a.reservation.settings=e,a.fetchRoomTypes()},function(e){r.reject(e)})}else r.resolve(a.reservation);return r.promise},this.fetchCompanyCard=function(r){var i=e.defer(),a="/api/accounts";return t.getJSON(a,r).then(function(e){i.resolve(e)},function(e){i.reject(e)}),i.promise},this.autoCompleteCodes=function(r){var i=e.defer(),a="/api/code_search";return t.getJSON(a,r).then(function(e){i.resolve(e)},function(e){i.reject(e)}),i.promise},this.fetchCurrentTime=function(r){var i=e.defer(),a="/api/hotel_current_time";return t.getJSON(a).then(function(e){r&&"string"==typeof r&&(e.hotel_time.date=r),i.resolve(e)},function(e){i.reject(e)}),i.promise},this.fetchAvailability=function(r){var i=e.defer(),a="/api/availability?from_date="+r.from_date+"&to_date="+r.to_date+"&override_restrictions=true";return r.company_id&&(a+="&company_id="+r.company_id),r.travel_agent_id&&(a+="&travel_agent_id="+r.travel_agent_id),r.group_id&&(a+="&group_id="+r.group_id),r.promotion_code&&(a+="&promotion_code="+encodeURI(r.promotion_code)),r.allotment_id&&(a+="&allotment_id="+encodeURI(r.allotment_id)),t.getJSON(a).then(function(e){i.resolve(e)},function(e){i.reject(e)}),i.promise},this.fetchMinTime=function(){var r=e.defer(),i="/api/hourly_rate_min_hours";return t.getJSON(i).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.fetchSortPreferences=function(){var r=e.defer(),i="/api/sort_preferences/list_selections";return null===a.cache.responses.sortOrder||Date.now()>a.cache.responses.sortOrder.expiryDate?t.getJSON(i).then(function(e){a.cache.responses.sortOrder={data:e.room_rates,expiryDate:Date.now()+1e3*a.cache.config.lifeSpan},r.resolve(e.room_rates)},function(e){r.reject(e)}):r.resolve(a.cache.responses.sortOrder.data),r.promise},this.fetchAddonsForRates=function(r){var i=e.defer(),a="/api/addons/rate_addons";return t.getJSON(a,r).then(function(e){i.resolve(e.rate_addons)},function(e){i.reject(e)}),i.promise},this.hasAnyConfiguredAddons=function(r){var i=e.defer(),a="/api/addons/configured";return t.getJSON(a,r).then(function(e){i.resolve(e.addons_configured)},function(e){i.reject(e)}),i.promise},this.getActivePromotions=function(){var r=e.defer(),i="/api/promotions?is_active=true";return t.getJSON(i).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.fetchUserMemberships=function(r){var i=e.defer(),a="/staff/user_memberships.json?user_id="+r;return t.getJSON(a).then(function(e){i.resolve(e.data)},function(e){i.reject(e)}),i.promise},this.checkOverbooking=function(r){var i=e.defer(),a="/api/availability/overbooking_check";return t.getJSON(a,r).then(function(e){i.resolve(e.results)},function(e){i.reject(e)}),i.promise},this.checkDiaryAvailability=function(r){var i=e.defer(),a="/api/nightly_diary/availability";return t.postJSON(a,r).then(function(e){i.resolve(e)},function(e){i.reject(e)}),i.promise},this.fetchOrdinaryRates=function(r){var i=e.defer(),a="/api/availability/rates";return t.getJSON(a,r).then(function(e){i.resolve(e)},function(e){i.reject(e)}),i.promise},this.fetchContractRates=function(r){var i=e.defer(),a="/api/availability/contracts";return t.getJSON(a,r).then(function(e){i.resolve(e)},function(e){i.reject(e)}),i.promise},this.fetchGroupRates=function(r){var i=e.defer(),a=r.group_id||r.allotment_id,o="/api/availability/groups/"+a;return t.getJSON(o,r).then(function(e){i.resolve(e)},function(e){i.reject(e)}),i.promise},this.fetchRates=function(t){var r=e.defer(),i=[];return a.rates=[],t.group_id?i.push(a.fetchGroupRates(t).then(function(e){_.each(e.rates,function(e){null===e.id&&(e.id="_CUSTOM_"+t.group_id)}),a.rates=a.rates.concat(e.rates)})):(i.push(a.fetchOrdinaryRates(t).then(function(e){a.rates=a.rates.concat(e.rates)})),(t.company_id||t.travel_agent_id)&&i.push(a.fetchContractRates(t).then(function(e){_.each(e.rates,function(e){e.isCorporate=!0}),a.rates=a.rates.concat(e.rates)}))),e.all(i).then(function(){r.resolve(a.rates)},function(e){r.reject(e)}),r.promise},this.fetchRestricitonTypes=function(){var r=e.defer(),i="/api/restriction_types";return null===a.cache.responses.restrictionTypes||Date.now()>a.cache.responses.restrictionTypes.expiryDate?t.getJSON(i).then(function(e){e.results.push({id:98,value:"INVALID_PROMO",description:"PROMOTION INVALID",activated:!0}),
e.results.push({id:99,activated:!0,value:"HOUSE_FULL",description:"NO HOUSE AVAILABILITY"});var t={};_.each(e.results,function(e){t[e.id]={key:e.value,value:["CLOSED","CLOSED_ARRIVAL","CLOSED_DEPARTURE","HOUSE_FULL","INVALID_PROMO"].indexOf(e.value)>-1?e.description:e.description+":"}}),a.cache.responses.restrictionTypes={data:t,expiryDate:Date.now()+1e3*a.cache.config.lifeSpan},r.resolve(t)},function(e){r.reject(e)}):r.resolve(a.cache.responses.restrictionTypes.data),r.promise};var o=function(e){var t=_.reject(e.rate_ids,function(e){return!!(a.rateDetailsList[e]&&Date.now()<a.rateDetailsList[e].expiryDate)});return t};this.fetchRatesDetails=function(r){var i=o(r),n=e.defer(),s="/api/rates/search.json",l={};return l.rate_ids=i,0===i.length?n.resolve({}):t.postJSON(s,l).then(function(e){_.each(e.results,function(e){a.rateDetailsList[e.id]={expiryDate:Date.now()+1e3*a.cache.config.lifeSpan,details:e}}),n.resolve(e.results)},function(e){n.reject(e)}),n.promise},this.fetchCustomRateConfig=function(){var r=e.defer(),i="api/rates/custom_group_rate_taxes";return null===a.cache.responses.customMeta||Date.now()>a.cache.responses.customMeta.expiryDate?t.getJSON(i).then(function(e){var t=e;a.cache.responses.customMeta={data:t,expiryDate:Date.now()+1e3*a.cache.config.lifeSpan},r.resolve(t)},function(e){r.reject(e)}):r.resolve(a.cache.responses.customMeta.data),r.promise},this.fetchRatesMeta=function(t){var r=e.defer(),i=[];return a["rates-restrictions"]={},i.push(a.fetchRestricitonTypes(t).then(function(e){a["rates-restrictions"].restrictions=e})),i.push(a.fetchCustomRateConfig().then(function(e){a["rates-restrictions"].customRates=e})),e.all(i).then(function(){r.resolve(a["rates-restrictions"])},function(e){r.reject(e)}),r.promise},this.fetchTaxInformation=function(){var r=e.defer(),i="api/rates/tax_information";return null===a.cache.responses.taxMeta||Date.now()>a.cache.responses.taxMeta.expiryDate?t.getJSON(i).then(function(e){var t=e.tax_codes;a.cache.responses.taxMeta={data:t,expiryDate:Date.now()+1e3*a.cache.config.lifeSpan},r.resolve(t)},function(e){r.reject(e)}):r.resolve(a.cache.responses.taxMeta.data),r.promise},this.fetchHouseAvailability=function(r){var i=e.defer(),a="api/availability/house";return t.getJSON(a,r).then(function(e){var t={};_.each(e.results,function(e){t[e.date]=e.availability}),i.resolve(t)},function(e){i.reject(e)}),i.promise},this.fetchHouseRestrictions=function(r){var i=e.defer(),a="/api/availability/house_restrictions";return t.getJSON(a,r).then(function(e){i.resolve(e.restrictions)},function(e){i.reject(e)}),i.promise},this.fetchTaxRateAddonMeta=function(t){var r=e.defer(),i=[];return a.meta={},i.push(a.fetchTaxInformation().then(function(e){a.meta.taxInfo=e})),i.push(a.fetchAddonsForRates(t).then(function(e){a.meta.rateAddons=e})),e.all(i).then(function(){r.resolve(a.meta)},function(e){r.reject(e)}),r.promise},this.fetchHotelReservationSettings=function(){var r=e.defer(),i="/api/hotel_settings/show_hotel_reservation_settings";return t.getJSON(i).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.searchForRates=function(r){var i=e.defer(),a={},o="/api/rates.json?&sort_dir=true&sort_field=rate";return a.query=r.query,a.per_page=25,a.page=1,t.getJSON(o,a).then(function(e){i.resolve(e)},function(e){i.reject(e)}),i.promise},this.fetchRateDetailsForIds=function(r){var i=o(r),n=e.defer(),s="/api/rates/search.json",l={};return l.rate_ids=i,0===i.length?n.resolve({}):t.postJSON(s,l).then(function(e){_.each(e.results,function(e){a.rateDetailsList[e.id]={expiryDate:Date.now()+1e3*a.cache.config.lifeSpan,details:e}});var t=_.difference(r.rate_ids,i);_.each(t,function(t){e.results.push(a.rateDetailsList[t].details)}),n.resolve(e.results)},function(e){n.reject(e)}),n.promise},this.checkTimeBasedAvailabilityAPI=function(t){var i=e.defer(),a="api/availability/time_based_room_type_and_house_avl";return r.postJSON(a,t).then(function(e){i.resolve(e)},function(e){i.reject(e)}),i.promise}}]),angular.module("sntRover").service("RVReservationSummarySrv",["$q","rvBaseWebSrvV2",function(e,t){var r=this;this.reservationData={},this.reservationData.demographics={};var i={},a={},o={},n={},s={};this.fetchPaymentMethods=function(){var r=e.defer(),i="/staff/payments/addNewPayment.json";return t.getJSON(i).then(function(e){r.resolve(e.data)},function(e){r.reject(e)}),r.promise},this.fetchLengthSegments=function(){var r=e.defer();if(isEmpty(s)){var i="/api/segments?is_active=true";t.getJSON(i).then(function(e){s=e,r.resolve(e)},function(e){r.reject(e)})}else r.resolve(s);return r.promise},this.fetchDemographicMarketSegments=function(){var r=e.defer();if(isEmpty(i)){var a="/api/market_segments?is_active=true";t.getJSON(a).then(function(e){i=e,r.resolve(i)},function(e){r.reject(e)})}else r.resolve(i);return r.promise},this.fetchDemographicSources=function(){var r=e.defer();if(isEmpty(a)){var i="/api/sources?is_active=true";t.getJSON(i).then(function(e){a=e,r.resolve(a)},function(e){r.reject(e)})}else r.resolve(a);return r.promise},this.fetchDemographicOrigins=function(){var r=function(e){o.is_use_origins=e.is_use_origins,o.origins=[];for(var t in e.booking_origins)e.booking_origins[t].is_active&&o.origins.push(e.booking_origins[t]);i.resolve(o)},i=e.defer();if(isEmpty(o)){var a="/api/booking_origins";t.getJSON(a).then(function(e){r(e)},function(e){i.reject(e)})}else i.resolve(o);return i.promise},this.fetchDemographicReservationTypes=function(){var i=function(e){n=[],r.reservationData.demographics.reservationTypes=[];for(var t in e.reservation_types)e.reservation_types[t].is_active&&n.push(e.reservation_types[t]);a.resolve(n)},a=e.defer();if(isEmpty(n)){var o="/api/reservation_types.json?is_active=true";t.getJSON(o).then(function(e){i(e)},function(e){a.reject(e)})}else a.resolve(n);return a.promise},this.fetchInitialData=function(){var t=e.defer(),i={};return i.marketsData=r.fetchDemographicMarketSegments(),i.originsData=r.fetchDemographicOrigins(),i.sourcesData=r.fetchDemographicSources(),i.reservationTypesData=r.fetchDemographicReservationTypes(),i.segmentsData=r.fetchLengthSegments(),e.all(i).then(function(e){r.reservationData.demographics.is_use_markets=e.marketsData.is_use_markets,r.reservationData.demographics.markets=e.marketsData.markets,r.reservationData.demographics.is_use_origins=e.originsData.is_use_origins,r.reservationData.demographics.origins=e.originsData.origins,r.reservationData.demographics.is_use_sources=e.sourcesData.is_use_sources,r.reservationData.demographics.sources=e.sourcesData.sources,r.reservationData.demographics.is_use_segments=e.segmentsData.is_use_segments,r.reservationData.demographics.segments=e.segmentsData.segments,r.reservationData.demographics.reservationTypes=e.reservationTypesData,t.resolve(r.reservationData)},function(e){t.reject(e)}),t.promise},this.saveReservation=function(r){var i=e.defer(),a="/api/reservations";return t.postJSON(a,r).then(function(e){i.resolve(e)},function(e){i.reject(e)}),i.promise},this.updateBillingInformation=function(r){var i=e.defer(),a="api/bill_routings/update_dates";return t.postJSON(a,r).then(function(e){i.resolve(e)},function(e){i.reject(e)}),i.promise},this.sendConfirmationEmail=function(r){var i=e.defer(),a="/api/reservations/"+r.reservationId+"/email_confirmation";return delete r.reservationId,t.postJSON(a,r).then(function(e){i.resolve(e)},function(e){i.reject(e)}),i.promise},this.sendHourlyConfirmationEmail=function(r){var i=e.defer(),a="/api/reservations/hourly_confirmation_emails?";return _.each(r.reservation_ids,function(e){a+="reservation_ids[]="+e+"&"}),_.each(r.emails,function(e){a+="emails[]="+encodeURIComponent(e)+"&"}),delete r.reservation_ids,delete r.emails,t.postJSON(a,r).then(function(e){i.resolve(e)},function(e){i.reject(e)}),i.promise},this.updateReservation=function(r){var i=e.defer(),a="/api/reservations/"+r.reservationId;return t.putJSON(a,r).then(function(e){i.resolve(e)},function(e){i.reject(e)}),i.promise},this.paymentAction=function(r){var i=e.defer(),a="/api/ipage/store_payments";return t.postJSON(a,r).then(function(e){i.resolve(e)},function(e){i.reject(e)}),i.promise},this.startPayment=function(r){var i=e.defer(),a="/api/cc/get_token";return t.postJSON(a,r).then(function(e){i.resolve(e)},function(e){i.reject(e)}),i.promise},this.fetchRooms=function(){var r=e.defer(),i="/api/rooms";return t.getJSON(i).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.getRateName=function(r){var i=e.defer(),a="/api/rates/"+r.id;return t.getJSON(a).then(function(e){i.resolve(e.name)},function(e){i.reject(e)}),i.promise},this.getRateDetails=function(r){var i=e.defer(),a="/api/rates/"+r.id;return t.getJSON(a).then(function(e){i.resolve(e)},function(e){i.reject(e)}),i.promise},this.getTaxDetails=function(r){var i=e.defer(),a="/api/rates/tax_information/";return t.getJSON(a,r).then(function(e){i.resolve(e)},function(e){i.reject(e)}),i.promise},this.fetchDefaultRoutingInfo=function(r){var i=e.defer(),a="/api/default_account_routings/routings_count/";return t.postJSON(a,r).then(function(e){i.resolve(e)},function(e){i.reject(e)}),i.promise},this.applyDefaultRoutingToReservation=function(r){var i=e.defer(),a="/api/default_account_routings/attach_reservation";return t.postJSON(a,r).then(function(e){i.resolve(e)},function(e){i.reject(e)}),i.promise},this.fetchResservationConfirmationPrintData=function(r){var i=e.defer(),a="/api/reservations/"+r.reservation_id+"/confirmation_email_data";return t.getJSON(a,r).then(function(e){e.data.addons_list=e.data.addons?e.data.addons.toString():"",i.resolve(e)},function(e){i.reject(e)}),i.promise},this.fetchResservationCancellationPrintData=function(r){var i=e.defer(),a="/api/reservations/"+r.reservation_id+"/cancellation_email_data";return t.getJSON(a,r).then(function(e){i.resolve(e)},function(e){i.reject(e)}),i.promise},this.updateNoRoomMove=function(r){var i=e.defer(),a="/api/reservations/"+r.reservationId+"/update_no_room_move_flag";return t.postJSON(a,r).then(function(e){i.resolve(e)},function(e){i.reject(e)}),i.promise},this.updateRestrictPost=function(r){var i=e.defer(),a="/api/reservations/"+r.reservationId+"/update_restrict_post_flag";return t.postJSON(a,r).then(function(e){i.resolve(e)},function(e){i.reject(e)}),i.promise},this.saveTaxExempt=function(r){var i=e.defer(),a="/api/reservations/save_tax_exempt";return t.postJSON(a,r).then(function(e){i.resolve(e)},function(e){i.reject(e)}),i.promise},this.checkUpsellAvailability=function(r){var i=e.defer(),a="/api/reservations/"+r+"/upsell_availability";return t.getJSON(a).then(function(e){i.resolve(e.is_upsell_available)},function(e){i.reject(e)}),i.promise},this.updateCommission=function(r){var i=e.defer(),a="/api/reservations/"+r.reservationId+"/update_commission";return t.putJSON(a,r).then(function(e){i.resolve(e)},function(e){i.reject(e)}),i.promise},this.retrieveRoomPin=function(r){var i=e.defer(),a="/staff/reservation/get_room_pin";return t.getJSON(a,r).then(function(e){i.resolve(e)},function(e){i.reject(e)}),i.promise},this.updateBookerEmail=function(r){var i=e.defer(),a="/api/reservations/"+r.reservationId+"/update_booker_email";return t.putJSON(a,r).then(function(e){i.resolve(e)},function(e){i.reject(e)}),i.promise}}]),angular.module("sntRover").service("RMFilterOptionsSrv",["$q","BaseWebSrvV2",function(e,t){this.fetchRates=function(){var r=e.defer(),i="/api/rates?per_page=100&is_active=true";return t.getJSON(i).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.fetchRateTypes=function(){var r=e.defer(),i="/api/rate_types/active";return t.getJSON(i).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.fetchCompanyCard=function(r){var i=e.defer(),a="/api/accounts";return t.getJSON(a,r).then(function(e){i.resolve(e)},function(e){i.reject(e)}),i.promise},this.fetchAllRates=function(r){var i=e.defer(),a="/api/rates?is_fully_configured=true&is_active=true";return t.getJSON(a).then(function(e){i.resolve(e)},function(e){i.reject(e)}),i.promise}}]),angular.module("sntRover").service("RVGuestCardSrv",["$http","$q","RVBaseWebSrv",function(e,t,r){this.fetchGuestPaymentData=function(e){var i=t.defer(),a="/staff/payments/payment.json?user_id="+e;return r.getJSON(a).then(function(e){i.resolve(e)},function(e){i.reject(e)}),i.promise}}]),angular.module("sntRover").service("RVHkRoomStatusSrv",["$http","$q","rvBaseWebSrvV2","$window","BaseWebSrvV2","$rootScope","$vault",function(e,t,r,i,a,o,n){this.initFilters=function(){return{dirty:!1,pickup:!1,clean:!1,inspected:!1,out_of_order:!1,out_of_service:!1,exclude_out_of_order:!1,exclude_out_of_service:!1,vacant:!1,occupied:!1,stayover:!1,not_reserved:!1,arrival:!1,arrived:!1,dueout:!1,departed:!1,dayuse:!1,queued:!1,lateCheckout:!1,pre_checkin:!1,floorFilterSingle:"",floorFilterStart:"",floorFilterEnd:"",showAllFloors:!0,filterByWorkType:"",filterByEmployeeName:"",singleRoomType:"",query:"",page:1,perPage:i.innerWidth<599?25:50}},this.currentFilters=this.initFilters(),this.isInitialLoad=!0,this.defaultViewState=null;var s=this,l=function(e){var t=this.currentFilters,r=[],i=[],a=[],n=[],s=[],l=!1,u=!1,c={page:t.page,per_page:t.perPage};return t.query?(c.query=t.query,e.assignee_id?c.assignee_id=e.assignee_id:c.all_employees_selected=!0):((e.isStandAlone||o.isStandAlone)&&(this.isInitialLoad?(this.isInitialLoad=!1,e.work_type_id&&(c.work_type_id=e.work_type_id,t.filterByWorkType=e.work_type_id),e.assignee_id?(c.assignee_id=e.assignee_id,t.filterByEmployeeName=e.assignee_id):c.all_employees_selected=!0):(t.filterByWorkType&&(c.work_type_id=t.filterByWorkType),t.filterByEmployeeName?c.assignee_id=t.filterByEmployeeName:c.all_employees_selected=!0)),t.showAllFloors||(l=t.floorFilterStart||t.floorFilterSingle,u=t.floorFilterEnd||t.floorFilterSingle),_.each(this.roomTypes,function(e){e.isSelected&&s.push(e.id)}),t.vacant&&r.push("VACANT"),t.occupied&&r.push("OCCUPIED"),t.queued&&r.push("QUEUED"),t.lateCheckout&&r.push("LATE_CHECKOUT"),t.pre_checkin&&r.push("PRE_CHECKIN"),t.stayover&&i.push("STAY_OVER"),t.not_reserved&&i.push("NOT_RESERVED"),t.arrival&&i.push("ARRIVAL"),t.arrived&&i.push("ARRIVED"),t.dayuse&&i.push("DAY_USE"),t.dueout&&i.push("DUE_OUT"),t.departed&&i.push("DEPARTED"),t.dirty&&a.push("DIRTY"),t.clean&&a.push("CLEAN"),t.inspected&&a.push("INSPECTED"),t.pickup&&a.push("PICKUP"),t.out_of_order&&a.push("OUT_OF_ORDER"),t.out_of_service&&a.push("OUT_OF_SERVICE"),t.exclude_out_of_order&&n.push("OUT_OF_ORDER"),t.exclude_out_of_service&&n.push("OUT_OF_SERVICE"),r.length&&(c.reservation_status=r),i.length&&(c.front_office_status=i),a.length&&(c.house_keeping_status=a),n.length&&(c.exclude_service_status=n),s.length&&(c.room_type_ids=s),l&&(c.floor_start=l),u&&(c.floor_end=u)),c}.bind(this),u={};this.fetchRoomListPost=function(e){var r=t.defer(),i="/house/search.json",o=l(e);return a.postJSON(i,o).then(function(e){u=e.data,u.summary=e.data.summary;var t=n.get("LAST_ROOM_SERVICE");t=t?JSON.parse(t):{rooms:[],status:{}};var i,a;for(i=0,a=u.rooms.length;i<a;i++){var o=u.rooms[i];o.description=o.hk_status.description,o.is_occupied="true"===o.is_occupied,o.is_vip="true"===o.is_vip,s.setRoomStatusClass(o),s.setReservationStatusClass(o),o.timeOrIn=m(o),o.timeOrOut=v(o),o.assigned_staff=h(o),o.ooOsTitle=f(o),t.rooms.length&&_.indexOf(t.rooms,o.id)>-1&&(o.service_status=$.extend({},o.service_status,t.status))}r.resolve(u)},function(e){r.reject(e)}),r.promise},this.fetchPayload=function(e){function r(e){d=e;var t={date:o.businessDate,employee_ids:[o.userId]};o.isMaintenanceStaff?this.fetchWorkAssignments(t).then(i.bind(this)):a.call(this)}function i(e){var t=e.employees.length&&e.employees[0]||null,r=t&&t.room_tasks&&t.room_tasks.length||!1;r?u=o.userId:(u=!1,l=!1),p=e,a.call(this)}function a(){l&&(c.work_type_id=l),u&&(c.assignee_id=u),_.extend(e,c,{initialLoad:!0}),this.fetchRoomListPost(e).then(n,function(e){s.reject(e)})}function n(e){var t={roomList:e,workTypes:d,assignments:p};s.resolve(t)}var s=t.defer(),e=e,l=!1,u=!1,c={},d={},p={};return e.isStandAlone||o.isStandAlone?this.fetchWorkTypes().then(r.bind(this)):a.call(this),s.promise};var c=[];this.fetchFloors=function(){var e=t.defer(),r="/api/floors.json";return c.length?e.resolve(c):a.getJSON(r).then(function(t){c=t.floors,e.resolve(c)},function(t){e.reject(t)}),e.promise},this.roomTypes=[],this.fetchRoomTypes=function(){var e="api/room_types?exclude_pseudo=true",r=t.defer();return s.roomTypes.length?r.resolve(s.roomTypes):a.getJSON(e).then(function(e){this.roomTypes=e.results,angular.forEach(this.roomTypes,function(e,t){e.isSelected=!1}),r.resolve(this.roomTypes)}.bind(this),function(e){r.reject(e)}),r.promise},this.resetRoomTypes=function(){return angular.forEach(this.roomTypes,function(e,t){e.isSelected=!1}),this.roomTypes},this.allRoomTypes=[],this.fetchAllRoomTypes=function(){var e="api/room_types",r=t.defer();return s.allRoomTypes.length?r.resolve(s.allRoomTypes):a.getJSON(e).then(function(e){this.allRoomTypes=e.results,angular.forEach(this.allRoomTypes,function(e,t){e.isSelected=!1}),r.resolve(this.allRoomTypes)}.bind(this),function(e){r.reject(e)}),r.promise};var d=[];this.fetchHKEmps=function(e){var r="/api/work_statistics/employees_list",i=t.defer();return d.length?i.resolve(d):a.getJSON(r,e).then(function(e){d=e.results,i.resolve(d)},function(e){i.reject(e)}),i.promise},this.checkRoomAssigned=function(e){var r="/house/search.json",i=t.defer();return a.getJSON(r,e).then(function(e){i.resolve(e)},function(e){i.reject(e)}),i.promise},this.fetchActiveWorksheetEmp=function(){var e="/api/work_sheets/active",r=t.defer();return a.getJSON(e).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise};var p=[];this.fetchWorkTypes=function(){var e=t.defer(),r="api/work_types";return p.length?e.resolve(p):a.getJSON(r).then(function(t){p=t.results,e.resolve(p)},function(t){e.reject(t)}),e.promise},this.fetchWorkAssignments=function(e){var r=t.defer(),i="api/work_assignments/assigned_rooms";return a.postJSON(i,e).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.fetchHkStatusList=function(){var e=t.defer(),r="api/rooms/hk_status_list";return a.getJSON(r).then(function(t){e.resolve(t)},function(t){e.reject(t)}),e.promise},this.putHkStatusChange=function(e){var r=t.defer(),i="house/mass_change_hk_status";return a.putJSON(i,e).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.fetchAllRoomIDs=function(){var e=t.defer(),r="/house/room_ids_list";return a.getJSON(r).then(function(t){e.resolve(t.room_ids)},function(t){e.reject(t)}),e.promise},this.toggleFilter=function(e){this.currentFilters[e]=!this.currentFilters[e]},this.isListEmpty=function(){return!(u&&u.rooms&&u.rooms.length)},this.setRoomStatusClass=function(e){var t;if(t=e.hasOwnProperty("service_status")?"OUT_OF_SERVICE"===e.service_status.value||"OUT_OF_ORDER"===e.service_status.value:"OO"===e.hk_status.value||"OS"===e.hk_status.value||2===e.room_reservation_hk_status||3===e.room_reservation_hk_status,t||"true"!==u.checkin_inspected_only){if(!t){if("CLEAN"===e.hk_status.value||"INSPECTED"===e.hk_status.value)return void(e.roomStatusClass="clean");if("PICKUP"===e.hk_status.value)return void(e.roomStatusClass="pickup")}}else{if("INSPECTED"===e.hk_status.value)return void(e.roomStatusClass="clean");if("CLEAN"===e.hk_status.value||"PICKUP"===e.hk_status.value)return void(e.roomStatusClass="pickup")}if("DIRTY"===e.hk_status.value&&!t)return void(e.roomStatusClass="dirty");if("DO_NOT_DISTURB"===e.hk_status.value)return void(e.roomStatusClass="dnd");if(t){if(e.roomStatusClass="out",e.hk_status.oo_status){if("true"===u.checkin_inspected_only){if("INSPECTED"===e.hk_status.oo_status)return void(e.roomStatusClassWithOO="clean");if("CLEAN"===e.hk_status.oo_status||"PICKUP"===e.hk_status.oo_status)return void(e.roomStatusClassWithOO="pickup")}else{if("CLEAN"===e.hk_status.oo_status||"INSPECTED"===e.hk_status.oo_status)return void(e.roomStatusClassWithOO="clean");if("PICKUP"===e.hk_status.oo_status)return void(e.roomStatusClassWithOO="pickup")}if("DIRTY"===e.hk_status.oo_status)return void(e.roomStatusClassWithOO="dirty")}}else;},this.setReservationStatusClass=function(e){switch(e.room_reservation_status){case"Due out":e.leaveStatusClass="check-out",e.enterStatusClass="no-show";break;case"Stayover":e.leaveStatusClass="inhouse",e.enterStatusClass="no-show";break;case"Departed":e.leaveStatusClass="check-out",e.enterStatusClass="no-show";break;case"Arrival":e.leaveStatusClass="no-show",e.enterStatusClass="check-in";break;case"Arrived":e.leaveStatusClass="no-show",e.enterStatusClass="check-in";break;case"Due out / Arrival":e.leaveStatusClass="check-out",e.enterStatusClass="check-in";break;case"Departed / Arrival":e.leaveStatusClass="check-out",e.enterStatusClass="check-in";break;case"Arrived / Departed":e.leaveStatusClass="check-out",e.enterStatusClass="check-in";break;case"Due out / Departed":e.leaveStatusClass="check-out",e.enterStatusClass="check-out";break;case"Arrived / Day use / Due out":e.leaveStatusClass="check-out",e.enterStatusClass="no-show";break;case"Arrived / Day use / Due out / Departed":e.leaveStatusClass="check-out",e.enterStatusClass="check-out";break;default:e.leaveStatusClass="no-show",e.enterStatusClass="no-show"}"true"===e.is_late_checkout&&(e.leaveStatusClass="late-check-out")},this.setRoomStatus=function(e,t,r){var i=_.find(u.rooms,function(t){return parseInt(t.id)===e});i[t]=r,i.ooOsTitle=f(i),this.setRoomStatusClass(i)},this.setWorkStatus=function(e,t){var r=_.find(u.rooms,function(t){return parseInt(t.id)===e});r.hk_status.description=t.description,r.description=r.hk_status.description,r.hk_status.value=t.value,this.setRoomStatusClass(r)};var m=function(e){return e.room_reservation_status.indexOf("Arrived")>=0&&!(e.room_reservation_status.indexOf("Day use")>=0)?"IN":e.room_reservation_status.indexOf("Arrival")>=0?e.arrival_time:""},v=function(e){return e.room_reservation_status.indexOf("Departed")>=0?"OUT":e.room_reservation_status.indexOf("Due out")>=0?"true"===e.is_late_checkout?e.late_checkout_time:e.departure_time:""},h=function(e){if(!o.isStandAlone)return!1;var t={name:"Unassigned",class:"unassigned"};return e.canAssign=!0,e.room_tasks&&e.room_tasks.length&&(e.canAssign=!1,t.class="assigned",_.unique(_.pluck(_.pluck(e.room_tasks,"assignee_maid"),"id")).length>1?t.name="Multiple Assignees":t.name=e.room_tasks[0].assignee_maid.name),t};this.calculateAssignedStaff=h;var f=function(e){return e.hasOwnProperty("service_status")?"OUT_OF_SERVICE"===e.service_status.value?"Out of Service":"OUT_OF_ORDER"===e.service_status.value?"Out of Order":"":o.isStandAlone?2===e.room_reservation_hk_status?"Out of Service":3===e.room_reservation_hk_status&&"Out of Order":"OS"===e.hk_status.value?"Out of Service":"OO"===e.hk_status.value&&"Out of Order"}}]),angular.module("sntRover").service("RVHkRoomDetailsSrv",["$http","$q","rvBaseWebSrvV2","RVBaseWebSrv","$window","$filter","$vault",function(e,t,r,i,a,o,n){var s=this,l=200,u=function(e){var t=function(e){return 2===e?"OUT_OF_SERVICE":3===e?"OUT_OF_ORDER":"IN_SERVICE"};n.setOnce("LAST_ROOM_SERVICE",JSON.stringify({rooms:[].concat(e.room_id),status:{to_date:e.to_date,end_time:e.end_time,id:e.room_service_status_id,value:t(e.room_service_status_id)}}))};s.roomDetails={},s.fetch=function(r,i){var o=t.defer(),n="/house/room/"+r+".json";return e.get(n).then(function(e){var t=e.data;"success"===t.status?(s.roomDetails=t.data.room_details,o.resolve(s.roomDetails)):o.reject(t)},function(e){var t=e.data,r=e.status;401===r?a.location.href="/house/logout":o.reject(t)}),o.promise},s.updateHKStatus=function(r){var i=t.defer(),o="/house/change_house_keeping_status.json";return e({url:o,method:"POST",data:r}).then(function(e){var t=e.data;"success"===t.status||e.status===l?i.resolve(t.data):i.reject(t)},function(e){var t=e.data,r=e.status;401===r?a.location.href="/house/logout":i.reject(t)}),i.promise};var c=[];s.fetchAllServiceStatus=function(){var e=t.defer(),i="api/room_services/status_list";return c.length?e.resolve(c):r.getJSON(i).then(function(t){c=t.results,e.resolve(c)},function(t){e.reject(t)}),e.promise};var d=[];s.fetchMaintenanceReasons=function(){var e=t.defer(),i="api/maintenance_reasons";return d.length?e.resolve(d):r.getJSON(i).then(function(t){d=t.maintenance_reasons,e.resolve(d)},function(t){e.reject(t)}),e.promise},s.getRoomLog=function(e){var i=t.defer(),a="/api/room_actions/"+e.id+"/?page="+e.page+"&per_page="+e.per_page;return r.getJSON(a).then(function(e){i.resolve(e)},function(e){i.reject(e)}),i.promise},s.getRoomServiceStatus=function(e){var i=t.defer(),a="/api/room_services/service_info.json?",n=tzIndependentDate(e.from_date),s=n.getFullYear(),l=n.getMonth(),u=tzIndependentDate(new Date(s,l+2,1));return e.to_date=o("date")(u,"yyyy-MM-dd"),r.getJSON(a,e).then(function(e){i.resolve(e)},function(e){i.reject(e)}),i.promise},s.postRoomServiceStatus=function(e){var i=t.defer(),a="api/room_services";return r.postJSON(a,e).then(function(t){u(e),i.resolve(t)},function(e){i.reject(e)}),i.promise},s.checkWhetherRoomStatusChangePossible=function(e){var i=t.defer(),a="/api/room_services/check_room_locked_or_assigned";return r.postJSON(a,e).then(function(e){i.resolve(e)},function(e){i.reject(e)}),i.promise},s.postCheckOutReservation=function(e){var i=t.defer(),a="api/reservations/"+e.id+"/checkout_from_house_keeping";return r.postJSON(a,e).then(function(e){i.resolve(e)},function(e){i.reject(e)}),i.promise},s.putRoomServiceStatus=function(e){var i=t.defer(),a="api/room_services/"+e.room_id;return r.putJSON(a,e).then(function(e){i.resolve(e)},function(e){i.reject(e)}),i.promise},s.putRoomInService=function(e){var i=t.defer(),a="api/room_services/"+e.room_id,o={room_service_status_id:e.inServiceID,from_date:e.from_date,to_date:e.to_date};return r.putJSON(a,o).then(function(e){i.resolve(e)},function(e){i.reject(e)}),i.promise};var p=[];s.getWorkTypes=function(){var e=t.defer(),i="api/work_types";return p.length?e.resolve(p):r.getJSON(i).then(function(t){p=t.results,e.resolve(p)},function(t){e.reject(t)}),e.promise},s.postRecordTime=function(e){var i=t.defer(),a="/api/work_assignments/record_time";return r.postJSON(a,e).then(function(e){i.resolve(e)},function(e){i.reject(e)}),i.promise},s.fetchRoomStatus=function(e){var i={from_date:o("date")(tzIndependentDate(new Date(e.year,e.month-1,1)),"yyyy-MM-dd"),to_date:o("date")(tzIndependentDate(new Date(e.year,e.month+1,1)),"yyyy-MM-dd"),room_id:e.room_id},a=t.defer(),n="/api/room_services/service_info.json?";return r.getJSON(n,i).then(function(e){a.resolve({service_status:e.service_status})},function(e){a.reject(e)}),a.promise},s.changeHouseKeepingStatus=function(e){var i=t.defer(),a="house/change_fo_status.json";return r.postJSON(a,e).then(function(e){i.resolve(e)},function(e){i.reject(e)}),i.promise}}]),angular.module("sntRover").service("rvUtilSrv",["$filter","$rootScope",function(e,t){var r=this,i=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];this.deepCopy=function(e){return JSON.parse(JSON.stringify(e))},this.escapeNull=function(e,t){var r="";"undefined"!=typeof t&&null!==t&&(r=t);var i=null===e||"undefined"==typeof e?r:e;return i},this.isEmpty=function(e){return"number"==typeof e&&(e=e.toString()),""===this.escapeNull(e).trim()},this.stringify=function(e){return JSON.stringify(e)},this.getDatesBetweenTwoDates=function(e,t){for(var r=[];e<=t;)r.push(new Date(e)),e.setDate(e.getDate()+1);return r},this.getFormattedDatesBetweenTwoDates=function(t,r){for(var i=[],a=new Date(t);a<=r;)i.push(e("date")(a,"yyyy-MM-dd")),a.setDate(a.getDate()+1);return i},this.getDayBetweenTwoDates=function(e,t){for(var r=[],i=new Date(e);i<=t;)r.push(i.getDate()),i.setDate(i.getDate()+1);return r},this.getMonthFromDateString=function(e){return new Date(e).getMonth()},this.toMilliSecond=function(e){var t=typeof e,r="";switch(t){case"string":r=new tzIndependentDate(e);break;case"object":r=e.getTime()}return r},this.addOneDay=function(e){return this.toMilliSecond(e)+864e5},this.getListOfKeyValuesFromAnArray=function(e,t){var r,i=[];return _.each(e,function(e){r={},_.each(t,function(t){r[t]=e[t]}),i.push(r)}),i},this.isNumeric=function(e){return!jQuery.isArray(e)&&e-parseFloat(e)+1>=0},this.convertToInteger=function(e,t){return t=t?t:0,r.isNumeric(e)?parseInt(e):t},this.convertToDouble=function(e,t){return t=t?t:0,r.isNumeric(e)?parseFloat(e):t},this.get_date_from_date_picker=function(e,t){return"undefined"==typeof t&&(t="/"),e.selectedYear+t+(e.selectedMonth+1)+t+e.selectedDay},this.getFirstDayOfNextMonth=function(e){var e=new tzIndependentDate(e),t=e.getFullYear(),r=e.getMonth();return tzIndependentDate(new Date(t,r+1,1))},this.getListForTimeSelector=function(e,t){var r=[],i=0,a=0,o=0,n=null,s="",l="";for(_.isUndefined(t)&&(t=12),_.isUndefined(e)&&(e=15);i<1440;i+=e)a=Math.floor(i/60),o=i%60,o<10&&(o="0"+o),n=a%24<12?"AM":"PM",s=(a<10?"0"+a:a)+":"+o,a%=t,(0===a&&12===t||0===a&&24===t&&i<=60)&&(a=12),l=a+":"+o,12===t&&(l+=" "+n),r.push({value:s,text:l});return r},this.checkDevice={any:function(){return!!navigator.userAgent.match(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i)},iOS:function(){return!!navigator.userAgent.match(/iPhone|iPad|iPod/i)},android:function(){return navigator.userAgent.match(/Android/i)}},this.roundToNextQuarter=function(e,t){var r=(t>45?++e%24:e).toString(),i=(15*((t+14)/15|0)%60).toString();return(2===r.length?r:"0"+r)+":"+(2===i.length?i:"0"+i)},this.isEmailValid=function(e){return e=_.isUndefined(e)||_.isNull(e)?"":e,e=e.replace(/\s+/g,""),/^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/.test(e)},this.retrieveFeatureDetails=function(e,t){var r=_.find(e,function(e){return e.feature_name===t});return r},this.generateTimeDuration=function(e,t,r){var i=15,a=0,o=1440-i,n=["AM","PM"],s=[],l="",u="",c="",d="",p={},r=r||0;e&&(a=60*e.split(":")[0]+1*e.split(":")[1]+1*r),t&&(o=60*t.split(":")[0]+1*t.split(":")[1]+1*r);for(var m=0;a<=o;m++)c=Math.floor(a/60),d=a%60,l=("00"===("0"+c%12).slice(-2)?"12":("0"+c%12).slice(-2))+":"+("0"+d).slice(-2)+" "+n[Math.floor(c/12)],u=("0"+c).slice(-2)+":"+("0"+d).slice(-2),p={12:l,24:u},s.push(p),a+=i;return s},this.extractHhMmAmPm=function(e){var t=parseInt(e.split(" ")[0].split(":")[0]),r=t>=12?"PM":"AM";return{ampm:r,hh:"00"===("0"+t%12).slice(-2)?"12":("0"+t%12).slice(-2),mm:e.split(" ")[0].split(":")[1]}},this.convertTimeHhMmAmPmTo24=function(e){var t=e.hh,r=e.mm,i=e.ampm;return"12"===t&&(t="00"),"PM"===i&&(t=parseInt(t,10)+12),t+":"+r},this.getDiaryMode=function(){var e="FULL",r=t.hotelDiaryConfig;return r.hourlyRatesForDayUseEnabled?"LIMITED"===r.mode&&(e="DAYUSE"):e="NIGHTLY",e},this.isWeekendDay=function(e,t){return _.contains(e,i[t.getDay()])},this.countryFlagLangMap={EN:"us",ES:"es",DE:"de",NL:"nl",FR:"fr",IT:"it"},this.translatableLangs=["EN","ES","FR"],this.langNameTranslations={EN:"English",DE:"Deutsch",FR:"Français",ES:"Español",JA:"日本",ZH:"中国人",NL:"Nederlands",IT:"Italiano",FI:"Suomalainen",SV:"Svenska",NN:"Norsk",DA:"Dansk",IS:"Íslensku",TR:"Türk",AR:"عربي",PT:"Português",PL:"Polskie",HU:"Magyar",BG:"български",TL:"Tagalog",CS:"Čeština",SK:"Slovensky",ET:"Eestlane",RO:"Română",UK:"Українська",SL:"Slovenščina",HR:"Hrvatski",SR:"Српски",EL:"Ελληνικά",TH:"ไทย",YUE:"粵語",CMN:"普通话",ID:"Indonesia",VI:"Tiếng Việt",KO:"한국인",HI:"हिंदी",RU:"Pусский",LV:"Latvietis",MS:"Melayu"}}]),sntRover.controller("RVDiaryConfirmationCtrl",["$scope","$rootScope","$state","$vault","ngDialog","rvDiarySrv","rvDiaryUtil","$filter","$timeout","RVReservationBaseSearchSrv",function(e,t,r,i,a,o,n,s,l,u){BaseCtrl.call(this,e),e.title=e.selectedReservations.length>1?"these rooms":"this room",e.initSelections=function(){!function(){var r=function(e,t){var r=new Date(t.arrival),i=new Date(t.departure);return e(r.toComponents(),i.toComponents())},i=function(e,r){var i=tzIndependentDate(e.date.toDateString().replace(/-/g,"/")),i=s("date")(i,t.fullDateFullMonthYear),a=tzIndependentDate(r.date.toDateString().replace(/-/g,"/")),a=s("date")(a,t.fullDateFullMonthYear);
return{arrival_time:e.time.toString(!0),arrival_date:i,departure_time:r.time.toString(!0),departure_date:a}},a=function(e,t){return{arrival_date:e.date.year+"/"+(e.date.month+1)+"/"+e.date.day,arrival_time:e.time.toReservationFormat(!1),departure_date:t.date.year+"/"+(t.date.month+1)+"/"+t.date.day,departure_time:t.time.toReservationFormat(!1)}},l=e.selectedReservations.length>0?e.selectedReservations[0].occupancy:void 0;if(e.selection={rooms:[]},e.vaultSelections={rooms:[]},l){e.reservationsSettings=o.ArrivalFromCreateReservation(),_.extend(e.vaultSelections,r(a,l)),_.extend(e.selection,r(i,l));var u;_.each(e.selectedReservations,function(t,r,i){var a={room_id:t.room.id,room_no:t.room.room_no,room_type:t.room.room_type_name,amount:parseFloat(t.occupancy.amount).toFixed(2),rateId:t.occupancy.rate_id,numAdults:e.reservationsSettings?e.reservationsSettings.adults:1,numChildren:e.reservationsSettings?e.reservationsSettings.children:0,numInfants:e.reservationsSettings?e.reservationsSettings.infants:0},o=n.shallowCopy({},a);"Corporate"===e.gridProps.filter.rate_type&&(u=e.gridProps.filter.rate.type,"COMPANY"===u&&(a.company_card_id=e.gridProps.filter.rate.id),"TRAVELAGENT"===u&&(a.travel_agent_id=e.gridProps.filter.rate.id),a.contract_id=e.gridProps.contractId),e.vaultSelections.rooms.push(a),o.amount=e.currencySymbol+" "+o.amount,e.selection.rooms.push(o)})}}()},e.initSelections(),e.closeWithAnimation=function(){t.modalOpened=!1,l(function(){a.close()},300)},e.selectAdditional=function(){e.closeWithAnimation()},e.removeSelectedOccupancy=function(t){var r=e.selectedReservations.splice(t,1);r[0].occupancy.selected=!1,0===e.selectedReservations.length?a.close():this.initSelections(),e.renderGrid()},e.routeToSummary=function(){var i=function(i){if(e.saveToVault("temporaryReservationDataFromDiaryScreen",e.vaultSelections),!t.isHourlyRateOn&&t.isAddonOn&&i&&"FULL"!==t.hotelDiaryConfig.mode){var a=e.vaultSelections.arrival_date,o=e.vaultSelections.departure_date;r.go("rover.reservation.staycard.mainCard.addons",{from_date:a,to_date:o,reservation:"HOURLY"})}else r.go("rover.reservation.staycard.mainCard.summaryAndConfirm",{reservation:"HOURLY"});e.closeWithAnimation()},a=function(t){e.errorMessage=t,e.closeWithAnimation()},o={};o.from_date=e.vaultSelections.arrival_date,o.to_date=e.vaultSelections.departure_date,o.is_active=!0,e.invokeApi(u.hasAnyConfiguredAddons,o,i,a)},e.saveToVault=function(e,t){return i.set(e,JSON.stringify(t)),i.get(e)||!1},e.readFromVault=function(e){return!!i.get(e)&&JSON.parse(i.get(e))},e.dateToMs=function(e){return"[object Date]"===Object.prototype.toString.apply(e)&&e.getTime()},e.msToDate=function(e){return"[object Date]"===Object.prototype.toString.apply(new Date(e))&&new Date(e)},e.cancelSelection=function(){var t=e.selectedReservations.pop();t&&(t.occupancy.selected=!1),e.closeWithAnimation(),e.renderGrid()}}]),angular.module("sntRover").controller("rvDiaryCtrl",["$scope","$rootScope","$state","$stateParams","$filter","$window","ngDialog","RMFilterOptionsSrv","RVGuestCardSrv","rvDiarySrv","rvDiaryMetadata","rvDiaryUtil","payload","propertyTime","$vault","RVReservationBaseSearchSrv","$timeout","RVReservationSummarySrv","baseSearchData","$interval","sntActivity","rvHouseEventsListSrv","houseEventsCount",function(e,t,r,i,a,o,n,s,l,u,c,d,p,m,v,h,f,g,y,D,R,S,M){function w(e){var t=new Date(e),r=new Date(e),i=23,a=59,o=59,n=36e5;return r.setDate(r.getDate()+1),r.setHours(i,a,o),t.setHours(0,0,0,0),Math.ceil(Math.abs(r-t)/n)}function I(e){}function P(t,r){var i,a=!0,o=(e.gridProps.filter.room_type,c.occupancy.start_date),n=c.occupancy.maintenance,s=c.occupancy.end_date,l=c.occupancy.id;return t&&t.forEach(function(e,t){var u=e[s]+e[n],c=r[s]+r[n];if(e[l]!==r[l]&&(r[o]>=e[o]&&r[o]<=u||e[o]>=r[o]&&u<=c||r[o]>=e[o]&&c<=u||c>=e[o]&&c<=u))return i=e,void(a=!1)}),[a,i]}e.$emit("showLoader"),BaseCtrl.call(this,e);var b=this;e.heading=a("translate")("DIARY_RESERVATIONS"),e.$emit("updateRoverLeftMenu","diaryReservation"),e.setTitle(a("translate")("DIARY")),t.setNextState={data:{isFromDiary:!0,useCache:!0}},e.addListener("UNASSIGNED_RESERVATION_SELECTED",function(t,r,i){var a,o,n=se(r.arrival_time,r.arrival_date,r.stay_span,r.room_type_id),s=!0,l=e.gridProps.unassignedRoomList;n.reservation_id=r.reservationId,e.hideRoomUnAssignButton=!0,e.showSaveChangesAfterEditing=!1,a=function(t,r){if(t.length){var a=t[0],o=e.gridProps.filter;o.arrival_time=new Date(a.arrival).toTimeString().substring(0,5),o.room_type=_.findWhere(o.room_types,{id:a.room_type_id})}e.gridProps.edit.originalItem=d.copyReservation(i),e.gridProps.currentResizeItem=d.copyReservation(i),ee(t,r,s)},o={params:n,successCallBack:a,failureCallBack:te,successCallBackParameters:n},e.clearAvailability(),e.resetEdit(),e.renderGrid(),e.callAPI(u.Availability,o),l.dragData=r}),e.showSaveChangesAfterEditing=!1,e.hideMoveRoomButton=!1;var O=function(e,t){function r(){var e=_.find(l,function(e){return e===s});return!!e}function i(){var e=!!_.find(u,function(e){return e===s});return!!e}var a=t.useOriginal(e.getPrevStateTitle()),o=t.getOriginState(),n=e.getPrevStateTitle(),s=e.getPrevStateName(),l=["rover.reservation.search","rover.reservation.staycard.reservationcard.reservationdetails"],u=["rover.search","rover.financials.journal","rover.ratemanager","rover.companycardsearch","rover.housekeeping.roomStatus"],c={title:"DASHBOARD",name:"rover.dashboard",param:{}};a?e.setPrevState={title:o.title,name:o.name,param:o.param}:r()?e.setPrevState={title:n}:i()?e.setPrevState={title:n,name:s,param:{}}:e.setPrevState=angular.copy(c)};"NIGHTLY_DIARY"!==i.origin&&O(t,t.diaryState),e.addListener("setDiaryBackButton",function(){O(t,t.diaryState)}),e.adj_property_date_time=d.correctTime(m.hotel_time.date,m);var A=function(e){return a("date")(e,t.dateFormatForAPI)},T=function(e,t){return e instanceof Object||(e=new Date(e)),t instanceof Object||(t=new Date(t)),e.getFullYear()!==t.getFullYear()||e.getMonth()!==t.getMonth()||e.getDate()!==t.getDate()};e.showHouseEventsListPopup=function(r){r&&(e.selectedEventDisplayDate=a("date")(e.gridProps.filter.arrival_date,t.dateFormatForAPI),n.open({template:"/assets/partials/popups/rvHouseEventsListPopup.html",scope:e,controller:"rvHouseEventsListPopupCtrl",className:"ngdialog-theme-default",closeByDocument:!1,closeByEscape:!0}))};var C=function(r,i){var o=e.gridProps.edit.active,n=new Date(r);m.hotel_time.date=n;var s=function(){if(!o)return e.gridProps.filter.arrival_date=n,e.$$phase||e.$apply(),!0;if(o){var t=d.copyReservation(e.gridProps.currentResizeItem);if("reserved"!==t.reservation_status&&"check-in"!==t.reservation_status)return e.message=["ONLY FUTURE/CHECKING-IN RESERVATION IS ALLOWED TO MOVE"],void H();he(t,n)}},l=function(r){e.gridProps.eventsCount=r[a("date")(n,t.dateFormatForAPI)],s()};e.callAPI(S.fetchHouseEventsCount,{params:{start_date:a("date")(n,t.dateFormatForAPI),end_date:a("date")(n,t.dateFormatForAPI)},onSuccess:l,onFailure:s})},E=function(e,t,r,i){u.isReservationMovingFromOneDateToAnother=!0,u.movingReservationData.reservation=e,u.movingReservationData.room_to=r,u.movingReservationData.originalRoom=i,u.movingReservationData.originalReservation=t},x=function(){u.isReservationMovingFromOneDateToAnother=!1,u.movingReservationData.reservation=void 0,u.movingReservationData.room_to=void 0,u.movingReservationData.originalRoom=void 0,u.movingReservationData.originalReservation=void 0};x();var k=new tzIndependentDate(t.businessDate);k.setDate(k.getDate()-1),e.dateOptions={showOn:"button",numberOfMonths:1,onSelect:C},_.extend(e,p),e.data=e.room,e.stats=e.availability_count,e.selectedReservations=[],e.callBackAfterClosingMessagePopUp=void 0;var z=!1,N=u.ArrivalFromCreateReservation(),L={};if(N)z=!0;else{var F=p.display.x_n instanceof Date?p.display.x_n.toComponents().date.toDateString().replace(/-/g,"/"):p.display.x_n;L=d.correctTime(F,m)}e.showRoomStatusAndServiceUpdatePopup=function(r){t.isStandAlone&&n.open({template:"/assets/partials/diary/rvDiaryUpdateRoomStatusAndServicePopup.html",className:"ngdialog-theme-default",closeByDocument:!0,controller:"rvDiaryRoomStatusAndServiceUpdatePopupCtrl",data:r,scope:e})},this.getHouseEventsCount=function(){var e=0;return M&&!_.isEmpty(M)&&(e=M[_.keys(M)[0]]),e},e.gridProps={meta:c,data:e.data,stats:e.stats,viewport:{hours:24,width:angular.element(o).width()-120,height:angular.element(o).height()-180,row_header_right:184,timeline_header_height:60,timeline_height:40,timeline_occupancy_height:20,timeline_header_bottom:180,element:function(){return $(".diary-grid")}},display:{x_offset:z?N.start_date-72e5:L.start_date-72e5,x_0:void 0,x_origin:z?N.start_date:L.start_date,x_n:z?N.__start_date:L.__start_date,x_n_time:z?N.__start_date.toComponents().time.convertToReferenceInterval(15):L.__start_date.toComponents().time.convertToReferenceInterval(15),x_p:p.display.x_p.getTime(),x_p_time:p.display.x_p_time?p.display.x_p_time:p.display.x_p.toComponents().time.convertToReferenceInterval(15),width:void 0,height:void 0,hours:w(p.display.x_n),row_height:28,row_height_margin:2,intervals_per_hour:4,ms_15:9e5,ms_hr:36e5,px_per_ms:void 0,px_per_int:void 0,px_per_hr:void 0,currency_symbol:t.currencySymbol,min_hours:z?N.minHours:p.display.min_hours,property_date_time:e.adj_property_date_time},availability:{resize:{current_arrival_time:null,current_departure_time:null,last_arrival_time:null,last_departure_time:null},drag:{lastRoom:null}},edit:{active:!1,passive:!1,mode:void 0,resizing:{enabled:!1},dragging:{enabled:!1,direction:1},originalItem:void 0,originalRowItem:void 0,currentResizeItem:void 0,currentResizeItemRow:void 0,reset_scroll:void 0},filter:{arrival_date:p.display.x_n,arrival_times:Array.prototype.slice.call(p.filter.arrival_times),arrival_time:z?p.filter.arrival_time:L.arrival_time,reservation_format:"h",range:12,rate_type:p.filter.rate_type,rate:void 0,room_type:p.filter.room_type_id?u.data_Store.get("_room_type.values.id")[p.filter.room_type_id]:void 0,room_types:p.filter.room_type,show_all_rooms:"off",toggleHoursDays:function(){this.reservation_format="h"===this.reservation_format?"d":"h","d"===this.reservation_format&&r.go("rover.reservation.search",{fromState:"DIARY"})},toggleRates:function(){e.openRateTypeChoosingBox=!e.openRateTypeChoosingBox},toggleRange:function(){var t=12===e.gridProps.viewport.hours;e.gridProps.viewport=_.extend({},e.gridProps.viewport),e.gridProps.display=d.deepCopy(e.gridProps.display),e.gridProps.viewport.hours=t?24:12,e.gridProps.display.row_height=t?24:60,e.gridProps.display.row_height_margin=t?0:5,e.gridProps.display.width=e.gridProps.display.hours/e.gridProps.viewport.hours*e.gridProps.viewport.width,e.gridProps.display.height=e.gridProps.display.row_height+e.gridProps.display.row_height_margin,e.gridProps.display.px_per_hr=e.gridProps.viewport.width/e.gridProps.viewport.hours,e.gridProps.display.px_per_int=e.gridProps.display.px_per_hr/e.gridProps.display.intervals_per_hour,e.gridProps.display.px_per_ms=e.gridProps.display.px_per_int/e.gridProps.display.ms_15,e.renderGrid()}},unassignedRoomList:{open:!1,data:[],dragData:{},isItemSelected:!1,selectedReservations:e.selectedReservations,isUnassignedPresent:!1,unassignedCount:0,reset:function(){this.open&&(e.$broadcast("CLOSE_UD_RESERVATION_PANEL"),this.data=[],this.open=!1,this.dragData={})},fetchCount:function(){var t=this,r={date:A(e.gridProps.filter.arrival_date)},i=function(r){t.unassignedCount=r,t.isUnassignedPresent=r>0,e.renderGrid(),e.$emit("hideLoader")},a=function(t){e.$emit("hideLoader"),e.errorMessage=t};e.invokeApi(u.fetchUnassignedRoomListCount,r,i,a)},dropReservation:function(t){this.dragData.reservationId&&e.saveReservationOnDrop(this.dragData,t)},dragEnded:function(){e.clearAvailability(),e.resetEdit(),e.renderGrid()}},reservatonFlow:{cannotResizeDuration:function(){return e.selectedReservations.length>0},showNotAllowedMsg:function(){e.message=["Cannot change duration - A reservation for the current duration has already been selected"],H()}},autoAssignData:{lockUI:!1,status:"",statusText:"",statusDescription:"",statusClass:"",processDate:""},eventsCount:b.getHouseEventsCount()};var V,U=function(){e.gridProps.autoAssignData={lockUI:!1,status:"",statusText:"",statusDescription:"",statusClass:"",processDate:""}},j=function(t){switch(e.gridProps.autoAssignData.lockUI=t.is_diary_locked,e.gridProps.autoAssignData.status=t.auto_room_assignment_status,e.gridProps.autoAssignData.processDate=t.process_date,t.is_diary_locked&&(e.gridProps.edit.active||e.gridProps.unassignedRoomList.isItemSelected)&&e.editCancel(),t.auto_room_assignment_status){case"pending":e.gridProps.autoAssignData.statusText="Room auto assignment in progress",e.gridProps.autoAssignData.statusDescription="Diary is locked until process is completed",e.gridProps.autoAssignData.statusClass="";break;case"failed":e.gridProps.autoAssignData.statusText="Room auto assignment failed",e.gridProps.autoAssignData.statusDescription="0 Rooms Assigned",e.gridProps.autoAssignData.statusClass="failed";break;case"partial":e.gridProps.autoAssignData.statusText="Room auto assignment completed",e.gridProps.autoAssignData.statusDescription="Some Reservations Remain Unassigned",e.gridProps.autoAssignData.statusClass="semi-completed";break;case"completed":t.is_diary_locked?(e.gridProps.autoAssignData.statusText="Room auto assignment completed",e.gridProps.autoAssignData.statusDescription="Rooms Assigned to All Reservations",e.gridProps.autoAssignData.statusClass="completed"):(e.gridProps.autoAssignData.statusText="",e.gridProps.autoAssignData.statusDescription="",e.gridProps.autoAssignData.statusClass="")}};e.refreshAutoAssignStatus=function(){u.fetchAutoAssignStatus().then(j)},e.unlockRoomDiary=function(){var t={successCallBack:function(t){t.is_diary_locked||(U(),e.gridProps.unassignedRoomList.reset(),e.gridProps.unassignedRoomList.fetchCount(),e.clearAvailability(),e.resetEdit(),e.renderGrid())},failureCallBack:function(t){t.httpStatus&&470===t.httpStatus&&(e.refreshAutoAssignStatus(),e.errorMessage=t.errorMessage)}};e.callAPI(u.unlockRoomDiary,t)},e.addListener("POLL_D_DIARY_AUTO_ASSIGN_STATUS",function(){V=D(e.refreshAutoAssignStatus,2e3)}),e.addListener("STOP_D_DIARY_AUTO_ASSIGN_STATUS_POLLING",function(){D.cancel(V)}),e.gridProps.filter.room_types.unshift({id:"All",name:"All",description:"All"}),e.focusOnCorporateSearchText=!1,e.openRateTypeChoosingBox=!1,e.companySearchTextEntered=function(){1===e.corporateSearchText.length?e.corporateSearchText=e.corporateSearchText.charAt(0).toUpperCase()+e.companySearchText.substr(1):e.corporateSearchText.length>2&&Z()},e.clearCorporateSearchText=function(){e.corporateSearchText="",G()},e.onUnassignedRoomToggle=function(){e.gridProps.unassignedRoomList.open?(e.$broadcast("CLOSE_UD_RESERVATION_PANEL"),e.gridProps.unassignedRoomList.open=!1):(e.gridProps.unassignedRoomList.open=!0,e.$broadcast("INITIALIZE_UNASSIGNED_LIST"))},e.onSelect=function(r,i,a,o){var s,l,u=e.gridProps,p=u.edit;if(e.showSaveChangesAfterEditing=!1,e.hideMoveRoomButton=i.is_hourly||"no-show"===i.reservation_status,e.isAvailable(void 0,i))e.gridProps.unassignedRoomList.isItemSelected||(s=d.shallowCopy({},i),s.selected=a,null!==u.availability.resize.current_arrival_time&&null!==u.availability.resize.current_departure_time&&(s[c.occupancy.start_date]=new Date(u.availability.resize.current_arrival_time),s[c.occupancy.end_date]=new Date(u.availability.resize.current_departure_time)),d.updateReservation(r,s),e.renderGrid(),e.isSelected(r,s)?(l=0,_.each(e.selectedReservations,function(e){e.occupancy.room_type_id===s.room_type_id&&(l+=1)}),0===s.physical_count||s.physical_count-l===0?(s.selected=!1,n.open({template:"/assets/partials/diary/rvDiaryAvailabilityPopup.html",controller:"RVDiaryConfirmationCtrl",scope:e})):(e.message=[],e.selectedReservations.push({room:r,occupancy:s}))):!function(){for(var t=0,r=e.selectedReservations.length;t<r;t++)if(e.selectedReservations[t].occupancy.key===s.key)return e.selectedReservations.splice(t,1)}(),e.$apply());else switch(o){case"edit":if(!p.active&&!u.unassignedRoomList.isItemSelected){e.initActiveEditMode({row_data:r,row_item_data:i}),e.hideRoomUnAssignButton="departed"===i.reservation_status||"inhouse"===i.reservation_status||"check-out"===i.reservation_status||"no-show"===i.reservation_status;var m=u.display.x_n instanceof Date?u.display.x_n:new Date(u.display.x_n);m.setHours(0,0,0);var v=(i.arrival,new Date(i.arrival));v=v.toComponents().time.toHourAndMinute(":",24),e.gridProps.filter.arrival_time=v,i.reservation_primary_guest_full_name||(e.gridProps.edit.originalItem.account_name=i.company_card_name?i.company_card_name:i.travel_agent_name);var h=new tzIndependentDate(t.businessDate);e.dateOptions.minDate=h,e.gridProps.availability.resize.last_arrival_time=null,e.gridProps.availability.resize.last_departure_time=null,e.renderGrid(),setTimeout(function(){e.$$phase||e.$apply()},100)}}},e.onResizeStart=function(e,t){};var B=function(t,r){this.availability.resize.current_arrival_time=r[c.occupancy.start_date],this.availability.resize.current_departure_time=r[c.occupancy.end_date],this.display.min_hours=(r[c.occupancy.end_date]-r[c.occupancy.start_date])/36e5,e.Availability()}.bind(e.gridProps);e.openStayCard=function(){var e=this.unassignedRoomList.isItemSelected?this.edit.originalItem:this.currentResizeItem,t=e.reservation_id,i=e.confirmation_number;r.go("rover.reservation.staycard.reservationcard.reservationdetails",{id:t,confirmationId:i,isrefresh:!0})}.bind(e.gridProps),e.moveRoomButtonClick=function(){var t=this.currentResizeItem,i=t.reservation_id,a=t.room_id;r.go("rover.nightlyDiary",{start_date:e.gridProps.filter.arrival_date,reservation_id:i,room_id:a,action:"TRIGGER_MOVE_ROOM"})}.bind(e.gridProps),e.unassignRoom=function(){if(this.currentResizeItem.cannot_move_room)e.message=["Guest is set to 'Do Not Move' - Remove flag from Stay Card to move reservation"],H();else{var t={id:this.currentResizeItem.reservation_id,is_from_diary:!0},r=function(){e.$emit("hideLoader"),e.gridProps.unassignedRoomList.reset(),De(),e.clearAvailability(),e.resetEdit(),e.renderGrid()},i=function(t){t.httpStatus&&470===t.httpStatus&&(e.refreshAutoAssignStatus(),e.errorMessage=t.errorMessage),e.$emit("hideLoader"),e.errorMessage=t};e.invokeApi(u.unassignRoom,t,r,i)}}.bind(e.gridProps);var H=function(){n.open({template:"/assets/partials/diary/rvDiaryMessages.html",scope:e,controller:"RVDiaryMessageShowingCtrl"})},J=function(){return n.open({template:"/assets/partials/diary/rvDiaryUnAssignedPopup.html",scope:e,controller:"RVDiaryMessageShowingCtrl"})};e.closeUnAssignedPopup=function(){e.resetEverything(),e.closeDialog()};var G=function(){e.focusOnCorporateSearchText=!0,e.$$phase||e.$apply()},Y=function(){n.open({template:"/assets/partials/diary/rvDiaryRoomTransferConfirmation.html",controller:"RVDiaryRoomTransferConfirmationCtrl",scope:e})};e.editSave=function(){var t=e.gridProps,r=t.currentResizeItemRow,i=t.currentResizeItem,a=(t.display.px_per_ms,t.display.x_n,t.edit.originalRowItem),o=t.edit.originalItem;if(e.roomXfer={current:{room:a,occupancy:o},next:{room:r,occupancy:i}},u.isReservationMovingFromOneDateToAnother){var n=u.movingReservationData;e.roomXfer.current.room=a=n.originalRoom,e.roomXfer.current.occupancy=o=n.originalReservation}e.price=e.roomXfer.next.room.new_price?e.roomXfer.next.room.new_price-e.roomXfer.current.room.old_price:0,0!==e.price?Y():a.room_type_id===r.room_type_id?o.arrival!==i.arrival||o.departure!==i.departure?(e.reserveRoom(e.roomXfer.next.room,e.roomXfer.next.occupancy),x()):(e.dateOptions.minDate=null,a.id!==r.id?e.saveReservation(i,r):(e.resetEdit(),e.renderGrid()),x()):(e.reserveRoom(e.roomXfer.next.room,e.roomXfer.next.occupancy),x())},e.reserveRoom=function(t,i){var a={},o=e.roomXfer,n=(o.current,o.next);a.arrival_date=t.arrivalDate,a.arrival_time=t.arrivalTime,a.departure_date=t.departureDate,a.departure_time=t.departureTime;var s={room_id:n.room.id,rateId:n.room.rate_id,amount:o.next.room.new_price,reservation_id:n.occupancy.reservation_id,confirmation_id:n.occupancy.confirmation_number,numAdults:n.occupancy.adults,numChildren:n.occupancy.children,numInfants:n.occupancy.infants,guest_card_id:n.occupancy.guest_card_id,company_card_id:n.occupancy.company_card_id,travel_agent_id:n.occupancy.travel_agent_id,payment:{payment_type:n.occupancy.payment_type,payment_method_used:n.occupancy.payment_method_used,payment_method_description:n.occupancy.payment_method_description,payment_details:n.occupancy.payment_details},demographics:n.occupancy.demographics};a.rooms=[],a.rooms.push(s),v.set("temporaryReservationDataFromDiaryScreen",JSON.stringify(a)),e.closeDialog(),r.go("rover.reservation.staycard.mainCard.summaryAndConfirm",{reservation:"HOURLY",mode:"EDIT_HOURLY"})},function(){var t,r;e.onDragStart=function(i,a){e.errorMessage="",this.availability.drag.lastRoom=d.copyRoom(i),t=i,r=a[c.occupancy.start_date],e.gridProps.edit.active,console.log("$scope.onDragStart")}.bind(e.gridProps),e.onDragEnd=function(i,a){var o,n=_.findWhere(e.room,{id:a.room_id});a.cannot_move_room&&i.room_no!==n.room_no?(e.message=["Guest is set to 'Do Not Move' - Remove flag from Stay Card to move reservation"],H()):e.gridProps.edit.active&&(o=P(i[c.room.row_children],a).shift(),t.id!==i.id&&(d.reservationRoomTransfer(e.gridProps.data,i,t,a),e.renderGrid()),e.gridProps.currentResizeItemRow=d.copyRoom(i),K(i,a),t="",r="")}}();var W=function(t,r,i,a){t.arrival!==r||t.departure!==i||a?(e.showSaveChangesAfterEditing=!0,e.hideRoomUnAssignButton=!0):e.showSaveChangesAfterEditing=!1},q=function(t,r){var i=t.availability,a=e.gridProps,o=a.edit.originalItem,n=a.edit.originalRowItem,s=this.availability.resize.last_arrival_time,l=this.availability.resize.last_departure_time,u=r.params.room_id!==o.room_id;if(W(o,a.currentResizeItem.arrival,a.currentResizeItem.departure,u),!i.is_available){if(s||l){if(a.currentResizeItemRow.id!==this.availability.drag.lastRoom.id){d.reservationRoomTransfer(this.data,this.availability.drag.lastRoom,a.currentResizeItemRow,a.currentResizeItem);var p=_.indexOf(_.pluck(e.gridProps.data,"id"),a.currentResizeItemRow.id);if(p!==-1){var m=_.indexOf(_.pluck(e.gridProps.data[p].occupancy,"reservation_id"),a.currentResizeItem.reservation_id);m!==-1&&e.gridProps.data[p].occupancy.splice(m)}}var p=_.indexOf(_.pluck(e.gridProps.data,"id"),this.availability.drag.lastRoom.id);if(p!==-1){var m=_.indexOf(_.pluck(e.gridProps.data[p].occupancy,"reservation_id"),a.currentResizeItem.reservation_id);m!==-1&&(e.gridProps.data[p].occupancy[m]=o)}this.currentResizeItemRow=this.availability.drag.lastRoom,this.currentResizeItem.arrival=s,this.currentResizeItem.departure=l}else{if(a.currentResizeItemRow.id!==n.id){d.reservationRoomTransfer(this.data,n,a.currentResizeItemRow,o);var p=_.indexOf(_.pluck(e.gridProps.data,"id"),a.currentResizeItemRow.id);if(p!==-1){var m=_.indexOf(_.pluck(e.gridProps.data[p].occupancy,"reservation_id"),o.reservation_id);m!==-1&&e.gridProps.data[p].occupancy.splice(m)}}var p=_.indexOf(_.pluck(e.gridProps.data,"id"),n.id);if(p!==-1){var m=_.indexOf(_.pluck(e.gridProps.data[p].occupancy,"reservation_id"),o.reservation_id);m!==-1&&(e.gridProps.data[p].occupancy[m]=d.copyReservation(o))}this.currentResizeItemRow=d.copyRoom(n),this.currentResizeItem.arrival=o.arrival,this.currentResizeItem.departure=o.departure}return e.message=i.message,H(),void e.renderGrid()}if(null===i.new_rate_amount&&(i.new_rate_amount=i.old_rate_amount),this.edit.originalRowItem.old_price=parseFloat(i.old_rate_amount),this.currentResizeItemRow.new_price=parseFloat(i.new_rate_amount),this.currentResizeItemRow.rate_id=i.old_rate_id,this.currentResizeItemRow.departureTime=r.params.end_time,this.currentResizeItemRow.departureDate=new Date(r.params.end_date).toComponents().date.toDateString().replace(/-/g,"/"),this.currentResizeItemRow.arrivalTime=r.params.begin_time,this.currentResizeItemRow.arrivalDate=new Date(r.params.begin_date).toComponents().date.toDateString().replace(/-/g,"/"),this.availability.resize.last_arrival_time=this.currentResizeItem[c.occupancy.start_date],this.availability.resize.last_departure_time=this.currentResizeItem[c.occupancy.end_date],this.availability.drag.lastRoom&&this.availability.drag.lastRoom.id!==this.currentResizeItemRow.id){var p=_.indexOf(_.pluck(e.gridProps.data,"id"),this.availability.drag.lastRoom.id);if(p!==-1){var m=_.indexOf(_.pluck(e.gridProps.data[p].occupancy,"reservation_id"),this.currentResizeItem.reservation_id);m!==-1&&e.gridProps.data[p].occupancy.splice(m),e.gridProps.currentResizeItem.room_id=this.currentResizeItemRow.id}}this.availability.drag.lastRoom=d.copyRoom(this.currentResizeItemRow),e.renderGrid(),e.gridProps.unassignedRoomList.isUnassignedPresent&&J()}.bind(e.gridProps),X=function(t){e.errorMessage=t,e.resetEdit(),e.renderGrid()},K=function(t,r){var i=oe(),a={params:i,successCallBack:q,failureCallBack:X,successCallBackParameters:{params:i,row_data:t,row_item_data:r}};e.callAPI(u.roomAvailabilityCheckAgainstReservation,a)};e.onResizeEnd=function(t,r){e.gridProps.edit.active?K(t,r,e.gridProps.edit.originalItem):B(t,r,e.gridProps.edit.originalItem)},e.onScrollEnd=function(t){e.toggleRows(e.gridProps.filter.show_all_rooms,t),e.gridProps.edit.reset_scroll=void 0},e.toggleRows=function(t,r){e.gridProps.filter.show_all_rooms=t,e.renderGrid()};var Z=_.debounce(function(){u.data_Store;s.fetchCompanyCard({query:e.corporateSearchText.trim()}).then(function(e){},I)},500);e.renderGrid=function(t){var r=t||{};ReactDOM.render(React.createElement(DiaryContent,_.extend(r,e.gridProps)),document.getElementById("component-wrapper"))},e.isSelected=function(e,t){return _.isBoolean(t.selected)&&t.selected},e.isAvailable=function(e,t){return"available"===t[c.occupancy.status].toLowerCase()},e.isDraggable=function(t){return!e.isAvailable(void 0,t)},e.isResizable=function(e){var t=c.status;if(e)return"check-in"===e[t].toLowerCase()?{resizable:!0,arrival:!1,departure:!0}:{resizable:!0,arrival:!0,departure:!0}},e.initActiveEditMode=function(e,t,r){if(this.edit.passive)throw Error("Active/Passive edit mode mutually exclusive.");this.edit=t.deepCopy(this.edit),this.edit.active=!0,this.edit.passive=!1,this.edit.originalItem=t.copyReservation(r.row_item_data),this.edit.originalRowItem=t.copyRoom(r.row_data),this.currentResizeItem=t.copyReservation(r.row_item_data),this.currentResizeItemRow=t.copyRoom(r.row_data)}.bind(e.gridProps,c,d),e.initPassiveEditMode=function(e,t,r){if(r.row_item_data){if(this.edit.active)throw Error("Active/Passive edit mode mutually exclusive.");this.edit=t.deepCopy(this.edit),this.edit.active=!1,this.edit.passive=!0,this.edit.mode=r.row_item_data[e.occupancy.id],this.currentResizeItem=t.copyReservation(r.row_item_data),this.currentResizeItemRow=t.copyRoom(r.row_data)}}.bind(e.gridProps,c,d),e.editCancel=function(){var t,r,i=e.gridProps;if(_.isEmpty(i.edit.originalRowItem)||(t=_.indexOf(_.pluck(e.gridProps.data,"id"),i.edit.originalRowItem.id),d.reservationRoomTransfer(e.gridProps.data,i.edit.originalRowItem,i.currentResizeItemRow,i.currentResizeItem)),r=e.gridProps.data,u.isReservationMovingFromOneDateToAnother){var a=u.movingReservationData.originalReservation,o=new tzIndependentDate(a.arrival);o.setHours(0,0,0),T(e.gridProps.filter.arrival_date,o)||f(function(){var t=i.filter.arrival_date.getTime(),r=d.gridTimeComponents(t,48,d.deepCopy(e.gridProps.display));e.gridProps.display=d.deepCopy(r.display),le(r.toStartDate(),r.toEndDate())},0),e.gridProps.filter.arrival_date=o,me(o),x()}e.gridProps.unassignedRoomList.isItemSelected&&e.$broadcast("DESELECT_UNASSIGNED_RESERVATION"),e.dateOptions.minDate=null,e.errorMessage="",e.resetEdit(),e.renderGrid()},e.resetEdit=function(){e.gridProps.edit=d.deepCopy(e.gridProps.edit),e.gridProps.edit.active=!1,e.gridProps.edit.passive=!1,e.gridProps.mode=void 0,e.gridProps.currentResizeItem=void 0,e.gridProps.currentResizeItemRow=void 0,e.gridProps.edit.currentResizeItem=void 0,e.gridProps.edit.currentResizeItemRow=void 0},e.clearAvailability=function(){for(var t,r=e.gridProps.data,i=c.occupancy.status,a=(c.occupancy.id,function(e){return"available"===e[i].toLowerCase()||"blocked"===e[i].toLowerCase()}),o=0,n=r.length;o<n;o++)t=r[o],t.occupancy=_.reject(t.occupancy,a),t=d.deepCopy(t)};var Q=function(t,r){e.callBackAfterClosingMessagePopUp=r,e.message=[t],H()},ee=function(t,r,i){var a;if(!t.length)return void Q("Sorry, No Availability found. Please change the parameter and continue");a=t[0],null!==this.availability.resize.current_arrival_time&&null!==this.availability.resize.current_departure_time&&(this.availability.resize.last_arrival_time=this.availability.resize.current_arrival_time,this.availability.resize.last_departure_time=this.availability.resize.current_departure_time);var o=u.data_Store.get("contractId");o&&(this.contractId=o),e.initPassiveEditMode({start_date:new Date(a[c.occupancy.start_date]),end_date:new Date(a[c.occupancy.end_date]),row_item_data:a,row_data:_.findWhere(u.data_Store.get("room"),{id:a.room_id})}),i||e.gridProps.unassignedRoomList.reset(),e.renderGrid()}.bind(e.gridProps),te=function(t){e.errorMessage=t},re=function(){e.openRateTypeChoosingBox=!0},ie=function(t,r){if(e.gridProps.unassignedRoomList.isUnassignedPresent){var i=J();i.closePromise.then(function(){ee(t,r,!0)})}else ee(t,r,!0)},ae=function(){var t=ne(),r=e.gridProps.filter;if("Corporate"===r.rate_type&&!r.rate)return re(),e.callBackAfterClosingMessagePopUp=G,e.message=["Please choose a Company Card or Travel Agent to proceed"],void H();var i={params:t,successCallBack:ie,failureCallBack:te,successCallBackParameters:t};e.callAPI(u.Availability,i)};e.Availability=function(){e.errorMessage="",e.clearAvailability(),e.resetEdit(),e.renderGrid(),e.gridProps.filter.arrival_time&&ae()};var oe=function(){var e=_.extend({},this.filter),t=(Time({hours:this.min_hours}),new Date(this.display.x_n)),r=(new Date(9e5*e.arrival_times.indexOf(e.arrival_time)+t.getTime()).toComponents().time,new Date(this.currentResizeItem.arrival).toComponents().date.toDateString().replace(/-/g,"/")),i=new Date(this.currentResizeItem.departure).toComponents().date.toDateString().replace(/-/g,"/"),a=ue(this.currentResizeItem),o=ce(this.currentResizeItem),n=this.currentResizeItemRow.id,s=this.currentResizeItem.reservation_id,l=new Date(this.currentResizeItem.arrival).toComponents().time,u=new Date(this.currentResizeItem.departure).toComponents().time;l=l.hours+":"+l.minutes+":"+l.seconds,u=u.hours+":"+u.minutes+":"+u.seconds;var c={room_id:n,reservation_id:s,begin_date:r,begin_time:l,end_date:i,end_time:u,rate_type:a};return o&&(c.account_id=o),c}.bind(e.gridProps),ne=function(){function t(e,t){var r,i,a,o=new Date(e),n=new Date(o);return n.setHours(t),r=o.getTimezoneOffset()-n.getTimezoneOffset(),r<0?(a=!0,i=!1):r>0?(a=!1,i=!0):(a=!1,i=!1),{hasExtraHour:i,hasLessHour:a}}var r=_.extend({},this.filter),i=Time({hours:this.display.min_hours}),a=new Date(this.display.x_n);a.setHours(0,0,0);var o=r.arrival_times.indexOf(r.arrival_time),n=new Date(9e5*o+a.getTime()).toComponents().time,s=new Date(a.getFullYear(),a.getMonth(),a.getDate(),n.hours,n.minutes,0,0),l=e.gridProps.filter.arrival_time.split(":"),u=l[0],c=l[1];s.setHours(u,c);var d=t(s,i.hours),p=d.hasExtraHour?1:d.hasLessHour?-1:0,m=new Date(s.getFullYear(),s.getMonth(),s.getDate(),s.getHours()+i.hours+p,s.getMinutes()+i.minutes,0,0),v=_.isEmpty(r.room_type)||r.room_type&&"All"===r.room_type.id?void 0:r.room_type.id,h=r.rate_type,f="Corporate"===r.rate_type&&r.rate&&""!==r.rate?r.rate.id:void 0,g="avl-101";s.isOnDST(),m.isOnDST(),null!==this.availability.resize.current_arrival_time&&null!==this.availability.resize.current_departure_time&&(s=new Date(this.availability.resize.current_arrival_time),m=new Date(this.availability.resize.current_departure_time));var y={start_date:s,end_date:m,room_type_id:v,rate_type:h,GUID:g};return f&&(y.account_id=f),y}.bind(e.gridProps),se=function(e,t,r,i){function a(e){var e=e||"00:00",t=e.split(":"),r=parseInt(t[0]),i=parseInt(t[1]),a="00",o="00";
return r=isNaN(r)?0:r,i=isNaN(i)?0:i,i=i>0&&i<=15?15:i>15&&i<=30?30:i>30&&i<=45?45:0,a=r<10?"0"+r:r.toString(),o=i<10?"0"+r:i.toString(),{hh:r,mm:i,hhmm:a+":"+o}}var o=a(e),n=_.extend({},this.filter),s=Time({hours:r.hh,minutes:r.mm}),l=new Date(this.display.x_n);l.setHours(0,0,0);var u=n.arrival_times.indexOf(o.hhmm),c=new Date(9e5*u+l.getTime()).toComponents().time,d=new Date(l.getFullYear(),l.getMonth(),l.getDate(),c.hours,c.minutes,0,0);d.setHours(o.hh,o.mm);var p=new Date(d.getFullYear(),d.getMonth(),d.getDate(),d.getHours()+s.hours,d.getMinutes()+s.minutes,0,0),m="avl-101";return{start_date:d,end_date:p,room_type_id:i,GUID:m,is_unassigned_room:!0}}.bind(e.gridProps);e.$watch("selectedReservations.length",function(t,r){t>r&&n.open({template:"/assets/partials/diary/rvDiaryConfirmation.html",controller:"RVDiaryConfirmationCtrl",scope:e})}),e.$watch("gridProps.filter.account_id",function(t,r){t!==r&&(e.gridProps.edit.active||e.Availability())});var le=function(t,r,i,a,o){R.start("LOAD_OCC_AVAILABILITY_COUNT"),e.errorMessage="",u.callOccupancyAndAvailabilityCount(t,r).then(function(t){if(e.gridProps.data=t.room,e.gridProps.stats=t.availability_count,e.gridProps.display.x_0=e.gridProps.viewport.row_header_right,_.size(ge))ge.callback();else{if(e.clearAvailability(),e.resetEdit(),e.renderGrid(),u.isReservationMovingFromOneDateToAnother){var r=u.movingReservationData,n=r.reservation.reservation_id;Se(n),e.gridProps.edit.originalItem=r.originalReservation,e.gridProps.edit.originalRowItem=r.originalRoom,K(e.gridProps.currentResizeItemRow,e.gridProps.currentResizeItem)}else e.gridProps.filter.rate_type=i?i:"Standard",e.gridProps.filter.arrival_time=a?a:"00:00",e.gridProps.filter.room_type=o?o:"";R.stop("LOAD_OCC_AVAILABILITY_COUNT")}e.gridProps.unassignedRoomList.fetchCount()},function(){R.stop("LOAD_OCC_AVAILABILITY_COUNT")})},ue=function(e){return null!==e.travel_agent_id&&""!==e.travel_agent_id||null!==e.company_card_id&&""!==e.company_card_id?"Corporate":"Standard"},ce=function(e){return"Corporate"===ue(e)?e.travel_agent_id?e.travel_agent_id:e.company_card_id:void 0},de=function(t,r){var i=_.extend({},e.gridProps.filter),a=r,o=new Date(9e5*i.arrival_times.indexOf(i.arrival_time)+a.getTime()),a=a.toComponents().date.toDateString(),n=new Date(t.arrival),s=new Date(t.departure),l=s.getTime()-n.getTime(),u=new Date(o.getTime()+l),c=u.toComponents().time,u=u.toComponents().date.toDateString(),o=o.toComponents().time,o=o.hours+":"+o.minutes+":"+o.seconds,c=c.hours+":"+c.minutes+":"+c.seconds,d=ue(t),p=ce(t),m=e.gridProps.edit.originalRowItem.id,v=t.reservation_id,h={room_id:m,reservation_id:v,begin_date:a,begin_time:o,end_date:u,end_time:c,rate_type:d};return p&&(h.account_id=p),h},pe=function(e){},me=function(t){e.duplicte_arrival_date=t},_e=function(t,r){t=t.availability;var i=t.response_code,a=r.oldGridProps;switch(i){case"ROOM_ROOM_TYPE_AVAILABLE":ve(a,t,r);break;case"ROOM_DIFF_ROOM_TYPE_AVAILABLE":e.message=[t.response_message],e.callBackAfterClosingMessagePopUp=function(){ve(a,t,r),e.callBackAfterClosingMessagePopUp=void 0},H();break;case"ROOM_ROOM_TYPE_DIFF_AVAILABLE":e.message=[t.response_message],e.callBackAfterClosingMessagePopUp=function(){ve(a,t,r),e.callBackAfterClosingMessagePopUp=void 0},H();break;case"NOT_AVAILABLE":e.message=[t.response_message],H(),me(a.filter.arrival_date);break;case"OOO":e.message=[t.response_message],e.callBackAfterClosingMessagePopUp=function(){ve(a,t,r),e.callBackAfterClosingMessagePopUp=void 0},H();break;case"BLOCKED":e.message=[t.response_message],e.callBackAfterClosingMessagePopUp=function(){ve(a,t,r),e.callBackAfterClosingMessagePopUp=void 0},H()}},ve=function(t,r,i){var a=t,o=a.filter,n=d.copyReservation(a.currentResizeItem),s=d.copyReservation(a.edit.originalItem),l=d.copyRoom(a.edit.originalRowItem),u=d.copyRoom(_.findWhere(a.data,{id:r.available_room_id})),c=o.arrival_time.split(":")[0],p=o.arrival_time.split(":")[1],m=new Date(n.arrival);m.setHours(c,p);var v=new Date(n.arrival),h=new Date(n.departure),f=h.getTime()-v.getTime(),g=new Date(m.getTime()+f);n.arrival=m.getTime(),n.departure=g.getTime(),n.room_id=u.id,E(n,s,u,l),i.chosenDate.setHours(0,0,0),e.gridProps.filter.arrival_date=i.chosenDate,e.$$phase||e.$apply()},he=function(t,r){if(""===this.filter.arrival_time)return e.message=["Please choose arrival time and retry"],void H();var i=new Date(e.gridProps.filter.arrival_date);if(r.getFullYear()!==i.getFullYear()||r.getMonth()!==i.getMonth()||r.getDate()!==i.getDate()){var a=de(t,r),o={params:a,successCallBack:_e,failureCallBack:pe,successCallBackParameters:{chosenDate:r,oldGridProps:d.deepCopy(e.gridProps)}};e.callAPI(u.checkAvailabilityForReservationToA_Date,o)}}.bind(e.gridProps),fe=function(t,r){var i,a=e.gridProps,o=a.filter,n=o.arrival_date.getTime();e.$emit("hideLoader"),T(t,r)&&(i=d.gridTimeComponents(n,48,d.deepCopy(e.gridProps.display)),e.gridProps.display=d.deepCopy(i.display),le(i.toStartDate(),i.toEndDate()),e.gridProps.unassignedRoomList.reset())};e.$watch("gridProps.filter.arrival_date",fe);var ge={};e.resetEverything=function(){var t=function(t){var r=new tzIndependentDate(t.hotel_time.date);r.setHours(0,0,0),ge=d.correctTime(r.toComponents().date.toDateString().replace(/-/g,"/"),t),ge.callback=function(){e.gridProps.filter.arrival_time=ge.arrival_time,e.gridProps.filter.rate_type="Standard",e.gridProps.filter.room_type="";new tzIndependentDate(ge.start_date);e.gridProps.edit.reset_scroll={x_n:r,x_origin:ge.start_date},e.renderGrid(),e.$emit("hideLoader"),f(function(){ge={}},300)},e.gridProps.filter.arrival_date=r,me(e.gridProps.filter.arrival_date),e.gridProps.display.min_hours=4,x(),e.$$phase||e.$apply()};e.gridProps.edit.reset_scroll||(e.gridProps.unassignedRoomList.open?e.gridProps.unassignedRoomList.reset():(e.clearAvailability(),e.resetEdit(),e.renderGrid(),e.gridProps.unassignedRoomList.isUnassignedPresent=!1),e.invokeApi(h.fetchCurrentTime,{},t))};var ye=function(e,r,i){var o=r.arrivalDate,n=r.departureDate,s=r.arrivalTime.split(":"),l=r.departureTime.split(":");s=getTimeFormated(s[0],s[1]),l=getTimeFormated(l[0],l[1]);var u=[],c=[],d=getDatesBetweenTwoDates(new Date(o),new Date(n));return _.each(d,function(i){c.push({date:a("date")(i,t.dateFormatForAPI),rate_id:r.rate_id,room_type_id:r.room_type_id,adults_count:e.adults,children_count:e.children,infants_count:e.infants,room_id:r.id})}),u.push(c),{room_id:[r.id],arrival_date:o,arrival_time:s,departure_date:n,departure_time:l,reservationId:e.reservation_id,stay_dates:u,is_move_without_rate_change:!!i&&i,is_from_diary:!0}};e.saveReservation=function(t,r,i){var a=ye(t,r,i),o={params:a,successCallBack:De,failureCallBack:Re};e.callAPI(g.updateReservation,o)},e.saveReservationOnDrop=function(t,r){var i={arrival_date:t.arrival_date,arrival_time:t.arrival_time,departure_date:t.departure_date,departure_time:t.departure_time,reservationId:t.reservationId,room_id:[r],stay_dates:[[{adults_count:t.adults,children_count:t.children,date:t.arrival_date,infants_count:t.infants,rate_id:t.rate_id,room_id:r,room_type_id:t.room_type_id}]],is_move_without_rate_change:!0,is_from_diary:!0},a={params:i,successCallBack:function(){e.gridProps.unassignedRoomList.reset(),De()},failureCallBack:Re};e.callAPI(g.updateReservation,a)};var De=function(t){var r=this.filter,i=e.gridProps.display.x_n,a=d.gridTimeComponents(i,48,d.deepCopy(this.display)),o=r.arrival_time,n=r.room_type,s=r.rate_type,l=e.gridProps.display.property_date_time;e.gridProps.display=d.deepCopy(a.display),e.gridProps.display.property_date_time=l,le(a.toStartDate(),a.toEndDate(),s,o,n)}.bind(e.gridProps),Re=function(t){t.httpStatus&&470===t.httpStatus&&(e.refreshAutoAssignStatus(),e.errorMessage=t.errorMessage),e.errorMessage=t};e.clickedOnArrivalTime=function(){e.gridProps.availability.resize.current_arrival_time=null,e.gridProps.availability.resize.current_departure_time=null,e.gridProps.availability.resize.last_arrival_time=null,e.gridProps.availability.resize.last_departure_time=null,e.gridProps.edit.active?""===e.gridProps.filter.arrival_time&&(e.clearAvailability(),e.resetEdit(),e.renderGrid()):(e.Availability(),e.gridProps.unassignedRoomList.reset())},e.clickedOnRoomType=function(){!e.gridProps.edit.active&&e.gridProps.filter.room_type?(e.Availability(),e.gridProps.unassignedRoomList.reset()):null===e.gridProps.filter.room_type&&(e.clearAvailability(),e.resetEdit(),e.renderGrid())},e.clickedOnRateType=function(){"Standard"===e.gridProps.filter.rate_type&&(e.gridProps.filter.rate=""),e.gridProps.edit.active||"Standard"!==e.gridProps.filter.rate_type||(e.Availability(),e.gridProps.filter.toggleRates())};var Se=function(t){if(t){var r=e.gridProps.data,i=null,a=null,o=null;_.each(r,function(e){o=e.occupancy,_.each(o,function(r){_.has(r,"reservation_id")&&r.reservation_id===parseInt(t)&&(a=r,i=e)})}),i&&e.onSelect(i,a,!1,"edit")}},Me=function(){if(!e.gridProps.filter.room_type){var t,r;if(t=v.get("searchReservationData"),!t)return;t=JSON.parse(t),r=isNaN(parseInt(t.roomTypeID))?"All":t.roomTypeID,match=_.find(e.gridProps.filter.room_types,function(e){return r===e.id}),e.gridProps.filter.room_type=match}e.clickedOnRoomType()};e.eventAfterRendering=function(){e.$apply(function(){e.$emit("hideLoader"),e.resetEdit()}),setTimeout(Me,100);var t="true"!==i.is_nightly_reservation||"undefined"==typeof i.is_nightly_reservation;setTimeout(function(){if(i&&"reservation_id"in i&&""!==i.reservation_id&&t){var r=i.reservation_id;e.$apply(function(){Se(r)})}},1e3)},t.$on("ngDialog.opened",function(e,r){t.modalOpened=!1,f(function(){t.modalOpened=!0},300)}),t.$on("ngDialog.closing",function(e,r){t.modalOpened=!1}),e.compCardOrTravelAgSelected=function(){e.gridProps.edit.active||(e.Availability(),e.gridProps.filter.toggleRates())},e.discardSelectedCompCardOrTravelAg=function(){e.gridProps.filter.rate="",e.corporateSearchText=""};var we=function(t,r){var i=[],a="",o={},n=!1,l="",u=function(t){e.$emit("hideLoader"),angular.forEach(t.accounts,function(t){o={},o={label:t.account_name,value:t.account_name,image:t.company_logo,type:t.account_type,id:t.id,corporateid:"",iataNumber:""},""===t.company_logo&&(l="COMPANY"===t.account_type?"avatar-company.png":"avatar-travel-agent.png",o.image="/ui/pms-ui/images/"+l),n=_.find(e.companyCardResults,function(e){return o.id===e.id}),n||i.push(o)}),r(i)},c=function(){""!==t.term&&a!==t.term&&(e.invokeApi(s.fetchCompanyCard,{query:t.term},u),a=t.term)};0===t.term.length?(i=[],a=""):t.term.length>2&&c()},Ie=function(t,r){e.gridProps.filter.rate=r.item,e.$apply()};e.autocompleteOptions={delay:0,position:{my:"right top",at:"right bottom",collision:"flip"},source:we,select:Ie};var Pe,be=function(){Pe=setTimeout(function(){var t=new tzIndependentDate(e.adj_property_date_time.start_date);t.setMinutes(t.getMinutes()+15),e.adj_property_date_time.start_date=t.getTime(),e.gridProps.display.property_date_time=e.adj_property_date_time,e.gridProps.display=d.deepCopy(e.gridProps.display),e.renderGrid(),be()},e.gridProps.display.ms_hr/e.gridProps.display.intervals_per_hour)};be(),e.gridProps.unassignedRoomList.fetchCount(),e.$on("$destroy",function(){Pe&&clearTimeout(Pe)}),e.toggleHourlyNightly=!0,e.navigateToNightlyDiary=function(){r.go("rover.nightlyDiary",{start_date:e.gridProps.filter.arrival_date}),e.toggleHourlyNightly=!1},e.hideToggleMenu=function(){var e=!1;return t.isHourlyRateOn&&(e=!0),e};var Oe=function(){var t,r=e.gridProps,i=r.filter,a=i.arrival_date.getTime();e.$emit("hideLoader"),t=d.gridTimeComponents(a,48,d.deepCopy(e.gridProps.display)),e.gridProps.display=d.deepCopy(t.display),le(t.toStartDate(),t.toEndDate()),e.gridProps.unassignedRoomList.reset()};e.addListener("REFRESH_DIARY_ROOMS_AND_RESERVATIONS",function(){Oe()})}]),sntRover.controller("RVDiaryMessageShowingCtrl",["$scope","ngDialog","$rootScope","$timeout",function(e,t,r,i){e.messages=e.message;var a=e.callBackAfterClosingMessagePopUp;e.closeDialog=function(){r.modalClosing=!0,i(function(){r.modalClosing=!1,t.close()},300),a&&i(function(){a()},1e3)},e.exitPopup=function(){t.close()}}]),sntRover.controller("RVDiaryRoomTransferConfirmationCtrl",["$scope","$rootScope","$state","rvDiarySrv","ngDialog","rvDiaryMetadata","$vault","rvDiaryUtil","$filter","$timeout",function(e,t,r,i,a,o,n,s,l,u){var c=e.roomXfer,d=c.current,p=c.next,m=o.occupancy,_=o.room;new Date(d[_.row_children][m.start_date]).toComponents(),new Date(d[_.row_children][m.end_date]).toComponents(),new Date(p[_.row_children][m.start_date]).toComponents(),new Date(p[_.row_children][m.end_date]).toComponents();BaseCtrl.call(this,e);var v=function(e){var r,i;e.arrivalTime=new Date(e[_.row_children][m.start_date]).toLocaleTimeString(),e.departureTime=new Date(e[_.row_children][m.end_date]).toLocaleTimeString(),r=tzIndependentDate(new Date(e[_.row_children][m.start_date]).toComponents().date.toDateString().replace(/-/g,"/")),e.arrivalDateToShow=l("date")(r,t.dateFormat),e.arrivalDate=l("date")(r,t.mmddyyyyBackSlashFormat),i=tzIndependentDate(new Date(e[_.row_children][m.end_date]).toComponents().date.toDateString().replace(/-/g,"/")),e.departureDateToShow=l("date")(i,t.dateFormat),e.departureDate=l("date")(i,t.mmddyyyyBackSlashFormat)};v(d),v(p),e.price=parseFloat(c.next.room.new_price-c.current.room.old_price);var h=function(){i.isReservationMovingFromOneDateToAnother=!1,i.movingReservationData.reservation=void 0,i.movingReservationData.room_to=void 0,i.movingReservationData.originalRoom=void 0,i.movingReservationData.originalReservation=void 0};e.moveWithoutRateChange=function(){var t=!0;e.saveReservation(e.roomXfer.next.occupancy,e.roomXfer.next.room,t),h(),e.closeDialog(),e.renderGrid()},e.selectAdditional=function(){e.closeDialog()},e.confirm=function(){e.reserveRoom(e.roomXfer.next.room,e.roomXfer.next.occupancy)}}]),angular.module("sntRover").controller("rvDiaryUnassignedListController",["$scope","$rootScope","rvDiarySrv",function(e,t,r){var i=[],a=function(){var t=function(t){e.errorMessage="",i=t,e.arrangeReservationList()},a={date:e.gridProps.filter.arrival_date},o={params:a,successCallBack:t};e.callAPI(r.fetchUnassignedRoomList,o)},o=function(e,t,r,i){var a,o,n,s,l,u,c,d,p,m={},_={};return t&&i?(d=t,p=i):(d="00:00",p="04:00"),a=e.split("-"),m.year=parseInt(a[0]),m.month=parseInt(a[1])-1,m.date=parseInt(a[2]),o=d.split(":"),m.hour=parseInt(o[0]),m.mins=parseInt(o[1]),a=r.split("-"),_.year=parseInt(a[0]),_.month=parseInt(a[1])-1,_.date=parseInt(a[2]),o=p.split(":"),_.hour=parseInt(o[0]),_.mins=parseInt(o[1]),n=new Date(m.year,m.month,m.date,m.hour,m.mins),s=new Date(_.year,_.month,_.date,_.hour,_.mins),l=Math.abs(s-n),u=Math.floor(l/36e5),c=Math.floor(l%36e5/6e4),{hh:u,mm:c,hhs:u+"h"}},n=function(){e.selectedIndex=null,e.gridProps.unassignedRoomList.isItemSelected=!1,e.clearAvailability(),e.resetEdit(),e.renderGrid()};BaseCtrl.call(this,e),e.businessDate=t.businessDate,e.queryString="",e.addListener("INITIALIZE_UNASSIGNED_LIST",a),e.addListener("CLOSE_UD_RESERVATION_PANEL",function(){i=[],e.clearList(),n()}),e.addListener("DESELECT_UNASSIGNED_RESERVATION",n),e.clickedUnassignedReservation=function(t){if(e.selectedIndex===t.reservation_id)n();else{e.selectedIndex=t.reservation_id,e.gridProps.unassignedRoomList.isItemSelected=!0;var r={arrival_date:t.arrival_date,arrival_time:t.arrival_time,departure_date:t.departure_date,departure_time:t.departure_time,reservationId:t.reservation_id,adults:t.adults,children:t.children,infants:t.infants,rate_id:t.rate_id,room_type_id:t.room_type_id,is_hourly:t.is_hourly,stay_span:o(t.arrival_date,t.arrival_time,t.departure_date,t.departure_time)};e.$emit("UNASSIGNED_RESERVATION_SELECTED",r,t)}},e.arrangeReservationList=function(){e.currentBookings=[],e.futureBookings=[];var t=[];t=e.queryString&&e.queryString.length>0?i.filter(function(t){return isNaN(e.queryString)&&t.primary_guest.toUpperCase().includes(e.queryString.toUpperCase())||!isNaN(e.queryString)&&t.confirmation_number.toString().includes(e.queryString)}):i,angular.forEach(t,function(t){moment(e.gridProps.filter.arrival_date).format("YYYY-MM-DD")===t.arrival_date?e.currentBookings.push(t):e.futureBookings.push(t)})},e.bookingsPresent=function(){return 0!==i.length},e.getNextDate=function(t){var r=moment(e.gridProps.filter.arrival_date).add(1,"day");return t?r.format("DD MMM YYYY"):r.format("YYYY-MM-DD")},e.getActiveDate=function(t){var r=moment(e.gridProps.filter.arrival_date);return t?r.format("DD MMM YYYY"):r.format("YYYY-MM-DD")},e.clearList=function(){e.queryString="",e.arrangeReservationList()}}]),angular.module("sntRover").controller("rvDiaryRoomStatusAndServiceUpdatePopupCtrl",["$scope","$rootScope","ngDialog","RVHkRoomStatusSrv","RVHkRoomDetailsSrv","$timeout","$filter","rvUtilSrv",function(e,t,r,i,a,o,n,s){BaseCtrl.call(this,e);var l="roomStatusServiceUpdateScroller",u=15,c=12,d=1,p="FULL"===s.getDiaryMode();e.closeDialog=function(){r.close()},e.setActiveSection=function(t){e.currentActiveSection=t,"service"===t&&o(function(){e.refreshScroller(l)},1e3)},e.getClassNameByHkStatus=function(e,r){var i="";return"IN_SERVICE"!==r?i="unavailable":"CLEAN"===e&&t.useInspectedRoomStatus?i="clean not-inspected":"CLEAN"!==e||t.useInspectedRoomStatus?"INSPECTED"===e?i="inspected":"DIRTY"===e?i="dirty":"PICKUP"===e?i="pickup":"DO_NOT_DISTURB"===e&&(i="dnd"):i="clean",i};var m=function(t){var r=_.find(e.hkStatusList,{value:t});return r&&r.id||""},v=function(){e.callAPI(i.fetchHkStatusList,{onSuccess:function(r){e.hkStatusList=r,t.isStandAlone&&!p&&e.roomInfo.is_occupied||(e.hkStatusList=_.reject(e.hkStatusList,function(e){return"DO_NOT_DISTURB"===e.value})),e.returnStatusList=_.reject(e.hkStatusList,function(e){return"DO_NOT_DISTURB"===e.value})}}),e.callAPI(a.fetchAllServiceStatus,{onSuccess:function(t){e.serviceList=t,d=_.find(e.serviceList,{value:"IN_SERVICE"}).id}})},h=function(){e.callAPI(a.fetchMaintenanceReasons,{onSuccess:function(t){e.maintenanceReasonsList=t}})},f=function(r,i,o){e.callAPI(a.fetchRoomStatus,{params:{room_id:e.roomInfo.id,year:r,month:i},onSuccess:function(r){if(angular.extend(e.serviceStatus,r.service_status),!o){var i=e.serviceStatus[y(tzIndependentDate(t.businessDate))];e.serviceStatusDetails.room_service_status_id=i.id,e.serviceStatusDetails.reason_id=i.maintenance_reason_id||"",e.serviceStatusDetails.comment=i.comments,e.serviceStatusDetails.return_status_id=i.return_status_id||""}!angular.isUndefined(o)&&o.id?$("#"+o.id).datepicker("refresh"):$(".ngmodal-uidate-wrap").datepicker("refresh")}})},g=function(){e.setClass=function(t){return[!0,e.serviceStatus[n("date")(tzIndependentDate(t),"yyyy-MM-dd")]&&e.serviceStatus[n("date")(tzIndependentDate(t),"yyyy-MM-dd")].id>1?"room-out":""]};var r={dateFormat:t.jqDateFormat,numberOfMonths:1,changeYear:!0,changeMonth:!0,beforeShow:function(){$("#ui-datepicker-div").addClass("reservation hide-arrow"),$('<div id="ui-datepicker-overlay">').insertAfter("#ui-datepicker-div"),setTimeout(function(){$("body").find("#ui-datepicker-overlay").on("click",function(){$("#room-out-from").blur(),$("#room-out-to").blur()})},100)},onClose:function(){$("#ui-datepicker-div").removeClass("reservation hide-arrow"),$("#ui-datepicker-overlay").off("click").remove()}},i=function(){tzIndependentDate(e.serviceStatusDetails.from_date)>tzIndependentDate(e.serviceStatusDetails.to_date)&&(e.serviceStatusDetails.to_date=n("date")(tzIndependentDate(e.serviceStatusDetails.from_date),"yyyy-MM-dd")),e.untilDateOptions.minDate=n("date")(tzIndependentDate(e.serviceStatusDetails.from_date),t.dateFormat)};e.fromDateOptions=angular.extend({minDate:n("date")(t.businessDate,t.dateFormat),onSelect:i,beforeShowDay:e.setClass,onChangeMonthYear:function(e,t,r){f(e,t,r)}},r),e.untilDateOptions=angular.extend({minDate:n("date")(t.businessDate,t.dateFormat),onSelect:i,beforeShowDay:e.setClass,onChangeMonthYear:function(e,t,r){f(e,t,r)}},r)},y=function(e){return n("date")(new tzIndependentDate(e),t.dateFormatForAPI)};e.isRoomStatusSectionActive=function(){return"room"===e.currentActiveSection},e.updateRoomStatus=function(t){e.callAPI(a.updateHKStatus,{params:{room_no:t,hkstatus_id:m(e.statusInfo.hkStatus)},onSuccess:function(){e.$emit("REFRESH_DIARY_ROOMS_AND_RESERVATIONS",e.roomInfo.room_id),e.closeDialog()},onFailure:function(t){e.errorMessage=t}})},e.isInService=function(){return e.serviceStatusDetails.room_service_status_id===d},e.onServiceStatusChange=function(){e.refreshScroller(l)},e.shouldShowTimeSelector=function(){return(t.isHourlyRateOn||"FULL"===t.hotelDiaryConfig.mode)&&!e.isInService()},e.updateServiceStatus=function(){var t=function(){e.$emit("REFRESH_DIARY_ROOMS_AND_RESERVATIONS",e.roomInfo.room_id),e.closeDialog()},r={from_date:y(e.serviceStatusDetails.from_date),to_date:y(e.serviceStatusDetails.to_date),begin_time:"",end_time:"",reason_id:e.serviceStatusDetails.reason_id,comment:e.serviceStatusDetails.comment,room_service_status_id:e.serviceStatusDetails.room_service_status_id,return_status_id:e.serviceStatusDetails.return_status_id};e.shouldShowTimeSelector()&&(r.begin_time=e.serviceStatusDetails.begin_time,r.end_time=e.serviceStatusDetails.end_time),r.room_id=e.roomInfo.id,e.invokeApi(a.postRoomServiceStatus,r,t)};var D=function(){e.currentActiveSection="room",e.roomInfo=e.ngDialogData,e.serviceStatusDetails={comment:"",reason_id:"",end_time:"",begin_time:"",room_service_status_id:"",from_date:tzIndependentDate(t.businessDate),to_date:tzIndependentDate(t.businessDate)},e.statusInfo={hkStatus:e.roomInfo.hk_status,serviceStatus:e.roomInfo.service_status||e.roomInfo.room_service_status},e.todayDate=tzIndependentDate(t.businessDate),v(),h(),f(tzIndependentDate(t.businessDate).getFullYear(),tzIndependentDate(t.businessDate).getMonth()),g(),e.setScroller(l),e.timeSelectorList=s.getListForTimeSelector(u,c),e.serviceStatus={}};D()}]);var DiaryLib=window.DiaryLib||Object.create(null);DiaryLib.Models=DiaryLib.Models||Object.create(null),DiaryLib.Util=DiaryLib.Util||Object.create(null),Model.prototype={constructor:Model,reset:function(){this.isUpdating=!1,this.isResolved=!1,this.isDirty=!1}},Time.prototype.convertToReferenceInterval=function(e){var t;return t=(this.minutes/e).toFixed()*e,this.minutes>45?(this.hours+=1,this.minutes=0):this.minutes=t,this.seconds=0,this.milliseconds=0,this},Time.prototype.getOffsetFromReference=function(e){var t;if(!(e instanceof Time))throw new Error("invalid parameter");return t=this.getTotalMilliseconds()-e.getTotalMilliseconds()},Time.prototype.getTotalMilliseconds=function(){return 1e4*(360*this.hours+6*this.minutes+this.seconds)+this.milliseconds},Time.prototype.convertMillisecondsToTime=function(e){return new Time(e)},Time.prototype.isAM=function(){return this.hours<12},Time.prototype.AMPM=function(){return this.isAM()?"AM":"PM"},Time.prototype.padZeroes=function(e){return e=+e,e<10?"0"+e:e},Time.prototype.toString=function(e){var t=this.padZeroes(this.hours),r=this.padZeroes(this.minutes),i="";return e&&(t%=12,0===t&&(t=12),i=this.AMPM()),t+":"+r+i},Time.prototype.toReservationFormat=function(e){var t;return t={hh:this.padZeroes(this.hours%12),mm:this.padZeroes(this.minutes),amPM:this.AMPM()},e?t:t.hh+":"+t.mm+" "+t.amPM},Time.prototype.toHourAndMinute=function(e,t){var r;return"undefined"==typeof t&&(t=12),"undefined"==typeof e&&(e=":"),r={hh:this.padZeroes(this.hours%t),mm:this.padZeroes(this.minutes)},r.hh+e+r.mm},Time.prototype.constructor=Time,String.prototype.toTimeComponent=function(e){var t,r,i=e.indexOf(":");if(i>-1&&(t=e.substr(0,i),i<e.length&&(r=e.substr(i+1))),t&&r)return Time({hours:t,minutes:r})},Date.prototype.toComponents=function(){var e=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],t=["January","February","March","April","May","June","July","August","September","October","November","December"],r=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];return{date:{day:this.getDate(),weekday:e[this.getDay()],month:this.getMonth(),monthName:t[this.getMonth()],monthNameShort:r[this.getMonth()],year:this.getFullYear(),toDateString:function(){return this.year+"-"+(this.month+1)+"-"+(this.day.length<2?"0":"")+this.day},fromDate:function(){var e=this.toLocaleDateString().replace(/\//g,"-").split("-").reverse();return e.shift()+"-"+temp.reverse().join("-")},toShortDateString:function(){return this.monthNameShort+" "+(this.day<10?"0":"")+this.day}},time:new Time({milliseconds:this.getMilliseconds(),seconds:this.getSeconds(),minutes:this.getMinutes(),hours:this.getHours()})}};var Toggle=React.createClass({render:function(){var e=this;return React.DOM.div({className:"switch-button"+("on"===this.props.mode?" on":"")},React.DOM.input({className:"",name:"diary-rooms-showing",id:"diary-rooms-showing",type:"checkbox",checked:void 0,onClick:e.props.__onClick}),React.DOM.label({className:"data-off"},React.DOM.span({className:"value"},"Open"),React.DOM.span({className:"switch-icon"},"All")),React.DOM.label({className:"data-on"},React.DOM.span({className:"switch-icon"},"All"),React.DOM.span({className:"value"},"Open")))}}),GridRowInactive=React.createClass({render:function(){var e=this.props,t=e.data,r=e.display,i="occupancy-block",a="occupied",o=r.px_per_ms,n=(r.px_per_int,r.x_n),s=t.startTime,l=t.endTime,u=(l-s)*o,c="OUT_OF_ORDER"===t.status,a=a+(c?" ooo":" oos"),d=c?"OUT OF ORDER":"OUT OF SERVICE";return React.DOM.div({className:i,style:{display:"block",left:(s-n)*o+"px"}},React.DOM.span({className:a,style:{width:u+"px"}},d))}}),TogglePanel=React.createClass({__onClick:function(e){var t=this,r="on"===this.state.mode?"off":"on";this.setState({mode:r},function(){t.props.__toggleRows(r)}),e.preventDefault(),e.stopPropagation()},getInitialState:function(){return{mode:"on"}},shouldComponentRender:function(e,t){return this.state.mode!==t.mode},render:function(){var e=this,t=null;return this.props.eventsCount&&this.props.eventsCount>0&&(t=React.DOM.button({className:"button white events-button",onClick:e.props.showEventsPopup},React.DOM.span({className:"events-count"},this.props.eventsCount)," Events")),React.DOM.div({className:"diary-toggle"},t,React.createElement(Toggle,{mode:this.state.mode,__onClick:e.__onClick}))}}),GridRowItemDrag=React.createClass({_update:function(e){return _.extend({},e)},__dbMouseMove:void 0,componentWillMount:function(){this.__dbMouseMove=_.debounce(this.__onMouseMove,1)},componentWillUnmount:function(){this._removeEventListeners(!0)},isInProperDraggingCycle:!1,__onMouseDown:function(e){var t,r,i=this.props,a=(this.state,i.display);this.isInProperDraggingCycle=!0,e.stopPropagation(),e.preventDefault(),e=e.changedTouches?e.changedTouches[0]:e,this._setMoveEventListners(),t=this.getDOMNode().getBoundingClientRect(),r=i.viewport.element(),this.mouseClickedColOnStarting=Math.floor(Math.abs(i.iscroll.grid.x-(e.pageX-this.__roomListingAreaWidth))/a.px_per_int),this.reservationTimeStartColNumber=parseFloat(this.props.style.left)/a.px_per_int,this.startingRowNumber=Math.floor((e.pageY-i.iscroll.grid.y-i.viewport.element().offset().top)/(a.row_height+a.row_height_margin)),this.setState({mouse_down:!0,selected:!0,element:r.parent(),origin_x:e.pageX,origin_y:e.pageY,offset_x:r.offset().left+i.iscroll.grid.x,offset_y:r.offset().top+i.iscroll.grid.y,element_x:t.left-i.display.x_0-i.iscroll.grid.x,element_y:t.top,currentClickedCol:this.mouseClickedColOnStarting},function(){i.iscroll.grid.disable(),i.iscroll.timeline.disable()})},__onMouseMove:function(e){if(e.stopPropagation(),e.preventDefault(),this.isInProperDraggingCycle){e=e.changedTouches?e.changedTouches[0]:e;var t,r=this.state,i=this.props,a=i.viewport.element(),o=i.display,n=o.px_per_ms,s=e.pageX-r.origin_x,l=e.pageY-r.origin_y-r.offset_y,u=e.pageY-i.iscroll.grid.y-a.offset().top,c=o.row_height+o.row_height_margin,d=o.x_n instanceof Date?o.x_n.getTime():o.x_n,p=9e5,m=i.iscroll.grid,_=Math.floor(u/c),v=Math.floor(Math.abs(m.x-(e.pageX-this.__roomListingAreaWidth))/o.px_per_int);if((i.edit.active||i.edit.passive)&&!(i.edit.active&&i.data.key!==i.currentDragItem.key||v<0||v/4>o.hours||_<0||_>o.total_rows-1||"reserved"!==i.currentDragItem.reservation_status&&"inhouse"!==i.currentDragItem.reservation_status&&"check-in"!==i.currentDragItem.reservation_status))if(!r.dragging&&Math.abs(s)+Math.abs(l)>10)t=this._update(i.currentDragItem),this.isMounted()&&this.setState({dragging:!0,currentDragItem:t,left:parseFloat(this.reservationTimeStartColNumber*o.px_per_int)},function(){i.__onDragStart(i.row_data,t)});else if(r.dragging){t=i.currentDragItem;var h=m.x,f=m.y,g=this.getDOMNode().offsetWidth;if(v-this.mouseClickedColOnStarting>0){var y=parseFloat(e.pageX)+Math.abs(m.maxScrollX)/4>window.innerWidth;if(y){var D=(v-r.currentClickedCol)*o.px_per_int;h-=D,h<m.maxScrollX&&(h=m.maxScrollX)}}else if(v-this.mouseClickedColOnStarting<0){var R=parseFloat(e.pageX)-parseFloat(g)-parseFloat(g)/4<=0;if(R){var D=(v-r.currentClickedCol)*o.px_per_int;h-=D,h>0&&(h=0)}}if(_-this.startingRowNumber<0){var S=parseFloat(e.pageY)-3*c<=i.viewport.element().offset().top;if(Math.abs(v-this.mouseClickedColOnStarting)<3&&(v=this.mouseClickedColOnStarting),S){var D=(parseFloat(_)-parseFloat(this.startingRowNumber))*parseFloat(c);f=parseFloat(f)-parseFloat(D),f>0&&(f=0)}}else if(_-this.startingRowNumber>0){var M=parseFloat(e.pageY)+3*c>=window.innerHeight;if(Math.abs(v-this.mouseClickedColOnStarting)<3&&(v=this.mouseClickedColOnStarting),M){var D=(parseFloat(_)-parseFloat(this.startingRowNumber))*parseFloat(c);f=parseFloat(f)-parseFloat(D),f<m.maxScrollY&&(f=m.maxScrollY)}}var w=(this.reservationTimeStartColNumber+v-this.mouseClickedColOnStarting)*o.px_per_int,I=_*c;if("inhouse"===i.currentDragItem.reservation_status)w=(r.element_x/o.px_per_int).toFixed()*o.px_per_int;else{var P=((w/n+d)/p).toFixed(0)*p,b=P-t.arrival;t.arrival=P,t.departure=t.departure+b}this.isMounted()&&this.setState({currentClickedCol:v,currentResizeItem:t,resizing:!0,left:parseFloat(w),top:I},function(){i.__onResizeCommand(t),m.maxScrollX<=h&&h<=0&&m.maxScrollY<=f&&f<=0&&(m.scrollTo(h,f,0),m._scrollFn())})}}},__onMouseUp:function(e){e.stopPropagation(),e.preventDefault(),e=e.changedTouches?e.changedTouches[0]:e;var t=this.state,r=this.props,i=this.state.currentDragItem,a=r.display;e.pageX-t.origin_x,a.x_n instanceof Date?a.x_n.getTime():a.x_n,a.px_per_int,a.px_per_ms;this._removeEventListeners(!1);this.getDOMNode().getBoundingClientRect();if(!t.dragging||!r.edit.active||r.data.key===r.currentDragItem.key)if(this.isInProperDraggingCycle=!1,t.dragging)this.isMounted()&&(this.reservationTimeStartColNumber=parseFloat(t.left)/a.px_per_int,this.setState({dragging:!1,currentDragItem:void 0},function(){r.iscroll.grid.enable(),r.__onDragStop(e,t.left,t.top,i)}));else if(this.state.mouse_down&&this.isMounted()){this.setState({mouse_down:!1,selected:!t.selected},function(){var e=_.has(t,"selected")?r.data:r.currentDragItem;r.iscroll.grid.enable(),r.iscroll.timeline.enable(),r.angular_evt.onSelect(r.row_data,e,!e.selected,"edit")});var o=r.data,n=r.meta.occupancy.status;"available"===o[n]&&this.props.unassignedRoomList.dropReservation(o.room_id)}},componentWillReceiveProps:function(e){var t=this.props.meta.occupancy.id;this.props.currentDragItem||this.state.currentDragItem||!e.currentDragItem||e.currentDragItem[t]!==this.props.data[t]?this.props.currentDragItem&&!e.currentDragItem&&this.setState({currentDragItem:void 0}):this.setState({currentDragItem:e.currentDragItem})},_hasTouchSupport:function(){var e=!1;try{e=void 0!==navigator.maxTouchPoints?navigator.maxTouchPoints>0&&"ontouchstart"in window:"ontouchstart"in window}catch(t){e="ontouchstart"in window}return e},_removeEventListeners:function(e){try{e&&(document.removeEventListener("touchstart",this.__onMouseDown),document.removeEventListener("mousedown",this.__onMouseDown)),document.removeEventListener("touchend",this.__onMouseUp),document.removeEventListener("mouseup",this.__onMouseUp),document.removeEventListener("mousemove",this.__dbMouseMove),document.removeEventListener("touchmove",this.__dbMouseMove)}catch(e){}},_setMoveEventListners:function(){
document.addEventListener(this.mouseLeavingEvent,this.__onMouseUp),document.addEventListener(this.mouseMovingEvent,this.__dbMouseMove),this.isTouchEnabled&&this.isMouseEnabled&&(document.addEventListener("mouseup",this.__onMouseUp),document.addEventListener("mousemove",this.__dbMouseMove))},_setClickEventListners:function(){var e=this.getDOMNode();this.isTouchEnabled=this._hasTouchSupport(),this.isMouseEnabled="onmousemove"in window,this.mouseStartingEvent=this.isTouchEnabled?"touchstart":"mousedown",this.mouseMovingEvent=this.isTouchEnabled?"touchmove":"mousemove",this.mouseLeavingEvent=this.isTouchEnabled?"touchend":"mouseup",this.isTouchEnabled&&this.isMouseEnabled?(e.addEventListener(this.mouseStartingEvent,this.__onMouseDown),e.addEventListener("mousedown",this.__onMouseDown)):e.addEventListener(this.mouseStartingEvent,this.__onMouseDown)},componentDidMount:function(){this._removeEventListeners(!0),this._setClickEventListners()},getInitialState:function(){return{dragging:!1,mouse_down:!1,selected:!1}},render:function(){var e=this.props,t=this.state,r=e.style,i=(e.display.x_n instanceof Date?e.display.x_n.getTime():e.display.x_n,"");return t.dragging?(r={position:"fixed",left:t.left,top:t.top},i=" dragstate"):i="",this.__roomListingAreaWidth=120,React.DOM.div({style:r,className:e.className+i,children:e.children})}}),GridRowItem=React.createClass({getInitialState:function(){return{editing:this.props.edit.active,resizing:this.props.resizing,currentResizeItem:this.props.currentResizeItem,currentResizeItemRow:this.props.currentResizeItemRow,isDragOver:!1}},componentDidMount:function(){},componentWillReceiveProps:function(e){var t=this.props.meta.occupancy.id,r=e.edit,i=r.active;i&&r.originalItem[t]===e.data[t]?this.setState({editing:!0,resizing:!0,currentResizeItem:e.currentResizeItem,currentResizeItemRow:e.currentResizeItemRow}):!i&&e.currentResizeItem&&e.currentResizeItem[t]===e.data[t]?this.setState({editing:e.edit.active,resizing:!0,currentResizeItem:e.currentResizeItem,currentResizeItemRow:e.currentResizeItemRow}):(!this.props.edit.active&&this.props.currentResizeItem&&!e.currentResizeItem||this.props.edit.active&&!i)&&this.setState({editing:!1,resizing:!1,currentResizeItem:void 0,currentResizeItemRow:void 0})},componentWillUnmount:function(){},__formInnerText:function(e,t){var r,i,a=this.props;a.display;try{var o=a.unassignedRoomList.dragData;i=!(!_.isEmpty(o)&&!o.is_hourly)}catch(e){i=!0}switch(e[t.status]){case"available":r=i?e.rate_currency+" "+parseFloat(e[t.rate]).toFixed(2)+" | "+e[t.room_type]:e[t.room_type];break;case"blocked":r="Web Booking In Progress";break;default:r=e[t.guest],r||(r=e[t.tr_ag_name]?e[t.tr_ag_name]:e[t.cmp_name]),_.isEmpty(e[t.accompanying_guests])||(r+="  |  ",_.each(e[t.accompanying_guests],function(e,t,i){r+=e.guest_name,t!==i.length-1&&(r+=", ")}))}return r},__formHouseKeepingStyle:function(e,t,r,i){var a,o={},n=9e5;return o.width=e[r.maintenance]*t.px_per_int+"px",a=e[r.maintenance]*n+i,a>t.x_p&&(i>t.x_p||!e.is_hourly?o.display="none":o.width=(t.x_p-i)*t.px_per_ms+"px"),o},__get_class_for_reservation_span:function(){var e=this.props,t=this.state,r=e.data,i=e.meta.occupancy,a="available"===r[i.status],o=a?"":"occupied ";switch(o+=t.editing?" editing":"",o+=a&&r.selected||a&&this.state.isDragOver?" reserved":"",r[i.status]){case"reserved":o+=" check-in";break;case"checking_in":o+=" check-in ";break;case"checkedin":o+=" inhouse ";break;case"checkedout":o+=" check-out ";break;case"checking_out":o+=" departed ";break;case"noshow":o+=" no-show ";break;default:o+=" "+r[i.status]}return r.cannot_move_room&&(o+=" locked"),"undefined"==typeof r.is_hourly||r.is_hourly||(o+=" occupied"),o},render:function(){var e=this.props,t=this.state,r=e.display,i=r.px_per_ms,a=r.px_per_int,o=r.x_n,n=e.data,s=e.row_data,l=e.meta.occupancy,u=t.resizing?t.currentResizeItem[l.start_date]:n[l.start_date],c=t.resizing?t.currentResizeItem[l.end_date]:n[l.end_date],d=(n[l.maintenance]*a,(c-u)*i),p=this.__formInnerText(n,l),m=this.__formHouseKeepingStyle(n,r,l,c),_=(u-o)*i+"px",v=n.is_balance_present,h=n.cannot_move_room,f="undefined"!=typeof n.is_hourly&&!n.is_hourly,g=n.is_vip,y=("check-in"===n.reservation_status||"reserved"===n.reservation_status)&&v,D="occupancy-block"+(t.editing?" editing":"")+(y?" deposit-required":"");t.editing&&f&&(D+=" disable-element"),t.editing&&(u=t.currentResizeItem[l.start_date],c=t.currentResizeItem[l.end_date],_=(u-o)*i+"px");var R=new Date(u),S=r.x_n instanceof Date?r.x_n:new Date(r.x_n);if(!S.isOnDST()&&R.isOnDST()){var M=new Date(u);M.setMinutes(M.getMinutes()+M.getDSTDifference()),_=(M.getTime()-o)*i+"px"}else if(S.isOnDST()&&!R.isOnDST()){var M=new Date(u);M.setMinutes(M.getMinutes()+M.getDSTDifference()),_=(M.getTime()-o)*i+"px",M.isOnDST()&&(_=(M.getTime()+36e5-o)*i+"px")}var w={},I={},P={};return y||(w.display="none",w.width="0px"),this.props.data.is_hourly||(I.display="none",I.width="0px"),this.props.data.is_hourly&&(P.display="none",P.width="0px"),React.createElement(GridRowItemDrag,{key:n.key,className:D,row_data:s,meta:e.meta,data:n,rateCurrency:n.rate_currency,display:r,viewport:e.viewport,edit:e.edit,unassignedRoomList:e.unassignedRoomList,iscroll:e.iscroll,angular_evt:e.angular_evt,__onDragStart:e.__onDragStart,__onDragStop:e.__onDragStop,__onResizeCommand:e.__onResizeCommand,show_outstanding_indicator:y,is_room_locked:h,isNightlyReservation:f,currentDragItem:e.currentResizeItem,style:{left:_,opacity:"1"},__setDragOver:function(e){this.__setDragOver(e)}.bind(this)},React.DOM.span({className:this.__get_class_for_reservation_span(),style:{width:d+"px"}},React.DOM.span({className:"name"},p,React.DOM.span({className:f?"reservation-type":"",style:P},f?"(N)":""),""),React.DOM.span({className:y?"deposit-icon":"",style:w},n.rate_currency),React.DOM.span({className:h?"icons icon-diary-lock":"",style:I},""),React.DOM.span({className:g?"vip":"",style:I},g?"VIP":"")),React.DOM.span({className:"maintenance",style:m}," "))}}),GridRow=React.createClass({shouldComponentUpdate:function(e,t){var r=!0;return r},componentDidMount:function(){$(ReactDOM.findDOMNode(this)).droppable()},render:function(){for(var e=this.props,t=e.display,r=t.px_per_hr+"px",i=[],a=e.meta.room,o=a.row_children,n=a.inactive_slots,s=[],l=0,u=t.hours;l<u;l++)i.push(React.DOM.span({className:"hour",style:{width:r}}));return _.each(e.data[n],function(r){s.push(React.createElement(GridRowInactive,{data:r,display:t,viewport:e.viewport}))}),React.DOM.li({key:e.key,className:e.data.is_available_for_day_use?"grid-row":"grid-row unavailable disable-element"},i,s,_.map(e.data[o],function(r){return React.createElement(GridRowItem,{key:r.key,display:t,viewport:e.viewport,filter:e.filter,edit:e.edit,iscroll:e.iscroll,angular_evt:e.angular_evt,meta:e.meta,data:r,row_data:e.data,row_offset:e.row_number*(t.row_height+t.row_height_margin),__onDragStart:e.__onDragStart,__onDragStop:e.__onDragStop,__onResizeCommand:e.__onResizeCommand,currentResizeItem:e.currentResizeItem,currentResizeItemRow:e.currentResizeItemRow,unassignedRoomList:e.unassignedRoomList})}))},__onDrop:function(e,t){var r=this.getDOMNode().querySelectorAll("[data-reactid='"+t+"']");r[0].className="hour",console.log(this.getDOMNode());var i=!0;this.props.angular_evt.saveReservationOnDrop(reservation,roomDetails,i)},__onDragOver:function(e,t){e.preventDefault();var r=this.getDOMNode().querySelectorAll("[data-reactid='"+t+"']");r[0].className="hour drag-over"},__onDragLeave:function(e,t){e.preventDefault();var r=this.getDOMNode().querySelectorAll("[data-reactid='"+t+"']");r[0].className="hour"}}),Room=React.createClass({shouldComponentUpdate:function(e,t){var r=this.props.meta.room.hk_status;return this.props.data[r]!==e.data[r]},showRoomStatusUpdatePopup:function(){this.props.showRoomStatusAndServiceUpdatePopup(this.props.data)},render:function(){var e=this.props,t=e.meta.room,r=this;return React.DOM.li({className:"room-title"+(""!==e.data[t.hk_status]?" "+this.props.data[t.hk_status]:"")},React.DOM.span({className:"number",onClick:r.showRoomStatusUpdatePopup},e.data[t.number]),React.DOM.span({className:"type"},e.data[t.type]))}}),Rooms=React.createClass({render:function(){var e=this.props;return React.DOM.ul({id:"room-wrapper",className:"wrapper"},_.map(e.data,function(t){return React.createElement(Room,{meta:e.meta,data:t,showRoomStatusAndServiceUpdatePopup:e.showRoomStatusAndServiceUpdatePopup})}))}}),RoomPanel=React.createClass({componentDidUpdate:function(){this.props.iscroll.rooms.refresh()},componentDidMount:function(){var e=this.props.iscroll;e.rooms=new IScroll("#diary-rooms",{probeType:2,scrollbars:"custom",interactiveScrollbars:!0,scrollX:!1,scrollY:!0,momentum:!1,bounce:!1,mouseWheel:!1,useTransition:!0}),e.rooms._scrollFn=_.throttle(this.props.__onGridScroll.bind(null,e.rooms),10,{leading:!1,trailing:!0}),e.rooms.on("scroll",e.rooms._scrollFn),setTimeout(function(){e.rooms.refresh()},0)},componentWillUnmount:function(){this.props.iscroll.rooms.destroy(),this.props.iscroll.rooms=null},render:function(){var e=this.props;return React.DOM.div({id:"diary-rooms",className:"diary-rooms scrollable"},React.createElement(Rooms,{display:e.display,meta:e.meta,data:e.data,showRoomStatusAndServiceUpdatePopup:e.showRoomStatusAndServiceUpdatePopup}))}}),Grid=React.createClass({componentDidUpdate:function(){this.props.iscroll.grid.refresh()},componentDidMount:function(){var e=this.props.iscroll;e.grid=new IScroll($(".diary-grid")[0],{probeType:2,scrollbars:"custom",interactiveScrollbars:!0,scrollX:!0,scrollY:!0,bounce:!1,momentum:!1,preventDefaultException:{className:/(^|\s)(occupied|available|reserved)(\s|$)/},mouseWheel:!0,useTransition:!0,disablePointer:!0}),e.grid._scrollFn=_.throttle(this.props.__onGridScroll.bind(null,e.grid),10,{leading:!1,trailing:!0}),e.grid.on("scroll",e.grid._scrollFn),e.grid.on("scrollEnd",this.props.__onGridScrollEnd),setTimeout(function(){e.grid.refresh()},1e3)},componentWillUnmount:function(){this.props.iscroll.grid.destroy(),this.props.iscroll.grid=null},render:function(){var e=this.props,t=e.display,r=t.width+"px";return React.DOM.div({id:"diary-grid",className:"diary-grid scrollable"},React.DOM.ul({className:"wrapper",style:{width:r}},_.map(this.props.data,function(r,i){return React.createElement(GridRow,{key:r.key,data:r,row_number:i,display:t,viewport:e.viewport,filter:e.filter,meta:e.meta,edit:e.edit,iscroll:e.iscroll,angular_evt:e.angular_evt,currentResizeItem:e.currentResizeItem,currentResizeItemRow:e.currentResizeItemRow,unassignedRoomList:e.unassignedRoomList,__onResizeCommand:e.__onResizeCommand,__onDragStart:e.__onDragStart,__onDragStop:e.__onDragStop})})))}}),TimelineResizeGrip=React.createClass({__dbMouseMove:void 0,__onMouseDown:function(e){var t,r=this.props;e.stopPropagation(),e.preventDefault(),e=e.changedTouches?e.changedTouches[0]:e,r.iscroll.timeline.disable(),this._setMoveEventListners(),t=ReactDOM.findDOMNode(this).getBoundingClientRect(),this.setState({mouse_down:!0,origin_x:e.pageX,element_x:t.left-r.display.x_0-r.iscroll.grid.x}),r.reservatonFlow.cannotResizeDuration()?r.reservatonFlow.showNotAllowedMsg():(document.addEventListener(this.mouseLeavingEvent,this.__onMouseUp),document.addEventListener(this.mouseMovingEvent,this.__onMouseMove))},__onMouseMove:function(e){e.stopPropagation(),e.preventDefault(),e=e.changedTouches?e.changedTouches[0]:e;var t,r=this.props,i=this.state,a=r.display,o=e.pageX-i.origin_x,n=a.x_n instanceof Date?a.x_n.getTime():a.x_n,s=(a.px_per_int,a.px_per_ms),l=i.currentResizeItem,u=r.itemProp,c=9e5*(((i.element_x+o)/s+n)/9e5).toFixed(),d="departure"===u?"arrival":"departure",p=this.__whetherResizable(d,c);p||(c=l[u]),!i.resizing&&i.mouse_down&&Math.abs(o)>10?(this.setState({resizing:!0,currentResizeItem:l},function(){this.props.__onResizeStart(void 0,l)}),this.props.__onResizeCommand(l)):i.resizing&&(t=l[u],l[u]=c,this.setState({currentResizeItem:l},function(){r.__onResizeCommand(l)}))},__onMouseUp:function(e){e.stopPropagation(),e.preventDefault(),e=e.changedTouches?e.changedTouches[0]:e;var t=this.props,r=this.state,i=t.display,a=(e.pageX-r.origin_x,i.px_per_int,i.px_per_ms,i.x_n,r.currentResizeItem);t.meta.occupancy,t.itemProp;this._removeEventListeners(!1),this.state.resizing&&(t.iscroll.timeline.enable(),setTimeout(function(){t.iscroll.timeline.refresh()},250),this.setState({mouse_down:!1,resizing:!1,currentResizeItem:a},function(){t.__onResizeEnd(r.row,a),t.__onResizeCommand(a)}))},__whetherResizable:function(e,t){var r=this.props,i=this.state,a=i.currentResizeItem,o=r.itemProp.toUpperCase(),n=9e5,s=a.reservation_status.toUpperCase(),l="departure"===e?a[e]-t:t-a[e];return!(l<n)&&("RESERVED"===s||"CHECK-IN"===s||"AVAILABLE"===s||("INHOUSE"===s||"CHECK-OUT"===s)&&"DEPARTURE"===o)},getDefaultProps:function(){return{handle_width:50}},getInitialState:function(){return{stop_resize:!1,resizing:!1,mode:void 0,mouse_down:!1,currentResizeItem:this.props.currentResizeItem,currentResizeItemRow:this.props.currentResizeItemRow}},componentWillMount:function(){this.__dbMouseMove=_.throttle(this.__onMouseMove,10)},componentWillUnmount:function(){this._removeEventListeners(!0)},_hasTouchSupport:function(){var e=!1;try{e=void 0!==navigator.maxTouchPoints?navigator.maxTouchPoints>0&&"ontouchstart"in window:"ontouchstart"in window}catch(t){e="ontouchstart"in window}return e},_removeEventListeners:function(e){try{e&&(document.removeEventListener("touchstart",this.__onMouseDown),document.removeEventListener("mousedown",this.__onMouseDown)),document.removeEventListener("touchend",this.__onMouseUp),document.removeEventListener("mouseup",this.__onMouseUp),document.removeEventListener("mousemove",this.__onMouseMove),document.removeEventListener("touchmove",this.__onMouseMove)}catch(e){}},_setMoveEventListners:function(){document.addEventListener(this.mouseLeavingEvent,this.__onMouseUp),document.addEventListener(this.mouseMovingEvent,this.__onMouseMove),this.isTouchEnabled&&this.isMouseEnabled&&(document.addEventListener("mouseup",this.__onMouseUp),document.addEventListener("mousemove",this.__onMouseMove))},_setClickEventListners:function(){var e=this.getDOMNode();this.isTouchEnabled=this._hasTouchSupport(),this.isMouseEnabled="onmousemove"in window,this.mouseStartingEvent=this.isTouchEnabled?"touchstart":"mousedown",this.mouseMovingEvent=this.isTouchEnabled?"touchmove":"mousemove",this.mouseLeavingEvent=this.isTouchEnabled?"touchend":"mouseup",this.isTouchEnabled&&this.isMouseEnabled?(e.addEventListener(this.mouseStartingEvent,this.__onMouseDown),e.addEventListener("mousedown",this.__onMouseDown)):e.addEventListener(this.mouseStartingEvent,this.__onMouseDown)},componentDidMount:function(){this._removeEventListeners(!0),this._setClickEventListners()},componentWillReceiveProps:function(e){var t,r=this.props,i=(this.state,r.display),a=(this.props.itemProp,i.px_per_ms),o=i.x_n,n=r.meta.occupancy;if(!this.state.resizing)if(!r.currentResizeItem&&e.currentResizeItem)if(t=e.currentResizeItem,e.edit.passive){this.setState({mode:t[r.meta.occupancy.id],currentResizeItem:t,currentResizeItemRow:t[r.meta.occupancy.id]});var s=(t[n.start_date]-o-72e5)*a;s<0&&(s=0),r.iscroll.grid.scrollTo(-s,0,0,1e3),r.iscroll.timeline.scrollTo(-s,0,0,1e3),r.iscroll.rooms.scrollTo(0,r.iscroll.rooms.y,0,1e3),r.iscroll.rooms._scrollFn(),r.iscroll.rooms.refresh()}else this.setState({mode:void 0,currentResizeItem:t,currentResizeItemRow:e.currentResizeItemRow});else this.props.currentResizeItem&&!e.currentResizeItem?this.setState({mode:void 0,currentResizeItem:void 0,currentResizeItemRow:void 0}):this.props.currentResizeItem&&e.currentResizeItem&&this.setState({mode:void 0,currentResizeItem:e.currentResizeItem,currentResizeItemRow:e.currentResizeItemRow})},render:function(){var e=this.props,t=e.itemProp,r=this.state.currentResizeItem,i=e.display.x_n instanceof Date?e.display.x_n.getTime():e.display.x_n,a=e.display.px_per_ms,o="arrival"===t?"ARRIVE":"DEPART",n="arrival"===t?"arrival":"departure",s=r?(r[t]-i)*a:0,l=(e.meta.availability_count.total>0&&e.meta.availability_count.total,"set-times "+n),u="";if(r){var c=new Date(r[t]);u=c.toComponents().time.toString(!0);var d=e.display.x_n instanceof Date?e.display.x_n:new Date(e.display.x_n);if(d.isOnDST()===!1&&c.isOnDST()===!0){var p=new Date(r[t]);p.setMinutes(p.getMinutes()+p.getDSTDifference()),s=(p.getTime()-i)*a}else if(d.isOnDST()===!0&&c.isOnDST()===!1){var p=new Date(r[t]);p.setMinutes(p.getMinutes()+p.getDSTDifference()),s=(p.getTime()-i)*a,p.isOnDST()&&(s=(p.getTime()+36e5-i)*a)}}return this.props.edit.active&&(l+=" editing",this.props.edit.originalItem.is_hourly||(l+=" disable-element")),React.DOM.div({className:l,style:{left:s+"px"}},React.DOM.span({className:"title"},React.DOM.span({},o),React.DOM.span({className:"time"},u)),React.DOM.span({className:"line",style:{display:this.props.edit.active?"inline":"none"}}))}}),Resizable=React.createClass({render:function(){var e=(this.props.handle_width*this.props.display.px_per_ms,this.props);return React.DOM.div({className:"stay-range",style:{display:e.edit.active||e.edit.passive?"block":"none"}},React.createElement(TimelineResizeGrip,{key:"resize-left-00",display:e.display,iscroll:e.iscroll,itemProp:"arrival",filter:e.filter,edit:e.edit,meta:e.meta,__onResizeCommand:e.__onResizeCommand,__onResizeStart:e.__onResizeStart,__onResizeEnd:e.__onResizeEnd,currentResizeItem:e.currentResizeItem,currentResizeItemRow:e.currentResizeItemRow,reservatonFlow:e.reservatonFlow}),React.createElement(TimelineResizeGrip,{key:"resize-right-01",display:e.display,iscroll:e.iscroll,filter:e.filter,itemProp:"departure",edit:e.edit,meta:e.meta,__onResizeCommand:e.__onResizeCommand,__onResizeStart:e.__onResizeStart,__onResizeEnd:e.__onResizeEnd,currentResizeItem:e.currentResizeItem,currentResizeItemRow:e.currentResizeItemRow,reservatonFlow:e.reservatonFlow}))}}),TimelineOccupancy=React.createClass({shouldComponentUpdate:function(e){return this.props.display!==e.display},render:function(){var e=this.props,t=e.display.px_per_hr+"px";return React.DOM.ul({className:"occupancy"},_.map(e.data,function(e){return React.DOM.li({style:{width:t}},e.count)}))}}),Timeline=React.createClass({__get_property_time_line_showing_point:function(){var e,t,r,i,a,o,n=this.props,s=n.display,l=s.property_date_time.start_date,u=s.x_n instanceof Date?s.x_n.getTime():s.x_n,c=s.x_p instanceof Date?s.x_p.getTime():s.x_p,d=-1;return u<=l<=c&&(e=c-u,t=l-u,r=e/(s.hours*s.intervals_per_hour),d=t/r,d++,i=new Date(u),a=new Date(l),o=a.getTimezoneOffset()-i.getTimezoneOffset(),d+=o/(60/s.intervals_per_hour)),d},__get_date_for_timeline_displaying:function(e){return e.toComponents().date.weekday+" - "+e.toComponents().date.toShortDateString()},render:function(){var e,t,r,i,a,o,n,s=this.props,l=(this.state,s.display),u=[],c=[],d=l.px_per_int+"px",p=l.px_per_hr+"px",m=(l.x_n_time,this.__get_property_time_line_showing_point()),_=s.filter.arrival_date,v=new tzIndependentDate(_.valueOf()),h=new tzIndependentDate(v.setDate(v.getDate()+1)),f=1;for(function(){var e,t,r,i,a=new Date(s.filter.arrival_date);for(a.setHours(0,0,0,0),r=0,i=l.hours;r<i;r++)e=new Date(a),e.setHours(e.getHours()-1),t=a.getTimezoneOffset()-e.getTimezoneOffset(),t<0||(t>0?(c.push(e.getHours()+":00"),c.push(a.getHours()+":00")):c.push(a.getHours()+":00")),a.setHours(a.getHours()+1)}(),_ instanceof Date?(a=this.__get_date_for_timeline_displaying(_),o=this.__get_date_for_timeline_displaying(h)):a=o="",t=0,i=l.hours;t<i;t++){for(e=[],e.push(React.DOM.span({className:""},c[t])),t%6===0&&e.push(React.DOM.span({className:"date"},t<23?a:o)),r=0;r<l.intervals_per_hour;r++,f++)n="interval-"+(r+1),f===parseInt(m,10)&&(n+=" active"),e.push(React.DOM.span({className:n,style:{width:d}}));u.push(React.DOM.span({className:"segment",style:{width:p}},e))}return React.DOM.div({className:"wrapper",style:{width:l.width+"px"}},React.DOM.div({className:"hours"},u),React.createElement(Resizable,{display:l,edit:s.edit,filter:s.filter,iscroll:s.iscroll,meta:s.meta,__onResizeCommand:s.__onResizeCommand,__onResizeStart:s.__onResizeStart,__onResizeEnd:s.__onResizeEnd,currentResizeItem:s.currentResizeItem,currentResizeItemRow:s.currentResizeItemRow,reservatonFlow:s.reservatonFlow}))}}),TimelinePanel=React.createClass({componentDidMount:function(){var e=this.props.iscroll;e.timeline=new IScroll("#diary-timeline",{probeType:2,scrollbars:!1,interactiveScrollbars:!1,scrollX:!0,scrollY:!1,momentum:!1,bounce:!1,mouseWheel:!1,useTransition:!0,disablePointer:!0,preventDefaultException:{className:/(^|\s)set-times(\s|$)/}}),e.timeline._scrollFn=_.throttle(this.props.__onGridScroll.bind(null,e.timeline),10,{leading:!1,trailing:!0}),e.timeline.on("scroll",e.timeline._scrollFn),setTimeout(function(){e.timeline.refresh(),_.isNumber(this.props.display.scrollTo)}.bind(this),1e3)},componentWillUnmount:function(){this.props.iscroll.timeline.destroy(),this.props.iscroll.timeline=null},componentWillReceiveProps:function(e){var t=Object.prototype.hasOwnProperty;t.call(this.props,"filter")&&this.props.filter!==e.filter&&this.setState({filter:e.filter})},shouldComponentUpdate:function(e,t){return!!(this.props.viewport!==e.viewport||this.props.display!==e.display||!this.props.currentResizeItem&&e.currentResizeItem||this.props.currentResizeItem||this.props.filter!==e.filter)},render:function(){var e=this.props;return React.DOM.div({id:"diary-timeline",className:"diary-timeline scrollable"},React.DOM.div({id:"timeline-outer-wrapper",className:"outer-wrapper",style:{position:"relative",width:e.display.width+"px"}},React.createElement(Timeline,{display:e.display,iscroll:e.iscroll,filter:e.filter,edit:e.edit,meta:e.meta,__onResizeCommand:e.__onResizeCommand,__onResizeStart:e.__onResizeStart,__onResizeEnd:e.__onResizeEnd,currentResizeItem:e.currentResizeItem,currentResizeItemRow:e.currentResizeItemRow,reservatonFlow:e.reservatonFlow}),React.createElement(TimelineOccupancy,{display:e.display,data:e.stats})))}}),GridPanel=React.createClass({componentDidMount:function(){},render:function(){var e=this.props;return React.createElement(Grid,{viewport:e.viewport,display:e.display,filter:e.filter,edit:e.edit,iscroll:e.iscroll,meta:e.meta,data:e.data,angular_evt:e.angular_evt,currentResizeItem:e.currentResizeItem,currentResizeItemRow:e.currentResizeItemRow,unassignedRoomList:e.unassignedRoomList,__onResizeCommand:e.__onResizeCommand,__onGridScroll:e.__onGridScroll,__onGridScrollEnd:e.__onGridScrollEnd,__onDragStart:e.__onDragStart,__onDragStop:e.__onDragStop})}}),DiaryContent=React.createClass({_recalculateGridSize:function(){var e=_.extend({},this.state.display),t=_.extend({},this.state.viewport),r=this.state.iscroll;t.width=$(window).width()-120,t.height=$(window).height()-230,t.width===this.state.viewport.width&&t.height===this.state.viewport.height||(e.width=e.hours/t.hours*t.width,e.px_per_hr=t.width/t.hours,e.px_per_int=e.px_per_hr/e.intervals_per_hour,e.px_per_ms=e.px_per_int/9e5,this.setState({viewport:t,display:e},function(){})),r.timeline.scrollTo(r.timeline.x,r.timeline.y),r.timeline.refresh(),r.timeline._scrollFn()},__toggleRows:function(e){this.state.angular_evt.toggleRows(e,Math.abs(this.state.iscroll.grid.x)/this.state.display.px_per_ms+this.state.display.x_n)},__onGridScrollStart:function(e){},__onGridScrollEnd:function(e){this.state.angular_evt.onScrollEnd(Math.abs(this.state.iscroll.grid.x)/this.state.display.px_per_ms+this.state.display.x_n)},__onGridScroll:function(e){var t=e,r=this.state.iscroll;switch(t){case r.grid:r.timeline.scrollTo(t.x,0),r.rooms.scrollTo(0,t.y);break;case r.timeline:r.grid.scrollTo(t.x,r.grid.y);break;case r.rooms:r.grid.scrollTo(r.grid.x,t.y)}},__onDragStart:function(e,t){this.state.angular_evt.onDragStart.apply(this,Array.prototype.slice.call(arguments))},__onDragStop:function(e,t,r,i){var a=this.state,o=this.props,n=o.display,s=n.row_height+n.row_height_margin,l=a.viewport.element(),u=e.pageY-a.iscroll.grid.y-l.offset().top,c=Math.floor(u/s),c=c<0?0:c,c=c>n.total_rows-1?n.total_rows-1:c,d=a.data[c];Number((t-i.left).toFixed(3)),e.pageX-a.origin_x,n.x_n instanceof Date?n.x_n.getTime():n.x_n,n.px_per_int,n.px_per_ms;this.setState({currentResizeItem:i,currentResizeItemRow:d}),this.state.angular_evt.onDragEnd(d,i)},__onResizeCommand:function(e){this.setProps({currentResizeItem:e})},__onResizeStart:function(e,t){this.state.angular_evt.onResizeStart.apply(this,Array.prototype.slice.call(arguments))},__onResizeEnd:function(e,t){this.state.angular_evt.onResizeEnd.apply(this,Array.prototype.slice.call(arguments)),this.setProps({currentResizeItem:t,currentResizeItemRow:e})},componentDidUpdate:function(){this.componentWillMount();var e=this.props,t=this.state,r=e.edit.reset_scroll,i=function(){var i=(r.x_origin-r.x_n-72e5)*t.display.px_per_ms;i<0&&(i=0);var a=e.data,o=e.display,n=o.row_height+o.row_height_margin,s=t.edit.active?_.indexOf(_.pluck(a,"id"),e.currentResizeItem.room_id)-2:0,s=s>0?s:0,l=s*n;t.iscroll.timeline.scrollTo(-i,-l,0,0),t.iscroll.grid.scrollTo(-i,-l,0,0),t.iscroll.rooms.scrollTo(0,-l,0,0),t.iscroll.timeline.refresh(),t.iscroll.grid.refresh(),t.angular_evt.onScrollEnd(Math.abs(t.iscroll.grid.x)/t.display.px_per_ms+r.x_n)};!!r&&setTimeout(i,500)},componentDidMount:function(){var e=this;this.state;$(window).on("resize",_.throttle(function(t){e._recalculateGridSize(),setTimeout(function(){e.componentWillMount()},1e3)},10,{leading:!1,trailing:!0})),setTimeout(function(){var t=(e.state.display.x_origin-e.state.display.x_n-72e5)*e.state.display.px_per_ms;t<0&&(t=0),e.state.iscroll.grid.scrollTo(-t,0,0,1e3),e.state.iscroll.timeline.scrollTo(-t,0,0,1e3),e.state.angular_evt.onScrollEnd(Math.abs(e.state.iscroll.grid.x)/e.state.display.px_per_ms+e.state.display.x_n),e.state.angular_evt.completedRendering.apply(e,Array.prototype.slice.call(arguments))},1e3)},componentWillUnmount:function(){$(window).off("resize")},componentWillMount:function(){var e=this;for(var t in this.state.iscroll)Object.prototype.hasOwnProperty.call(this.state.iscroll,t)&&this.state.iscroll[t]instanceof IScroll&&setTimeout(function(){e.state.iscroll[t].refresh()},100)},componentWillReceiveProps:function(e){var t=Object.prototype.hasOwnProperty;t.call(this.props,"stats")&&this.props.stats!==e.stats&&this.setState({stats:e.stats}),t.call(this.props,"data")&&this.props.data!==e.data&&this.setState({data:e.data}),t.call(this.props,"viewport")&&this.props.viewport!==e.viewport&&this.setState({viewport:e.viewport}),t.call(this.props,"display")&&this.props.display!==e.display&&this.setState({display:e.display},function(){this._recalculateGridSize()}),t.call(this.props,"filter")&&this.props.filter!==e.filter&&this.setState({filter:e.filter}),t.call(this.props,"edit")&&this.props.edit!==e.edit&&this.setState({edit:e.edit})},getInitialState:function(){var e=this.props,t=e.scope,r=t.gridProps.viewport,i=t.gridProps.display,a=t.gridProps.filter,o={angular_evt:{onSelect:t.onSelect,isSelected:t.isSelected,isAvailable:t.isAvailable,isDraggable:t.isDraggable,isResizable:t.isResizable,toggleRows:t.toggleRows,displayFilter:t.displayFilter,onDragStart:t.onDragStart,onDragEnd:t.onDragEnd,onResizeStart:t.onResizeStart,onResizeEnd:t.onResizeEnd,onScrollEnd:t.onScrollEnd,onScrollLoadTriggerRight:t.onScrollLoadTriggerRight,onScrollLoadTriggerLeft:t.onScrollLoadTriggerLeft,completedRendering:t.eventAfterRendering,saveReservationOnDrop:t.saveReservationOnDrop,showRoomStatusAndServiceUpdatePopup:t.showRoomStatusAndServiceUpdatePopup,showEventsList:t.showHouseEventsListPopup},currentDragItem:e.currentDragItem,currentResizeItem:e.currentResizeItem,currentResizeItems:e.currentResizeItems,edit:{active:!1,originalItem:void 0,originalRowItem:void 0},iscroll:{timeline:void 0,rooms:void 0,grid:void 0},stats:e.stats,data:e.data};return i.width=i.hours/r.hours*r.width,i.height="100%",i.px_per_hr=r.width/r.hours,i.px_per_int=i.px_per_hr/i.intervals_per_hour,i.px_per_ms=i.px_per_int/9e5,i.x_0=r.row_header_right,i.total_rows=t.gridProps.data.length,i.x_origin_start_time=a.arrival_time,i.scrollTo=(i.x_origin-i.x_n)*i.px_per_ms,_.extend(o,t.gridProps)},render:function(){var e=this,t=this.props,r=this.state;return React.DOM.div({className:"diary-container "+(12===r.viewport.hours?"hours-12":"hours-24")+(r.edit.active?" editing":"")},React.createElement(TogglePanel,{__toggleRows:e.__toggleRows,showEventsPopup:r.angular_evt.showEventsList,eventsCount:t.eventsCount}),React.createElement(RoomPanel,{refs:"rooms",viewport:r.viewport,display:r.display,meta:r.meta,data:r.data,edit:r.edit,filter:r.filter,iscroll:r.iscroll,__onGridScroll:e.__onGridScroll,__onGridScrollEnd:e.__onGridScrollEnd,showRoomStatusAndServiceUpdatePopup:r.angular_evt.showRoomStatusAndServiceUpdatePopup}),React.createElement(TimelinePanel,{refs:"timeline",viewport:r.viewport,display:r.display,data:r.data,stats:r.stats,meta:r.meta,filter:r.filter,edit:r.edit,iscroll:r.iscroll,currentResizeItem:t.currentResizeItem,angular_evt:r.angular_evt,__onResizeCommand:e.__onResizeCommand,__onResizeStart:e.__onResizeStart,__onResizeEnd:e.__onResizeEnd,__onGridScroll:e.__onGridScroll,__onGridScrollEnd:e.__onGridScrollEnd,reservatonFlow:r.reservatonFlow}),React.createElement(GridPanel,{refs:"grid",viewport:r.viewport,display:r.display,filter:r.filter,edit:r.edit,iscroll:r.iscroll,meta:r.meta,data:r.data,currentResizeItem:t.currentResizeItem,currentResizeItemRow:t.currentResizeItemRow,unassignedRoomList:t.unassignedRoomList,angular_evt:r.angular_evt,__onResizeCommand:e.__onResizeCommand,__onGridScroll:e.__onGridScroll,__onGridScrollEnd:e.__onGridScrollEnd,__onDragStart:e.__onDragStart,__onDragStop:e.__onDragStop}))}});