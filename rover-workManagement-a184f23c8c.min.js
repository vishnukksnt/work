function getLengthChangedNumber(e,t){"number"==typeof t&&(t=t.toString());var o=e-t.length;if(o<=0)return t;for(var n="",r=1;r<=o;r++)n+="0";return n+t}angular.module("sntRover").controller("RVWorkManagementSearchDatePickerController",["$scope","$rootScope","ngDialog","dateFilter",function(e,t,o,n){e.setUpData=function(){e.dateOptions={changeYear:!0,changeMonth:!0,maxDate:tzIndependentDate(t.businessDate).addDays(365),minDate:tzIndependentDate(t.businessDate),onSelect:function(t,n){e.onViewDateChanged(),o.close()}}},e.setUpData()}]),angular.module("sntRover").controller("RVWorkManagementCreateDatePickerController",["$scope","$rootScope","ngDialog","dateFilter",function(e,t,o,n){e.setUpData=function(){e.dateOptions={changeYear:!0,changeMonth:!0,minDate:tzIndependentDate(t.businessDate),maxDate:tzIndependentDate(t.businessDate).addDays(365),onSelect:function(t,n){o.close(e.calendarDialog.id)}}},e.setUpData()}]),angular.module("sntRover").controller("RVWorkManagementMultiDatePickerController",["$scope","$rootScope","ngDialog","dateFilter",function(e,t,o,n){e.setUpData=function(){e.dateOptions={changeYear:!0,changeMonth:!0,maxDate:tzIndependentDate(t.businessDate).addDays(365),onSelect:function(t,n){e.onDateChanged(),o.close()}}},e.setUpData()}]),angular.module("sntRover").controller("RVWorkManagementMultiSheetCtrl",["$rootScope","$scope","ngDialog","RVWorkManagementSrv","$state","$stateParams","$timeout","allUnassigned","fetchHKStaffs","allRoomTypes","payload","$window","$filter","sntActivity","$transitions",function(e,t,o,n,r,s,a,i,l,d,c,u,h,m,p){BaseCtrl.call(this,t);var f,g,k=!1,S=null;p.onStart({},function(e){var o=e.from(),n=e.to();if("rover.workManagement.multiSheet"===o.name&&t.workSheetChanged)return m.stop("STATE_CHANGE"+n.name.toUpperCase()),t.$emit("hideLoader"),k=!0,S=function(){t.closeDialog(),t.workSheetChanged=!1,k=!1,r.go(n,e.params())},v(),!1}),t.closeSaveConfirmationDialog=function(e){k?(k=!1,S&&S()):(e&&e.callNextMethod&&t[e.callNextMethod]&&t[e.callNextMethod](),t.closeDialog())},t.closeDialog=function(){t.errorMessage="",o.close()},t.getWidthForWorkSheetContent=function(){return 220*t.multiSheetState.selectedEmployees.length+20+"px"},t.selectEmployee=function(){},t.onEmployeeListOpen=function(){t.multiSheetState.dndEnabled=!1},t.onEmployeeListClosed=function(){t.multiSheetState.dndEnabled=!0;var e=_.where(t.employeeList,{ticked:!0});e=_.pluck(e,"id"),_.difference(e,t.multiSheetState._lastSelectedIds)&&(_.each(t.multiSheetState._selectedIndexMap,function(e,o){t.multiSheetState.assigned[e]=t.multiSheetState.selectedEmployees[o]}),V(),G())},t.filterUnassigned=function(){t.filterUnassignedRooms(t.filters,t.multiSheetState.unassigned,t.multiSheetState.allRooms),t.multiSheetState.unassignedFiltered=t.multiSheetState.unassigned,G(),t.closeDialog()},t.showCalendar=function(e){o.open({template:"/assets/partials/workManagement/popups/rvWorkManagementMultiDateFilter.html",controller:e,className:"ngdialog-theme-default single-date-picker",closeByDocument:!0,scope:t})},t.showFilter=function(){o.open({template:"/assets/partials/workManagement/popups/rvWorkManagementFilterRoomsPopup.html",className:"ngdialog-theme-default",closeByDocument:!0,scope:t})},t.onCancel=function(){$_shouldSaveFirst=!1,r.go("rover.workManagement.start")},t.dropToAssign=function(e,o){function n(e,t,o){var n=e[t],r=o<t?-1:1,s=0;if(o!==t){for(s=t;s!=o;s+=r)e[s]=e[s+r];return e[o]=n,e}}var r,s,a,i,o,l,d,c,u,h,m,p,f=$(o.draggable).attr("id"),g=f.split("-")[1],k=parseInt(f.split("-")[2]),S=parseInt(f.split("-")[3]),v={};"UA"===g?(r=t.multiSheetState.unassignedFiltered,a=r[k],i=a.room_tasks[S]):(r=t.multiSheetState.selectedEmployees,s=r[g],a=s.rooms[k],i=a.room_tasks[S]),o=$(e.target).attr("id"),l=parseInt(o.split("-")[0]),d=t.multiSheetState.selectedEmployees[l],c=_.find(d.rooms,{room_id:a.room_id}),u=_.findIndex(d.rooms,{room_id:a.room_id}),h=[],v={},c?(h=angular.copy(d.rooms),_.find(c.room_tasks,{id:i.id})||h[u].room_tasks.push(i),void 0!==t.dropIndex&&(u>t.dropIndex?n(h,u,t.dropIndex):0===t.dropIndex?n(h,u,t.dropIndex):n(h,u,t.dropIndex-1)),d.rooms=h):(v={room_id:a.room_id,room_type:a.room_type,is_vip:a.is_vip,room_index:a.room_index,room_tasks:[i]},void 0===t.dropIndex||t.dropIndex===d.rooms-1?d.rooms.push(v):0===t.dropIndex?d.rooms.unshift(v):d.rooms=[].concat(d.rooms.slice(0,t.dropIndex),v,d.rooms.slice(t.dropIndex))),parseInt(g)!==l&&(d.only_tasks.push(i),d.touched_work_types.push(i.work_type_id),d.touched_work_types=_.uniq(_.flatten(d.touched_work_types)),"UA"!==g&&(m=_.findIndex(s.only_tasks,function(e){return e.id===i.id&&e.room_id===i.room_id}),m>-1&&s.only_tasks.splice(m,1),p=_.find(s.only_tasks,{work_type_id:i.work_type_id}),p||(s.touched_work_types=_.without(s.touched_work_types,i.work_type_id))),a.room_tasks.splice(S,1),"UA"===g||a.room_tasks.length||s.rooms.splice(k,1)),t.workSheetChanged=!0,G()},t.dropToUnassign=function(e,o){var n=$(o.draggable).attr("id"),r=n.split("-")[1],s=parseInt(n.split("-")[2]),a=parseInt(n.split("-")[3]),i=t.multiSheetState.selectedEmployees,l=t.multiSheetState.unassignedFiltered,d=i[r],c=d.rooms[s],u=c.room_tasks[a],h=_.find(l,{room_id:u.room_id});h?h.room_tasks.push(u):l.push({room_id:c.room_id,room_index:c.room_index,room_tasks:[u],show:!0}),t.filterUnassigned();var m,p;m=_.findIndex(d.only_tasks,function(e){return e.id===u.id&&e.room_id===u.room_id}),m>-1&&d.only_tasks.splice(m,1),p=_.find(d.only_tasks,{work_type_id:u.work_type_id}),p||(d.touched_work_types=_.without(d.touched_work_types,u.work_type_id)),c.room_tasks.splice(a,1),c.room_tasks.length||d.rooms.splice(s,1),t.workSheetChanged=!0,G()},t.onDateChanged=function(){t.workSheetChanged?v({date:t.dateSelected,callNextMethod:"updateView"}):z(!0),t.dateSelected=t.multiSheetState.selectedDate},t.onWorkTypeChanged=function(){t.workTypeSelected=t.multiSheetState.header.work_type_id,G()},t.refreshSheet=function(){t.saveMultiSheet({callNextMethod:"updateView"})};var v=function(e){o.open({template:"/assets/partials/workManagement/popups/rvWorkManagementSaveConfirmationPopup.html",className:"",scope:t,closeByDocument:!1,closeByEscape:!1,data:JSON.stringify(e)})},y=null,w=function(){!k&&y&&t[y.callNextMethod]&&a(t[y.callNextMethod].bind(null,y.nexMethodArgs),50),k&&S&&a(S,60),y=null},D=function(e){t.$emit("hideLoader"),t.clearErrorMessage(),t.workSheetChanged=!1,w()},A=function(e){t.errorMessage=e,t.$emit("hideLoader"),w()};t.saveMultiSheet=function(e){if(_.each(t.multiSheetState._selectedIndexMap,function(e,o){t.multiSheetState.assigned[e]=t.multiSheetState.selectedEmployees[o]}),y=e||null,t.multiSheetState.selectedEmployees.length){var o={successCallBack:D,failureCallBack:A,params:{assignedRoomTasks:t.multiSheetState.assigned,date:e&&e.date||t.multiSheetState.selectedDate,shouldSaveOrder:L()}};L()&&_.each(t.multiSheetState.assigned,function(e){_.each(e.only_tasks,function(t){var o=_.findIndex(e.rooms,{room_id:t.room_id});t.order=o+1})}),t.callAPI(n.saveWorkSheets,o)}else w(e)};var R=function(){$("head").append("<style id='print-orientation'>@page { size: landscape; }</style>")},M=function(){$("#print-orientation").remove()},I=null;t.openPrintWorkSheetPopup=function(){I=angular.copy(t.employeeList),o.open({template:"/assets/partials/workManagement/popups/rvWorkManagementPrintOptionsPopup.html",className:"",scope:t,closeByDocument:!1,closeByEscape:!1})},t.cancelPopupDialog=function(){t.employeeList=angular.copy(I),t.onEmployeeListClosed(),o.close()};var T=function(o){var r=t.multiSheetState;r.selectedEmployees=n.sortAssigned(r.selectedEmployees,r.allRooms,r.allTasks,o);var s=e.$watch(function(){s(),a(x,0)});E()},x=function(){t.$emit("hideLoader");var e=function(){a(function(){M(),t.multiSheetState=angular.copy(C),t.employeeList=angular.copy(I),t.onEmployeeListClosed(),C=null,E()},150)};a(function(){sntapp.cordovaLoaded?cordova.exec(e,function(){e()},"RVCardPlugin","printWebView",["worksheet","0","","L"]):(u.print(),e())},100)},C=null;t.printWorkSheet=function(){t.closeDialog(),a(function(){C=angular.copy(t.multiSheetState),T(t.printSettings);var e;for(e=t.multiSheetState.selectedEmployees.length-1;e>=0;e--)t.$parent.myScroll["assignedRoomList-"+t.multiSheetState.selectedEmployees[e].id].scrollTo(0,0);R()},750)};var E=function(){t.$$phase||t.$digest()},N=function(){e.setPrevState={title:h("translate")("WORK_MANAGEMENT"),name:"rover.workManagement.start"},t.setHeading(h("translate")("WORK_MANAGEMENT"))},O=function(){var e={tap:!0,preventDefault:!1,probeType:3,bounce:!1},o=_.extend({scrollX:!0,scrollY:!1},e),n=_.extend({scrollX:!1,scrollY:!0},e);t.setScroller("unAssignedRoomList",n),t.setScroller("multiSelectWorkSheet",e),t.setScroller("multiSelectPrintPopup",e),t.setScroller("worksheetHorizontal",o);var r=function(e,o,n){for(var r=0;r<o.length;r++)t.setScroller("assignedRoomList-"+o[r].id,n)};r(0,t.employeeList,n)},W=function(){t.refreshScroller("unAssignedRoomList"),t.refreshScroller("worksheetHorizontal");for(var e=0;e<t.employeeList.length;e++)t.refreshScroller("assignedRoomList-"+t.employeeList[e].id)},b=function(){t.$watch("multiSheetState.header.work_type_id",function(e,o){e!==o&&t.onWorkTypeChanged()})},L=function(){return!t.multiSheetState.header.work_type_id},P=function(e){var o,n;o=_.findIndex(t.multiSheetState.assigned,function(t){return t.id==e.id}),o>-1&&(t.multiSheetState.assigned[o].shiftId=e.shift_id,t.multiSheetState.selectedEmployees.push(t.multiSheetState.assigned[o]),n=t.multiSheetState.selectedEmployees.length-1,t.multiSheetState._selectedIndexMap[n]=o,t.multiSheetState._lastSelectedIds.push(t.multiSheetState.assigned[o].id))},U=function(e){t.multiSheetState.selectedEmployees=[],t.multiSheetState._selectedIndexMap={},t.multiSheetState._lastSelectedIds=[],l&&(t.employeeList=l.results);var o=!1;_.each(t.employeeList,function(t){e?(o=e.indexOf(t.id)>-1,o&&(t.ticked=!0,P(t))):(t.ticked=!0,P(t))})},V=function(){t.multiSheetState.selectedEmployees=[],t.multiSheetState._selectedIndexMap={},t.multiSheetState._lastSelectedIds=[],_.each(t.employeeList,function(e){e.ticked&&P(e)})},F=function(){var e=_.where(t.employeeList,{ticked:!0});return e=_.pluck(e,"id")},B=function(e){var o={};_.each(e.rooms,function(e){var o=[];_.each(e.room_tasks,function(e){"COMPLETED"!==e.status&&"IN_PROGRESS"!==e.status?t.multiSheetState.header.work_type_id&&e.work_type_id!=t.multiSheetState.header.work_type_id&&o.push(e):o.push(e)}),e.room_tasks=o});var n=[];return _.each(e.only_tasks,function(e){o[e.room_id]||(o[e.room_id]=[]),"COMPLETED"!==e.status&&"IN_PROGRESS"!==e.status?t.multiSheetState.header.work_type_id?e.work_type_id==t.multiSheetState.header.work_type_id?o[e.room_id].push(e):n.push(e):o[e.room_id].push(e):n.push(e)}),e.only_tasks=n,o},H=function(e,t){_.each(e,function(e){t[e.room_id]&&(e.room_tasks=e.room_tasks.concat(t[e.room_id]))})},J=function(e){if(m.stop("RELOAD_WORKSHEET"),g&&t.workSheetChanged){var o=_.find(c.assignedRoomTasks,{id:g}),n=B(o);H(c.unassignedRoomTasks,n)}else c=e,t.workSheetChanged=!1;q(!1),U(F()),t.filterUnassigned(),G(),g=null},j=function(e){m.stop("RELOAD_WORKSHEET"),t.errorMessage=e},z=function(){m.start("RELOAD_WORKSHEET");var e={date:t.multiSheetState.selectedDate},o={date:t.multiSheetState.selectedDate,employee_ids:l.emp_ids};n.processedPayload(e,o).then(J,j)},G=function(){Y(),E(),O(),W()},K=function(e){var o,n,r,s,a,i={tasksAssigned:0,tasksCompleted:0,timeAllocated:"00:00",shiftLength:"00:00"};a=_.findWhere(t.shifts,{id:e.shiftId}),i.shiftLength=a&&a.time||"00:00";var l;for(l=e.rooms.length-1;l>=0;l--)o=e.rooms[l].room_tasks,n=_.where(o,{is_completed:!0})||[],r=_.reduce(o,function(e,o){return s=o.time_allocated,t.addDuration(e,s.hh+":"+s.mm)},"0:0"),i.tasksAssigned+=o.length,i.tasksCompleted+=n.length,i.timeAllocated=t.addDuration(i.timeAllocated,r);return i},Y=function(e){var o=t.multiSheetState;if("number"==typeof e){var n=_.findWhere(o.assigned,{id:e});o.summary[e]=K(n)}else _.each(o.assigned,function(e){o.summary[e.id]=K(e)})};t.updateView=z;var q=function(o){t.multiSheetState=$.extend({},{unassigned:c.unassignedRoomTasks,assigned:c.assignedRoomTasks,allTasks:c.allTasks,allRooms:c.allRooms},{unassignedFiltered:[],_unassignIndexMap:{}},{selectedEmployees:[],_selectedIndexMap:{},_lastSelectedIds:[]},{dndEnabled:!0,selectedDate:s.filterParams&&s.filterParams.selectedDate||t.dateSelected||s.date||e.businessDate,summary:{},header:{work_type_id:s.filterParams&&s.filterParams.worktype_id||t.workTypeSelected||""}}),o&&(t.filters={selectedFloor:"",selectedReservationStatus:"",selectedFOStatus:"",vipsOnly:!1,showAllRooms:!1,checkin:{after:{hh:"",mm:"",am:"AM"},before:{hh:"",mm:"",am:"AM"}},checkout:{after:{hh:"",mm:"",am:"AM"},before:{hh:"",mm:"",am:"AM"}}}),s.filterParams&&(s.filterParams.selectedDate=null)},X=function(){t.dateSelected=t.multiSheetState.selectedDate,t.workTypeSelected=t.multiSheetState.header.work_type_id,t.workSheetChanged=!1,t.printSettings={grouping:"room",sort:"asc",employees:1}},Q=function(){W()},Z=t.$on("ALL_RENDER_COMPLETE",Q);t.$on("$destroy",Z),t.getReservationStatusClass=function(e){if(angular.isUndefined(e))return"guest";switch(e.reservation_status){case"Due out":case"Arrived / Day use / Due out":case"Arrived / Day use / Due out / Departed":case"Due out / Arrival":case"Due out / Departed":case"Arrived / Departed":case"Departed":return"guest red";case"Stayover":return"guest blue";case"Arrival":case"Arrived":case"Departed / Arrival":return"guest green";case"Not Reserved":return"guest gray";default:return"guest"}},t.getReservationStatusValue=function(e){if(angular.isUndefined(e))return"default";switch(e.reservation_status){case"Due out / Departed":case"Arrived / Day use / Due out / Departed":case"Arrived / Departed":case"Departed":return"OUT";case"Due out":case"Arrived / Day use / Due out":case"Due out / Arrival":return e.checkout_time?e.checkout_time:"DUE OUT";case"Stayover":return"STAYOVER";case"Arrived":return"IN";case"Arrival":case"Departed / Arrival":return e.checkin_time?e.checkin_time:"DUE IN";case"Not Reserved":return"NOT RESERVED";default:return"default"}},t.getCurrentStatusClass=function(e){if(angular.isUndefined(e))return"room";switch(e.current_status){case"DIRTY":return"room red";case"PICKUP":return"room orange";case"CLEAN":case"INSPECTED":return"room green";case"DO_NOT_DISTURB":return"room purple";default:return"room"}};var ee=function(){var e="LEFT",o="RIGHT",n="TOP",r="BOTTOM",s=void 0,a=s,i=s,l=s,d=function(){var e={},o=0,n=0,r=void 0,s=void 0;return e.getClientPos=function(){return{x:o,y:n}},e.setClientPos=function(e,t){o=e,n=t},e.removePlaceholder=function(e){var t,o,n=function(){t&&(o=t.find(".placeholder"),o.remove())};t=r?r:s?s:void 0,e?setTimeout(n,10):n()},e.findCurrCol=function(){var e,o=this.getClientPos().x,n=t.$parent.myScroll.worksheetHorizontal,r=n.x,s=20,a=220,i=o-(s+r),l=t.multiSheetState.selectedEmployees.length;return i<0?e=-1:(e=Math.floor(i/a),0===l?e=0:e>=l?e=l-1:e>0&&(e-=1)),e},e.findCurrColNode=function(){var e,o=this.findCurrCol();return this.removePlaceholder(),s=r,o>-1?(e=t.multiSheetState.selectedEmployees[o],r=$("#"+o+"-"+e.id)):r=void 0,r}.bind(e),e.checkOnOverRoom=function(e,t,o){var n,r,s,a,i,l,d,c,u,h=280,m=20;return n=$(e),r=n.next(".worksheet-room"),s=t+1,r.hasClass(".placeholder")&&this.addPlaceholder(),a=n.height(),l=0===t?h:o,d=l+a/2,c=l+a+m,i=l+a,u=this.getClientPos().y,u<l&&0===t?{method:"BEFORE",node:n,index:t}:u>c?r.length?this.checkOnOverRoom(r,s,i):{method:"AFTER",node:n,index:s}:u<d&&u>=l?{method:"BEFORE",node:n,index:t}:{method:"AFTER",node:n,index:s}}.bind(e),e.addPlaceholder=function(){var e,o=this.findCurrColNode(),n=0,r=0,s=$('<div class="worksheet-room placeholder">Drop Here</div>');if(this.removePlaceholder(),void 0!==o)if(e=o.find(".worksheet-room")[0],void 0===e)o.find(".wrapper").append(s),t.dropIndex=0;else{var a=this.checkOnOverRoom(e,n,r);switch(a.method){case"BEFORE":s.insertBefore(a.node);break;case"AFTER":s.insertAfter(a.node);break;default:o.find(".wrapper").append(s)}t.dropIndex=a.index}}.bind(e),e}(),c=function(){var e=200,t=260,o=110,n=100,r=$(window).width(),s=$(window).height();return{screenStart:{x:e+o,y:t+n},screenEnd:{x:r-e,y:s-n}}},u=function(){l=c()};u(),window.addEventListener("resize",u,!1),t.$on("$destroy",function(){window.removeEventListener("resize",u)});var h,m=function(){var s=t.$parent.myScroll.worksheetHorizontal,i=void 0,l=-1,c=function(){return a===e||a===o},u=function(){return!!s.hasHorizontalScroll},h=function(){return a===e&&s.x<0},m=function(){return a===o&&s.x>s.maxScrollX},p=function(){return a===n||a===r},f=function(){return!!i&&!!i.hasVerticalScroll},_=function(){return a===n&&i.y<0},g=function(){return a===r&&i.y>i.maxScrollY};c()&&u()?h()?s.scrollBy(10,0,1):m()&&s.scrollBy(-10,0,1):p()&&(l=d.findCurrCol(),l>-1&&(i=t.getScroller("assignedRoomList-"+l),f()&&(_()?i.scrollBy(0,8,1):g()&&i.scrollBy(0,-8,1))))};t.dragStart=function(e){h=$(e.target).parent(),h.hide(),i=setInterval(m,1),t.dropIndex=void 0},t.dragDrop=function(){var e=!0;h.show(),L()&&d.removePlaceholder(e),i&&(window.clearInterval(i),i=s)};var p=_.throttle(d.addPlaceholder,250,{leading:!0,trailing:!1});t.userDragging=function(t){return L()&&(d.setClientPos(t.clientX,t.clientY),p()),t.clientX>l.screenEnd.x?void(a=o):t.clientX<l.screenStart.x?void(a=e):t.clientY>l.screenEnd.y?void(a=r):t.clientY<l.screenStart.y?void(a=n):void(a=s)}},te=function(){t.getScroller("worksheetHorizontal")?ee():setTimeout(te,100)},oe=function(e){N(),b(),q(!0),U(e),t.filterUnassigned(),X(),G(),te()};oe(),f={},t.getRoomType=function(e){var t,o,n=f[e];return angular.isDefined(n)?o=n:(t=_.find(d,{id:e}),angular.isDefined(t)?(f[e]=t.name,o=t.name):o=""),o},t.formatDateForUI=function(t){var o=typeof t,n="";switch(o){case"string":n=h("date")(new tzIndependentDate(t),e.dateFormat);break;case"object":n=h("date")(t,e.dateFormat)}return n};var ne=function(){var e=_.pluck(_.where(t.employeeList,{ticked:!0}),"id");return e},re=function(e,o){var n=[];return _.each(o,function(o){var r=angular.copy(o),s=_.find(t.multiSheetState.allRooms,function(e){return e.id==r.room_id});s&&(r.hk_section_id=s.hk_section_id),e&&(r.room_tasks=_.filter(r.room_tasks,function(e){return e.work_type_id==t.multiSheetState.header.work_type_id})),r.room_tasks.length&&n.push(r)}),n},se=function(e){var t=_.find(c.unassignedRoomTasks,function(t){return t.room_id==e});return JSON.parse(JSON.stringify(t))},ae=function(e){var t=e;_.each(t,function(e,t){var o=_.find(c.assignedRoomTasks,function(e){return e.id==t});o.only_tasks=o.only_tasks.concat(e);var n=_.uniq(_.pluck(e,"room_id"));_.each(n,function(t){var n=_.find(o.rooms,function(e){return e.id==t}),r=_.findIndex(o.rooms,function(e){return e.id==t}),s=angular.copy(n);if(n)s.room_tasks=s.room_tasks.concat(_.filter(e,function(e){return e.room_id==t})),o.rooms[r]=s;else{var a=se(t);a.room_tasks=_.filter(e,function(e){return e.room_id==t}),o.rooms.push(a)}}),o.touched_work_types=_.uniq(_.pluck(o.only_tasks,"work_type_id"))})},ie=function(e){var t=[];_.each(e,function(e){t=t.concat(e)});var o=_.uniq(_.pluck(t,"room_id"));_.each(o,function(e){var o=_.find(c.unassignedRoomTasks,function(t){return t.room_id==e}),n=_.findIndex(c.unassignedRoomTasks,function(t){return t.room_id==e}),r=_.filter(t,function(t){return t.room_id==e}),s=_.pluck(r,"id"),a=angular.copy(o);a.room_tasks=_.filter(a.room_tasks,function(e){return s.indexOf(e.id)<0}),c.unassignedRoomTasks[n]=a})},le=function(e){ae(e.assigned_tasks),ie(e.assigned_tasks),oe(ne())};t.executeAutoAssign=function(){if(t.workSheetChanged)return v(),!1;var e=function(e){le(e),G()},o=function(e){t.errorMessage=e},r={successCallBack:e,failureCallBack:o,params:{date:t.dateSelected,employee_ids:ne(),worktype_id:t.multiSheetState.header.work_type_id,unassigned_room_tasks:re(t.multiSheetState.header.work_type_id,c.unassignedRoomTasks)}};t.callAPI(n.executeAutoAssign,r)},t.getHKStatus=function(e){return"DO_NOT_DISTURB"===e?"DND":e},t.getFirstFilteredTaskId=function(e,t,o){if(!e)return o&&o.length>0&&o[0].id||null;var n=_.filter(o,function(t){return t.work_type_id==e});return n&&n.length>0&&n[0].id||null};var de=e.$on("LANGUAGE_CHANGED",function(){a(function(){e.setPrevState.title=h("translate")("WORK_MANAGEMENT"),t.setHeading(h("translate")("WORK_MANAGEMENT"))},100)});t.$on("$destroy",de);var ce=function(e){var o={date:t.multiSheetState.selectedDate,employee_ids:e,work_type_id:t.multiSheetState.header.work_type_id};t.callAPI(n.resetWorkAssignments,{params:o,onSuccess:z,onFailure:z})};t.resetWorkAssignments=function(){t.workSheetChanged?z():ce(F())},t.shouldDisableResetButton=function(){return F().length<1},t.shouldShowRemoveTasksButton=function(e){var o=!1;return _.find(e,function(e){if(t.multiSheetState.header.work_type_id?(o=_.filter(e.room_tasks,function(e){return e.work_type_id==t.multiSheetState.header.work_type_id}),o=o.length>0):o=e.room_tasks.length>0,o)return!0}),o},t.unassignAllTasks=function(e){g=e,ce([e])}}]),angular.module("sntRover").controller("RVWorkManagementStartCtrl",["$rootScope","$scope","ngDialog","$state","RVWorkManagementSrv","$timeout","$filter",function(e,t,o,n,r,s,a){t.setHeading(a("translate")("WORK_MANAGEMENT")),BaseCtrl.call(this,t);var i={click:!0,scrollbars:!0};t.setScroller("work_management",i),t.refreshScroller=function(e){setTimeout(function(){t&&t.myScroll&&e in t.myScroll&&t.myScroll[e].refresh()},100)},t.showCreateWorkSheetDialog=function(){o.open({template:"/assets/partials/workManagement/popups/rvWorkManagementCreatePopup.html",className:"ngdialog-theme-default",closeByDocument:!0,scope:t})};var l=function(){var e=function(e){t.$emit("hideLoader"),t.workStats=e,t.refreshScroller("work_management"),_.each(t.workStats.work_types,function(e){e.total_rooms_completed<e.total_rooms_assigned?e.css_class="red":e.css_class="green",_.each(e.tasks,function(e){e.total_rooms_completed<e.total_rooms_assigned?e.css_class="red":e.css_class="green"})})},o=function(e){t.errorMessage="",t.errorMessage=e,t.$emit("hideLoader")};t.invokeApi(r.fetchStatistics,t.stateVariables.viewingDate,e,o)};t.stateVariables={searching:!1,searchQuery:"",lastSearchQuery:"",employeeSearch:!1,noSearchResults:!1,viewingDate:{date:e.businessDate,work_type_id:t.workTypes[0].id},searchResults:{maids:[],rooms:[]},newSheet:{user_id:"",work_type_id:t.workTypes[0].id,date:e.businessDate},assignRoom:{user_id:"",work_type_id:t.workTypes[0].id,rooms:[]}},t.closeDialog=function(){t.errorMessage="",o.close()},t.continueCreateWorkSheet=function(){var e=function(e){t.$emit("hideLoader"),n.go("rover.workManagement.singleSheet",{id:e.id,date:e.date,from:"START"}),t.closeDialog()},o=function(e){t.errorMessage="",t.errorMessage=e,t.$emit("hideLoader")};t.invokeApi(r.createWorkSheet,t.stateVariables.newSheet,e,o)},t.showWorkSheet=function(e){e&&n.go("rover.workManagement.singleSheet",{date:t.stateVariables.viewingDate.date,id:e,from:"START"})},t.onRoomSelect=function(e){t.stateVariables.assignRoom.rooms=[e.id],e.work_sheet_id?n.go("rover.workManagement.singleSheet",{date:t.stateVariables.viewingDate.date,id:e.work_sheet_id,from:"START"}):(t.stateVariables.assignRoom.work_type_id=e.work_type_ids[0],o.open({template:"/assets/partials/workManagement/popups/rvWorkManagementAssignRoom.html",className:"ngdialog-theme-default",closeByDocument:!0,scope:t,data:JSON.stringify({workTypes:_.filter(t.workTypes,function(t){return e.work_type_ids.indexOf(t.id)>-1})})}))},t.assignRoom=function(){if(t.errorMessage="",!t.stateVariables.assignRoom.work_type_id)return t.errorMessage=["Please select a work type."],!1;if(!t.stateVariables.assignRoom.user_id)return t.errorMessage=["Please select an employee."],!1;var e=function(e){t.$emit("hideLoader"),t.stateVariables.assignRoom.user_id="",t.stateVariables.assignRoom.work_type_id="";var o=e.touched_work_sheets&&e.touched_work_sheets[0]&&e.touched_work_sheets[0].work_sheet_id;t.showWorkSheet(o),t.closeDialog()},o=function(e){t.$emit("hideLoader"),t.errorMessage=e};t.invokeApi(r.saveWorkSheet,{date:t.stateVariables.viewingDate.date,task_id:t.stateVariables.assignRoom.work_type_id,order:"",assignments:[{assignee_id:t.stateVariables.assignRoom.user_id,room_ids:t.stateVariables.assignRoom.rooms,work_sheet_id:"",from_search:!0}]},e,o)},t.showCalendar=function(e){o.open({template:"/assets/partials/workManagement/popups/rvWorkManagementSearchDateFilter.html",controller:e,className:"ngdialog-theme-default single-date-picker",closeByDocument:!0,scope:t})},t.showCreateCalendar=function(){t.calendarDialog=o.open({template:"/assets/partials/workManagement/popups/rvWorkManagementCreateDatePicker.html",controller:"RVWorkManagementCreateDatePickerController",className:"ngdialog-theme-default single-date-picker",closeByDocument:!0,scope:t})},t.onViewDateChanged=function(){t.stateVariables.searching&&t.workManagementSearch(!0),l()},t.resetView=function(){t.stateVariables.viewingDate.date=e.businessDate,l()},t.toggleTasksList=function(e){e.showTasks=!e.showTasks,t.refreshScroller("work_management")},t.navigateToMultiSheet=function(){n.go("rover.workManagement.multiSheet",{date:t.stateVariables.viewingDate.date})};var d=e.$on("LANGUAGE_CHANGED",function(){s(function(){t.setHeading(a("translate")("WORK_MANAGEMENT"))},100)});t.$on("$destroy",d),l()}]),angular.module("sntRover").controller("RVWorkManagementCtrl",["$rootScope","$scope","employees","workTypes","shifts","floors","$timeout",function(e,t,o,n,r,s,a){BaseCtrl.call(this,t),t.setHeading=function(e){t.heading=e,t.setTitle(e)},t.setHeading("Work Management"),t.$emit("updateRoverLeftMenu","workManagement"),t.workTypes=n,t.employeeList=o,t.shifts=r,t.floors=s,t.reservationStatus={"Due out":"check-out",Departed:"check-out",Stayover:"inhouse","Not Reserved":"no-show",Arrival:"check-in",Arrived:"check-in","Not Defined":"no-show","Day Use":"check-out","Due out / Arrival":"check-out","Departed / Arrival":"check-out","Arrived / Departed":"check-in","Due out / Departed":"check-out","Arrived / Day use / Due out":"check-in","Arrived / Day use / Due out / Departed":"check-in"},t.arrivalClass={Arrival:"check-in",Arrived:"check-in","Due out":"no-show",Departed:"no-show",Stayover:"no-show","Not Reserved":"no-show","Not Defined":"no-show","Day Use":"check-in","Due out / Arrival":"check-in","Departed / Arrival":"check-in","Arrived / Departed":"check-in","Due out / Departed":"no-show","Arrived / Day use / Due out":"check-in","Arrived / Day use / Due out / Departed":"check-in"},t.departureClass={Arrival:"check-out",Arrived:"check-out","Due out":"check-out",Departed:"check-out",Stayover:"inhouse","Not Reserved":"check-out","Not Defined":"check-out","Day Use":"check-out","Due out / Arrival":"check-out","Departed / Arrival":"check-out","Arrived / Departed":"check-out","Due out / Departed":"check-out","Arrived / Day use / Due out":"check-out","Arrived / Day use / Due out / Departed":"check-out"},t.printWorkSheet=function(){window.print()},t.addDuration=function(e,t){if(!t)return e;var o=e.split(":"),n=t.split(":"),r=parseInt(o[1])+parseInt(n[1]),s=(parseInt(o[0])+parseInt(n[0])+parseInt(r/60)).toString();return(s.length<2?"0"+s:s)+":"+((r%60).toString().length<2?"0"+(r%60).toString():(r%60).toString())},t.filterUnassignedRooms=function(e,t,o){function n(){return!!(e.checkin.before.hh||e.checkin.after.hh||e.checkout.after.hh||e.checkout.after.hh)}function r(t){return!!(t.checkin_time&&(e.checkin.before.hh||e.checkin.after.hh)||t.checkout_time&&(e.checkout.before.hh||e.checkout.after.hh))}function s(e){var t,o,n;return e?(t=e.toString().split(":"),o=t[1].split(" "),n=t[0],n=o[1].toString()&&"PM"===o[1].toString().toUpperCase()?parseInt(n)+12:(parseInt(n)+12)%12,n.toString().length<2&&(n="0"+n.toString()),n+=":"+o[0]):n="00:00",n}var a,i,l={};if(e.showAllRooms)_.each(t,function(e){e.show=!0});else{e.selectedFloor&&(l.floor_number=e.selectedFloor),e.selectedReservationStatus&&(l.reservation_status=e.selectedReservationStatus),e.vipsOnly&&(l.is_vip=!0),e.selectedFOStatus&&(l.fo_status=e.selectedFOStatus),_.each(t,function(e){a=o[e.room_index],i=_.find(l,function(e,t){return a[t]!==e}),i?e.show=!1:e.show=!0});var d,c,u,h,m,p,f;n()&&_.each(t,function(t){var n=o[t.room_index];r(n)&&(d=e.checkin.before,c=e.checkin.after,u=e.checkout.before,h=e.checkout.after,c.hh&&d.hh?(m=n.checkin_time,f=c.hh+":"+(c.mm||"00")+" "+c.am,p=d.hh+":"+(d.mm||"00")+" "+d.am,s(m)>=s(f)&&s(m)<=s(p)?t.show=!0:t.show=!1):c.hh?(m=n.checkin_time,f=c.hh+":"+(c.mm||"00")+" "+c.am,s(m)>=s(f)?t.show=!0:t.show=!1):d.hh?(m=n.checkin_time,p=d.hh+":"+(d.mm||"00")+" "+d.am,s(m)>=s(p)?t.show=!0:t.show=!1):h.hh&&u.hh?(m=n.checkout_time,f=h.hh+":"+(h.mm||"00")+" "+h.am,p=u.hh+":"+(u.mm||"00")+" "+u.am,s(m)>=s(f)&&s(m)<=s(p)?t.show=!0:t.show=!1):h.hh?(m=n.checkout_time,f=h.hh+":"+(h.mm||"00")+" "+h.am,s(m)>=s(f)?t.show=!0:t.show=!1):u.hh&&(m=n.checkin_time,p=u.hh+":"+(u.mm||"00")+" "+u.am,s(m)<=s(p)?t.show=!0:t.show=!1))})}}}]),angular.module("sntRover").controller("RVWorkManagementSingleSheetCtrl",["$rootScope","$scope","$stateParams","wmWorkSheet","RVWorkManagementSrv","$timeout","$state","ngDialog","$filter","allUnassigned","$window","$transitions",function(e,t,o,n,r,s,a,i,l,d,c,u){BaseCtrl.call(this,t);var h=!0,m=null;u.onStart({},function(e){if("rover.workManagement.singleSheet"===e.from().name&&h)return m=function(){h=!1,a.go(e.to(),e.params())},t.saveWorkSheet(),!1});var p={title:"Work Management",name:"rover.workManagement.start"};"multiple"===o.from?p={title:"Manage Worksheets",name:"rover.workManagement.multiSheet"}:parseInt(o.from)&&(p={title:"Room Details",name:"rover.housekeeping.roomDetails",param:{id:parseInt(o.from)}}),e.setPrevState=p,t.dropToUnassign=function(e,o){var n=parseInt($(o.draggable).attr("id").split("-")[1]);t.unAssignRoom(t.singleState.assigned[n])},t.dropToAssign=function(e,o){var n=parseInt($(o.draggable).attr("id").split("-")[1]);t.assignRoom(t.singleState.unassigned[n])};var n=n,f=function(){t.refreshScroller("workSheetUnassigned"),t.refreshScroller("workSheetAssigned")},g=function(){t.setHeading("Work Sheet No."+n.sheet_number+", "+l("date")(o.date,e.dateFormat)),t.singleState={workSheet:{user_id:null===n.maid_id?"":n.maid_id,work_type_id:null===n.work_type_id?"":n.work_type_id,shift_id:n.shift_id?n.shift_id:""},unassigned:[],unassignedFiltered:[],assigned:[],summary:{timeAllocated:"00:00",departures:0,stayovers:0,completed:0},filters:{selectedFloor:"",selectedStatus:""},dimensions:{unassigned:$("#worksheet-unassigned-rooms").width()-40,assigned:$("#worksheet-assigned-rooms").width()-40}},t.filters={selectedFloor:"",selectedReservationStatus:"",selectedFOStatus:"",vipsOnly:!1,showAllRooms:!1,checkin:{after:{hh:"",mm:"",am:"AM"},before:{hh:"",mm:"",am:"AM"}},checkout:{after:{hh:"",mm:"",am:"AM"},before:{hh:"",mm:"",am:"AM"}}}},k=function(){var n=function(n){t.setHeading("Work Sheet No."+n.work_sheets[0].work_sheet_id+", "+l("date")(o.date,e.dateFormat)),t.singleState.unassigned=n.unassigned;var r=[];_.each(n.work_sheets[0].work_assignments,function(e){r.push(e.room)}),t.singleState.assigned=r,t.filterUnassigned(),S(),f(),t.$emit("hideLoader")},s=function(e){t.errorMessage=e,t.$emit("hideLoader")};t.invokeApi(r.fetchWorkSheetDetails,{date:o.date||e.businessDate,employee_ids:[t.singleState.workSheet.user_id],work_type_id:t.singleState.workSheet.work_type_id},n,s)};t.init=k;var S=function(){t.singleState.summary={timeAllocated:"00:00",departures:0,stayovers:0,completed:0},_.each(t.singleState.assigned,function(e){"check-out"===t.departureClass[e.reservation_status]?t.singleState.summary.departures++:"inhouse"===t.departureClass[e.reservation_status]&&t.singleState.summary.stayovers++,e.hk_complete&&t.singleState.summary.completed++;var o=t.singleState.summary.timeAllocated.split(":"),n=e.time_allocated.split(":"),r=parseInt(o[1])+parseInt(n[1]),s=(parseInt(o[0])+parseInt(n[0])+parseInt(r/60)).toString();t.singleState.summary.timeAllocated=(s.length<2?"0"+s:s)+":"+((r%60).toString().length<2?"0"+(r%60).toString():(r%60).toString())})};t.setScroller("workSheetUnassigned"),t.setScroller("workSheetAssigned"),
t.assignRoom=function(e){t.singleState.unassigned.splice(_.indexOf(t.singleState.unassigned,_.find(t.singleState.unassigned,function(t){return t.room_no===e.room_no})),1),t.singleState.assigned.push(e),S(),f()},t.unAssignRoom=function(e){t.singleState.assigned.splice(_.indexOf(t.singleState.assigned,_.find(t.singleState.assigned,function(t){return t.room_no===e.room_no})),1),t.singleState.unassigned.push(e),S(),f()},t.printWorkSheet=function(){t.saveWorkSheet({callNextMethod:"printAfterSave"})};var v=function(){$("head").append("<style id='print-orientation'>@page { size: landscape; }</style>")},y=function(){$("#print-orientation").remove()};t.printAfterSave=function(){t.$parent.myScroll.workSheetAssigned&&t.$parent.myScroll.workSheetAssigned.scrollTo&&t.$parent.myScroll.workSheetAssigned.scrollTo(0,0),v();var e=function(){s(y,100)};s(function(){sntapp.cordovaLoaded?cordova.exec(e,function(){e()},"RVCardPlugin","printWebView",["singleSheet","0","","L"]):(c.print(),e())},100)},t.deletWorkSheet=function(){var e=function(e){t.$emit("hideLoader"),h=!1,s(function(){a.go("rover.workManagement.start")},20)},n=function(e){t.errorMessage=e,t.$emit("hideLoader")};t.invokeApi(r.deleteWorkSheet,{id:o.id},e,n)};var w="";_.each(d,function(e){w=e.id,_.each(e.unassigned,function(e){e.work_type_id=w})}),t.saveWorkSheet=function(e){var n=[],a=0,i=e&&e.oldWorkTypeId?e.oldWorkTypeId:t.singleState.workSheet.work_type_id,l=e&&e.oldUserId?e.oldUserId:t.singleState.workSheet.user_id,d={},c=function(){e&&t[e.callNextMethod]&&s(t[e.callNextMethod],50),h&&m&&s(m,60)},u=function(e){a--,0===a&&(t.$emit("hideLoader"),t.clearErrorMessage(),c())},p=function(e){t.errorMessage=e,a--,0===a&&(t.$emit("hideLoader"),c())};return i?t.singleState.workSheet.user_id?(d={},_.each(t.workTypes,function(e){d[e.id.toString()]=[]}),void(t.singleState.assigned.length?(_.each(t.singleState.assigned,function(e){e.hasOwnProperty("work_type_id")?d[e.work_type_id.toString()].push(e):d[i.toString()].push(e)}),_.each(d,function(e,s){e.length&&(_.each(e,function(e){n.push(e.room_id||e.id)}),t.invokeApi(r.saveWorkSheet,{date:o.date,task_id:parseInt(s),order:"",assignments:[{shift_id:t.singleState.workSheet.shift_id,assignee_id:l,room_ids:n,work_sheet_id:""}]},u,p),n=[],a++)})):(_.each(d,function(e,n){t.invokeApi(r.saveWorkSheet,{date:o.date,task_id:parseInt(n),assignments:[{assignee_id:l,room_ids:[]}]},u,p)}),c()))):(t.errorMessage=["Please select an employee."],!1):(t.errorMessage=["Please select a work type."],!1)},t.startLoader=function(){t.$emit("showLoader")},t.filterUnassigned=function(){t.$emit("showLoader"),s(function(){t.singleState.unassignedFiltered=t.filterUnassignedRooms(t.filters,t.singleState.unassigned,d),f(),t.closeDialog(),t.$emit("hideLoader")},10)},t.$watch("singleState.workSheet.work_type_id",function(e,o){e!==o&&t.saveWorkSheet({oldWorkTypeId:o,callNextMethod:"onWorkTypeChange"})}),t.onWorkTypeChange=function(){k()},t.$watch("singleState.workSheet.user_id",function(e,o){e!==o&&t.saveWorkSheet({oldUserId:o,callNextMethod:"onEmployeeChange"})}),t.onEmployeeChange=function(e){k()},t.refreshSheet=function(){t.saveWorkSheet({callNextMethod:"init"})},t.onAssignmentDragStart=function(){t.$parent.myScroll.workSheetUnassigned.disable()},t.onAssignmentDragStop=function(){t.$parent.myScroll.workSheetUnassigned.enable()},t.onUnassignmentDragStart=function(){t.$parent.myScroll.workSheetAssigned.disable()},t.onUnassignmentDragStop=function(){t.$parent.myScroll.workSheetAssigned.enable()},t.showFilter=function(){i.open({template:"/assets/partials/workManagement/popups/rvWorkManagementFilterRoomsPopup.html",className:"ngdialog-theme-default",closeByDocument:!0,scope:t})},t.idToVal=function(e,t,o){var n=_.find(o,function(t){return t.id===e});return n&&n.hasOwnProperty(t)?n[t]:""},g(),k()}]),angular.module("sntRover").service("RVWorkManagementSrv",["$q","rvBaseWebSrvV2",function(e,t){function o(e,t){var o=[];return o.concat(e.rooms,t.rooms)}function n(e,t,o){var n,r,a,i,l,d,c,u,h,m,p,f,g,t=t||[],e=$.extend({},{rooms:[],room_tasks:[]},e),k=e.rooms,S=e.room_tasks,v=[];for(n=0,r=k.length;n<r;n++)S[n].tasks.length&&(l=_.findIndex(o,function(e){return e.id==k[n].id}),d=$.extend({},{room_id:k[n].id},{room_type:k[n].room_type},{is_vip:k[n].is_vip},{room_index:l},{room_tasks:[]}),v.push(d));for(n=0,r=S.length;n<r;n++)if(S[n].tasks.length)for(c=S[n].room_id,h=S[n].tasks,m=_.find(v,{room_id:c}),p=o[m.room_index].room_type,f=o[m.room_index].room_no,a=0,i=h.length;a<i;a++)g=_.find(t,{id:h[a].id}),u=$.extend({},h[a],{task_name:g.name,work_type_id:g.work_type_id,work_type_name:g.work_type_name,time_allocated:s(g,p)},{room_id:c,room_no:f}),m.room_tasks.push(u);return v}function r(e,t,o){var n,r,a,i,l,d,c,u,h,m,p,f,g,k,S,v,t=t||[],e=$.extend({},{employees:[],rooms:[]},e),y=e.employees,w=e.rooms,D=[],A=function(e){var t=_.find(w,{id:e});return t?t:{room_type:"",is_vip:null}};for(n=0,r=y.length;n<r;n++){var R=y[n].name.split(" "),M=R.shift();for(R=M.charAt(0)+". "+R.join(" "),u=$.extend({},{id:y[n].id,name:y[n].name},{display_name:R},{rooms:[]},{only_tasks:[]},{touched_work_types:[]},{shift_id:y[n].shift_id}),h=y[n].room_tasks,a=0,i=h.length;a<i;a++)for(c=_.findIndex(o,function(e){return e.id==h[a].room_id}),v=A(h[a].room_id),m=$.extend({},{room_id:h[a].room_id},{room_type:v.room_type},{is_vip:v.is_vip},{room_index:c},{room_tasks:[]}),u.rooms.push(m),p=h[a].tasks,k=o[c].room_type,S=o[c].room_no,l=0,d=p.length;l<d;l++)f=_.find(t,{id:p[l].id}),g=$.extend({},p[l],{task_name:f.name,work_type_id:f.work_type_id,work_type_name:f.work_type_name,time_allocated:s(f,k)},{room_id:h[a].room_id,room_no:S}),u.touched_work_types.push([g.work_type_id]),u.rooms[a].room_tasks.push(g),u.only_tasks.push(g);u.touched_work_types=_.uniq(_.flatten(u.touched_work_types)),D.push(u)}return D}function s(e,t){var o="",n=0,r=0;return e.room_types_completion_time&&e.room_types_completion_time.hasOwnProperty(t)&&e.room_types_completion_time[t]?o=e.room_types_completion_time[t]:e.completion_time&&(o=e.completion_time),o.indexOf(":")>-1&&(n=o.split(":")[0],r=o.split(":")[1]),{hh:isNaN(parseInt(n))?0:parseInt(n),mm:isNaN(parseInt(r))?0:parseInt(r)}}function a(e,t,o){var n=$.extend({},{date:t},{work_types:[]});_.each(e,function(e){var t=e.touched_work_types;_.each(t,function(e){var t,o=_.find(n.work_types,{id:e});o||(t={id:e,assignments:[]},n.work_types.push(t))})});var r,s,a,i,l;return _.each(n.work_types,function(t,o){r=t.id,_.each(e,function(e){s=_.find(e.touched_work_types,function(e){return r==e}),a={employee_id:e.id,tasks:[]},s&&(i=_.where(e.only_tasks,{work_type_id:r}),_.each(i,function(e,t){l={id:e.id,room_id:e.room_id,order:e.order||null},a.tasks.push(l)})),n.work_types[o].assignments.push(a)})}),n}this.fetchMaids=function(o){var n=e.defer(),r="api/work_statistics/employees_list";return o=o||{},t.getJSON(r,o).then(function(e){_.each(e.results,function(e){e.ticked=!1,e.checkboxDisabled=!1}),n.resolve(e.results)},function(e){n.reject(e)}),n.promise},this.fetchWorkTypes=function(){var o=e.defer(),n="api/work_types";return t.getJSON(n).then(function(e){o.resolve(e.results)},function(e){o.reject(e)}),o.promise},this.fetchShifts=function(){var o=e.defer(),n="api/shifts";return t.getJSON(n).then(function(e){_.each(e.results,function(e){e.display_name=e.name+"("+e.time+")"}),o.resolve(e.results)},function(e){o.reject(e)}),o.promise},this.fetchStatistics=function(o){var n=e.defer(),r="/api/work_statistics?date="+o.date;return t.getJSON(r).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.createWorkSheet=function(o){var n=e.defer(),r="api/work_sheets";return t.postJSON(r,o).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchWorkSheet=function(o){var n=e.defer(),r="api/work_sheets/"+o.id;return t.getJSON(r).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.deleteWorkSheet=function(o){var n=e.defer(),r="api/work_sheets/"+o.id;return t.deleteJSON(r).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchWorkSheetDetails=function(t){var o=e.defer();return o.resolve([]),o.promise},this.saveWorkSheet=function(o){var n=e.defer(),r="api/work_assignments/assign";return t.postJSON(r,o).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.searchEmployees=function(o){var n=e.defer(),r="/api/work_statistics/employee?query="+o.key+"&date="+o.date;return o.workType&&(r+="&work_type_id="+o.workType),t.getJSON(r).then(function(e){n.resolve(e.results)},function(e){n.reject(e)}),n.promise},this.searchRooms=function(o){var n=e.defer(),r="/house/search.json?query="+o.key+"&date="+o.date;return t.getJSON(r).then(function(e){n.resolve(e.data.rooms)},function(e){n.reject(e)}),n.promise},this.fetchAllUnassigned=function(t){var o=e.defer();"api/work_assignments/unassigned_rooms?date="+t.date;return o.resolve([]),o.promise},this.fetchHKStaffs=function(o){var n=e.defer(),r="api/work_statistics/employees_list";o=o||{};var s=function(e){var t,o=[],n=[];return _.each(e.results,function(e){n.push(e.id),t=$.extend({},e,{ticked:!1},{checkboxDisabled:!1}),o.push(t)}),{results:o,emp_ids:n}};return t.getJSON(r,o).then(function(e){n.resolve(s(e))},function(e){n.reject(e)}),n.promise},this.fetchAllTasks=function(){var o=e.defer(),n="api/tasks";return t.getJSON(n).then(function(e){o.resolve(e.results)},function(e){o.reject(e)}),o.promise},this.fetchUnassignedRoomTasks=function(o){var n=e.defer(),r="api/work_assignments/unassigned_rooms";return t.postJSON(r,o).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchAssignedRoomTasks=function(o){var n=e.defer(),r="api/work_assignments/assigned_rooms";return t.postJSON(r,o).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.payload={},this.processedPayload=function(t,s){var a,i,a,l,d,c=e.defer(),u=[];return u.push(this.fetchAllTasks()),u.push(this.fetchUnassignedRoomTasks(t)),u.push(this.fetchAssignedRoomTasks(s)),e.all(u).then(function(e){i=e[0],a=e[1],l=e[2],d=o(a,l),this.payload={allTasks:i,allRooms:d,unassignedRoomTasks:n(a,i,JSON.parse(JSON.stringify(d))),assignedRoomTasks:r(l,i,JSON.parse(JSON.stringify(d)))},c.resolve(this.payload)}.bind(this),function(e){c.reject(e)}),c.promise},this.getRoomDetails=function(e){return this.payload.allRooms[e]},this.saveWorkSheets=function(o){var n=e.defer(),r="api/work_assignments/assign",s=a(o.assignedRoomTasks,o.date,o.shouldSaveOrder);return t.postJSON(r,s).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.sortAssigned=function(e,t,o,n){var r,s,a,i,l,d,c,u=e.length,h=function(e,t){var o=_.find(e,{room_id:t});return angular.isDefined(o)?o:{room_type:"",is_vip:null}};for(s=0;s<u;s++)r=e[s],"room"===n.grouping?(r.rooms=_.sortBy(r.rooms,function(e){return t[e.room_index].room_no}),"desc"===n.sort&&r.rooms.reverse()):(a=_.flatten(_.pluck(r.rooms,"room_tasks")),i=[],a=_.sortBy(a,function(e){return e.task_name.toLowerCase()}),"desc"===n.sort&&a.reverse(),_.each(a,function(e){l=_.findIndex(t,{id:e.room_id}),c=h(r.rooms,e.room_id),d=$.extend({},{room_id:e.room_id},{room_type:c.room_type},{is_vip:c.is_vip},{room_index:l},{room_tasks:[e]}),i.push(d)}),r.rooms=i);return e},this.executeAutoAssign=function(o){var n=e.defer(),r="api/work_assignments/auto_assign";return t.postJSON(r,o).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.resetWorkAssignments=function(o){var n=e.defer(),r="api/work_assignments/reset";return t.postJSON(r,o).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise}}]),angular.module("sntRover").filter("makeRange",function(){return function(e){var t,o,n=1,r=0;switch(e.length){case 1:t=0,o=parseInt(e[0])-1;break;case 2:t=parseInt(e[0]),o=parseInt(e[1]);break;case 3:t=parseInt(e[0]),o=parseInt(e[1]),n=parseInt(e[2]);break;case 4:t=parseInt(e[0]),o=parseInt(e[1]),n=parseInt(e[2]),r=parseInt(e[3]);break;default:return e}for(var s=[],a="",i=t;i<=o;i+=n)a=getLengthChangedNumber(r,i),s.push(a);return s}});