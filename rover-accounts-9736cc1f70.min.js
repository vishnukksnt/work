angular.module("sntRover").controller("rvActivityCtrl",["$scope","$rootScope","$filter","$stateParams","$timeout",function(e,t,a,n,r){BaseCtrl.call(this,e);var i=50;e.init=function(){e.page=1,e.perPage=i,e.errorMessage="",e.accountActivityLogPagination={id:"ACCOUNT_ACTIVITY_LOG",api:e.updateReport,perPage:i},e.setScroller("report_content")},e.$on("PopulateLogData",function(t,a){e.count=a.total_count,e.activityLogData=a.results,e.$emit("hideLoader"),e.refreshScroller("report_content"),r(function(){e.$broadcast("updatePagination","ACCOUNT_ACTIVITY_LOG")},800)}),e.isOldValue=function(e){return""!==e&&"undefined"!=typeof e&&null!==e},e.initSort=function(){e.sortOrderOfUserASC=!1,e.sortOrderOfDateASC=!1,e.sortOrderOfActionASC=!1,e.sortOrderOfUserDSC=!1,e.sortOrderOfDateDSC=!1,e.sortOrderOfActionDSC=!1},e.sortByUserName=function(){e.sort_field="USERNAME",e.sortOrderOfUserASC?(e.initSort(),e.sortOrderOfUserDSC=!0,e.sort_order="desc"):(e.initSort(),e.sortOrderOfUserASC=!0,e.sort_order="asc"),e.updateReport()},e.sortByDate=function(){e.sort_field="DATE",e.sortOrderOfDateASC?(e.initSort(),e.sortOrderOfDateDSC=!0,e.sort_order="desc"):(e.initSort(),e.sortOrderOfDateASC=!0,e.sort_order="asc"),e.updateReport()},e.sortByAction=function(){e.sort_field="ACTION",e.sortOrderOfActionASC?(e.initSort(),e.sortOrderOfActionDSC=!0,e.sort_order="desc"):(e.initSort(),e.sortOrderOfActionASC=!0,e.sort_order="asc"),e.updateReport()},e.updateReport=function(t){var a={page:t||1,per_page:e.perPage};a.sort_order=e.sort_order,a.sort_field=e.sort_field,e.$emit("updateLogdata",a)};var o=function(){$("head").append("<style id='print-orientation'>@page { size: landscape; }</style>")},s=function(){$("#print-orientation").remove()};e.print=function(){$("header h1").addClass("text-hide"),$(".cards-header").css({marginBottom:"2%"}),o();var e=$("#print-orientation"),t=e.css("background-image"),a=t.replace(/(^url\()|(\)$|[\"\'])/g,"");$("<img>").attr("src",a).on("load",function(){$(this).off("load"),$(this).remove();var e=function(){r(function(){$("header h1").removeClass("text-hide"),$(".cards-header").css({marginBottom:"0"}),s()},1200)};r(function(){sntapp.cordovaLoaded?cordova.exec(e,function(){e()},"RVCardPlugin","printWebView",["","0","","L"]):(window.print(),e())},300)})},e.init()}]),angular.module("sntRover").controller("rvGroupActivityCtrl",["$scope","$rootScope","$filter","$stateParams","rvGroupAccountActivitySrv",function(e,t,a,n,r){BaseCtrl.call(this,e),e.init=function(){e.selectedGroupOrAccountId=e.groupConfigData?e.groupConfigData.summary.group_id:e.accountConfigData.summary.posting_account_id;var t={id:e.selectedGroupOrAccountId,page:1,type:e.groupConfigData?"group":"account",per_page:50},a=function(t){e.$broadcast("PopulateLogData",t)};e.invokeApi(r.fetchActivityLog,t,a)},e.$on("updateLogdata",function(t,a){a.id=e.selectedGroupOrAccountId,a.type=e.groupConfigData?"group":"account";var n=function(t){e.$broadcast("PopulateLogData",t)};e.invokeApi(r.fetchActivityLog,a,n)}),e.$on("GROUP_TAB_SWITCHED",function(t,a){"ACTIVITY"===a&&e.init()}),e.$on("ACCOUNT_TAB_SWITCHED",function(t,a){"ACTIVITY"===a&&e.init()})}]),sntRover.controller("rvAccountActivityCtrl",["$scope","$rootScope","$filter","$stateParams","rvGroupAccountActivitySrv",function(e,t,a,n,r){BaseCtrl.call(this,e),e.init=function(){e.selectedGroupOrAccountId=e.$parent.accountConfigData.summary.posting_account_id;var t={id:e.selectedGroupOrAccountId,page:1,type:"account",per_page:50},a=function(t){e.$broadcast("PopulateLogData",t)};e.invokeApi(r.fetchActivityLog,t,a)},e.$on("updateLogdata",function(t,a){a.id=e.selectedGroupOrAccountId,a.type="account";var n=function(t){e.$broadcast("PopulateLogData",t)};e.invokeApi(r.fetchActivityLog,a,n)}),e.$on("ACCOUNT_TAB_SWITCHED",function(t,a){"ACTIVITY"===a&&e.init()})}]),sntRover.controller("rvAccountsSearchCtrl",["$scope","$rootScope","rvAccountsSrv","initialAccountsListing","$filter","$timeout","$state","rvUtilSrv","rvPermissionSrv",function(e,t,a,n,r,i,o,s,c){BaseCtrl.call(this,e),e.isEmpty=s.isEmpty,e.getClassAgainstBalance=function(e){var t="";return s.convertToDouble(e.balance)>0&&(t="red"),t},e.getClassAgainstAccountStatus=function(e){var t="";return e.status&&"open"===e.status.toLowerCase()&&(t="green"),t},e.clearSearchQuery=function(t){t.preventDefault(),t.stopPropagation(),e.query="",e.search()},e.stringify=s.stringify,e.$on("NG_REPEAT_STARTED_RENDERING",function(t){e.$emit("showLoader")}),e.$on("NG_REPEAT_COMPLETED_RENDERING",function(t){i(function(){f()},300),e.$emit("hideLoader")}),e.hasPermissionToAddNewAccount=function(){return c.getPermissionValue("CREATE_ACCOUNT")},e.searchQueryChanged=function(){return!e.isEmpty(e.query)&&(!(e.query.length<3)&&void e.search())};var l=function(){var t={query:e.query,status:e.status,to_date:e.toDate,per_page:e.perPage,page:e.page,account_type:e.accountType,is_non_zero:e.isNonZero};return t};e.search=function(t){e.amFirstTimeHere=!1,e.page=t||1,e.errorMessage="";var n=l(),r={params:n,successCallBack:u,failureCallBack:d};e.callAPI(a.getAccountsList,r)};var u=function(t){e.accountList=t.posting_accounts,e.totalResultCount=t.total_count,i(function(){e.$broadcast("updatePagination","ACCOUNT_SEARCH")},800),f()},d=function(t){e.errorMessage=t},p=function(){var t={tap:!0,preventDefault:!1,deceleration:1e-4,shrinkScrollbars:"clip"};e.setScroller("result_showing_area",t)},f=function(){e.refreshScroller("result_showing_area")};e.shouldShowPagination=function(){return e.totalResultCount>=e.perPage};var m=function(){return e.accountList.length>0};e.isFirstTimeWithNoResult=function(){return e.amFirstTimeHere&&!m()},e.shouldShowNoResult=function(){return!e.amFirstTimeHere&&!m()},e.shouldShowAddNewButton=function(){return e.hasPermissionToAddNewAccount()},e.gotoEditAccountConfiguration=function(e){o.go("rover.accounts.config",{id:e,activeTab:"ACCOUNT",isFromCards:!0})},e.gotoAddNewAccount=function(){o.go("rover.accounts.config",{id:"NEW_ACCOUNT",isFromCards:!0})};(function(){e.setHeadingTitle("MENU_ACCOUNTS"),e.$emit("updateRoverLeftMenu","accounts"),e.accountList=n.posting_accounts,e.totalResultCount=n.total_count,e.amFirstTimeHere=!0,e.query="",e.isNonZero=!1,e.status="OPEN",p(),e.perPage=a.DEFAULT_PER_PAGE,e.accountSearchPagination={id:"ACCOUNT_SEARCH",api:e.search,perPage:a.DEFAULT_PER_PAGE},e.search()})()}]),sntRover.controller("rvAccountSummaryCtrl",["$scope","$rootScope","$filter","$stateParams","RVPaymentSrv","RVDepositBalanceSrv","rvAccountsConfigurationSrv","RVReservationSummarySrv","ngDialog","rvPermissionSrv","RVReservationCardSrv",function(e,t,a,n,r,i,o,s,c,l,u){BaseCtrl.call(this,e);var d={};e.updateAccountSummary=function(){if(l.getPermissionValue("EDIT_ACCOUNT")){var t=function(t){e.$broadcast("UPDATED_ACCOUNT_INFO"),e.$emit("hideloader")},a=function(t){e.$broadcast("FAILED_TO_UPDATE_ACCOUNT_INFO"),e.$emit("showErrorMessage",t),e.$emit("hideloader")};e.callAPI(o.updateAccountSummary,{successCallBack:t,failureCallBack:a,params:{summary:e.accountConfigData.summary}})}else e.$emit("showErrorMessage",["Sorry, Changes will not get saved as you don't have enough permission"])};var p=function(){var t,a=e.accountConfigData.summary;for(t in d)if(!angular.equals(a[t],d[t]))return!1;return!0},f=function(){e.setScroller("rvAccountSummaryScroller"),e.accountSummaryData={promptMandatoryDemographics:!1,isDemographicsPopupOpen:!1,newNote:"",editingNote:null,demographics:null},d=angular.copy(e.accountConfigData.summary);var t=function(){p()||e.accountSummaryData.isDemographicsPopupOpen||(d=angular.copy(e.accountConfigData.summary),e.updateAccountSummary())};e.isInAddMode()||(e.$on("OUTSIDECLICKED",function(e,a){"AccountTab"!==a.id&&t()}),e.$on("UPDATE_ACCOUNT_SUMMARY",function(e,a){t()}))};e.getBalanceAmount=function(e){return"undefined"==typeof e?"":t.currencySymbol+a("number")(e,2)};var m=e.$on("BALANCE_AFTER_PAYMENT",function(t,a){e.accountConfigData.summary.balance=a});e.isDemographicsFormValid=function(){return!0},e.closeDemographicsPopup=function(){e.accountSummaryData.isDemographicsPopupOpen=!1,e.closeDialog()};var v={};e.openDemographicsPopup=function(){e.errorMessage="";var t=function(){e.accountSummaryData.isDemographicsPopupOpen=!0,v=angular.copy(e.accountConfigData.summary.demographics),c.open({template:"/assets/partials/accounts/accountsTab/rvAccountDemographics.html",className:"",scope:e,closeByDocument:!1,closeByEscape:!1})},a=function(a){e.accountSummaryData.demographics=a.demographics,t()},n=function(e){};null===e.accountSummaryData.demographics?e.callAPI(s.fetchInitialData,{successCallBack:a,failureCallBack:n}):t()},e.saveDemographicsData=function(){return e.isInAddMode()?void(e.errorMessage=["Account needs to be saved first"]):(e.updateAccountSummary(),void e.closeDemographicsPopup())},e.cancelDemographicChanges=function(){e.accountConfigData.summary.demographics=v},e.saveAccountNote=function(){if(e.isInAddMode())return void(e.errorMessage=["Account needs to be saved first'"]);if(e.errorMessage="",e.accountSummaryData.newNote){var t=function(t){e.accountConfigData.summary.notes=t.notes,e.accountSummaryData.newNote="",e.refreshScroller("rvAccountSummaryScroller")},a=function(t){e.errorMessage=t};e.callAPI(o.saveAccountNote,{successCallBack:t,failureCallBack:a,params:{notes:e.accountSummaryData.newNote,posting_account_id:e.accountConfigData.summary.posting_account_id}})}},e.removeAccountNote=function(t,a){var n=function(t,a){e.accountConfigData.summary.notes=_.without(e.accountConfigData.summary.notes,_.findWhere(e.accountConfigData.summary.notes,{note_id:a.noteId})),e.refreshScroller("rvAccountSummaryScroller"),e.cancelEditModeAccountNote()},r=function(t){e.errorMessage=t};t.stopPropagation(),e.callAPI(o.removeAccountNote,{successCallBack:n,failureCallBack:r,params:{note_id:a},successCallBackParameters:{noteId:a}})},e.updateActiveAccountNote=function(){if(!e.accountSummaryData.editingNote)return void(e.errorMessage=["Something went wrong, please switch tab and comeback"]);if(e.errorMessage="",e.accountSummaryData.newNote){var t=function(t){e.accountSummaryData.editingNote.description=e.accountSummaryData.newNote;var a=_.findIndex(e.accountConfigData.summary.notes,{note_id:t.note_id});e.accountConfigData.summary.notes[a]=e.accountSummaryData.editingNote,e.refreshScroller("rvAccountSummaryScroller"),e.cancelEditModeAccountNote()},a=function(t){e.errorMessage=t};e.callAPI(o.updateAccountNote,{successCallBack:t,failureCallBack:a,params:{id:e.accountSummaryData.editingNote.note_id,text:e.accountSummaryData.newNote,associated_id:e.accountConfigData.summary.posting_account_id,associated_type:"PostingAccount"}})}},e.clickedOnNote=function(t){e.accountSummaryData.editingNote=t,e.accountSummaryData.newNote=t.description.replace(new RegExp("<br/>","g"),"\n")},e.cancelEditModeAccountNote=function(){e.accountSummaryData.editingNote=null,e.accountSummaryData.newNote=""},e.onCloseWarningPopup=function(){e.accountConfigData.summary.posting_account_status="OPEN",e.closeDialog()},e.onAccountTypeModification=function(){"GROUP"===e.accountConfigData.summary.posting_account_type&&(e.accountConfigData.summary.posting=!1),e.accountConfigData.summary.posting_account_id&&e.updateAccountSummary()},e.onAccountStatusModification=function(){parseFloat(e.accountConfigData.summary.balance)&&"CLOSED"===e.accountConfigData.summary.posting_account_status?c.open({template:"/assets/partials/accounts/accountsTab/rvAccountAlertCloseWithBalance.html",className:"",scope:e,closeByDocument:!1,closeByEscape:!1}):e.updateAccountSummary()};var h=function(t){e.accountConfigData.summary=t,d=angular.copy(e.accountConfigData.summary)},g=function(){var t={accountId:e.accountConfigData.summary.posting_account_id},a={params:t,successCallBack:h};e.callAPI(o.getAccountSummary,a)};f(),e.$on("ACCOUNT_TAB_SWITCHED",function(e,t){"ACCOUNT"===t&&(f(),g())}),e.$on("GROUP_TAB_SWITCHED",function(e,t){"ACCOUNT"===t&&(f(),g())}),e.paymentTypes=[],e.creditCardTypes=[];var y=function(t){e.$emit("hideLoader"),e.paymentTypes=t,angular.forEach(e.paymentTypes,function(t,a){"CC"==t.name&&(e.creditCardTypes=t.values)})};e.invokeApi(r.fetchAvailPayments,{},y),e.openDepositBalanceModal=function(){e.$emit("showErrorMessage",[]);var t={posting_account_id:e.accountConfigData.summary.posting_account_id},a=function(t){e.$emit("showErrorMessage",t)};e.callAPI(i.getRevenueDetails,{params:t,onSuccess:e.successCallBackFetchDepositBalance,onFailure:a})},e.successCallBackFetchDepositBalance=function(t){e.$emit("hideLoader"),e.depositBalanceData=t,e.$emit("TOGGLE_PAYMET_POPUP_STATUS",!0),e.passData={origin:"GROUP",details:{firstName:"",lastName:"",paymentTypes:e.paymentTypes,accountId:e.accountConfigData.summary.posting_account_id}},c.open({template:"/assets/partials/depositBalance/rvModifiedDepositBalanceModal.html",controller:"RVDepositBalanceAccountsCtrl",className:"ngdialog-theme-default1",closeByDocument:!1,scope:e})};var C=function(t){var a=new SwipeOperation,n=a.createSWipedDataToRender(t);e.$broadcast("SHOW_SWIPED_DATA_ON_DEPOSIT_BALANCE_SCREEN",n)};e.$on("SWIPE_ACTION",function(t,a){var n=new SwipeOperation,r=n.createDataToTokenize(a),i=function(t){e.$emit("hideLoader"),a.token=t,C(a)};e.invokeApi(u.tokenize,r,i)}),e.$on("$destroy",m)}]),sntRover.controller("rvAccountDatepickerCtrl",["$scope","ngDialog",function(e,t){e.date=e.ngDialogData.activeDate,e.setUpData=function(){e.dateOptions={changeYear:!0,changeMonth:!0,minDate:tzIndependentDate(e.ngDialogData.minDate),maxDate:tzIndependentDate(e.ngDialogData.maxDate),yearRange:"-100:+5",onSelect:function(){e.$emit("DATE_CHANGED",e.date),t.close()}}},e.setUpData()}]),sntRover.controller("rvAccountTransactionsCtrl",["$scope","$rootScope","$filter","$stateParams","ngDialog","rvAccountsConfigurationSrv","RVReservationSummarySrv","rvAccountTransactionsSrv","RVPaymentSrv","RVReservationCardSrv","RVBillCardSrv","rvPermissionSrv","RVAutomaticEmailSrv","$timeout","$window","$q","jsMappings","sntActivity",function(e,t,a,n,r,i,o,s,c,l,u,d,p,f,m,v,h,g){BaseCtrl.call(this,e),SharedMethodsBaseCtrl.call(this,e,t,p,r);var y=this;e.stateParams=n,e.perPage=50,e.maxNoOfDaysToShow=15,e.businessDate=t.businessDate,e.isFromBillCard=!1,e.reservationBillData={},e.groupId=null,e.type="SUMMARY"===n.activeTab?"Group":"Account";var C=function(t){var a=e.transactionsDetails.bills[e.currentActiveBill].days,n=_.find(a,function(e){return e.date===t});if(!n.show){var r=0,i=!1;angular.forEach(a,function(a){a.date===t&&(i=!0),i&&r<e.maxNoOfDaysToShow?(a.show=!0,r++):a.show=!1})}e.transactionsDetails.bills[e.currentActiveBill].activeDate=t},S=function(){var t=e.transactionsDetails.bills[e.currentActiveBill],a=t.days.length;a>0&&a<=e.maxNoOfDaysToShow?angular.forEach(t.days,function(e){e.show=!0}):a>0&&angular.forEach(t.days,function(t,n){t.show=n>=a-e.maxNoOfDaysToShow})},A=function(t,a){var n=e.transactionsDetails.bills[e.currentActiveBill];t.transactions.length>0?(e.errorMessage="",n.transactions=[],_.each(t.transactions,function(e){e.description=null!==e.card_number&&""!==e.card_number?e.description+"-"+e.card_number:e.description}),n.transactions=t.transactions,n.total_count=t.total_count,Z(),angular.forEach(n.transactions,function(e,t){e.billValue=n.bill_number,e.oldBillValue=n.bill_number}),N(!1),f(function(){e.$broadcast("updatePagination",n.bill_number)},1e3),a?C(a):S()):0===t.transactions.length&&n.transactions.length>0?I():e.errorMessage=["The date selected has no transactions, please select a new date"]},D=function(t){e.errorMessage=t},b=function(t,a){var n=e.transactionsDetails.bills[e.currentActiveBill];n.page_no=t||1;var r={bill_id:n.bill_id,date:a?a:n.activeDate,page:n.page_no,per_page:e.perPage},i={successCallBack:A,failureCallBack:D,successCallBackParameters:a,params:r};e.callAPI(s.fetchBillTransactionDetails,i)};e.hasMoveToOtherBillPermission=function(){return t.isStandAlone&&d.getPermissionValue("MOVE_CHARGES_RESERVATION_ACCOUNT")},e.clickedVoidBillButton=function(){e.isFromAccounts=!0,r.open({template:"/assets/partials/bill/rvVoidBillPopup.html",controller:"RVVoidBillPopupCtrl",className:"",scope:e})},e.shouldShowVoidBill=function(){return!e.transactionsDetails.bills[e.currentActiveBill].is_active&&0===parseInt(e.transactionsDetails.bills[e.currentActiveBill].balance_amount)&&!e.transactionsDetails.bills[e.currentActiveBill].is_db_payment_exists&&e.transactionsDetails.is_void_bill_enabled&&!e.transactionsDetails.bills[e.currentActiveBill].is_voided&&!e.transactionsDetails.bills[e.currentActiveBill].is_void_bill},e.addListener("VOID_BILL_GENERATED",function(){e.closeDialog(),I()});var N=function(t){var a=e.transactionsDetails.bills,n=a[e.currentActiveBill].transactions;_.each(n,function(e){e.isSelected=t}),e.transactionsDetails.isAllChargeCodeSelected=t};e.isAllChargeCodesSelected=function(){var a=!0,n=e.transactionsDetails.bills;if(t.isStandAlone){var r=n[e.currentActiveBill].transactions;r&&r.length>0?_.each(r,function(e){e.isSelected||(a=!1)}):a=!1}else a=!1;return a},e.isAnyOneChargeCodeIsExcluded=function(){var t=!1,a=!1,n=e.transactionsDetails.bills,r=n[e.currentActiveBill].transactions;return r&&r.length>0?_.each(r,function(e,n){e.isSelected?a=!0:t=!0}):(t=!1,a=!1),t&&a},e.selectAllChargeCodeToggle=function(){N(e.transactionsDetails.isAllChargeCodeSelected?!0:!1)},e.moveChargesClicked=function(){g.start("MOVE_CHARGES_CLICKED"),h.fetchAssets(["addBillingInfo","directives"]).then(function(){g.stop("MOVE_CHARGES_CLICKED");var t=e.transactionsDetails.bills,a=t[e.currentActiveBill].transactions;e.moveChargeData={},e.moveChargeData.selectedTransactionIds=[];var n="undefined"!=typeof e.accountConfigData.summary.posting_account_name?e.accountConfigData.summary.posting_account_name:"";e.moveChargeData.displayName=n,e.moveChargeData.currentActiveBillNumber=parseInt(e.currentActiveBill)+parseInt(1),e.moveChargeData.fromBillId=t[e.currentActiveBill].bill_id,e.moveChargeData.isMoveAllCharges=!1,e.moveChargeData.totalCount=e.transactionsDetails.bills[e.currentActiveBill].total_count,e.moveChargeData.date=e.invoiceDate,a.length>0&&(_.each(a,function(t,a){if(t.isSelected)if(t.is_group_by_ref){var n=e.moveChargeData.selectedTransactionIds.concat(t.item_ids);e.moveChargeData.selectedTransactionIds=n}else e.moveChargeData.selectedTransactionIds.push(t.id)}),e.origin="ACCOUNT",r.open({template:"/assets/partials/bill/rvMoveTransactionPopup.html",controller:"RVMoveChargeCtrl",className:"",scope:e}))})},e.hasPermissionToMoveCharges=function(){return d.getPermissionValue("GROUP_MOVE_CHARGES_BILL")};var P=(function(){e.currentActiveBill=0,e.dayRates=-1,e.isStandAlone=t.isStandAlone,e.setScroller("registration-content"),e.setScroller("bill-tab-scroller",{scrollX:!0}),e.setScroller("billDays",{scrollX:!0,scrollY:!1}),e.showMoveCharges=e.hasPermissionToMoveCharges(),e.renderData={},e.paymentModalOpened=!1,e.isFromGroups="undefined"!=typeof e.groupConfigData&&"TRANSACTIONS"===e.groupConfigData.activeTab,e.invoiceDate=t.businessDate}(),function(){var t=function(t){e.transactionsDetails.is_bill_lock_enabled&&(e.transactionsDetails.bills[e.currentActiveBill].is_active=!1)},a=function(t){e.errorMessage=t},n={bill_id:e.transactionsDetails.bills[e.currentActiveBill].bill_id},r={params:n,successCallBack:t,failureCallBack:a};e.callAPI(u.callBlackBoxApi,r)});y.generateFolioNumber=function(t,a,n,r){if(e.shouldGenerateFolioNumber=!1,0===parseInt(a)&&!n){var i=function(t){e.transactionsDetails.is_bill_lock_enabled&&(e.transactionsDetails.bills[r].is_active=!1),e.transactionsDetails.bills[r].is_folio_number_exists=!0},o={bill_id:t},s={params:o,successCallBack:i};e.callAPI(u.generateFolioNumber,s)}};var T=function(a){e.hasPrintFolioEnabled=a.is_print_folio_enabled,e.transactionsDetails=a;var n=e.transactionsDetails.bills[e.currentActiveBill];0===parseInt(n.balance_amount)&&e.isFromPaymentScreen&&(e.isFromPaymentScreen=!1,t.isInfrasecActivated&&t.isInfrasecActivatedForWorkstation&&P()),0===parseInt(n.balance_amount)&&e.shouldGenerateFolioNumber&&y.generateFolioNumber(n.bill_id,n.balance_amount,n.is_folio_number_exists,e.currentActiveBill),X(),e.shouldGenerateFolioNumber=!1,e.refreshScroller("bill-tab-scroller"),e.refreshScroller("billDays")},O=e.$on("moveChargeSuccsess",function(t,a){var n=function(e){T(e)},i={account_id:e.accountConfigData.summary.posting_account_id},o={params:i,successCallBack:n};a.is_move_charges_inprogress?r.open({template:"/assets/partials/bill/rvMoveAllChargesInprogress.html",className:"",scope:e}):e.callAPI(s.fetchTransactionDetails,o)});e.$on("$destroy",O);var I=function(){var t=function(e){T(e)},a={account_id:e.accountConfigData.summary.posting_account_id},n={successCallBack:t,params:a};e.callAPI(s.fetchTransactionDetails,n)};e.$on("AUTO_TRIGGER_EMAIL_AFTER_PAYMENT",function(t,a){e.sendAutomaticEmails(a)}),e.UPDATE_TRANSACTION_DATA=function(){I()};var E=e.$on("UPDATE_TRANSACTION_DATA",function(a,n){n.response_data&&n.response_data.message&&B(n.response_data),e.isFromPaymentScreen=n.isFromPaymentSuccess,(e.isFromPaymentScreen&&!e.transactionsDetails.is_bill_lock_enabled||"DB"===n.selectedPaymentType)&&(e.shouldGenerateFolioNumber=!0),I(),e.currentPaymentBillId=n.bill_id,e.currentPaymentTransactionId=n.transaction_id,e.isFromGroups&&t.autoEmailPayReceipt&&e.isFromPaymentScreen&&e.autoTriggerPaymentReceiptActions()}),B=function(t){e.message=t.message,f(function(){r.open({template:"/assets/partials/bill/rvShowMessagePopup.html",className:"",closeByDocument:!1,scope:e})},1e3)};e.$on("$destroy",E),e.createNewBill=function(){var t={account_id:e.accountConfigData.summary.posting_account_id},a=function(e){I()},n={params:t,successCallBack:a};e.callAPI(s.createAnotherBill,n)},e.moveToBillActionfetchSuccessCallback=function(t){e.fetchSuccessCallback(t)},e.moveToBillAction=function(t,a){var n=parseInt(t)-1,r=e.transactionsDetails.bills[n].transactions[a],i=r.billValue,o=r.id?r.id:null,c=r.item_ids?r.item_ids:[],l={to_bill:i,from_bill:t,transaction_id:o,item_ids:c,account_id:e.accountConfigData.summary.posting_account_id},u=function(t){e.$emit("hideLoader"),l.toBill=parseInt(t.bill_id),e.transactionsDetails.bills[t.bill_number-1]={bill_id:t.bill_id,bill_number:t.bill_number},I(l)},d=function(t){e.$emit("hideLoader"),e.errorMessage=t};e.invokeApi(s.moveToAnotherBill,l,u,d)},e.getWidthForBillTabsScroll=function(){var t=0;if(void 0!==e.transactionsDetails)var t=$("#registration-summary ul li").width()*(e.transactionsDetails.bills.length+1);return t},e.showActiveBill=function(t){var a=e.transactionsDetails.bills[t],n="",r=e.transactionsDetails.bills.length,i=a.is_transactions_exist;return 0===t||t!==e.currentActiveBill||r-1!==t||i?t===e.currentActiveBill&&(n="ui-tabs-active ui-state-active"):n="ui-tabs-active ui-state-active with-button",n},e.setActiveBill=function(t){e.currentActiveBill=t;var a=e.transactionsDetails.bills[t];a.activeDate=a.days.length>0?_.last(a.days).date:null,X()},e.callAPI(u.fetchAdjustmentReasons,{successCallBack:function(t){e.adjustmentReasonOptions=t.force_adjustment_reasons,e.showAdjustmentReason=t.force_adjustment_reason_enabled}}),e.openPostCharge=function(t){g.start("OPEN_POST_CHARGE"),h.fetchAssets(["postcharge","directives"]).then(function(){g.stop("OPEN_POST_CHARGE"),e.account_id=e.accountConfigData.summary.posting_account_id,e.billNumber=t;for(var a=[],n=0;n<e.transactionsDetails.bills.length;n++)a.push(n+1);e.fetchedData={},e.fetchedData.bill_numbers=a,e.isOutsidePostCharge=!1,e.shouldShowChargesForMobile=!1,r.open({template:"/assets/partials/postCharge/rvPostChargeV2.html",className:"",scope:e})})};var w=function(){var t={account_id:e.accountConfigData.summary.posting_account_id,is_swiped:!1,details:{firstName:"",lastName:""}};return t};e.showPayemntModal=function(){g.start("SHOW_PAYMENT_MODEL"),h.fetchAssets(["addBillingInfo","directives"]).then(function(){g.stop("SHOW_PAYMENT_MODEL"),e.passData=w(),e.paymentModalOpened=!0,e.$emit("TOGGLE_PAYMET_POPUP_STATUS",!0),r.open({template:"/assets/partials/accounts/transactions/rvAccountPaymentModal.html",className:"",controller:"RVAccountsTransactionsPaymentCtrl",closeByDocument:!1,scope:e})})},e.$on("showValidationErrorPopup",function(t,a){e.status="error",e.popupMessage=a,f(function(){r.open({template:"/assets/partials/validateCheckin/rvShowValidation.html",controller:"",scope:e})},100)}),e.okButtonClicked=function(){R()};var R=function(){r.close()},k=e.$on("HANDLE_MODAL_OPENED",function(t){e.paymentModalOpened=!1,e.$emit("TOGGLE_PAYMET_POPUP_STATUS",!1)});e.$on("$destroy",k);var j=function(t){var a=w(),n=new SwipeOperation,r=n.createSWipedDataToRender(t);a.details.swipedDataToRenderInScreen=r,e.$broadcast("SHOW_SWIPED_DATA_ON_PAY_SCREEN",r)};e.$on("SWIPE_ACTION",function(t,a){if(e.paymentModalOpened){var n=new SwipeOperation,r=n.createDataToTokenize(a),i=function(t){e.$emit("hideLoader"),a.token=t,j(a)};e.invokeApi(l.tokenize,r,i)}});var M=function(e){var t="PAYMENT"!==e,a=d.getPermissionValue("SPLIT_CHARGES"),n=d.getPermissionValue("EDIT_CHARGES"),r=d.getPermissionValue("DELETE_CHARGES");return t&&(n||r)||a};e.hasPermissionToEditChargeCodeDescription=function(){return d.getPermissionValue("EDIT_CHARGECODE_DESCRIPTION")},e.hasPermissionToSplitCharges=function(){return d.getPermissionValue("SPLIT_CHARGES")},e.hasPermissionToEditCharges=function(){return d.getPermissionValue("EDIT_CHARGES")},e.hasPermissionToDeleteCharges=function(){return d.getPermissionValue("DELETE_CHARGES")},e.showEditChargeButton=function(e){return t.isStandAlone&&"TAX"!==e&&M()},e.splitTypeisAmount=!0,e.chargeCodeActive=!1,e.selectedChargeCode={},e.getAllchargeCodes=function(t){t(e.chargeCodeData)},e.setchargeCodeActive=function(t){e.chargeCodeActive=t},e.HIDE_LOADER_FROM_POPUP=function(){e.$emit("hideLoader")},e.openActionsPopup=function(t,a,n,i,o,s,c,l){e.errorMessage="",e.hideRemoveAndEdit="PAYMENT"===i,e.selectedTransaction={},e.selectedTransaction.id=t,e.selectedTransaction.desc=a,e.reference_text=s,e.show_ref_on_invoice=c,e.show_split_payment=l,n?e.selectedTransaction.amount=n:o&&(e.selectedTransaction.amount=o),r.open({template:"/assets/partials/bill/rvBillActionsPopup.html",className:"",scope:e})},e.callActionsPopupAction=function(t){r.close(),"custom_description"===t?e.openEditChargeDescPopup():"remove"===t?e.openRemoveChargePopup():"split"===t?e.openSplitChargePopup():"edit"===t&&e.openEditChargePopup()},e.openRemoveChargePopup=function(){r.open({template:"/assets/partials/bill/rvRemoveChargePopup.html",controller:"RVAccountTransactionsPopupCtrl",className:"",scope:e})},e.openEditChargeDescPopup=function(){r.open({template:"/assets/partials/bill/rvEditChargePopup.html",controller:"RVAccountTransactionsPopupCtrl",className:"",scope:e})},e.openSplitChargePopup=function(){r.open({template:"/assets/partials/bill/rvSplitChargePopup.html",controller:"RVAccountTransactionsPopupCtrl",className:"",scope:e})},e.openEditChargePopup=function(){e.selectedChargeCode={id:"",name:"",description:"",associcated_charge_groups:[]},r.open({template:"/assets/partials/bill/rvEditPostingPopup.html",className:"",controller:"RVAccountTransactionsPopupCtrl",scope:e}),e.setScroller("chargeCodesList")},e.sendEmail=function(t){if(e.shouldGenerateFinalInvoice&&!e.billFormat.isInformationalInvoice)L(t,!1);else{e.closeDialog();var n=function(t){t.is_invoice_issued?(e.statusMsg=a("translate")("EMAIL_SENT_SUCCESSFULLY"),e.status="success",e.shouldGenerateFinalInvoice&&!e.billFormat.isInformationalInvoice?e.$broadcast("UPDATE_WINDOW"):e.showEmailSentStatusPopup(),e.switchTabTo("TRANSACTIONS")):f(function(){G()},500)},r=function(t){e.statusMsg=a("translate")("EMAIL_SEND_FAILED"),e.status="alert",e.showEmailSentStatusPopup()};e.callAPI(i.emailInvoice,{successCallBack:n,failureCallBack:r,params:t})}};var L=function(t,a){var n=function(){e.shouldGenerateFinalInvoice=!1,I(),a?F(t):e.sendEmail(t)},r={params:{bill_id:e.transactionsDetails.bills[e.currentActiveBill].bill_id,bill_address_type:t.type},successCallBack:n};e.callAPI(u.settleFinalInvoice,r)},G=function(){r.open({template:"/assets/partials/popups/billFormat/rvInvoicePendingInfoPopup.html",className:"",scope:e})};e.clickedEmail=function(t){e.sendEmail(t)},e.clickedPrint=function(t){e.closeDialog(),g.start("PRINT_STARTED"),F(t)};var J=function(){e.invoiceActive=!1,e.printGroupProfomaActive=!1,$(".nav-bar").removeClass("no-print"),$(".cards-header").removeClass("no-print"),$(".card-tabs-nav").removeClass("no-print"),e.shouldGenerateFinalInvoice&&!e.billFormat.isInformationalInvoice?e.$broadcast("UPDATE_WINDOW"):e.closeDialog(),$("body #loading").html('<div id="loading-spinner" ></div>'),e.switchTabTo("TRANSACTIONS")},F=function(t){if(e.shouldGenerateFinalInvoice&&!e.billFormat.isInformationalInvoice)L(t,!0);else{var a=function(e){var t="";return e.is_copy_counter&&(t=parseInt(e.print_counter)-parseInt(e.no_of_original_invoices)),t},n=function(t){g.stop("PRINT_STARTED");var n=t.data,r="",i=700,o=moment(n.print_ar_invoice_number_activated_at,"YYYY-MM-DD"),s=moment(n.ar_transaction_date,"YYYY-MM-DD"),c=s.diff(o,"days"),l="";e.shouldShowArInvoiceNumber=!0,c<0&&(e.shouldShowArInvoiceNumber=!1),n.is_group&&n.is_proforma_invoice&&(e.invoiceActive=!1,e.printGroupProfomaActive=!0),e.billFormat.isInformationalInvoice?n.invoiceLabel=n.translation.information_invoice:null!==n.no_of_original_invoices||e.transactionsDetails.bills[e.currentActiveBill].is_void_bill?e.transactionsDetails.bills[e.currentActiveBill].is_void_bill?null===n.no_of_original_invoices||parseInt(n.print_counter,10)<=parseInt(n.no_of_original_invoices,10)?n.invoiceLabel=n.translation.void_invoice:parseInt(n.print_counter,10)>parseInt(n.no_of_original_invoices,10)&&(r=a(n),n.invoiceLabel=n.translation.copy_of_void_invoice.replace("#count",r)):parseInt(n.print_counter,10)<=parseInt(n.no_of_original_invoices,10)?n.invoiceLabel=n.posting_account_invoice_label||n.translation.invoice:parseInt(n.print_counter,10)>parseInt(n.no_of_original_invoices,10)&&(r=a(n),l=n.posting_account_invoice_copy_label||n.translation.copy_of_invoice,n.invoiceLabel=l.replace("#count",r)):n.invoiceLabel=n.posting_account_invoice_label||n.translation.invoice,n.is_invoice_issued?(e.invoiceActive=!0,e.printData=n,e.errorMessage="",$(".nav-bar").addClass("no-print"),$(".cards-header").addClass("no-print"),$(".card-tabs-nav").addClass("no-print"),$("body #loading").html(""),f(function(){sntapp.cordovaLoaded?cordova.exec(J,function(e){J()},"RVCardPlugin","printWebView",[]):f(function(){window.print(),J()},i)},100)):G()},r=function(t){e.$emit("hideLoader"),e.errorMessage=t};e.invokeApi(s.fetchAccountBillsForPrint,t,n,r)}},V=function(t){var a=function(){e.$emit("hideLoader"),I(),e.diretBillpaymentData={}};e.callAPI(s.submitPaymentOnBill,{successCallBack:a,params:e.diretBillpaymentData})},x=t.$on("arAccountCreated",function(){e.diretBillpaymentData.data_to_pass.is_new_ar_account=!0,V()}),U=e.$on("arAccountWillBeCreated",function(t,a){e.account_id=a.account_id,e.is_auto_assign_ar_numbers=a.is_auto_assign_ar_numbers,e.diretBillpaymentData=a.paymentDetails,r.open({template:"/assets/partials/payment/rvAccountReceivableMessagePopup.html",controller:"RVAccountReceivableMessagePopupCtrl",className:"",scope:e})});e.$on("$destroy",U),e.$on("$destroy",x);var W=function(t){e.chargeCodeData=t.results,e.availableChargeCodes=t.results},H=function(t){e.isFromGroups="undefined"!=typeof e.groupConfigData&&"TRANSACTIONS"===e.groupConfigData.activeTab};e.getInvoiceButtonClass=function(){var t="blue";return!e.transactionsDetails.bills[e.currentActiveBill].is_active&&e.transactionsDetails.bills[e.currentActiveBill].is_folio_number_exists&&e.roverObj.noReprintReEmailInvoice&&e.transactionsDetails.bills[e.currentActiveBill].is_printed_once&&e.transactionsDetails.bills[e.currentActiveBill].is_emailed_once&&(t="grey"),t},e.isInvoiceButtonDisabled=function(){var t=!1;return!e.transactionsDetails.bills[e.currentActiveBill].is_active&&e.transactionsDetails.bills[e.currentActiveBill].is_folio_number_exists&&e.roverObj.noReprintReEmailInvoice&&e.transactionsDetails.bills[e.currentActiveBill].is_printed_once&&e.transactionsDetails.bills[e.currentActiveBill].is_emailed_once&&(t=!0),
t};var Y=function(t){e.$emit("hideLoader")};e.hasPermissionToViewTransactionsTab=function(){return d.getPermissionValue("ACCESS_GROUP_ACCOUNT_TRANSACTIONS")};var q=function(){if(!e.hasPermissionToViewTransactionsTab())return void(e.errorMessage=["Sorry, You dont have enough permission to proceed!!"]);var t=[];e.$emit("showLoader");var a={account_id:e.accountConfigData.summary.posting_account_id};t.push(s.fetchTransactionDetails(a).then(T)),t.push(u.fetchChargeCodes().then(W)),v.all(t).then(H,Y)};e.changeBillingReferenceNumber=function(){e.isBillingReferenceNumberChanged=!0},e.$on("ACCOUNT_TAB_SWITCHED",function(t,a){"TRANSACTIONS"===a?q():e.isBillingReferenceNumberChanged&&z()});var z=function(){if(d.getPermissionValue("EDIT_ACCOUNT")){var t=function(t){e.isBillingRefernceNumberChanged=!1,e.$broadcast("UPDATED_ACCOUNT_INFO"),e.$emit("hideloader")},a=function(t){e.$broadcast("FAILED_TO_UPDATE_ACCOUNT_INFO"),e.$emit("showErrorMessage",t),e.$emit("hideloader")};e.callAPI(i.updateBillingRefNumber,{successCallBack:t,failureCallBack:a,params:{summary:e.accountConfigData.summary,custom_reference_number:e.transactionsDetails.custom_reference_number}})}else e.$emit("showErrorMessage",["Sorry, Changes will not get saved as you don't have enough permission"])},K=e.$on("GROUP_TAB_SWITCHED",function(t,a){"TRANSACTIONS"===a?q():e.isBillingReferenceNumberChanged&&z()});e.$on("$destroy",K);var Q=e.$on("UPDATE_INFORMATIONAL_INVOICE",function(t,a){e.billFormat.isInformationalInvoice=a});e.$on("$destroy",Q),e.showFormatBillPopup=function(t,a){e.billNo=t,e.isSettledBill=a,e.billFormat={},e.billFormat.isInformationalInvoice=!1,e.isFolioNumberExists=e.transactionsDetails.bills[e.currentActiveBill].is_folio_number_exists,e.reservationBillData=e.transactionsDetails,e.transactionsDetails.bills[e.currentActiveBill].is_transactions_exist&&0===parseInt(e.transactionsDetails.bills[e.currentActiveBill].balance_amount)&&e.transactionsDetails.is_bill_lock_enabled&&e.transactionsDetails.bills[e.currentActiveBill].is_active?(e.isInvoiceStepOneActive=!0,e.isInvoiceStepThreeActive=!1,e.shouldGenerateFinalInvoice=!0):(e.isInvoiceStepOneActive=!1,e.isInvoiceStepThreeActive=!0,e.shouldGenerateFinalInvoice=!1),e.isInvoiceStepTwoActive=!1,e.isInvoiceStepFourActive=!1,e.isInvoiceStepFiveActive=!1,r.open({template:"/assets/partials/popups/billFormat/rvBillFormatPopup.html",controller:"rvBillFormatPopupCtrl",className:"",scope:e})},e.showEmailSentStatusPopup=function(t){r.open({template:"/assets/partials/popups/rvEmailSentStatusPopup.html",className:"",scope:e})};var X=function(){var t=e.transactionsDetails.bills[e.currentActiveBill];t.activeDate&&t.days.length>0?(f(function(){t.pageOptions={id:t.bill_number,perPage:e.perPage,api:b}},100),b()):(e.$emit("hideLoader"),Z())},Z=function(){f(function(){e.refreshScroller("registration-content")},500)};e.clickedSummaryDate=function(t){var a=e.transactionsDetails.bills[e.currentActiveBill];a.activeDate=t,b(null,t)},e.expandGroupedCharge=function(t){var a=function(a){t.light_speed_data=a.data,t.isExpanded=!0,e.$emit("hideLoader"),Z()},n=function(t){e.errorMessage=t,e.emit("hideLoader")};if(t.isExpanded)t.isExpanded=!1,Z();else{var r={reference_number:t.reference_number,bill_id:e.transactionsDetails.bills[e.currentActiveBill].bill_id,date:t.date};e.invokeApi(s.groupChargeDetailsFetch,r,a,n)}},e.clickedRemoveBill=function(t){var a=function(){I(),e.currentActiveBill=t-1},n=function(t){e.errorMessage=t},r={params:{bill_id:e.transactionsDetails.bills[t].bill_id},successCallBack:a,failureCallBack:n};e.callAPI(u.hideBill,r)};var ee=function(){e.printReceiptActive=!1,$("header .logo").removeClass("logo-hide"),$("header .h2").removeClass("text-hide"),$("body #loading").html('<div id="loading-spinner" ></div>')};e.addListener("PRINT_RECEIPT",function(t,a){e.printReceiptActive=!0,e.receiptPrintData=a,e.errorMessage="",$(".nav-bar").addClass("no-print"),$(".cards-header").addClass("no-print"),$(".card-tabs-nav").addClass("no-print"),$("body #loading").html(""),f(function(){sntapp.cordovaLoaded?cordova.exec(ee,function(e){ee()},"RVCardPlugin","printWebView",[]):f(function(){window.print(),ee()},500)},100)}),e.openReceiptDialog=function(t){var a=e.transactionsDetails.bills[e.currentActiveBill].transactions[t];e.transactionId=a.id?a.id:null,e.billId=e.transactionsDetails.bills[e.currentActiveBill].bill_id,e.entityType="PostingAccount",r.open({template:"/assets/partials/popups/rvReceiptPopup.html",controller:"RVReceiptPopupController",className:"",scope:e})},e.clickedGotoDate=function(){var t=e.transactionsDetails.bills[e.currentActiveBill],a={minDate:t.days[0].date,maxDate:_.last(t.days).date,activeDate:t.activeDate};r.open({template:"/assets/partials/accounts/transactions/rvAccountDatePicker.html",controller:"rvAccountDatepickerCtrl",className:"single-date-picker",scope:e,data:a})},e.openAllowances=function(){e.$emit("showLoader"),h.fetchAssets(["rover.group.allowances","directives"]).then(function(){e.groupId=n.id,e.callAPI(s.fetchGroupAllowances,{params:{id:n.id,type:e.type},successCallBack:function(t){try{e.reservationBillData.groupedAllowances=t,r.open({template:"/assets/partials/groupAllowances/rvGroupAllowances.html",controller:"rvGroupAllowancesCtrl",className:"",scope:e})}catch(e){console.error(e)}},failureCallBack:function(t){e.groupedAllowanceData=!1}})}).then(function(){e.$emit("hideLoader")})},e.addListener("DATE_CHANGED",function(e,t){b(null,t)});var te=t.$on("CLICKED_VIEW_CHARGES",function(){e.shouldShowChargesForMobile=!0}),ae=t.$on("BACK_TO_CHARGES_LIST",function(){e.shouldShowChargesForMobile=!1});e.$on("$destroy",te),e.$on("$destroy",ae)}]),sntRover.controller("RVAccountTransactionsPopupCtrl",["$scope","$rootScope","$filter","rvAccountTransactionsSrv","ngDialog","$timeout",function(e,t,a,n,r,i){BaseCtrl.call(this,e),e.warningMessage="",e.adjustmentData={};var o=function(){i(function(){e.UPDATE_TRANSACTION_DATA&&e.UPDATE_TRANSACTION_DATA()},1)},s=function(){r.close(),i(function(){e.HIDE_LOADER_FROM_POPUP&&e.HIDE_LOADER_FROM_POPUP(),o()},1e3)};e.removeCharge=function(t){e.$emit("showLoader");var a={data:{reason:t,process:"delete"},id:e.selectedTransaction.id},r={params:a,loader:"NONE",successCallBack:s};e.callAPI(n.transactionDelete,r)},e.showSpiltValues=function(){var t=e.selectedTransaction;e.splitTypeisAmount?(e.displayFirstValue=t.amount-e.splitValue,e.displaySecondValue=e.splitValue):(e.displaySecondValue=parseFloat(t.amount*e.splitValue/100).toFixed(2),e.displayFirstValue=t.amount-e.displaySecondValue)},e.splitCharge=function(a,r){e.$emit("showLoader");var i=r?t.currencySymbol:"%",o={id:e.selectedTransaction.id,data:{split_type:i,split_value:a}},c={params:o,loader:"NONE",successCallBack:s};e.callAPI(n.transactionSplit,c)},e.selectedAdjReason=function(){e.warningMessage=""},e.clearWarningMessage=function(){e.warningMessage=""},e.editCharge=function(){if(!e.adjustmentData.adjustmentReason&&e.showAdjustmentReason)return void(e.warningMessage="Please fill adjustment reason");e.$emit("showLoader");var t={updatedDate:{new_amount:e.newAmount,charge_code_id:e.selectedChargeCode.id,adjustment_reason:e.adjustmentData.adjustmentReason,reference_text:e.reference_text,show_ref_on_invoice:e.show_ref_on_invoice},id:e.selectedTransaction.id},a={params:t,loader:"NONE",successCallBack:s};e.callAPI(n.transactionEdit,a)},e.editChargeDescription=function(t){var a={postData:{custom_charge_description:t},id:e.selectedTransaction.id},r={params:a,loader:"NONE",successCallBack:s};e.callAPI(n.transactionEditChargeDescription,r)},e.chargecodeData={},e.chargecodeData.chargeCodeSearchText="";var c={click:!0,preventDefault:!1};e.setScroller("chargeCodesList",c),e.selectChargeCode=function(t){for(var a=0;a<e.availableChargeCodes.length;a++)e.availableChargeCodes[a].id===t&&(e.selectedChargeCode=e.availableChargeCodes[a]);e.showChargeCodes=!1,e.chargecodeData.chargeCodeSearchText=""};var l=function(){if(e.chargecodeData.chargeCodeSearchText.length<3){for(var t=0;t<e.availableChargeCodes.length;t++)e.availableChargeCodes[t].is_row_visible=!0,e.availableChargeCodes[t].is_selected=!0;e.refreshScroller("chargeCodesList")}else{for(var a="",t=0;t<e.availableChargeCodes.length;t++)a=e.availableChargeCodes[t],e.escapeNull(a.name).toUpperCase().indexOf(e.chargecodeData.chargeCodeSearchText.toUpperCase())>=0||e.escapeNull(a.description).toUpperCase().indexOf(e.chargecodeData.chargeCodeSearchText.toUpperCase())>=0?e.availableChargeCodes[t].is_row_visible=!0:e.availableChargeCodes[t].is_row_visible=!1;e.refreshScroller("chargeCodesList")}};e.clearResults=function(){e.chargecodeData.chargeCodeSearchText=""},e.showAvailableChargeCodes=function(){e.clearResults(),l(),e.showChargeCodes=!e.showChargeCodes},e.chargeCodeEntered=function(){e.showChargeCodes=!1,l();var t=e.chargecodeData.chargeCodeSearchText;e.chargecodeData.chargeCodeSearchText=t.charAt(0).toUpperCase()+t.slice(1)},e.isShowChargeCodeList=function(){var t=!1,a=e.availableChargeCodes.length,n=e.chargecodeData.chargeCodeSearchText.length;if(e.showChargeCodes)t=!0;else if(n>2&&0!==a)for(var r=0;r<a;r++)if(e.availableChargeCodes[r].is_row_visible){t=!0;break}return t},e.getEditChargeButtonText=function(){return e.chargeCodeActive?"CHANGE_CHARGE_CODE":"CHANGE_AMOUNT"}}]),sntRover.controller("RVAccountsTransactionsPaymentCtrl",["$scope","$rootScope","RVPaymentSrv","ngDialog","$filter","$timeout","rvAccountTransactionsSrv","rvPermissionSrv","RVReservationCardSrv",function(e,t,a,n,r,i,o,s,c){BaseCtrl.call(this,e),BasePaymentCtrl.call(this,e);var l=!1,u={},d={},p=parseFloat("0.00"),f=function(){var t=function(t){e.ArDetails=t,t.company_present&&t.travel_agent_present?e.showArSelection=!0:t.company_present?t.company_ar_attached?y("company"):D(e.ArDetails.company_id):t.travel_agent_present?t.travel_agent_ar_attached?y("travel_agent"):D(e.ArDetails.travel_agent_id):(e.showErrorPopup(r("translate")("ACCOUNT_ID_NIL_MESSAGE_PAYMENT")),i(function(){n.close()},100))},a={account_id:e.accountConfigData.summary.posting_account_id};e.callAPI(o.checkForArAccount,{successCallBack:t,params:a})},m=function(t){e.$emit("hideLoader"),e.errorMessage=t,e.showArSelection=!1},v=function(){var n=function(t){e.renderData.paymentTypes=t,C()},r=function(t){e.errorMessage=t};if(e.callAPI(a.renderPaymentScreen,{successCallBack:n,failureCallBack:r,params:{direct_bill:!0}}),"tax_payment_receipt"===t.selectedReceiptTypeValue){var i={bill_holder_id:e.accountConfigData.summary.posting_account_id,bill_holder_type:"PostingAccount"};e.invokeApi(a.getReceiptsList,i,e.getReceiptsListSuccess)}},h=function(){return s.getPermissionValue("POST_PAYMENT")},g=function(){return s.getPermissionValue("POST_REFUND")},y=function(a){e.errorMessage="";var n=b(a);"sixpayments"!==t.paymentGateway||e.isManual||"CC"!==e.saveData.paymentType?e.callAPI(o.submitPaymentOnBill,{successCallBack:P,failureCallBack:m,params:n}):(n.data_to_pass.is_emv_request=!0,e.shouldShowWaiting=!0,o.submitPaymentOnBill(n).then(function(t){e.shouldShowWaiting=!1,P(t)},function(t){e.errorMessage=t,e.shouldShowWaiting=!1}))},C=function(){var t=e.billsArray[e.currentActiveBill].balance_amount?e.billsArray[e.currentActiveBill].balance_amount:p,a=e.billsArray[e.currentActiveBill].default_payment_amount?e.billsArray[e.currentActiveBill].default_payment_amount:p;e.renderData.defaultPaymentAmount=parseFloat(t).toFixed(2),e.renderData.defaultPaymentCurrencyAmount=a,e.defaultRefundAmount=-1*parseFloat(e.renderData.defaultPaymentAmount),e.renderData.defaultPaymentAmount<0?(e.defaultRefundAmount=-1*parseFloat(e.renderData.defaultPaymentAmount),e.shouldShowMakePaymentButton=!1):e.shouldShowMakePaymentButton=!0},S=function(){e.$$phase||e.$digest()},A=function(t){l=angular.copy(e.newPaymentInfo.tokenDetails.isSixPayment),u=angular.copy(e.newPaymentInfo.tokenDetails),d=angular.copy(e.newPaymentInfo.cardDetails);var a=l?t.tokenDetails.token_no:u.session,n=l?u.expiry.substring(2,4):d.expiryMonth,r=l?u.expiry.substring(0,2):d.expiryYear,i=n&&r?"20"+r+"-"+n+"-01":"",s=l?getSixCreditCardType(u.card_type).toLowerCase():d.cardType;e.callAPI(o.savePaymentDetails,{successCallBack:N,params:{bill_id:e.billsArray[e.renderData.billNumberSelected-1].bill_id,data_to_pass:{card_expiry:i,name_on_card:e.newPaymentInfo.cardDetails.userName,payment_type:"CC",token:a,card_code:s}}})},D=function(t,a){n.close();var r=b(a),i={account_id:t,is_auto_assign_ar_numbers:e.ArDetails.is_auto_assign_ar_numbers,paymentDetails:r};e.$emit("arAccountWillBeCreated",i)},b=function(t){var a={data_to_pass:{bill_number:e.renderData.billNumberSelected,payment_type:e.saveData.paymentType,amount:e.renderData.defaultPaymentAmount,payment_method_id:"CC"===e.saveData.paymentType?e.saveData.payment_type_id:null,reference_text:e.renderData.referanceText},bill_id:e.billsArray[e.renderData.billNumberSelected-1].bill_id};return"undefined"!=typeof t&&""!==t&&(a.data_to_pass.ar_type=t),e.isShowFees()&&(e.feeData.calculatedFee&&(a.data_to_pass.fees_amount=e.feeData.calculatedFee),e.feeData.feesInfo&&(a.data_to_pass.fees_charge_code_id=e.feeData.feesInfo.charge_code_id)),a},N=function(t){e.$emit("hideLoader");var a="",n="",r="",i=angular.copy(e.swipedCardDataToSave);isEmptyObject(i)?(a=retrieveCardtype(l,u,d),n=retrieveCardNumber(l,u,d),r=retrieveCardExpiryDate(l,u,d)):(a=i.cardType.toLowerCase(),n=i.cardNumber.slice(-4),r=i.cardExpiryMonth+"/"+i.cardExpiryYear,e.saveData.paymentType="CC"),e.defaultPaymentTypeCard=a,e.defaultPaymentTypeCardNumberEndingWith=n,e.defaultPaymentTypeCardExpiry=r,checkReferencetextAvailableForCC(),_.each(e.renderData.paymentTypes,function(t){"CC"===t.name&&_.each(t.values,function(t){a.toUpperCase()===t.cardcode&&(e.feeData.feesInfo=t.charge_code.fees_information,setupFeeData())})}),e.saveData.payment_type_id=t.id,e.showCCPage=!1,e.swippedCard=!1,e.showCreditCardInfo=!0,e.newCardAdded=!0,e.swipedCardDataToSave={}},P=function(t){e.$emit("hideLoader"),e.depositPaidSuccesFully=!0,e.authorizedCode=t.authorization_code,t.isFromPaymentSuccess=!0,e.$emit("UPDATE_TRANSACTION_DATA",t),e.showArSelection=!1};e.billPaymentReceiptData={},e.billPaymentReceiptData.allBillReceiptsList={},e.feeData={},e.renderData={},e.showArSelection=!1,e.swipedCardDataToSave={},e.saveData={},e.renderData={},e.errorMessage="",e.saveData.payment_type_id="",e.newPaymentInfo={},e.renderData.billNumberSelected="",e.renderData.defaultPaymentAmount="",e.renderData.defaultPaymentCurrencyAmount="",e.defaultRefundAmount=0,e.currentActiveBillNumber=parseInt(e.currentActiveBill)+parseInt(1),e.renderData.billNumberSelected=e.currentActiveBillNumber,e.renderData.billNumberSelected=e.currentActiveBillNumber,e.billsArray=e.transactionsDetails.bills,e.passData={},e.passData.details={},e.renderData.referanceText="",e.swipedCardDataToSave={},e.cardData={},e.newCardAdded=!1,e.shouldShowWaiting=!1,e.depositPaidSuccesFully=!1,e.saveData.paymentType="",e.defaultPaymentTypeOfBill="",e.shouldShowMakePaymentButton=!0,e.hasPermissionToMakePayment=h(),e.hasPermissionToRefundPayment=g(),e.billNumberChanged=function(){e.currentActiveBill=parseInt(e.renderData.billNumberSelected)-parseInt(1),e.billPaymentReceiptData.receiptsList=_.find(e.billPaymentReceiptData.allBillReceiptsList.payment_receipts,{bill_number:e.billsArray[e.currentActiveBill].bill_number.toString()}),C()},e.changeOnsiteCallIn=function(){e.showCCPage=!!e.isManual},e.closeDialog=function(){e.paymentModalOpened=!1,e.$emit("HANDLE_MODAL_OPENED"),n.close()},e.getReceiptsListSuccess=function(t){e.billPaymentReceiptData.allBillReceiptsList=t.data,e.billPaymentReceiptData.receiptsList=_.find(e.billPaymentReceiptData.allBillReceiptsList.payment_receipts,{bill_number:e.billsArray[e.currentActiveBill].bill_number.toString()})},e.hasPermissionToMakePayment=function(){return s.getPermissionValue("MAKE_PAYMENT")},e.showErrorPopup=function(t){e.$emit("showValidationErrorPopup",t)},e.submitPayment=function(){e.renderData.defaultPaymentAmount>0||e.renderData.defaultPaymentAmount<0?"DB"===e.saveData.paymentType?f():y():i(function(){e.errorMessage=["Please enter amount to pay"]},200)},e.selectArAccount=function(t){e.$broadcast("CONTINUE_DIRECT_BILL_PAYMENT",{ar_type:t,arDetails:e.ArDetails}),e.showArSelection=!1},e.$on("cancelCardSelection",function(t,a){e.showCCPage=!1,e.swippedCard=!1,e.isManual=!1,e.saveData.paymentType=""}),e.$on("changeOnsiteCallIn",function(t){e.isManual=!e.isManual,e.changeOnsiteCallIn()}),e.$on("CLOSE_DIALOG",e.closeDialog),e.$on("MLI_ERROR",function(t,a){e.errorMessage=a}),e.$on("PAYMENT_FAILED",function(e,t){m(t)}),e.$on("PAYMENT_SUCCESS",function(e,t){P(t)}),e.$on("PAYMENT_TYPE_CHANGED",function(t,a){e.showCCPage="CC"===a}),e.$on("SHOW_AR_SELECTION",function(t,a){e.ArDetails=a,e.showArSelection=!0}),e.$on("SHOW_SWIPED_DATA_ON_PAY_SCREEN",function(t,a){e.showCCPage=!0,e.swippedCard=!0,e.addmode=!0,e.$broadcast("RENDER_SWIPED_DATA",a)}),e.$on("SWIPED_DATA_TO_SAVE",function(t,a){e.swipedCardDataToSave=a;var n=a;n.payment_credit_type=a.cardType,n.credit_card=a.cardType,n.card_expiry="20"+a.cardExpiryYear+"-"+a.cardExpiryMonth+"-01",e.callAPI(o.savePaymentDetails,{successCallBack:N,params:{bill_id:e.billsArray[e.renderData.billNumberSelected-1].bill_id,data_to_pass:n}})}),e.$on("TOKEN_CREATED",function(t,a){e.newPaymentInfo=a,e.showCCPage=!1,e.swippedCard=!1,setTimeout(function(){A(a)},200),S()}),function(){v()}()}]);var BasePaymentCtrl=function(e){BaseCtrl.call(this,e);var t=function(){e.isFromAccounts=!0,e.shouldShowWaiting=!1,e.addmode=!0,e.savePayment={},e.isNewCardAdded=!1,e.isManual=!1,e.dataToSave={},e.showCCPage=!1,e.swippedCard=!1,e.cardsList=[],e.errorMessage=""};t(),e.changePaymentType=function(){return"sixpayments"===e.paymentGateway?void(e.isNewCardAdded="CC"===e.dataToSave.paymentType&&!e.isManual):(e.showCCPage="CC"===e.dataToSave.paymentType,e.swippedCard="CC"===e.dataToSave.paymentType,e.showCCPage="CC"===e.dataToSave.paymentType,e.addmode=!0,void 0)},e.changeOnsiteCallIn=function(){e.showCCPage=!!e.isManual,e.swippedCard=!!e.isManual,e.addmode=!0}};sntRover.controller("rvAccountsConfigurationCtrl",["$scope","$rootScope","rvGroupSrv","$filter","$stateParams","rvAccountsConfigurationSrv","rvGroupConfigurationSrv","accountData","$state","rvPermissionSrv","rvAccountTransactionsSrv","$vault","$timeout","transitions",function(e,t,a,n,r,i,o,s,c,l,u,d,p,f){BaseCtrl.call(this,e);var m=function(){e.$$phase||e.$digest()};e.isInAddMode=function(){return"NEW_ACCOUNT"===r.id};var v=function(){var t=n("translate")("ACCOUNT_DETAILS");e.isInAddMode()&&(t=n("translate")("NEW_ACCOUNT")),e.setHeadingTitle(t)};e.updateAndBackFlag=!1,e.updateAndBack=function(){e.isInAddMode?c.go("rover.accounts.search"):(e.$broadcast("UPDATE_ACCOUNT_SUMMARY"),e.updateAccountSummary(),e.updateAndBackFlag=!0)};var _=function(){if(r.isFromCards)t.setPrevState={title:n("translate")("ACCOUNTS"),callback:"updateAndBack",scope:e};else if(r.isFromArTransactions){var a=r.isFromArTab;t.setPrevState={title:"AR Transactions",name:"rover.companycarddetails",param:{id:d.get("cardId"),type:d.get("type"),query:d.get("query"),isBackFromStaycard:!0,isBackFromStaycardToARTab:a}}}else"rover.financials.invoiceSearch"===e.previousState.name?t.setPrevState={title:"INVOICE SEARCH",name:"rover.financials.invoiceSearch",param:{isFromStayCard:!0}}:f.get().from().name.match(/rover\.reports/)&&(t.setPrevState={title:"REPORTS",name:f.get().from().name,param:angular.extend(angular.copy(f.get().params("from")),{action:"report.show.last"})});v()},h=function(){var t=e.accountConfigData.summary;return!!t.posting_account_name};e.initializeDataModelForSummaryScreen=function(){e.accountConfigData={activeTab:r.activeTab,summary:s}},e.hasPermissionToViewTransactionsTab=function(){return l.getPermissionValue("ACCESS_GROUP_ACCOUNT_TRANSACTIONS")},e.switchTabTo=function(t){if(e.errorMessage="","TRANSACTIONS"===t&&!e.hasPermissionToViewTransactionsTab())return void(e.errorMessage=["Sorry, you don't have the permission to access the transactions"]);var a="ACCOUNT"===e.accountConfigData.activeTab,n=a&&"ACCOUNT"!==t;return e.isInAddMode()&&n?void(e.errorMessage=["Sorry, Please save the entered information and try to switch the tab"]):(a&&!e.isInAddMode(),"ACCOUNT"===t||"TRANSACTIONS"===t||e.$broadcast("UPDATE_ACCOUNT_SUMMARY"),e.accountConfigData.activeTab=t,void p(function(){e.$broadcast("ACCOUNT_TAB_SWITCHED",e.accountConfigData.activeTab)},100))},e.saveNewAccount=function(){if(e.errorMessage="",l.getPermissionValue("CREATE_ACCOUNT"))if(h()){var t=function(t){e.accountConfigData.summary.posting_account_id=t.posting_account_id,c.go("rover.accounts.config",{id:t.posting_account_id}),r.id=t.posting_account_id},a=function(t){e.errorMessage=t};e.callAPI(i.saveAccountSummary,{successCallBack:t,failureCallBack:a,params:{summary:e.accountConfigData.summary}})}else e.errorMessage=["Account's name is mandatory"];else console.warn("No Permission for CREATE_GROUP_SUMMARY")},e.discardNewAccount=function(){e.accountConfigData.summary=angular.copy(i.baseAccountSummaryData)};var g=function(){var t={focus:function(e,t){return!1}};e.companyAutoCompleteOptions=angular.extend({source:function(e,t){o.searchCompanyCards(e.term).then(function(e){var a=[],n={};$.map(e,function(e){n={label:e.account_name,value:e.id,address:e.account_address,type:e.account_type,contract_access_code:e.current_contracts.length>0?e.current_contracts[0].access_code:null},a.push(n)}),t(a)})},select:function(t,a){return this.value=a.item.label,e.accountConfigData.summary.company.name=a.item.label,e.accountConfigData.summary.company.id=a.item.value,e.isInAddMode()||e.updateAccountSummary(),m(),!1},change:function(){e.isInAddMode()||e.accountConfigData.summary.company.name||(e.accountConfigData.summary.company.id="",e.updateAccountSummary())}},t),e.travelAgentAutoCompleteOptions=angular.extend({source:function(e,t){o.searchTravelAgentCards(e.term).then(function(e){var a=[],n={};$.map(e,function(e){n={label:e.account_name,value:e.id,address:e.account_address,type:e.account_type,contract_access_code:e.current_contracts.length>0?e.current_contracts[0].access_code:null},a.push(n)}),t(a)})},select:function(t,a){return this.value=a.item.label,e.accountConfigData.summary.travel_agent.name=a.item.label,e.accountConfigData.summary.travel_agent.id=a.item.value,e.isInAddMode()||e.updateAccountSummary(),m(),!1},change:function(){e.isInAddMode()||e.accountConfigData.summary.travel_agent.name||(e.accountConfigData.summary.travel_agent.id="",e.updateAccountSummary())}},t)};e.updateAccountSummary=function(){if(l.getPermissionValue("EDIT_ACCOUNT")){var t=function(t){e.$broadcast("UPDATED_ACCOUNT_INFO"),e.updateAndBackFlag?c.go("rover.accounts.search"):e.$emit("hideLoader")},a=function(t){e.$broadcast("FAILED_TO_UPDATE_ACCOUNT_INFO"),e.$emit("showErrorMessage",t),e.$emit("hideLoader")};e.callAPI(i.updateAccountSummary,{successCallBack:t,failureCallBack:a,params:{summary:e.accountConfigData.summary}})}else e.$emit("showErrorMessage",["Sorry, Changes will not get saved as you don't have enough permission"])},e.$on("showErrorMessage",function(t,a){e.errorMessage=a,m()}),e.shouldShowCompanyCardNavigationButton=function(){return!e.isInAddMode()&&e.accountConfigData.summary.company&&!!e.accountConfigData.summary.company.id},e.shouldShowTravelAgentNavigationButton=function(){return!e.isInAddMode()&&e.accountConfigData.summary.travel_agent&&!!e.accountConfigData.summary.travel_agent.id},e.goToTACard=function(){c.go("rover.companycarddetails",{id:e.accountConfigData.summary.travel_agent.id,type:"TRAVELAGENT"})},e.goToCompanyCard=function(){c.go("rover.companycarddetails",{id:e.accountConfigData.summary.company.id,type:"COMPANY"})};var y=function(){e.initializeDataModelForSummaryScreen(),g(),_(),"rover.financials.invoiceSearch"===e.previousState.name&&e.switchTabTo("TRANSACTIONS")};y()}]),sntRover.controller("rvAccountsRootCtrl",["$scope","$rootScope","$filter","$timeout","$interval","$log",function(e,t,a,n,r,i){e.setHeadingTitle=function(t){e.heading=t,e.setTitle(a("translate")(t))},t.disableObserveForSwipe||(CardReaderCtrl.call(this,e,t,n,r,i),e.observeForSwipe())}]),sntRover.controller("RVDepositBalanceAccountsCtrl",["$scope","ngDialog","$rootScope","RVDepositBalanceSrv","RVPaymentSrv","$stateParams","$filter","$timeout","rvPermissionSrv","RVReservationCardSrv",function(e,t,a,n,r,i,o,s,c,l){BaseCtrl.call(this,e),e.pageloadingOver=!1,s(function(){e.pageloadingOver=!0},3500),e.shouldShowWaiting=!1,e.depositWithGiftCard=!1,e.depositPaidSuccesFully=!1,e.shouldShowExistingCards=!0,e.shouldShowAddNewCard=!0,e.authorizedCode="",e.showExistingAndAddNewPayments=!0,e.showOnlyAddCard=!1,e.cardsList=[],e.shouldShowMakePaymentButton=!0,e.shouldShowMakePaymentScreen=!0,e.showAddtoGuestCard=!0,e.shouldCardAvailable=!1,e.depositBalanceMakePaymentData={},e.depositBalanceMakePaymentData.amount=parseFloat(e.depositBalanceData.current_balance).toFixed(2),e.depositBalanceMakePaymentData.payment_amount=parseFloat(e.depositBalanceData.current_payment_balance).toFixed(2),e.refundAmount=0,e.depositBalanceMakePaymentData.amount<0&&(e.refundAmount=-1*parseFloat(e.depositBalanceMakePaymentData.amount),e.shouldShowMakePaymentButton=!1),e.depositBalanceMakePaymentData.add_to_guest_card=!1,e.makePaymentButtonDisabled=!0,e.isDisplayReference=!1,e.referanceText="",e.isAddToGuestCardVisible=!1,e.isSwipedCardSave=!1,e.isManual=!1,e.setScroller("cardsList",{click:!0,tap:!0}),e.setScroller("deopositdue");var u=function(){s(function(){e.refreshScroller("deopositdue")},1500)},u=function(){s(function(){e.refreshScroller("cardsList")},1500)},d=function(){setTimeout(function(){e.refreshScroller("payment-deposit-scroll")},500)};e.validPayment=!0,e.disableMakePayment=function(){return!!e.validPayment&&("undefined"==typeof e.depositBalanceMakePaymentData.payment_type||!(e.depositBalanceMakePaymentData.payment_type.length>0))},e.showingDepositModal=!1,e.giftCardAmountAvailable=!1,e.giftCardAvailableBalance=0,e.$on("giftCardAvailableBalance",function(t,a){e.giftCardAvailableBalance=a.amount}),e.timer=null,e.hasPermissionToMakePayment=function(){return c.getPermissionValue("MAKE_PAYMENT")},"sixpayments"===a.paymentGateway&&(e.shouldCardAvailable=!1,e.makePaymentButtonDisabled=!1),e.hideCreditCardFields=function(){e.addmode=!1,e.shouldShowExistingCards=!1,e.shouldCardAvailable=!1},e.changeOnsiteCallIn=function(){e.shouldShowMakePaymentScreen=!e.isManual,e.shouldShowExistingCards=e.cardsList.length>0,e.addmode=!(e.cardsList.length>0),e.shouldCardAvailable=!e.shouldShowMakePaymentScreen,u()},e.$on("changeOnsiteCallIn",function(t){e.isManual=!e.isManual,e.changeOnsiteCallIn()}),e.$on("TOKEN_CREATED",function(t,a){e.cardValues=a;var n="";if(e.cardValues.tokenDetails.isSixPayment){n=""!==e.cardValues.tokenDetails.expiry?"20"+e.cardValues.tokenDetails.expiry.substring(0,2)+"-"+e.cardValues.tokenDetails.expiry.substring(2,4)+"-01":"",e.shouldShowIframe=!1,e.shouldShowMakePaymentScreen=!0,e.showAddtoGuestCard=!1,e.shouldShowExistingCards=!1,e.addmode=!1,e.makePaymentButtonDisabled=!1,e.shouldCardAvailable=!0,e.depositBalanceMakePaymentData.card_code=getSixCreditCardType(e.cardValues.tokenDetails.card_type).toLowerCase(),e.depositBalanceMakePaymentData.ending_with=e.cardValues.tokenDetails.token_no.substr(e.cardValues.tokenDetails.token_no.length-4);var i={token:e.cardValues.tokenDetails.token_no,card_name:e.passData.details.firstName+" "+e.passData.details.lastName,card_expiry:n,payment_type:"CC"}}else{n=""!==e.cardValues.cardDetails.expiryMonth&&""!==e.cardValues.cardDetails.expiryYear?"20"+e.cardValues.cardDetails.expiryYear+"-"+e.cardValues.cardDetails.expiryMonth+"-01":"",e.depositBalanceMakePaymentData.card_code=getCreditCardType(e.cardValues.cardDetails.cardType).toLowerCase(),e.depositBalanceMakePaymentData.ending_with=e.cardValues.cardDetails.cardNumber.substr(e.cardValues.cardDetails.cardNumber.length-4);var i={token:e.cardValues.tokenDetails.session,card_name:e.cardValues.cardDetails.userName,card_expiry:n,payment_type:"CC"}}i.card_code=e.cardValues.tokenDetails.isSixPayment?getSixCreditCardType(e.cardValues.tokenDetails.card_type).toLowerCase():e.cardValues.cardDetails.cardType,e.depositBalanceMakePaymentData.card_expiry=e.cardValues.tokenDetails.isSixPayment?e.cardValues.tokenDetails.expiry.substring(2,4)+" / "+e.cardValues.tokenDetails.expiry.substring(0,2):e.cardValues.cardDetails.expiryMonth+" / "+e.cardValues.cardDetails.expiryYear,e.invokeApi(r.savePaymentDetails,i,e.successSavePayment)}),e.$on("MLI_ERROR",function(t,a){e.errorMessage=a}),e.feeData={};parseFloat("0.00");e.isShowFees=function(){var t=!1,n=e.feeData;return"undefined"==typeof n||"undefined"==typeof n.feesInfo||null===n.feesInfo?t=!1:n.defaultAmount>=n.minFees&&e.isStandAlone&&n.feesInfo.amount&&e.depositBalanceMakePaymentData.amount>=0&&(t=!("sixpayments"===a.paymentGateway&&!e.isManual&&"CC"===e.depositBalanceMakePaymentData.payment_type||""===e.depositBalanceMakePaymentData.payment_type)),t},e.emitCancelCardSelection=function(){if(a.isStandAlone||t.close(),e.depositWithGiftCard=!1,e.$emit("cancelCardSelection"),e.cardselectedIndex=-1,$("#sixIframe").length){var n=document.getElementById("sixIframe");n.src=n.src}},e.clickedMakePayment=function(){var t={postData:{payment_type:e.depositBalanceMakePaymentData.payment_type,amount:e.depositBalanceMakePaymentData.amount,payment_method_id:e.paymentId},bill_id:e.depositBalanceData.primary_bill_id};e.isShowFees()&&(e.feeData.calculatedFee&&(t.postData.fees_amount=e.feeData.calculatedFee),e.feeData.feesInfo&&(t.postData.fees_charge_code_id=e.feeData.feesInfo.charge_code_id)),e.invokeApi(n.submitPaymentOnBill,t,e.successMakePayment)},e.giftCardAvailableBalance="",e.$on("giftCardAvailableBalance",function(t,a){e.giftCardAvailableBalance=a.amount,e.giftCardAmountAvailable=!0}),a.$on("validatedGiftCardPmt",function(t,a){a?e.validPayment=!0:e.validPayment=!1}),e.updatedAmountToPay=function(t){if("GIFT_CARD"===e.depositBalanceMakePaymentData.payment_type){var n=e.giftCardAvailableBalance;if(n){var r=parseFloat(n).toFixed(2),i=parseFloat(t).toFixed(2);r=parseFloat(r),i=parseFloat(i),r<i?e.validPayment=!1:e.validPayment=!0}}else e.validPayment=!0;a.$broadcast("validatedGiftCardPmt",e.validPayment)},e.successSavePayment=function(t){e.$emit("hideLoader"),e.shouldShowIframe=!1,e.shouldShowMakePaymentScreen=!0,e.showAddtoGuestCard=!1,e.shouldShowExistingCards=!1,e.addmode=!1,e.makePaymentButtonDisabled=!1,e.paymentId=t.id,e.shouldCardAvailable=!0},e.closeDepositModal=function(){e.$emit("UPDATE_DEPOSIT_BALANCE_FLAG",!1),e.$emit("TOGGLE_PAYMET_POPUP_STATUS",!1),e.closeDialog()},e.$on("CLOSE_DIALOG",e.closeDepositModal),e.successMakePayment=function(t){e.$emit("hideLoader"),"sixpayments"===a.paymentGateway&&e.isManual&&(e.authorizedCode=t.authorization_code),e.depositPaidSuccesFully=!0,e.$emit("BALANCE_AFTER_PAYMENT",t.current_balance)},e.setCreditCardFromList=function(t){e.shouldShowIframe=!1,e.shouldShowMakePaymentScreen=!0,e.showAddtoGuestCard=!1,e.shouldShowExistingCards=!1,e.addmode=!1,e.makePaymentButtonDisabled=!1,e.shouldCardAvailable=!0,e.paymentId=e.depositBalanceData.data.existing_payments[t].value,e.depositBalanceMakePaymentData.card_code=e.depositBalanceData.data.existing_payments[t].card_code,e.depositBalanceMakePaymentData.ending_with=e.depositBalanceData.data.existing_payments[t].ending_with,e.depositBalanceMakePaymentData.card_expiry=e.depositBalanceData.data.existing_payments[t].card_expiry,e.isStandAlone},e.$on("cardSelected",function(t,a){e.shouldCardAvailable=!0,e.setCreditCardFromList(a.index)}),e.showAddCardSection=function(){e.shouldShowIframe=!1,e.shouldShowMakePaymentScreen=!1,e.showAddtoGuestCard=!1,e.shouldShowExistingCards=!0,e.addmode=!1,e.makePaymentButtonDisabled=!1,u()},e.$on("cancelCardSelection",function(t,a){e.shouldShowMakePaymentScreen=!0,e.addmode=!1,e.depositBalanceMakePaymentData.payment_type="",e.isManual=!1}),e.$on("SHOW_SWIPED_DATA_ON_DEPOSIT_BALANCE_SCREEN",function(t,n){e.shouldShowMakePaymentScreen=!1,e.addmode=!0,a.$broadcast("RENDER_SWIPED_DATA",n),
e.swipedCardHolderName=n.nameOnCard}),e.$on("SWIPED_DATA_TO_SAVE",function(t,a){e.depositBalanceMakePaymentData.card_code=a.cardType.toLowerCase(),e.depositBalanceMakePaymentData.ending_with=a.cardNumber.slice(-4),e.depositBalanceMakePaymentData.card_expiry=a.cardExpiryMonth+"/"+a.cardExpiryYear,e.depositBalanceMakePaymentData.payment_type="CC",e.isSwipedCardSave=!0;var n=a;n.payment_credit_type=a.cardType,n.credit_card=a.cardType,n.card_expiry="20"+a.cardExpiryYear+"-"+a.cardExpiryMonth+"-01",e.invokeApi(r.savePaymentDetails,n,e.successSavePayment)}),e.isBalanceAmountShown=function(){return!0},e.$on("PAYMENT_SUCCESS",function(t,a){e.successMakePayment(a),d()}),e.$on("PAYMENT_FAILED",function(t,a){e.errorMessage=a}),function(){e.setScroller("payment-deposit-scroll")}()}]),sntRover.controller("RVCardOptionsCtrl",["$rootScope","$scope","$state","ngDialog","$location","$document","RVPaymentSrv","RVReservationCardSrv",function(e,t,a,n,r,i,o,s){BaseCtrl.call(this,t),t.showAddtoGuestCard=!1,t.renderDataFromSwipe=function(a){t.cardData.cardNumber=a.cardNumber,t.cardData.userName=a.nameOnCard,t.cardData.expiryMonth=a.cardExpiryMonth,t.cardData.expiryYear=a.cardExpiryYear,t.cardData.cardType=a.cardType,"guestCard"===a.swipeFrom&&e.$broadcast("swipeAtGuestCard"),"guestCard"===a.swipeFrom?t.showAddtoGuestCard=!1:t.showAddtoGuestCard=!0,"guestCard"!==a.swipeFrom&&"stayCard"!==a.swipeFrom||setTimeout(function(){t.clickedAddNewCard()},100)},t.refreshIframe=function(){if($("#sixIframe").length){var e=document.getElementById("sixIframe");e.src=e.src}},t.$on("REFRESH_IFRAME",function(e){t.refreshIframe()}),e.$on("depositModalAllowGiftCard",function(){t.allowPmtWithGiftCard=!0}),t.checkForGiftCard=function(){t.isGiftCard=!1,e.isStandAlone||t.invokeApi(o.fetchAvailPayments,{},t.cardsListSuccess)},t.hideCardToggles=function(){return!!(t.isFromGuestCard||t.hasAccompanyguest||t.cardsList&&0===t.cardsList.length)},t.$on("isFromGuestCardFalse",function(){t.showAddtoGuestCard=!0,t.isFromGuestCard=!0}),t.$on("hidePayCardToggles",function(e,a){t.isFromGuestCard=!0,a&&a.isFromSwipe&&"guestCard"!==a.swipeFrom&&(t.isFromGuestCard=!1)}),t.$on("giftCardSelectedFromGroups",function(){t.clickedGiftCardToggle()}),t.$on("CLICK_ADD_NEW_CARD",function(){t.clickedAddNewCard()}),t.$on("SHOW_SWIPED_DATA_ON_PAY_SCREEN",function(){t.clickedAddNewCard(),t.$$phase?"":t.$apply()}),t.$on("SHOW_SWIPED_DATA_ON_BILLING_SCREEN",function(){t.clickedAddNewCard(),t.$$phase?"":t.$apply()}),t.$on("SHOW_SWIPED_DATA_ON_DEPOSIT_BALANCE_SCREEN",function(){t.clickedAddNewCard(),t.$$phase?"":t.$apply()}),t.clickedAddNewCard=function(){t.shouldShowIframe=!1,t.addmode=!0,t.isGiftCard=!1,t.useDepositGiftCard=!1,t.hideCancelCard=!1,t.depositWithGiftCard=!1},t.clickedExistingCard=function(){t.shouldShowIframe=!0,t.addmode=!1,t.isGiftCard=!1,t.useDepositGiftCard=!1,t.hideCancelCard=!1,t.depositWithGiftCard=!1},t.clickedGiftCardToggle=function(){t.shouldShowIframe=!0,t.useDepositGiftCard=!0,t.addmode=!1,t.isGiftCard=!0,t.depositWithGiftCard=!0},t.showExistingCards=function(){return!t.addmode&&!t.useDepositGiftCard},t.showGiftCardToggle=function(){return!(t.isStandAlone||!t.allowPmtWithGiftCard)},t.existingSelected=function(){return!t.addmode&&!t.isGiftCard},t.addNewSelected=function(){return!(!t.addmode||t.isGiftCard)},t.hideMLINewCard=function(){return!!("sixpayments"===t.paymentGateway&&t.addmode||t.isManual||t.isGiftCard||t.depositWithGiftCard||t.shouldShowIframe)},t.showAddToGuestCardBox=function(){return t.existingSelected()||t.isGiftCard?t.showAddtoGuestCard=!1:t.addNewSelected()&&(t.showAddtoGuestCard=!0),!!t.showAddtoGuestCard},t.showMLIAddNewCC=function(){return!!t.addNewSelected()||!(!t.isGiftCard||t.showingDepositModal||t.depositWithGiftCard||t.useDepositGiftCard)},e.$on("giftCardSelected",function(){t.shouldShowIframe=!1,e.isStandAlone&&$("#cc-new-card").addClass("ng-hide")}),e.$on("creditCardSelected",function(){e.isStandAlone||(t.shouldShowIframe=!0,$("#cc-new-card").removeClass("ng-hide")),e.isStandAlone&&($("#cc-new-card").removeClass("ng-hide"),t.clickedAddNewCard())}),t.hideIfFromStayCardDirect=function(){e.isStandAlone||(t.swippedCard?t.shouldShowIframe=!1:t.shouldShowIframe=!0)},e.$on("validatedGiftCardPmt",function(e,a){a?t.validPayment=!0:t.validPayment=!1}),t.showMakePaymentButtonStatus=function(){var e="";return e=t.depositBalanceMakePaymentData&&"undefined"!=typeof t.depositBalanceMakePaymentData.payment_type?t.depositBalanceMakePaymentData.payment_type.length>0&&t.validPayment?"green":"grey":t.validPayment?"grey":"grey overlay"},t.useDepositGiftCard=!1,t.cardsListSuccess=function(a){t.allowPmtWithGiftCard=!1,e.allowPmtWithGiftCard=!1,t.$emit("hideLoader");for(var n in a)"GIFT_CARD"===a[n].name&&(t.allowPmtWithGiftCard=!0,t.$parent.allowPmtWithGiftCard=!0,t.$parent.$parent.allowPmtWithGiftCard=!0,t.$parent.$parent.$parent.allowPmtWithGiftCard=!0,e.allowPmtWithGiftCard=!0,e.$broadcast("depositModalAllowGiftCard",!0));e.initFromCashDeposit?t.initFromCashDeposit=!0:t.initFromCashDeposit=!1},t.isGiftCard=!1,t.allowPmtWithGiftCard=!1,e.$on("depositUsingGiftCardChange",function(a,n){e.depositUsingGiftCard?(t.isGiftCard=!0,t.hideCancelCard=!0):(t.isGiftCard=!1,t.hideCancelCard=!1)}),t.refreshIframeWithGuestData=function(e){var t=(new Date).getTime(),a=e.fname,n=e.lname;iFrameUrl=domainUrl+"/api/ipage/index.html?card_holder_first_name="+a+"&card_holder_last_name="+n+"&service_action=createtoken&time="+t;var r=document.getElementById("sixIframe");try{r.src=iFrameUrl}catch(e){console.warn(e.name,e.message)}},t.$on("refreshIframe",function(e,a){t.refreshIframeWithGuestData(a)});var c=r.$$absUrl;domainUrl=c.split("/staff#/")[0],t.cardData={},t.cardData.addToGuestCard=!1,t.cardData.cardNumber="",t.cardData.CCV="",t.cardData.expiryMonth="",t.cardData.expiryYear="",t.cardData.userName="";var l=(new Date).getTime();if(t.shouldShowAddNewCard=!0,"undefined"!=typeof t.passData)var u="undefined"==typeof t.passData.details.firstName?"":t.passData.details.firstName,d="undefined"==typeof t.passData.details.lastName?"":t.passData.details.lastName;if(t.iFrameUrl=domainUrl+"/api/ipage/index.html?card_holder_first_name="+u+"&card_holder_last_name="+d+"&service_action=createtoken&time="+l,"sixpayments"===e.paymentGateway){t.shouldShowAddNewCard=!1;var p=i.find("sixIframe");p.attr("src",t.iFrameUrl),t.showAddtoGuestCard=!1}else t.isFromGuestCard||(t.showAddtoGuestCard=!0);"undefined"==typeof t.passData||isEmptyObject(t.passData.details.swipedDataToRenderInScreen)||t.renderDataFromSwipe(t.passData.details.swipedDataToRenderInScreen),t.shouldShowIframe=!1,t.changeOnsiteCallIn=function(){t.shouldShowIframe=!t.shouldShowIframe,t.isFromGuestCard||(t.shouldShowIframe?(t.showAddtoGuestCard=!0,t.refreshIframe()):t.showAddtoGuestCard=!1)};var f=function(){t.cardData.cardNumber="",t.cardData.CCV="",t.cardData.expiryMonth="",t.cardData.expiryYear=""};t.$on("clearCardDetails",function(){f()});var m=function(e){var a={};a.cardDetails=angular.copy(t.cardData),a.tokenDetails=e,t.$emit("TOKEN_CREATED",a),t.$digest(),t.refreshIframe()},v=function(e){t.$emit("MLI_ERROR",e)},_=function(){var e={};return e.cardNumber=t.cardData.cardNumber,e.cardSecurityCode=t.cardData.CCV,e.cardExpiryMonth=t.cardData.expiryMonth,e.cardExpiryYear=t.cardData.expiryYear,e};t.getToken=function(e){if(e.preventDefault(),isEmptyObject(t.passData.details.swipedDataToRenderInScreen)){var a=_(),n=function(e){e.isSixPayment=!1,m(e)},r=function(e){v(e)};t.fetchMLI(a,n,r)}else{var i=new SwipeOperation,o=i.createSWipedDataToSave(t.passData.details.swipedDataToRenderInScreen);o.addToGuestCard=t.cardData.addToGuestCard,o.card_name&&""!==o.card_name||(o.card_name=t.cardData.userName),t.$emit("SWIPED_DATA_TO_SAVE",o)}},t.$on("six_token_recived",function(e,a){a.six_payment_data.isSixPayment=!0,t.shouldShowAddNewCard=!1,m(a.six_payment_data)}),t.setCreditCardFromList=function(e){t.$emit("cardSelected",{index:e}),t.cardselectedIndex=e},t.setToShowCancelCard=function(){t.hideCancelCard=!1,t.depositWithGiftCard=!1},t.setToHideCancelCard=function(){t.hideCancelCard=!0},t.showCancelCardSelection=function(){return!t.hideCancelCard&&!t.depositWithGiftCard},t.isSixPayPayment=function(){return!!("sixpayments"===t.paymentGateway&&t.addmode||t.isManual)},t.cancelCardSelection=function(){e.isStandAlone?(t.$emit("cancelCardSelection"),t.cardselectedIndex=-1,t.refreshIframe()):n.close()},t.$on("cancelCardSelection",function(){t.depositWithGiftCard=!1,t.isGiftCard=!1,t.hideCancelCard=!1}),t.$on("showCancelCreditCardButton",function(){t.setToShowCancelCard()}),t.giftCardAmountAvailable=!1,t.giftCardAvailableBalance=0,t.$on("giftCardAvailableBalance",function(e,a){t.giftCardAvailableBalance=a.amount}),t.timer=null,t.cardNumberInput=function(a,n,r){if(r?(t.isGiftCard=!0,t.useDepositGiftCard=!0,e.useDepositGiftCard=!0):e.useDepositGiftCard=!1,t.isGiftCard||r){var i=a.length;t.num=a,i>=8&&i<=22?$("[name=card-number]").keydown(function(){clearTimeout(t.timer),t.timer=setTimeout(t.fetchGiftCardBalance,1500)}):t.giftCardAmountAvailable=!1}},t.num,t.fetchGiftCardBalance=function(){if(t.isGiftCard){var e=function(e){t.giftCardAvailableBalance=e.amount,t.giftCardAmountAvailable=!0,t.$emit("giftCardAvailableBalance",e),t.$emit("hideLoader")};t.invokeApi(s.checkGiftCardBalance,{card_number:t.num},e)}else t.giftCardAmountAvailable=!1},t.$on("addNewCardClicked",function(){t.clickedAddNewCard()}),t.$on("existingCardClicked",function(){t.clickedExistingCard()}),t.$on("RENDER_SWIPED_DATA",function(e,a){t.swippedCard=!0,t.renderDataFromSwipe(a),t.passData.details.swipedDataToRenderInScreen=a,setTimeout(function(){t.clickedAddNewCard()},100)})}]),sntRover.controller("rvBillFormatPopupCtrl",["$scope","$rootScope","$filter","RVBillCardSrv","RVContactInfoSrv","ngDialog","$timeout",function(e,t,a,n,r,i,o){var s=200,c=500;BaseCtrl.call(this,e),e.isCompanyCardInvoice=!0,e.disableCompanyCardInvoice=!1,e.disableCompanyGuestToggle=!1,e.hideCompanyCardInvoiceToggle=!0,e.billFormat.isInformationalInvoice=!e.shouldGenerateFinalInvoice&&e.isSettledBill&&e.reservationBillData.is_bill_lock_enabled,e.billFormat.isInformationalInvoiceDisabled=e.isSettledBill&&e.reservationBillData.is_bill_lock_enabled,e.disableToggleAccount=!1;var l=function(){var t={};return e.reservationBillData&&e.reservationBillData.reservation_id?(t.id=e.reservationBillData.reservation_id,t.is_type="Reservation"):(e.hideCompanyCardInvoiceToggle=!1,e.isFromInvoiceSearchScreen&&(null===e.clickedInvoiceData.associated_item.company_card&&null===e.clickedInvoiceData.associated_item.travel_agent_card?e.hideCompanyCardInvoiceToggle=!0:null===e.clickedInvoiceData.associated_item.company_card&&null!==e.clickedInvoiceData.associated_item.travel_agent_card?(e.isCompanyCardInvoice=!1,e.disableCompanyCardInvoice=!0):null!==e.clickedInvoiceData.associated_item.company_card&&null===e.clickedInvoiceData.associated_item.travel_agent_card&&(e.disableCompanyCardInvoice=!0)),e.groupConfigData?(t.id=e.groupConfigData.summary.group_id,t.is_group=!0,t.is_type="Account",u(e.groupConfigData.summary)):(t.id=e.accountConfigData?e.accountConfigData.summary.posting_account_id:e.clickedInvoiceData.associated_item.item_id,t.is_group=!1,t.is_type="Account",e.accountConfigData&&u(e.accountConfigData.summary))),t.bill_no=e.billNo,t};e.closeDialog=function(){t.modalOpened=!1,o(function(){i.close()},s)};var u=function(t){(d(t.company)||d(t.travel_agent))&&(d(t.company)&&d(t.travel_agent)?e.hideCompanyCardInvoiceToggle=!0:!d(t.company)&&d(t.travel_agent)?(e.isCompanyCardInvoice=!0,e.disableCompanyCardInvoice=!0):(e.isCompanyCardInvoice=!1,e.disableCompanyCardInvoice=!0))},d=function(e){return!e||0===e.length},p=function(t){e.$emit("hideLoader"),t.languages&&(t.languages=_.filter(t.languages,{is_show_on_guest_card:!0})),e.languageData=t,e.data.locale=t.selected_language_code},f=function(){var t={};e.reservationBillData&&e.reservationBillData.reservation_id&&(t.reservation_id=e.reservationBillData.reservation_id),e.invokeApi(r.fetchGuestLanguages,t,p)},m=function(){var t=l(),a=function(t){f(),t.data&&t.data.default_bill_settings&&(t.data.default_bill_settings=t.data.default_bill_settings.toString());var a=t.data&&t.data.bill_paid_account_type;"COMPANY"===a?(e.isCompanyCardInvoice=!0,e.disableToggleAccount=!0):"TRAVELAGENT"===a&&(e.isCompanyCardInvoice=!1,e.disableToggleAccount=!0),e.data=t.data,e.setEmailAddress()};e.invokeApi(n.getBillSettingsInfo,t,a)},v=function(){var t={};return e.reservationBillData&&e.reservationBillData.reservation_id?t.reservation_id=e.reservationBillData.reservation_id:(e.groupConfigData?(t.group_id=e.groupConfigData.summary.group_id,t.is_group=!0):(t.account_id=e.isFromInvoiceSearchScreen?e.clickedInvoiceData.associated_item.item_id:e.accountConfigData.summary.posting_account_id,t.is_group=!1),t.type=e.isCompanyCardInvoice?"COMPANY":"TRAVELAGENT"),t.bill_number=e.billNo,t.locale=e.data.locale,e.$emit("hideLoader"),t};e.printBill=function(){var t=v();e.$emit("UPDATE_INFORMATIONAL_INVOICE",e.billFormat.isInformationalInvoice),t.bill_layout=e.data.default_bill_settings,t.is_informational_invoice=e.billFormat.isInformationalInvoice,e.clickedPrint(t)},e.clickedContinueButtonPrintOrEmail=function(){e.isClickedPrint?e.printBill():e.sendEmail()},e.clickedPrintBill=function(){e.shouldGenerateFinalInvoice&&!e.billFormat.isInformationalInvoice?(e.isClickedPrint=!0,e.isInvoiceStepThreeActive=!1,o(function(){e.isInvoiceStepFourActive=!0},c)):e.printBill()},e.sendEmail=function(){var t=v();t.bill_layout=e.data.default_bill_settings,t.to_address=e.data.mailto_address,t.is_informational_invoice=e.billFormat.isInformationalInvoice,e.clickedEmail(t)},e.emailBill=function(){e.shouldGenerateFinalInvoice&&!e.billFormat.isInformationalInvoice?(e.isClickedPrint=!1,e.isInvoiceStepThreeActive=!1,o(function(){e.isInvoiceStepFourActive=!0},c)):e.sendEmail()},e.clickedFinalInvoiceButton=function(){e.isInvoiceStepOneActive=!1,o(function(){e.isInvoiceStepTwoActive=!0},c)},e.clickedProceedButton=function(){e.isInvoiceStepTwoActive=!1,e.isInvoiceStepFourActive=!1,o(function(){e.isInvoiceStepThreeActive=!0},c)},e.clickedCancelButtonProceedScreen=function(){e.isInvoiceStepTwoActive=!1,o(function(){e.isInvoiceStepOneActive=!0},c)};var h=e.$on("UPDATE_WINDOW",function(){e.isInvoiceStepFourActive=!1,o(function(){e.isInvoiceStepFiveActive=!0},c)});e.getPrintButtonClass=function(){var t="blue";return!e.billFormat.isInformationalInvoice&&parseInt(e.reservationBillData.bills[e.currentActiveBill].print_counter,10)>=parseInt(e.reservationBillData.no_of_original_invoices,10)&&e.roverObj.noReprintReEmailInvoice&&0!==parseInt(e.reservationBillData.no_of_original_invoices,10)&&(t="grey"),t},e.isPrintButtonDisabled=function(){var t=!1;return!e.billFormat.isInformationalInvoice&&parseInt(e.reservationBillData.bills[e.currentActiveBill].print_counter,10)>=parseInt(e.reservationBillData.no_of_original_invoices,10)&&e.roverObj.noReprintReEmailInvoice&&0!==parseInt(e.reservationBillData.no_of_original_invoices,10)&&(t=!0),t},e.getEmailButtonClass=function(){var t="blue";return e.data.mailto_address?!e.billFormat.isInformationalInvoice&&parseInt(e.reservationBillData.bills[e.currentActiveBill].email_counter,10)>=parseInt(e.reservationBillData.no_of_original_emails,10)&&e.roverObj.noReprintReEmailInvoice&&0!==parseInt(e.reservationBillData.no_of_original_invoices,10)&&(t="grey"):t="grey",t},e.isEmailButtonDisabled=function(){var t=!1;return e.data.mailto_address?!e.billFormat.isInformationalInvoice&&parseInt(e.reservationBillData.bills[e.currentActiveBill].email_counter,10)>=parseInt(e.reservationBillData.no_of_original_emails,10)&&e.roverObj.noReprintReEmailInvoice&&0!==parseInt(e.reservationBillData.no_of_original_invoices,10)&&(t=!0):t=!0,t},e.clickedInformationalButton=function(){e.billFormat.isInformationalInvoice=!0,e.isInvoiceStepOneActive=!1,o(function(){e.isInvoiceStepThreeActive=!0},c)},e.setEmailAddress=function(){e.isCompanyCardInvoice?e.data.mailto_address=e.data.company_address?e.data.company_address:e.data.to_address:e.data.mailto_address=e.data.travel_agent_address?e.data.travel_agent_address:e.data.to_address};var g=function(){e.data={},m()};e.changeCompanyCardInvoiceToggle=function(){e.isCompanyCardInvoice=!e.isCompanyCardInvoice,e.setEmailAddress()},e.$on("$destroy",h),g()}]),sntRover.controller("RVReceiptPopupController",["$scope","$rootScope","RVBillCardSrv","RVContactInfoSrv","ngDialog","$filter",function(e,t,a,n,r,i){BaseCtrl.call(this,e),e.getEmailButtonClass=function(){var t="blue";return e.data.mailto_address||(t="grey"),t},e.isEmailButtonDisabled=function(){var t=!1;return e.data.mailto_address||(t=!0),t},e.printReceipt=function(){var t=function(t){var a=t.data;if(a.is_copy_of_receipt){var n=a.copy_counter||"";a.receiptHeading=a.receipt_translations.copy_of_receipt.replace("#count",n)}else a.receiptHeading=a.receipt_translations.payment_receipt;e.$emit("PRINT_RECEIPT",a)},n={params:{bill_id:e.billId,transaction_id:e.transactionId,locale:e.data.locale},successCallBack:t};e.callAPI(a.printReceiptData,n)},e.closeDialog=function(){r.close()},e.showEmailSentStatusPopup=function(){r.open({template:"/assets/partials/popups/rvEmailSentStatusPopup.html",className:"",scope:e})},e.emailReceipt=function(){var t=function(){e.statusMsg=i("translate")("EMAIL_SEND_FAILED"),e.status="alert",e.showEmailSentStatusPopup()},n=function(t){e.statusMsg=i("translate")("EMAIL_SENT_SUCCESSFULLY"),e.status="success",e.showEmailSentStatusPopup()},r={params:{bill_id:e.billId,transaction_id:e.transactionId,to_address:e.data.mailto_address,locale:e.data.locale},successCallBack:n,failureCallBack:t};e.callAPI(a.emailReceiptData,r)};var o=function(t){t.languages&&(t.languages=_.filter(t.languages,{is_show_on_guest_card:!0})),e.languageData=t,e.data.locale=t.selected_language_code},s=function(){e.data={};var t={successCallBack:o};e.callAPI(n.fetchGuestLanguages,t)};s()}]),sntRover.controller("RVAccountReceivableMessagePopupCtrl",["$rootScope","$scope","$state","ngDialog","$timeout","RVCompanyCardSrv","rvPermissionSrv",function(e,t,a,n,r,i,o){BaseCtrl.call(this,t),t.isCreateNewARAccountMode=!1,t.data={},t.isCreateButtonDisabled=!1,t.createAccountAction=function(){if("undefined"!=typeof t.reservationBillData&&"true"===t.reservationBillData.is_auto_assign_ar_numbers||"undefined"!=typeof t.is_auto_assign_ar_numbers&&t.is_auto_assign_ar_numbers){var e=!0;t.createAccountReceivable(e)}else t.isCreateNewARAccountMode=!0},t.successCreate=function(a){"undefined"!=typeof t.reservationBillData&&(t.reservationBillData.ar_number=a.ar_number,t.reservationBillData.bills[t.currentActiveBill].ar_number=a.ar_number,t.reservationBillData.bills[t.currentActiveBill].has_ar_account=!0),n.close(),r(function(){e.$emit("arAccountCreated")},500)},t.failureCreate=function(e){t.$emit("hideLoader"),t.errorMessage=e,t.isCreateButtonDisabled=!1,"Please complete required AR Account Information"===t.errorMessage[0]&&(t.isCreateButtonDisabled=!0)},t.createAccountReceivable=function(e){var a={id:t.reservationBillData.bills[t.currentActiveBill].account_id,ar_number:e?"":t.data.ar_number};t.invokeApi(i.saveARDetails,a,t.successCreate,t.failureCreate)},t.closeDialog=function(){n.close()},t.cancelButtonClick=function(){t.errorMessage="",t.isCreateNewARAccountMode=!1},t.hasPermissionToCreateArAccount=function(){return o.getPermissionValue("CREATE_AR_ACCOUNT")}}]),sntRover.controller("RVAddPaymentMethodCrtl",["$scope","$rootScope",function(e,t){}]),sntRover.controller("RVPaymentCompanyCardCtrl",["$rootScope","$scope","$state","RVPaymentSrv","RVCompanyCardSrv","ngDialog",function(e,t,a,n,r,i){BaseCtrl.call(this,t),t.$on("clearNotifications",function(){t.errorMessage="",t.successMessage=""});var o={data:[],paymentTypes:[]};t.paymentData=o,t.updateErrorMessage=function(e){t.errorMessage=e},t.openAddNewPaymentModel=function(){t.callAPI(n.renderPaymentScreen,{params:{direct_bill:!1},onSuccess:function(e){var a=_.find(e,function(e){return"CC"===e.name}),n={fromView:"companyTravelAgent",isFromWallet:!0,accountId:t.contactInformation.id,details:{}},r=t.paymentData;r.paymentTypes=[a],t.openPaymentDialogModal(n,r)}})},t.fetchAttachedPaymentTypes=function(){var e=function(e){t.paymentData=e,t.$parent.$emit("hideLoader")},a=function(e){t.$parent.$emit("hideLoader"),t.$emit("displayErrorMessage",e)};t.invokeApi(r.fetchCompanyPaymentData,t.contactInformation.id,e,a)},t.addListener("wallet",function(){t.fetchAttachedPaymentTypes()}),t.openDeleteSetAsPrimaryModal=function(e,a){t.paymentData.payment_id=e,t.paymentData.index=a,t.paymentData.accountId=t.contactInformation.id,t.paymentData.isFromWallet=!0,i.open({template:"/assets/partials/payment/rvDeleteSetAsPrimary.html",controller:"RVDeleteSetAsPrimaryCtrl",scope:t})},t.$on("ADDEDNEWPAYMENTTOCOTA",function(e,a){"undefined"==typeof t.paymentData.data&&(t.paymentData.data=[]),_.find(t.paymentData.data,{id:a.id})||t.paymentData.data.push(a),t.refreshScroller("paymentList")}),function(){var e={preventDefault:!1};t.setScroller("paymentList",e),t.$on("$viewContentLoaded",function(){t.refreshScroller("paymentList")}),t.$on("REFRESHLIKESSCROLL",function(){t.refreshScroller("paymentList")})}()}]),sntRover.controller("RVCreateAccountReceivableCtrl",["$rootScope","$scope","$state","RVCompanyCardSrv","ngDialog",function(e,t,a,n,r){BaseCtrl.call(this,t),t.ar_number="",t.createAccountReceivable=function(){var e={id:t.account_id,ar_number:t.ar_number};t.invokeApi(n.saveARDetails,e,t.successCreate,t.failureCreate)},t.closeDialog=function(){r.close()}}]),sntRover.controller("RVDeleteSetAsPrimaryCtrl",["$rootScope","$scope","$state","RVPaymentSrv","RVCompanyCardSrv","ngDialog",function(e,t,a,n,r,i){BaseCtrl.call(this,t),t.successSetAsPrimary=function(){angular.forEach(t.paymentData.data,function(e,t){e.is_primary=!1}),t.paymentData.data[t.paymentData.index].is_primary=!0,t.refreshScroller("paymentList"),t.$emit("hideLoader"),i.close()},t.successDelete=function(){t.paymentData.data.splice(t.paymentData.index,1),t.$emit("hideLoader"),i.close()},t.failureCallBack=function(e){t.$emit("hideLoader"),t.updateErrorMessage(e),t.refreshScroller("paymentList"),t.closeDialog()},t.setAsPrimary=function(){if(t.paymentData.isFromWallet){var e={associated_payment_method_id:t.paymentData.payment_id,account_id:t.paymentData.accountId};t.invokeApi(r.setAsPrimary,e,t.successSetAsPrimary,t.failureCallBack)}else{var e={id:t.paymentData.payment_id,user_id:t.paymentData.user_id};t.invokeApi(n.setAsPrimary,e,t.successSetAsPrimary,t.failureCallBack)}},t.deletePayment=function(){if(t.paymentData.isFromWallet){var e={associated_payment_method_id:t.paymentData.payment_id,account_id:t.paymentData.accountId};t.invokeApi(r.deletePayment,e,t.successDelete,t.failureCallBack)}else{var e={id:t.paymentData.payment_id};t.invokeApi(n.deletePayment,e,t.successDelete,t.failureCallBack)}}}]),sntRover.controller("RVPaymentGuestCtrl",["$rootScope","$scope","$state","RVPaymentSrv","ngDialog",function(e,t,a,n,r){BaseCtrl.call(this,t),t.$on("clearNotifications",function(){t.errorMessage="",t.successMessage=""}),t.updateErrorMessage=function(e){t.errorMessage=e},t.openAddNewPaymentModel=function(){t.callAPI(n.renderPaymentScreen,{params:{direct_bill:!1},onSuccess:function(e){var a=_.find(e,function(e){return"CC"===e.name}),n={guest_id:t.guestCardData.contactInfo.user_id,isFromGuestCard:!0,details:{firstName:t.guestCardData.contactInfo.first_name,lastName:t.guestCardData.contactInfo.last_name}},r=t.paymentData;r.paymentTypes=[a],t.openPaymentDialogModal(n,r)}})},t.openDeleteSetAsPrimaryModal=function(e,a){t.paymentData.payment_id=e,t.paymentData.index=a,r.open({template:"/assets/partials/payment/rvDeleteSetAsPrimary.html",controller:"RVDeleteSetAsPrimaryCtrl",scope:t})},t.$on("ADDEDNEWPAYMENTTOGUEST",function(e,a){"undefined"==typeof t.paymentData.data&&(t.paymentData.data=[]),_.find(t.paymentData.data,{id:a.id})||t.paymentData.data.push(a),t.refreshScroller("paymentList")}),function(){var e={preventDefault:!1};t.setScroller("paymentList",e),t.$on("$viewContentLoaded",function(){t.refreshScroller("paymentList")}),t.$on("REFRESHLIKESSCROLL",function(){t.refreshScroller("paymentList")})}()}]),sntRover.controller("RVShowPaymentListCtrl",["$rootScope","$scope","$state","RVPaymentSrv","ngDialog","rvPermissionSrv",function(e,t,a,n,r,i){BaseCtrl.call(this,t),t.showNoValues=!1;var o=i.getPermissionValue("REMOVE_CREDIT_CARD_FROM_STAYCARD");t.paymentListSuccess=function(e){t.$emit("hideLoader"),t.paymentListData=e,angular.forEach(t.paymentListData.existing_payments,function(e,a){if(!e.is_credit_card)return void t.paymentListData.existing_payments.splice(a,1)}),t.paymentListLength=t.paymentListData.existing_payments.length,0===t.paymentListLength&&(t.showNoValues=!0)};var s="",c=1;"billCard"===t.dataToPaymentList.currentView?(s=t.dataToPaymentList.reservation_id,c=t.dataToPaymentList.bills[t.dataToPaymentList.currentActiveBill].bill_number):s=t.dataToPaymentList.reservation_card.reservation_id;var l={reservation_id:s,bill_number:c};t.invokeApi(n.getExistingPaymentsForBill,l,t.paymentListSuccess),t.clickPaymentItem=function(a,i,o,c,l,u){var d={reservation_id:s,user_payment_type_id:a};"billCard"===t.dataToPaymentList.currentView&&(d.bill_number=t.dataToPaymentList.bills[t.dataToPaymentList.currentActiveBill].bill_number);var p=function(e){t.$emit("hideLoader"),t.errorMessage=e},f=function(a){var n;t.$emit("hideLoader"),e.$emit("UPDATECCATTACHEDBILLSTATUS",a.has_any_credit_card_attached_bill),r.close(),"billCard"===t.dataToPaymentList.currentView?(n=t.dataToPaymentList.currentActiveBill,t.dataToPaymentList.bills[n].credit_card_details.card_code=i.toLowerCase(),t.dataToPaymentList.bills[n].credit_card_details.card_number=o,t.dataToPaymentList.bills[n].credit_card_details.card_expiry=c,t.dataToPaymentList.bills[n].credit_card_details.is_swiped=l,t.dataToPaymentList.bills[n].credit_card_details.auth_color_code=u,t.dataToPaymentList.bills[n].credit_card_details.payment_id=a.id,t.dataToPaymentList.bills[n].credit_card_details.token=a.token,0===n&&e.$emit("UPDATEDPAYMENTLIST",t.dataToPaymentList.bills[n].credit_card_details)):(t.dataToPaymentList.reservation_card.payment_details.card_type_image="images/"+i.toLowerCase()+".png",t.dataToPaymentList.reservation_card.payment_details.card_number=o,t.dataToPaymentList.reservation_card.payment_details.card_expiry=c,t.dataToPaymentList.reservation_card.payment_method_used="CC",t.dataToPaymentList.reservation_card.payment_method_description="Credit Card",t.dataToPaymentList.reservation_card.payment_details.is_swiped=l,t.dataToPaymentList.reservation_card.payment_details.auth_color_code=u,t.dataToPaymentList.reservation_card.payment_details.id=a.id,t.dataToPaymentList.reservation_card.restrict_post=a.restrict_post)};t.invokeApi(n.mapPaymentToReservation,d,f,p)},t.$parent.myScrollOptions={paymentList:{scrollbars:!0,snap:!1,hideScrollbar:!1,preventDefault:!1}},t.$on("$viewContentLoaded",function(){setTimeout(function(){t.$parent.myScroll.paymentList.refresh()},3e3)}),t.openAddNewPaymentModel=function(){t.closeDialog(),e.$broadcast("OPENPAYMENTMODEL")},t.deleteCreditCard=function(e){var a=function(){t.closeDialog()},r=function(e){t.errorMessage=e};t.callAPI(n.deleteCreditCard,{onSuccess:a,onFailure:r,params:{reservation_id:s,payment_method_id:e}})},t.shouldShowCreditCardDeleteBtn=function(){return e.isStandAlone&&o&&"rover.reservation.staycard.reservationcard.reservationdetails"===a.current.name}}]),sntRover.controller("RVPleaseSwipeCtrl",["$rootScope","$scope","sntPaymentSrv",function(e,t,a){BaseCtrl.call(this,t),t.state={numAttempts:0},t.addCardOWS=function(){t.$emit("SHOW_SIX_PAY_LOADER"),t.callAPI(a.getSixPaymentToken,{params:{reservation_id:t.reservationBillData.reservation_id,workstation_id:t.workstation_id},successCallBack:function(){t.$emit("REFRESH_BILLCARD_VIEW"),t.$emit("HIDE_SIX_PAY_LOADER"),t.closeDialog()},failureCallBack:function(e){t.state.numAttempts++,t.errorMessage=e,t.$emit("HIDE_SIX_PAY_LOADER")}})}}]),sntRover.controller("reservationPaymentController",["$scope","$rootScope","RVReservationSummarySrv","rvPermissionSrv",function(e,t,a,n){e.getHasButtonClass=function(){var t=e.reservationData.reservation_card.has_any_credit_card_attached_bill,a="has-button";return t&&e.showCCAuthButton()&&(a="has-buttons"),a},e.displayButton=function(){var t=e.reservationData.reservation_card.reservation_status,a=!0;return"NOSHOW"!==t&&"CHECKEDOUT"!==t&&"CANCELED"!==t||(a=!1),a},e.showCCAuthButton=function(){return!(!e.reservationData.reservation_card.has_any_credit_card_attached_bill||!e.isStandAlone)};var r=function(){e.reservationData.reservation_card.restrict_post=!e.reservationData.reservation_card.restrict_post};e.setAllowPostWithNoCredit=function(){if(n.getPermissionValue("ALLOW_POST_WHEN_RESTRICTED")){var t={restrict_post:!e.reservationData.reservation_card.restrict_post,reservationId:e.reservationData.reservation_card.reservation_id},i={params:t,successCallBack:r};e.callAPI(a.updateRestrictPost,i)}},e.showPostWithNoCreditButton=function(){var a=!0;return t.isStandAlone&&""!==e.reservationData.reservation_card.payment_method_used&&null!==e.reservationData.reservation_card.payment_method_used||(a=!1),a},t.$on("UPDATEDPAYMENTLIST",function(t,a){e.reservationData.reservation_card.payment_details.card_type_image=a.card_code+".png",e.reservationData.reservation_card.payment_details.card_number=a.card_number,e.reservationData.reservation_card.payment_details.card_expiry=a.card_expiry,e.reservationData.reservation_card.payment_details.is_swiped=a.is_swiped}),t.$on("UPDATECCATTACHEDBILLSTATUS",function(t,a){e.reservationData.reservation_card.has_any_credit_card_attached_bill=a})}]),sntRover.controller("RVVoidBillPopupCtrl",["$scope","$timeout","RVBillCardSrv",function(e,t,a){BaseCtrl.call(this,e),e.voidData={},e.voidBill=function(t){var n=function(t){e.$emit("VOID_BILL_GENERATED",t.bills)},r={bill_id:e.isFromAccounts?e.transactionsDetails.bills[e.currentActiveBill].bill_id:e.reservationBillData.bills[e.currentActiveBill].bill_id,data:{void_type:t,void_reason:e.voidData.reason}},i={params:r,successCallBack:n};e.callAPI(a.generateVoidBill,i)}}]),angular.module("sntRover").service("RVCompanyCardSrv",["$q","rvBaseWebSrvV2",function(e,t){var a=this,n={},r=6e4;a.companyTaArDetailsCached=[],a.companyTaNotes=[],a.cachedTime="",this.DEFAULT_PER_PAGE=10,this.DEFAULT_PAGE=1;var i={},o=this;this.fetchContactInformation=function(a){var n=a.id,r=e.defer(),i="/api/accounts/"+n,o=["is_eod_failed","is_eod_in_progress","is_eod_manual_started","is_eod_process_running"];return t.getJSON(i).then(function(e){r.resolve(_.omit(e,o))},function(e){r.reject(e)}),r.promise},this.fetchCompanyPaymentData=function(a){var n=e.defer(),r="/staff/payments/payment.json?account_id="+a;return t.getJSON(r).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.setAsPrimary=function(a){var n=e.defer(),r="api/accounts/"+a.account_id+"/set_wallet_payment_method_primary";return t.postJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.deletePayment=function(a){var n=e.defer(),r="api/accounts/"+a.account_id+"/delete_wallet_payment_methods";return t.postJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchContactInformationMandatoryFields=function(){var a=e.defer(),n="/admin/co_ta_settings/current_settings.json";return t.getJSON(n).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.fetchAccountPaymentData=function(a){var n=e.defer(),r="/staff/payments/payment.json?account_id="+a;return t.getJSON(r).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchContactInformationAndMandatoryFields=function(t){var a=e.defer(),n={};return e.when().then(function(){return o.fetchContactInformation(t).then(function(e){n=e})}).then(function(){return o.fetchContactInformationMandatoryFields().then(function(e){n.mandatoryFields=e})}).then(function(){
a.resolve(n)},function(e){a.reject(e)}),a.promise},this.fetchCommissionDetail=function(){var a=e.defer(),n=" /api/hotel_settings/default_agent_commission_details";return t.getJSON(n).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.fetchCommissionDetailsAndMandatoryFields=function(){var t=e.defer(),a={};return e.when().then(function(){return o.fetchCommissionDetail().then(function(e){a=e})}).then(function(){return o.fetchContactInformationMandatoryFields().then(function(e){a.mandatoryFields=e})}).then(function(){t.resolve(a)},function(e){t.reject(e)}),t.promise},this.fetchMultiProperties=function(a){var n=e.defer(),r="/api/accounts/"+a.accountId+"/subscribed_properties";return t.getJSON(r).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise};var s=[];this.fetchCountryList=function(){var a=e.defer(),n="/ui/country_list";return s.length?a.resolve(s):t.getJSON(n).then(function(e){s=e,a.resolve(e)},function(e){a.reject(e)}),a.promise},this.saveContactInformation=function(a){var n,r,o=e.defer(),s="api/accounts/save.json",c=parseInt(a.id,10),l=_.omit(a,["workstation_id"]),u={data:l,deferred:o};return i[c]=i[c]||[],n=i[c],(r=n.find(function(e){return angular.equals(e.data,l)&&!e.resolved}))?r.deferred.promise:(n.push(u),t.postJSON(s,a).then(function(e){u.resolved=!0,o.resolve(e)},function(e){u.resolved=!0,o.reject(e)}),o.promise)},this.fetchRates=function(a){var n=e.defer(),r="/api/rates/contract_rates";return t.getJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.replaceCard=function(a){var n={old:{type:a.cardType},new:{type:a.cardType,id:a.id,use_card_rate:a.useCardRate},change_all_reservations:a.future},r=e.defer(),i="/api/reservations/"+a.reservation+"/cards/replace";return t.putJSON(i,n).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.removeCard=function(a){var n={type:a.cardType,id:a.cardId},r=e.defer(),i="/api/reservations/"+a.reservation+"/cards/remove";return t.deleteJSON(i,n).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.fetchArAccountDetails=function(n){var i=n.id,o=e.defer(),s="/api/accounts/"+i+"/ar_details";if(!a.companyTaArDetailsCached[i]||a.companyTaArDetailsCached[i].expiry&&Date.now()>a.companyTaArDetailsCached[i].expiry)a.companyTaArDetailsCached[i]=o,t.getJSON(s).then(function(e){a.companyTaArDetailsCached[i]={response:e,expiry:Date.now()+r},o.resolve(e)},function(e){o.reject(e)});else{if(!a.companyTaArDetailsCached[i].response)return a.companyTaArDetailsCached[i].promise;o.resolve(a.companyTaArDetailsCached[i].response)}return o.promise},this.fetchArAccountNotes=function(n){var i=n.id,o=e.defer(),s="/api/accounts/"+i+"/ar_notes";if(!a.companyTaNotes[i]||a.companyTaNotes[i].expiry&&Date.now()>a.companyTaNotes[i].expiry)a.companyTaNotes[i]=o,t.getJSON(s).then(function(e){a.companyTaNotes[i]={response:e,expiry:Date.now()+r},o.resolve(e)},function(e){o.reject(e)});else{if(!a.companyTaNotes[i].response)return a.companyTaNotes[i].promise;o.resolve(a.companyTaNotes[i].response)}return o.promise},this.saveARNote=function(n){var r=e.defer(),i="/api/accounts/save_ar_note",o=n.id;return t.postJSON(i,n).then(function(e){a.companyTaNotes[o]=null,r.resolve(e)},function(e){r.reject(e)}),r.promise},this.saveARDetails=function(n){var r=e.defer(),i="api/accounts/save_ar_details",o=n.id;return t.postJSON(i,n).then(function(e){a.companyTaArDetailsCached[o]=null,r.resolve(e)},function(e){r.reject(e)}),r.promise},this.deleteARNote=function(n){var r=e.defer(),i="/api/accounts/delete_ar_note",o=n.id;return t.postJSON(i,n).then(function(e){a.companyTaNotes[o]=null,r.resolve(e)},function(e){r.reject(e)}),r.promise},this.deleteArAccount=function(n){var r=n.id,i=e.defer(),o="api/accounts/"+r+"/delete_ar_detail";return t.deleteJSON(o).then(function(e){a.companyTaArDetailsCached[r]=null,i.resolve(e)},function(e){i.reject(e)}),i.promise},this.fetchArAccountsList=function(a){var n=e.defer(),r="/api/accounts/"+a.id+"/ar_transactions?paid="+a.paid+"&from_date="+a.from_date+"&to_date="+a.to_date+"&query="+a.query+"&page="+a.page_no+"&per_page="+a.per_page+"&transaction_type="+a.transaction_type;return t.getJSON(r).then(function(e){e.ar_transactions&&e.ar_transactions.length>0&&angular.forEach(e.ar_transactions,function(e){"DEBIT"===e.transaction_type&&(e.active=!1)}),n.resolve(e)},function(e){n.reject(e)}),n.promise},this.addCreditAmount=function(a){var n=e.defer(),r="api/accounts/"+a.id+"/ar_transactions";return t.postJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.payForReservation=function(a){var n=e.defer(),r="api/accounts/"+a.id+"/ar_transactions/"+a.transaction_id+"/pay";return t.postJSON(r).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.openForReservation=function(a){var n=e.defer(),r="api/accounts/"+a.id+"/ar_transactions/"+a.transaction_id+"/open";return t.postJSON(r).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.payAll=function(a){var n=e.defer(),r="api/accounts/"+a.id+"/ar_transactions/pay_all";return t.postJSON(r).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},a.fetchHotelLoyaltiesHlps=function(){var a=e.defer(),r="/staff/user_memberships/get_available_hlps.json";return n.fetchHotelLoyaltiesHlps?a.resolve(n.fetchHotelLoyaltiesHlps):t.getJSON(r).then(function(e){n.fetchHotelLoyaltiesHlps=e,a.resolve(e)},function(e){a.reject(e)}),a.promise},a.fetchHotelLoyaltiesFfp=function(){var a=e.defer(),r="/staff/user_memberships/get_available_ffps.json";return n.fetchHotelLoyaltiesFfp?a.resolve(n.fetchHotelLoyaltiesFfp):t.getJSON(r).then(function(e){n.fetchHotelLoyaltiesFfp=e,a.resolve(e)},function(e){a.reject(e)}),a.promise},this.fetchTACommissionDetails=function(a){var n=e.defer(),r=" api/accounts/"+a.accountId+"/commission_details";return t.getJSON(r,a.params).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.saveTACommissionDetails=function(a){var n=e.defer(),r={};r.reservations=a.commissionDetails;var i="api/accounts/"+a.accountId+"/save_commission_details";return t.postJSON(i,r).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchTransactionDetails=function(a){var n=e.defer(),r=" /api/bills/"+a.bill_id+"/transactions";return t.getJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchArStatementPrintData=function(a){var n=e.defer(),r="/api/ar_transactions/print";return t.postJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.emailArStatement=function(a){var n=e.defer(),r="/api/ar_transactions/email";return t.postJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchArStatementData=function(a){var n=e.defer(),r="/api/ar_transactions/get_email?id="+a.id;return t.getJSON(r).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.groupChargeDetailsFetch=function(a){var n=e.defer(),r="/staff/reservation/transaction_details";return t.getJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.recalculateCommission=function(a){var n=e.defer(),r="/api/reservations/recalculate_commission_details";return t.postJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchCompanyTravelAgentStatisticsSummary=function(a){var n=e.defer(),r="/api/accounts/"+a.accountId+"/statistics?view=SUMMARY";return delete a.accountId,t.getJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchCompanyTravelAgentStatisticsDetails=function(a){var n=e.defer(),r="/api/accounts/"+a.accountId+"/statistics?view=DETAILED";return delete a.accountId,t.getJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchCompanyTravelAgentMonthlyReservations=function(a){var n=e.defer(),r="/api/accounts/"+a.accountId+"/statistics?view=RESERVATIONS";return delete a.accountId,t.getJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.verifyTravelAgentCompanyCardMerge=function(a){var n=e.defer(),r="/api/accounts/validate_card_merge";return t.postJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.mergeCards=function(a){var n=e.defer(),r="/api/accounts/merge_cards";return t.postJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise}}]),angular.module("sntRover").service("rvAccountsArTransactionsSrv",["$q","rvBaseWebSrvV2",function(e,t){this.fetchTransactionDetails=function(a){var n=e.defer(),r="/api/accounts/"+a.account_id+"/ar_transactions";return t.getJSON(r,a.getParams).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchBillPrintData=function(a){var n=e.defer(),r="/api/accounts/"+a.account_id+"/ar_transactions/"+a.id+"/print_ar_invoice";return t.postJSON(r,a).then(function(e){e.charge_details_list=[],e.credit_details_list=[],angular.forEach(e.fee_details,function(t,a){angular.forEach(t.charge_details,function(a,n){a.date=t.date,e.charge_details_list.push(a)}),angular.forEach(t.credit_details,function(a,n){a.date=t.date,e.credit_details_list.push(a)})}),n.resolve(e)},function(e){n.reject(e)}),n.promise},this.sendEmail=function(a){var n=e.defer(),r="/api/accounts/"+a.account_id+"/ar_transactions/"+a.id+"/email_ar_invoice";return t.postJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.saveArBalance=function(a){var n=e.defer(),r="/api/accounts/"+a.account_id+"/ar_transactions/create_manual_balances";return t.postJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchPaymentMethods=function(a){var n=e.defer(),r="api/accounts/"+a.id+"/ar_transactions/payments_for_allocation";return t.getJSON(r).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.paySelected=function(a){var n=e.defer(),r="/api/accounts/"+a.account_id+"/ar_transactions/allocate_payment";return t.postJSON(r,a.data).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.holdSelectedInvoices=function(a){var n=e.defer(),r="/api/accounts/"+a.account_id+"/ar_transactions/add_hold";return t.putJSON(r,a.data).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.releaseSelectedInvoices=function(a){var n=e.defer(),r="/api/accounts/"+a.account_id+"/ar_transactions/release_hold";return t.putJSON(r,a.data).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.expandPaidAndUnpaidList=function(a){var n=e.defer(),r="/api/accounts/"+a.account_id+"/ar_transactions/"+a.id+"/invoice_details";return t.getJSON(r).then(function(e){n.resolve(e.data)},function(e){n.reject(e)}),n.promise},this.fetchArStatementData=function(a){var n=e.defer(),r="/api/ar_transactions/get_email?id="+a.id;return t.getJSON(r).then(function(e){n.resolve(e.data)},function(e){n.reject(e)}),n.promise},this.fetchArStatementPrintData=function(a){var n=e.defer(),r="/api/ar_transactions/print";return t.postJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.emailArStatement=function(a){var n=e.defer(),r="/api/ar_transactions/email";return t.postJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.expandPaidAndUnpaidList=function(a){var n=e.defer(),r="/api/accounts/"+a.account_id+"/ar_transactions/"+a.id+"/invoice_details";return t.getJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.expandAllocateAndUnallocatedList=function(a){var n=e.defer(),r="/api/accounts/"+a.account_id+"/ar_transactions/"+a.id+"/payment_details";return t.getJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.getUnAllocateDetails=function(a){var n=e.defer(),r="/api/accounts/"+a.account_id+"/ar_transactions/"+a.id+"/payment_details";return t.getJSON(r).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.unAllocateSelectedPayment=function(a){var n=e.defer(),r="/api/accounts/"+a.account_id+"/ar_transactions/unallocate_payment";return t.postJSON(r,a.data).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.unAllocateData=function(a){var n=e.defer(),r="/api/accounts/"+a.account_id+"/ar_transactions/unallocate_info";return t.getJSON(r,a.data).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchAccountsReceivables=function(a){var n=e.defer(),r="/api/accounts/ar_overview";return t.getJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.moveInvoice=function(a){var n=e.defer(),r="/api/accounts/"+a.account_id+"/ar_transactions/move_invoice";return t.postJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.getAdjustmentInfo=function(a){var n=e.defer(),r="api/accounts/"+a.accountId+"/ar_transactions/"+a.arTransactionId+"/adjustment_info";return t.postJSON(r,a.requestParams).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.postAdjustmentInfo=function(a){var n=e.defer(),r="api/accounts/"+a.accountId+"/ar_transactions/"+a.arTransactionId+"/post_adjustment";return t.postJSON(r,a.postData).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.moveToCreditInvoice=function(a){var n=e.defer(),r="/api/accounts/"+a.account_id+"/ar_transactions/post_manual_credit";return t.postJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.lockBill=function(a){var n=e.defer(),r="/api/accounts/"+a.account_id+"/ar_transactions/"+a.id+"/ar_final_invoice_settlement";return t.postJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.moveZeroInvoiceAsPaid=function(a){var n=e.defer(),r="/api/accounts/"+a.account_id+"/ar_transactions/move_zero_invoices_as_paid";return t.postJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise}}]),angular.module("sntRover").service("rvAccountsConfigurationSrv",["$q","rvBaseWebSrvV2",function(e,t){var a=this;this.baseAccountSummaryData={posting_account_id:"",posting_account_name:"",posting_account_number:"",posting_account_type:"HOUSE",posting_account_status:"OPEN",demographics:{market_segment_id:"",source_id:"",booking_origin_id:""},notes:[],travel_agent:null,company:null},this.getAccountSummary=function(n){var r=e.defer();if("NEW_ACCOUNT"===n.accountId)r.resolve(angular.copy(a.baseAccountSummaryData));else{var i="api/posting_accounts/"+n.accountId;t.getJSON(i).then(function(e){r.resolve(e)},function(e){r.reject(e)})}return r.promise},this.updateAccountSummary=function(a){var n=e.defer(),r="api/posting_accounts/"+a.summary.posting_account_id;return t.putJSON(r,a.summary).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.updateBillingRefNumber=function(a){var n=e.defer(),r="api/posting_accounts/"+a.summary.posting_account_id;return a.summary.custom_reference_number=a.custom_reference_number,t.putJSON(r,a.summary).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.saveAccountSummary=function(a){var n=e.defer(),r="api/posting_accounts";return t.postJSON(r,a.summary).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.saveAccountNote=function(a){var n=e.defer(),r="api/posting_accounts/save_posting_account_note";return t.postJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.updateAccountNote=function(a){var n=e.defer(),r="api/notes/"+a.id;return t.putJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.removeAccountNote=function(a){var n=e.defer(),r="api/posting_accounts/delete_posting_account_note";return t.deleteJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.emailInvoice=function(a){var n=e.defer(),r="api/posting_accounts/email_bill_card";return t.postJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise}}]),angular.module("sntRover").service("rvAccountsSrv",["$q","rvBaseWebSrvV2",function(e,t){this.DEFAULT_PER_PAGE=50,this.DEFAULT_PAGE=1,this.getAccountsList=function(a){var n=e.defer(),r="/api/posting_accounts/search",i={q:a.query,status:a.status,per_page:a.per_page,page:a.page,account_type:a.account_type,is_non_zero:a.is_non_zero};return t.getJSON(r,i).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise}}]),angular.module("sntRover").service("rvAccountTransactionsSrv",["$q","rvBaseWebSrvV2","$rootScope",function(e,t,a){this.fetchGroupAllowances=function(e){const a="/api/groups/"+e.id+"/group_allowance_transactions";return t.getJSON(a,{associated_type:e.type}).then(function(e){var t={dataByAllowance:[],dataByDate:[]};e.allowance_data=_.map(e.allowance_data,function(e){return e.ptime=parseInt(e.time.replace(":",""),10),e});try{e.allowance_data&&e.allowance_data.length&&(t.dataByAllowance=_.groupBy(e.allowance_data,function(e){return e.addon_id}),t.dataByDate=_.groupBy(e.allowance_data,function(e){return e.date}),_.each(t.dataByAllowance,function(e,a){t.dataByAllowance[a]=_.sortBy(e,function(e){return e.ptime})}),_.each(t.dataByDate,function(e,a){t.dataByDate[a]=_.sortBy(e,function(e){return e.ptime})}))}catch(e){console.error(e)}return t},function(){})},this.searchAllowanceShares=function(a){var n=e.defer(),r="/api/groups/"+a.groupId+"/group_allowance_search";return t.getJSON(r,{query:a.query,associated_type:a.type}).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.saveAllowanceShares=function(a){var n=e.defer(),r="/api/groups/"+a.groupId+"/group_allowance_share";return t.postJSON(r,{shared_allowances:a.data,associated_type:a.type}).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchTransactionDetails=function(a){var n=e.defer(),r="/api/posting_accounts/"+a.account_id+"/bill_card";return t.getJSON(r).then(function(e){angular.forEach(e.bills,function(e){e.page_no=1,e.transactions=[],e.activeDate=e.days.length>0?_.last(e.days).date:null}),n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchBillTransactionDetails=function(a){var n=e.defer(),r="/api/bills/"+a.bill_id+"/transactions?date="+a.date+"&page="+a.page+"&per_page="+a.per_page;return t.getJSON(r).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.createAnotherBill=function(a){var n=e.defer(),r="api/bills/create_bill";return t.postJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.moveToAnotherBill=function(a){var n=e.defer(),r="api/bills/transfer_transaction";return t.postJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.transactionEdit=function(a){var n=e.defer(),r=a.id,i=a.updatedDate,o="api/financial_transactions/"+r;return t.putJSON(o,i).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.transactionEditChargeDescription=function(a){var n=e.defer(),r="api/financial_transactions/"+a.id+"/save_custom_description";return t.postJSON(r,a.postData).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.transactionDelete=function(a){var n=e.defer(),r=a.id,i="api/financial_transactions/"+r;return t.putJSON(i,a.data).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.transactionSplit=function(a){var n=e.defer(),r=a.id,i="api/financial_transactions/"+r;return t.putJSON(i,a.data).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.savePaymentDetails=function(a){var n=e.defer(),r="/api/bills/"+a.bill_id+"/add_payment_method";return t.postJSON(r,a.data_to_pass).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.submitPaymentOnBill=function(n){var r=0,i=function(){r++},o=setInterval(i,1e3),s=e.defer(),c="/api/bills/"+n.bill_id+"/submit_payment",l=function(e){if(r>=a.emvTimeout){var n=["Request timed out. Unable to process the transaction"];s.reject(n)}else t.getJSONWithSpecialStatusHandling(e).then(function(t){t.status&&"processing_not_completed"===t.status||"null"===t?setTimeout(function(){console.info("POLLING::-> for emv terminal response"),l(e)},5e3):(clearInterval(o),s.resolve(t))},function(t){"undefined"==typeof t?l(e):(clearInterval(o),s.reject(t))})};return t.postJSONWithSpecialStatusHandling(c,n.data_to_pass).then(function(e){n.data_to_pass.is_emv_request&&e.status&&"processing_not_completed"===e.status?l(e.location_header):(clearInterval(o),s.resolve(e))},function(e){clearInterval(o),s.reject(e)}),s.promise},this.postCharges=function(a){var n=e.defer(),r="/staff/items/post_items_to_bill";return t.postJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.checkForArAccount=function(a){var n=e.defer(),r="/api/posting_accounts/"+a.account_id+"/check_ar_account_attached";return t.getJSON(r).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchAccountBillsForPrint=function(a){var n=e.defer(),r="/api/posting_accounts/print_bill_card";return t.postJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.groupChargeDetailsFetch=function(a){var n=e.defer(),r="/api/posting_accounts/transaction_details";return t.getJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise}}]),angular.module("sntRover").service("rvGroupAccountActivitySrv",["$q","rvBaseWebSrvV2",function(e,t){this.cacheReportList={},this.fetchActivityLog=function(a){var n=e.defer(),r="/api/group_actions/"+a.id;return a=_.omit(a,"id"),t.getJSON(r,a).then(function(e){this.cacheReportList=e,n.resolve(this.cacheReportList)}.bind(this),function(e){n.reject(e)}),n.promise}}]),angular.module("sntRover").service("rvGroupActionsSrv",["$q","BaseWebSrvV2",function(e,t){var a=this,n=null;a.searchPerPage=50,a.page=1,a.to_date="",this.getTasksCount=function(a){var n=e.defer(),r="/api/groups/"+a.id;return t.getJSON(r).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.getActionsTasksList=function(a){var n=e.defer(),r="/api/action_tasks?associated_id="+a.id+"&associated_type=Group";return t.getJSON(r).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.getActionsManagerTasksList=function(a){var n=e.defer(),r="/api/action_tasks?associated_type=Reservation";return t.getJSON(r).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.syncActionCount=function(a){var n=e.defer(),r="/api/action_tasks/sync_with_external_pms?reservation_id="+a;return t.getJSON(r).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.postNewAction=function(a){var n=e.defer(),r="/api/action_tasks.json";return t.postJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.updateNewAction=function(a){var n=e.defer(),r="/api/action_tasks/"+a.action_task.id+".json";return t.putJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.completeAction=function(a){var n=e.defer(),r="/api/action_tasks/"+a.action_task.id;return t.putJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchDepartments=function(){var n=e.defer(),r="admin/departments.json";return null===a.cache.responses.departments||Date.now()>a.cache.responses.departments.expiryDate?t.getJSON(r).then(function(e){a.cache.responses.departments={data:e,expiryDate:Date.now()+1e3*a.cache.config.lifeSpan},n.resolve(e)},function(e){n.reject(e)}):n.resolve(a.cache.responses.departments.data),n.promise},this.fetchGuestInfo=function(n){var r=e.defer();n&&(n.fakeDataToAvoidCache=new Date),a.toDate=void 0===a.toDate?"":a.toDate;var i="search.json?per_page="+a.searchPerPage+"&page="+a.page;return t.getJSON(i,n).then(function(e){e.data.results;if(n.query){var t,a,i,o=n.query.toLowerCase(),s=0;for(var c in e.data.results)e.data.results[c].is_row_visible=!1,e.data.results[c].firstname&&(t=e.data.results[c].firstname.toLowerCase(),t.indexOf(o)!==-1&&(e.data.results[c].is_row_visible=!0,s++)),e.data.results[c].lastname&&(a=e.data.results[c].lastname.toLowerCase(),a.indexOf(o)!==-1&&(e.data.results[c].is_row_visible=!0,s++)),e.data.results[c].room&&(i=e.data.results[c].room.toLowerCase(),i.indexOf(o)!==-1&&(e.data.results[c].is_row_visible=!0,s++))}e.queryTime=n.queryTime,e.visibleRowCount=s,e.querySent=n.query,r.resolve(e)},function(e){r.reject(e)}),r.promise},this.fetchActions=function(a){var n=e.defer(),r="api/action_tasks/hotel_actions";return t.getJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.getActionDetails=function(a){var n=e.defer(),r="api/action_tasks/"+a;return t.getJSON(r).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.cache={config:{lifeSpan:900},responses:{departments:null}},a.setFilterState=function(e){n=angular.copy(e)},a.getFilterState=function(e){return n},a.clearFilterState=function(e){n=null}}]),angular.module("sntRover").service("rvGroupActivitySrv",["$q","rvBaseWebSrvV2",function(e,t){this.cacheReportList={},this.fetchActivityLog=function(a){var n=e.defer(),r="/ui/show?format=json&json_input=activityLog/activity_log.json";return t.getJSON(r,a).then(function(e){this.cacheReportList=e,n.resolve(this.cacheReportList)}.bind(this),function(e){n.reject(e)}),n.promise},this.fetchActivityLog1=function(a){var n=e.defer(),r="/ui/show?format=json&json_input=activityLog/activity_log1.json";return t.getJSON(r,a).then(function(e){this.cacheReportList=e,n.resolve(this.cacheReportList)}.bind(this),function(e){n.reject(e)}),n.promise}}]),angular.module("sntRover").service("rvGroupConfigurationSrv",["$q","rvBaseWebSrvV2","rvAccountsConfigurationSrv","rvHouseEventsListSrv",function(e,t,a,n){var r=this;this.baseConfigurationSummary={group_id:null,group_name:"",group_code:null,first_name:"",last_name:"",contact_phone:null,contact_email:null,demographics:{reservation_type_id:"",market_segment_id:"",source_id:"",booking_origin_id:"",segment_id:""},travel_agent:null,company:null,hold_status:"",block_from:"",block_to:"",revenue_actual:null,revenue_potential:null,rooms_total:null,rooms_pickup:null,rate:"",addons_count:null,notes:[]},this.lastFetchedGroup={group_id:null,demographics:null},this.getHoldStatusList=function(a){var n=e.defer(),r="/api/group_hold_statuses";return t.getJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.saveRoomBlockBookings=function(a){var n=e.defer(),r="/api/groups/save_inventories";return t.postJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.saveMassUpdate=function(a){var n=e.defer(),r="/api/groups/save_bulk_inventories";return t.postJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.getGroupInventories=function(a){var n=e.defer(),r="/api/groups/"+a.group_id+"/inventories";return t.getJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.getRoomBlockGridDetails=function(t){var a=[],i=e.defer();return a.push(r.getGroupInventories(t)),a.push(n.fetchHouseEventsCount(t)),e.all(a).then(function(e){var t=e[0];t.eventsCount=e[1],i.resolve(t)},function(){i.reject({})}),i.promise},this.getAllRoomTypes=function(){var a=e.defer(),n="/api/room_types.json?is_exclude_pseudo=true";return t.getJSON(n).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.getSelectedRoomTypesAndRates=function(a){var n=e.defer(),r=a.id,i="/api/groups/"+r+"/room_type_and_rates";return t.getJSON(i,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.updateSelectedRoomTypesAndRates=function(a){var n=e.defer(),r="/api/groups/update_room_type_and_rates";return t.postJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.cancelGroup=function(a){var n=e.defer(),r="/api/groups/"+a.group_id+"/cancel";return t.postJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.sendGroupConfirmationEmail=function(a){var n=e.defer(),r=a.postData,i=" api/groups/"+a.groupId+"/group_email_confirmation";return t.postJSON(i,r).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.getRoomTypeBestAvailableRateAndOccupancyCount=function(a){var n=e.defer(),r="/api/groups/availability";return t.getJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise};this.getGroupSummary=function(n){var i=e.defer(),o="";if("NEW_GROUP"===n.groupId)i.resolve(angular.copy({groupSummary:r.baseConfigurationSummary}));else{var o="api/groups/"+n.groupId;t.getJSON(o).then(function(e){var n,o=e.posting_account_id;null===e.rate&&(e.rate=-1),e.country_id=e.country_id?e.country_id:"",e.nationality=e.nationality?e.nationality:"",r.lastFetchedGroup={id:e.group_id,demographics:angular.copy(e.demographics)},"NEW_ACCOUNT"===o?i.resolve({accountSummary:angular.copy(a.baseAccountSummaryData)}):(n="api/posting_accounts/"+o,t.getJSON(n).then(function(t){_.defer(i.resolve,{groupSummary:e,accountSummary:t})},function(e){i.reject(e)}))},function(e){i.reject(e)})}return i.promise},this.searchCompanyCards=function(a){var n=e.defer(),r="api/accounts?account_type=COMPANY&query="+a;return t.getJSON(r).then(function(e){n.resolve(e.accounts)},function(e){n.reject(e)}),n.promise},this.searchTravelAgentCards=function(a){var n=e.defer(),r="api/accounts?account_type=TRAVELAGENT&query="+a;return t.getJSON(r).then(function(e){n.resolve(e.accounts)},function(e){n.reject(e)}),n.promise},this.updateGroupSummary=function(a){var n=e.defer(),i="api/groups/"+a.summary.group_id;return r.processGroupUpdatePostData(a.summary),t.putJSON(i,a.summary).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.saveGroupSummary=function(a){var n=e.defer(),r="api/groups";return t.postJSON(r,a.summary).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.addGroupEnhancement=function(a){var n=e.defer(),r="/api/groups/"+a.id+"/addons";return t.postJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.removeGroupEnhancement=function(a){var n=e.defer(),r="/api/groups/"+a.id+"/addons";return t.deleteJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.getGroupEnhancements=function(a){var n=e.defer(),r="/api/groups/"+a.id+"/addons";return t.getJSON(r).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.saveGroupNote=function(a){var n=e.defer(),r="api/groups/save_group_note";return t.postJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.updateGroupNote=function(a){var n=e.defer(),r="api/notes/"+a.id;return t.putJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.removeGroupNote=function(a){var n=e.defer(),r="api/groups/delete_group_note";return t.deleteJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.updateRoomingListItem=function(a){var n=e.defer(),r="api/group_reservations/"+a.id;return t.putJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.removeRoomingListItem=function(a){var n=e.defer(),r="api/group_reservations/"+a.id+"/cancel";return t.postJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.releaseRooms=function(a){var n=e.defer(),r="api/groups/"+a.groupId+"/release_now";return t.getJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.getRates=function(a){var n=e.defer(),r="api/groups/rates";return t.getJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.toggleHideRate=function(a){var n=e.defer(),r="api/groups/"+a.group_id+"/hide_rates";return t.postJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.updateRate=function(a){var n=e.defer(),r="api/groups/"+a.group_id+"/change_rate";return t.postJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.completeMoveGroup=function(a){var n=e.defer(),r="/api/groups/"+a.group_id+"/move_dates",i={from_date:a.from_date,to_date:a.to_date,old_from_date:a.old_from_date,old_to_date:a.old_to_date,force_fully_over_book:a.force_fully_over_book
};return t.postJSON(r,i).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.changeDates=function(a){var n=e.defer(),r="/api/groups/"+a.group_id+"/change_dates",i=_.omit(a,"group_id");return t.postJSON(r,i).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.deleteBillingInfo=function(a){var n=e.defer(),r="/api/groups/"+a.group_id+"/remove_routing";return t.postJSON(r,{}).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.processGroupUpdatePostData=function(e){var t=isObjectAllValuesEmpty(e.company),a=isObjectAllValuesEmpty(e.travel_agent);t&&(e.company={}),a&&(e.travel_agent={}),e=replaceValueWithinObject(e,"",null)},this.updateAddonPosting=function(a){var n=e.defer(),r="/api/groups/"+a.group_id+"/update_addon_posting";return t.postJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.updateCompanyCard=function(a){var n=e.defer(),r="/api/groups/"+a.id+"/update_company_card";return t.postJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.updateHoldStatus=function(a){var n=e.defer(),r="/api/groups/"+a.id+"/hold_status";return t.putJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchRoomTypesRates=function(a){var n=e.defer(),r="/api/groups/"+a.group_id+"/daily_rates";return t.getJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.getRoomTypesOccupancyRateDetailsAndEventsCount=function(t){var a=[],i=e.defer();return a.push(r.fetchRoomTypesRates(t)),a.push(n.fetchHouseEventsCount(t)),e.all(a).then(function(e){var t={results:e[0],eventsCount:e[1]};i.resolve(t)},function(e){i.reject(e)}),i.promise},this.performRateMassUpdate=function(a){var n=e.defer(),r="/api/groups/"+a.groupId+"/daily_rates/bulk_update";return delete a.groupId,t.putJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.saveRoomTypesDailyRates=function(a){var n=e.defer(),r="/api/groups/"+a.group_id+"/daily_rates";return t.putJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise}}]),angular.module("sntRover").service("rvGroupRoomingListSrv",["$q","rvBaseWebSrvV2","rvUtilSrv","sntBaseWebSrv",function(e,t,a,n){var r=this;this.DEFAULT_PER_PAGE=50,this.DEFAULT_PAGE=1,this.addReservations=function(a){var n=e.defer(),r=(a.id,"/api/group_reservations/"),a={group_id:a.group_id,reservations_data:{room_type_id:a.room_type_id,from_date:a.from_date,to_date:a.to_date,occupancy:a.occupancy,no_of_reservations:a.no_of_reservations}};return t.postJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchReservations=function(a){var n=e.defer(),r="/api/group_reservations/"+a.group_id+"/list",i=$.extend({},{per_page:a.per_page,page:a.page,locale:a.locale||"en"}),o=["sort_field","sort_dir","arrival_date","dep_date","query","exclude_cancel","show_pending_only"];return _.each(o,function(e){typeof a[e]!=typeof!0&&a[e]&&(i[e]=a[e]),typeof a[e]==typeof!0&&(i[e]=a[e])}),t.getJSON(r,i).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.performMassCheckin=function(a){var n=e.defer(),r=(a.id,"/api/group_checkins/"),a={group_id:a.group_id,reservation_ids:a.reservation_ids};return t.postJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.performMassCheckout=function(a){var n=e.defer(),r=(a.id,"/api/group_checkouts/"),a={group_id:a.group_id,reservation_ids:a.reservation_ids};return t.postJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.performAutoRoomAssignment=function(a){var n=e.defer(),r=(a.id,"/api/groups/auto_room_assignment"),a={group_id:a.group_id,reservation_ids:a.reservation_ids};return t.postJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.getFreeAvailableRooms=function(a){var n="/api/reservations/"+a.reserevation_id+"/ready_to_assign_rooms/",r=e.defer(),i={count:a.num_of_rooms_to_fetch,room_type_id:a.room_type_id};return t.getJSON(n,i).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.getRoomTypesConfiguredAgainstGroup=function(a){var n=e.defer(),r=a.id,i="api/group_rooms/"+r;return t.getJSON(i,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.checkDefaultChargeRoutings=function(a){var n=e.defer(),r=a.id,i="/api/groups/"+r+"/check_default_charge_routings";return t.getJSON(i).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.attachBillingInfoToReservations=function(a){var n=e.defer(),r="/api/default_account_routings/attach_reservation";return t.postJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.emailInvoice=function(a){var n=e.defer(),r="/api/group_reservations/email_rooming_list";return t.postJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchRegistrationCardPrintData=function(a){var n=e.defer(),r="/api/registration_cards/";return t.getJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.updateGuestData=function(a){var n=e.defer(),r="/api/group_reservations/update_guest_details";return t.postJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.exportRoomingList=function(e){var t="/api/group_reservations/"+e.group_id+"/list.csv";return delete e.group_id,n.download(t,e,"GET")},this.fetchHotelReservationSettings=function(){var a=e.defer(),n="/api/hotel_settings/show_hotel_reservation_settings";return r.reservationSettings?a.resolve(r.reservationSettings):t.getJSON(n).then(function(e){r.reservationSettings=e,a.resolve(e)},function(e){a.reject(e)}),a.promise}}]),angular.module("sntRover").service("rvGroupSrv",["$q","rvBaseWebSrvV2",function(e,t){this.DEFAULT_PER_PAGE=50,this.DEFAULT_PAGE=1,this.getGroupList=function(a){var n=e.defer(),r="/api/groups/search";return a.q=a.q||a.query,t.postJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.searchGroupCard=function(a){var n=e.defer(),r="/api/groups/group_search",i={name:a.name,code:a.code,from_date:a.from_date,to_date:a.to_date,per_page:a.per_page,page:a.page};return a.is_take_from_inventory&&(i.is_take_from_inventory=!0),t.getJSON(r,i).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.attachGroupToReservation=function(a){var n=e.defer(),r="/api/reservations/"+a.reservation_id+"/add_group",i={group_id:a.group_id};return a.forcefully_overbook&&(i.forcefully_overbook=a.forcefully_overbook),t.postJSON(r,i).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.detachGroupFromReservation=function(a){var n=e.defer(),r="/api/reservations/"+a.reservation_id+"/remove_group",i={group_id:a.group_id};return t.postJSON(r,i).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchHotelBusinessDate=function(){var a=e.defer(),n="/api/business_dates/active";return t.getJSON(n).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise};var a=function(e){return"cancel"===e.hold_status.toLowerCase()};this.getClassAgainstPickedStatus=function(e){var t="";return e.total_picked_count>0&&(t="green"),a(e)&&(t+=" red"),t},this.getGuestClassForArrival=function(e){var t=a(e)?"cancel":"check-in";return t},this.getGuestClassForDeparture=function(e){var t=a(e)?"cancel":"check-out";return t},this.getClassAgainstHoldStatus=function(e){return"true"===e.is_take_from_inventory?"":"tentative"},this.getHoldStatusList=function(a){var n=e.defer(),r="/api/group_hold_statuses";return t.getJSON(r,a).then(function(e){_.each(e.data.hold_status,function(e){e.active=!0}),n.resolve(e.data)},function(e){n.reject(e)}),n.promise},this.updateCache=function(e){this.filterParams=e},this.getCache=function(){return this.filterParams},this.clearCache=function(){this.filterParams={}}}]),angular.module("sntRover").service("RVReservationSummarySrv",["$q","rvBaseWebSrvV2",function(e,t){var a=this;this.reservationData={},this.reservationData.demographics={};var n={},r={},i={},o={},s={};this.fetchPaymentMethods=function(){var a=e.defer(),n="/staff/payments/addNewPayment.json";return t.getJSON(n).then(function(e){a.resolve(e.data)},function(e){a.reject(e)}),a.promise},this.fetchLengthSegments=function(){var a=e.defer();if(isEmpty(s)){var n="/api/segments?is_active=true";t.getJSON(n).then(function(e){s=e,a.resolve(e)},function(e){a.reject(e)})}else a.resolve(s);return a.promise},this.fetchDemographicMarketSegments=function(){var a=e.defer();if(isEmpty(n)){var r="/api/market_segments?is_active=true";t.getJSON(r).then(function(e){n=e,a.resolve(n)},function(e){a.reject(e)})}else a.resolve(n);return a.promise},this.fetchDemographicSources=function(){var a=e.defer();if(isEmpty(r)){var n="/api/sources?is_active=true";t.getJSON(n).then(function(e){r=e,a.resolve(r)},function(e){a.reject(e)})}else a.resolve(r);return a.promise},this.fetchDemographicOrigins=function(){var a=function(e){i.is_use_origins=e.is_use_origins,i.origins=[];for(var t in e.booking_origins)e.booking_origins[t].is_active&&i.origins.push(e.booking_origins[t]);n.resolve(i)},n=e.defer();if(isEmpty(i)){var r="/api/booking_origins";t.getJSON(r).then(function(e){a(e)},function(e){n.reject(e)})}else n.resolve(i);return n.promise},this.fetchDemographicReservationTypes=function(){var n=function(e){o=[],a.reservationData.demographics.reservationTypes=[];for(var t in e.reservation_types)e.reservation_types[t].is_active&&o.push(e.reservation_types[t]);r.resolve(o)},r=e.defer();if(isEmpty(o)){var i="/api/reservation_types.json?is_active=true";t.getJSON(i).then(function(e){n(e)},function(e){r.reject(e)})}else r.resolve(o);return r.promise},this.fetchInitialData=function(){var t=e.defer(),n={};return n.marketsData=a.fetchDemographicMarketSegments(),n.originsData=a.fetchDemographicOrigins(),n.sourcesData=a.fetchDemographicSources(),n.reservationTypesData=a.fetchDemographicReservationTypes(),n.segmentsData=a.fetchLengthSegments(),e.all(n).then(function(e){a.reservationData.demographics.is_use_markets=e.marketsData.is_use_markets,a.reservationData.demographics.markets=e.marketsData.markets,a.reservationData.demographics.is_use_origins=e.originsData.is_use_origins,a.reservationData.demographics.origins=e.originsData.origins,a.reservationData.demographics.is_use_sources=e.sourcesData.is_use_sources,a.reservationData.demographics.sources=e.sourcesData.sources,a.reservationData.demographics.is_use_segments=e.segmentsData.is_use_segments,a.reservationData.demographics.segments=e.segmentsData.segments,a.reservationData.demographics.reservationTypes=e.reservationTypesData,t.resolve(a.reservationData)},function(e){t.reject(e)}),t.promise},this.saveReservation=function(a){var n=e.defer(),r="/api/reservations";return t.postJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.updateBillingInformation=function(a){var n=e.defer(),r="api/bill_routings/update_dates";return t.postJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.sendConfirmationEmail=function(a){var n=e.defer(),r="/api/reservations/"+a.reservationId+"/email_confirmation";return delete a.reservationId,t.postJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.sendHourlyConfirmationEmail=function(a){var n=e.defer(),r="/api/reservations/hourly_confirmation_emails?";return _.each(a.reservation_ids,function(e){r+="reservation_ids[]="+e+"&"}),_.each(a.emails,function(e){r+="emails[]="+encodeURIComponent(e)+"&"}),delete a.reservation_ids,delete a.emails,t.postJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.updateReservation=function(a){var n=e.defer(),r="/api/reservations/"+a.reservationId;return t.putJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.paymentAction=function(a){var n=e.defer(),r="/api/ipage/store_payments";return t.postJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.startPayment=function(a){var n=e.defer(),r="/api/cc/get_token";return t.postJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchRooms=function(){var a=e.defer(),n="/api/rooms";return t.getJSON(n).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.getRateName=function(a){var n=e.defer(),r="/api/rates/"+a.id;return t.getJSON(r).then(function(e){n.resolve(e.name)},function(e){n.reject(e)}),n.promise},this.getRateDetails=function(a){var n=e.defer(),r="/api/rates/"+a.id;return t.getJSON(r).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.getTaxDetails=function(a){var n=e.defer(),r="/api/rates/tax_information/";return t.getJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchDefaultRoutingInfo=function(a){var n=e.defer(),r="/api/default_account_routings/routings_count/";return t.postJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.applyDefaultRoutingToReservation=function(a){var n=e.defer(),r="/api/default_account_routings/attach_reservation";return t.postJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchResservationConfirmationPrintData=function(a){var n=e.defer(),r="/api/reservations/"+a.reservation_id+"/confirmation_email_data";return t.getJSON(r,a).then(function(e){e.data.addons_list=e.data.addons?e.data.addons.toString():"",n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchResservationCancellationPrintData=function(a){var n=e.defer(),r="/api/reservations/"+a.reservation_id+"/cancellation_email_data";return t.getJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.updateNoRoomMove=function(a){var n=e.defer(),r="/api/reservations/"+a.reservationId+"/update_no_room_move_flag";return t.postJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.updateRestrictPost=function(a){var n=e.defer(),r="/api/reservations/"+a.reservationId+"/update_restrict_post_flag";return t.postJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.saveTaxExempt=function(a){var n=e.defer(),r="/api/reservations/save_tax_exempt";return t.postJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.checkUpsellAvailability=function(a){var n=e.defer(),r="/api/reservations/"+a+"/upsell_availability";return t.getJSON(r).then(function(e){n.resolve(e.is_upsell_available)},function(e){n.reject(e)}),n.promise},this.updateCommission=function(a){var n=e.defer(),r="/api/reservations/"+a.reservationId+"/update_commission";return t.putJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.retrieveRoomPin=function(a){var n=e.defer(),r="/staff/reservation/get_room_pin";return t.getJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.updateBookerEmail=function(a){var n=e.defer(),r="/api/reservations/"+a.reservationId+"/update_booker_email";return t.putJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise}}]),angular.module("sntRover").service("RVPaymentSrv",["$http","$q","RVBaseWebSrv","rvBaseWebSrvV2","$rootScope","sntBaseWebSrv",function(e,t,a,n,r,i){var o={PAYMENT_TYPES:{}};this.renderPaymentScreen=function(e){var n=t.defer(),r="/staff/payments/addNewPayment.json",i=angular.toJson(e||"default");return o.PAYMENT_TYPES[i]?n.resolve(o.PAYMENT_TYPES[i]):a.getJSON(r,e).then(function(e){o.PAYMENT_TYPES[i]=e,n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchAvailPayments=function(e){var n=t.defer(),r="/staff/payments/addNewPayment.json";return a.getJSON(r,e).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.savePaymentDetails=function(e){var n=t.defer(),r="staff/reservation/save_payment";return a.postJSON(r,e).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.saveGuestPaymentDetails=function(e){var n=t.defer(),r="staff/payments/save_new_payment";return a.postJSON(r,e).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.setAsPrimary=function(e){var n=t.defer(),r="/staff/payments/setCreditAsPrimary";return a.postJSON(r,e).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.deletePayment=function(e){var n=t.defer(),r="/staff/payments/deleteCreditCard";return a.postJSON(r,e).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.getPaymentList=function(e){var n=t.defer(),r="/staff/staycards/get_credit_cards.json?reservation_id="+e;return a.getJSON(r).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.getReceiptsList=function(e){var a=t.defer(),r="/api/bills/payment_receipts";return n.getJSON(r,e).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.getExistingPaymentsForBill=function(e){var n=t.defer(),r="/staff/staycards/get_credit_cards.json";return a.getJSON(r,e).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.mapPaymentToReservation=function(e){var n=t.defer(),r="/staff/reservation/link_payment";return a.postJSON(r,e).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.submitPaymentOnBill=function(e){var a=0,i=function(){a++},o=setInterval(i,1e3),s=t.defer(),c="api/reservations/"+e.reservation_id+"/submit_payment",l=function(e){if(a>=r.emvTimeout){var t=["Request timed out. Unable to process the transaction"];s.reject(t)}else n.getJSONWithSpecialStatusHandling(e).then(function(t){t.status&&"processing_not_completed"===t.status||"null"===t?setTimeout(function(){console.info("POLLING::-> for emv terminal response"),l(e)},5e3):(clearInterval(o),s.resolve(t))},function(t){"undefined"==typeof t?l(e):(clearInterval(o),s.reject(t))})};return n.postJSONWithSpecialStatusHandling(c,e.postData).then(function(t){e.postData.is_emv_request&&t.status&&"processing_not_completed"===t.status?l(t.location_header):(clearInterval(o),s.resolve(t))},function(e){clearInterval(o),s.reject(e)}),s.promise},this.makePaymentOnDepositBalance=function(e){var n=t.defer(),r="staff/reservation/post_payment";return a.postJSON(r,e).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.chipAndPinGetToken=function(e){var a=0,i=function(){a++},o=setInterval(i,1e3),s=t.defer(),c="/api/cc/get_token.json",l=function(e){if(a>=r.emvTimeout){var t=["Request timed out. Unable to process the transaction"];s.reject(t)}else n.getJSONWithSpecialStatusHandling(e).then(function(t){t.status&&"processing_not_completed"===t.status||"null"===t?setTimeout(function(){console.info("POLLING::-> for emv terminal response"),l(e)},5e3):(clearInterval(o),s.resolve(t))},function(t){"undefined"==typeof t?l(e):(clearInterval(o),s.reject(t))})};return n.postJSONWithSpecialStatusHandling(c,e).then(function(e){e.status&&"processing_not_completed"===e.status?l(e.location_header):(clearInterval(o),s.resolve(e))},function(e){clearInterval(o),s.reject(e)}),s.promise},this.deleteCreditCard=function(e){var a=t.defer(),n="api/reservations/"+e.reservation_id+"/delete_credit_card";return delete e.reservation_id,i.postJSON(n,e).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise}}]),angular.module("sntRover").service("RVReservationCardSrv",["$http","$q","RVBaseWebSrv","rvBaseWebSrvV2","RVGAHelperSrv","$rootScope",function(e,t,a,n,r,i){this.reservationData={};var o=this;this.fetch=function(e){var n=t.defer(),r=e.reservationId,i=e.isRefresh,s=!1;if(angular.forEach(o.reservationIdsArray,function(e,t){i&&null!==i&&""!==i||e===r&&(s=!0)}),s)n.resolve(o.reservationData[r]);else{o.storeReservationIds(r);var c="api/reservations/"+r+".json";a.getJSON(c).then(function(e){o.reservationData[r]=e,n.resolve(e)},function(e){n.reject(e)})}return n.promise},this.reservationDetails={},this.confirmationNumbersArray=[],this.reservationIdsArray=[];var o=this;this.emptyConfirmationNumbers=function(){o.confirmationNumbersArray=[],o.reservationDetails={}},this.storeConfirmationNumbers=function(e){o.confirmationNumbersArray.push(e)},this.storeReservationIds=function(e){o.reservationIdsArray.push(e)},this.fetchReservationDetails=function(e){var n=e.confirmationNumber,i=e.isRefresh,s=!1,c=!0;angular.forEach(o.confirmationNumbersArray,function(e,t){i&&null!==i||e===n&&(s=!0)});var l=t.defer();if(s)l.resolve(o.reservationDetails[n]);else{o.storeConfirmationNumbers(n);var u="/staff/staycards/reservation_details.json?reservation="+n+"&is_dep_date_allowed="+c;a.getJSON(u).then(function(e){o.reservationDetails[n]=e,r.sendEventToGA("LOAD_RESERVATION",n),l.resolve(e)},function(e){l.reject(e)})}return l.promise},this.updateResrvationForConfirmationNumber=function(e,t){o.reservationDetails[e]=t},this.getResrvationForConfirmationNumber=function(e){return o.reservationDetails[e]},this.guestData="",this.setGuestData=function(e){this.guestData=e},this.getGuestData=function(){return this.guestData},this.fetchGuestcardData=function(e){var n=t.defer(),r="/staff/guestcard/show.json";return a.getJSON(r,e).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchCancellationPolicies=function(e){var a=t.defer(),r="/api/reservations/"+e.id+"/cancellation_policies";return n.getJSON(r,e).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.cancelReservation=function(e){var a=t.defer(),r="/api/reservations/"+e.id+"/cancel";return n.postJSON(r,e).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.tokenize=function(e){var n=t.defer(),r="/staff/payments/tokenize";return a.postJSON(r,e).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.getLastRateAdjustmentReason=function(e){var a=t.defer(),r="api/reservations/"+e.reservation_id+"/reason_for_last_adjusted_rate";return n.getJSON(r).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.saveReservationNote=function(e){var n=t.defer(),r="/reservation_notes";return a.postJSON(r,e).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.deleteReservationNote=function(e){var n=t.defer(),r="/reservation_notes/"+e;return a.deleteJSON(r,"").then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.updateReservationNote=function(e){var a=t.defer(),r="/reservation_notes/"+e.id;return n.putJSON(r,e).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.getGuestDetails=function(e){var a=t.defer(),r="/api/guest_details/"+e.id;return null===e.id?a.reject([""]):n.getJSON(r).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.modifyRoomQueueStatus=function(e){var a=t.defer(),r={status:e.status};e.viaAdvancedQueue&&(r.signature=e.signature,r.is_promotions_and_email_set=e.is_promotions_and_email_set);var i="/api/reservations/"+e.reservationId+"/queue";return n.postJSON(i,r).then(function(t){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.fetchDepositDetails=function(e){var a=t.defer(),r="api/reservations/"+e+"/deposit_policy";return n.getJSON(r).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.sendConfirmationEmail=function(e){var a=t.defer(),r="/api/reservations/"+e.reservationId+"/email_confirmation";return n.postJSON(r,e.postData).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.validateStayDateChange=function(e){var a=t.defer(),r="/staff/change_stay_dates/validate_stay_dates_change";return n.postJSON(r,e).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.detachGroupReservation=function(e){var a=t.defer(),r="/api/group_reservations/"+e.id+"/detach_group_reservation";return n.postJSON(r,e).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.reinstateReservation=function(e){var a=t.defer(),r="/api/reservations/"+e.reservationId+"/reinstate";return n.postJSON(r,e).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.checkReinstationAvailbility=function(e){var a=t.defer(),r="/api/reservations/"+e+"/check_reinstate_availability";return n.getJSON(r).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.checkGiftCardBalance=function(e){var a={card_number:e.card_number},r=t.defer(),i="/api/gift_cards/balance_inquiry";return n.postJSON(i,a).then(function(e){e&&"number"==typeof e.amount&&(e.amount=parseFloat(e.amount).toFixed(2)),r.resolve(e)},function(e){r.reject(e)}),r.promise},this.fetchGuestIdentity=function(e){var a=t.defer(),r="/api/guest_identity/"+e.reservation_id;return n.getJSON(r,e).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.reverseCheckIn=function(e){var a=t.defer(),r="/api/reservations/"+e.reservationId+"/reverse_check_in";return n.postJSON(r).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.attachGuestToReservation=function(e){var a=t.defer(),r="/api/reservations/"+e.reservation_id+"/reservations_guest_details/attach_guest_details";return delete e.reservation_id,n.postJSON(r,e).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.getConfirmationData=function(e){var a=t.defer(),r="/api/reservations/"+e.reservation_id+"/confirmation_data";return n.getJSON(r).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.createActivityLog=function(e){var a=t.defer();return n.postJSON("/api/reservation_actions",e).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise}}]),angular.module("sntRover").service("RVDepositBalanceSrv",["$q","BaseWebSrvV2","rvBaseWebSrvV2","$rootScope",function(e,t,a,n){this.getDepositBalanceData=function(a){var n=e.defer(),r="staff/reservations/"+a.reservationId+"/deposit_and_balance.json";return t.getJSON(r).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.getRevenueDetails=function(a){var n=e.defer(),r="api/posting_accounts/"+a.posting_account_id+"/deposit_and_balance";return t.getJSON(r).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.submitPaymentOnBill=function(t){var r=0,i=function(){r++},o=setInterval(i,1e3),s=e.defer(),c="/api/bills/"+t.bill_id+"/submit_payment",l=function(e){if(r>=n.emvTimeout){var t=["Request timed out. Unable to process the transaction"];s.reject(t)}else a.getJSONWithSpecialStatusHandling(e).then(function(t){t.status&&"processing_not_completed"===t.status||"null"===t?setTimeout(function(){console.info("POLLING::-> for emv terminal response"),l(e)},5e3):(clearInterval(o),s.resolve(t))},function(t){"undefined"==typeof t?l(e):(clearInterval(o),s.reject(t))})};return a.postJSONWithSpecialStatusHandling(c,t.postData).then(function(e){t.is_emv_request&&e.status&&"processing_not_completed"===e.status?l(e.location_header):(clearInterval(o),s.resolve(e))},function(e){clearInterval(o),s.reject(e)}),s.promise}}]),angular.module("sntRover").service("RVBillCardSrv",["$http","$q","BaseWebSrvV2","RVBaseWebSrv","rvBaseWebSrvV2","sntBaseWebSrv","RVGAHelperSrv",function(e,t,a,n,r,i,o){var s=this;this.fetchReservationBillData=function(e){var a=t.defer(),n="/api/reservations/"+e+"/bills_summary";return r.getJSON(n).then(function(e){a.resolve(e.data)},function(e){a.reject(e)}),a.promise},this.fetchAllowanceData=function(e,t,a){var n="/api/bills/"+t+"/allowance_transactions";return r.getJSON(n).then(function(t){t.allowance_data&&t.allowance_data.allowance_entries&&t.allowance_data.allowance_entries.length&&(_.each(t.allowance_data.allowance_entries,function(e,a){e.entriesForTheDate=_.filter(t.allowance_data.allowance_entries,function(t){return t.date===e.date}),e.amount=e.amount?parseFloat(e.amount):e.amount}),a.allowance_data=t.allowance_data),e.resolve(a)},function(t){e.reject(t)}),e.promise},this.fetchReservationAllowanceTransactions=function(e){const t="/api/reservations/"+e+"/allowance_transactions";return r.getJSON(t).then(function(e){var t={dataByAllowance:[],dataByDate:[]};return e.allowance_data&&e.allowance_data.allowance_entries&&e.allowance_data.allowance_entries.length&&(t.dataByAllowance=_.groupBy(e.allowance_data.allowance_entries,function(e){return e.addon_id}),t.dataByDate=_.groupBy(e.allowance_data.allowance_entries,function(e){return e.date})),t.amount=e.allowance_data.amount,t},function(){})},this.searchAllowanceShares=function(e){var a=t.defer(),n="/api/reservations/"+e.reservationId+"/search_reservations_for_allowance_share";return r.getJSON(n,{query:e.query}).then(function(e){a.resolve(e.data)},function(e){a.reject(e)}),a.promise},this.saveAllowanceShares=function(e){var n=t.defer(),r="/api/reservations/"+e.reservationId+"/route_allowance";return a.postJSON(r,e.data).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchBillData=function(e){var a=t.defer(),n="/api/bills/"+e;return r.getJSON(n).then(function(e){a.resolve(e.data)},function(e){a.reject(e)}),a.promise},this.fetch=function(e){var a="",n=t.defer(),r="",i="";return t.when().then(function(){return s.fetchReservationBillData(e).then(function(e){a=e})}).then(function(){return r=a.bills[0].bill_id,i=parseInt(a.bills[0].bill_number)-1,s.fetchBillData(r).then(function(e){a.bills[i]=e})}).then(function(){a.groupedAllowances={},n.resolve(a)},function(e){n.reject(e)}),n.promise},this.fetchBillPrintData=function(e){var a=t.defer(),r="staff/bills/print_guest_bill";return n.postJSON(r,e).then(function(e){e.charge_details_list=[],angular.forEach(e.fee_details,function(t,a){angular.forEach(t.charge_details,function(a){a.date=t.date,a.isCredit=!1,e.charge_details_list.push(a)}),angular.forEach(t.credit_details,function(a){a.date=t.date,a.isCredit=!0,e.charge_details_list.push(a)})}),a.resolve(e)},function(e){a.reject(e)}),a.promise},this.fetchRegistrationCardPrintData=function(e){var a=t.defer(),n="/api/registration_cards/"+e.reservation_id;return r.getJSON(n,e).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.movetToAnotherBill=function(e){var n=t.defer(),r="/staff/bills/transfer_transaction";return a.postJSON(r,e).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.setBillAddressType=function(e){var n=t.defer(),r="/api/bills/"+e.bill_id+"/save_address_type";return a.postJSON(r,e.parmasToApi).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.completeCheckin=function(e){var a=t.defer(),r="/staff/checkin";return n.postJSON(r,e).then(function(t){o.sendEventToGA("CHECKIN",e.reservation_id),a.resolve(t)},function(e){a.reject(e)}),a.promise},this.completeCheckout=function(e){var a=t.defer(),r="/staff/checkout";return n.postJSON(r,e).then(function(t){o.sendEventToGA("CHECKOUT",e.reservation_id),a.resolve(t)},function(e){a.reject(e)}),a.promise},this.getAdvanceBill=function(e){var a=t.defer(),r="api/reservations/"+e.id+"/advance_bill";return n.postJSON(r).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.transactionEdit=function(e){var n=t.defer(),r="api/financial_transactions/"+e.id;return a.putJSON(r,e.updatedData).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.transactionEditChargeDescription=function(e){var n=t.defer(),r="api/financial_transactions/"+e.id+"/save_custom_description";return a.postJSON(r,e.postData).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.transactionDelete=function(e){var n=t.defer(),r=e.id,i="api/financial_transactions/"+r;return a.putJSON(i,e.data).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.transactionSplit=function(e){var n=t.defer(),r=e.id,i="api/financial_transactions/"+r;return a.putJSON(i,e.data).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchChargeCodes=function(){var e=t.defer(),n="/api/charge_codes?exclude_payments=true&per_page=1000";return a.getJSON(n).then(function(t){e.resolve(t)},function(t){e.reject(t)}),e.promise},this.fetchAdjustmentReasons=function(){var e=t.defer(),n="/admin/force_adjustment_reasons";return a.getJSON(n).then(function(t){e.resolve(t)},function(t){e.reject(t)}),e.promise},this.sendEmail=function(e){var n=t.defer(),r="api/reservations/email_guest_bill.json";
return a.postJSON(r,e).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.createAnotherBill=function(e){var n=t.defer(),r="/api/bills/create_bill";return a.postJSON(r,e).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.changeHousekeepingStatus=function(e){var n=t.defer(),r="/house/change_house_keeping_status.json";return a.postJSON(r,e).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.completeReverseCheckout=function(e){var n=t.defer(),r="/staff/reverse_checkout";return a.postJSON(r,e).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.toggleHideRate=function(e){var n=t.defer(),r="api/reservations/"+e.reservation_id+"/hide_rates";return a.postJSON(r,e).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.getBillSettingsInfo=function(e){var n=t.defer(),r="/api/bills/get_settings_info";return a.getJSON(r,e).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.groupChargeDetailsFetch=function(e){var n=t.defer(),r="/staff/reservation/transaction_details";return a.getJSON(r,e).then(function(e){n.resolve(e.data)},function(e){n.reject(e)}),n.promise},this.hideBill=function(e){var n=t.defer(),r="/api/bills/"+e.bill_id+"/hide_bill";return a.postJSON(r).then(function(e){n.resolve(e.data)},function(e){n.reject(e)}),n.promise},this.fetchGuestLanguages=function(e){var a=t.defer(),n="/api/guest_languages";return r.getJSON(n,e).then(function(e){e.languages&&(e.languages=_.filter(e.languages,{is_show_on_guest_card:!0})),a.resolve(e)},function(e){a.reject(e)}),a.promise},this.callBlackBoxApi=function(e){var n=t.defer(),r="/api/hotel_settings/infrasec/generate_control_code";return a.postJSON(r,e).then(function(e){n.resolve(e.data)},function(e){n.reject(e)}),n.promise},this.generateFolioNumber=function(e){var n=t.defer(),r="/api/bills/"+e.bill_id+"/generate_folio_number";return a.postJSON(r,e).then(function(e){n.resolve(e.data)},function(e){n.reject(e)}),n.promise},this.generateVoidBill=function(e){var n=t.defer(),r="/api/bills/"+e.bill_id+"/void_bill";return a.postJSON(r,e.data).then(function(e){n.resolve(e.data)},function(e){n.reject(e)}),n.promise},this.settleFinalInvoice=function(e){var n=t.defer(),r="/api/bills/"+e.bill_id+"/final_invoice_settlement";return a.postJSON(r,e).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.printReceiptData=function(e){var a=t.defer(),n="/api/bills/"+e.bill_id+"/print_payment_receipt";return i.postJSON(n,e).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.emailReceiptData=function(e){var a=t.defer(),n="/api/bills/"+e.bill_id+"/email_payment_receipt";return i.postJSON(n,e).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise}}]),angular.module("sntRover").service("RVContactInfoSrv",["$q","RVBaseWebSrv","rvBaseWebSrvV2",function(e,t,a){var n=this;n.saveContactInfo=function(a){var n=e.defer(),r=a.data,i=a.userId,o="/staff/guest_cards/"+i;return t.putJSON(o,r).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},n.createGuest=function(t){var n=e.defer(),r=t.data,i="/api/guest_details";return a.postJSON(i,r).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},n.updateGuest=function(t){var n=e.defer(),r="/api/guest_details/"+t.userId;return t.check_validation_only&&(r+="?check_validation_only=true"),a.putJSON(r,t.data).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},n.fetchGuestLanguages=function(t){var n=e.defer(),r="/api/guest_languages";return a.getJSON(r,t).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},n.removeGuestDetails=function(t){var n=e.defer(),r="/api/guest_details/"+t+"/anonymize";return a.putJSON(r).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},n.getGuestDetailsById=function(t){var n=e.defer(),r="/api/guest_details/"+t;return null===t?n.reject([""]):a.getJSON(r).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},n.parseGuestData=function(e,t){var a={};return a.id=t,a.firstName=e.first_name,a.lastName=e.last_name,a.image=e.image_url,a.vip=e.vip,e.address&&(a.address={},a.address.city=e.address.city,a.address.state=e.address.state,a.address.postalCode=e.address.postal_code),a.stayCount=e.stay_count,a.lastStay={},a.phone=e.home_phone,a.email=e.email,e.last_stay&&(a.lastStay.date=e.last_stay.date,a.lastStay.room=e.last_stay.room,a.lastStay.roomType=e.last_stay.room_type),a},n.deleteGuest=function(t){var n=e.defer(),r="/api/guest_details/"+t;return a.deleteJSON(r).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},n.checkIfCommisionWasRecalculated=function(t){var n=e.defer(),r="/api/reservations/"+t.reservation_id+"/commission_transaction_info";return a.getJSON(r).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise}}]),angular.module("sntRover").service("RVBillPaymentSrv",["$http","$q","RVBaseWebSrv","rvBaseWebSrvV2",function(e,t,a,n){}]),angular.module("sntRover").service("RVGuestCardSrv",["$http","$q","RVBaseWebSrv",function(e,t,a){this.fetchGuestPaymentData=function(e){var n=t.defer(),r="/staff/payments/payment.json?user_id="+e;return a.getJSON(r).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise}}]),sntRover.controller("rvGroupAllowancesCtrl",["$scope","rvAccountTransactionsSrv","ngDialog",function(e,t,a){BaseCtrl.call(this,e,a),e.keys=Object.keys,e.isActivitiesTabOpen=!0,e.isGroupedByDate=!0,e.shareQuery={query:""},e.shareData=[],e.filteredShareData=[],e.shared=[],e.groupedSharedAllowances={},e.sharedAllowances={},e.errorMessage="",e.successMessage="",e.statusMap={RESERVED:"arrival",PRE_CHECKIN:"pre-check-in",CHECKEDIN:"check-in",CHECKEDOUT:"check-out",NOSHOW:"no-show",CANCELED:"cancel"},e.toggleMode=function(){e.isActivitiesTabOpen=!e.isActivitiesTabOpen,e.isActivitiesTabOpen||e.onQueryUpdate()},e.toggleGrouping=function(){e.isGroupedByDate=!e.isGroupedByDate},e.toggleChecked=function(t,a){var n=_.findIndex(e.shared,function(e){return e.id===t}),r=_.findIndex(e.shared[n].allowances,function(e){return e.id===a});e.shared[n].allowances[r].checked=!e.shared[n].allowances[r].checked},e.closeDialog=function(){a.close()},e.filterShareData=function(){e.filteredShareData=_.filter(e.shareData,function(t){return["CHECKEDIN","RESERVED"].indexOf(t.reservation_status.value)!==-1&&!e.hasAllAllowancesShared(t.id,t.allowances_count)})},e.hasAllAllowancesShared=function(t,a){const n=_.flatten(Array.from(Object.values(e.groupedSharedAllowances))),r=_.filter(n,function(e){return e.item_id===t&&e.checked===!0}).length;return r===a},e.saveSharing=function(){e.errorMessage="";const a={};_.each(e.groupedSharedAllowances,function(t){a[t[0].id]={to_reservation_ids:_.map(_.filter(t,function(t){return e.isChecked(t.item_id,t.id)}),function(e){return e.item_id}),allowance:{id:t[0].id,name:t[0].name,description:t[0].description}}}),e.callAPI(t.saveAllowanceShares,{params:{groupId:e.groupId,type:e.type,data:a},successCallBack:function(t){return t.allowance_data.errors.length?void(e.errorMessage=t.allowance_data.errors.join(". ")):(e.onQueryUpdate(),void(t.allowance_data.success_messages.length&&(e.successMessage=t.allowance_data.success_messages.join(". "))))},failureCallBack:function(t){e.error=t}})},e.onSelect=function(t,a){a&&(a.preventDefault(),a.stopImmediatePropagation(),e.shared=_.filter(e.shared,function(e){return e.id!==t.id})),t.allowances=_.map(t.allowances,function(e){return e.checked=!0,e});var n;e.shared.push(t);try{n=a?_.map(e.shared,function(e){var t=e.allowances;return _.each(t,function(a,n){t[n].id=a.id,t[n].item_id=e.id,t[n].firstname=e.firstname,t[n].lastname=e.lastname,t[n].room=e.room,t[n].reservation_status=e.reservation_status.value}),t}):_.map(e.shared,function(e){var t=_.flatten(_.map(e.shared_allowances,function(e){return e.allowances}));return _.each(t,function(a,n){t[n].id=a.id,t[n].firstname=e.firstname,t[n].lastname=e.lastname,t[n].item_id=e.id,t[n].room=e.room,t[n].reservation_status=e.reservation_status.value,t[n].checked=!0}),t}),e.groupedSharedAllowances=_.groupBy(_.flatten(n),function(e){return e.id})}catch(e){console.error(e)}return e.filterShareData(),!1},e.isChecked=function(t,a){var n=_.findIndex(e.shared,function(e){return e.id===t});if(n===-1)return!1;var r=_.findIndex(e.shared[n].allowances,function(e){return e.id===a});return e.shared[n].allowances[r]&&e.shared[n].allowances[r].checked},e.onQueryUpdate=function(){e.callAPI(t.searchAllowanceShares,{params:{groupId:e.groupId,query:e.shareQuery.query,type:e.type},successCallBack:function(t){e.shared=[],e.shareData=t.allowance_data.results,e.filterShareData(),_.each(t.allowance_data.results,function(t){t.shared_allowances.length>0&&e.onSelect(t)});var a=_.map(t.allowance_data.results,function(e){var t=_.flatten(_.map(e.shared_allowances,function(e){return e.allowances}));return _.each(t,function(a,n){t[n].id=a.id,t[n].firstname=e.firstname,t[n].lastname=e.lastname,t[n].item_id=e.id,t[n].room=e.room,t[n].reservation_status=e.reservation_status.value,t[n].checked=!0}),t});try{e.groupedSharedAllowances=_.groupBy(_.flatten(a),function(e){return e.id}),e.successMessage=""}catch(e){console.error(e)}},failureCallBack:function(){e.groupedAllowanceData=!1,e.sharedData=[],e.shared=[]}})},e.debounceQueryUpdate=_.debounce(e.onQueryUpdate,500),e.onQueryUpdate()}]);