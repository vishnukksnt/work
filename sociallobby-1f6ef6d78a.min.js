sntRover.controller("RVSocialLobbyCtrl",["$scope","$rootScope","$filter","RVSocilaLobbySrv","$timeout","$state","ngDialog",function(e,t,o,s,a,n,r){BaseCtrl.call(this,e),e.posts=[],e.postParams={page:1,per_page:20},e.selectedPost="",e.newPost="",e.middle_page1=2,e.middle_page2=3,e.middle_page3=4,e.$emit("updateRoverLeftMenu","sociallobby"),e.textInQueryBox="",e.showSearchResultsArea=!1,e.searchResultsCount=0,e.isSearchFocussed=!1,e.match_count=0;var i="",l="post-list-scroll",c="",m=function(){var t=angular.element(document.querySelector(".neighbours-post-container"))[0],o=angular.element(document.querySelector(".neighbours-post-scroll"))[0],s=t.children,a=80*s.length+40;_.each(e.posts,function(e){"undefined"!=typeof e.expandedHeight&&""!==e.expandedHeight&&(a+=e.expandedHeight)}),""==c&&(c=o.clientHeight);var n="";n=""!=e.errorMessage&&"undefined"!=typeof e.errorMessage?c-140:c-100,o.style.height=""+n+"px",t.style.height=""+a+"px"},p=function(t){setTimeout(function(){m(),e.refreshScroller(l),t&&e.myScroll.hasOwnProperty(l)&&e.myScroll[l].scrollTo(0,0,100)},500)},d=function(t){for(var o=t;o<e.posts.length;o++)if(e.posts[o].comments.length>0)return e.posts[o];return""};e.$on("socialLobbyHeightUpdated",function(t,o){if(e.posts[o.index].expandedHeight=o.height,o.isSearchResultsView&&o.index<e.posts.length-1){var s=d(o.index+1);""!=s?setTimeout(function(){s.isExpanded=!0,s.isSearchResults=!0,e.$broadcast("SL_SEARCH_UPDATED",{post_id:s.id}),e.$apply()},500):p(!0)}else p()}),e.$on("SL_ERROR",function(t,o){e.errorMessage=o});var u=function(){var t={tap:!0,preventDefault:!1};e.setScroller(l,t)};u(),e.fetchPosts=function(){e.errorMessage="";var t={};t.params=e.postParams,t.onSuccess=function(t){e.posts=t.results.posts,e.totalPostPages=t.results.total_count%e.postParams.per_page>0?Math.floor(t.results.total_count/e.postParams.per_page)+1:Math.floor(t.results.total_count/e.postParams.per_page),e.$emit("hideLoader"),p(!0)},e.callAPI(s.fetchPosts,t)},e.fetchPosts();var g=function(){e.textInQueryBox="",e.showSearchResultsArea=!1,e.searchResultsCount=0,e.isSearchFocussed=!1,e.match_count=0};e.refreshPosts=function(){g(),e.postParams.page=1,e.middle_page1=2,e.middle_page2=3,e.middle_page3=4,e.newPost="",e.fetchPosts()},e.addPost=function(){e.errorMessage="";var t={};t.params={post:{post_message:e.newPost,body_html:"testtt"}},t.onSuccess=function(){e.refreshPosts()},e.callAPI(s.addPost,t)},e.goToStayCard=function(e,t,o){o.stopPropagation(),n.go("rover.reservation.staycard.reservationcard.reservationdetails",{id:e,confirmationId:t,isrefresh:!1})},e.getProfessionStringForUser=function(e){var t="";return null!=e.profession&&""!=e.profession&&(t+=e.profession),""!=e.works_at&&null!=e.works_at&&(t=""!=t?t+", "+e.works_at:e.works_at),t},e.deletePostClicked=function(t){e.errorMessage="",i=t,r.open({template:"/assets/partials/socialLobby/rvSLPostDelete.html",className:"ngdialog-theme-default single-calendar-modal",scope:e,closeByDocument:!0})},e.closeDialog=function(){r.close()},e.delete=function(){e.errorMessage="";var t={};t.params={post_id:i},t.onSuccess=function(){e.refreshPosts(),r.close()},t.failureCallBack=function(t){e.errorMessage=t,r.close()},e.callAPI(s.deletePost,t)},e.paginatePosts=function(t){e.errorMessage="",t!=e.postParams.page&&(e.postParams.page=t,e.textInQueryBox.length>=3?f():e.fetchPosts(),e.postParams.page>e.middle_page3&&e.postParams.page<e.totalPostPages?(e.middle_page3++,e.middle_page2++,e.middle_page1++):e.postParams.page<e.middle_page1&&e.postParams.page>1?(e.middle_page3--,e.middle_page2--,e.middle_page1--):1==e.postParams.page?(e.middle_page3=4,e.middle_page2=3,e.middle_page1=2):e.postParams.page==e.totalPostPages&&e.totalPostPages>5&&(e.middle_page3=e.totalPostPages-1,e.middle_page2=e.totalPostPages-2,e.middle_page1=e.totalPostPages-3))},e.togglePostDetails=function(t){e.errorMessage="",t.isExpanded?t.isSearchResults?(t.isSearchResults=!1,t.isExpanded=!1,t.expandedHeight="",setTimeout(function(){t.isExpanded=!0,e.$apply()},500)):(t.isExpanded=!1,t.expandedHeight="",p()):t.isExpanded=!0},e.$watch(function(){return e.errorMessage},function(){p()});var f=function(){var t={};t.params=e.postParams,t.params.search=e.textInQueryBox,e.errorMessage="",t.onSuccess=function(t){e.posts=t.results.posts,e.match_count=t.results.matched_count;var o=d(0);""!=o&&(o.isExpanded=!0,o.isSearchResults=!0,e.$broadcast("SL_SEARCH_UPDATED",{post_id:o.id})),e.totalPostPages=t.results.total_count%e.postParams.per_page>0?Math.floor(t.results.total_count/e.postParams.per_page)+1:Math.floor(t.results.total_count/e.postParams.per_page),e.$emit("hideLoader")},e.callAPI(s.search,t)};e.queryEntered=function(){return 0===e.textInQueryBox.length?void e.refreshPosts():(e.showSearchResultsArea||(e.showSearchResultsArea=!0,e.postParams.page=1,e.middle_page1=2,e.middle_page2=3,e.middle_page3=4),void(e.textInQueryBox.length>=3&&f()))}}]),sntRover.controller("RVSocialLobbyCommentsCtrl",["$scope","$rootScope","$filter","RVSocilaLobbySrv","$timeout","$state","ngDialog",function(e,t,o,s,a,n,r){BaseCtrl.call(this,e),e.parentPost=e.posts[e.$index],e.comments=[],e.commentParams={page:1,per_page:10,post_id:e.parentPost.id},e.selectedComment="",e.newComment="",e.middle_page1=2,e.middle_page2=3,e.middle_page3=4;var i="",l=!1,c="comment-list-scroll",m=function(){var t=angular.element(document.querySelectorAll(".activity-post"))[e.$index],o=angular.element(t.querySelector(".conversation-wrapper"))[0],s=angular.element(t.querySelector(".neighbours-comment-scroll"))[0],a=angular.element(t.querySelector(".neighbours-comment-container"))[0],n=a.children,r=75*n.length;r=r<200&&r>0?r+20:r,_.each(n,function(e){e.clientHeight>70&&(r+=e.clientHeight-70)});var i;r<300?(i=r,s.style.height=""+r+"px",o.style.height=""+r+"px"):(i=300,s.style.height="300px",o.style.height="300px"),a.style.height=""+r+"px";var c=angular.element(t.querySelector(".post-full"))[0],m=c.clientHeight-20,p=i+60+m,d={};d.index=e.$index,d.height=p,d.isSearchResultsView=l,e.$emit("socialLobbyHeightUpdated",d)},p=function(){setTimeout(function(){m(),e.refreshScroller(c),e.myScroll.hasOwnProperty(c)&&e.myScroll[c].scrollTo(0,0,100),e.$apply()},500)},d=function(){var t={tap:!0,preventDefault:!1};e.setScroller(c,t)};d(),e.fetchComments=function(){var t={};t.params=e.commentParams,e.$emit("SL_ERROR",""),t.onSuccess=function(t){e.comments=t.results.comments,e.totalCommentPages=t.results.total_count%e.commentParams.per_page>0?Math.floor(t.results.total_count/e.commentParams.per_page)+1:Math.floor(t.results.total_count/e.commentParams.per_page),e.$emit("hideLoader"),l=!1,p()},t.failureCallBack=function(t){e.$emit("SL_ERROR",t)},e.callAPI(s.fetchComments,t)};var u=function(){e.comments=e.parentPost.comments,e.totalCommentPages=1,l=!0,p()};0!=e.parentPost.comments.length&&e.parentPost.isSearchResults?(u(),e.$on("ExpandComments",function(t,o){o.post_id==e.parentPost.id&&e.fetchComments()}),e.$on("SL_SEARCH_UPDATED",function(t,o){o.post_id==e.parentPost.id&&u()})):e.fetchComments(),e.refreshComments=function(){e.commentParams.page=1,e.middle_page1=2,e.middle_page2=3,e.middle_page3=4,e.newComment="",e.fetchComments()},e.addComment=function(){e.$emit("SL_ERROR","");var t={};t.params={comment:{comment_title:"",comment_text:e.newComment}},t.params.post_id=e.parentPost.id,t.onSuccess=function(){e.parentPost.comment_count++,e.refreshComments()},t.failureCallBack=function(t){e.$emit("SL_ERROR",t)},e.callAPI(s.addComment,t)},e.deleteCommentClicked=function(t){i=t,r.open({template:"/assets/partials/socialLobby/rvSLPostDelete.html",className:"ngdialog-theme-default single-calendar-modal",scope:e,closeByDocument:!0})},e.delete=function(){e.$emit("SL_ERROR","");var t={};t.params={comment_id:i},t.onSuccess=function(){e.parentPost.comment_count--,e.refreshComments(),r.close()},t.failureCallBack=function(t){e.$emit("SL_ERROR",t),r.close()},e.callAPI(s.deleteComment,t)},e.paginateComments=function(t){e.$emit("SL_ERROR",""),t!=e.commentParams.page&&(e.commentParams.page=t,e.fetchComments(),e.commentParams.page>e.middle_page3&&e.commentParams.page<e.totalCommentPages?(e.middle_page3++,e.middle_page2++,e.middle_page1++):e.commentParams.page<e.middle_page1&&e.commentParams.page>1?(e.middle_page3--,e.middle_page2--,e.middle_page1--):1==e.commentParams.page?(e.middle_page3=4,e.middle_page2=3,e.middle_page1=2):e.commentParams.page==e.totalCommentPages&&e.totalCommentPages>5&&(e.middle_page3=e.totalCommentPages-1,e.middle_page2=e.totalCommentPages-2,e.middle_page1=e.totalCommentPages-3))}}]),angular.module("sntRover").service("RVSocilaLobbySrv",["$http","$q","BaseWebSrvV2","RVBaseWebSrv",function(e,t,o,s){this.fetchPosts=function(e){var s=t.defer(),a="api/social_lobby.json";return o.getJSON(a,e).then(function(e){s.resolve(e)},function(e){s.reject(e)}),s.promise},this.fetchComments=function(e){var s=t.defer(),a="api/social_lobby/"+e.post_id+"/comments.json";return o.getJSON(a,e).then(function(e){s.resolve(e)},function(e){s.reject(e)}),s.promise},this.search=function(e){var s=t.defer(),a="api/social_lobby/search.json";return o.getJSON(a,e).then(function(e){s.resolve(e)},function(e){s.reject(e)}),s.promise},this.addPost=function(e){var s=t.defer(),a="api/social_lobby.json";return o.postJSON(a,e).then(function(e){s.resolve(e)},function(e){s.reject(e)}),s.promise},this.addComment=function(e){var s=t.defer(),a="api/social_lobby/"+e.post_id+"/create_comment.json";return o.postJSON(a,e).then(function(e){s.resolve(e)},function(e){s.reject(e)}),s.promise},this.deletePost=function(e){var s=t.defer(),a="api/social_lobby/"+e.post_id;return o.deleteJSON(a).then(function(e){s.resolve(e)},function(e){s.reject(e)}),s.promise},this.deleteComment=function(e){var s=t.defer(),a="api/social_lobby/"+e.comment_id+"/destory_comment.json";return o.deleteJSON(a).then(function(e){s.resolve(e)},function(e){s.reject(e)}),s.promise}}]),angular.module("iscrollStopPropagation",[]).directive("iscrollStopPropagation",["$window",function(e){return{link:function(e,t,o){t.on("pointermove",function(e){e.stopPropagation()}),t.on("mousedown",function(e){e.stopPropagation()}),e.$on("$destroy",function(e){t.off("mousedown"),t.off("pointermove")})}}}]);