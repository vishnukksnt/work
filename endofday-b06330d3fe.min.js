sntRover.controller("RVEndOfDayModalController",["$scope","ngDialog","$rootScope","$filter","RVEndOfDayModalSrv",function(e,t,s,n,a){BaseCtrl.call(this,e),e.userName="",e.errorMessage="",e.isLoggedIn=!1,e.startProcess=!1,e.startProcessEnabled=!0,e.businessDate=n("date")(s.businessDate,s.dateFormat),e.nextBusinessDate=tzIndependentDate(s.businessDate),e.nextBusinessDate.setDate(e.nextBusinessDate.getDate()+1),e.nextBusinessDate=n("date")(e.nextBusinessDate,s.dateFormat),e.isTimePastMidnight=!0,s.isCurrentUserChangingBussinessDate=!0,e.cancelClicked=function(){s.isCurrentUserChangingBussinessDate=!1,t.close()},e.login=function(){s.$broadcast("showLoader");var t=function(t){s.$broadcast("hideLoader"),e.isLoggedIn=!0,e.isTimePastMidnight="true"!==t.is_show_warning,o()},n=function(t){s.$broadcast("hideLoader"),e.errorMessage=t,o()};e.invokeApi(a.login,{password:e.userPassword},t,n)},e.startEndOfDayProcess=function(){e.startProcess=!0,o()},e.yesClick=function(){e.isTimePastMidnight=!0,o()},e.continueClicked=function(){e.startProcessEnabled=!1,s.$broadcast("showLoader");var n=function(t){s.$broadcast("hideLoader"),e.startProcess=!1,e.errorMessage=t,e.startProcessEnabled=!0,o()},i=function(e){s.$broadcast("hideLoader"),s.isBussinessDateChanging=!0,t.close()};e.invokeApi(a.startProcess,{},i,n)};var o=function(){var t="";t=e.isTimePastMidnight?e.isLoggedIn?e.startProcess?"ALERT_START":"PROMPT_CONFIRMATION":"PROMPT_LOGIN":"NOTIFY_TIME",e.displayMode=t};!function(){o(),e.userPassword=""}()}]),sntRover.controller("RVEndOfDayController",["$scope","ngDialog","$rootScope","$filter","RVEndOfDayModalSrv","$state","rvPermissionSrv",function(e,t,s,n,a,o,i){BaseCtrl.call(this,e);var r=function(){};e.hasPermissionToRunEOD=function(){return i.getPermissionValue("OVERRIDE_BUSINESS_DATE_CHANGE")},e.setHeadingTitle=function(t){e.heading=t,e.setTitle(n("translate")(t))},r()}]),sntRover.controller("RVEndOfDayProcessController",["$scope","ngDialog","$rootScope","$filter","RVEndOfDayModalSrv","$state","$timeout",function(e,t,s,n,a,o,i){BaseCtrl.call(this,e);var r,d=function(){c(),e.eodLogDetails={},e.checkEodStatus=!1,e.dateFormat=s.dateFormat,e.businessDate=s.businessDate,l(),f(),r=s.hotelDetails.is_auto_change_bussiness_date?e.selectedDate:e.businessDate,u(),e.setScroller("eod_scroll"),h()},c=function(){e.setHeadingTitle("End of Day")},u=function(){var t=e.selectedDate.split("-");e.year=t[0],e.month=getMonthName(parseInt(t[1]-1)),e.day=t[2]},l=function(){e.nextBusinessDate=tzIndependentDate(s.businessDate),e.nextBusinessDate.setDate(e.nextBusinessDate.getDate()+1),e.nextBusinessDate=n("date")(e.nextBusinessDate,"yyyy-MM-dd")};e.restartFailedProcess=function(t){var n={id:t.id},o=function(){h()},i=function(e){s.$broadcast("hideLoader")};e.invokeApi(a.restartFailedProcess,n,o,i)};var f=function(){var t=tzIndependentDate(s.businessDate);t.setDate(t.getDate()-1),e.selectedDate=n("date")(t,"dd-MM-yyyy").split("-").reverse().join("-")},D=function(){e.date=e.selectedDate,e.dateOptions={changeYear:!0,changeMonth:!0,dateFormat:"yy-mm-dd",maxDate:r,yearRange:"-100:+0",onSelect:function(s,n){e.selectedDate=s,u(),e.selectedDate!==e.businessDate&&h(),t.close()}}},g=function(){e.refreshScroller("eod_scroll")};e.showError=function(t){e.eodLogDetails[t].isOpened=!e.eodLogDetails[t].isOpened,g()};var h=function(){var t={date:e.selectedDate},n=function(t){e.eodLogDetails=t.eod_processes,e.nextEodRunTime=t.eod_process_time,e.lastEodRunInHours=t.last_eod_run_in_hours,e.lastEodRunInMinutes=t.last_eod_run_in_minutes,s.$broadcast("hideLoader"),i(function(){g()},1e3),!s.isEodRunning&&e.checkEodStatus&&o.go("rover.dashboard.manager")},r=function(){s.$broadcast("hideLoader")};e.invokeApi(a.fetchLog,t,n,r)};e.isLastEodRunWithin18Hr=function(){return null!=e.lastEodRunInMinutes},e.clickedDate=function(){D(),t.open({template:"/assets/partials/endOfDay/rvEodDatepicker.html",className:"single-date-picker",scope:e})},e.getClassForEODButton=function(){return e.isLastEodRunWithin18Hr()?e.isLastEodRunWithin18Hr()&&e.hasPermissionToRunEOD()?"orange":"grey":"green"},e.disableEODButton=function(){return!!e.isLastEodRunWithin18Hr()&&!e.hasPermissionToRunEOD()},e.updateStatus=function(){e.checkEodStatus=!0,h()},e.setSelectedDateToBussinessDate=function(){e.selectedDate=e.businessDate,u()},e.showSetToTodayButton=function(){return!(s.hotelDetails.is_auto_change_bussiness_date&&!e.isSameSelectedAndBussiness())},e.isSameSelectedAndBussiness=function(){return e.selectedDate===e.businessDate},e.getClass=function(e){return"SUCCESS"==e.status?"has-success":"NOT_ACTIVE"==e.status?"pending":"PENDING"==e.status?"":"FAILED"==e.status&&e.isOpened?" error has-arrow toggle active":" error has-arrow toggle "},e.openEndOfDayPopup=function(){t.open({template:"/assets/partials/endOfDay/rvEndOfDayModal.html",controller:"RVEndOfDayModalController",className:"end-of-day-popup ngdialog-theme-plain"})},d()}]),angular.module("sntRover").service("RVEndOfDayModalSrv",["$q","rvBaseWebSrvV2",function(e,t){this.login=function(s){var n=e.defer(),a="/api/end_of_days/authenticate_user";return t.postJSON(a,s).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.startProcess=function(s){var n=e.defer(),a="/api/end_of_days/change_business_date";return t.getJSON(a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.restartFailedProcess=function(s){var n=e.defer(),a="/api/eod_processes/"+s.id+"/re_run";return t.postJSON(a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchLog=function(s){var n=e.defer(),a="/api/eod_processes";return t.getJSON(a,s).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise}}]);