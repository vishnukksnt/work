sntRover.controller("rvGroupAllowancesCtrl",["$scope","rvAccountTransactionsSrv","ngDialog",function(e,t,a){BaseCtrl.call(this,e,a),e.keys=Object.keys,e.isActivitiesTabOpen=!0,e.isGroupedByDate=!0,e.shareQuery={query:""},e.shareData=[],e.filteredShareData=[],e.shared=[],e.groupedSharedAllowances={},e.sharedAllowances={},e.errorMessage="",e.successMessage="",e.statusMap={RESERVED:"arrival",PRE_CHECKIN:"pre-check-in",CHECKEDIN:"check-in",CHECKEDOUT:"check-out",NOSHOW:"no-show",CANCELED:"cancel"},e.toggleMode=function(){e.isActivitiesTabOpen=!e.isActivitiesTabOpen,e.isActivitiesTabOpen||e.onQueryUpdate()},e.toggleGrouping=function(){e.isGroupedByDate=!e.isGroupedByDate},e.toggleChecked=function(t,a){var n=_.findIndex(e.shared,function(e){return e.id===t}),r=_.findIndex(e.shared[n].allowances,function(e){return e.id===a});e.shared[n].allowances[r].checked=!e.shared[n].allowances[r].checked},e.closeDialog=function(){a.close()},e.filterShareData=function(){e.filteredShareData=_.filter(e.shareData,function(t){return["CHECKEDIN","RESERVED"].indexOf(t.reservation_status.value)!==-1&&!e.hasAllAllowancesShared(t.id,t.allowances_count)})},e.hasAllAllowancesShared=function(t,a){const n=_.flatten(Array.from(Object.values(e.groupedSharedAllowances))),r=_.filter(n,function(e){return e.item_id===t&&e.checked===!0}).length;return r===a},e.saveSharing=function(){e.errorMessage="";const a={};_.each(e.groupedSharedAllowances,function(t){a[t[0].id]={to_reservation_ids:_.map(_.filter(t,function(t){return e.isChecked(t.item_id,t.id)}),function(e){return e.item_id}),allowance:{id:t[0].id,name:t[0].name,description:t[0].description}}}),e.callAPI(t.saveAllowanceShares,{params:{groupId:e.groupId,type:e.type,data:a},successCallBack:function(t){return t.allowance_data.errors.length?void(e.errorMessage=t.allowance_data.errors.join(". ")):(e.onQueryUpdate(),void(t.allowance_data.success_messages.length&&(e.successMessage=t.allowance_data.success_messages.join(". "))))},failureCallBack:function(t){e.error=t}})},e.onSelect=function(t,a){a&&(a.preventDefault(),a.stopImmediatePropagation(),e.shared=_.filter(e.shared,function(e){return e.id!==t.id})),t.allowances=_.map(t.allowances,function(e){return e.checked=!0,e});var n;e.shared.push(t);try{n=a?_.map(e.shared,function(e){var t=e.allowances;return _.each(t,function(a,n){t[n].id=a.id,t[n].item_id=e.id,t[n].firstname=e.firstname,t[n].lastname=e.lastname,t[n].room=e.room,t[n].reservation_status=e.reservation_status.value}),t}):_.map(e.shared,function(e){var t=_.flatten(_.map(e.shared_allowances,function(e){return e.allowances}));return _.each(t,function(a,n){t[n].id=a.id,t[n].firstname=e.firstname,t[n].lastname=e.lastname,t[n].item_id=e.id,t[n].room=e.room,t[n].reservation_status=e.reservation_status.value,t[n].checked=!0}),t}),e.groupedSharedAllowances=_.groupBy(_.flatten(n),function(e){return e.id})}catch(e){console.error(e)}return e.filterShareData(),!1},e.isChecked=function(t,a){var n=_.findIndex(e.shared,function(e){return e.id===t});if(n===-1)return!1;var r=_.findIndex(e.shared[n].allowances,function(e){return e.id===a});return e.shared[n].allowances[r]&&e.shared[n].allowances[r].checked},e.onQueryUpdate=function(){e.callAPI(t.searchAllowanceShares,{params:{groupId:e.groupId,query:e.shareQuery.query,type:e.type},successCallBack:function(t){e.shared=[],e.shareData=t.allowance_data.results,e.filterShareData(),_.each(t.allowance_data.results,function(t){t.shared_allowances.length>0&&e.onSelect(t)});var a=_.map(t.allowance_data.results,function(e){var t=_.flatten(_.map(e.shared_allowances,function(e){return e.allowances}));return _.each(t,function(a,n){t[n].id=a.id,t[n].firstname=e.firstname,t[n].lastname=e.lastname,t[n].item_id=e.id,t[n].room=e.room,t[n].reservation_status=e.reservation_status.value,t[n].checked=!0}),t});try{e.groupedSharedAllowances=_.groupBy(_.flatten(a),function(e){return e.id}),e.successMessage=""}catch(e){console.error(e)}},failureCallBack:function(){e.groupedAllowanceData=!1,e.sharedData=[],e.shared=[]}})},e.debounceQueryUpdate=_.debounce(e.onQueryUpdate,500),e.onQueryUpdate()}]),angular.module("sntRover").service("rvAccountTransactionsSrv",["$q","rvBaseWebSrvV2","$rootScope",function(e,t,a){this.fetchGroupAllowances=function(e){const a="/api/groups/"+e.id+"/group_allowance_transactions";return t.getJSON(a,{associated_type:e.type}).then(function(e){var t={dataByAllowance:[],dataByDate:[]};e.allowance_data=_.map(e.allowance_data,function(e){return e.ptime=parseInt(e.time.replace(":",""),10),e});try{e.allowance_data&&e.allowance_data.length&&(t.dataByAllowance=_.groupBy(e.allowance_data,function(e){return e.addon_id}),t.dataByDate=_.groupBy(e.allowance_data,function(e){return e.date}),_.each(t.dataByAllowance,function(e,a){t.dataByAllowance[a]=_.sortBy(e,function(e){return e.ptime})}),_.each(t.dataByDate,function(e,a){t.dataByDate[a]=_.sortBy(e,function(e){return e.ptime})}))}catch(e){console.error(e)}return t},function(){})},this.searchAllowanceShares=function(a){var n=e.defer(),r="/api/groups/"+a.groupId+"/group_allowance_search";return t.getJSON(r,{query:a.query,associated_type:a.type}).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.saveAllowanceShares=function(a){var n=e.defer(),r="/api/groups/"+a.groupId+"/group_allowance_share";return t.postJSON(r,{shared_allowances:a.data,associated_type:a.type}).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchTransactionDetails=function(a){var n=e.defer(),r="/api/posting_accounts/"+a.account_id+"/bill_card";return t.getJSON(r).then(function(e){angular.forEach(e.bills,function(e){e.page_no=1,e.transactions=[],e.activeDate=e.days.length>0?_.last(e.days).date:null}),n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchBillTransactionDetails=function(a){var n=e.defer(),r="/api/bills/"+a.bill_id+"/transactions?date="+a.date+"&page="+a.page+"&per_page="+a.per_page;return t.getJSON(r).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.createAnotherBill=function(a){var n=e.defer(),r="api/bills/create_bill";return t.postJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.moveToAnotherBill=function(a){var n=e.defer(),r="api/bills/transfer_transaction";return t.postJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.transactionEdit=function(a){var n=e.defer(),r=a.id,o=a.updatedDate,i="api/financial_transactions/"+r;return t.putJSON(i,o).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.transactionEditChargeDescription=function(a){var n=e.defer(),r="api/financial_transactions/"+a.id+"/save_custom_description";return t.postJSON(r,a.postData).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.transactionDelete=function(a){var n=e.defer(),r=a.id,o="api/financial_transactions/"+r;return t.putJSON(o,a.data).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.transactionSplit=function(a){var n=e.defer(),r=a.id,o="api/financial_transactions/"+r;return t.putJSON(o,a.data).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.savePaymentDetails=function(a){var n=e.defer(),r="/api/bills/"+a.bill_id+"/add_payment_method";return t.postJSON(r,a.data_to_pass).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.submitPaymentOnBill=function(n){var r=0,o=function(){r++},i=setInterval(o,1e3),s=e.defer(),c="/api/bills/"+n.bill_id+"/submit_payment",l=function(e){if(r>=a.emvTimeout){var n=["Request timed out. Unable to process the transaction"];s.reject(n)}else t.getJSONWithSpecialStatusHandling(e).then(function(t){t.status&&"processing_not_completed"===t.status||"null"===t?setTimeout(function(){console.info("POLLING::-> for emv terminal response"),l(e)},5e3):(clearInterval(i),s.resolve(t))},function(t){"undefined"==typeof t?l(e):(clearInterval(i),s.reject(t))})};return t.postJSONWithSpecialStatusHandling(c,n.data_to_pass).then(function(e){n.data_to_pass.is_emv_request&&e.status&&"processing_not_completed"===e.status?l(e.location_header):(clearInterval(i),s.resolve(e))},function(e){clearInterval(i),s.reject(e)}),s.promise},this.postCharges=function(a){var n=e.defer(),r="/staff/items/post_items_to_bill";return t.postJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.checkForArAccount=function(a){var n=e.defer(),r="/api/posting_accounts/"+a.account_id+"/check_ar_account_attached";return t.getJSON(r).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchAccountBillsForPrint=function(a){var n=e.defer(),r="/api/posting_accounts/print_bill_card";return t.postJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.groupChargeDetailsFetch=function(a){var n=e.defer(),r="/api/posting_accounts/transaction_details";return t.getJSON(r,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise}}]);