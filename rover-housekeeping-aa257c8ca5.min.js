angular.module("sntRover").controller("RVHKGuestTabCtrl",["$scope","$rootScope","$state","$stateParams","RVHkRoomDetailsSrv","$filter","rvPermissionSrv","ngDialog","$timeout",function(e,t,o,r,s,n,a,i,u){BaseCtrl.call(this,e),e.roomDetails=e.$parent.roomDetails;var l=e.$parent.updateRoomDetails,c="room-details-scroller",d=function(){var t={tap:!0,preventDefault:!1,scrollX:!1,scrollY:!0};e.setScroller(c,t)};e.hasCheckOutReservationPermission=function(){return a.getPermissionValue("CHECK_OUT_RESERVATION")},e.checkOutReservation=function(){var t={id:e.roomDetails.reservation_id};e.invokeApi(s.postCheckOutReservation,t,m,h)};var m=function(t){e.message=t.data,e.roomDetails.reservation_is_due_out=!1,e.isSuccess=!0,e.roomDetails.is_occupied="false",e.$emit("hideLoader"),"true"===e.roomDetails.enable_room_status_at_checkout?i.open({template:"/assets/partials/housekeeping/rvCheckoutDialogWithHkStatusPopup.html",scope:e,closeByDocument:!0}):i.open({template:"/assets/partials/housekeeping/rvCheckoutDialogPopup.html",scope:e,closeByDocument:!0})},h=function(t){t&&t.hasOwnProperty("errors")&&(e.message=t.errors[0]),e.isSuccess=!1,e.$emit("hideLoader"),i.open({template:"/assets/partials/housekeeping/rvCheckoutDialogPopup.html",scope:e,closeByDocument:!0})};e.flag={roomStatusReady:!1},e.manualRoomStatusChange=function(){var o,r=function(t){e.$emit("hideLoader"),l("current_hk_status",e.roomDetails.current_hk_status)};if(e.flag.roomStatusReady){var n=a.getPermissionValue("CHANGE_ROOM_STATUS_TO_INSPECTED");if(!n&&t.isStandAlone)return i.close(),void u(function(){i.open({template:"/assets/partials/housekeeping/popups/rvRoomStatusChangeRestrictAlert.html",className:"",closeByDocument:!0,scope:e})},50);o="true"===e.roomDetails.checkin_inspected_only?2:1}else o=3;e.roomDetails.current_hk_status=_.find(e.roomDetails.hk_status_list,{id:o}).value;var c={room_no:e.roomDetails.current_room_no,hkstatus_id:o};e.closeDialog(),e.invokeApi(s.updateHKStatus,c,r)},e.$on("reloadPage",function(t,o){e.roomDetails=o,p()}),e.changeHouseKeepingStatus=function(){var t=function(t){e.$emit("hideLoader"),e.reloadPage()},o=function(t){t&&t.hasOwnProperty("errors")&&(e.message=t.errors[0]),e.$emit("hideLoader")},r={id:e.roomDetails.id};e.invokeApi(s.changeHouseKeepingStatus,r,t,o)};var p=function(){d();var t=e.roomDetails.current_room_reservation_status;switch(t){case"ARRIVED":case"STAYOVER":e.roomDetails.hasDept=!(!e.roomDetails.dept_date&&!e.roomDetails.departure_time),e.roomDetails.departure={date:e.roomDetails.dept_date,time:e.roomDetails.departure_time};break;case"DUE OUT":case"DUE OUT / ARRIVAL":case"DUE OUT / DEPARTED":case"ARRIVED / DAY USE / DUE OUT":case"ARRIVED / DAY USE / DUE OUT / DEPARTED":e.roomDetails.hasDept=!(!e.roomDetails.late_checkout_time&&!e.roomDetails.departure_time),e.roomDetails.departure={time:"true"===e.roomDetails.is_late_checkout?e.roomDetails.late_checkout_time:e.roomDetails.departure_time};break;default:e.roomDetails.hasDept=!1}u(function(){e.refreshScroller(c)},1e3)};p(),e.setProfileImageForAccompanyingGuests=function(e){switch(e){case"ADULT":return"adult";case"CHILDREN":return"student";case"INFANTS":return"infant";default:return""}}}]),angular.module("sntRover").controller("RVHKLogTabCtrl",["$scope","$rootScope","RVHkRoomDetailsSrv","roomDetailsLogData","$filter","$timeout","$stateParams",function(e,t,o,r,s,n,a){BaseCtrl.call(this,e),t.setPrevState={title:s("translate")("ROOM_STATUS"),name:"rover.housekeeping.roomStatus",param:{roomStatus:a.roomStatus}},e.setScroller("LOG_TAB_SCROLL");var i=function(t){e.refreshScroller("LOG_TAB_SCROLL"),t&&e.getScroller("LOG_TAB_SCROLL").scrollTo(0,0)},u=function(){e.pageOptions={id:"ROOM_LOG",perPage:e.perPage,api:h}},l=function(){n(function(){e.$broadcast("updatePagination","ROOM_LOG")},100)},c=function(e){return e.total_count},d=function(){angular.forEach(e.roomLogData,function(e,t){e.front_office_status=_.findWhere(e.details,{key:"fo_status"}),e.room_status=_.findWhere(e.details,{key:"room_status"}),e.service_status=_.findWhere(e.details,{key:"service_status"}),e.service_status&&(e.service_status.old_value=getServiceStatusValue(e.service_status.old_value),e.service_status.new_value=getServiceStatusValue(e.service_status.new_value))})},m=function(){e.perPage=50,e.roomDetails=e.$parent.roomDetails,u(),e.roomLogData=r.results,d(),e.totalResultCount=c(r),i(!1),l()},h=function(t){t=t||1;var s=function(t){e.roomLogData=t.results,d(),e.totalResultCount=c(r),i(!0),l()},n={id:e.roomDetails.id,page:t,per_page:e.perPage},a={onSuccess:s,params:n};e.callAPI(o.getRoomLog,a)};e.getRoomStatusClass=function(e){return"DO NOT DISTURB"===e?"dnd":e.toLowerCase()},m();var p=e.$on("OPEN_LOG",function(){u(),h()});e.$on("$destroy",p)}]),angular.module("sntRover").controller("RVHKRoomTabCtrl",["$scope","$rootScope","$state","$stateParams","$filter","RVHkRoomDetailsSrv","ngDialog","rvUtilSrv","$timeout","rvPermissionSrv",function(e,t,o,r,s,n,a,i,u,l){BaseCtrl.call(this,e);var c=15,d=12,m=e.roomDetails.room_reservation_hk_status,h=1;e.setClass=function(t){return[!0,e.serviceStatus[s("date")(tzIndependentDate(t),"yyyy-MM-dd")]&&e.serviceStatus[s("date")(tzIndependentDate(t),"yyyy-MM-dd")].id>1?"room-out":""]};var p=function(t){e.showSaved=!0,e.$emit("hideLoader"),e.refreshScroller("room-tab-scroll"),angular.extend(e.serviceStatus,t.service_status),e.onViewDateChanged(e.serviceStatus)},f=function(){function t(t){e.allServiceStatus=t,e.invokeApi(n.getRoomServiceStatus,{room_id:e.roomDetails.id,from_date:e.updateService.selected_date},p),e.refreshScroller("room-tab-scroll"),e.$emit("hideLoader")}e.invokeApi(n.fetchAllServiceStatus,{},t)},v=function(){function t(t){e.$emit("hideLoader"),e.maintenanceReasonsList=t,e.refreshScroller("room-tab-scroll")}e.invokeApi(n.fetchMaintenanceReasons,{},t)};e.$watch("updateService.room_service_status_id",function(t,o){t!==o&&(e.prev_room_service_status_id=o)}),e.statusChange=function(){e.updateService.selected_date=s("date")(tzIndependentDate(e.updateService.selected_date),"yyyy-MM-dd");var o=_.find(e.allServiceStatus,function(t){return t.id===e.updateService.room_service_status_id});if(e.ooOsTitle=o.description,e.inService=e.updateService.room_service_status_id===h,e.showInseviceOnLoad=!1,m!==e.updateService.room_service_status_id){var r=tzIndependentDate(t.businessDate).toDateString(),a=tzIndependentDate(e.updateService.selected_date).toDateString();r===a&&(e.roomDetails.room_reservation_hk_status=e.updateService.room_service_status_id),e.showSaved=!1,e.updateStatus={from_date:s("date")(tzIndependentDate(t.businessDate),"yyyy-MM-dd"),to_date:s("date")(tzIndependentDate(t.businessDate),"yyyy-MM-dd"),reason_id:"",comment:"",return_status_id:""}}else e.invokeApi(n.getRoomServiceStatus,{room_id:e.roomDetails.id,from_date:e.updateService.selected_date,to_date:e.updateService.selected_date},p);e.$$phase||e.$apply(),e.refreshScroller("room-tab-scroll")},e.closeDialog=function(){a.close()};var S={dateFormat:t.jqDateFormat,numberOfMonths:1,changeYear:!0,changeMonth:!0,beforeShow:function(e,t){$("#ui-datepicker-div").addClass("reservation hide-arrow"),$('<div id="ui-datepicker-overlay">').insertAfter("#ui-datepicker-div"),setTimeout(function(){$("body").find("#ui-datepicker-overlay").on("click",function(){$("#room-out-from").blur(),$("#room-out-to").blur()})},100)},onClose:function(e){$("#ui-datepicker-div").removeClass("reservation hide-arrow"),$("#ui-datepicker-overlay").off("click").remove()}},g=function(){tzIndependentDate(e.updateService.from_date)>tzIndependentDate(e.updateService.to_date)&&(e.updateService.to_date=s("date")(tzIndependentDate(e.updateService.from_date),"yyyy-MM-dd")),e.untilDateOptions.minDate=s("date")(tzIndependentDate(e.updateService.from_date),t.dateFormat)};e.fromDateOptions=angular.extend({minDate:s("date")(t.businessDate,t.dateFormat),onSelect:g,beforeShowDay:e.setClass,onChangeMonthYear:function(t,o,r){e.updateCalendar(t,o,r)}},S),e.untilDateOptions=angular.extend({minDate:s("date")(t.businessDate,t.dateFormat),onSelect:g,beforeShowDay:e.setClass,onChangeMonthYear:function(t,o,r){e.updateCalendar(t,o,r)}},S),e.selectDateOptions=angular.extend({minDate:s("date")(t.businessDate,t.dateFormat),onSelect:function(t,o){e.serviceStatus[s("date")(new Date(t),"yyyy-MM-dd")]&&(e.updateService.room_service_status_id=e.serviceStatus[s("date")(new Date(t),"yyyy-MM-dd")].id),f(),u(function(){$(".room-actions").click()},300)},beforeShowDay:e.setClass,onChangeMonthYear:function(t,o,r){e.updateCalendar(t,o,r)}},S),e.shouldShowTimeSelector=function(){return(t.isHourlyRateOn||"FULL"===t.hotelDiaryConfig.mode)&&!e.inService};var k=function(e){return s("date")(new tzIndependentDate(e),t.dateFormatForAPI)},y=function(){a.open({template:"/assets/partials/housekeeping/popups/roomTab/rvRoomTabWebInProgressPopup.html",className:"",scope:e,closeByDocument:!1,closeByEscape:!1})},D=function(t){var o={reservations:t};e.setScroller("reservation-list-scroller",{tap:!0,preventDefault:!1}),a.open({template:"/assets/partials/housekeeping/popups/roomTab/rvRoomTabReservationExist.html",className:"",scope:e,data:JSON.stringify(o),closeByDocument:!1,closeByEscape:!1})},w=function(t){var o=t.is_locked_room,r=t.is_room_already_assigned;o?y():r?D(t.reservations):e.update()},R=function(t){e.errorMessage=t};e.checkWhetherRoomStatusChangePossible=function(){var o={from_date:k(e.updateService.from_date),to_date:k(e.updateService.to_date),room_id:e.roomDetails.id};(t.isHourlyRateOn||"FULL"===t.hotelDiaryConfig.mode)&&(o.begin_time=e.updateService.begin_time,o.end_time=e.updateService.end_time);var r={params:o,successCallBack:w,failureCallBack:R};e.callAPI(n.checkWhetherRoomStatusChangePossible,r)},e.forcefullyPutRoomToOOSorOOO=function(){e.closeDialog(),u(function(){e.update()},700)},e.update=function(){var o=function(t){e.$emit("hideLoader"),e.errorMessage=t,e.updateService.room_service_status_id=e.prev_room_service_status_id,e.statusChange(),e.$parent.myScroll["room-tab-scroll"]&&e.$parent.myScroll["room-tab-scroll"].scrollTo&&e.$parent.myScroll["room-tab-scroll"].scrollTo(0,0),e.refreshScroller("room-tab-scroll")},r=function(){e.$emit("hideLoader"),e.errorMessage="",m=e.updateService.room_service_status_id,e.showSaved=!0,e.updateStatus={room_id:e.roomDetails.id,from_date:s("date")(tzIndependentDate(t.businessDate),"yyyy-MM-dd"),to_date:s("date")(tzIndependentDate(t.businessDate),"yyyy-MM-dd")},e.updateCalendar(),e.$emit("REFRESH_ROOM_STATUS")};e.updateService.from_date=s("date")(tzIndependentDate(e.updateService.from_date),"yyyy-MM-dd"),e.updateService.to_date=s("date")(tzIndependentDate(e.updateService.to_date),"yyyy-MM-dd"),e.showInseviceOnLoad=!1,m!==h&&e.inService?e.invokeApi(n.putRoomServiceStatus,e.updateService,r,o):e.invokeApi(n.postRoomServiceStatus,e.updateService,r,o)},e.edit=function(){e.showSaved?e.showSaved=!1:1!==e.updateService.room_service_status_id?e.checkWhetherRoomStatusChangePossible():e.update()},e.generateButtonName=function(){return e.showSaved?"Edit":"Update"},e.updateCalendar=function(o,r,s){function a(o){angular.extend(e.serviceStatus,o.service_status);var r=e.updateService.room_service_status_id>1,n=e.serviceStatus[k(e.updateService.selected_date)],a=t.isHourlyRateOn;r&&a&&(e.updateService.begin_time=n.from_time,e.updateService.end_time=n.to_time),!angular.isUndefined(s)&&s.id?$("#"+s.id).datepicker("refresh"):$(".ngmodal-uidate-wrap").datepicker("refresh"),e.$emit("hideLoader")}function i(){e.$emit("hideLoader")}e.invokeApi(n.fetchRoomStatus,{year:o||tzIndependentDate(e.updateService.selected_date).getFullYear(),month:r||tzIndependentDate(e.updateService.selected_date).getMonth(),room_id:e.roomDetails.id},a,i)},e.$watch("updateService.selected_date",function(){e.refreshScroller("room-tab-scroll")});var T=function(t){for(var o=864e5;t[s("date")(tzIndependentDate(e.updateService.from_date).getTime()-o,"yyyy-MM-dd")];){var r=s("date")(tzIndependentDate(e.updateService.from_date).getTime()-o,"yyyy-MM-dd"),n=t[r];if(n.id!==e.updateService.room_service_status_id||n.reason_id!==e.updateService.reason_id||n.comments!==e.updateService.comment)break;e.updateService.from_date=r}for(;t[s("date")(tzIndependentDate(e.updateService.to_date).getTime()+o,"yyyy-MM-dd")];){var a=s("date")(tzIndependentDate(e.updateService.to_date).getTime()+o,"yyyy-MM-dd"),i=t[a];if(i.id!==e.updateService.room_service_status_id||i.reason_id!==e.updateService.reason_id||i.comments!==e.updateService.comment)break;e.updateService.to_date=a}};e.onViewDateChanged=function(t){e.updateService.selected_date=s("date")(tzIndependentDate(e.updateService.selected_date),"yyyy-MM-dd"),e.updateService.room_service_status_id=t[e.updateService.selected_date].id,m=e.updateService.room_service_status_id,e.updateService.from_date=e.updateService.selected_date,e.updateService.to_date=e.updateService.selected_date,e.inService=e.updateService.room_service_status_id===h;var o=_.find(e.allServiceStatus,function(t){return t.id===e.updateService.room_service_status_id});e.ooOsTitle=o.description,e.updateService.reason_id=t[e.updateService.selected_date].maintenance_reason_id,e.updateService.comment=t[e.updateService.selected_date].comments,e.updateService.return_status_id=t[e.updateService.selected_date].return_status_id,e.updateService.room_service_status_id!==h&&T(t)};var O=function(){e.setScroller("room-tab-scroll"),e.roomDetails=e.$parent.roomDetails,e.showInseviceOnLoad=!0,e.inService=!0,e.showSaved=!1,e.allServiceStatus=[],e.maintenanceReasonsList=[],e.returnStatusList=_.reject(e.roomDetails.hk_status_list,function(e){return"DO_NOT_DISTURB"===e.value}),e.hasPermissionPutRoomOOS=l.getPermissionValue("PUT_ROOM_OOO_OR_OOS"),e.updateService={room_id:e.roomDetails.id,from_date:s("date")(tzIndependentDate(t.businessDate),"yyyy-MM-dd"),to_date:s("date")(tzIndependentDate(t.businessDate),"yyyy-MM-dd"),selected_date:s("date")(tzIndependentDate(t.businessDate),"yyyy-MM-dd"),room_service_status_id:m,begin_time:"",end_time:""},e.serviceStatus={},e.timeSelectorList=i.getListForTimeSelector(c,d),e.timeSelectorList.push({text:"11:59 PM",value:"23:59"}),f(),v()};O(),e.$on("reloadPage",function(t,o){e.roomDetails=o})}]),angular.module("sntRover").controller("RVHKWorkTabCtrl",["$scope","$rootScope","$state","$stateParams","RVHkRoomDetailsSrv","RVHkRoomStatusSrv","$filter","$timeout","rvPermissionSrv","ngDialog","rvUtilSrv",function(e,t,o,r,s,n,a,i,u,l,c){BaseCtrl.call(this,e),e.isStandAlone=t.isStandAlone,e.setScroller("room-status-content"),i(function(){e.refreshScroller("room-status-content")},1500),e.isTaskPresent=function(){return 0!=e.roomDetails.task_details.length};var d=e.$parent.updateRoomDetails,m="FULL"===c.getDiaryMode();e.roomDetails=e.$parent.roomDetails,t.isStandAlone&&!m&&"true"===e.roomDetails.is_occupied||(e.roomDetails.hk_status_list=_.filter(e.roomDetails.hk_status_list,function(e){return"DO_NOT_DISTURB"!==e.value})),e.taskDetails=e.roomDetails.task_details,e.isTaskPresent()&&(e.currentTask=e.taskDetails[0],e.currentTaskID=e.currentTask.id);var h=e.roomDetails.current_hk_status,p={open:"OPEN",inProgress:"IN_PROGRESS",completed:"COMPLETED"};e.isStarted=!1,e.isCompleted=!1,e.isOpen=!1,e.disableDone=!1,e.disableStart=!1;var f={INSPECTED:"INSPECTED"},v=function(){e.isStarted=e.currentTask.work_status===p.inProgress,e.isCompleted=e.currentTask.work_status===p.completed,e.isOpen=e.currentTask.work_status===p.open,e.currentTask.assigned_maid_id!==t.userId?(e.disableDone=!0,e.disableStart=!0):(e.disableDone=!1,e.disableStart=!1)};e.taskDetails.length&&e.isStandAlone&&v();var S=function(e,t){if(t)return!1;var o=!1,r=!1,s="Out Of Service",n="Out Of Order";return e.hasOwnProperty("service_status")?(o="OUT_OF_ORDER"===e.service_status.value,r="OUT_OF_SERVICE"===e.service_status.value):e.hk_status?(o="OO"===e.hk_status.value,r="OS"===e.hk_status.value):(o=3===e.room_reservation_hk_status,r=2===e.room_reservation_hk_status),r?s:!!o&&n};e.ooOsTitle=S(e.roomDetails,e.isStandAlone),e.checkShow=function(t){return"clean"===t&&("CLEAN"===e.roomDetails.current_hk_status||"INSPECTED"===e.roomDetails.current_hk_status)||("dirty"===t&&"DIRTY"===e.roomDetails.current_hk_status||("pickup"===t&&"PICKUP"===e.roomDetails.current_hk_status||"dnd"===t&&"DO_NOT_DISTURB"===e.roomDetails.current_hk_status))},e.manualRoomStatusChanged=function(){var o=function(t){e.$emit("hideLoader"),e.refreshScroller("room-status-content"),d("current_hk_status",e.roomDetails.current_hk_status)};if(e.roomDetails.current_hk_status===f.INSPECTED){var r=u.getPermissionValue("CHANGE_ROOM_STATUS_TO_INSPECTED");if(!r&&t.isStandAlone)return i(function(){l.open({template:"/assets/partials/housekeeping/popups/rvRoomStatusChangeRestrictAlert.html",className:"",closeByDocument:!0,scope:e})},50),void(e.roomDetails.current_hk_status=h)}h=e.roomDetails.current_hk_status;var n=_.find(e.roomDetails.hk_status_list,function(t){return t.value===e.roomDetails.current_hk_status}),a={room_no:e.roomDetails.current_room_no,hkstatus_id:n.id};e.invokeApi(s.updateHKStatus,a,o)},e.changedTask=function(t){e.currentTask=_.find(e.taskDetails,function(e){return e.id===t}),v(),g()};var g=function(){e.$$phase||e.$digest()};e.startWorking=function(){var t=function(){e.$emit("hideLoader"),e.refreshScroller("room-status-content"),e.currentTask.work_status=p.inProgress,v()},o={room_id:e.roomDetails.id,work_sheet_id:e.currentTask.work_sheet_id,task_id:e.currentTask.id};e.invokeApi(s.postRecordTime,o,t)},e.doneWorking=function(){var t=function(){e.$emit("hideLoader"),e.refreshScroller("room-status-content"),e.currentTask.work_status=p.completed,v(),e.currentTask.task_completion_status&&(e.roomDetails.current_hk_status=e.currentTask.task_completion_status)},o={room_id:e.roomDetails.id,work_sheet_id:e.currentTask.work_sheet_id,task_completion_status:e.currentTask.task_completion_status_id,task_id:e.currentTask.id};e.invokeApi(s.postRecordTime,o,t)},e.$on("reloadPage",function(t,o){e.roomDetails=o})}]),angular.module("sntRover").controller("RVHkAppCtrl",["$rootScope","$scope","$state","ngDialog",function(e,t,o,r){BaseCtrl.call(this,t),t.setTitle("Housekeeping"),t.topFilter={byEmployee:-1},e.$on("$stateChangeStart",function(e,o,r,s,n){t.$emit("showLoader")}),e.$on("$stateChangeSuccess",function(e,o,r){t.$emit("hideLoader")}),e.$on("$stateChangeError",function(e,o,r,s,n,a){t.$emit("hideLoader")}),t.$on("filterRoomsClicked",function(){t.filterOpen=!t.filterOpen}),t.$on("showLoader",function(){t.hasLoader=!0}),t.$on("hideLoader",function(){t.hasLoader=!1}),t.isRoomFilterOpen=function(){return t.filterOpen},t.$on("dismissFilterScreen",function(){t.filterOpen=!1}),t.$on("showFilterScreen",function(){t.filterOpen=!0})}]),angular.module("sntRover").controller("RVHkRoomDetailsCtrl",["$scope","$rootScope","$state","$stateParams","RVHkRoomDetailsSrv","RVHkRoomStatusSrv","roomDetailsData","$filter","$timeout",function(e,t,o,r,s,n,a,i,u){BaseCtrl.call(this,e),t.setPrevState={title:i("translate")("ROOM_STATUS"),name:"rover.housekeeping.roomStatus",param:{page:r.page,roomStatus:r.roomStatus}},e.setTitle(i("translate")("ROOM_DETAILS")),e.heading=i("translate")("ROOM_DETAILS"),e.$emit("updateRoverLeftMenu","roomStatus"),e.updateHKStatus=function(){e.$emit("showLoader"),s.updateHKStatus(e.data.room_details.current_room_no,e.currentHKStatus.id).then(function(t){e.$emit("hideLoader"),e.data.room_details.current_hk_status=e.currentHKStatus.value,e.calculateColorCodes(),n.updateHKStatus(e.data.room_details)},function(){e.$emit("hideLoader")})};var l=document.getElementById("#room-details");angular.element(l).bind("ontouchmove",function(e){e.stopPropagation()}),e.roomDetails=a,e.getHeaderColor=function(){return 1!==e.roomDetails.room_reservation_hk_status?"out":"CLEAN"===e.roomDetails.current_hk_status?"clean":"DIRTY"===e.roomDetails.current_hk_status?"dirty":"PICKUP"===e.roomDetails.current_hk_status?"pickup":"INSPECTED"===e.roomDetails.current_hk_status?"inspected":"DO_NOT_DISTURB"===e.roomDetails.current_hk_status?"dnd":void 0};var c=function(){return 0!=a.task_details.length};!t.isStandAlone||t.isStandAlone&&(t.isMaintenanceStaff||t.isMaintenanceManager)||t.isStandAlone&&c()?e.openTab="Work":e.openTab="Guest";var d=function(e,t){var o="";return"true"===t?"late-check-out":("RESERVED"===e?o="arrival":"CHECKING_IN"===e?o="check-in":"CHECKEDIN"===e?o="inhouse":"CHECKEDOUT"===e?o="departed":"CHECKING_OUT"===e?o="check-out":"CANCELED"===e?o="cancel":"NOSHOW"!==e&&"NOSHOW_CURRENT"!==e||(o="no-show"),o)};e.tabSwitch=function(t){t&&(e.openTab=t)},e.showLogTab=function(){e.openTab="Log",e.$broadcast("OPEN_LOG"),o.go("rover.housekeeping.roomDetails.log",{id:e.roomDetails.id,roomStatus:r.roomStatus})},e.updateRoomDetails=function(t,o){if(e.roomDetails.hasOwnProperty(t)&&(e.roomDetails[t]=o,e.getHeaderColor()),"room_reservation_hk_status"===t)n.setRoomStatus(e.roomDetails.id,t,o);else if("current_hk_status"===t){var r=_.find(e.roomDetails.hk_status_list,function(e){return e.value===o});n.setWorkStatus(e.roomDetails.id,r)}};var m=function(t){e.$emit("hideLoader"),e.$broadcast("reloadPage",t),p(t)},h=function(t){e.$emit("hideLoader"),e.errorMessage=t};e.reloadPage=function(){e.invokeApi(s.fetch,e.roomDetails.id,m,h)};var p=function(t){e.roomDetails=t,e.guestViewStatus=d(t.reservation_status,e.roomDetails.is_late_checkout)},f=function(){e.callAPI(s.fetch,{params:r.id,onSuccess:function(t){e.roomDetails=t}})};e.addListener("REFRESH_ROOM_STATUS",function(){f()});var v=t.$on("LANGUAGE_CHANGED",function(){u(function(){t.setPrevState.title=i("translate")("ROOM_STATUS"),e.setTitle(i("translate")("ROOM_DETAILS")),e.heading=i("translate")("ROOM_DETAILS")},100)});e.$on("$destroy",v),p(a)}]),angular.module("sntRover").controller("RVHkRoomStatusCtrl",["$scope","$rootScope","$timeout","$state","$filter","$window","RVHkRoomStatusSrv","fetchPayload","employees","roomTypes","floors","hkStatusList","ngDialog","RVWorkManagementSrv","RVHkRoomDetailsSrv","rvUtilSrv","rvPermissionSrv","$stateParams",function(e,t,o,r,s,n,a,i,u,l,c,d,m,h,p,f,v,S){function g(){e.$emit("hideLoader"),$("head").append("<style id='print-orientation'>@page { size: landscape; }</style>");var t=function(){o(function(){$("#print-orientation").remove(),I=e.returnToPage,T("page",I),T("perPage",n.innerWidth<599?25:50),R()},150)};o(function(){sntapp.cordovaLoaded?cordova.exec(t,function(){t()},"RVCardPlugin","printWebView",["hkstatus","0","","L"]):(n.print(),t())},100)}function k(r,s){if(C=_.size(r)?angular.copy(r):{},e.topFilter.byWorkType="",e.topFilter.byEmployee="",e.rooms=[],e.summary=C.summary,e.netTotalCount=C.total_count,e.uiTotalCount=C&&C.rooms?C.rooms.length:0,e.allRoomIDs=C.hasOwnProperty("all_room_ids")?C.all_room_ids:[],1===I?(e.resultFrom=1,e.resultUpto=e.netTotalCount<L?e.netTotalCount:L,e.disablePrevBtn=!0,e.disableNextBtn=!(e.netTotalCount>L)):(e.resultFrom=L*(I-1)+1,e.resultUpto=e.resultFrom+L-1<e.netTotalCount?e.resultFrom+L-1:e.netTotalCount,e.disablePrevBtn=!1,e.disableNextBtn=e.resultUpto===e.netTotalCount),e.showPickup=C.use_pickup||!1,e.showInspected=C.use_inspected||!1,e.showQueued=C.is_queue_rooms_on||!1,t.isStandAlone){e.workTypes.length||(e.workTypes=i.workTypes),e.employees.length||(e.employees=u);var n=function(){E=e.currentFilters.filterByWorkType,M=e.currentFilters.filterByEmployeeName,s?(e.hasActiveWorkSheet=e.employees&&e.employees.room_tasks&&e.employees.room_tasks.length||!1,e.topFilter.byWorkType=E,e.topFilter.byEmployee=M,o(function(){D()},10)):y(s)};e.workTypes&&e.workTypes.length&&e.employees&&e.employees.length?n():e.invokeApi(a.fetchWorkTypes,{},function(t){var o={per_page:9999};e.workTypes=t,e.invokeApi(a.fetchHKEmps,o,function(t){e.employees=t,n()})})}else o(function(){D()},10);T("page",I),o(function(){e.$broadcast("updatePagination","HK_SEARCH"),e.$broadcast("updatePageNo",I)},700)}function y(r){e.currentFilters.filterByEmployeeName&&(M=e.currentFilters.filterByEmployeeName);var s={date:t.businessDate,employee_ids:[M||t.userId]},n=function(t){var r=t.employees.length&&t.employees[0]||null;e.hasActiveWorkSheet=r&&r.room_tasks&&r.room_tasks.length||!1,e.topFilter.byWorkType=E,e.topFilter.byEmployee=M,o(function(){D()},10)},i=function(){e.topFilter.byWorkType="",e.topFilter.byEmployee="",e.hasActiveWorkSheet=!1,e.currentView="rooms",o(function(){D()},10)};e.invokeApi(a.fetchWorkAssignments,s,n,i)}function D(){var t=C.rooms,o=0,r=0;for(o=0,r=t.length;o<r;o++)e.rooms.push(t[o]);C={},w(localStorage.getItem("roomListScrollTopPos")),e.$emit("hideLoader")}function w(e){if(N.scrollTop!==e){if(isNaN(parseInt(e)))var e=0;else localStorage.removeItem("roomListScrollTopPos");o(function(){N.scrollTop=e},10)}}function R(t){var o=t||1;I=o,T("page",o),e.hasActiveWorkSheet=!1,e.rooms=[],e.resetMultiRoomAction(),e.invokeApi(a.fetchRoomListPost,{},k)}function T(t,o){e.currentFilters[t]=o,a.currentFilters=angular.copy(e.currentFilters)}function O(){I=b,T("page",b)}BaseCtrl.call(this,e),t.setPrevState={title:s("translate")("DASHBOARD"),name:"rover.dashboard"};var A=t.isMaintenanceStaff?"MY_WORKSHEET":"ROOM_STATUS";A=s("translate")(A),e.setTitle(A),e.heading=A,e.$emit("updateRoverLeftMenu","roomStatus"),e.totalRoomsSelectedForUpdate=0,e.setScroller("room-status-filter"),e.setScroller("room-service-status-update"),e.setScroller("rooms-list-to-forcefully-update"),setTimeout(function(){e.refreshScroller("room-status-filter"),e.refreshScroller("rooms-list-to-forcefully-update")},1500),a.currentFilters.page<1&&(a.currentFilters.page=1),e.currentFilters=angular.copy(a.currentFilters);var C={},E="",M="",I=e.currentFilters.page,L=e.currentFilters.perPage,b=1,N=(n.innerWidth<599?25:50,document.getElementById("rooms")),P=document.getElementById("filter-rooms"),F="",x=angular.copy(a.currentFilters),U=angular.copy(l),W=!1;e.resultFrom=I,e.resultUpto=L,e.netTotalCount=0,e.uiTotalCount=0,e.disablePrevBtn=!0,e.disableNextBtn=!0,e.filterOpen=!1,e.query=e.currentFilters.query,e.noResultsFound=0,e.isStandAlone=t.isStandAlone,e.isMaintenanceStaff=t.isMaintenanceStaff,e.isMaintenanceManager=t.isMaintenanceManager,e.hasActiveWorkSheet=!1,e.roomTypes=l,e.floors=c,e.workTypes=[],e.employees=[],e.assignRoom={},e.isRoomStatusUpdate=!0,e.isServiceStatusUpdate=!1,e.updateServiceData={},a.defaultViewState?e.currentView=a.defaultViewState:e.currentView=e.isMaintenanceStaff?"TASKS":"ROOMS";var V={INSPECTED:"INSPECTED"};e.changeView=function(t){e.currentView=t,a.defaultViewState=t};var H=0,B=function(e,t){var o;return function(){H+=1,o&&clearTimeout(o),o=setTimeout(t,e)}},j=B(500,function(){H=0});angular.element(document.querySelector("#rooms")).bind("scroll",j),e.toggleView=function(){"ROOMS"===e.currentView?e.currentView="TASKS":e.currentView="ROOMS",a.defaultViewState=e.currentView,o(function(){e.refreshScroller("tasks-summary-scroller")},2e3)},e.multiRoomAction={rooms:[],indexes:{},anyChosen:!1,allChosen:!1,hkStatusId:""},e.hkStatusList=d,e.hkStatusList=_.filter(e.hkStatusList,function(e){return"DO_NOT_DISTURB"!==e.value}),e.allRoomIDs=i.roomList.all_room_ids,e.hkSearchPagination={id:"HK_SEARCH",api:R,perPage:e.currentFilters.perPage},k(i.roomList,!0),e.loadNextPage=function(t){e.disableNextBtn||(I++,T("page",I),R(I))},e.loadPrevPage=function(t){e.disablePrevBtn||(I--,T("page",I),R(I))},e.roomListItemClicked=function(e){o(function(){0===H&&(localStorage.setItem("roomListScrollTopPos",N.scrollTop),r.go("rover.housekeeping.roomDetails",{id:e.id,page:I,roomStatus:S.roomStatus}))},400)},e.showFilters=function(){e.filterOpen=!0,setTimeout(function(){e.refreshScroller("room-status-filter")},1500)},e.refreshData=function(){R()},e.filterDoneButtonPressed=function(){var t=!1,r=!1,s=function(){e.filterOpen=!1,e.$emit("showLoader"),O(),a.currentFilters=angular.copy(e.currentFilters),x=angular.copy(e.currentFilters),a.roomTypes=angular.copy(e.roomTypes),U=angular.copy(e.roomTypes),o(function(){R()},100)};for(key in e.currentFilters)if(e.currentFilters.hasOwnProperty(key)){if("page"===key)continue;if(e.currentFilters[key]!==x[key]){t=!0;break}}if(e.roomTypes.length)for(var n=0,i=e.roomTypes.length;n<i;n++)if(e.roomTypes[n].isSelected!==U[n].isSelected){r=!0;break}t||r?o(s,100):e.filterOpen=!1};var z=function(r){var s=function(){T("query",e.query),O(),o(function(){R(),F=e.query},10)};t.isSingleDigitSearch?(r||e.query!==F)&&s():(r||e.query.length<=2&&e.query.length<F.length||e.query.length>2&&e.query!==F)&&s()};e.filterByQuery=_.throttle(z,1e3,{leading:!1}),e.clearSearch=function(){e.query="",z("forced")},e.isFilterChcked=function(){var t,o;for(t in e.currentFilters){if("showAllFloors"!==t&&e.currentFilters[t]){o=!0;break}o=!1}return o},e.clearFilters=function(){console.log("clearFilters autocalled"),e.roomTypes=a.resetRoomTypes(),e.currentFilters=a.initFilters(),e.isStandAlone&&(e.currentFilters.filterByWorkType="",e.currentFilters.filterByEmployeeName=""),a.currentFilters=angular.copy(e.currentFilters),w()},e.validateFloorSelection=function(t){"SINGLE_FLOOR"===t&&(e.currentFilters.floorFilterStart="",e.currentFilters.floorFilterEnd=""),"FROM_FLOOR"!==t&&"TO_FLOOR"!==t||(e.currentFilters.floorFilterSingle="")},e.allFloorsClicked=function(){e.currentFilters.showAllFloors=!e.currentFilters.showAllFloors,e.currentFilters.floorFilterStart="",e.currentFilters.floorFilterEnd="",e.currentFilters.floorFilterSingle=""},e.closeDialog=function(){e.errorMessage="",m.close()};e.singleRoomTypeFiltered=function(){_.each(e.roomTypes,function(t){t.id&&t.id.toString()===e.currentFilters.singleRoomType?t.isSelected=!0:t.isSelected=!1})},e.printData=function(){function t(e){k(e),W=!0}e.returnToPage=I,T("page",1),T("perPage",1e3),e.invokeApi(a.fetchRoomListPost,{},t)};var J=e.$on("ALL_RENDERED",function(){W&&(g(),W=!1)});e.$on("$destroy",J),e.roomSelectChange=function(t,o){var r=t.selected,s=o+"";if(r)e.multiRoomAction.anyChosen=!0,e.multiRoomAction.indexes.hasOwnProperty(s)||(e.multiRoomAction.rooms.push(e.rooms[o].id),e.multiRoomAction.indexes[s]=o);else{if(_.has(e.multiRoomAction.indexes,s)){var n=_.indexOf(e.multiRoomAction.rooms,e.rooms[o].id);e.multiRoomAction.rooms.splice(n,1),e.multiRoomAction.indexes[s]=void 0,delete e.multiRoomAction.indexes[s],e.multiRoomAction.allChosen=!1}e.multiRoomAction.rooms.length||(e.multiRoomAction.anyChosen=!1)}},e.toggleRoomSelection=function(){var t,o,r,s,n;if(t=!!e.multiRoomAction.allChosen,e.multiRoomAction.anyChosen&&(t=!1),e.multiRoomAction.anyChosen=t,e.multiRoomAction.allChosen=t,t)for(e.multiRoomAction.rooms=[],e.multiRoomAction.indexes={},s=0,n=e.uiTotalCount;s<n;s++)e.rooms[s].selected=!0,e.multiRoomAction.rooms.push(e.rooms[s].id),e.multiRoomAction.indexes[s]=s;else{for(r in e.multiRoomAction.indexes)e.multiRoomAction.indexes.hasOwnProperty(r)&&(o=e.rooms[e.multiRoomAction.indexes[r]],o&&(o.selected=!1));e.multiRoomAction.rooms=[],e.multiRoomAction.indexes={}}},e.openChangeHkStatusModal=function(){m.open({template:"/assets/partials/housekeeping/rvChangeHkStatusModal.html",className:"ngdialog-theme-default",closeByDocument:!0,scope:e}),e.initilizeServiceStatus()},e.toggleRoomServiceStatusUpdate=function(){e.isRoomStatusUpdate=!e.isRoomStatusUpdate,e.isServiceStatusUpdate=!e.isServiceStatusUpdate};var K=function(){function t(t){e.$emit("hideLoader"),e.maintenanceReasonsList=t}e.invokeApi(p.fetchMaintenanceReasons,{},t)},G=function(){function t(t){e.$emit("hideLoader"),e.serviceStatusList=t,e.updateServiceData.room_service_status_id=e.serviceStatusList[0].id}e.invokeApi(p.fetchAllServiceStatus,{},t)},Y=15,q=12;e.timeSelectorList=f.getListForTimeSelector(Y,q),e.shouldShowTimeSelector=function(){var o=1===e.updateServiceData.room_service_status_id;return(t.isHourlyRateOn||"FULL"===t.hotelDiaryConfig.mode)&&!o},e.closeDialog=function(){m.close()};var X={dateFormat:t.jqDateFormat,numberOfMonths:1,changeYear:!0,changeMonth:!0,beforeShow:function(e,t){$("#ui-datepicker-div").addClass("reservation hide-arrow"),$('<div id="ui-datepicker-overlay">').insertAfter("#ui-datepicker-div"),setTimeout(function(){$("body").find("#ui-datepicker-overlay").on("click",function(){$("#room-out-from").blur(),
$("#room-out-to").blur()})},100)},onClose:function(e){$("#ui-datepicker-div").removeClass("reservation hide-arrow"),$("#ui-datepicker-overlay").off("click").remove()}},Q=function(){tzIndependentDate(e.updateServiceData.from_date)>tzIndependentDate(e.updateServiceData.to_date)&&(e.updateServiceData.to_date=s("date")(tzIndependentDate(e.updateServiceData.from_date),"yyyy-MM-dd")),e.untilDateOptions.minDate=s("date")(tzIndependentDate(e.updateServiceData.from_date),t.dateFormat)};e.fromDateOptions=angular.extend({minDate:s("date")(t.businessDate,t.dateFormat),onSelect:Q,beforeShowDay:e.setClass},X),e.untilDateOptions=angular.extend({minDate:s("date")(t.businessDate,t.dateFormat),onSelect:Q,beforeShowDay:e.setClass},X);var Z=function(e){return s("date")(new tzIndependentDate(e),t.dateFormatForAPI)},ee=function(t){e.closeDialog(),e.completedData={},e.completedData.serviceName=e.selectedServiceStatusName,e.completedData.assignedRoomsList=t,e.completedData.successFullyUpdated=parseInt(e.totalRoomsSelectedForUpdate)-parseInt(e.completedData.assignedRoomsList.length),e.completedData.notSuccessFullyUpdated=parseInt(e.completedData.assignedRoomsList.length),_.each(e.completedData.assignedRoomsList,function(e){e.is_add_to_update=!0,e.reservations.length>1?(e.reservationData="Multiple Reservations",e.isMultipleReservation=!0):1===e.reservations.length&&(e.reservationData="#"+e.reservations[0].confirm_no,e.GuestName=function(){var t="";return e.reservations[0].last_name&&e.reservations[0].first_name?t=e.reservations[0].last_name+", "+e.reservations[0].first_name:e.reservations[0].last_name&&!e.reservations[0].first_name?t=e.reservations[0].last_name+", ":!e.reservations[0].last_name&&e.reservations[0].first_name&&(t=", "+e.reservations[0].first_name),t}(),e.isMultipleReservation=!1)}),m.open({template:"/assets/partials/housekeeping/popups/rvMultipleRoomSeviceStatusResultPopup.html",className:"",closeByDocument:!0,scope:e}),setTimeout(function(){e.refreshScroller("rooms-list-to-forcefully-update")},1500)};e.updateServiceStatus=function(){var t=function(t){e.$emit("hideLoader"),"undefined"!=typeof t.assigned_rooms&&t.assigned_rooms.length>0?ee(t.assigned_rooms):(o(e.closeHkStatusDialog,100),e.refreshData())},r={from_date:Z(e.updateServiceData.from_date),to_date:Z(e.updateServiceData.to_date),begin_time:"",end_time:"",reason_id:e.updateServiceData.reason_id,comment:e.updateServiceData.comments,room_service_status_id:e.updateServiceData.room_service_status_id,return_status_id:e.updateServiceData.return_status_id};e.shouldShowTimeSelector()&&(r.begin_time=e.updateServiceData.begin_time,r.end_time=e.updateServiceData.end_time),r.room_id=[],e.multiRoomAction.allChosen?r.room_id=e.allRoomIDs:r.room_id=e.multiRoomAction.rooms,e.totalRoomsSelectedForUpdate=parseInt(r.room_id.length),e.selectedServiceStatusName=e.serviceStatusList[_.findIndex(e.serviceStatusList,{id:r.room_service_status_id})].description,e.invokeApi(p.postRoomServiceStatus,r,t)},e.forcefullyPutRoomToOOSorOOO=function(){var t=function(){e.$emit("hideLoader"),o(e.closeHkStatusDialog,100),e.refreshData()},r={from_date:Z(e.updateServiceData.from_date),to_date:Z(e.updateServiceData.to_date),begin_time:e.updateServiceData.begin_time,end_time:e.updateServiceData.end_time,reason_id:e.updateServiceData.reason_id,comment:e.updateServiceData.comments,is_move_forcefully:!0,room_service_status_id:e.updateServiceData.room_service_status_id,return_status_id:e.updateServiceData.return_status_id},s=_.filter(e.completedData.assignedRoomsList,function(e){return e.is_add_to_update});r.room_id=_.pluck(s,"id"),r.room_id.length>0?e.invokeApi(p.postRoomServiceStatus,r,t):e.closeForcefullyUpdatePopup()};var te=function(){e.updateServiceData.from_date=t.businessDate,e.updateServiceData.to_date=e.updateServiceData.from_date,e.updateServiceData.begin_time="",e.updateServiceData.end_time="",e.updateServiceData.reason_id="",e.updateServiceData.comments=""};e.initilizeServiceStatus=function(){K(),G(),te(),e.refreshScroller("room-service-status-update")},e.resetMultiRoomAction=function(){var t,o;for(t in e.multiRoomAction.indexes)e.multiRoomAction.indexes.hasOwnProperty(t)&&(o=e.rooms[e.multiRoomAction.indexes[t]],o&&(o.selected=!1));e.multiRoomAction.rooms=[],e.multiRoomAction.indexes={},e.multiRoomAction.anyChosen=!1,e.multiRoomAction.allChosen=!1,e.multiRoomAction.hkStatusId="",e.isRoomStatusUpdate=!0,e.isServiceStatusUpdate=!1,e.updateServiceData={}},e.closeHkStatusDialog=function(){e.resetMultiRoomAction(),e.closeDialog()},e.closeForcefullyUpdatePopup=function(){e.closeHkStatusDialog(),e.refreshData()},e.submitHkStatusChange=function(){var r,s,n,i=_.find(e.hkStatusList,function(t){return t.id==e.multiRoomAction.hkStatusId});if(i.value===V.INSPECTED){var u=v.getPermissionValue("CHANGE_ROOM_STATUS_TO_INSPECTED");if(!u&&t.isStandAlone)return m.close(),void o(function(){m.open({template:"/assets/partials/housekeeping/popups/rvRoomStatusChangeRestrictAlert.html",className:"",closeByDocument:!0,scope:e})},50)}e.multiRoomAction.rooms.length&&(r={room_ids:[],hk_status_id:e.multiRoomAction.hkStatusId},1==e.multiRoomAction.rooms.length==e.uiTotalCount&&e.multiRoomAction.allChosen?r.room_ids.push(e.multiRoomAction.rooms[0]):e.multiRoomAction.allChosen?r.room_ids=e.allRoomIDs:r.room_ids=e.multiRoomAction.rooms,s=function(t){e.$emit("hideLoader");var r,s,n=_.find(e.hkStatusList,function(t){return t.id===parseInt(e.multiRoomAction.hkStatusId)});for(r in e.multiRoomAction.indexes)e.multiRoomAction.indexes.hasOwnProperty(r)&&(s=e.rooms[e.multiRoomAction.indexes[r]],s.description=n.description,s.hk_status.description=n.description,s.hk_status.value=n.value,a.setRoomStatusClass(s));o(e.closeHkStatusDialog,100)},n=function(t){e.$emit("hideLoader"),e.errorMessage=t},e.invokeApi(a.putHkStatusChange,r,s,n))};var oe=function(){var t=document.getElementById("rooms"),r=t.children[0],n=document.getElementById("pull-refresh-page"),a=document.getElementById("refresh-icon"),i=document.getElementById("refresh-text"),u=document.getElementById("pull-load-next"),l=document.getElementById("load-icon"),c=document.getElementById("load-text"),d=!1,m=!1,h=0,p=0,_=110,f=0,v=r.clientHeight-t.clientHeight,S=Math.abs,g=e,k=s("translate")("PULL_REFRESH"),y=s("translate")("RELEASE_REFRESH"),D=s("translate")("PULL_LOAD_NEXT"),T=s("translate")("RELEASE_LOAD_NEXT"),A=s("translate")("PULL_LOAD_PREV"),C=s("translate")("RELEASE_LOAD_PREV"),E=function(e){return e?(e>_-40?a.className="rotate":a.className="",void(e>_-30?i.innerHTML=g.disablePrevBtn?y:C:i.innerHTML=g.disablePrevBtn?k:A)):(a.className="",void(i.innerHTML=g.disablePrevBtn?k:A))},M=function(e){return e?(S(e)>_-40?l.className="rotate":l.className="",void(S(e)>_-30?c.innerHTML=T:c.innerHTML=D)):(l.className="",void(c.innerHTML=D))},I=function(){g.disablePrevBtn?(O(),R()):g.loadPrevPage()},$=function(){g.loadNextPage()},L=function(e,t,o){var e=(e||0)+"px",t=(t||0)+"px",o=(o||0)+"px";return"translate3d("+e+", "+t+", "+o+")"},b=function(e){e.stopPropagation();var r=e.touches?e.touches[0]:e,s=0,a=L(),i="",l=function(){e.preventDefault(),m=!0,s=p-h,i=L(0,s,0),t.style.WebkitTransition="",t.style.webkitTransform=i},c=function(){t.style.webkitTransform=a,n.style.webkitTransform=a,u.style.webkitTransform=a,o(function(){n.classList.remove("show"),u.classList.remove("show")},320)};if(d||this.scrollTop===f||this.scrollTop===v){if(p=r.y||r.pageY,p>h&&this.scrollTop===f)l(),n.classList.add("show"),n.style.WebkitTransition="",n.style.webkitTransform=i,E(s);else{if(g.disableNextBtn||!(p<h)||parseInt(this.scrollTop+.5)!==parseInt(v))return void(m=!1);l(),u.classList.add("show"),u.style.WebkitTransition="",u.style.webkitTransform=i,M(s)}p-h===0&&c()}},N=function(e){var r=e.touches?e.touches[0]:e,s=0,a="-webkit-transform 0.3s",i=L(0,0,0),l=function(){m&&e.preventDefault(),s=p-h,d=!1,m=!1,t.style.WebkitTransition=a,t.style.webkitTransform=i,t.removeEventListener("touchmove",b)},c=function(){t.style.WebkitTransition=a,t.style.webkitTransform=i,n.style.WebkitTransition=a,n.style.webkitTransform=i,u.style.WebkitTransition=a,u.style.webkitTransform=i,t.removeEventListener("touchmove",b),o(function(){n.classList.remove("show"),u.classList.remove("show"),S(s)>_&&w()},320)};if(p=r?r.y||r.pageY:p,p>h&&this.scrollTop===f)l(),S(s)>_&&I(),E(),c();else{if(g.disableNextBtn||!(p<h)||parseInt(this.scrollTop+.5)!==parseInt(v))return void c();l(),S(s)>_&&$(),M(),c()}},P=function(e){var o=e.touches?e.touches[0]:e;v=r.clientHeight-t.clientHeight,d=!0,m=!1,h=o.y||o.pageY,t.style.WebkitTransition="",this.scrollTop===f?(n.style.WebkitTransition="",n.classList.add("show"),u.style.WebkitTransition="",u.classList.remove("show")):this.scrollTop===v&&(u.style.WebkitTransition="",u.classList.add("show"),n.style.WebkitTransition="",n.classList.remove("show")),t.addEventListener("touchmove",b,!1)};t.addEventListener("touchstart",P,!1),t.addEventListener("touchend",N,!1),t.addEventListener("touchcancel",N,!1),g.$on("$destroy",function(){!!t.length&&t.removeEventListener("touchstart",P),!!t.length&&t.removeEventListener("touchend",N),!!t.length&&t.removeEventListener("touchcancel",N)})};n.innerWidth<599&&oe(),angular.element(N).on("touchmove",function(e){e.stopPropagation()}),angular.element(P).on("touchmove",function(e){}),e.$on("$destroy",function(){angular.element(N).off("ontouchmove"),angular.element(P).off("ontouchmove")}),e.getWidthForSummary=function(){var t=0,o=e.summary.work_types.length;return t=parseInt(160*parseInt(o+1)+40)};var re={scrollX:!0,scrollY:!1,click:!0,preventDefault:!0,mouseWheel:!1};e.setScroller("tasks-summary-scroller",re),e.formatDateForUI=function(e){var o=typeof e,r="";switch(o){case"string":r=s("date")(new tzIndependentDate(e),t.dateFormat);break;case"object":r=s("date")(e,t.dateFormat)}return r},e.shouldShowArrivingGuestCount=function(e){return t.isStandAlone&&e.guest_details&&("RESERVED"===e.reservation_status||"CHECKEDIN"===e.reservation_status&&!e.is_stayover)},e.shouldShowStayoverGuestCount=function(e){return t.isStandAlone&&e.guest_details&&"CHECKEDIN"===e.reservation_status&&e.is_stayover},e.checkOooAndOosFilterValidation=function(t){"OO"!==t||e.currentFilters.out_of_order?"OOO"!==t||e.currentFilters.exclude_out_of_order?"OS"!==t||e.currentFilters.out_of_service?"OOS"!==t||e.currentFilters.exclude_out_of_service||(e.currentFilters.out_of_service=!1):e.currentFilters.exclude_out_of_service=!1:e.currentFilters.out_of_order=!1:e.currentFilters.exclude_out_of_order=!1};var se=t.$on("LANGUAGE_CHANGED",function(){o(function(){var o=t.isMaintenanceStaff?"MY_WORKSHEET":"ROOM_STATUS";t.setPrevState.title=s("translate")("DASHBOARD"),o=s("translate")(o),e.setTitle(o),e.heading=o},100)});e.$on("$destroy",se)}]),angular.module("sntRover").controller("rvHkServiceStatusDateSelectorCtrl",["$scope","$rootScope","ngDialog","dateFilter","$filter",function(e,t,o,r,s){e.setUpData=function(){e.dateOptions={changeYear:!0,changeMonth:!0,onSelect:function(t,r){e.onViewDateChanged(),e.serviceStatus[s("date")(new Date(t),"yyyy-MM-dd")]&&(e.updateService.room_service_status_id=e.serviceStatus[s("date")(new Date(t),"yyyy-MM-dd")].id),o.close()},beforeShowDay:e.setClass,onChangeMonthYear:function(t,o,r){e.updateCalendar(t,o)}}},e.setUpData()}]),angular.module("sntRover").controller("RVWorkManagementSearchDatePickerController",["$scope","$rootScope","ngDialog","dateFilter",function(e,t,o,r){e.setUpData=function(){e.dateOptions={changeYear:!0,changeMonth:!0,maxDate:tzIndependentDate(t.businessDate).addDays(365),minDate:tzIndependentDate(t.businessDate),onSelect:function(t,r){e.onViewDateChanged(),o.close()}}},e.setUpData()}]),angular.module("sntRover").controller("RVWorkManagementCreateDatePickerController",["$scope","$rootScope","ngDialog","dateFilter",function(e,t,o,r){e.setUpData=function(){e.dateOptions={changeYear:!0,changeMonth:!0,minDate:tzIndependentDate(t.businessDate),maxDate:tzIndependentDate(t.businessDate).addDays(365),onSelect:function(t,r){o.close(e.calendarDialog.id)}}},e.setUpData()}]),angular.module("sntRover").controller("RVWorkManagementMultiDatePickerController",["$scope","$rootScope","ngDialog","dateFilter",function(e,t,o,r){e.setUpData=function(){e.dateOptions={changeYear:!0,changeMonth:!0,maxDate:tzIndependentDate(t.businessDate).addDays(365),onSelect:function(t,r){e.onDateChanged(),o.close()}}},e.setUpData()}]),angular.module("sntRover").controller("RVWorkManagementMultiSheetCtrl",["$rootScope","$scope","ngDialog","RVWorkManagementSrv","$state","$stateParams","$timeout","allUnassigned","fetchHKStaffs","allRoomTypes","payload","$window","$filter","sntActivity","$transitions",function(e,t,o,r,s,n,a,i,u,l,c,d,m,h,p){BaseCtrl.call(this,t);var f,v,S=!1,g=null;p.onStart({},function(e){var o=e.from(),r=e.to();if("rover.workManagement.multiSheet"===o.name&&t.workSheetChanged)return h.stop("STATE_CHANGE"+r.name.toUpperCase()),t.$emit("hideLoader"),S=!0,g=function(){t.closeDialog(),t.workSheetChanged=!1,S=!1,s.go(r,e.params())},k(),!1}),t.closeSaveConfirmationDialog=function(e){S?(S=!1,g&&g()):(e&&e.callNextMethod&&t[e.callNextMethod]&&t[e.callNextMethod](),t.closeDialog())},t.closeDialog=function(){t.errorMessage="",o.close()},t.getWidthForWorkSheetContent=function(){return 220*t.multiSheetState.selectedEmployees.length+20+"px"},t.selectEmployee=function(){},t.onEmployeeListOpen=function(){t.multiSheetState.dndEnabled=!1},t.onEmployeeListClosed=function(){t.multiSheetState.dndEnabled=!0;var e=_.where(t.employeeList,{ticked:!0});e=_.pluck(e,"id"),_.difference(e,t.multiSheetState._lastSelectedIds)&&(_.each(t.multiSheetState._selectedIndexMap,function(e,o){t.multiSheetState.assigned[e]=t.multiSheetState.selectedEmployees[o]}),W(),K())},t.filterUnassigned=function(){t.filterUnassignedRooms(t.filters,t.multiSheetState.unassigned,t.multiSheetState.allRooms),t.multiSheetState.unassignedFiltered=t.multiSheetState.unassigned,K(),t.closeDialog()},t.showCalendar=function(e){o.open({template:"/assets/partials/workManagement/popups/rvWorkManagementMultiDateFilter.html",controller:e,className:"ngdialog-theme-default single-date-picker",closeByDocument:!0,scope:t})},t.showFilter=function(){o.open({template:"/assets/partials/workManagement/popups/rvWorkManagementFilterRoomsPopup.html",className:"ngdialog-theme-default",closeByDocument:!0,scope:t})},t.onCancel=function(){$_shouldSaveFirst=!1,s.go("rover.workManagement.start")},t.dropToAssign=function(e,o){function r(e,t,o){var r=e[t],s=o<t?-1:1,n=0;if(o!==t){for(n=t;n!=o;n+=s)e[n]=e[n+s];return e[o]=r,e}}var s,n,a,i,o,u,l,c,d,m,h,p,f=$(o.draggable).attr("id"),v=f.split("-")[1],S=parseInt(f.split("-")[2]),g=parseInt(f.split("-")[3]),k={};"UA"===v?(s=t.multiSheetState.unassignedFiltered,a=s[S],i=a.room_tasks[g]):(s=t.multiSheetState.selectedEmployees,n=s[v],a=n.rooms[S],i=a.room_tasks[g]),o=$(e.target).attr("id"),u=parseInt(o.split("-")[0]),l=t.multiSheetState.selectedEmployees[u],c=_.find(l.rooms,{room_id:a.room_id}),d=_.findIndex(l.rooms,{room_id:a.room_id}),m=[],k={},c?(m=angular.copy(l.rooms),_.find(c.room_tasks,{id:i.id})||m[d].room_tasks.push(i),void 0!==t.dropIndex&&(d>t.dropIndex?r(m,d,t.dropIndex):0===t.dropIndex?r(m,d,t.dropIndex):r(m,d,t.dropIndex-1)),l.rooms=m):(k={room_id:a.room_id,room_type:a.room_type,is_vip:a.is_vip,room_index:a.room_index,room_tasks:[i]},void 0===t.dropIndex||t.dropIndex===l.rooms-1?l.rooms.push(k):0===t.dropIndex?l.rooms.unshift(k):l.rooms=[].concat(l.rooms.slice(0,t.dropIndex),k,l.rooms.slice(t.dropIndex))),parseInt(v)!==u&&(l.only_tasks.push(i),l.touched_work_types.push(i.work_type_id),l.touched_work_types=_.uniq(_.flatten(l.touched_work_types)),"UA"!==v&&(h=_.findIndex(n.only_tasks,function(e){return e.id===i.id&&e.room_id===i.room_id}),h>-1&&n.only_tasks.splice(h,1),p=_.find(n.only_tasks,{work_type_id:i.work_type_id}),p||(n.touched_work_types=_.without(n.touched_work_types,i.work_type_id))),a.room_tasks.splice(g,1),"UA"===v||a.room_tasks.length||n.rooms.splice(S,1)),t.workSheetChanged=!0,K()},t.dropToUnassign=function(e,o){var r=$(o.draggable).attr("id"),s=r.split("-")[1],n=parseInt(r.split("-")[2]),a=parseInt(r.split("-")[3]),i=t.multiSheetState.selectedEmployees,u=t.multiSheetState.unassignedFiltered,l=i[s],c=l.rooms[n],d=c.room_tasks[a],m=_.find(u,{room_id:d.room_id});m?m.room_tasks.push(d):u.push({room_id:c.room_id,room_index:c.room_index,room_tasks:[d],show:!0}),t.filterUnassigned();var h,p;h=_.findIndex(l.only_tasks,function(e){return e.id===d.id&&e.room_id===d.room_id}),h>-1&&l.only_tasks.splice(h,1),p=_.find(l.only_tasks,{work_type_id:d.work_type_id}),p||(l.touched_work_types=_.without(l.touched_work_types,d.work_type_id)),c.room_tasks.splice(a,1),c.room_tasks.length||l.rooms.splice(n,1),t.workSheetChanged=!0,K()},t.onDateChanged=function(){t.workSheetChanged?k({date:t.dateSelected,callNextMethod:"updateView"}):J(!0),t.dateSelected=t.multiSheetState.selectedDate},t.onWorkTypeChanged=function(){t.workTypeSelected=t.multiSheetState.header.work_type_id,K()},t.refreshSheet=function(){t.saveMultiSheet({callNextMethod:"updateView"})};var k=function(e){o.open({template:"/assets/partials/workManagement/popups/rvWorkManagementSaveConfirmationPopup.html",className:"",scope:t,closeByDocument:!1,closeByEscape:!1,data:JSON.stringify(e)})},y=null,D=function(){!S&&y&&t[y.callNextMethod]&&a(t[y.callNextMethod].bind(null,y.nexMethodArgs),50),S&&g&&a(g,60),y=null},w=function(e){t.$emit("hideLoader"),t.clearErrorMessage(),t.workSheetChanged=!1,D()},R=function(e){t.errorMessage=e,t.$emit("hideLoader"),D()};t.saveMultiSheet=function(e){if(_.each(t.multiSheetState._selectedIndexMap,function(e,o){t.multiSheetState.assigned[e]=t.multiSheetState.selectedEmployees[o]}),y=e||null,t.multiSheetState.selectedEmployees.length){var o={successCallBack:w,failureCallBack:R,params:{assignedRoomTasks:t.multiSheetState.assigned,date:e&&e.date||t.multiSheetState.selectedDate,shouldSaveOrder:F()}};F()&&_.each(t.multiSheetState.assigned,function(e){_.each(e.only_tasks,function(t){var o=_.findIndex(e.rooms,{room_id:t.room_id});t.order=o+1})}),t.callAPI(r.saveWorkSheets,o)}else D(e)};var T=function(){$("head").append("<style id='print-orientation'>@page { size: landscape; }</style>")},O=function(){$("#print-orientation").remove()},A=null;t.openPrintWorkSheetPopup=function(){A=angular.copy(t.employeeList),o.open({template:"/assets/partials/workManagement/popups/rvWorkManagementPrintOptionsPopup.html",className:"",scope:t,closeByDocument:!1,closeByEscape:!1})},t.cancelPopupDialog=function(){t.employeeList=angular.copy(A),t.onEmployeeListClosed(),o.close()};var C=function(o){var s=t.multiSheetState;s.selectedEmployees=r.sortAssigned(s.selectedEmployees,s.allRooms,s.allTasks,o);var n=e.$watch(function(){n(),a(E,0)});I()},E=function(){t.$emit("hideLoader");var e=function(){a(function(){O(),t.multiSheetState=angular.copy(M),t.employeeList=angular.copy(A),t.onEmployeeListClosed(),M=null,I()},150)};a(function(){sntapp.cordovaLoaded?cordova.exec(e,function(){e()},"RVCardPlugin","printWebView",["worksheet","0","","L"]):(d.print(),e())},100)},M=null;t.printWorkSheet=function(){t.closeDialog(),a(function(){M=angular.copy(t.multiSheetState),C(t.printSettings);var e;for(e=t.multiSheetState.selectedEmployees.length-1;e>=0;e--)t.$parent.myScroll["assignedRoomList-"+t.multiSheetState.selectedEmployees[e].id].scrollTo(0,0);T()},750)};var I=function(){t.$$phase||t.$digest()},L=function(){e.setPrevState={title:m("translate")("WORK_MANAGEMENT"),name:"rover.workManagement.start"},t.setHeading(m("translate")("WORK_MANAGEMENT"))},b=function(){var e={tap:!0,preventDefault:!1,probeType:3,bounce:!1},o=_.extend({scrollX:!0,scrollY:!1},e),r=_.extend({scrollX:!1,scrollY:!0},e);t.setScroller("unAssignedRoomList",r),t.setScroller("multiSelectWorkSheet",e),t.setScroller("multiSelectPrintPopup",e),t.setScroller("worksheetHorizontal",o);var s=function(e,o,r){for(var s=0;s<o.length;s++)t.setScroller("assignedRoomList-"+o[s].id,r)};s(0,t.employeeList,r)},N=function(){t.refreshScroller("unAssignedRoomList"),t.refreshScroller("worksheetHorizontal");for(var e=0;e<t.employeeList.length;e++)t.refreshScroller("assignedRoomList-"+t.employeeList[e].id)},P=function(){t.$watch("multiSheetState.header.work_type_id",function(e,o){e!==o&&t.onWorkTypeChanged()})},F=function(){return!t.multiSheetState.header.work_type_id},x=function(e){var o,r;o=_.findIndex(t.multiSheetState.assigned,function(t){return t.id==e.id}),o>-1&&(t.multiSheetState.assigned[o].shiftId=e.shift_id,t.multiSheetState.selectedEmployees.push(t.multiSheetState.assigned[o]),r=t.multiSheetState.selectedEmployees.length-1,t.multiSheetState._selectedIndexMap[r]=o,t.multiSheetState._lastSelectedIds.push(t.multiSheetState.assigned[o].id))},U=function(e){t.multiSheetState.selectedEmployees=[],t.multiSheetState._selectedIndexMap={},t.multiSheetState._lastSelectedIds=[],u&&(t.employeeList=u.results);var o=!1;_.each(t.employeeList,function(t){e?(o=e.indexOf(t.id)>-1,o&&(t.ticked=!0,x(t))):(t.ticked=!0,x(t))})},W=function(){t.multiSheetState.selectedEmployees=[],t.multiSheetState._selectedIndexMap={},t.multiSheetState._lastSelectedIds=[],_.each(t.employeeList,function(e){e.ticked&&x(e)})},V=function(){var e=_.where(t.employeeList,{ticked:!0});return e=_.pluck(e,"id")},H=function(e){var o={};_.each(e.rooms,function(e){var o=[];_.each(e.room_tasks,function(e){"COMPLETED"!==e.status&&"IN_PROGRESS"!==e.status?t.multiSheetState.header.work_type_id&&e.work_type_id!=t.multiSheetState.header.work_type_id&&o.push(e):o.push(e)}),e.room_tasks=o});var r=[];return _.each(e.only_tasks,function(e){o[e.room_id]||(o[e.room_id]=[]),"COMPLETED"!==e.status&&"IN_PROGRESS"!==e.status?t.multiSheetState.header.work_type_id?e.work_type_id==t.multiSheetState.header.work_type_id?o[e.room_id].push(e):r.push(e):o[e.room_id].push(e):r.push(e)}),e.only_tasks=r,o},B=function(e,t){_.each(e,function(e){t[e.room_id]&&(e.room_tasks=e.room_tasks.concat(t[e.room_id]))})},j=function(e){if(h.stop("RELOAD_WORKSHEET"),v&&t.workSheetChanged){var o=_.find(c.assignedRoomTasks,{id:v}),r=H(o);B(c.unassignedRoomTasks,r)}else c=e,t.workSheetChanged=!1;q(!1),U(V()),t.filterUnassigned(),K(),v=null},z=function(e){h.stop("RELOAD_WORKSHEET"),t.errorMessage=e},J=function(){h.start("RELOAD_WORKSHEET");var e={date:t.multiSheetState.selectedDate},o={date:t.multiSheetState.selectedDate,employee_ids:u.emp_ids};r.processedPayload(e,o).then(j,z)},K=function(){Y(),I(),b(),N()},G=function(e){var o,r,s,n,a,i={tasksAssigned:0,tasksCompleted:0,timeAllocated:"00:00",shiftLength:"00:00"};a=_.findWhere(t.shifts,{id:e.shiftId}),i.shiftLength=a&&a.time||"00:00";var u;for(u=e.rooms.length-1;u>=0;u--)o=e.rooms[u].room_tasks,r=_.where(o,{is_completed:!0})||[],s=_.reduce(o,function(e,o){return n=o.time_allocated,t.addDuration(e,n.hh+":"+n.mm)},"0:0"),i.tasksAssigned+=o.length,i.tasksCompleted+=r.length,i.timeAllocated=t.addDuration(i.timeAllocated,s);return i},Y=function(e){var o=t.multiSheetState;if("number"==typeof e){var r=_.findWhere(o.assigned,{id:e});o.summary[e]=G(r)}else _.each(o.assigned,function(e){o.summary[e.id]=G(e)})};t.updateView=J;var q=function(o){t.multiSheetState=$.extend({},{unassigned:c.unassignedRoomTasks,assigned:c.assignedRoomTasks,allTasks:c.allTasks,allRooms:c.allRooms},{unassignedFiltered:[],_unassignIndexMap:{}},{selectedEmployees:[],_selectedIndexMap:{},_lastSelectedIds:[]},{dndEnabled:!0,selectedDate:n.filterParams&&n.filterParams.selectedDate||t.dateSelected||n.date||e.businessDate,summary:{},header:{work_type_id:n.filterParams&&n.filterParams.worktype_id||t.workTypeSelected||""}}),o&&(t.filters={selectedFloor:"",selectedReservationStatus:"",selectedFOStatus:"",vipsOnly:!1,showAllRooms:!1,checkin:{after:{hh:"",mm:"",am:"AM"},before:{hh:"",mm:"",am:"AM"}},checkout:{after:{hh:"",mm:"",am:"AM"},before:{hh:"",mm:"",am:"AM"}}}),n.filterParams&&(n.filterParams.selectedDate=null)},X=function(){t.dateSelected=t.multiSheetState.selectedDate,t.workTypeSelected=t.multiSheetState.header.work_type_id,t.workSheetChanged=!1,t.printSettings={grouping:"room",sort:"asc",employees:1}},Q=function(){N()},Z=t.$on("ALL_RENDER_COMPLETE",Q);t.$on("$destroy",Z),t.getReservationStatusClass=function(e){if(angular.isUndefined(e))return"guest";switch(e.reservation_status){case"Due out":case"Arrived / Day use / Due out":case"Arrived / Day use / Due out / Departed":case"Due out / Arrival":case"Due out / Departed":case"Arrived / Departed":case"Departed":return"guest red";case"Stayover":return"guest blue";case"Arrival":case"Arrived":case"Departed / Arrival":return"guest green";case"Not Reserved":return"guest gray";default:return"guest"}},t.getReservationStatusValue=function(e){if(angular.isUndefined(e))return"default";switch(e.reservation_status){case"Due out / Departed":case"Arrived / Day use / Due out / Departed":case"Arrived / Departed":case"Departed":return"OUT";case"Due out":case"Arrived / Day use / Due out":case"Due out / Arrival":return e.checkout_time?e.checkout_time:"DUE OUT";case"Stayover":return"STAYOVER";case"Arrived":return"IN";case"Arrival":case"Departed / Arrival":return e.checkin_time?e.checkin_time:"DUE IN";case"Not Reserved":return"NOT RESERVED";default:return"default"}},t.getCurrentStatusClass=function(e){if(angular.isUndefined(e))return"room";switch(e.current_status){case"DIRTY":return"room red";case"PICKUP":return"room orange";case"CLEAN":case"INSPECTED":return"room green";case"DO_NOT_DISTURB":return"room purple";default:return"room"}};var ee=function(){var e="LEFT",o="RIGHT",r="TOP",s="BOTTOM",n=void 0,a=n,i=n,u=n,l=function(){var e={},o=0,r=0,s=void 0,n=void 0;return e.getClientPos=function(){return{x:o,y:r}},e.setClientPos=function(e,t){o=e,r=t},e.removePlaceholder=function(e){var t,o,r=function(){t&&(o=t.find(".placeholder"),o.remove())};t=s?s:n?n:void 0,e?setTimeout(r,10):r()},e.findCurrCol=function(){var e,o=this.getClientPos().x,r=t.$parent.myScroll.worksheetHorizontal,s=r.x,n=20,a=220,i=o-(n+s),u=t.multiSheetState.selectedEmployees.length;return i<0?e=-1:(e=Math.floor(i/a),0===u?e=0:e>=u?e=u-1:e>0&&(e-=1)),e},e.findCurrColNode=function(){var e,o=this.findCurrCol();return this.removePlaceholder(),n=s,o>-1?(e=t.multiSheetState.selectedEmployees[o],s=$("#"+o+"-"+e.id)):s=void 0,s}.bind(e),e.checkOnOverRoom=function(e,t,o){var r,s,n,a,i,u,l,c,d,m=280,h=20;return r=$(e),s=r.next(".worksheet-room"),n=t+1,s.hasClass(".placeholder")&&this.addPlaceholder(),a=r.height(),u=0===t?m:o,l=u+a/2,c=u+a+h,i=u+a,d=this.getClientPos().y,d<u&&0===t?{method:"BEFORE",node:r,index:t}:d>c?s.length?this.checkOnOverRoom(s,n,i):{method:"AFTER",node:r,index:n}:d<l&&d>=u?{method:"BEFORE",node:r,index:t}:{method:"AFTER",node:r,index:n}}.bind(e),e.addPlaceholder=function(){var e,o=this.findCurrColNode(),r=0,s=0,n=$('<div class="worksheet-room placeholder">Drop Here</div>');if(this.removePlaceholder(),void 0!==o)if(e=o.find(".worksheet-room")[0],void 0===e)o.find(".wrapper").append(n),t.dropIndex=0;else{var a=this.checkOnOverRoom(e,r,s);switch(a.method){case"BEFORE":n.insertBefore(a.node);break;case"AFTER":n.insertAfter(a.node);break;default:o.find(".wrapper").append(n)}t.dropIndex=a.index}}.bind(e),e}(),c=function(){var e=200,t=260,o=110,r=100,s=$(window).width(),n=$(window).height();return{screenStart:{x:e+o,y:t+r},screenEnd:{x:s-e,y:n-r}}},d=function(){u=c()};d(),window.addEventListener("resize",d,!1),t.$on("$destroy",function(){window.removeEventListener("resize",d)});var m,h=function(){var n=t.$parent.myScroll.worksheetHorizontal,i=void 0,u=-1,c=function(){return a===e||a===o},d=function(){return!!n.hasHorizontalScroll},m=function(){return a===e&&n.x<0},h=function(){return a===o&&n.x>n.maxScrollX},p=function(){return a===r||a===s},_=function(){return!!i&&!!i.hasVerticalScroll},f=function(){return a===r&&i.y<0},v=function(){return a===s&&i.y>i.maxScrollY};c()&&d()?m()?n.scrollBy(10,0,1):h()&&n.scrollBy(-10,0,1):p()&&(u=l.findCurrCol(),u>-1&&(i=t.getScroller("assignedRoomList-"+u),_()&&(f()?i.scrollBy(0,8,1):v()&&i.scrollBy(0,-8,1))))};t.dragStart=function(e){m=$(e.target).parent(),m.hide(),i=setInterval(h,1),t.dropIndex=void 0},t.dragDrop=function(){var e=!0;m.show(),F()&&l.removePlaceholder(e),i&&(window.clearInterval(i),i=n)};var p=_.throttle(l.addPlaceholder,250,{leading:!0,trailing:!1});t.userDragging=function(t){return F()&&(l.setClientPos(t.clientX,t.clientY),p()),t.clientX>u.screenEnd.x?void(a=o):t.clientX<u.screenStart.x?void(a=e):t.clientY>u.screenEnd.y?void(a=s):t.clientY<u.screenStart.y?void(a=r):void(a=n)}},te=function(){t.getScroller("worksheetHorizontal")?ee():setTimeout(te,100)},oe=function(e){L(),P(),q(!0),U(e),t.filterUnassigned(),X(),K(),te()};oe(),f={},t.getRoomType=function(e){var t,o,r=f[e];return angular.isDefined(r)?o=r:(t=_.find(l,{id:e}),angular.isDefined(t)?(f[e]=t.name,o=t.name):o=""),o},t.formatDateForUI=function(t){var o=typeof t,r="";switch(o){case"string":r=m("date")(new tzIndependentDate(t),e.dateFormat);break;case"object":r=m("date")(t,e.dateFormat)}return r};var re=function(){var e=_.pluck(_.where(t.employeeList,{ticked:!0}),"id");return e},se=function(e,o){var r=[];return _.each(o,function(o){var s=angular.copy(o),n=_.find(t.multiSheetState.allRooms,function(e){return e.id==s.room_id});n&&(s.hk_section_id=n.hk_section_id),e&&(s.room_tasks=_.filter(s.room_tasks,function(e){return e.work_type_id==t.multiSheetState.header.work_type_id})),s.room_tasks.length&&r.push(s)}),r},ne=function(e){var t=_.find(c.unassignedRoomTasks,function(t){return t.room_id==e});return JSON.parse(JSON.stringify(t))},ae=function(e){var t=e;_.each(t,function(e,t){var o=_.find(c.assignedRoomTasks,function(e){return e.id==t});o.only_tasks=o.only_tasks.concat(e);var r=_.uniq(_.pluck(e,"room_id"));_.each(r,function(t){var r=_.find(o.rooms,function(e){return e.id==t}),s=_.findIndex(o.rooms,function(e){return e.id==t}),n=angular.copy(r);if(r)n.room_tasks=n.room_tasks.concat(_.filter(e,function(e){return e.room_id==t})),o.rooms[s]=n;else{var a=ne(t);a.room_tasks=_.filter(e,function(e){return e.room_id==t}),o.rooms.push(a)}}),o.touched_work_types=_.uniq(_.pluck(o.only_tasks,"work_type_id"))})},ie=function(e){var t=[];_.each(e,function(e){t=t.concat(e)});var o=_.uniq(_.pluck(t,"room_id"));_.each(o,function(e){var o=_.find(c.unassignedRoomTasks,function(t){return t.room_id==e}),r=_.findIndex(c.unassignedRoomTasks,function(t){return t.room_id==e}),s=_.filter(t,function(t){return t.room_id==e}),n=_.pluck(s,"id"),a=angular.copy(o);a.room_tasks=_.filter(a.room_tasks,function(e){return n.indexOf(e.id)<0}),c.unassignedRoomTasks[r]=a})},ue=function(e){ae(e.assigned_tasks),ie(e.assigned_tasks),oe(re())};t.executeAutoAssign=function(){if(t.workSheetChanged)return k(),!1;var e=function(e){ue(e),K()},o=function(e){t.errorMessage=e},s={successCallBack:e,failureCallBack:o,params:{date:t.dateSelected,employee_ids:re(),worktype_id:t.multiSheetState.header.work_type_id,unassigned_room_tasks:se(t.multiSheetState.header.work_type_id,c.unassignedRoomTasks)}};t.callAPI(r.executeAutoAssign,s)},t.getHKStatus=function(e){return"DO_NOT_DISTURB"===e?"DND":e},t.getFirstFilteredTaskId=function(e,t,o){if(!e)return o&&o.length>0&&o[0].id||null;var r=_.filter(o,function(t){return t.work_type_id==e});return r&&r.length>0&&r[0].id||null};var le=e.$on("LANGUAGE_CHANGED",function(){a(function(){e.setPrevState.title=m("translate")("WORK_MANAGEMENT"),t.setHeading(m("translate")("WORK_MANAGEMENT"))},100)});t.$on("$destroy",le);var ce=function(e){var o={date:t.multiSheetState.selectedDate,employee_ids:e,work_type_id:t.multiSheetState.header.work_type_id};t.callAPI(r.resetWorkAssignments,{params:o,onSuccess:J,onFailure:J})};t.resetWorkAssignments=function(){t.workSheetChanged?J():ce(V())},t.shouldDisableResetButton=function(){return V().length<1},t.shouldShowRemoveTasksButton=function(e){var o=!1;return _.find(e,function(e){if(t.multiSheetState.header.work_type_id?(o=_.filter(e.room_tasks,function(e){return e.work_type_id==t.multiSheetState.header.work_type_id}),o=o.length>0):o=e.room_tasks.length>0,o)return!0}),o},t.unassignAllTasks=function(e){v=e,ce([e])}}]),
angular.module("sntRover").controller("RVWorkManagementStartCtrl",["$rootScope","$scope","ngDialog","$state","RVWorkManagementSrv","$timeout","$filter",function(e,t,o,r,s,n,a){t.setHeading(a("translate")("WORK_MANAGEMENT")),BaseCtrl.call(this,t);var i={click:!0,scrollbars:!0};t.setScroller("work_management",i),t.refreshScroller=function(e){setTimeout(function(){t&&t.myScroll&&e in t.myScroll&&t.myScroll[e].refresh()},100)},t.showCreateWorkSheetDialog=function(){o.open({template:"/assets/partials/workManagement/popups/rvWorkManagementCreatePopup.html",className:"ngdialog-theme-default",closeByDocument:!0,scope:t})};var u=function(){var e=function(e){t.$emit("hideLoader"),t.workStats=e,t.refreshScroller("work_management"),_.each(t.workStats.work_types,function(e){e.total_rooms_completed<e.total_rooms_assigned?e.css_class="red":e.css_class="green",_.each(e.tasks,function(e){e.total_rooms_completed<e.total_rooms_assigned?e.css_class="red":e.css_class="green"})})},o=function(e){t.errorMessage="",t.errorMessage=e,t.$emit("hideLoader")};t.invokeApi(s.fetchStatistics,t.stateVariables.viewingDate,e,o)};t.stateVariables={searching:!1,searchQuery:"",lastSearchQuery:"",employeeSearch:!1,noSearchResults:!1,viewingDate:{date:e.businessDate,work_type_id:t.workTypes[0].id},searchResults:{maids:[],rooms:[]},newSheet:{user_id:"",work_type_id:t.workTypes[0].id,date:e.businessDate},assignRoom:{user_id:"",work_type_id:t.workTypes[0].id,rooms:[]}},t.closeDialog=function(){t.errorMessage="",o.close()},t.continueCreateWorkSheet=function(){var e=function(e){t.$emit("hideLoader"),r.go("rover.workManagement.singleSheet",{id:e.id,date:e.date,from:"START"}),t.closeDialog()},o=function(e){t.errorMessage="",t.errorMessage=e,t.$emit("hideLoader")};t.invokeApi(s.createWorkSheet,t.stateVariables.newSheet,e,o)},t.showWorkSheet=function(e){e&&r.go("rover.workManagement.singleSheet",{date:t.stateVariables.viewingDate.date,id:e,from:"START"})},t.onRoomSelect=function(e){t.stateVariables.assignRoom.rooms=[e.id],e.work_sheet_id?r.go("rover.workManagement.singleSheet",{date:t.stateVariables.viewingDate.date,id:e.work_sheet_id,from:"START"}):(t.stateVariables.assignRoom.work_type_id=e.work_type_ids[0],o.open({template:"/assets/partials/workManagement/popups/rvWorkManagementAssignRoom.html",className:"ngdialog-theme-default",closeByDocument:!0,scope:t,data:JSON.stringify({workTypes:_.filter(t.workTypes,function(t){return e.work_type_ids.indexOf(t.id)>-1})})}))},t.assignRoom=function(){if(t.errorMessage="",!t.stateVariables.assignRoom.work_type_id)return t.errorMessage=["Please select a work type."],!1;if(!t.stateVariables.assignRoom.user_id)return t.errorMessage=["Please select an employee."],!1;var e=function(e){t.$emit("hideLoader"),t.stateVariables.assignRoom.user_id="",t.stateVariables.assignRoom.work_type_id="";var o=e.touched_work_sheets&&e.touched_work_sheets[0]&&e.touched_work_sheets[0].work_sheet_id;t.showWorkSheet(o),t.closeDialog()},o=function(e){t.$emit("hideLoader"),t.errorMessage=e};t.invokeApi(s.saveWorkSheet,{date:t.stateVariables.viewingDate.date,task_id:t.stateVariables.assignRoom.work_type_id,order:"",assignments:[{assignee_id:t.stateVariables.assignRoom.user_id,room_ids:t.stateVariables.assignRoom.rooms,work_sheet_id:"",from_search:!0}]},e,o)},t.showCalendar=function(e){o.open({template:"/assets/partials/workManagement/popups/rvWorkManagementSearchDateFilter.html",controller:e,className:"ngdialog-theme-default single-date-picker",closeByDocument:!0,scope:t})},t.showCreateCalendar=function(){t.calendarDialog=o.open({template:"/assets/partials/workManagement/popups/rvWorkManagementCreateDatePicker.html",controller:"RVWorkManagementCreateDatePickerController",className:"ngdialog-theme-default single-date-picker",closeByDocument:!0,scope:t})},t.onViewDateChanged=function(){t.stateVariables.searching&&t.workManagementSearch(!0),u()},t.resetView=function(){t.stateVariables.viewingDate.date=e.businessDate,u()},t.toggleTasksList=function(e){e.showTasks=!e.showTasks,t.refreshScroller("work_management")},t.navigateToMultiSheet=function(){r.go("rover.workManagement.multiSheet",{date:t.stateVariables.viewingDate.date})};var l=e.$on("LANGUAGE_CHANGED",function(){n(function(){t.setHeading(a("translate")("WORK_MANAGEMENT"))},100)});t.$on("$destroy",l),u()}]),angular.module("sntRover").controller("RVWorkManagementCtrl",["$rootScope","$scope","employees","workTypes","shifts","floors","$timeout",function(e,t,o,r,s,n,a){BaseCtrl.call(this,t),t.setHeading=function(e){t.heading=e,t.setTitle(e)},t.setHeading("Work Management"),t.$emit("updateRoverLeftMenu","workManagement"),t.workTypes=r,t.employeeList=o,t.shifts=s,t.floors=n,t.reservationStatus={"Due out":"check-out",Departed:"check-out",Stayover:"inhouse","Not Reserved":"no-show",Arrival:"check-in",Arrived:"check-in","Not Defined":"no-show","Day Use":"check-out","Due out / Arrival":"check-out","Departed / Arrival":"check-out","Arrived / Departed":"check-in","Due out / Departed":"check-out","Arrived / Day use / Due out":"check-in","Arrived / Day use / Due out / Departed":"check-in"},t.arrivalClass={Arrival:"check-in",Arrived:"check-in","Due out":"no-show",Departed:"no-show",Stayover:"no-show","Not Reserved":"no-show","Not Defined":"no-show","Day Use":"check-in","Due out / Arrival":"check-in","Departed / Arrival":"check-in","Arrived / Departed":"check-in","Due out / Departed":"no-show","Arrived / Day use / Due out":"check-in","Arrived / Day use / Due out / Departed":"check-in"},t.departureClass={Arrival:"check-out",Arrived:"check-out","Due out":"check-out",Departed:"check-out",Stayover:"inhouse","Not Reserved":"check-out","Not Defined":"check-out","Day Use":"check-out","Due out / Arrival":"check-out","Departed / Arrival":"check-out","Arrived / Departed":"check-out","Due out / Departed":"check-out","Arrived / Day use / Due out":"check-out","Arrived / Day use / Due out / Departed":"check-out"},t.printWorkSheet=function(){window.print()},t.addDuration=function(e,t){if(!t)return e;var o=e.split(":"),r=t.split(":"),s=parseInt(o[1])+parseInt(r[1]),n=(parseInt(o[0])+parseInt(r[0])+parseInt(s/60)).toString();return(n.length<2?"0"+n:n)+":"+((s%60).toString().length<2?"0"+(s%60).toString():(s%60).toString())},t.filterUnassignedRooms=function(e,t,o){function r(){return!!(e.checkin.before.hh||e.checkin.after.hh||e.checkout.after.hh||e.checkout.after.hh)}function s(t){return!!(t.checkin_time&&(e.checkin.before.hh||e.checkin.after.hh)||t.checkout_time&&(e.checkout.before.hh||e.checkout.after.hh))}function n(e){var t,o,r;return e?(t=e.toString().split(":"),o=t[1].split(" "),r=t[0],r=o[1].toString()&&"PM"===o[1].toString().toUpperCase()?parseInt(r)+12:(parseInt(r)+12)%12,r.toString().length<2&&(r="0"+r.toString()),r+=":"+o[0]):r="00:00",r}var a,i,u={};if(e.showAllRooms)_.each(t,function(e){e.show=!0});else{e.selectedFloor&&(u.floor_number=e.selectedFloor),e.selectedReservationStatus&&(u.reservation_status=e.selectedReservationStatus),e.vipsOnly&&(u.is_vip=!0),e.selectedFOStatus&&(u.fo_status=e.selectedFOStatus),_.each(t,function(e){a=o[e.room_index],i=_.find(u,function(e,t){return a[t]!==e}),i?e.show=!1:e.show=!0});var l,c,d,m,h,p,f;r()&&_.each(t,function(t){var r=o[t.room_index];s(r)&&(l=e.checkin.before,c=e.checkin.after,d=e.checkout.before,m=e.checkout.after,c.hh&&l.hh?(h=r.checkin_time,f=c.hh+":"+(c.mm||"00")+" "+c.am,p=l.hh+":"+(l.mm||"00")+" "+l.am,n(h)>=n(f)&&n(h)<=n(p)?t.show=!0:t.show=!1):c.hh?(h=r.checkin_time,f=c.hh+":"+(c.mm||"00")+" "+c.am,n(h)>=n(f)?t.show=!0:t.show=!1):l.hh?(h=r.checkin_time,p=l.hh+":"+(l.mm||"00")+" "+l.am,n(h)>=n(p)?t.show=!0:t.show=!1):m.hh&&d.hh?(h=r.checkout_time,f=m.hh+":"+(m.mm||"00")+" "+m.am,p=d.hh+":"+(d.mm||"00")+" "+d.am,n(h)>=n(f)&&n(h)<=n(p)?t.show=!0:t.show=!1):m.hh?(h=r.checkout_time,f=m.hh+":"+(m.mm||"00")+" "+m.am,n(h)>=n(f)?t.show=!0:t.show=!1):d.hh&&(h=r.checkin_time,p=d.hh+":"+(d.mm||"00")+" "+d.am,n(h)<=n(p)?t.show=!0:t.show=!1))})}}}]),angular.module("sntRover").controller("RVWorkManagementSingleSheetCtrl",["$rootScope","$scope","$stateParams","wmWorkSheet","RVWorkManagementSrv","$timeout","$state","ngDialog","$filter","allUnassigned","$window","$transitions",function(e,t,o,r,s,n,a,i,u,l,c,d){BaseCtrl.call(this,t);var m=!0,h=null;d.onStart({},function(e){if("rover.workManagement.singleSheet"===e.from().name&&m)return h=function(){m=!1,a.go(e.to(),e.params())},t.saveWorkSheet(),!1});var p={title:"Work Management",name:"rover.workManagement.start"};"multiple"===o.from?p={title:"Manage Worksheets",name:"rover.workManagement.multiSheet"}:parseInt(o.from)&&(p={title:"Room Details",name:"rover.housekeeping.roomDetails",param:{id:parseInt(o.from)}}),e.setPrevState=p,t.dropToUnassign=function(e,o){var r=parseInt($(o.draggable).attr("id").split("-")[1]);t.unAssignRoom(t.singleState.assigned[r])},t.dropToAssign=function(e,o){var r=parseInt($(o.draggable).attr("id").split("-")[1]);t.assignRoom(t.singleState.unassigned[r])};var r=r,f=function(){t.refreshScroller("workSheetUnassigned"),t.refreshScroller("workSheetAssigned")},v=function(){t.setHeading("Work Sheet No."+r.sheet_number+", "+u("date")(o.date,e.dateFormat)),t.singleState={workSheet:{user_id:null===r.maid_id?"":r.maid_id,work_type_id:null===r.work_type_id?"":r.work_type_id,shift_id:r.shift_id?r.shift_id:""},unassigned:[],unassignedFiltered:[],assigned:[],summary:{timeAllocated:"00:00",departures:0,stayovers:0,completed:0},filters:{selectedFloor:"",selectedStatus:""},dimensions:{unassigned:$("#worksheet-unassigned-rooms").width()-40,assigned:$("#worksheet-assigned-rooms").width()-40}},t.filters={selectedFloor:"",selectedReservationStatus:"",selectedFOStatus:"",vipsOnly:!1,showAllRooms:!1,checkin:{after:{hh:"",mm:"",am:"AM"},before:{hh:"",mm:"",am:"AM"}},checkout:{after:{hh:"",mm:"",am:"AM"},before:{hh:"",mm:"",am:"AM"}}}},S=function(){var r=function(r){t.setHeading("Work Sheet No."+r.work_sheets[0].work_sheet_id+", "+u("date")(o.date,e.dateFormat)),t.singleState.unassigned=r.unassigned;var s=[];_.each(r.work_sheets[0].work_assignments,function(e){s.push(e.room)}),t.singleState.assigned=s,t.filterUnassigned(),g(),f(),t.$emit("hideLoader")},n=function(e){t.errorMessage=e,t.$emit("hideLoader")};t.invokeApi(s.fetchWorkSheetDetails,{date:o.date||e.businessDate,employee_ids:[t.singleState.workSheet.user_id],work_type_id:t.singleState.workSheet.work_type_id},r,n)};t.init=S;var g=function(){t.singleState.summary={timeAllocated:"00:00",departures:0,stayovers:0,completed:0},_.each(t.singleState.assigned,function(e){"check-out"===t.departureClass[e.reservation_status]?t.singleState.summary.departures++:"inhouse"===t.departureClass[e.reservation_status]&&t.singleState.summary.stayovers++,e.hk_complete&&t.singleState.summary.completed++;var o=t.singleState.summary.timeAllocated.split(":"),r=e.time_allocated.split(":"),s=parseInt(o[1])+parseInt(r[1]),n=(parseInt(o[0])+parseInt(r[0])+parseInt(s/60)).toString();t.singleState.summary.timeAllocated=(n.length<2?"0"+n:n)+":"+((s%60).toString().length<2?"0"+(s%60).toString():(s%60).toString())})};t.setScroller("workSheetUnassigned"),t.setScroller("workSheetAssigned"),t.assignRoom=function(e){t.singleState.unassigned.splice(_.indexOf(t.singleState.unassigned,_.find(t.singleState.unassigned,function(t){return t.room_no===e.room_no})),1),t.singleState.assigned.push(e),g(),f()},t.unAssignRoom=function(e){t.singleState.assigned.splice(_.indexOf(t.singleState.assigned,_.find(t.singleState.assigned,function(t){return t.room_no===e.room_no})),1),t.singleState.unassigned.push(e),g(),f()},t.printWorkSheet=function(){t.saveWorkSheet({callNextMethod:"printAfterSave"})};var k=function(){$("head").append("<style id='print-orientation'>@page { size: landscape; }</style>")},y=function(){$("#print-orientation").remove()};t.printAfterSave=function(){t.$parent.myScroll.workSheetAssigned&&t.$parent.myScroll.workSheetAssigned.scrollTo&&t.$parent.myScroll.workSheetAssigned.scrollTo(0,0),k();var e=function(){n(y,100)};n(function(){sntapp.cordovaLoaded?cordova.exec(e,function(){e()},"RVCardPlugin","printWebView",["singleSheet","0","","L"]):(c.print(),e())},100)},t.deletWorkSheet=function(){var e=function(e){t.$emit("hideLoader"),m=!1,n(function(){a.go("rover.workManagement.start")},20)},r=function(e){t.errorMessage=e,t.$emit("hideLoader")};t.invokeApi(s.deleteWorkSheet,{id:o.id},e,r)};var D="";_.each(l,function(e){D=e.id,_.each(e.unassigned,function(e){e.work_type_id=D})}),t.saveWorkSheet=function(e){var r=[],a=0,i=e&&e.oldWorkTypeId?e.oldWorkTypeId:t.singleState.workSheet.work_type_id,u=e&&e.oldUserId?e.oldUserId:t.singleState.workSheet.user_id,l={},c=function(){e&&t[e.callNextMethod]&&n(t[e.callNextMethod],50),m&&h&&n(h,60)},d=function(e){a--,0===a&&(t.$emit("hideLoader"),t.clearErrorMessage(),c())},p=function(e){t.errorMessage=e,a--,0===a&&(t.$emit("hideLoader"),c())};return i?t.singleState.workSheet.user_id?(l={},_.each(t.workTypes,function(e){l[e.id.toString()]=[]}),void(t.singleState.assigned.length?(_.each(t.singleState.assigned,function(e){e.hasOwnProperty("work_type_id")?l[e.work_type_id.toString()].push(e):l[i.toString()].push(e)}),_.each(l,function(e,n){e.length&&(_.each(e,function(e){r.push(e.room_id||e.id)}),t.invokeApi(s.saveWorkSheet,{date:o.date,task_id:parseInt(n),order:"",assignments:[{shift_id:t.singleState.workSheet.shift_id,assignee_id:u,room_ids:r,work_sheet_id:""}]},d,p),r=[],a++)})):(_.each(l,function(e,r){t.invokeApi(s.saveWorkSheet,{date:o.date,task_id:parseInt(r),assignments:[{assignee_id:u,room_ids:[]}]},d,p)}),c()))):(t.errorMessage=["Please select an employee."],!1):(t.errorMessage=["Please select a work type."],!1)},t.startLoader=function(){t.$emit("showLoader")},t.filterUnassigned=function(){t.$emit("showLoader"),n(function(){t.singleState.unassignedFiltered=t.filterUnassignedRooms(t.filters,t.singleState.unassigned,l),f(),t.closeDialog(),t.$emit("hideLoader")},10)},t.$watch("singleState.workSheet.work_type_id",function(e,o){e!==o&&t.saveWorkSheet({oldWorkTypeId:o,callNextMethod:"onWorkTypeChange"})}),t.onWorkTypeChange=function(){S()},t.$watch("singleState.workSheet.user_id",function(e,o){e!==o&&t.saveWorkSheet({oldUserId:o,callNextMethod:"onEmployeeChange"})}),t.onEmployeeChange=function(e){S()},t.refreshSheet=function(){t.saveWorkSheet({callNextMethod:"init"})},t.onAssignmentDragStart=function(){t.$parent.myScroll.workSheetUnassigned.disable()},t.onAssignmentDragStop=function(){t.$parent.myScroll.workSheetUnassigned.enable()},t.onUnassignmentDragStart=function(){t.$parent.myScroll.workSheetAssigned.disable()},t.onUnassignmentDragStop=function(){t.$parent.myScroll.workSheetAssigned.enable()},t.showFilter=function(){i.open({template:"/assets/partials/workManagement/popups/rvWorkManagementFilterRoomsPopup.html",className:"ngdialog-theme-default",closeByDocument:!0,scope:t})},t.idToVal=function(e,t,o){var r=_.find(o,function(t){return t.id===e});return r&&r.hasOwnProperty(t)?r[t]:""},v(),S()}]),angular.module("sntRover").service("RVHkRoomDetailsSrv",["$http","$q","rvBaseWebSrvV2","RVBaseWebSrv","$window","$filter","$vault",function(e,t,o,r,s,n,a){var i=this,u=200,l=function(e){var t=function(e){return 2===e?"OUT_OF_SERVICE":3===e?"OUT_OF_ORDER":"IN_SERVICE"};a.setOnce("LAST_ROOM_SERVICE",JSON.stringify({rooms:[].concat(e.room_id),status:{to_date:e.to_date,end_time:e.end_time,id:e.room_service_status_id,value:t(e.room_service_status_id)}}))};i.roomDetails={},i.fetch=function(o,r){var n=t.defer(),a="/house/room/"+o+".json";return e.get(a).then(function(e){var t=e.data;"success"===t.status?(i.roomDetails=t.data.room_details,n.resolve(i.roomDetails)):n.reject(t)},function(e){var t=e.data,o=e.status;401===o?s.location.href="/house/logout":n.reject(t)}),n.promise},i.updateHKStatus=function(o){var r=t.defer(),n="/house/change_house_keeping_status.json";return e({url:n,method:"POST",data:o}).then(function(e){var t=e.data;"success"===t.status||e.status===u?r.resolve(t.data):r.reject(t)},function(e){var t=e.data,o=e.status;401===o?s.location.href="/house/logout":r.reject(t)}),r.promise};var c=[];i.fetchAllServiceStatus=function(){var e=t.defer(),r="api/room_services/status_list";return c.length?e.resolve(c):o.getJSON(r).then(function(t){c=t.results,e.resolve(c)},function(t){e.reject(t)}),e.promise};var d=[];i.fetchMaintenanceReasons=function(){var e=t.defer(),r="api/maintenance_reasons";return d.length?e.resolve(d):o.getJSON(r).then(function(t){d=t.maintenance_reasons,e.resolve(d)},function(t){e.reject(t)}),e.promise},i.getRoomLog=function(e){var r=t.defer(),s="/api/room_actions/"+e.id+"/?page="+e.page+"&per_page="+e.per_page;return o.getJSON(s).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},i.getRoomServiceStatus=function(e){var r=t.defer(),s="/api/room_services/service_info.json?",a=tzIndependentDate(e.from_date),i=a.getFullYear(),u=a.getMonth(),l=tzIndependentDate(new Date(i,u+2,1));return e.to_date=n("date")(l,"yyyy-MM-dd"),o.getJSON(s,e).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},i.postRoomServiceStatus=function(e){var r=t.defer(),s="api/room_services";return o.postJSON(s,e).then(function(t){l(e),r.resolve(t)},function(e){r.reject(e)}),r.promise},i.checkWhetherRoomStatusChangePossible=function(e){var r=t.defer(),s="/api/room_services/check_room_locked_or_assigned";return o.postJSON(s,e).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},i.postCheckOutReservation=function(e){var r=t.defer(),s="api/reservations/"+e.id+"/checkout_from_house_keeping";return o.postJSON(s,e).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},i.putRoomServiceStatus=function(e){var r=t.defer(),s="api/room_services/"+e.room_id;return o.putJSON(s,e).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},i.putRoomInService=function(e){var r=t.defer(),s="api/room_services/"+e.room_id,n={room_service_status_id:e.inServiceID,from_date:e.from_date,to_date:e.to_date};return o.putJSON(s,n).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise};var m=[];i.getWorkTypes=function(){var e=t.defer(),r="api/work_types";return m.length?e.resolve(m):o.getJSON(r).then(function(t){m=t.results,e.resolve(m)},function(t){e.reject(t)}),e.promise},i.postRecordTime=function(e){var r=t.defer(),s="/api/work_assignments/record_time";return o.postJSON(s,e).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},i.fetchRoomStatus=function(e){var r={from_date:n("date")(tzIndependentDate(new Date(e.year,e.month-1,1)),"yyyy-MM-dd"),to_date:n("date")(tzIndependentDate(new Date(e.year,e.month+1,1)),"yyyy-MM-dd"),room_id:e.room_id},s=t.defer(),a="/api/room_services/service_info.json?";return o.getJSON(a,r).then(function(e){s.resolve({service_status:e.service_status})},function(e){s.reject(e)}),s.promise},i.changeHouseKeepingStatus=function(e){var r=t.defer(),s="house/change_fo_status.json";return o.postJSON(s,e).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise}}]),angular.module("sntRover").service("RVHkRoomStatusSrv",["$http","$q","rvBaseWebSrvV2","$window","BaseWebSrvV2","$rootScope","$vault",function(e,t,o,r,s,n,a){this.initFilters=function(){return{dirty:!1,pickup:!1,clean:!1,inspected:!1,out_of_order:!1,out_of_service:!1,exclude_out_of_order:!1,exclude_out_of_service:!1,vacant:!1,occupied:!1,stayover:!1,not_reserved:!1,arrival:!1,arrived:!1,dueout:!1,departed:!1,dayuse:!1,queued:!1,lateCheckout:!1,pre_checkin:!1,floorFilterSingle:"",floorFilterStart:"",floorFilterEnd:"",showAllFloors:!0,filterByWorkType:"",filterByEmployeeName:"",singleRoomType:"",query:"",page:1,perPage:r.innerWidth<599?25:50}},this.currentFilters=this.initFilters(),this.isInitialLoad=!0,this.defaultViewState=null;var i=this,u=function(e){var t=this.currentFilters,o=[],r=[],s=[],a=[],i=[],u=!1,l=!1,c={page:t.page,per_page:t.perPage};return t.query?(c.query=t.query,e.assignee_id?c.assignee_id=e.assignee_id:c.all_employees_selected=!0):((e.isStandAlone||n.isStandAlone)&&(this.isInitialLoad?(this.isInitialLoad=!1,e.work_type_id&&(c.work_type_id=e.work_type_id,t.filterByWorkType=e.work_type_id),e.assignee_id?(c.assignee_id=e.assignee_id,t.filterByEmployeeName=e.assignee_id):c.all_employees_selected=!0):(t.filterByWorkType&&(c.work_type_id=t.filterByWorkType),t.filterByEmployeeName?c.assignee_id=t.filterByEmployeeName:c.all_employees_selected=!0)),t.showAllFloors||(u=t.floorFilterStart||t.floorFilterSingle,l=t.floorFilterEnd||t.floorFilterSingle),_.each(this.roomTypes,function(e){e.isSelected&&i.push(e.id)}),t.vacant&&o.push("VACANT"),t.occupied&&o.push("OCCUPIED"),t.queued&&o.push("QUEUED"),t.lateCheckout&&o.push("LATE_CHECKOUT"),t.pre_checkin&&o.push("PRE_CHECKIN"),t.stayover&&r.push("STAY_OVER"),t.not_reserved&&r.push("NOT_RESERVED"),t.arrival&&r.push("ARRIVAL"),t.arrived&&r.push("ARRIVED"),t.dayuse&&r.push("DAY_USE"),t.dueout&&r.push("DUE_OUT"),t.departed&&r.push("DEPARTED"),t.dirty&&s.push("DIRTY"),t.clean&&s.push("CLEAN"),t.inspected&&s.push("INSPECTED"),t.pickup&&s.push("PICKUP"),t.out_of_order&&s.push("OUT_OF_ORDER"),t.out_of_service&&s.push("OUT_OF_SERVICE"),t.exclude_out_of_order&&a.push("OUT_OF_ORDER"),t.exclude_out_of_service&&a.push("OUT_OF_SERVICE"),o.length&&(c.reservation_status=o),r.length&&(c.front_office_status=r),s.length&&(c.house_keeping_status=s),a.length&&(c.exclude_service_status=a),i.length&&(c.room_type_ids=i),u&&(c.floor_start=u),l&&(c.floor_end=l)),c}.bind(this),l={};this.fetchRoomListPost=function(e){var o=t.defer(),r="/house/search.json",n=u(e);return s.postJSON(r,n).then(function(e){l=e.data,l.summary=e.data.summary;var t=a.get("LAST_ROOM_SERVICE");t=t?JSON.parse(t):{rooms:[],status:{}};var r,s;for(r=0,s=l.rooms.length;r<s;r++){var n=l.rooms[r];n.description=n.hk_status.description,n.is_occupied="true"===n.is_occupied,n.is_vip="true"===n.is_vip,i.setRoomStatusClass(n),i.setReservationStatusClass(n),n.timeOrIn=h(n),n.timeOrOut=p(n),n.assigned_staff=f(n),n.ooOsTitle=v(n),t.rooms.length&&_.indexOf(t.rooms,n.id)>-1&&(n.service_status=$.extend({},n.service_status,t.status))}o.resolve(l)},function(e){o.reject(e)}),o.promise},this.fetchPayload=function(e){function o(e){d=e;var t={date:n.businessDate,employee_ids:[n.userId]};n.isMaintenanceStaff?this.fetchWorkAssignments(t).then(r.bind(this)):s.call(this)}function r(e){var t=e.employees.length&&e.employees[0]||null,o=t&&t.room_tasks&&t.room_tasks.length||!1;o?l=n.userId:(l=!1,u=!1),m=e,s.call(this)}function s(){u&&(c.work_type_id=u),l&&(c.assignee_id=l),_.extend(e,c,{initialLoad:!0}),this.fetchRoomListPost(e).then(a,function(e){i.reject(e)})}function a(e){var t={roomList:e,workTypes:d,assignments:m};i.resolve(t)}var i=t.defer(),e=e,u=!1,l=!1,c={},d={},m={};return e.isStandAlone||n.isStandAlone?this.fetchWorkTypes().then(o.bind(this)):s.call(this),i.promise};var c=[];this.fetchFloors=function(){var e=t.defer(),o="/api/floors.json";return c.length?e.resolve(c):s.getJSON(o).then(function(t){c=t.floors,e.resolve(c)},function(t){e.reject(t)}),e.promise},this.roomTypes=[],this.fetchRoomTypes=function(){var e="api/room_types?exclude_pseudo=true",o=t.defer();return i.roomTypes.length?o.resolve(i.roomTypes):s.getJSON(e).then(function(e){this.roomTypes=e.results,angular.forEach(this.roomTypes,function(e,t){e.isSelected=!1}),o.resolve(this.roomTypes)}.bind(this),function(e){o.reject(e)}),o.promise},this.resetRoomTypes=function(){return angular.forEach(this.roomTypes,function(e,t){e.isSelected=!1}),this.roomTypes},this.allRoomTypes=[],this.fetchAllRoomTypes=function(){var e="api/room_types",o=t.defer();return i.allRoomTypes.length?o.resolve(i.allRoomTypes):s.getJSON(e).then(function(e){this.allRoomTypes=e.results,angular.forEach(this.allRoomTypes,function(e,t){e.isSelected=!1}),o.resolve(this.allRoomTypes)}.bind(this),function(e){o.reject(e)}),o.promise};var d=[];this.fetchHKEmps=function(e){var o="/api/work_statistics/employees_list",r=t.defer();return d.length?r.resolve(d):s.getJSON(o,e).then(function(e){d=e.results,r.resolve(d)},function(e){r.reject(e)}),r.promise},this.checkRoomAssigned=function(e){var o="/house/search.json",r=t.defer();return s.getJSON(o,e).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.fetchActiveWorksheetEmp=function(){var e="/api/work_sheets/active",o=t.defer();return s.getJSON(e).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise};var m=[];this.fetchWorkTypes=function(){var e=t.defer(),o="api/work_types";return m.length?e.resolve(m):s.getJSON(o).then(function(t){m=t.results,e.resolve(m)},function(t){e.reject(t)}),e.promise},this.fetchWorkAssignments=function(e){var o=t.defer(),r="api/work_assignments/assigned_rooms";return s.postJSON(r,e).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.fetchHkStatusList=function(){var e=t.defer(),o="api/rooms/hk_status_list";return s.getJSON(o).then(function(t){e.resolve(t)},function(t){e.reject(t)}),e.promise},this.putHkStatusChange=function(e){var o=t.defer(),r="house/mass_change_hk_status";return s.putJSON(r,e).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.fetchAllRoomIDs=function(){var e=t.defer(),o="/house/room_ids_list";return s.getJSON(o).then(function(t){e.resolve(t.room_ids)},function(t){e.reject(t)}),e.promise},this.toggleFilter=function(e){this.currentFilters[e]=!this.currentFilters[e]},this.isListEmpty=function(){return!(l&&l.rooms&&l.rooms.length)},this.setRoomStatusClass=function(e){var t;if(t=e.hasOwnProperty("service_status")?"OUT_OF_SERVICE"===e.service_status.value||"OUT_OF_ORDER"===e.service_status.value:"OO"===e.hk_status.value||"OS"===e.hk_status.value||2===e.room_reservation_hk_status||3===e.room_reservation_hk_status,t||"true"!==l.checkin_inspected_only){if(!t){if("CLEAN"===e.hk_status.value||"INSPECTED"===e.hk_status.value)return void(e.roomStatusClass="clean");if("PICKUP"===e.hk_status.value)return void(e.roomStatusClass="pickup")}}else{if("INSPECTED"===e.hk_status.value)return void(e.roomStatusClass="clean");if("CLEAN"===e.hk_status.value||"PICKUP"===e.hk_status.value)return void(e.roomStatusClass="pickup")}if("DIRTY"===e.hk_status.value&&!t)return void(e.roomStatusClass="dirty");if("DO_NOT_DISTURB"===e.hk_status.value)return void(e.roomStatusClass="dnd");if(t){if(e.roomStatusClass="out",e.hk_status.oo_status){if("true"===l.checkin_inspected_only){if("INSPECTED"===e.hk_status.oo_status)return void(e.roomStatusClassWithOO="clean");if("CLEAN"===e.hk_status.oo_status||"PICKUP"===e.hk_status.oo_status)return void(e.roomStatusClassWithOO="pickup")}else{if("CLEAN"===e.hk_status.oo_status||"INSPECTED"===e.hk_status.oo_status)return void(e.roomStatusClassWithOO="clean");if("PICKUP"===e.hk_status.oo_status)return void(e.roomStatusClassWithOO="pickup")}if("DIRTY"===e.hk_status.oo_status)return void(e.roomStatusClassWithOO="dirty")}}else;},this.setReservationStatusClass=function(e){switch(e.room_reservation_status){case"Due out":e.leaveStatusClass="check-out",e.enterStatusClass="no-show";break;case"Stayover":e.leaveStatusClass="inhouse",e.enterStatusClass="no-show";break;case"Departed":e.leaveStatusClass="check-out",e.enterStatusClass="no-show";break;case"Arrival":e.leaveStatusClass="no-show",e.enterStatusClass="check-in";break;case"Arrived":e.leaveStatusClass="no-show",e.enterStatusClass="check-in";break;case"Due out / Arrival":e.leaveStatusClass="check-out",e.enterStatusClass="check-in";break;case"Departed / Arrival":e.leaveStatusClass="check-out",e.enterStatusClass="check-in";break;case"Arrived / Departed":e.leaveStatusClass="check-out",e.enterStatusClass="check-in";break;case"Due out / Departed":e.leaveStatusClass="check-out",e.enterStatusClass="check-out";break;case"Arrived / Day use / Due out":e.leaveStatusClass="check-out",e.enterStatusClass="no-show";break;case"Arrived / Day use / Due out / Departed":e.leaveStatusClass="check-out",e.enterStatusClass="check-out";break;default:e.leaveStatusClass="no-show",e.enterStatusClass="no-show"}"true"===e.is_late_checkout&&(e.leaveStatusClass="late-check-out")},this.setRoomStatus=function(e,t,o){var r=_.find(l.rooms,function(t){return parseInt(t.id)===e});r[t]=o,r.ooOsTitle=v(r),this.setRoomStatusClass(r)},this.setWorkStatus=function(e,t){var o=_.find(l.rooms,function(t){return parseInt(t.id)===e});o.hk_status.description=t.description,o.description=o.hk_status.description,o.hk_status.value=t.value,this.setRoomStatusClass(o)};var h=function(e){return e.room_reservation_status.indexOf("Arrived")>=0&&!(e.room_reservation_status.indexOf("Day use")>=0)?"IN":e.room_reservation_status.indexOf("Arrival")>=0?e.arrival_time:""},p=function(e){return e.room_reservation_status.indexOf("Departed")>=0?"OUT":e.room_reservation_status.indexOf("Due out")>=0?"true"===e.is_late_checkout?e.late_checkout_time:e.departure_time:""},f=function(e){if(!n.isStandAlone)return!1;var t={name:"Unassigned",class:"unassigned"};return e.canAssign=!0,e.room_tasks&&e.room_tasks.length&&(e.canAssign=!1,t.class="assigned",_.unique(_.pluck(_.pluck(e.room_tasks,"assignee_maid"),"id")).length>1?t.name="Multiple Assignees":t.name=e.room_tasks[0].assignee_maid.name),t};this.calculateAssignedStaff=f;var v=function(e){return e.hasOwnProperty("service_status")?"OUT_OF_SERVICE"===e.service_status.value?"Out of Service":"OUT_OF_ORDER"===e.service_status.value?"Out of Order":"":n.isStandAlone?2===e.room_reservation_hk_status?"Out of Service":3===e.room_reservation_hk_status&&"Out of Order":"OS"===e.hk_status.value?"Out of Service":"OO"===e.hk_status.value&&"Out of Order"}}]),angular.module("sntRover").service("RVHkDashboardSrv",["RVBaseWebSrv","$q","$window",function(e,t,o){this.fetch=function(){var o=t.defer(),r="/house/dashboard.json";return e.getJSON(r).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise}}]),angular.module("sntRover").service("RVWorkManagementSrv",["$q","rvBaseWebSrvV2",function(e,t){function o(e,t){var o=[];return o.concat(e.rooms,t.rooms)}function r(e,t,o){var r,s,a,i,u,l,c,d,m,h,p,f,v,t=t||[],e=$.extend({},{rooms:[],room_tasks:[]},e),S=e.rooms,g=e.room_tasks,k=[];for(r=0,s=S.length;r<s;r++)g[r].tasks.length&&(u=_.findIndex(o,function(e){return e.id==S[r].id}),l=$.extend({},{room_id:S[r].id},{room_type:S[r].room_type},{is_vip:S[r].is_vip},{room_index:u},{room_tasks:[]}),k.push(l));for(r=0,s=g.length;r<s;r++)if(g[r].tasks.length)for(c=g[r].room_id,m=g[r].tasks,h=_.find(k,{room_id:c}),p=o[h.room_index].room_type,f=o[h.room_index].room_no,a=0,i=m.length;a<i;a++)v=_.find(t,{id:m[a].id}),d=$.extend({},m[a],{task_name:v.name,work_type_id:v.work_type_id,work_type_name:v.work_type_name,time_allocated:n(v,p)},{room_id:c,room_no:f}),h.room_tasks.push(d);return k}function s(e,t,o){var r,s,a,i,u,l,c,d,m,h,p,f,v,S,g,k,t=t||[],e=$.extend({},{employees:[],rooms:[]},e),y=e.employees,D=e.rooms,w=[],R=function(e){var t=_.find(D,{id:e});return t?t:{room_type:"",is_vip:null}};for(r=0,s=y.length;r<s;r++){var T=y[r].name.split(" "),O=T.shift();for(T=O.charAt(0)+". "+T.join(" "),d=$.extend({},{id:y[r].id,name:y[r].name},{display_name:T},{rooms:[]},{only_tasks:[]},{touched_work_types:[]},{shift_id:y[r].shift_id}),m=y[r].room_tasks,a=0,i=m.length;a<i;a++)for(c=_.findIndex(o,function(e){return e.id==m[a].room_id}),k=R(m[a].room_id),h=$.extend({},{room_id:m[a].room_id},{room_type:k.room_type},{is_vip:k.is_vip},{room_index:c},{room_tasks:[]}),d.rooms.push(h),p=m[a].tasks,S=o[c].room_type,g=o[c].room_no,u=0,l=p.length;u<l;u++)f=_.find(t,{id:p[u].id}),v=$.extend({},p[u],{task_name:f.name,work_type_id:f.work_type_id,work_type_name:f.work_type_name,time_allocated:n(f,S)},{room_id:m[a].room_id,room_no:g}),d.touched_work_types.push([v.work_type_id]),d.rooms[a].room_tasks.push(v),d.only_tasks.push(v);d.touched_work_types=_.uniq(_.flatten(d.touched_work_types)),w.push(d)}return w}function n(e,t){var o="",r=0,s=0;return e.room_types_completion_time&&e.room_types_completion_time.hasOwnProperty(t)&&e.room_types_completion_time[t]?o=e.room_types_completion_time[t]:e.completion_time&&(o=e.completion_time),o.indexOf(":")>-1&&(r=o.split(":")[0],s=o.split(":")[1]),{hh:isNaN(parseInt(r))?0:parseInt(r),
mm:isNaN(parseInt(s))?0:parseInt(s)}}function a(e,t,o){var r=$.extend({},{date:t},{work_types:[]});_.each(e,function(e){var t=e.touched_work_types;_.each(t,function(e){var t,o=_.find(r.work_types,{id:e});o||(t={id:e,assignments:[]},r.work_types.push(t))})});var s,n,a,i,u;return _.each(r.work_types,function(t,o){s=t.id,_.each(e,function(e){n=_.find(e.touched_work_types,function(e){return s==e}),a={employee_id:e.id,tasks:[]},n&&(i=_.where(e.only_tasks,{work_type_id:s}),_.each(i,function(e,t){u={id:e.id,room_id:e.room_id,order:e.order||null},a.tasks.push(u)})),r.work_types[o].assignments.push(a)})}),r}this.fetchMaids=function(o){var r=e.defer(),s="api/work_statistics/employees_list";return o=o||{},t.getJSON(s,o).then(function(e){_.each(e.results,function(e){e.ticked=!1,e.checkboxDisabled=!1}),r.resolve(e.results)},function(e){r.reject(e)}),r.promise},this.fetchWorkTypes=function(){var o=e.defer(),r="api/work_types";return t.getJSON(r).then(function(e){o.resolve(e.results)},function(e){o.reject(e)}),o.promise},this.fetchShifts=function(){var o=e.defer(),r="api/shifts";return t.getJSON(r).then(function(e){_.each(e.results,function(e){e.display_name=e.name+"("+e.time+")"}),o.resolve(e.results)},function(e){o.reject(e)}),o.promise},this.fetchStatistics=function(o){var r=e.defer(),s="/api/work_statistics?date="+o.date;return t.getJSON(s).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.createWorkSheet=function(o){var r=e.defer(),s="api/work_sheets";return t.postJSON(s,o).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.fetchWorkSheet=function(o){var r=e.defer(),s="api/work_sheets/"+o.id;return t.getJSON(s).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.deleteWorkSheet=function(o){var r=e.defer(),s="api/work_sheets/"+o.id;return t.deleteJSON(s).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.fetchWorkSheetDetails=function(t){var o=e.defer();return o.resolve([]),o.promise},this.saveWorkSheet=function(o){var r=e.defer(),s="api/work_assignments/assign";return t.postJSON(s,o).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.searchEmployees=function(o){var r=e.defer(),s="/api/work_statistics/employee?query="+o.key+"&date="+o.date;return o.workType&&(s+="&work_type_id="+o.workType),t.getJSON(s).then(function(e){r.resolve(e.results)},function(e){r.reject(e)}),r.promise},this.searchRooms=function(o){var r=e.defer(),s="/house/search.json?query="+o.key+"&date="+o.date;return t.getJSON(s).then(function(e){r.resolve(e.data.rooms)},function(e){r.reject(e)}),r.promise},this.fetchAllUnassigned=function(t){var o=e.defer();"api/work_assignments/unassigned_rooms?date="+t.date;return o.resolve([]),o.promise},this.fetchHKStaffs=function(o){var r=e.defer(),s="api/work_statistics/employees_list";o=o||{};var n=function(e){var t,o=[],r=[];return _.each(e.results,function(e){r.push(e.id),t=$.extend({},e,{ticked:!1},{checkboxDisabled:!1}),o.push(t)}),{results:o,emp_ids:r}};return t.getJSON(s,o).then(function(e){r.resolve(n(e))},function(e){r.reject(e)}),r.promise},this.fetchAllTasks=function(){var o=e.defer(),r="api/tasks";return t.getJSON(r).then(function(e){o.resolve(e.results)},function(e){o.reject(e)}),o.promise},this.fetchUnassignedRoomTasks=function(o){var r=e.defer(),s="api/work_assignments/unassigned_rooms";return t.postJSON(s,o).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.fetchAssignedRoomTasks=function(o){var r=e.defer(),s="api/work_assignments/assigned_rooms";return t.postJSON(s,o).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.payload={},this.processedPayload=function(t,n){var a,i,a,u,l,c=e.defer(),d=[];return d.push(this.fetchAllTasks()),d.push(this.fetchUnassignedRoomTasks(t)),d.push(this.fetchAssignedRoomTasks(n)),e.all(d).then(function(e){i=e[0],a=e[1],u=e[2],l=o(a,u),this.payload={allTasks:i,allRooms:l,unassignedRoomTasks:r(a,i,JSON.parse(JSON.stringify(l))),assignedRoomTasks:s(u,i,JSON.parse(JSON.stringify(l)))},c.resolve(this.payload)}.bind(this),function(e){c.reject(e)}),c.promise},this.getRoomDetails=function(e){return this.payload.allRooms[e]},this.saveWorkSheets=function(o){var r=e.defer(),s="api/work_assignments/assign",n=a(o.assignedRoomTasks,o.date,o.shouldSaveOrder);return t.postJSON(s,n).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.sortAssigned=function(e,t,o,r){var s,n,a,i,u,l,c,d=e.length,m=function(e,t){var o=_.find(e,{room_id:t});return angular.isDefined(o)?o:{room_type:"",is_vip:null}};for(n=0;n<d;n++)s=e[n],"room"===r.grouping?(s.rooms=_.sortBy(s.rooms,function(e){return t[e.room_index].room_no}),"desc"===r.sort&&s.rooms.reverse()):(a=_.flatten(_.pluck(s.rooms,"room_tasks")),i=[],a=_.sortBy(a,function(e){return e.task_name.toLowerCase()}),"desc"===r.sort&&a.reverse(),_.each(a,function(e){u=_.findIndex(t,{id:e.room_id}),c=m(s.rooms,e.room_id),l=$.extend({},{room_id:e.room_id},{room_type:c.room_type},{is_vip:c.is_vip},{room_index:u},{room_tasks:[e]}),i.push(l)}),s.rooms=i);return e},this.executeAutoAssign=function(o){var r=e.defer(),s="api/work_assignments/auto_assign";return t.postJSON(s,o).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.resetWorkAssignments=function(o){var r=e.defer(),s="api/work_assignments/reset";return t.postJSON(s,o).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise}}]),angular.module("sntRover").service("rvUtilSrv",["$filter","$rootScope",function(e,t){var o=this,r=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];this.deepCopy=function(e){return JSON.parse(JSON.stringify(e))},this.escapeNull=function(e,t){var o="";"undefined"!=typeof t&&null!==t&&(o=t);var r=null===e||"undefined"==typeof e?o:e;return r},this.isEmpty=function(e){return"number"==typeof e&&(e=e.toString()),""===this.escapeNull(e).trim()},this.stringify=function(e){return JSON.stringify(e)},this.getDatesBetweenTwoDates=function(e,t){for(var o=[];e<=t;)o.push(new Date(e)),e.setDate(e.getDate()+1);return o},this.getFormattedDatesBetweenTwoDates=function(t,o){for(var r=[],s=new Date(t);s<=o;)r.push(e("date")(s,"yyyy-MM-dd")),s.setDate(s.getDate()+1);return r},this.getDayBetweenTwoDates=function(e,t){for(var o=[],r=new Date(e);r<=t;)o.push(r.getDate()),r.setDate(r.getDate()+1);return o},this.getMonthFromDateString=function(e){return new Date(e).getMonth()},this.toMilliSecond=function(e){var t=typeof e,o="";switch(t){case"string":o=new tzIndependentDate(e);break;case"object":o=e.getTime()}return o},this.addOneDay=function(e){return this.toMilliSecond(e)+864e5},this.getListOfKeyValuesFromAnArray=function(e,t){var o,r=[];return _.each(e,function(e){o={},_.each(t,function(t){o[t]=e[t]}),r.push(o)}),r},this.isNumeric=function(e){return!jQuery.isArray(e)&&e-parseFloat(e)+1>=0},this.convertToInteger=function(e,t){return t=t?t:0,o.isNumeric(e)?parseInt(e):t},this.convertToDouble=function(e,t){return t=t?t:0,o.isNumeric(e)?parseFloat(e):t},this.get_date_from_date_picker=function(e,t){return"undefined"==typeof t&&(t="/"),e.selectedYear+t+(e.selectedMonth+1)+t+e.selectedDay},this.getFirstDayOfNextMonth=function(e){var e=new tzIndependentDate(e),t=e.getFullYear(),o=e.getMonth();return tzIndependentDate(new Date(t,o+1,1))},this.getListForTimeSelector=function(e,t){var o=[],r=0,s=0,n=0,a=null,i="",u="";for(_.isUndefined(t)&&(t=12),_.isUndefined(e)&&(e=15);r<1440;r+=e)s=Math.floor(r/60),n=r%60,n<10&&(n="0"+n),a=s%24<12?"AM":"PM",i=(s<10?"0"+s:s)+":"+n,s%=t,(0===s&&12===t||0===s&&24===t&&r<=60)&&(s=12),u=s+":"+n,12===t&&(u+=" "+a),o.push({value:i,text:u});return o},this.checkDevice={any:function(){return!!navigator.userAgent.match(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i)},iOS:function(){return!!navigator.userAgent.match(/iPhone|iPad|iPod/i)},android:function(){return navigator.userAgent.match(/Android/i)}},this.roundToNextQuarter=function(e,t){var o=(t>45?++e%24:e).toString(),r=(15*((t+14)/15|0)%60).toString();return(2===o.length?o:"0"+o)+":"+(2===r.length?r:"0"+r)},this.isEmailValid=function(e){return e=_.isUndefined(e)||_.isNull(e)?"":e,e=e.replace(/\s+/g,""),/^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/.test(e)},this.retrieveFeatureDetails=function(e,t){var o=_.find(e,function(e){return e.feature_name===t});return o},this.generateTimeDuration=function(e,t,o){var r=15,s=0,n=1440-r,a=["AM","PM"],i=[],u="",l="",c="",d="",m={},o=o||0;e&&(s=60*e.split(":")[0]+1*e.split(":")[1]+1*o),t&&(n=60*t.split(":")[0]+1*t.split(":")[1]+1*o);for(var h=0;s<=n;h++)c=Math.floor(s/60),d=s%60,u=("00"===("0"+c%12).slice(-2)?"12":("0"+c%12).slice(-2))+":"+("0"+d).slice(-2)+" "+a[Math.floor(c/12)],l=("0"+c).slice(-2)+":"+("0"+d).slice(-2),m={12:u,24:l},i.push(m),s+=r;return i},this.extractHhMmAmPm=function(e){var t=parseInt(e.split(" ")[0].split(":")[0]),o=t>=12?"PM":"AM";return{ampm:o,hh:"00"===("0"+t%12).slice(-2)?"12":("0"+t%12).slice(-2),mm:e.split(" ")[0].split(":")[1]}},this.convertTimeHhMmAmPmTo24=function(e){var t=e.hh,o=e.mm,r=e.ampm;return"12"===t&&(t="00"),"PM"===r&&(t=parseInt(t,10)+12),t+":"+o},this.getDiaryMode=function(){var e="FULL",o=t.hotelDiaryConfig;return o.hourlyRatesForDayUseEnabled?"LIMITED"===o.mode&&(e="DAYUSE"):e="NIGHTLY",e},this.isWeekendDay=function(e,t){return _.contains(e,r[t.getDay()])},this.countryFlagLangMap={EN:"us",ES:"es",DE:"de",NL:"nl",FR:"fr",IT:"it"},this.translatableLangs=["EN","ES","FR"],this.langNameTranslations={EN:"English",DE:"Deutsch",FR:"Français",ES:"Español",JA:"日本",ZH:"中国人",NL:"Nederlands",IT:"Italiano",FI:"Suomalainen",SV:"Svenska",NN:"Norsk",DA:"Dansk",IS:"Íslensku",TR:"Türk",AR:"عربي",PT:"Português",PL:"Polskie",HU:"Magyar",BG:"български",TL:"Tagalog",CS:"Čeština",SK:"Slovensky",ET:"Eestlane",RO:"Română",UK:"Українська",SL:"Slovenščina",HR:"Hrvatski",SR:"Српски",EL:"Ελληνικά",TH:"ไทย",YUE:"粵語",CMN:"普通话",ID:"Indonesia",VI:"Tiếng Việt",KO:"한국인",HI:"हिंदी",RU:"Pусский",LV:"Latvietis",MS:"Melayu"}}]);