"use strict";sntRover.controller("companyCardCommissionsCtrl",["$scope","$state","$rootScope","$stateParams","RVCompanyCardSrv","ngDialog","$timeout","rvPermissionSrv","rvUtilSrv","$window","$vault","sntActivity",function(t,a,e,n,o,r,i,c,s,l,d,u){BaseCtrl.call(this,t);var m=function(){var a={};return t.filterData.fromDate&&(a.from_date=t.filterData.fromDate),t.filterData.toDate&&(a.to_date=t.filterData.toDate),a.paid_status=t.filterData.paidStatus,a.commission_status=t.filterData.commissionStatus,a.per_page=t.filterData.perPage,a.page=t.filterData.page,a.hotel_id=parseInt(t.filterData.selectedHotel),a};t.setScroller("commission-list");var f=function(){i(function(){t.refreshScroller("commission-list")},3e3)};f(),t.$on("commissionsTabActive",function(){v(!0)});var p=function(a){t.filterData.page=a||1,v(!0)},v=function(a){var e=function(){t.filterData.commissionsLoaded||"COMMISION_SUMMARY"!==n.origin||u.stop("NAVIGATING_TO_TA_COMMISSIONS")},r=function(a){_.each(a.commission_details,function(t,a){_.extend(t,{is_checked:!1})}),t.currencySymbol=a.currency.symbol,t.commissionDetails=a.commission_details,t.commissionSummary.totalCommissionableRevenue=a.total_commissionable_revenue,t.commissionSummary.totalReservationsRevenue=a.total_reservations_revenue,t.commissionSummary.totalCommission=a.total_commission-a.total_commission_unpaid,t.commissionSummary.totalUnpaidCommission=a.total_commission_unpaid,t.commissionSummary.taxOnCommissions=a.tax_on_commissions,t.pagination.totalResultCount=a.total_count,i(function(){t.$broadcast("updatePagination",t.paginationData.id)},1e3),t.$emit("hideLoader"),f(),e(),t.filterData.commissionsLoaded=!0,C()},c=function(a){t.$emit("hideLoader"),t.commissionDetails=[],t.commissionSummary={},e()},s={};s.params=m(),s.accountId=t.accountId,"add"!==t.accountId&&t.invokeApi(o.fetchTACommissionDetails,s,r,c)};t.hasPermissionToEditPaid=function(){return c.getPermissionValue("EDIT_COMMISSIONS_TAB")},t.goToStayCard=function(n,o){e.hotelDetails.userHotelsData.current_hotel_id===parseInt(t.filterData.selectedHotel)&&a.go("rover.reservation.staycard.reservationcard.reservationdetails",{id:n,confirmationId:o,isrefresh:!0,isFromTACommission:!0},{reload:!0})},t.clearToDateField=function(){t.filterData.toDate="",t.onFilterChange()},t.clearFromDateField=function(){t.filterData.fromDate="",t.onFilterChange()},t.shouldShowPagination=function(){return t.commissionDetails.length>0&&t.pagination.totalResultCount>t.filterData.perPage},t.$on("fromDateChanged",function(){t.onFilterChange()}),t.$on("toDateChanged",function(){t.onFilterChange()}),t.onFilterChange=function(){t.selectedCommissions=[],t.prePaidCommissions=[],v(!0)},t.clickedFromDate=function(){t.popupCalendar("FROM")},t.clickedToDate=function(){t.popupCalendar("TO")},t.popupCalendar=function(a){t.clickedOn=a,r.open({template:"/assets/partials/companyCard/contracts/rvCompanyCardContractsCalendar.html",controller:"RVCommissionsDatePickerController",className:"",scope:t})};var h=function(a){var e=0,n=0,o=0;a.forEach(function(t){isEmptyObject(t.commission_data)||("Unpaid"===t.commission_data.paid_status||"On Hold"===t.commission_data.paid_status?e+=t.commission_data.amount:o+=t.commission_data.amount),n+=t.commissionable_revenue}),t.commissionSummary.totalUnpaidCommission=e,t.commissionSummary.totalRevenue=n,t.commissionSummary.totalCommission=o};t.onCheckBoxSelection=function(a){if(t.filterData.commssionRecalculationValue="",a.is_checked?"Prepaid"==a.commission_data.paid_status?t.prePaidCommissions.push(a):t.selectedCommissions.push(a):(t.selectedCommissions=_.filter(t.selectedCommissions,function(t){return t.reservation_id!=a.reservation_id}),t.prePaidCommissions=_.filter(t.prePaidCommissions,function(t){return t.reservation_id!=a.reservation_id}),t.filterData.selectAll=!1),0==t.selectedCommissions.length&&0==t.prePaidCommissions.length)v(!1),t.status.groupPaidStatus="";else{t.status.groupPaidStatus="";var e=t.selectedCommissions.concat(t.prePaidCommissions);h(e)}var n=_.every(t.commissionDetails,function(t){return t.is_checked});0===t.selectedCommissions.length&&0===t.prePaidCommissions.length?(t.filterData.selectAll=!1,t.toggleSelection()):n&&(t.filterData.selectAll=!0,t.toggleSelection())};var D=function(a){for(var e in t.commissionDetails)t.commissionDetails[e].is_checked=a};t.toggleSelection=function(){t.filterData.commssionRecalculationValue="",t.filterData.selectAll?(D(!0),t.selectedCommissions=Object.assign([],t.commissionDetails),t.prePaidCommissions=[],h(t.commissionDetails),t.status.groupPaidStatus=""):(D(!1),t.selectedCommissions=[],t.prePaidCommissions=[],v(!1),t.status.groupPaidStatus=""),t.isCommissionFilterTabOpened=!0};var y=function(a){var e=function(t){C(),v(!1)},n=function(t){C(),v(!1)};t.invokeApi(o.saveTACommissionDetails,a,e,n)},C=function(){t.selectedCommissions=[],t.prePaidCommissions=[],t.filterData.selectAll=!1};t.isTogglePaidStatusEnabled=function(){var a=!0;return t.contactInformation.is_global_enabled&&(a=!1,c.getPermissionValue("GLOBAL_CARD_UPDATE")&&(a=!0)),a},t.togglePaidStatus=function(a){var e={};e.reservation_id=a.reservation_id,e.status="Paid"==a.commission_data.paid_status?"Unpaid":"Paid";var n={};n.accountId=t.accountId,n.commissionDetails=[e],y(n)},t.toggleHoldStatus=function(a,e){if("Paid"==e.commission_data.paid_status||"Prepaid"==e.commission_data.paid_status)return t.errorMessage=["Only transactions on 'UNPAID' status can be set to On Hold"],void a.stopPropagation();var n={};n.reservation_id=e.reservation_id,n.status="On Hold"==e.commission_data.paid_status?"Unpaid":"On Hold";var o={};o.accountId=t.accountId,o.commissionDetails=[n],y(o)},t.onGroupPaidStatusChange=function(a){var e=[],n=!1;t.filterData.selectAll?t.commissionDetails.forEach(function(o){a&&"Unpaid"!=o.commission_data.paid_status&&"On Hold"!=o.commission_data.paid_status&&(n=!0),"Prepaid"!=o.commission_data.paid_status&&e.push({reservation_id:o.reservation_id,status:t.status.groupPaidStatus})}):t.selectedCommissions.forEach(function(o){a&&"Unpaid"!=o.commission_data.paid_status&&"On Hold"!=o.commission_data.paid_status&&(n=!0),"Prepaid"!=o.commission_data.paid_status&&e.push({reservation_id:o.reservation_id,status:t.status.groupPaidStatus})});var o={};o.accountId=t.accountId,o.commissionDetails=e,n?i(function(){t.errorMessage=["The hold status can be updated only for unpaid or on hold commissions"]},500):y(o)},t.showToggleButton=function(t){var a="Paid"==t.commission_data.paid_status||"Unpaid"==t.commission_data.paid_status;return a?{visibility:"visible"}:{visibility:"hidden"}};var g=function(){$("head").append("<style id='print-orientation'>@page { size: landscape; }</style>")},A=function(){$("#print-orientation").remove()};t.$on("CLEAR_ERROR_MESSAGE",function(){t.errorMessage=""}),t.clickedPrintButton=function(){g(),$("header .logo").addClass("logo-hide"),$("header .h2").addClass("text-hide");var t=function(){i(function(){$("header .logo").removeClass("logo-hide"),$("header .h2").addClass("text-hide"),A()},100)};i(function(){sntapp.cordovaLoaded?cordova.exec(t,function(a){t()},"RVCardPlugin","printWebView",["","0","","L"]):(l.print(),t())},100)},t.toggleCommission=function(){t.filterData.toggleCommission=!t.filterData.toggleCommission};var S=function(){var a=[];return t.filterData.selectAll?t.commissionDetails.forEach(function(t){"Prepaid"!=t.commission_data.paid_status&&a.push(t.reservation_id)}):t.selectedCommissions.forEach(function(t){"Prepaid"!=t.commission_data.paid_status&&a.push(t.reservation_id)}),a},b=function(){var a="percent";return t.filterData.toggleCommission&&(a="amount"),a};t.recalculationValueChanged=function(){isNaN(t.filterData.commssionRecalculationValue)&&(t.filterData.commssionRecalculationValue="")},t.clickedRecalculate=function(){var a=function(t){C(),i(function(){v(!1)},2e3)},e=function(a){t.errorMessage=a,t.$emit("hideLoader")},n={type:b(),value:t.filterData.commssionRecalculationValue,reservation_ids:S()};t.invokeApi(o.recalculateCommission,n,a,e)};var I=function(){var a=function(a){t.multiProperies=a.multi_properties,t.$emit("hideLoader")},e={};e.accountId="add"===t.accountId?t.contactInformation.id:t.accountId,t.invokeApi(o.fetchMultiProperties,e,a)};t.toggleFilter=function(){t.isCommissionFilterTabOpened=!t.isCommissionFilterTabOpened},t.$on("LOAD_SUBSCRIBED_MPS",function(){t.contactInformation.is_global_enabled&&e.isAnMPHotel&&c.getPermissionValue("GLOBAL_CARD_UPDATE")&&e.hotelDetails.userHotelsData.hotel_list.length>0&&c.getPermissionValue("MULTI_PROPERTY_SWITCH")?(t.shouldShowPropertyDropDown=!0,I()):(t.shouldShowPropertyDropDown=!1,T())}),t.onPropertyFilterChange=function(){e.hotelDetails.userHotelsData.current_hotel_id!==parseInt(t.filterData.selectedHotel)&&(t.filterData.commissionStatus="Commissionable"),t.onFilterChange()};var T=function(){t.commissionDetails=[],t.commissionSummary={},t.isCommissionFilterTabOpened=!0,t.shouldShowPropertyDropDown=!1,t.filterData={fromDate:n.fromDate,toDate:n.toDate,paidStatus:"Unpaid",commissionStatus:"Commissionable",perPage:25,page:1,start:1,selectAll:!1,toggleCommission:!1,commssionRecalculationValue:"",selectedHotel:parseInt(e.hotelDetails.userHotelsData.current_hotel_id),commissionsLoaded:!1},t.accountId="rover.reservation.staycard.reservationcard.reservationdetails"===a.current.name?t.travelAgentInformation.id:n.id,t.isEmpty=s.isEmpty,t.isEmptyObject=isEmptyObject,t.pagination={start:1,end:o.DEFAULT_PER_PAGE,totalResultCount:0},t.selectedCommissions=[],t.prePaidCommissions=[],t.status={groupPaidStatus:""},t.businessDate=e.businessDate,"cc-commissions"===t.currentSelectedTab&&v(!0),"rover.companycarddetails"===a.current.name&&(d.set("travelAgentId",n.id),d.set("travelAgentType",n.type),d.set("travelAgentQuery",n.query)),t.paginationData={id:"RESERVATION_LIST_"+t.accountId,api:p,perPage:t.filterData.perPage}};T()}]),angular.module("sntRover").controller("companyCardDetailsController",["$scope","RVCompanyCardSrv","rvCompanyCardContractsSrv","$state","$stateParams","ngDialog","$filter","$timeout","$rootScope","rvPermissionSrv","$interval","$log",function(t,a,e,n,o,r,i,c,s,l,d,u){t.isAddNewCard="add"===o.id,t.disableGlobalToggle=!t.isAddNewCard;var m=[];t.hasPermissionToViewCommissionTab=function(){return l.getPermissionValue("VIEW_COMMISSIONS_TAB")},t.hasPermissionToCreateArAccount=function(){return l.getPermissionValue("CREATE_AR_ACCOUNT")},t.isCommissionTabAvailable=t.hasPermissionToViewCommissionTab(),t.isDiscard=!1,t.isPromptOpened=!1,t.isLogoPrint=!0,t.isPrintArStatement=!1,t.contactInformation={},t.isGlobalToggleReadOnly=!l.getPermissionValue("GLOBAL_CARD_UPDATE");var f=!1;"COMPANY"===o.type?(t.isAddNewCard?t.heading=i("translate")("NEW_COMPANY_CARD"):t.heading=i("translate")("COMPANY_CARD"),t.cardTypeText=i("translate")("COMPANY"),t.dataIdHeader="company-card-header"):"TRAVELAGENT"===o.type&&(t.isAddNewCard?t.heading=i("translate")("NEW_TA_CARD"):t.heading=i("translate")("TA_CARD"),t.cardTypeText=i("translate")("TRAVELAGENT"),t.dataIdHeader="travel-agent-card-header"),t.setTitle(t.heading),t.$on("ARTransactionSearchFilter",function(a,e){t.isWithFilters=e});var p=function(){"rvAllotmentConfigurationCtrl"===s.previousState.controller?t.searchBackButtonCaption=i("translate")("ALLOTMENTS"):"rvGroupConfigurationCtrl"===s.previousState.controller?t.searchBackButtonCaption=i("translate")("GROUPS"):"rvAccountsConfigurationCtrl"===s.previousState.controller?t.searchBackButtonCaption=i("translate")("ACCOUNTS"):"AR_OVERVIEW"===o.origin?t.searchBackButtonCaption=i("translate")("MENU_ACCOUNTS_RECEIVABLES"):"COMMISION_SUMMARY"===o.origin?t.searchBackButtonCaption=i("translate")("MENU_COMMISIONS"):o.isMergeViewSelected?t.searchBackButtonCaption=i("translate")("MERGE_CARDS"):t.searchBackButtonCaption=i("translate")("FIND_CARDS")};s.$broadcast("viewFromCardsOutside"),p(),t.headerBackButtonClicked=function(){return"cc-contact-info"===t.currentSelectedTab?void I(t.contactInformation,!1,!0):("cc-contracts"===t.currentSelectedTab?t.$broadcast("saveContract"):"cc-ar-accounts"===t.currentSelectedTab&&t.$broadcast("saveArAccount"),void("COMMISION_SUMMARY"===o.origin?n.go("rover.financials.commisions"):n.go(s.previousState,s.previousStateParams)))},t.isContactInformationSaved=!1,BaseCtrl.call(this,t),t.currentSelectedTab="cc-contact-info","undefined"!=typeof o.type&&""!==o.type&&(t.account_type=o.type),t.companyCardClicked=function(a){a.stopPropagation(),getParentWithSelector(a,document.getElementById("cc-contact-info"))&&"cc-contact-info"===t.currentSelectedTab||getParentWithSelector(a,document.getElementById("cc-contracts"))&&"cc-contracts"===t.currentSelectedTab||(getParentWithSelector(a,document.getElementById("company-card-nested-first"))&&t.$emit("saveContactInformation"),getParentWithSelector(a,document.getElementById("cc-ar-accounts"))||t.$broadcast("saveArAccount"),t.$broadcast("CLEAR_ERROR_MESSAGE"))},t.$on("ERRORONARTAB",function(a){t.isArTabAvailable=!0,t.switchTabTo("","cc-ar-accounts")}),t.showArAccountButtonClick=function(a){t.switchTabTo(a,"cc-ar-accounts")},t.switchTabTo=function(a,e){void 0!==a&&""!==a&&(a.stopPropagation(),a.stopImmediatePropagation());var n=!!t.contactInformation&&!!t.contactInformation.account_details&&!!t.contactInformation.account_details.accounts_receivable_number;if("cc-contact-info"===t.currentSelectedTab&&"cc-contact-info"!==e){if(t.isAddNewCard&&!t.isContactInformationSaved)return t.errorMessage=["Please save "+t.cardTypeText+" card first"],void("COMPANY"===o.type?t.$broadcast("setCardContactErrorMessage",[i("translate")("COMPANY_SAVE_PROMPT")]):t.$broadcast("setCardContactErrorMessage",[i("translate")("TA_SAVE_PROMPT")]));"cc-ar-accounts"===e?t.showARTab():(I(t.contactInformation),t.$broadcast("ContactTabActivated"))}"cc-contracts"===t.currentSelectedTab&&"cc-contracts"!==e?t.$broadcast("saveContract"):"cc-ar-accounts"===t.currentSelectedTab&&"cc-ar-accounts"!==e&&t.$broadcast("saveArAccount"),"cc-ar-accounts"===e&&(t.$broadcast("arAccountTabActive"),t.$broadcast("refreshAccountsScroll")),"cc-contracts"===e&&t.$broadcast("refreshContractsScroll"),"cc-ar-transactions"===e&&n&&(s.$broadcast("arTransactionTabActive"),t.isWithFilters=!1),"cc-notes"===e&&t.$broadcast("fetchNotes"),"cc-contact-info"===e&&t.$broadcast("contactTabActive"),"cc-commissions"===e&&t.$broadcast("commissionsTabActive"),"cc-activity-log"===e&&t.$broadcast("activityLogTabActive"),"statistics"===e&&t.$broadcast("LOAD_STATISTICS"),"wallet"===e&&t.$broadcast("wallet"),"cc-ar-transactions"!==e||n?t.currentSelectedTab=e:console.warn("Save AR Account and Navigate to AR Transactions")},t.openCompanyTravelAgentCardMandatoryFieldsPopup=function(){t.shouldSaveArDataFromPopup=!1,r.open({template:"/assets/partials/companyCard/rvCompanyTravelAgentCardMandatoryFieldsPopup.html",className:"ngdialog-theme-default1 calendar-single1",controller:"companyTravelAgentMandatoryFieldsController",closeByDocument:!1,scope:t})},t.clickedCreateArAccountButton=function(){t.shouldShowARMandatoryPopup()?(f=!0,t.showARTab()):(t.isMandatoryPopupOpen=!0,t.openCompanyTravelAgentCardMandatoryFieldsPopup())},t.$on("UPDATE_MANDATORY_POPUP_OPEN_FLAG",function(){t.isMandatoryPopupOpen=!1}),t.showARTab=function(){I(t.contactInformation)},t.$on("saveArAccountFromMandatoryPopup",function(a,e){t.arAccountDetails=e,t.isArTabAvailable=!0,t.shouldSaveArDataFromPopup=!0,t.contactInformation.account_details.accounts_receivable_number=e.ar_number}),t.$on("UPDATE_AR_ACCOUNT_DETAILS_AFTER_DELETE",function(a,e){t.arAccountDetails=e}),o.isBackFromStaycard||(o.isMergeViewSelected?s.prevStateBookmarkDataFromAR={title:t.searchBackButtonCaption,name:s.previousState.name}:s.prevStateBookmarkDataFromAR={title:t.searchBackButtonCaption,name:s.previousState.name}),o.isBackFromStaycard&&(t.isArTabAvailable=!o.isBackToTACommission&&!o.isBackToStatistics,s.prevStateBookmarkDataFromAR.title!==i("translate")("FIND_CARDS")&&s.prevStateBookmarkDataFromAR.title!==i("translate")("MENU_ACCOUNTS_RECEIVABLES")||(s.setPrevState={title:s.prevStateBookmarkDataFromAR.title,name:s.prevStateBookmarkDataFromAR.name}),"undefined"==typeof t.contactInformation&&(t.contactInformation=angular.copy(s.prevStateBookmarkDataFromAR.contactInformation)),o.isBackToStatistics?(t.currentSelectedTab="statistics",t.$broadcast("LOAD_STATISTICS")):t.isArTabAvailable&&(c(function(){t.currentSelectedTab="cc-ar-transactions",t.$broadcast("setgenerateNewAutoAr",!0),t.switchTabTo("","cc-ar-transactions")},500),c(function(){t.$broadcast("BACK_FROM_STAY_CARD")},1e3))),o.isBackToTACommission&&(t.currentSelectedTab="cc-commissions"),t.$on("ARNumberChanged",function(a,e){t.contactInformation.account_details.accounts_receivable_number=e.newArNumber,t.isMandatoryPopupOpen&&(t.arAccountDetails.payment_due_days=null,t.arAccountDetails.ar_number=e.newArNumber,t.openCompanyTravelAgentCardMandatoryFieldsPopup())}),t.deleteArAccount=function(){t.errorMessage="",r.open({template:"/assets/partials/companyCard/rvCompanyCardDeleteARaccountPopup.html",className:"ngdialog-theme-default1 calendar-single1",closeByDocument:!1,scope:t})},t.deleteARAccountConfirmed=function(){var e=function(){t.$emit("hideLoader"),t.isArTabAvailable=!1,t.$broadcast("setgenerateNewAutoAr",!1),t.$broadcast("ArAccountDeleted"),t.contactInformation.account_details.accounts_receivable_number="",r.close()},n={id:t.contactInformation.id};t.invokeApi(a.deleteArAccount,n,e)},t.clikedDiscardDeleteAr=function(){r.close()},t.toggleGlobalButton=function(){l.getPermissionValue("GLOBAL_CARD_UPDATE")&&(t.contactInformation.is_global_enabled=!t.contactInformation.is_global_enabled,t.contactInformation.account_type=t.account_type),c(function(){t.$broadcast("LOAD_SUBSCRIBED_MPS"),t.activateSelectedTab()},1e3)},t.activateSelectedTab=function(){"cc-contact-info"===t.currentSelectedTab&&(t.$broadcast("ContactTabActivated"),t.$broadcast("contactTabActive")),"cc-contracts"===t.currentSelectedTab&&t.$broadcast("refreshContractsScroll"),"cc-ar-accounts"===t.currentSelectedTab&&(t.$broadcast("arAccountTabActive"),t.$broadcast("refreshAccountsScroll")),"cc-ar-transactions"===t.currentSelectedTab&&(s.$broadcast("arTransactionTabActive"),t.isWithFilters=!1),"cc-notes"===t.currentSelectedTab&&t.$broadcast("fetchNotes"),"cc-commissions"===t.currentSelectedTab&&t.$broadcast("commissionsTabActive")},t.shouldShowCommissionsTab=function(){return"TRAVELAGENT"===t.account_type},t.isUpdateEnabled=function(a){if(void 0!==t.contactInformation.is_global_enabled){var e=!1;return t.contactInformation.is_global_enabled?l.getPermissionValue("GLOBAL_CARD_UPDATE")||(e=!0):l.getPermissionValue("EDIT_COMPANY_CARD")||(e=!0),a?e||!t.isUpdateEnabledForName():e}},t.isUpdateEnabledForTravelAgent=function(a){if(void 0!==t.contactInformation.is_global_enabled){var e=!1;return t.contactInformation.is_global_enabled?l.getPermissionValue("GLOBAL_CARD_UPDATE")||(e=!0):l.getPermissionValue("EDIT_TRAVEL_AGENT_CARD")||(e=!0),a?e||!t.isUpdateEnabledForName():e}},t.isUpdateEnabledForName=function(){var t=e.getContractedRates(),a=!0;return(t.current_contracts&&t.current_contracts.length>0||t.future_contracts&&t.future_contracts.length>0||t.history_contracts&&t.history_contracts.length>0)&&(a=!1),a};var v=function(){var e={id:t.contactInformation.id},n=function(a){t.$emit("hideLoader"),t.arAccountNotes=a,t.$broadcast("ARDetailsRecieved")},o=function(){t.invokeApi(a.fetchArAccountNotes,e,n)},r=function(a){t.$emit("hideLoader"),t.arAccountDetails=a,t.arAccountDetails.is_use_main_contact!==!1&&(t.arAccountDetails.is_use_main_contact=!0),t.arAccountDetails.is_use_main_address!==!1&&(t.arAccountDetails.is_use_main_address=!0),o()};t.invokeApi(a.fetchArAccountDetails,e,r)};t.addListener("MANDATORY_CHECK_FAILED",function(a,e){t.isArTabAvailable=!1,t.switchTabTo("","cc-contact-info"),t.mandatoryErrorMessage=e,t.openCompanyTravelAgentCardMandatoryFieldsPopup()});var h={},D=function(a){t.$emit("hideLoader"),t.contactInformation=a,t.contactInformation.emailStyleClass=s.roverObj.eInvoiceVisible?"margin":"full-width",t.$broadcast("LOAD_SUBSCRIBED_MPS"),t.$broadcast("UPDATE_CONTACT_INFO"),""!==t.contactInformation.alert_message&&(t.errorMessage=[t.contactInformation.alert_message]),"undefined"!=typeof o.id&&""!==o.id&&(t.contactInformation.id=o.id,v()),h=JSON.parse(JSON.stringify(t.contactInformation)),s.prevStateBookmarkDataFromAR.contactInformation=angular.copy(t.contactInformation),"AR_OVERVIEW"===o.origin?t.switchTabTo("","cc-ar-transactions"):"COMMISION_SUMMARY"===o.origin&&t.switchTabTo("","cc-commissions"),t.displayShowPropertiesButton=!t.contactInformation.commission_details.is_global_commission},y=function(a){t.$emit("hideLoader"),angular.isDefined(t.contactInformation.address_details)||(t.contactInformation.address_details={street1:"",street2:"",street3:"",city:"",state:"",postal_code:"",country_id:"",email_address:"",phone:"",fax:"",location:""}),angular.isDefined(t.contactInformation.primary_contact_details)||(t.contactInformation.primary_contact_details={contact_first_name:"",contact_last_name:"",contact_job_title:"",contact_phone:"",contact_email:""}),t.contactInformation.mandatoryFields=a.mandatoryFields,t.contactInformation.emailStyleClass=t.contactInformation.mandatoryFields.e_invoice_mandatory.is_visible?"margin":"full-width",t.contactInformation.commission_details=a.commission_details,t.displayShowPropertiesButton=!t.contactInformation.commission_details.is_global_commission},C=function(a){t.countries=a};t.invokeApi(a.fetchCountryList,A,C);var g=o.id;if(t.shouldShowStatisticsTab="add"!==o.id,"undefined"!=typeof g&&"add"===g)t.contactInformation={},"undefined"!=typeof o.query&&""!==o.query&&(t.contactInformation.account_details={organization_id:null,reg_tax_office:null,tax_number:null},t.contactInformation.account_details.account_name=o.query),t.arAccountNotes={},t.arAccountDetails={},h={},t.invokeApi(a.fetchCommissionDetailsAndMandatoryFields,A,y);else if("undefined"!=typeof g&&""!==g){var A={id:g};t.invokeApi(a.fetchContactInformationAndMandatoryFields,A,D)}var S=function(a,e,c){if(e&&r.close(),t.contactInformation.commission_details.is_global_commission&&angular.forEach(t.contactInformation.commission_details.other_hotels_info,function(a){a.commission_type=t.contactInformation.commission_details.commission_type,a.type=t.contactInformation.commission_details.type,a.value=t.contactInformation.commission_details.value,a.is_prepaid=t.contactInformation.commission_details.is_prepaid}),t.shouldSaveArDataFromPopup&&(t.shouldSaveArDataFromPopup=!1,t.$broadcast("UPDATE_AR_ACCOUNT_DETAILS",t.arAccountDetails),t.$broadcast("saveArAccount")),f)return f=!1,t.$broadcast("setgenerateNewAutoAr",!0),t.$broadcast("saveArAccount"),void(t.isArTabAvailable=!0);if("undefined"!=typeof a.id&&""!==a.id){var l=!!t.contactInformation.id;t.contactInformation.id=a.id,l||v()}else"undefined"!=typeof o.id&&""!==o.id&&(t.contactInformation.id=o.id);h=JSON.parse(JSON.stringify(t.contactInformation)),t.isAddNewCard&&(t.disableGlobalToggle=!1,"COMPANY"===o.type?t.heading=i("translate")("COMPANY_CARD"):"TRAVELAGENT"===o.type&&(t.heading=i("translate")("TA_CARD"))),t.isAddNewCard=!1,t.disableGlobalToggle=!0,t.errorMessage="",t.$broadcast("clearCardContactErrorMessage"),t.$broadcast("IDGENERATED",{id:a.id}),c&&n.go(s.previousState,s.previousStateParams)},b=function(a){return t.$broadcast("setCardContactErrorMessage",a),t.errorMessage=a,t.currentSelectedTab="cc-contact-info",!1},I=function(e,i,c){var l=!1;if(m=[],angular.equals(e,h)||(l=!0,angular.forEach(e.commission_details.other_hotels_info,function(t){angular.forEach(h.commission_details.other_hotels_info,function(a){t.id!==a.id||_.isMatch(t,a)||m.push(t)})})),l){var d=JSON.parse(JSON.stringify(e));d.commission_details.other_hotels_info=angular.copy(m),"undefined"!=typeof d.countries&&delete d.countries,""===d.account_details.account_number&&(d.account_details.account_number=null),"undefined"==typeof d.primary_contact_details?(d.primary_contact_details={},d.primary_contact_details.contact_email=null):""===d.primary_contact_details.contact_email&&(d.primary_contact_details.contact_email=null),"undefined"==typeof d.address_details&&(d.address_details={}),d.account_type=o.type;var u={params:d,successCallBack:function(t){S(t,i,c)},failureCallBack:b};t.callAPI(a.saveContactInformation,u)}else t.shouldSaveArDataFromPopup&&(t.shouldSaveArDataFromPopup=!1,t.$broadcast("UPDATE_AR_ACCOUNT_DETAILS",t.arAccountDetails),t.$broadcast("saveArAccount")),f&&(t.$broadcast("setgenerateNewAutoAr",!0),t.$broadcast("saveArAccount"),t.isArTabAvailable=!0),f=!1,i&&r.close(),c&&n.go(s.previousState,s.previousStateParams)};t.$on("saveContactInformation",function(a,e){a.preventDefault(),a.stopPropagation(),t.isAddNewCard||t.isDiscard||(e&&e.other_hotels_info?(t.contactInformation.commission_details.other_hotels_info=e.other_hotels_info,I(t.contactInformation,e.hotel_info_changed_from_popup)):I(t.contactInformation))}),t.$on("OUTSIDECLICKED",function(a){a.preventDefault(),t.isMandatoryPopupOpen||(t.isAddNewCard&&!t.isContactInformationSaved?t.isPromptOpened||t.saveNewCardPrompt():t.isDiscard||o.isBackFromStaycard||t.isContactInformationSaved||("cc-contact-info"===t.currentSelectedTab?I(t.contactInformation):"cc-contracts"===t.currentSelectedTab?t.$broadcast("saveContract"):"cc-ar-accounts"===t.currentSelectedTab&&t.$broadcast("saveArAccount")))}),t.clikedSaveNewCard=function(){I(t.contactInformation),t.isContactInformationSaved=!0},t.clikedSaveNewCardViaPopup=function(){I(t.contactInformation),t.isContactInformationSaved=!0,r.close()},t.clikedDiscardCard=function(){t.isDiscard=!0,n.go("rover.companycardsearch",{textInQueryBox:o.query}),t.isAddNewCard=!1,t.disableGlobalToggle=!0,r.close()},t.saveNewCardPrompt=function(){t.isPromptOpened=!0,r.open({template:"/assets/partials/companyCard/rvSaveNewCardPrompt.html",controller:"saveNewCardPromptCtrl",className:"ngdialog-theme-default1 calendar-single1",closeByDocument:!1,scope:t})},t.clickedLogo=function(){"TRAVELAGENT"===o.type?t.isUpdateEnabledForTravelAgent()||c(function(){angular.element("#uplaodCompanyLogo").trigger("click")},0,!1):"COMPANY"===o.type&&(t.isUpdateEnabled()||c(function(){angular.element("#uplaodCompanyLogo").trigger("click")},0,!1))},t.shouldShowARMandatoryPopup=function(){var a=(!t.contactInformation.mandatoryFields.address_line1_mandatory.is_mandatory_on_ar_account_creation&&!t.contactInformation.mandatoryFields.address_line1_mandatory.is_mandatory||!isEmpty(t.contactInformation.address_details.street1))&&(!t.contactInformation.mandatoryFields.city_mandatory.is_mandatory_on_ar_account_creation&&!t.contactInformation.mandatoryFields.city_mandatory.is_mandatory||!isEmpty(t.contactInformation.address_details.city))&&(!t.contactInformation.mandatoryFields.postal_code_mandatory.is_mandatory_on_ar_account_creation&&!t.contactInformation.mandatoryFields.postal_code_mandatory.is_mandatory||!isEmpty(t.contactInformation.address_details.postal_code))&&(!t.contactInformation.mandatoryFields.country_mandatory.is_mandatory_on_ar_account_creation&&!t.contactInformation.mandatoryFields.country_mandatory.is_mandatory||""!==t.contactInformation.address_details.country_id&&null!==t.contactInformation.address_details.country_id)&&(!t.contactInformation.mandatoryFields.contact_phone_mandatory.is_mandatory_on_ar_account_creation&&!t.contactInformation.mandatoryFields.contact_phone_mandatory.is_mandatory||!isEmpty(t.contactInformation.address_details.phone))&&(!t.contactInformation.mandatoryFields.contact_email_address_mandatory.is_mandatory_on_ar_account_creation&&!t.contactInformation.mandatoryFields.contact_email_address_mandatory.is_mandatory||!isEmpty(t.contactInformation.address_details.email_address)&&isValidEmail(t.contactInformation.address_details.email_address))&&(!t.contactInformation.mandatoryFields.e_invoice_mandatory.is_mandatory_on_ar_account_creation&&!t.contactInformation.mandatoryFields.e_invoice_mandatory.is_mandatory||!isEmpty(t.contactInformation.e_invoice_address))&&(!t.contactInformation.mandatoryFields.organization_id_mandatory.is_mandatory_on_ar_account_creation&&!t.contactInformation.mandatoryFields.organization_id_mandatory.is_mandatory||!isEmpty(t.contactInformation.account_details.organization_id))&&(!t.contactInformation.mandatoryFields.tax_id_mandatory.is_mandatory_on_ar_account_creation&&!t.contactInformation.mandatoryFields.tax_id_mandatory.is_mandatory||!isEmpty(t.contactInformation.account_details.tax_number))&&(!t.contactInformation.mandatoryFields.regd_tax_office_mandatory.is_mandatory_on_ar_account_creation&&!t.contactInformation.mandatoryFields.regd_tax_office_mandatory.is_mandatory||!isEmpty(t.contactInformation.account_details.reg_tax_office))&&(!t.contactInformation.mandatoryFields.contact_name_mandatory.is_mandatory_on_ar_account_creation&&!t.contactInformation.mandatoryFields.contact_name_mandatory.is_mandatory||!isEmpty(t.contactInformation.primary_contact_details.contact_first_name)&&!isEmpty(t.contactInformation.primary_contact_details.contact_last_name))&&(!!t.arAccountDetails.is_auto_assign_ar_numbers||""!==t.arAccountDetails.ar_number&&null!==t.arAccountDetails.ar_number)&&(!t.contactInformation.mandatoryFields.payment_due_days_mandatory.is_mandatory_on_ar_account_creation&&!t.contactInformation.mandatoryFields.payment_due_days_mandatory.is_mandatory||""!==t.arAccountDetails.payment_due_days&&null!==t.arAccountDetails.payment_due_days);return a},t.isEmptyObject=isEmptyObject,t.$on("PRINT_AR_STATEMENT",function(a,e){t.isPrintArStatement=e}),s.disableObserveForSwipe||(CardReaderCtrl.call(this,t,s,c,d,u),t.observeForSwipe())}]);var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t};angular.module("sntRover").controller("companyCardNotesController",["$scope","rvCompanyCardNotesSrv","$timeout","$filter","$rootScope",function(t,a,e,n,o){BaseCtrl.call(this,t);var r=null,i=function(){var a=t.getScroller("companycard_notes_scroller");e(function(){a.scrollTo(0,0,300)},0)},c=function(a){t.notes=a,t.refreshScroller("companycard_notes_scroller"),t.contactInformation.account_notes_count=t.notes.length},s=function(){r=t.contactInformation.id;var e={accountID:r},n={params:e,successCallBack:c};t.callAPI(a.fetchNotes,n)},l=function(a,e){var n=e.index;t.notes.splice(n,1),t.refreshScroller("companycard_notes_scroller"),t.contactInformation.account_notes_count=t.notes.length},d=function(a){t.errorMessage=a,s()};t.deleteNote=function(e,n,o){e.stopPropagation(),t.cancelEditMode(),t.errorMessage="";var i={noteID:n,accountID:r},c={params:i,successCallBack:l,failureCallBack:d,successCallBackParameters:{index:o}};t.callAPI(a.deleteNote,c)};var u=function(a){var e={user_name:a.user_name,avatar:a.avatar,note:a.note,time:a.time,date:a.date,id:a.id,hotel_name:a.hotel_name,is_editable:a.is_editable};t.notes.unshift(0),t.notes[0]=e,t.noteText="",t.refreshScroller("companycard_notes_scroller"),i(),t.contactInformation.account_notes_count=t.notes.length};t.createNote=function(){r=t.contactInformation.id;var e={accountID:r,text:t.noteText};t.errorMessage="";var n={params:e,successCallBack:u};t.callAPI(a.createNote,n)};var m=function(a){var n=_.findIndex(t.notes,{id:t.editingNote.id})+1;t.cancelEditMode(),s();var o=t.getScroller("companycard_notes_scroller");e(function(){o.scrollToElement(".notes.wrapper li:nth-child("+n+")",300)},0)};t.updateActiveNote=function(){if(null===t.editingNote)return void(t.errorMessage=["Something went wrong, please switch tab and comeback"]);t.errorMessage="";var e={noteID:t.editingNote.id,accountID:r,text:t.noteText},n={params:e,successCallBack:m};t.callAPI(a.updateNote,n)},t.clickedOnNote=function(a){a.is_editable&&(t.editingNote=a,t.noteText=a.note)},t.cancelEditMode=function(){t.editingNote=null,t.noteText=""},t.formatDateForUI=function(t){var a="undefined"==typeof t?"undefined":_typeof(t),e="";switch(a){case"string":
e=n("date")(new tzIndependentDate(t),o.dateFormat);break;case"object":e=n("date")(t,o.dateFormat)}return e};(function(){t.editingNote=null,t.notes=[],t.noteText="",t.setScroller("companycard_notes_scroller",{})})();t.$on("fetchNotes",function(){r=t.contactInformation&&t.contactInformation.id||!1,r&&s()})}]),sntRover.controller("companyCardArAccountCtrl",["$scope","RVCompanyCardSrv","$timeout","rvPermissionSrv",function(t,a,e,n){BaseCtrl.call(this,t),t.setScroller("cardAccountsScroller");var o=function(){e(function(){t.myScroll&&t.myScroll.cardAccountsScroller&&t.myScroll.cardAccountsScroller.refresh(),t.refreshScroller("cardAccountsScroller")},500)};t.$on("refreshAccountsScroll",o);var r=function(){t.ARData={},t.ARData.note="",t.shouldValidate=!0};r();var i={};t.$on("setgenerateNewAutoAr",function(a,e){t.$parent.generateNewAutoAr=e,!t.arAccountDetails.is_auto_assign_ar_numbers&&e&&c(!0)});var c=function(e){var n=function(a){t.$emit("hideLoader"),t.errorMessage="",t.arAccountDetails.is_auto_assign_ar_numbers&&!t.arAccountDetails.ar_number&&(t.arAccountDetails.ar_number=a.ar_number,t.$parent.generateNewAutoAr=!1),t.$emit("ARNumberChanged",{newArNumber:t.arAccountDetails.ar_number})},o=function(a){t.$emit("hideLoader"),t.errorMessage=""},r=function(a){t.$emit("hideLoader"),t.errorMessage=a,"Please complete required AR Account Information"!==a[0]&&"Please provide payment due days since it is mandatory"!==a[0]||t.$emit("MANDATORY_CHECK_FAILED",t.errorMessage)},c=t.arAccountDetails;_.isEmpty(i)&&(i=angular.fromJson(angular.toJson(t.arAccountDetails))),t.contactInformation.id&&(c.id=t.contactInformation.id,i.id=t.contactInformation.id);var s=JSON.parse(JSON.stringify(t.arAccountDetails)),l=!1,d=["workstation_id"];angular.equals(_.omit(s,d),_.omit(i,d))||(l=!0,i=s),t.$parent.generateNewAutoAr&&t.arAccountDetails.is_auto_assign_ar_numbers||l?t.invokeApi(a.saveARDetails,c,n,r):(!t.arAccountDetails.is_auto_assign_ar_numbers&&l||e)&&t.invokeApi(a.saveARDetails,c,o,r)};t.$on("arAccountTabActive",function(){setTimeout(function(){o()},500),t.arAccountDetails&&t.arAccountDetails.is_auto_assign_ar_numbers&&!t.arAccountDetails.ar_number&&c()}),t.$on("ARDetailsRecieved",function(){i=JSON.parse(JSON.stringify(t.arAccountDetails))}),t.checkboxModelChanged=function(){o()},t.saveNote=function(){var e=function(a){t.$emit("hideLoader"),t.arAccountNotes.ar_notes.push(a),t.ARData.note="",o()},n={id:t.contactInformation.id,note:t.ARData.note,ar_number:t.arAccountDetails.ar_number};t.invokeApi(a.saveARNote,n,e)},t.deletePost=function(e,n){var r=function(){t.$emit("hideLoader"),t.arAccountNotes.ar_notes.splice(n,1),o()},i={id:t.contactInformation.id,note_id:e};t.invokeApi(a.deleteARNote,i,r)},t.$on("UPDATE_AR_ACCOUNT_DETAILS",function(a,e){t.arAccountDetails=e,t.arAccountDetails.payment_due_days=null===e.payment_due_days?"":e.payment_due_days}),t.$on("saveArAccount",function(t){t.preventDefault(),c()}),t.$on("ArAccountDeleted",function(a){var e=t.arAccountDetails.is_auto_assign_ar_numbers;t.arAccountDetails={},t.arAccountDetails.is_use_main_contact=!0,t.arAccountDetails.is_use_main_address=!0,t.arAccountDetails.is_auto_assign_ar_numbers=e,t.arAccountDetails.ar_number="",t.arAccountDetails.payment_due_days="",t.arAccountNotes.ar_notes=[],t.$emit("UPDATE_AR_ACCOUNT_DETAILS_AFTER_DELETE",t.arAccountDetails)}),t.clearErrorMessage=function(){t.errorMessage=""},t.hasPermissionToEditDirectBillRestriction=function(){return n.getPermissionValue("EDIT_DIRECT_BILL_RESTRICTION")},t.hasPermissionToCreateArAccount=function(){return n.getPermissionValue("CREATE_AR_ACCOUNT")}}]),angular.module("sntRover").controller("companyCardDetailsContactCtrl",["$scope","$q","jsMappings","RVCompanyCardSrv","rvPermissionSrv","$state","$stateParams","ngDialog","$rootScope",function(t,a,e,n,o,r,i,c,s){BaseCtrl.call(this,t),t.setScroller("companyCardDetailsContactCtrl"),t.$on("contactTabActive",function(){l()}),t.isEmpty=function(t){return _.isEmpty(t)},t.toggleCommission=function(){t.contactInformation.commission_details.is_on=!t.contactInformation.commission_details.is_on},t.openBillingInformation=function(a){if(null===t.contactInformation.id||void 0===t.contactInformation.id)return t.$emit("OUTSIDECLICKED"),!1;if("TRAVELAGENT"===a)t.attachedEntities={},t.attachedEntities.travel_agent={},t.attachedEntities.travel_agent.id=t.contactInformation.id,t.attachedEntities.travel_agent.name=t.contactInformation.account_details.account_name,t.attachedEntities.travel_agent.logo=t.contactInformation.account_details.company_logo,t.billingEntity="TRAVEL_AGENT_DEFAULT_BILLING";else{if("COMPANY"!==a)return!1;t.attachedEntities={},t.attachedEntities.company_card={},t.attachedEntities.company_card.id=t.contactInformation.id,t.attachedEntities.company_card.name=t.contactInformation.account_details.account_name,t.attachedEntities.company_card.logo=t.contactInformation.account_details.company_logo,t.billingEntity="COMPANY_CARD_DEFAULT_BILLING"}t.$emit("showLoader"),e.fetchAssets(["addBillingInfo","directives"]).then(function(){t.$emit("hideLoader"),s.UPDATED_BI_ENABLED_ON.CARDS?(console.log("##Billing-info updated version"),c.open({template:"/assets/partials/billingInformation/cards/rvBillingInfoCardsMain.html",controller:"rvBillingInfoCardsMainCtrl",className:"",scope:t})):(console.log("##Billing-info old version"),c.open({template:"/assets/partials/bill/rvBillingInformationPopup.html",controller:"rvBillingInformationPopupCtrl",className:"",scope:t}))})},t.$on("setCardContactErrorMessage",function(a,e){t.errorMessage=e}),t.$on("clearCardContactErrorMessage",function(){t.errorMessage=""});var l=function(){t.refreshScroller("companyCardDetailsContactCtrl")};t.$on("BILLINGINFODELETED",function(){t.contactInformation.account_details.routes_count=0}),t.$on("BILLINGINFOADDED",function(){t.contactInformation.account_details.routes_count=1}),t.openPropertiesPopup=function(){c.open({template:"/assets/partials/companyCard/rvTACardPropertiesCommissionsPopup.html",controller:"rvTACardPropertiesCommissionsPopupCtrl",className:"",scope:t})},t.toggleGlobalCommission=function(){t.displayShowPropertiesButton=!t.contactInformation.commission_details.is_global_commission},t.displayShowPropertiesButtonFn=function(){return t.displayShowPropertiesButton&&"TRAVELAGENT"===t.account_type&&!t.isEmpty(t.contactInformation.commission_details)&&t.contactInformation.is_global_enabled&&s.isAnMPHotel&&s.hotelDetails.userHotelsData.hotel_list.length>0&&o.getPermissionValue("MULTI_PROPERTY_SWITCH")&&o.getPermissionValue("GLOBAL_CARD_UPDATE")&&!t.isUpdateEnabledForTravelAgent()},t.showGlobalCommissionCheckbox=function(){return t.contactInformation.is_global_enabled&&s.hotelDetails.userHotelsData.hotel_list.length>0&&o.getPermissionValue("MULTI_PROPERTY_SWITCH")}}]),sntRover.controller("companyTravelAgentMandatoryFieldsController",["$scope","$timeout","ngDialog",function(t,a,e){BaseCtrl.call(this,t),t.setScroller("companyTravelAgentMandatory"),t.closeDialog=function(){t.$emit("UPDATE_MANDATORY_POPUP_OPEN_FLAG"),e.close()},t.saveCoTaMandatoryData=function(){t.$emit("saveContactInformation"),t.$emit("saveArAccountFromMandatoryPopup",t.arAccountDetails),t.closeDialog()},t.shouldEnableSubmitButton=function(){return t.shouldShowARMandatoryPopup()};var n=function(){t.errorMessage=angular.isUndefined(t.mandatoryErrorMessage)?"":t.mandatoryErrorMessage,a(function(){t.refreshScroller("companyTravelAgentMandatory")},200),angular.isUndefined(t.contactInformation.e_invoice_address)&&(t.contactInformation.e_invoice_address=null),null!==t.contactInformation.address_details.street1&&""!==t.contactInformation.address_details.street1||!t.contactInformation.mandatoryFields.address_line1_mandatory.is_mandatory_on_ar_account_creation&&!t.contactInformation.mandatoryFields.address_line1_mandatory.is_mandatory||(t.shouldShowAddress=!0),null!==t.contactInformation.address_details.city&&""!==t.contactInformation.address_details.city||!t.contactInformation.mandatoryFields.city_mandatory.is_mandatory_on_ar_account_creation&&!t.contactInformation.mandatoryFields.city_mandatory.is_mandatory||(t.shouldShowCity=!0),null!==t.contactInformation.address_details.postal_code&&""!==t.contactInformation.address_details.postal_code||!t.contactInformation.mandatoryFields.postal_code_mandatory.is_mandatory_on_ar_account_creation&&!t.contactInformation.mandatoryFields.postal_code_mandatory.is_mandatory||(t.shouldShowPostalCode=!0),null!==t.contactInformation.address_details.country_id&&""!==t.contactInformation.address_details.country_id||!t.contactInformation.mandatoryFields.country_mandatory.is_mandatory_on_ar_account_creation&&!t.contactInformation.mandatoryFields.country_mandatory.is_mandatory||(t.shouldShowCountry=!0),null!==t.contactInformation.address_details.phone&&""!==t.contactInformation.address_details.phone||!t.contactInformation.mandatoryFields.contact_phone_mandatory.is_mandatory_on_ar_account_creation&&!t.contactInformation.mandatoryFields.contact_phone_mandatory.is_mandatory||(t.shouldShowPhone=!0),null!==t.contactInformation.address_details.email_address&&""!==t.contactInformation.address_details.email_address||!t.contactInformation.mandatoryFields.contact_email_address_mandatory.is_mandatory_on_ar_account_creation&&!t.contactInformation.mandatoryFields.contact_email_address_mandatory.is_mandatory||(t.shouldShowEmail=!0),null!==t.contactInformation.e_invoice_address&&""!==t.contactInformation.e_invoice_address||!t.contactInformation.mandatoryFields.e_invoice_mandatory.is_mandatory_on_ar_account_creation&&!t.contactInformation.mandatoryFields.e_invoice_mandatory.is_mandatory||(t.shouldShowEInvoice=!0),null!==t.contactInformation.account_details.organization_id&&""!==t.contactInformation.account_details.organization_id||!t.contactInformation.mandatoryFields.organization_id_mandatory.is_mandatory_on_ar_account_creation&&!t.contactInformation.mandatoryFields.organization_id_mandatory.is_mandatory||(t.shouldShowOrganization=!0),null!==t.contactInformation.account_details.tax_number&&""!==t.contactInformation.account_details.tax_number||!t.contactInformation.mandatoryFields.tax_id_mandatory.is_mandatory_on_ar_account_creation&&!t.contactInformation.mandatoryFields.tax_id_mandatory.is_mandatory||(t.shouldShowTaxNumber=!0),null!==t.contactInformation.account_details.reg_tax_office&&""!==t.contactInformation.account_details.reg_tax_office||!t.contactInformation.mandatoryFields.regd_tax_office_mandatory.is_mandatory_on_ar_account_creation&&!t.contactInformation.mandatoryFields.regd_tax_office_mandatory.is_mandatory||(t.shouldShowRegisteredTaxOffice=!0),null!==t.contactInformation.primary_contact_details.contact_first_name&&""!==t.contactInformation.primary_contact_details.contact_first_name||!t.contactInformation.mandatoryFields.contact_name_mandatory.is_mandatory_on_ar_account_creation&&!t.contactInformation.mandatoryFields.contact_name_mandatory.is_mandatory||(t.shouldShowPrimaryContactFirstName=!0),null!==t.contactInformation.primary_contact_details.contact_last_name&&""!==t.contactInformation.primary_contact_details.contact_last_name||!t.contactInformation.mandatoryFields.contact_name_mandatory.is_mandatory_on_ar_account_creation&&!t.contactInformation.mandatoryFields.contact_name_mandatory.is_mandatory||(t.shouldShowPrimaryContactLastName=!0),null!==t.arAccountDetails.payment_due_days&&""!==t.arAccountDetails.payment_due_days||!t.contactInformation.mandatoryFields.payment_due_days_mandatory.is_mandatory_on_ar_account_creation&&!t.contactInformation.mandatoryFields.payment_due_days_mandatory.is_mandatory||(t.shouldShowPayDays=!0),t.arAccountDetails.is_auto_assign_ar_numbers||(t.shouldShowArNumber=!0)};n()}]),sntRover.controller("rvTACardPropertiesCommissionsPopupCtrl",["$scope","$rootScope","$filter","$timeout","rvUtilSrv","ngDialog",function(t,a,e,n,o,r){BaseCtrl.call(this,t);var i={tap:!0,preventDefault:!1,showScrollbar:!0};t.clickedCancel=function(){r.close()},t.saveChanges=function(){t.$emit("saveContactInformation",{hotel_info_changed_from_popup:!0,other_hotels_info:t.hotelCommissionDetails})};var c=function(){t.hotelCommissionDetails=angular.copy(t.contactInformation.commission_details.other_hotels_info),t.setScroller("rvTACardPropertiesCommissionsScroll",i),n(function(){t.refreshScroller("rvTACardPropertiesCommissionsScroll")},2e3)};c()}]),sntRover.controller("RVCompanyCardActivityLogCtrl",["$scope","$rootScope","$stateParams","$timeout","RVCompanyCardActivityLogSrv","ngDialog",function(t,a,e,n,o,r){BaseCtrl.call(this,t);var i=this,c=1e3,s=function(){n(function(){t.refreshScroller("rvCompanyCardActivityLogScroll")},500)},l=function(){t.activityLogObj={response:{},perPage:50,page:1,sortField:"DATE",sortOrder:"asc",accountId:"undefined"==typeof t.contactInformation?e.id:t.contactInformation.id},t.activityLogFilter={user:"",date:"asc",action:"",actionsList:[],selectedAction:"",fromDate:new Date,toDate:new Date,query:""},t.activityLogPagination={id:"ACTIVITY_LOG",api:i.loadAPIData,perPage:t.activityLogObj.perPage},t.setScroller("rvCompanyCardActivityLogScroll",{}),s()};i.fetchFilterData=function(){var a={params:{id:t.activityLogObj.accountId},successCallBack:function(a){t.activityLogFilter.actionsList=a.results},failureCallBack:function(a){t.errorMessage=a}};t.callAPI(o.fetchFilterData,a)},t.showPagination=function(){var a=!1,e=t.activityLogObj.response;return"undefined"!=typeof e&&"undefined"!=typeof e.results&&e.results.length<e.total_count&&e.results.length>0&&(a=!0),a},i.loadAPIData=function(a){t.activityLogObj.page=a?a:1,t.activityLogObj.accountId="undefined"==typeof t.contactInformation?e.id:t.contactInformation.id;var r={params:{page:t.activityLogObj.page,per_page:t.activityLogObj.perPage,sort_field:t.activityLogObj.sortField,sort_order:t.activityLogObj.sortOrder,id:t.activityLogObj.accountId,action_type_id:t.activityLogFilter.selectedAction,from_date:t.activityLogFilter.fromDate,to_date:t.activityLogFilter.toDate,query:t.activityLogFilter.query},successCallBack:function(a){t.activityLogObj.response=a,t.errorMessage="",s(),n(function(){t.$broadcast("updatePagination","ACTIVITY_LOG")},c)},failureCallBack:function(a){t.errorMessage=a}};t.callAPI(o.fetchActivityLog,r)};var d=function(a){t.activityLogObj.sortField=a;var e=t.activityLogFilter;switch(a){case"USERNAME":""===e.user||"asc"===e.user?e.user="desc":e.user="asc",t.activityLogObj.sortOrder=e.user;break;case"DATE":""===e.date||"asc"===e.date?e.date="desc":e.date="asc",t.activityLogObj.sortOrder=e.date;break;case"ACTION":""===e.action||"asc"===e.action?e.action="desc":e.action="asc",t.activityLogObj.sortOrder=e.action}i.loadAPIData()};t.sortByAction=function(t){d(t)};var u=t.$on("activityLogTabActive",function(){n(function(){i.loadAPIData(),i.fetchFilterData()},c)});t.isOldValue=function(t){var a=!0;return""!==t&&"undefined"!=typeof t&&null!==t||(a=!1),a};var m=function(a){t.clickedOn=a,r.open({template:"/assets/partials/companyCard/contracts/rvCompanyCardContractsCalendar.html",controller:"RVCompanyCardActivityLogDatePickerController",className:"",scope:t})};t.clickedFromDate=function(){m("FROM")},t.clickedToDate=function(){m("TO")},t.clearDate=function(a){"FROM"===a?t.activityLogFilter.fromDate="":t.activityLogFilter.toDate=""},t.clearQuery=function(){t.activityLogFilter.query=""},t.clickedFilterButton=function(){i.loadAPIData()},l(),t.$on("$destroy",u)}]),sntRover.controller("RVCompanyCardActivityLogDatePickerController",["$scope","$rootScope","ngDialog",function(t,a,e){var n="";"FROM"===t.clickedOn?t.date=t.activityLogFilter.fromDate?tzIndependentDate(t.activityLogFilter.fromDate):tzIndependentDate(a.businessDate):"TO"===t.clickedOn&&(n=tzIndependentDate(t.activityLogFilter.fromDate),t.date=t.activityLogFilter.toDate?tzIndependentDate(t.activityLogFilter.toDate):tzIndependentDate(a.businessDate)),t.setUpData=function(){t.dateOptions={changeYear:!0,changeMonth:!0,minDate:n,yearRange:"-5:+5",onSelect:function(){"FROM"===t.clickedOn?(t.activityLogFilter.fromDate=t.date,t.activityLogFilter.toDate=t.date,t.$emit("fromDateChanged")):"TO"===t.clickedOn&&(t.activityLogFilter.toDate=t.date,t.$emit("toDateChanged")),e.close()}}},t.setUpData()}]),angular.module("sntRover").controller("rvCardAddContractsCtrl",["$scope","rvCompanyCardContractsSrv","$stateParams","ngDialog","$timeout",function(t,a,e,n,o){BaseCtrl.call(this,t);var r=this;t.setScroller("cardNewContractsScroll");var i=function(){o(function(){t.refreshScroller("cardNewContractsScroll")},500)},c=function(a){t.$emit("setErrorMessage",[]),t.contractData.mode="EDIT",t.contractData.selectedContractId=a.id,t.$emit("fetchContractsList"),t.$emit("updateContractedNights",t.addData.occupancy),r.init()},s=function(a){t.$emit("setErrorMessage",a)};r.init=function(){t.addData={contractName:"",accessCode:"",startDate:null,endDate:null,contractedNights:"",contractedRates:[],isActive:!0,occupancy:[]},i()},t.addListener("refreshAddScroller",i),t.addListener("addDataReset",function(){_.isEmpty(t.addData)||r.init()}),t.toggleActiveStatus=function(){t.addData.isActive=!t.addData.isActive},t.cancelNewContract=function(){t.contractData.mode="",t.$emit("fetchContractsList"),r.init()},t.saveNewContract=function(){var n=_.isEmpty(t.contactInformation)?e.id:t.contactInformation.id,o={access_code:t.addData.accessCode,contract_name:t.addData.contractName,begin_date:t.addData.startDate,end_date:t.addData.endDate,total_contracted_nights:t.addData.contractedNights,is_active:t.addData.isActive,rate_ids:_.pluck(t.contractData.selectedRateList,"id"),owner_id:t.contractData.contractOwner.selectedOwner.id||null},r={params:{account_id:n,postData:o},failureCallBack:s,successCallBack:c};t.callAPI(a.addNewContract,r)},t.contractStart=function(){n.open({template:"/assets/partials/companyCard/contracts/rvCompanyCardContractsCalendar.html",controller:"rvContractStartCalendarCtrl",className:"",scope:t})},t.contractEnd=function(){n.open({template:"/assets/partials/companyCard/contracts/rvCompanyCardContractsCalendar.html",controller:"rvContractEndCalendarCtrl",className:"",scope:t})},t.contractedNights=function(){n.open({template:"/assets/partials/companyCard/contracts/rvContractedNightsPopup.html",controller:"rvContractedNightsCtrl",className:"",scope:t})},r.init()}]),angular.module("sntRover").controller("rvCardContractListCtrl",["$timeout","$scope",function(t,a){BaseCtrl.call(this,a),a.setScroller("contractListScroller");var e=function(){t(function(){a.refreshScroller("contractListScroller")},500)},n=function(){var t=a.contractData.selectedContractId,n=a.contractData.contractsList;angular.forEach(n,function(a){a.opened=!1,angular.forEach(a.contracts,function(e){t===e.id&&(a.opened=!0)})}),e()},o=function(){a.contractData.selectedRateList=[],a.contractData.rateSearchQuery=""},r=function(){a.contractData.linkContractsSearch.query="",a.contractData.linkContractsSearch.results=[]};a.openContractsList=function(t){t.opened=!t.opened,e()},a.fetchDetails=function(t){t===a.contractData.selectedContractId&&"EDIT"===a.contractData.mode||(a.contractData.mode="EDIT",o(),r(),a.$emit("fetchContract",t))},a.newContract=function(){a.contractData.mode="ADD",a.contractData.disableFields=!1,a.contractData.contractOwner.selectedOwner.id=null,a.contractData.contractOwner.isInactive=!1,o(),r(),a.$emit("refreshContractsScroll")},a.linkContract=function(){a.contractData.mode="LINK",o(),r()},a.addListener("initContractsList",n)}]),angular.module("sntRover").controller("rvCardContractsLinkingCtrl",["$scope","rvCompanyCardContractsSrv","$timeout","$stateParams",function(t,a,e,n){BaseCtrl.call(this,t);var o=this;o.initialise=function(){t.contractData.linkContractsSearch.results=[],t.setScroller("searchContractsResultsList")},o.refreshSearchList=function(){e(function(){t.refreshScroller("searchContractsResultsList")},500)},o.fetchContractsForLinking=function(){var e=function(a){t.contractData.linkContractsSearch.results=a.contracts,t.$emit("searchContractsResultsList"),o.refreshSearchList()},r=function(a){t.errorMessage=a};t.contractData.accountId="add"===n.id?t.contactInformation.id:n.id;var i={successCallBack:e,failureCallBack:r,params:{account_id:t.contractData.accountId,query:t.contractData.linkContractsSearch.query}};t.callAPI(a.fetchContractsForLinking,i)},t.searchContracts=function(){t.contractData.linkContractsSearch.query.length>2?o.fetchContractsForLinking():t.contractData.linkContractsSearch.results=[]},t.clearQuery=function(){t.contractData.linkContractsSearch.query="",t.contractData.linkContractsSearch.results=[]},t.clickedOnResult=function(e){var n=t.contractData.linkContractsSearch.results[e],o=function(){t.contractData.selectedContractId=n.id,t.contractData.linkContractsSearch.query="",t.$emit("fetchContractsList")},r=function(a){t.errorMessage=a},i={successCallBack:o,failureCallBack:r,params:{id:n.id,account_id:t.contractData.accountId}};t.callAPI(a.linkContract,i)},t.cancelSearch=function(){t.contractData.linkContractsSearch.query="",t.contractData.noContracts?t.contractData.mode="":(t.contractData.mode="EDIT",t.$emit("fetchContract",t.contractData.selectedContractId))},o.initialise()}]),angular.module("sntRover").controller("rvCardContractsMainCtrl",["rvPermissionSrv","$rootScope","$scope","rvCompanyCardContractsSrv","$stateParams","$timeout",function(t,a,e,n,o,r){BaseCtrl.call(this,e);var i=function(){e.contractData={mode:"",contractsList:[],editData:{},disableFields:!1,isPastContract:!1,noContracts:!0,selectedContractId:"",rateSearchResult:[],rateSearchQuery:"",selectedRateList:[],selectedRateIdList:[],accountId:"",hasEditAccessCodePermission:t.getPermissionValue("EDIT_CONTRACT_ACCESS_CODE"),hasDeleteContractPermission:t.getPermissionValue("DELETE_CONTRACT"),linkContractsSearch:{query:"",results:[]},contractOwner:{results:[],isInactive:!1,selectedOwner:{id:null}}}},c=this,s=function(t){e.errorMessage=t},l=function(t,a,n){e.contractData.contractsList=[{contracts:a,type:"FUTURE",count:a.length},{contracts:t,type:"CURRENT",count:t.length},{contracts:n,type:"PAST",count:n.length}]},d=function(t,a){var n=t.current_contracts||[],o=t.history_contracts||[],r=t.future_contracts||[];s([]),l(n,r,o),0!==n.length||0!==o.length||0!==r.length?("UNLINK"!==a.action&&""!==e.contractData.selectedContractId||(e.contractData.selectedContractId=t.contract_selected||""),e.contractData.mode="EDIT",e.contractData.noContracts=!1,c.fetchContractDetails(e.contractData.selectedContractId)):i(),""!==e.contractData.selectedContractId&&""!==e.contractData.mode&&p()},u=function(t){e.contractData.contractOwner.results=t.ownersList,s([]),e.contractData.editData=t.contractDetails,e.contractData.selectedRateList=t.contractDetails.contract_rates,e.contractData.disableFields=t.contractDetails.end_date<a.businessDate||!t.contractDetails.is_master_contract,e.contractData.isPastContract=t.contractDetails.end_date<a.businessDate,e.$broadcast("addDataReset"),e.$broadcast("refreshEditScroller"),r(function(){if(null!==t.contractDetails.selected_contract_owner){var a=t.contractDetails.selected_contract_owner;e.contractData.contractOwner.selectedOwner.id=a.id.toString(),e.contractData.contractOwner.selectedOwner.name=a.name?a.name:"No contract owner",e.contractData.contractOwner.isInactive=!a.is_active}else e.contractData.contractOwner.selectedOwner.id=null,e.contractData.contractOwner.selectedOwner.name="No contract owner",e.contractData.contractOwner.isInactive=!1},100)},m=function(t){s(t),e.$broadcast("addDataReset")};c.fetchContractDetails=function(t){var a=_.isEmpty(e.contactInformation)?o.id:e.contactInformation.id;e.contractData.selectedContractId=t;var r={successCallBack:u,failureCallback:m,params:{account_id:a,contract_id:t}};e.callAPI(n.fetchDetailsWithOwnersList,r)};var f=function(t){s(t)};c.fetchContracts=function(t){e.contractData.accountId=_.isEmpty(e.contactInformation)?o.id:e.contactInformation.id;var a={successCallBack:d,failureCallBack:f,successCallBackParameters:{action:t},params:{account_id:e.contractData.accountId}};e.contractData.accountId&&e.callAPI(n.fetchContractsList,a)};var p=function(){"ADD"===e.contractData.mode?e.$broadcast("refreshAddScroller"):"EDIT"===e.contractData.mode&&(e.$broadcast("refreshEditScroller"),e.$broadcast("initContractsList"))};e.addListener("fetchContractsList",function(t,a){c.fetchContracts(a)}),e.addListener("fetchContract",function(t,a){c.fetchContractDetails(a)}),e.addListener("setErrorMessage",function(t,a){s(a)}),e.addListener("refreshContractsScroll",p),e.addListener("updateContractedNights",function(t,a){var r=function(){s([])},i=function(t){s(t)},c=_.isEmpty(e.contactInformation)?o.id:e.contactInformation.id,l={successCallBack:r,failureCallBack:i,params:{account_id:c,contract_id:e.contractData.selectedContractId,postData:{occupancy:a}}};e.callAPI(n.updateNight,l)}),e.createFirstContract=function(){e.contractData.mode="ADD",p()},e.moveToLinkContract=function(){e.contractData.mode="LINK",p()},i(),c.fetchContracts()}]),angular.module("sntRover").controller("rvCardEditContractsCtrl",["$scope","rvCompanyCardContractsSrv","$stateParams","ngDialog","$timeout",function(t,a,e,n,o){BaseCtrl.call(this,t),t.setScroller("editContractScroller");var r=function(){o(function(){t.refreshScroller("editContractScroller")},500)};t.addListener("refreshEditScroller",r),t.updateContract=function(){var n={access_code:t.contractData.editData.access_code,contract_name:t.contractData.editData.contract_name,begin_date:t.contractData.editData.begin_date,end_date:t.contractData.editData.end_date,total_contracted_nights:t.contractData.editData.total_contracted_nights,is_active:t.contractData.editData.is_active,rate_ids:_.pluck(t.contractData.selectedRateList,"id"),owner_id:t.contractData.contractOwner.selectedOwner.id||null},o=function(){t.$emit("setErrorMessage",[]),t.$emit("fetchContractsList"),t.$emit("updateContractedNights",t.contractData.editData.occupancy)},r=function(a){t.$emit("setErrorMessage",a),t.$parent.currentSelectedTab="cc-contracts"},i=_.isEmpty(t.contactInformation)?e.id:t.contactInformation.id,c={params:{account_id:i,contract_id:t.contractData.selectedContractId,postData:n},failureCallBack:r,successCallBack:o};t.callAPI(a.updateContract,c)},t.deleteContract=function(){var e,n=function(a){t.$emit("setErrorMessage",a)},o=function(){t.contractData.selectedContractId="",t.$emit("fetchContractsList")};e=t.contactInformation.id;var r={params:{account_id:e,contract_id:t.contractData.selectedContractId},failureCallBack:n,successCallBack:o};t.callAPI(a.deleteContract,r)},t.toggleActiveStatus=function(){t.contractData.disableFields||(t.contractData.editData.is_active=!t.contractData.editData.is_active)},t.restoreContract=function(){t.contractData.linkContractsSearch.query="",t.contractData.linkContractsSearch.results=[],t.$emit("fetchContract",t.contractData.selectedContractId)},t.editAccessCode=function(){var a;return a=!t.contractData.hasEditAccessCodePermission||t.contractData.disableFields},t.contractStart=function(){t.contractData.disableFields||n.open({template:"/assets/partials/companyCard/contracts/rvCompanyCardContractsCalendar.html",controller:"rvContractStartCalendarCtrl",className:"",scope:t})},t.contractEnd=function(){t.contractData.disableFields||n.open({template:"/assets/partials/companyCard/contracts/rvCompanyCardContractsCalendar.html",controller:"rvContractEndCalendarCtrl",className:"",scope:t})},t.editContractedNights=function(){t.contractData.disableFields||n.open({template:"/assets/partials/companyCard/contracts/rvContractedNightsPopup.html",controller:"rvContractedNightsCtrl",className:"",scope:t})},t.unlinkContractsCofirmed=function(){t.closeDialog();var e=function(){t.$emit("fetchContractsList","UNLINK")},n=function(a){t.$emit("setErrorMessage",a)},o={successCallBack:e,failureCallBack:n,params:{id:t.contractData.selectedContractId,account_id:t.contractData.accountId}};t.contractData.editData.is_master_contract&&(o.params.from_account_id=t.contractData.accountId,o.params.account_id=t.contractData.unlinkAccountId),t.callAPI(a.unLinkContract,o)},t.clickedUnlinkContracts=function(a){var e=t.contractData.editData.account_details[a];t.contractData.editData.is_master_contract?(t.cardName=e.name,t.contractData.unlinkAccountId=e.id):t.cardName=t.contactInformation.account_details.account_name,n.open({template:"/assets/partials/companyCard/contracts/rvConfirmUnlinkContract.html",className:"",closeByDocument:!1,scope:t})}}]),angular.module("sntRover").controller("rvCardSearchContractOwnerCtrl",["$scope","rvCompanyCardContractsSrv","$timeout","$stateParams",function(t,a,e,n){BaseCtrl.call(this,t);var o=this;o.fetchOwners=function(){t.contractData.contractOwner.results=[];var e=function(a){t.contractData.contractOwner.results=a.data},o=function(a){t.$emit("setErrorMessage",a)},r=_.isEmpty(t.contactInformation)?n.id:t.contactInformation.id,i={successCallBack:e,failureCallBack:o,params:{account_id:r}};t.callAPI(a.fetchOwners,i)},t.clickedInactive=function(){t.contractData.contractOwner.isInactive=!t.contractData.contractOwner.isInactive,t.contractData.contractOwner.isInactive||t.contractData.contractOwner.selectedOwner.is_active||(t.contractData.contractOwner.selectedOwner.id=null)},t.clickedOnResult=function(a){"undefined"==typeof a?t.contractData.contractOwner.selectedOwner={}:t.contractData.contractOwner.selectedOwner=a},t.checkNoContract=function(){var a=!1,e=t.contractData.contractOwner.selectedOwner;return 0!==t.contractData.contractOwner.results.length&&null!==e.id&&""!==e.id||(a=!0),a},"ADD"===t.contractData.mode&&o.fetchOwners()}]),angular.module("sntRover").controller("rvCardSearchContractedRateCtrl",["$scope","rvCompanyCardContractsSrv","$timeout","ngDialog","$stateParams",function(t,a,e,n,o){BaseCtrl.call(this,t);var r=this,i=500;r.initialise=function(){t.contractData.searchResults=[],t.setScroller("searchResultsList")},r.refreshSearchList=function(){e(function(){t.refreshScroller("searchResultsList")},i)},r.fetchRateContract=function(){var e=function(a){t.contractData.searchResults=a.contract_rates,t.$emit("refreshContractsScroll"),r.refreshSearchList()},n=function(a){t.$emit("setErrorMessage",a)},i=_.isEmpty(t.contactInformation)?o.id:t.contactInformation.id,c={successCallBack:e,failureCallBack:n,params:{query:t.contractData.rateSearchQuery,selected_rate_ids:_.pluck(t.contractData.selectedRateList,"id"),account_id:i}};"EDIT"===t.contractData.mode&&(c.params.contract_id=t.contractData.selectedContractId),t.callAPI(a.fetchRateContract,c)},t.searchRate=function(){t.contractData.rateSearchQuery.length>2?r.fetchRateContract():t.contractData.searchResults=[]},t.clearQuery=function(){t.contractData.rateSearchQuery="",t.contractData.searchResults=[],t.$emit("refreshContractsScroll")},t.clickedOnResult=function(e){var n=t.contractData.searchResults[e],r=function(){t.contractData.selectedRateList.push(n),t.$emit("refreshContractsScroll"),t.contractData.searchResults=[],t.contractData.rateSearchQuery=""},i=function(a){t.$emit("setErrorMessage",a)},c=_.isEmpty(t.contactInformation)?o.id:t.contactInformation.id,s={successCallBack:r,failureCallBack:i,params:{id:t.contractData.selectedContractId,rate_id:n.id,account_id:c}};t.callAPI(a.linkRate,s)},t.removeRate=function(a){t.rateObj=t.contractData.selectedRateList[a],n.open({template:"/assets/partials/companyCard/contracts/rvConfirmRemoveRate.html",className:"",closeByDocument:!1,scope:t})};var c=function(a){t.rateErrorMessage=a[0],n.open({template:"/assets/partials/companyCard/contracts/rvErrorOnRemoveRate.html",className:"",closeByDocument:!1,scope:t})};t.confirmRemoveRate=function(e){n.close();var r=function(){var a=t.contractData.selectedRateList.map(function(t){return t.id}).indexOf(e);t.contractData.selectedRateList.splice(a,1),t.$emit("refreshContractsScroll")},i=function(t){c(t)},s=_.isEmpty(t.contactInformation)?o.id:t.contactInformation.id,l={successCallBack:r,failureCallBack:i,params:{id:t.contractData.selectedContractId,rate_id:e,account_id:s}};t.callAPI(a.unlinkRate,l)},r.initialise()}]),sntRover.controller("rvContractEndCalendarCtrl",["$rootScope","$scope","dateFilter","ngDialog",function(t,a,e,n){
a.setUpData=function(){var e,o=moment(t.businessDate);"ADD"===a.contractData.mode?o=a.addData.startDate?moment(a.addData.startDate):o:"EDIT"===a.contractData.mode&&(o=a.contractData.editData&&a.contractData.editData.begin_date?moment(a.contractData.editData.begin_date):o),e=moment(o).add(10,"years"),o.add(1,"days"),"ADD"===a.contractData.mode?a.date=a.addData.endDate?tzIndependentDate(a.addData.endDate):tzIndependentDate(o):"EDIT"===a.contractData.mode&&(_.isEmpty(a.contractData.editData)?a.date=tzIndependentDate(o):a.date=a.contractData.editData.end_date?tzIndependentDate(a.contractData.editData.end_date):tzIndependentDate(o)),a.dateOptions={changeYear:!0,changeMonth:!0,minDate:tzIndependentDate(o),maxDate:tzIndependentDate(e),yearRange:o.year()+":"+e.year(),onSelect:function(){var t=moment(a.date);"ADD"===a.contractData.mode?a.addData.endDate=t.format("YYYY-MM-DD"):"EDIT"===a.contractData.mode&&(a.contractData.editData.end_date=t.format("YYYY-MM-DD")),n.close()}}},a.setUpData()}]),sntRover.controller("rvContractStartCalendarCtrl",["$rootScope","$scope","ngDialog",function(t,a,e){a.setUpData=function(){a.isDateSelected=!1;var n="";n=t.businessDate,"ADD"===a.contractData.mode?a.date=a.addData.startDate||n:"EDIT"===a.contractData.mode&&(_.isEmpty(a.contractData.editData)?a.date=n:a.date=a.contractData.editData.begin_date||n),a.dateOptions={changeYear:!0,changeMonth:!0,minDate:tzIndependentDate(n),yearRange:"0:+10",onSelect:function(){var t=moment(a.date).add(1,"days"),n=moment(a.date);"ADD"===a.contractData.mode?(a.addData.startDate=n.format("YYYY-MM-DD"),(!a.addData.endDate||a.addData.startDate>=a.addData.endDate)&&(a.addData.endDate=t.format("YYYY-MM-DD"))):"EDIT"===a.contractData.mode&&(a.contractData.editData.begin_date=n.format("YYYY-MM-DD"),a.contractData.editData.begin_date>=a.contractData.editData.end_date&&(a.contractData.editData.end_date=t.format("YYYY-MM-DD"))),e.close()}}},a.setUpData()}]),sntRover.controller("rvContractedNightsCtrl",["$rootScope","$scope","dateFilter","ngDialog",function(t,a,e,n){a.nightsData={},a.nightsData.occupancy=[],a.nightsData.allNights="";var o,r,i,c=tzIndependentDate(t.businessDate);"ADD"===a.contractData.mode?(c=a.addData.startDate?tzIndependentDate(a.addData.startDate):c,o=e(c,"yyyy-MM-dd"),r=a.addData.endDate||e(c.setDate(c.getDate()+1),"yyyy-MM-dd"),i=a.addData.occupancy):"EDIT"===a.contractData.mode&&(c=a.contractData.editData&&a.contractData.editData.begin_date?tzIndependentDate(a.contractData.editData.begin_date):c,o=e(c,"yyyy-MM-dd"),r=a.contractData.editData.end_date||e(c.setDate(c.getDate()+1),"yyyy-MM-dd"),i=a.contractData.editData.occupancy);for(var s=tzIndependentDate(o),l=tzIndependentDate(r),d=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],u=[],m=12*s.getFullYear()+s.getMonth(),f=12*l.getFullYear()+l.getMonth(),p=m;p<=f;){var _=Math.floor(p/12),v=p-12*_,h={contracted_occupancy:0,year:_.toString(),actual_occupancy:0,month:d[v]};u.push(h),p+=1}angular.forEach(i,function(t){angular.forEach(u,function(a){a.year===t.year&&a.month===t.month&&(a.contracted_occupancy=t.contracted_occupancy,a.actual_occupancy=t.actual_occupancy)})}),a.nightsData.occupancy=u;var D=function(){var t=0;return angular.forEach(a.nightsData.occupancy,function(a){t+=a.contracted_occupancy}),t};a.saveContractedNights=function(){"ADD"===a.contractData.mode?(a.addData.occupancy=a.nightsData.occupancy,a.addData.contractedNights=D()):"EDIT"===a.contractData.mode&&(a.contractData.editData.occupancy=a.nightsData.occupancy,a.contractData.editData.total_contracted_nights=D()),n.close()},a.clickedCancel=function(){n.close()},a.updateAllNights=function(){angular.forEach(a.nightsData.occupancy,function(t){t.contracted_occupancy=a.nightsData.allNights})};var y=function(){a.setScroller("contractedNightsScroller")};y()}]),sntRover.controller("RVAccountReceivableMessagePopupCtrl",["$rootScope","$scope","$state","ngDialog","$timeout","RVCompanyCardSrv","rvPermissionSrv",function(t,a,e,n,o,r,i){BaseCtrl.call(this,a),a.isCreateNewARAccountMode=!1,a.data={},a.isCreateButtonDisabled=!1,a.createAccountAction=function(){if("undefined"!=typeof a.reservationBillData&&"true"===a.reservationBillData.is_auto_assign_ar_numbers||"undefined"!=typeof a.is_auto_assign_ar_numbers&&a.is_auto_assign_ar_numbers){var t=!0;a.createAccountReceivable(t)}else a.isCreateNewARAccountMode=!0},a.successCreate=function(e){"undefined"!=typeof a.reservationBillData&&(a.reservationBillData.ar_number=e.ar_number,a.reservationBillData.bills[a.currentActiveBill].ar_number=e.ar_number,a.reservationBillData.bills[a.currentActiveBill].has_ar_account=!0),n.close(),o(function(){t.$emit("arAccountCreated")},500)},a.failureCreate=function(t){a.$emit("hideLoader"),a.errorMessage=t,a.isCreateButtonDisabled=!1,"Please complete required AR Account Information"===a.errorMessage[0]&&(a.isCreateButtonDisabled=!0)},a.createAccountReceivable=function(t){var e={id:a.reservationBillData.bills[a.currentActiveBill].account_id,ar_number:t?"":a.data.ar_number};a.invokeApi(r.saveARDetails,e,a.successCreate,a.failureCreate)},a.closeDialog=function(){n.close()},a.cancelButtonClick=function(){a.errorMessage="",a.isCreateNewARAccountMode=!1},a.hasPermissionToCreateArAccount=function(){return i.getPermissionValue("CREATE_AR_ACCOUNT")}}]),sntRover.controller("RVAddPaymentMethodCrtl",["$scope","$rootScope",function(t,a){}]),sntRover.controller("RVPaymentCompanyCardCtrl",["$rootScope","$scope","$state","RVPaymentSrv","RVCompanyCardSrv","ngDialog",function(t,a,e,n,o,r){BaseCtrl.call(this,a),a.$on("clearNotifications",function(){a.errorMessage="",a.successMessage=""});var i={data:[],paymentTypes:[]};a.paymentData=i,a.updateErrorMessage=function(t){a.errorMessage=t},a.openAddNewPaymentModel=function(){a.callAPI(n.renderPaymentScreen,{params:{direct_bill:!1},onSuccess:function(t){var e=_.find(t,function(t){return"CC"===t.name}),n={fromView:"companyTravelAgent",isFromWallet:!0,accountId:a.contactInformation.id,details:{}},o=a.paymentData;o.paymentTypes=[e],a.openPaymentDialogModal(n,o)}})},a.fetchAttachedPaymentTypes=function(){var t=function(t){a.paymentData=t,a.$parent.$emit("hideLoader")},e=function(t){a.$parent.$emit("hideLoader"),a.$emit("displayErrorMessage",t)};a.invokeApi(o.fetchCompanyPaymentData,a.contactInformation.id,t,e)},a.addListener("wallet",function(){a.fetchAttachedPaymentTypes()}),a.openDeleteSetAsPrimaryModal=function(t,e){a.paymentData.payment_id=t,a.paymentData.index=e,a.paymentData.accountId=a.contactInformation.id,a.paymentData.isFromWallet=!0,r.open({template:"/assets/partials/payment/rvDeleteSetAsPrimary.html",controller:"RVDeleteSetAsPrimaryCtrl",scope:a})},a.$on("ADDEDNEWPAYMENTTOCOTA",function(t,e){"undefined"==typeof a.paymentData.data&&(a.paymentData.data=[]),_.find(a.paymentData.data,{id:e.id})||a.paymentData.data.push(e),a.refreshScroller("paymentList")}),function(){var t={preventDefault:!1};a.setScroller("paymentList",t),a.$on("$viewContentLoaded",function(){a.refreshScroller("paymentList")}),a.$on("REFRESHLIKESSCROLL",function(){a.refreshScroller("paymentList")})}()}]),sntRover.controller("RVCreateAccountReceivableCtrl",["$rootScope","$scope","$state","RVCompanyCardSrv","ngDialog",function(t,a,e,n,o){BaseCtrl.call(this,a),a.ar_number="",a.createAccountReceivable=function(){var t={id:a.account_id,ar_number:a.ar_number};a.invokeApi(n.saveARDetails,t,a.successCreate,a.failureCreate)},a.closeDialog=function(){o.close()}}]),sntRover.controller("RVDeleteSetAsPrimaryCtrl",["$rootScope","$scope","$state","RVPaymentSrv","RVCompanyCardSrv","ngDialog",function(t,a,e,n,o,r){BaseCtrl.call(this,a),a.successSetAsPrimary=function(){angular.forEach(a.paymentData.data,function(t,a){t.is_primary=!1}),a.paymentData.data[a.paymentData.index].is_primary=!0,a.refreshScroller("paymentList"),a.$emit("hideLoader"),r.close()},a.successDelete=function(){a.paymentData.data.splice(a.paymentData.index,1),a.$emit("hideLoader"),r.close()},a.failureCallBack=function(t){a.$emit("hideLoader"),a.updateErrorMessage(t),a.refreshScroller("paymentList"),a.closeDialog()},a.setAsPrimary=function(){if(a.paymentData.isFromWallet){var t={associated_payment_method_id:a.paymentData.payment_id,account_id:a.paymentData.accountId};a.invokeApi(o.setAsPrimary,t,a.successSetAsPrimary,a.failureCallBack)}else{var t={id:a.paymentData.payment_id,user_id:a.paymentData.user_id};a.invokeApi(n.setAsPrimary,t,a.successSetAsPrimary,a.failureCallBack)}},a.deletePayment=function(){if(a.paymentData.isFromWallet){var t={associated_payment_method_id:a.paymentData.payment_id,account_id:a.paymentData.accountId};a.invokeApi(o.deletePayment,t,a.successDelete,a.failureCallBack)}else{var t={id:a.paymentData.payment_id};a.invokeApi(n.deletePayment,t,a.successDelete,a.failureCallBack)}}}]),sntRover.controller("RVPaymentGuestCtrl",["$rootScope","$scope","$state","RVPaymentSrv","ngDialog",function(t,a,e,n,o){BaseCtrl.call(this,a),a.$on("clearNotifications",function(){a.errorMessage="",a.successMessage=""}),a.updateErrorMessage=function(t){a.errorMessage=t},a.openAddNewPaymentModel=function(){a.callAPI(n.renderPaymentScreen,{params:{direct_bill:!1},onSuccess:function(t){var e=_.find(t,function(t){return"CC"===t.name}),n={guest_id:a.guestCardData.contactInfo.user_id,isFromGuestCard:!0,details:{firstName:a.guestCardData.contactInfo.first_name,lastName:a.guestCardData.contactInfo.last_name}},o=a.paymentData;o.paymentTypes=[e],a.openPaymentDialogModal(n,o)}})},a.openDeleteSetAsPrimaryModal=function(t,e){a.paymentData.payment_id=t,a.paymentData.index=e,o.open({template:"/assets/partials/payment/rvDeleteSetAsPrimary.html",controller:"RVDeleteSetAsPrimaryCtrl",scope:a})},a.$on("ADDEDNEWPAYMENTTOGUEST",function(t,e){"undefined"==typeof a.paymentData.data&&(a.paymentData.data=[]),_.find(a.paymentData.data,{id:e.id})||a.paymentData.data.push(e),a.refreshScroller("paymentList")}),function(){var t={preventDefault:!1};a.setScroller("paymentList",t),a.$on("$viewContentLoaded",function(){a.refreshScroller("paymentList")}),a.$on("REFRESHLIKESSCROLL",function(){a.refreshScroller("paymentList")})}()}]),sntRover.controller("RVShowPaymentListCtrl",["$rootScope","$scope","$state","RVPaymentSrv","ngDialog","rvPermissionSrv",function(t,a,e,n,o,r){BaseCtrl.call(this,a),a.showNoValues=!1;var i=r.getPermissionValue("REMOVE_CREDIT_CARD_FROM_STAYCARD");a.paymentListSuccess=function(t){a.$emit("hideLoader"),a.paymentListData=t,angular.forEach(a.paymentListData.existing_payments,function(t,e){if(!t.is_credit_card)return void a.paymentListData.existing_payments.splice(e,1)}),a.paymentListLength=a.paymentListData.existing_payments.length,0===a.paymentListLength&&(a.showNoValues=!0)};var c="",s=1;"billCard"===a.dataToPaymentList.currentView?(c=a.dataToPaymentList.reservation_id,s=a.dataToPaymentList.bills[a.dataToPaymentList.currentActiveBill].bill_number):c=a.dataToPaymentList.reservation_card.reservation_id;var l={reservation_id:c,bill_number:s};a.invokeApi(n.getExistingPaymentsForBill,l,a.paymentListSuccess),a.clickPaymentItem=function(e,r,i,s,l,d){var u={reservation_id:c,user_payment_type_id:e};"billCard"===a.dataToPaymentList.currentView&&(u.bill_number=a.dataToPaymentList.bills[a.dataToPaymentList.currentActiveBill].bill_number);var m=function(t){a.$emit("hideLoader"),a.errorMessage=t},f=function(e){var n;a.$emit("hideLoader"),t.$emit("UPDATECCATTACHEDBILLSTATUS",e.has_any_credit_card_attached_bill),o.close(),"billCard"===a.dataToPaymentList.currentView?(n=a.dataToPaymentList.currentActiveBill,a.dataToPaymentList.bills[n].credit_card_details.card_code=r.toLowerCase(),a.dataToPaymentList.bills[n].credit_card_details.card_number=i,a.dataToPaymentList.bills[n].credit_card_details.card_expiry=s,a.dataToPaymentList.bills[n].credit_card_details.is_swiped=l,a.dataToPaymentList.bills[n].credit_card_details.auth_color_code=d,a.dataToPaymentList.bills[n].credit_card_details.payment_id=e.id,a.dataToPaymentList.bills[n].credit_card_details.token=e.token,0===n&&t.$emit("UPDATEDPAYMENTLIST",a.dataToPaymentList.bills[n].credit_card_details)):(a.dataToPaymentList.reservation_card.payment_details.card_type_image="images/"+r.toLowerCase()+".png",a.dataToPaymentList.reservation_card.payment_details.card_number=i,a.dataToPaymentList.reservation_card.payment_details.card_expiry=s,a.dataToPaymentList.reservation_card.payment_method_used="CC",a.dataToPaymentList.reservation_card.payment_method_description="Credit Card",a.dataToPaymentList.reservation_card.payment_details.is_swiped=l,a.dataToPaymentList.reservation_card.payment_details.auth_color_code=d,a.dataToPaymentList.reservation_card.payment_details.id=e.id,a.dataToPaymentList.reservation_card.restrict_post=e.restrict_post)};a.invokeApi(n.mapPaymentToReservation,u,f,m)},a.$parent.myScrollOptions={paymentList:{scrollbars:!0,snap:!1,hideScrollbar:!1,preventDefault:!1}},a.$on("$viewContentLoaded",function(){setTimeout(function(){a.$parent.myScroll.paymentList.refresh()},3e3)}),a.openAddNewPaymentModel=function(){a.closeDialog(),t.$broadcast("OPENPAYMENTMODEL")},a.deleteCreditCard=function(t){var e=function(){a.closeDialog()},o=function(t){a.errorMessage=t};a.callAPI(n.deleteCreditCard,{onSuccess:e,onFailure:o,params:{reservation_id:c,payment_method_id:t}})},a.shouldShowCreditCardDeleteBtn=function(){return t.isStandAlone&&i&&"rover.reservation.staycard.reservationcard.reservationdetails"===e.current.name}}]),sntRover.controller("RVPleaseSwipeCtrl",["$rootScope","$scope","sntPaymentSrv",function(t,a,e){BaseCtrl.call(this,a),a.state={numAttempts:0},a.addCardOWS=function(){a.$emit("SHOW_SIX_PAY_LOADER"),a.callAPI(e.getSixPaymentToken,{params:{reservation_id:a.reservationBillData.reservation_id,workstation_id:a.workstation_id},successCallBack:function(){a.$emit("REFRESH_BILLCARD_VIEW"),a.$emit("HIDE_SIX_PAY_LOADER"),a.closeDialog()},failureCallBack:function(t){a.state.numAttempts++,a.errorMessage=t,a.$emit("HIDE_SIX_PAY_LOADER")}})}}]),sntRover.controller("reservationPaymentController",["$scope","$rootScope","RVReservationSummarySrv","rvPermissionSrv",function(t,a,e,n){t.getHasButtonClass=function(){var a=t.reservationData.reservation_card.has_any_credit_card_attached_bill,e="has-button";return a&&t.showCCAuthButton()&&(e="has-buttons"),e},t.displayButton=function(){var a=t.reservationData.reservation_card.reservation_status,e=!0;return"NOSHOW"!==a&&"CHECKEDOUT"!==a&&"CANCELED"!==a||(e=!1),e},t.showCCAuthButton=function(){return!(!t.reservationData.reservation_card.has_any_credit_card_attached_bill||!t.isStandAlone)};var o=function(){t.reservationData.reservation_card.restrict_post=!t.reservationData.reservation_card.restrict_post};t.setAllowPostWithNoCredit=function(){if(n.getPermissionValue("ALLOW_POST_WHEN_RESTRICTED")){var a={restrict_post:!t.reservationData.reservation_card.restrict_post,reservationId:t.reservationData.reservation_card.reservation_id},r={params:a,successCallBack:o};t.callAPI(e.updateRestrictPost,r)}},t.showPostWithNoCreditButton=function(){var e=!0;return a.isStandAlone&&""!==t.reservationData.reservation_card.payment_method_used&&null!==t.reservationData.reservation_card.payment_method_used||(e=!1),e},a.$on("UPDATEDPAYMENTLIST",function(a,e){t.reservationData.reservation_card.payment_details.card_type_image=e.card_code+".png",t.reservationData.reservation_card.payment_details.card_number=e.card_number,t.reservationData.reservation_card.payment_details.card_expiry=e.card_expiry,t.reservationData.reservation_card.payment_details.is_swiped=e.is_swiped}),a.$on("UPDATECCATTACHEDBILLSTATUS",function(a,e){t.reservationData.reservation_card.has_any_credit_card_attached_bill=e})}]),sntRover.controller("RvArAllocatedController",["$scope","$timeout","ngDialog","rvAccountsArTransactionsSrv","sntActivity",function(t,a,e,n,o){BaseCtrl.call(this,t);var r={preventDefaultException:{tagName:/^(INPUT|LI)$/},preventDefault:!1};t.setScroller("allocated-list-scroller",r);var i=function(){a(function(){t.refreshScroller("allocated-list-scroller")},700)};t.$on("REFRESH_ALLOCATED_LIST_SCROLLER",function(){i()});var c=function(a){o.start("EXPAND_ALLOCATED");var e=function(t){o.stop("EXPAND_ALLOCATED"),a.transactions=t.allocated_transactions,a.active=!0,i()},r=function(a){o.stop("EXPAND_ALLOCATED"),t.$emit("SHOW_ERROR_MSG",a)},c={id:a.transaction_id,account_id:t.arDataObj.accountId};t.invokeApi(n.expandAllocateAndUnallocatedList,c,e,r)};t.clickedAllocatedListItem=function(a){var e=t.arDataObj.allocatedList[a];e.active?(e.active=!1,i()):c(e)},t.clickedUnallocateButton=function(a){var o=function(a){t.selectedUnAllocatedItem=a,e.open({template:"/assets/partials/companyCard/arTransactions/rvCompanyTravelAgentUnallocatePopup.html",scope:t})},r={},i={};r.allocation_id=a.id,i.account_id=t.arDataObj.accountId,i.data=r;var c={params:i,successCallBack:o};t.callAPI(n.unAllocateData,c)},t.unAllocate=function(){var a={},o={},r=function(){t.$emit("REFRESH_ALLOCATED"),e.close()};a.allocation_id=t.selectedUnAllocatedItem.allocation_id,a.credit_id=t.selectedUnAllocatedItem.from_bill.transaction_id,a.debit_id=t.selectedUnAllocatedItem.to_payment.transaction_id,a.amount=t.selectedUnAllocatedItem.amount,o.account_id=t.arDataObj.accountId,o.data=a;var i={params:o,successCallBack:r};t.callAPI(n.unAllocateSelectedPayment,i)}}]),sntRover.controller("RvArBalanceController",["$scope","$timeout","rvAccountsArTransactionsSrv","RVCompanyCardSrv","$vault","$stateParams","$state","sntActivity","ngDialog",function(t,a,e,n,o,r,i,c,s){BaseCtrl.call(this,t);var l={preventDefaultException:{tagName:/^(INPUT|LI)$/},preventDefault:!1};t.setScroller("balance-list",l);var d=function(){a(function(){t.refreshScroller("balance-list")},1e3)};t.$on("FETCH_COMPLETE_BALANCE_LIST",function(){d(),t.arDataObj.totalOfAllInvoicesInBalanceTab=0,_.each(t.arDataObj.balanceList,function(a){t.arDataObj.totalOfAllInvoicesInBalanceTab=parseFloat(t.arDataObj.totalOfAllInvoicesInBalanceTab)+parseFloat(a.amount)}),t.arDataObj.totalAllocatedAmount=Number(parseFloat(t.arDataObj.totalOfAllInvoicesInBalanceTab).toFixed(2))});var u=function(){t.arDataObj.totalAllocatedAmount=0,_.each(t.arDataObj.balanceList,function(a){a.isSelected&&(t.arDataObj.totalAllocatedAmount=parseFloat(t.arDataObj.totalAllocatedAmount)+parseFloat(a.amount))}),t.arDataObj.totalAllocatedAmount=Number(parseFloat(t.arDataObj.totalAllocatedAmount).toFixed(2))};t.changeBalanceAmount=function(a){t.arDataObj.balanceList[a].amount=parseFloat(t.arDataObj.balanceList[a].amount)>parseFloat(t.arDataObj.balanceList[a].initialAmount)?t.arDataObj.balanceList[a].initialAmount:t.arDataObj.balanceList[a].amount,t.arDataObj.balanceList[a].balanceAfter=t.arDataObj.balanceList[a].initialAmount-t.arDataObj.balanceList[a].amount,t.arDataObj.balanceList[a].balanceNow=t.arDataObj.balanceList[a].amount;var e=_.findWhere(t.arDataObj.selectedInvoices,{invoice_id:t.arDataObj.balanceList[a].transaction_id});e.amount=parseFloat(t.arDataObj.balanceList[a].amount),u()},t.addDecimal=function(a){t.arDataObj.balanceList[a].amount=parseFloat(t.arDataObj.balanceList[a].amount).toFixed(2)};var m=function(e,n){t.arFlags.insufficientAmount=!1,a(function(){_.each(t.arDataObj.balanceList,function(a){if(a.transaction_id===e){a.isSelected=!a.isSelected;var n={};n.invoice_id=e,n.amount=a.amount,a.isSelected?t.arDataObj.selectedInvoices.push(n):(n.amount=a.initialAmount,t.arDataObj.selectedInvoices=_.filter(t.arDataObj.selectedInvoices,function(t){return t.invoice_id!==e}))}}),t.arDataObj.balanceList[n].amount=t.arDataObj.balanceList[n].initialAmount,t.arDataObj.balanceList[n].balanceAfter=0,t.arDataObj.balanceList[n].balanceNow=t.arDataObj.balanceList[n].amount,u()},400)},f=function(a){c.start("EXPAND_BALANCE");var n=function(t){c.stop("EXPAND_BALANCE"),a.active=!0,a.debits=t.debits,a.payments=t.payments,d()},o=function(a){c.stop("EXPAND_BALANCE"),t.$emit("SHOW_ERROR_MSG",a)},r={id:a.transaction_id,account_id:t.arDataObj.accountId};t.invokeApi(e.expandPaidAndUnpaidList,r,n,o)};t.clickedOnParentList=function(a,e){var n=t.arDataObj.balanceList[e],o=a.target,r=n.amount;a.stopImmediatePropagation(),a.stopPropagation(),r>=0&&(o.parentElement.classList.contains("checkbox")||o.classList.contains("checkbox"))?m(n.transaction_id,e):o.parentElement.classList.contains("actions")||o.classList.contains("icon-edit-40")||o.classList.contains("icon-double-arrow")||o.classList.contains("text-box")||o.classList.contains("button-edit")||p(e)};var p=function(a){var e=t.arDataObj.balanceList[a];e.active?(e.active=!1,d()):f(e)};t.goToReservationDetails=function(a){var e=t.arDataObj.balanceList[a];if(t.arFlags.viewFromOutside){o.set("cardId",r.id),o.set("type",r.type),o.set("query",r.query);var n=e.associated_type,c=e.associated_id;"Reservation"===n?i.go("rover.reservation.staycard.reservationcard.reservationdetails",{id:c,confirmationId:e.reservation_confirm_no,isrefresh:!0,isFromCards:!0,isFromArTab:"balance"}):"PostingAccount"===n&&i.go("rover.accounts.config",{id:c,activeTab:"ACCOUNT",isFromArTransactions:!0,isFromArTab:"balance"})}},t.clickedUnallocateButton=function(a){var n=function(a){t.selectedUnAllocatedItem=a,s.open({template:"/assets/partials/companyCard/arTransactions/rvCompanyTravelAgentUnallocatePopup.html",scope:t})},o={},r={};o.allocation_id=a.id,r.account_id=t.arDataObj.accountId,r.data=o;var i={params:r,successCallBack:n};t.callAPI(e.unAllocateData,i)},t.unAllocate=function(){var a={},n={},o=function(){t.$emit("REFRESH_BALANCE_LIST"),s.close()};a.allocation_id=t.selectedUnAllocatedItem.allocation_id,a.credit_id=t.selectedUnAllocatedItem.from_bill.transaction_id,a.debit_id=t.selectedUnAllocatedItem.to_payment.transaction_id,a.amount=t.selectedUnAllocatedItem.amount,n.account_id=t.arDataObj.accountId,n.data=a;var r={params:n,successCallBack:o};t.callAPI(e.unAllocateSelectedPayment,r)},t.expandGroupedCharge=function(a){a.isExpanded?(a.isExpanded=!1,d()):t.callAPI(n.groupChargeDetailsFetch,{params:{reference_number:a.reference_number,date:a.date,bill_id:a.bill_id},successCallBack:function(t){a.light_speed_data=t.data,a.isExpanded=!0,d()},failureCallBack:function(a){t.$emit("SHOW_ERROR_MSG",a)}})},t.moveInvoiceButtonClick=function(a){var e={firstName:a.guest_first_name,lastName:a.guest_last_name,accountName:a.account_name,invoiceNumber:a.invoice_number,confirmationNumber:a.reservation_confirm_no,arrivalDate:a.reservation_arrival_date,arrivalTime:a.reservation_arrival_time,departureDate:a.reservation_dep_date,departureTime:a.reservation_dep_time,amount:a.amount,image:a.icon_url,transactionId:a.transaction_id,associatedType:a.associated_type};t.moveInvoiceHeaderData=e,s.open({template:"/assets/partials/companyCard/arTransactions/rvArMoveInvoiceToArPopup.html",controller:"rvArMoveInvoiceCtrl",className:"",closeByDocument:!1,scope:t})},t.clickedEditIconToAdjustInvoice=function(a,e){t.selectedInvoice=t.arDataObj.balanceList[a],t.selectedTransaction=t.arDataObj.balanceList[a].debits[e],s.open({template:"/assets/partials/companyCard/arTransactions/rvArInvoiceAdjustPopup.html",scope:t,controller:"RvArInvoiceAdjustController"})},t.clickedPostCharge=function(a){t.selectedItemToPostCharge=t.arDataObj.balanceList[a],s.open({template:"/assets/partials/companyCard/arTransactions/rvArTransactionPostCharge.html",controller:"RvArPostChargeController",scope:t})},t.moveToCreditButtonClicked=function(a){t.callAPI(e.moveToCreditInvoice,{params:{invoice_id:a.transaction_id,account_id:t.arDataObj.accountId,amount:a.amount},successCallBack:function(){t.$emit("REFRESH_BALANCE_LIST")},failureCallBack:function(a){t.$emit("SHOW_ERROR_MSG",a)}})}}]),sntRover.controller("RvArInvoiceAdjustController",["$scope","$timeout","rvAccountsArTransactionsSrv",function(t,a,e){BaseCtrl.call(this,t),t.adjustData={};var n=function(){var a=function(a){t.adjustData=a.charge_details[0],t.show_reference_on_guest_invoice=a.charge_details[0].is_reference_text_shown},n={},o={};o.is_group_by_ref=t.selectedTransaction.is_group_by_ref,o.reference_number=t.selectedTransaction.reference_number,o.bill_id=t.selectedInvoice.is_manual_balance?t.selectedTransaction.bill_id:t.selectedInvoice.bill_id,t.selectedInvoice.is_manual_balance||(o.financial_transaction_id=t.selectedTransaction.id),o.ar_transaction_id=t.selectedInvoice.transaction_id,o.item_ids=t.selectedTransaction.item_ids,o.is_manual_balance=t.selectedInvoice.is_manual_balance,n.requestParams=o,n.accountId=t.arDataObj.accountId,n.arTransactionId=t.selectedInvoice.transaction_id;var r={params:n,successCallBack:a};t.callAPI(e.getAdjustmentInfo,r)};t.enteredAmount=function(){t.new_amount=parseFloat(t.new_amount).toFixed(2)},t.clickedAdjust=function(){var a={new_amount:t.adjustData.amount,reference_text:t.adjustData.reference_text,show_ref_on_invoice:t.show_reference_on_guest_invoice,is_manual_balance:t.selectedInvoice.is_manual_balance};t.selectedTransaction.is_adjustment&&(a.change_reference_only=t.selectedTransaction.is_adjustment),t.selectedTransaction.is_group_by_ref?a.financial_transaction_id=t.selectCharge:t.selectedInvoice.is_manual_balance?a.ar_transaction_id=t.selectedTransaction.id:a.financial_transaction_id=t.selectedTransaction.id;var n=function(){t.closeDialog(),t.$emit("REFRESH_BALANCE_LIST")},o={};o.accountId=t.arDataObj.accountId,o.arTransactionId=t.selectedInvoice.transaction_id,o.postData=a;var r={params:o,successCallBack:n};t.callAPI(e.postAdjustmentInfo,r)},n()}]),sntRover.controller("RvArOnHoldController",["$scope","$timeout","rvAccountsArTransactionsSrv","RVCompanyCardSrv","$vault","$stateParams","$state","sntActivity","ngDialog",function(t,a,e,n,o,r,i,c,s){BaseCtrl.call(this,t);var l={preventDefaultException:{tagName:/^(INPUT|LI)$/},preventDefault:!1};t.setScroller("onhold-list",l);var d=function(){a(function(){t.refreshScroller("onhold-list")},1e3)};t.addListener("FETCH_COMPLETE_ONHOLD_LIST",function(){d(),t.arDataObj.totalOfAllInvoicesInOnHoldTab=0,_.each(t.arDataObj.onHoldList,function(a){t.arDataObj.totalOfAllInvoicesInOnHoldTab=parseFloat(t.arDataObj.totalOfAllInvoicesInOnHoldTab)+parseFloat(a.amount)})});var u=function(e){a(function(){_.each(t.arDataObj.onHoldList,function(a){if(a.transaction_id===e){a.isonHoldSelected=!a.isonHoldSelected;var n={};n.invoice_id=e,a.isonHoldSelected?t.arDataObj.selectedOnHoldInvoices.push(n):t.arDataObj.selectedOnHoldInvoices=_.filter(t.arDataObj.selectedOnHoldInvoices,function(t){return t.invoice_id!==e})}})},400)},m=function(a){c.start("EXPAND_BALANCE");var n=function(t){c.stop("EXPAND_BALANCE"),a.active=!0,a.debits=t.debits,a.payments=t.payments,d()},o=function(a){c.stop("EXPAND_BALANCE"),t.$emit("SHOW_ERROR_MSG",a)},r={id:a.transaction_id,account_id:t.arDataObj.accountId},i={params:r,successCallBack:n,failureCallBack:o};t.callAPI(e.expandPaidAndUnpaidList,i)};t.clickedOnParentList=function(a,e){var n=t.arDataObj.onHoldList[e],o=a.target,r=n.amount;a.stopImmediatePropagation(),a.stopPropagation(),r>=0&&(o.parentElement.classList.contains("checkbox")||o.classList.contains("checkbox"))?u(n.transaction_id,e):o.parentElement.classList.contains("actions")||o.classList.contains("icon-edit-40")||o.classList.contains("icon-double-arrow")||o.classList.contains("text-box")||o.classList.contains("button-edit")||f(e)};var f=function(a){var e=t.arDataObj.onHoldList[a];e.active?(e.active=!1,d()):m(e)};t.goToReservationDetails=function(a){var e=t.arDataObj.onHoldList[a];if(t.arFlags.viewFromOutside){o.set("cardId",r.id),o.set("type",r.type),o.set("query",r.query);var n=e.associated_type,c=e.associated_id;"Reservation"===n?i.go("rover.reservation.staycard.reservationcard.reservationdetails",{id:c,confirmationId:e.reservation_confirm_no,isrefresh:!0,isFromCards:!0,isFromArTab:"on-hold"}):"PostingAccount"===n&&i.go("rover.accounts.config",{id:c,activeTab:"ACCOUNT",isFromArTransactions:!0,isFromArTab:"on-hold"})}},t.clickedUnallocateButton=function(a){var n=function(a){t.selectedUnAllocatedItem=a,s.open({template:"/assets/partials/companyCard/arTransactions/rvCompanyTravelAgentUnallocatePopup.html",scope:t})},o={},r={};o.allocation_id=a.id,r.account_id=t.arDataObj.accountId,r.data=o;var i={params:r,successCallBack:n};t.callAPI(e.unAllocateData,i)},t.unAllocate=function(){var a={},n={},o=function(){t.$emit("REFRESH_BALANCE_LIST"),s.close()};a.allocation_id=t.selectedUnAllocatedItem.allocation_id,a.credit_id=t.selectedUnAllocatedItem.from_bill.transaction_id,a.debit_id=t.selectedUnAllocatedItem.to_payment.transaction_id,a.amount=t.selectedUnAllocatedItem.amount,n.account_id=t.arDataObj.accountId,n.data=a;var r={params:n,successCallBack:o};t.callAPI(e.unAllocateSelectedPayment,r)},t.expandGroupedCharge=function(a){a.isExpanded?(a.isExpanded=!1,d()):t.callAPI(n.groupChargeDetailsFetch,{params:{reference_number:a.reference_number,date:a.date,bill_id:a.bill_id},successCallBack:function(t){a.light_speed_data=t.data,a.isExpanded=!0,d()},failureCallBack:function(a){t.$emit("SHOW_ERROR_MSG",a)}})},t.moveInvoiceButtonClick=function(a){var e={firstName:a.guest_first_name,lastName:a.guest_last_name,accountName:a.account_name,invoiceNumber:a.invoice_number,confirmationNumber:a.reservation_confirm_no,arrivalDate:a.reservation_arrival_date,arrivalTime:a.reservation_arrival_time,departureDate:a.reservation_dep_date,departureTime:a.reservation_dep_time,amount:a.amount,image:a.icon_url,transactionId:a.transaction_id,associatedType:a.associated_type};t.moveInvoiceHeaderData=e,s.open({template:"/assets/partials/companyCard/arTransactions/rvArMoveInvoiceToArPopup.html",controller:"rvArMoveInvoiceCtrl",className:"",closeByDocument:!1,scope:t})},t.clickedEditIconToAdjustInvoice=function(a,e){t.selectedInvoice=t.arDataObj.onHoldList[a],t.selectedTransaction=t.arDataObj.onHoldList[a].debits[e],s.open({template:"/assets/partials/companyCard/arTransactions/rvArInvoiceAdjustPopup.html",scope:t,controller:"RvArInvoiceAdjustController"})},t.clickedPostCharge=function(a){t.selectedItemToPostCharge=t.arDataObj.onHoldList[a],s.open({template:"/assets/partials/companyCard/arTransactions/rvArTransactionPostCharge.html",controller:"RvArPostChargeController",scope:t})},t.moveToCreditButtonClicked=function(a){t.callAPI(e.moveToCreditInvoice,{params:{invoice_id:a.transaction_id,account_id:t.arDataObj.accountId,amount:a.amount},successCallBack:function(){t.$emit("REFRESH_BALANCE_LIST")},failureCallBack:function(a){t.$emit("SHOW_ERROR_MSG",a)}})}}]),sntRover.controller("RvArPaidController",["$scope","$timeout","RVCompanyCardSrv","rvAccountsArTransactionsSrv","$vault","$stateParams","$state","sntActivity","ngDialog",function(t,a,e,n,o,r,i,c,s){BaseCtrl.call(this,t);var l={preventDefaultException:{tagName:/^(INPUT|LI)$/},preventDefault:!1};t.setScroller("paid-list",l);var d=function(){a(function(){t.refreshScroller("paid-list")},700)};t.$on("FETCH_COMPLETE_PAID_LIST",function(){d()});var u=function(a){c.start("EXPAND_PAID");var e=function(t){c.stop("EXPAND_PAID"),a.active=!0,a.debits=t.debits,a.payments=t.payments,d()},o=function(a){c.stop("EXPAND_PAID"),t.$emit("SHOW_ERROR_MSG",a)},r={id:a.transaction_id,account_id:t.arDataObj.accountId};t.invokeApi(n.expandPaidAndUnpaidList,r,e,o)};t.clickedPaidListItem=function(a){var e=t.arDataObj.paidList[a];e.active?(e.active=!1,d()):u(e)},t.goToReservationDetails=function(a){var e=t.arDataObj.paidList[a];if(t.arFlags.viewFromOutside){o.set("cardId",r.id),o.set("type",r.type),o.set("query",r.query);var n=e.associated_type,c=e.associated_id;"Reservation"===n?i.go("rover.reservation.staycard.reservationcard.reservationdetails",{id:c,confirmationId:e.reservation_confirm_no,isrefresh:!0,isFromCards:!0,isFromArTab:"paid-bills"}):"PostingAccount"===n&&i.go("rover.accounts.config",{id:c,activeTab:"ACCOUNT",isFromArTransactions:!0,isFromArTab:"paid-bills"})}},t.clickedUnallocateButton=function(a){var e=function(a){t.selectedUnAllocatedItem=a,s.open({template:"/assets/partials/companyCard/arTransactions/rvCompanyTravelAgentUnallocatePopup.html",scope:t})},o={},r={};o.allocation_id=a.id,r.account_id=t.arDataObj.accountId,r.data=o;var i={params:r,successCallBack:e};t.callAPI(n.unAllocateData,i);
},t.unAllocate=function(){var a={},e={},o=function(){t.$emit("REFRESH_PAID_BILLS"),s.close()};a.allocation_id=t.selectedUnAllocatedItem.allocation_id,a.credit_id=t.selectedUnAllocatedItem.from_bill.transaction_id,a.debit_id=t.selectedUnAllocatedItem.to_payment.transaction_id,a.amount=t.selectedUnAllocatedItem.amount,e.account_id=t.arDataObj.accountId,e.data=a;var r={params:e,successCallBack:o};t.callAPI(n.unAllocateSelectedPayment,r)},t.expandGroupedCharge=function(a){a.isExpanded?(a.isExpanded=!1,d()):t.callAPI(e.groupChargeDetailsFetch,{params:{reference_number:a.reference_number,date:a.date,bill_id:a.bill_id},successCallBack:function(t){a.light_speed_data=t.data,a.isExpanded=!0,d()},failureCallBack:function(a){t.errorMessage=a}})}}]),sntRover.controller("RVArPaymentForAllocationController",["$scope","$rootScope","$stateParams","$timeout","rvAccountsArTransactionsSrv","sntActivity","ngDialog",function(t,a,e,n,o,r,i){BaseCtrl.call(this,t);var c=function(){t.setScroller("payment-allocation"),"REFUND"===t.type?u():l()},s=function(){n(function(){t.refreshScroller("payment-allocation")},500)},l=function(){var a={id:t.arDataObj.accountId},e=function(a){t.payments=a.payments,s(),t.$emit("hideLoader")};t.invokeApi(o.fetchPaymentMethods,a,e)},d=function(a){t.payments=a.ar_transactions,s()},u=function(){var a={account_id:t.arDataObj.accountId,getParams:{per_page:1e3,page:1,transaction_type:"PAYMENTS",allocated:!1}},e={params:a,successCallBack:d};t.callAPI(o.fetchTransactionDetails,e)};t.closePopup=function(){i.close()},t.clickedRefundButton=function(a){t.$emit("CLICKED_REFUND_BUTTON",a),t.closePopup()},c()}]),sntRover.controller("RvArPostChargeController",["$rootScope","$scope","ngDialog","$timeout","RVPostChargeSrvV2",function(t,a,e,n,o){BaseCtrl.call(this,a),a.searchedItems=[],a.isItemsToShow=!1,a.queryValue="",a.selectedItem={},a.totalAmount=0,a.showCalculationArea=!1,a.quantity=1,a.show_reference_on_guest_invoice=!0,a.closeDialog=function(){e.close()};var r=function(e,n){var r=[],i=function(a){angular.forEach(a.results,function(a){a.label=a.name,a.curreny=t.currencySymbol,a.unit_price=parseFloat(a.unit_price).toFixed(2)}),r=a.results,n(r)},c=function(){var t={query:a.queryValue?a.queryValue.toLowerCase():"",page:1,per_page:50,charge_group_id:"",is_favorite:0},e={params:t,successCallBack:i};a.callAPI(o.searchChargeItems,e)};0===e.term.length?r=[]:e.term.length>2&&c()},i=function(t,e){a.selectedItem=e.item,a.totalAmount=e.item.unit_price,n(function(){a.showCalculationArea=!0},200)};a.autocompleteOptions={delay:0,minLength:0,position:{of:"#new-charge-input",my:"left top",at:"left bottom",collision:"flip",within:"#new-charge"},source:r,select:i},a.postCharge=function(){var t=function(){a.$emit("REFRESH_BALANCE_LIST"),a.closeDialog()},e={},n={};e.item_id=a.selectedItem.id,e.quantity=parseInt(a.quantity),e.reference=a.reference,e.is_item="ITEM"===a.selectedItem.type,e.amount=parseFloat(a.selectedItem.unit_price),e.show_ref_on_invoice=a.show_reference_on_guest_invoice,n.postChargeData=e,n.accountId=a.arDataObj.accountId,n.arTransactionId=a.selectedItemToPostCharge.transaction_id;var r={params:n,successCallBack:t};a.callAPI(o.postChargesFromArInvoice,r)},a.changedQuantity=function(){a.totalAmount=(a.selectedItem.unit_price*a.quantity).toFixed(2)},a.enteredAmount=function(){a.selectedItem.unit_price=parseFloat(a.selectedItem.unit_price).toFixed(2)}}]),sntRover.controller("RVArTransactionsDatePickerController",["$scope","$rootScope","ngDialog",function(t,a,e){"FROM"===t.clickedOn?t.date=t.filterData.fromDate?tzIndependentDate(t.filterData.fromDate):tzIndependentDate(a.businessDate):"TO"===t.clickedOn&&(t.date=t.filterData.toDate?tzIndependentDate(t.filterData.toDate):tzIndependentDate(a.businessDate)),t.setUpData=function(){t.dateOptions={changeYear:!0,changeMonth:!0,yearRange:"-5:+5",onSelect:function(){"FROM"===t.clickedOn?(t.filterData.fromDate=t.date,t.$emit("fromDateChanged")):"TO"===t.clickedOn&&(t.filterData.toDate=t.date,t.$emit("toDateChanged")),e.close()}}},t.setUpData()}]),sntRover.controller("RVArTransactionsPayCreditsController",["$scope","RVPaymentSrv","ngDialog","$rootScope","$timeout","$filter","rvAccountTransactionsSrv","rvPermissionSrv",function(t,a,e,n,o,r,i,c){BaseCtrl.call(this,t);var s=t.passData.isRefundClick?(-1*parseFloat(t.passData.payment.amount)).toFixed(2):parseFloat(t.arDataObj.unpaidAmount).toFixed(2),l=t.passData.isRefundClick?(-1*parseFloat(t.passData.payment.amount)).toFixed(2):parseFloat(t.arDataObj.unpaidPaymentAmount).toFixed(2);t.feeData={},t.selectedCC={},t.saveData={paymentType:""},t.billNumber=1,t.renderData={},t.renderData.defaultPaymentAmount=parseFloat(s).toFixed(2),t.renderData.defaultPaymentCurrencyAmount=parseFloat(l),t.saveData.paymentType=t.passData.isRefundClick?t.passData.payment.payment_type_value:"",t.actionType=t.passData.isRefundClick?"AR_REFUND_PAYMENT":"AR_SUBMIT_PAYMENT",t.passData.isRefundClick&&"CC"===t.passData.payment.payment_type_value&&(t.selectedCC=t.passData.payment.card_details);var d=t.arDataObj.company_or_ta_bill_id;t.cardsList=[];var u=!1,m={},f={};t.addmode=t.cardsList.length>0,t.disableMakePayment=function(){return t.saveData.paymentType.length},t.handleCloseDialog=function(){t.$emit("HANDLE_MODAL_OPENED"),t.closeDialog()},t.$on("CLOSE_DIALOG",t.handleCloseDialog),t.getPaymentListSuccess=function(a){t.$emit("hideLoader"),t.renderData.paymentTypes=_.filter(a,function(t){return"GIFT_CARD"!==t.name}),S()};var p=function(){t.referenceTextAvailable=!1,t.showInitalPaymentScreen=!0,t.depositPaidSuccesFully=!1;var e={successCallBack:t.getPaymentListSuccess};t.callAPI(a.renderPaymentScreen,e)};p();var v=function(a){if(t.depositPaidSuccesFully=!0,t.arDataObj.availableAmount=parseFloat(a.amountPaid).toFixed(2),t.depositPaidSuccesFully=!0,t.authorizedCode=a.authorization_code,t.allocatedPayment.payment_type=a.selectedPaymentTypeDescription,t.allocatedPayment.transaction_id=a.ar_transaction_id,"CC"===a.selectedPaymentType?(a.cc_details.last_digits=a.cc_details.ending_with,a.cc_details.expire_date=a.cc_details.expiry_date,t.allocatedPayment.card_details=a.cc_details):t.allocatedPayment=_.omit(t.allocatedPayment,"card_details"),t.arFlags.shouldShowPayAllButton=t.arDataObj.balanceList.length>0,a.allocatePaymentAfterPosting){t.arFlags.currentSelectedArTab="balance",t.arFlags.isFromAddPaymentOrAllocateButton=!0;var e=0;_.each(t.arDataObj.balanceList,function(t){e=parseFloat(e)+parseFloat(t.amount)}),t.arDataObj.totalAllocatedAmount=e}t.arFlags.isPaymentSelected=!0,t.arFlags.insufficientAmount=!1,t.arDataObj.selectedInvoices=[],a.allocatePaymentAfterPosting?t.$emit("REFRESH_PAYABLE_LIST"):t.$emit("REFRESH_SELECTED_LIST")},h=function(a){t.errorMessage=a},D=t.$on("PAYMENT_SUCCESS",function(t,a){v(a)}),y=t.$on("PAYMENT_FAILED",function(t,a){h(a)});t.$on("$destroy",D),t.$on("$destroy",y),t.clearPaymentErrorMessage=function(){t.paymentErrorMessage=""},t.hasPermissionToMakePayment=function(){return c.getPermissionValue("MAKE_PAYMENT")},t.$on("TOKEN_CREATED",function(a,e){t.newPaymentInfo=e,t.showCCPage=!1,t.swippedCard=!1,o(function(){C(e)},200)});var C=function(a){u=angular.copy(t.newPaymentInfo.tokenDetails.isSixPayment),m=angular.copy(t.newPaymentInfo.tokenDetails),f=angular.copy(t.newPaymentInfo.cardDetails);var e=u?a.tokenDetails.token_no:m.session,n=u?m.expiry.substring(2,4):f.expiryMonth,o=u?m.expiry.substring(0,2):f.expiryYear,r=n&&o?"20"+o+"-"+n+"-01":"",c=u?getSixCreditCardType(m.card_type).toLowerCase():f.cardType,s={bill_id:d,data_to_pass:{card_expiry:r,name_on_card:t.newPaymentInfo.cardDetails.userName,payment_type:"CC",token:e,card_code:c}};t.callAPI(i.savePaymentDetails,{successCallBack:g,params:s})},g=function(a){t.$emit("hideLoader");var e="",n="",o="",r=angular.copy(t.swipedCardDataToSave);isEmptyObject(r)?(e=retrieveCardtype(u,m,f),n=retrieveCardNumber(u,m,f),o=retrieveCardExpiryDate(u,m,f)):(e=r.cardType.toLowerCase(),n=r.cardNumber.slice(-4),o=r.cardExpiryMonth+"/"+r.cardExpiryYear,t.saveData.paymentType="CC"),t.defaultPaymentTypeCard=e,t.defaultPaymentTypeCardNumberEndingWith=n,t.defaultPaymentTypeCardExpiry=o,A(),_.each(t.renderData.paymentTypes,function(a){"CC"===a.name&&_.each(a.values,function(a){e.toUpperCase()===a.cardcode&&(t.feeData.feesInfo=a.charge_code.fees_information,t.setupFeeData())})}),t.saveData.payment_type_id=a.id,t.showCCPage=!1,t.swippedCard=!1,t.showCreditCardInfo=!0,t.newCardAdded=!0,t.swipedCardDataToSave={}};t.showSelectedCreditCardButton=function(){return t.showCreditCardInfo&&!t.showCCPage&&("sixpayments"!==t.paymentGateway||t.isManual)&&"CC"===t.saveData.paymentType&&!t.depositPaidSuccesFully};var A=function(){t.referenceTextAvailable=checkIfReferencetextAvailableForCC(t.renderData.paymentTypes,t.defaultPaymentTypeCard)};t.changeOnsiteCallIn=function(){t.showCCPage=!!t.isManual},t.$on("changeOnsiteCallIn",function(){t.isManual=!t.isManual,t.changeOnsiteCallIn()}),t.$on("SHOW_SWIPED_DATA_ON_PAY_SCREEN",function(a,e){t.showCCPage=!0,t.swippedCard=!0,t.addmode=!0,t.$broadcast("RENDER_SWIPED_DATA",e)}),t.$on("PAYMENT_TYPE_CHANGED",function(a,e){t.showCCPage="CC"===e}),t.$on("SWIPED_DATA_TO_SAVE",function(a,e){t.swipedCardDataToSave=e;var n=e;n.payment_credit_type=e.cardType,n.credit_card=e.cardType,n.card_expiry="20"+e.cardExpiryYear+"-"+e.cardExpiryMonth+"-01",t.callAPI(i.savePaymentDetails,{successCallBack:g,params:{bill_id:d,data_to_pass:n}})}),t.$on("MLI_ERROR",function(a,e){t.errorMessage=e});var S=function(){t.defaultRefundAmount=(-1*parseFloat(t.renderData.defaultPaymentAmount)).toFixed(2),t.renderData.defaultPaymentAmount<0?(t.defaultRefundAmount=(-1*parseFloat(t.renderData.defaultPaymentAmount)).toFixed(2),t.shouldShowMakePaymentButton=!1):t.shouldShowMakePaymentButton=!0}}]),sntRover.controller("RvArUnallocatedController",["$scope","$timeout","rvAccountsArTransactionsSrv","sntActivity","ngDialog",function(t,a,e,n,o){BaseCtrl.call(this,t);var r={preventDefaultException:{tagName:/^(INPUT|LI)$/},preventDefault:!1};t.setScroller("unallocated-list-scroller",r);var i=function(){a(function(){t.refreshScroller("unallocated-list-scroller")},700)};t.$on("REFRESH_UNALLOCATED_LIST_SCROLLER",function(){i()});var c=function(a){n.start("EXPAND_UNALLOCATED");var o=function(t){n.stop("EXPAND_UNALLOCATED"),a.transactions=t.allocated_transactions,a.active=!0,i()},r=function(a){n.stop("EXPAND_UNALLOCATED"),t.$emit("SHOW_ERROR_MSG",a)},c={id:a.transaction_id,account_id:t.arDataObj.accountId};t.invokeApi(e.expandAllocateAndUnallocatedList,c,o,r)};t.clickedUnallocatedListItem=function(a){var e=t.arDataObj.unallocatedList[a];e.is_partially_paid&&(e.active?(e.active=!1,i()):c(e))},t.clickedAllocateButton=function(a,e){a.cancelBubble=!0,a.stopPropagation&&a.stopPropagation(),t.$emit("CLICKED_ALLOCATE_BUTTON",t.arDataObj.unallocatedList[e])},t.clickedUnallocate=function(a){var n=function(a){t.selectedUnAllocatedItem=a,o.open({template:"/assets/partials/companyCard/arTransactions/rvCompanyTravelAgentUnallocatePopup.html",scope:t})},r={},i={};r.allocation_id=a.id,i.account_id=t.arDataObj.accountId,i.data=r;var c={params:i,successCallBack:n};t.callAPI(e.unAllocateData,c)},t.unAllocate=function(){var a={},n={},r=function(){t.$emit("REFRESH_UNALLOCATED"),o.close()};a.allocation_id=t.selectedUnAllocatedItem.allocation_id,a.credit_id=t.selectedUnAllocatedItem.from_bill.transaction_id,a.debit_id=t.selectedUnAllocatedItem.to_payment.transaction_id,a.amount=t.selectedUnAllocatedItem.amount,n.account_id=t.arDataObj.accountId,n.data=a;var i={params:n,successCallBack:r};t.callAPI(e.unAllocateSelectedPayment,i)}}]),sntRover.controller("RVCompanyCardArTransactionsMainCtrl",["$scope","$rootScope","$stateParams","ngDialog","$timeout","rvAccountsArTransactionsSrv","RVReservationCardSrv","$window","$filter","RVContactInfoSrv","rvPermissionSrv","sntActivity",function(t,a,e,n,o,r,i,c,s,l,d,u){BaseCtrl.call(this,t),t.errorMessage="";var m=800,f=this;t.showSortFilter=!0,t.showToggleFilter=!0,t.arFlags={currentSelectedArTab:"balance",isAddBalanceScreenVisible:!1,isArTabActive:!1,isPaymentSelected:!1,viewFromOutside:"undefined"!=typeof e.type,shouldShowPayAllButton:!1,shouldShowFooter:!1,insufficientAmount:!1,isFromAddPaymentOrAllocateButton:!1,shouldShowRefundButton:!1,hasAllocateUnallocatePermission:d.getPermissionValue("ALLOCATE_UNALLOCATE_PAYMENT"),isPayableTab:!0,shouldShowOnHoldFooter:!1,showSelectAllOpenBills:!0},t.filterData={query:"",fromDate:"",toDate:"",includePayments:!1,isSummary:!1,statementEmailAddress:"",sortField:"aging_date",sortOptions:[{value:"aging_date",name:"AGING DATE"},{value:"invoice_num",name:"INVOICE #"},{value:"ar_invoice",name:"AR INVOICE #"},{value:"name",name:"NAME"}]},t.arDataObj={balanceList:[],paidList:[],unallocatedList:[],allocatedList:[],onHoldList:[],unpaidAmount:"",paidAmount:"",allocatedCredit:"",unallocatedCredit:"",company_or_ta_bill_id:"",perPage:15,balancePageNo:1,paidPageNo:1,allocatePageNo:1,unallocatePageNo:1,onHoldPageNo:1,balanceTotalCount:0,paidTotalCount:0,allocatedTotalCount:0,unallocatedTotalCount:0,totalOfAllInvoicesInBalanceTab:0,OnHoldTotalCount:0,selectedOnHoldInvoices:[],selectedInvoices:[],totalAllocatedAmount:0,availableAmount:0,accountId:"undefined"==typeof t.contactInformation?e.id:t.contactInformation.id};var p={};f.createParametersFetchTheData=function(){t.arDataObj.accountId="undefined"==typeof t.contactInformation?e.id:t.contactInformation.id;var a={account_id:t.arDataObj.accountId,getParams:{per_page:t.arDataObj.perPage,from_date:t.filterData.fromDate,to_date:t.filterData.toDate,query:t.filterData.query}};switch(t.arFlags.currentSelectedArTab){case"balance":a.getParams.transaction_type="CHARGES",a.getParams.paid=!1,a.getParams.page=t.arDataObj.balancePageNo,a.getParams.sort_field=t.filterData.sortField,a.getParams.on_hold=!1;break;case"paid-bills":a.getParams.transaction_type="CHARGES",a.getParams.paid=!0,a.getParams.page=t.arDataObj.paidPageNo,a.getParams.sort_field=t.filterData.sortField;break;case"unallocated":a.getParams.transaction_type="PAYMENTS",a.getParams.allocated=!1,a.getParams.page=t.arDataObj.unallocatePageNo;break;case"allocated":a.getParams.transaction_type="PAYMENTS",a.getParams.allocated=!0,a.getParams.page=t.arDataObj.allocatePageNo;break;case"on-hold":a.getParams.transaction_type="CHARGES",a.getParams.paid=!1,a.getParams.page=t.arDataObj.onHoldPageNo,a.getParams.sort_field=t.filterData.sortField,a.getParams.on_hold=!0}return a};var v=function(t){_.each(t,function(t){t.active=!1})};t.allocatedPayment={};var h=function(a){switch(t.transactionsDetails=a,0===a.ar_transactions.length&&"balance"===t.arFlags.currentSelectedArTab&&1!==t.arDataObj.balancePageNo&&P("BALANCE",1),t.arDataObj.unpaidAmount=a.unpaid_amount,t.arDataObj.unpaidPaymentAmount=a.unpaid_payment_amount,t.arDataObj.unpaidPayableAmount=a.unpaid_payable_amount,t.arDataObj.paidAmount=a.paid_amount,t.arDataObj.allocatedCredit=a.allocated_credit,t.arDataObj.unallocatedCredit=a.unallocated_credit,t.arDataObj.company_or_ta_bill_id=a.company_or_ta_bill_id,t.arDataObj.arBalance=a.ar_balance,t.arDataObj.isPrintArInvoiceNumberEnabled=a.is_print_ar_invoice_number_enabled,t.arDataObj.arInvoiceLabel=a.ar_invoice_label,t.arDataObj.is_bill_lock_enabled=a.is_bill_lock_enabled,t.arDataObj.selectAllOpenBills=!1,"balance"===t.arFlags.currentSelectedArTab&&(t.arDataObj.total_count=a.total_count),t.arFlags.currentSelectedArTab){case"balance":_.each(a.ar_transactions,function(t){t.amount=parseFloat(t.amount).toFixed(2),t.isSelected=!1,t.balanceNow=t.amount,t.balanceAfter=0,t.initialAmount=t.amount}),t.arDataObj.balanceList=[],t.arDataObj.balanceList=a.ar_transactions,t.arDataObj.balanceTotalCount=a.total_count,v(t.arDataObj.balanceList),t.$broadcast("FETCH_COMPLETE_BALANCE_LIST"),o(function(){t.$broadcast("updatePagination","BALANCE")},1e3);break;case"paid-bills":t.arDataObj.paidList=[],t.arDataObj.paidList=a.ar_transactions,t.arDataObj.paidTotalCount=a.total_count,v(t.arDataObj.paidList),t.$broadcast("FETCH_COMPLETE_PAID_LIST"),o(function(){t.$broadcast("updatePagination","PAID")},1e3);break;case"unallocated":t.arDataObj.unallocatedList=[],t.arDataObj.unallocatedList=a.ar_transactions,t.arDataObj.unallocatedTotalCount=a.total_count,v(t.arDataObj.unallocatedList),t.$broadcast("REFRESH_UNALLOCATED_LIST_SCROLLER"),o(function(){t.$broadcast("updatePagination","UNALLOCATE")},1e3);break;case"allocated":t.arDataObj.allocatedList=[],t.arDataObj.allocatedList=a.ar_transactions,t.arDataObj.allocatedTotalCount=a.total_count,v(t.arDataObj.allocatedList),t.$broadcast("REFRESH_ALLOCATED_LIST_SCROLLER"),o(function(){t.$broadcast("updatePagination","ALLOCATE")},1e3);break;case"on-hold":_.each(a.ar_transactions,function(t){t.onHoldAmount=parseFloat(t.amount).toFixed(2),t.isonHoldSelected=!1,t.onHoldInitialAmount=t.onHoldAmount}),t.arDataObj.onHoldList=[],t.arDataObj.onHoldList=a.ar_transactions,t.arDataObj.onHoldTotalCount=a.total_count,v(t.arDataObj.onHoldList),t.$broadcast("FETCH_COMPLETE_ONHOLD_LIST"),o(function(){t.$broadcast("updatePagination","ONHOLD")},1e3)}var e=document.getElementById("arTransactionQuery");e.focus()};f.fetchTransactions=function(){t.errorMessage="",t.callAPI(r.fetchTransactionDetails,{successCallBack:h,params:f.createParametersFetchTheData()})},t.clickedSelectAllBills=function(){t.arDataObj.selectedInvoices=[],t.arDataObj.selectAllOpenBills&&_.each(t.arDataObj.balanceList,function(t){t.isSelected=!1})},f.filterChanged=function(){switch(t.arDataObj.selectAllOpenBills=!1,t.arFlags.showSelectAllOpenBills=""===t.filterData.query&&""===t.filterData.fromDate&&""===t.filterData.toDate,t.arFlags.currentSelectedArTab){case"balance":t.arDataObj.balancePageNo=1;break;case"paid-bills":t.arDataObj.paidPageNo=1;break;case"unallocated":t.arDataObj.unallocatePageNo=1;break;case"allocated":t.arDataObj.allocatePageNo=1;break;case"on-hold":t.arDataObj.onHoldPageNo=1}f.fetchTransactions();var a=document.getElementById("arTransactionQuery");a.blur()},t.queryEntered=_.debounce(f.filterChanged,m),t.switchArTransactionTab=function(a){t.arFlags.currentSelectedArTab=a,"balance"===a||"paid-bills"===a||"on-hold"===a?t.showSortFilter=!0:t.showSortFilter=!1,"balance"===a||"on-hold"===a?t.showToggleFilter=!0:(t.showToggleFilter=!1,t.arFlags.isPayableTab=!0),"balance"!==a&&(t.arFlags.isAddBalanceScreenVisible=!1),t.arDataObj.balancePageNo=t.arDataObj.paidPageNo=t.arDataObj.unallocatePageNo=t.arDataObj.allocatePageNo=t.arDataObj.onHoldPageNo=1,f.fetchTransactions()};var D=function(){t.filterData.query="",t.filterData.fromDate="",t.filterData.toDate="",t.filterData.sortField="aging_date",t.arFlags.showSelectAllOpenBills=!0};t.switchArTransactionOpenBillTab=function(){D(),t.arFlags.isPayableTab?t.switchArTransactionTab("balance"):(t.arDataObj.selectedOnHoldInvoices=[],t.switchArTransactionTab("on-hold"))},t.showAddBalanceScreen=function(){t.arFlags.isAddBalanceScreenVisible=!0,t.$broadcast("ADD_BALANCE_TAB")},t.changedSortBy=function(){f.filterChanged()},t.clickedFromDate=function(){t.popupCalendar("FROM")},t.clickedToDate=function(){t.popupCalendar("TO")},t.clearFromDate=function(){t.filterData.fromDate="",f.filterChanged()},t.clearToDate=function(){t.filterData.toDate="",f.filterChanged()},t.$on("fromDateChanged",function(){f.filterChanged()}),t.$on("toDateChanged",function(){f.filterChanged()}),t.popupCalendar=function(a){t.clickedOn=a,n.open({template:"/assets/partials/companyCard/contracts/rvCompanyCardContractsCalendar.html",controller:"RVArTransactionsDatePickerController",className:"",scope:t})},t.popupPaymentForAllocation=function(){t.type="ALLOCATE",n.open({template:"/assets/partials/companyCard/arTransactions/rvCompanyTravelAgentCardArPaymentPopup.html",controller:"RVArPaymentForAllocationController",scope:t})},t.updateAllocatedPayment=function(a){t.allocatedPayment=a,t.arDataObj.availableAmount=a.available_amount,t.arFlags.isPaymentSelected=!0,n.close()},t.addPayment=function(){t.passData=I(),n.open({template:"/assets/partials/companyCard/arTransactions/rvArTransactionsPayCredits.html",controller:"RVArTransactionsPayCreditsController",className:"",scope:t}),t.paymentModalOpened=!0};var y=function(){t.arFlags.insufficientAmount=!1,t.arDataObj.selectedInvoices=[],t.arFlags.isPaymentSelected=!1,t.arFlags.shouldShowPayAllButton=!1,t.arFlags.shouldShowFooter=!1,t.arDataObj.availableAmount=0,f.fetchTransactions()},C=function(a){t.arDataObj.selectedInvoices=[],"Insufficient Funds.Please 'Add payment' first"===a[0]?(t.errorMessage=[],t.arFlags.insufficientAmount=!0):t.errorMessage=a};t.paySelectedInvoices=function(){var a={},e={};e.credit_id=t.allocatedPayment.transaction_id,e.select_all=t.arDataObj.selectAllOpenBills,t.arDataObj.selectAllOpenBills||(e.selected_amount=t.arDataObj.totalAllocatedAmount,e.available_amount=t.arDataObj.availableAmount,e.invoices=t.arDataObj.selectedInvoices),a.account_id=t.arDataObj.accountId,a.data=e;var n={params:a,successCallBack:y,failureCallBack:C};t.callAPI(r.paySelected,n)},t.clickedPayAllButton=function(){var a={},e={},n=0;t.arDataObj.selectedInvoices=[],_.each(t.arDataObj.balanceList,function(a){var e={};e.invoice_id=a.transaction_id,e.amount=a.amount,t.arDataObj.selectedInvoices.push(e),n=parseInt(n)+parseInt(a.amount)}),t.arDataObj.totalAllocatedAmount=n,e.credit_id=t.allocatedPayment.transaction_id,e.invoices=t.arDataObj.selectedInvoices,e.selected_amount=t.arDataObj.totalAllocatedAmount,e.available_amount=t.arDataObj.availableAmount,a.account_id=t.arDataObj.accountId,a.data=e;var o={params:a,successCallBack:y,failureCallBack:C};t.callAPI(r.paySelected,o)},t.clickCancelFromFooter=function(){t.arFlags.isPaymentSelected=!1,t.arFlags.shouldShowFooter=!1,t.arFlags.insufficientAmount=!1,t.arFlags.shouldShowPayAllButton=!1,t.arDataObj.selectedInvoices=[],t.arFlags.isFromAddPaymentOrAllocateButton=!1,t.arDataObj.availableAmount=0,_.each(t.arDataObj.balanceList,function(t){t.isSelected=!1}),f.fetchTransactions()},t.shouldShowOnHoldFooter=function(){return 0!==t.arDataObj.selectedOnHoldInvoices.length},t.clickCancelFromOnHoldFooter=function(){t.arFlags.shouldShowOnHoldFooter=!1,t.arDataObj.selectedOnHoldInvoices=[],_.each(t.arDataObj.onHoldList,function(t){t.isonHoldSelected=!1}),f.fetchTransactions()};var g=function(){t.arDataObj.selectedInvoices=[],t.arFlags.shouldShowFooter=!1,f.fetchTransactions()},A=function(a){t.arDataObj.selectedInvoices=[],t.errorMessage=a};t.holdSelectedInvoices=function(){var a={},e={},n=[];_.each(t.arDataObj.selectedInvoices,function(t){n.push(t.invoice_id)}),a.selected_invoice_ids=n,e.account_id=t.arDataObj.accountId,e.data=a;var o={params:e,successCallBack:g,failureCallBack:A};t.callAPI(r.holdSelectedInvoices,o)};var S=function(){t.arDataObj.selectedOnHoldInvoices=[],t.arFlags.shouldShowOnHoldFooter=!1,f.fetchTransactions()},b=function(a){t.arDataObj.selectedOnHoldInvoices=[],t.errorMessage=a};t.releaseSelectedInvoices=function(){var a={},e={},n=[];_.each(t.arDataObj.selectedOnHoldInvoices,function(t){n.push(t.invoice_id)}),a.selected_invoice_ids=n,e.account_id=t.arDataObj.accountId,e.data=a;var o={params:e,successCallBack:S,failureCallBack:b};t.callAPI(r.releaseSelectedInvoices,o)},t.shouldShowFooter=function(){var a=!0;return 0!==t.arDataObj.selectedInvoices.length||t.arFlags.isFromAddPaymentOrAllocateButton||t.arDataObj.selectAllOpenBills||(a=!1),a};var I=function(){var a={account_id:t.arDataObj.accountId,is_swiped:!1,details:{firstName:"",lastName:""}};return a},T=function(a){var e=I(),n=new SwipeOperation,o=n.createSWipedDataToRender(a);e.details.swipedDataToRenderInScreen=o,t.$broadcast("SHOW_SWIPED_DATA_ON_PAY_SCREEN",o)};p.SWIPE_ACTION=t.$on("SWIPE_ACTION",function(a,e){if(t.paymentModalOpened){var n=new SwipeOperation,o=n.createDataToTokenize(e),r=function(a){t.$emit("hideLoader"),e.token=a,T(e)};t.invokeApi(i.tokenize,o,r)}});var O=function(){f.fetchTransactions()};p.SHOW_ERROR_MSG=t.$on("SHOW_ERROR_MSG",function(a,e){t.errorMessage=e}),p.REFRESH_PAYABLE_LIST=t.addListener("REFRESH_PAYABLE_LIST",function(){t.arFlags.currentSelectedArTab="balance",t.arDataObj.balancePageNo=1,t.arFlags.isPayableTab=!0,t.showToggleFilter=!0,f.fetchTransactions()}),p.REFRESH_BALANCE_LIST=t.addListener("REFRESH_BALANCE_LIST",function(){t.switchArTransactionOpenBillTab()}),p.REFRESH_UNALLOCATED=t.$on("REFRESH_UNALLOCATED",function(){t.arFlags.currentSelectedArTab="unallocated",f.fetchTransactions()}),p.REFRESH_PAID_BILLS=t.$on("REFRESH_PAID_BILLS",function(){t.arFlags.currentSelectedArTab="paid-bills",f.fetchTransactions()}),p.REFRESH_ALLOCATED=t.$on("REFRESH_ALLOCATED",function(){t.arFlags.currentSelectedArTab="allocated",f.fetchTransactions()}),p.REFRESH_SELECTED_LIST=t.$on("REFRESH_SELECTED_LIST",function(){f.fetchTransactions()}),p.CLICKED_ALLOCATE_BUTTON=t.$on("CLICKED_ALLOCATE_BUTTON",function(a,e){t.arFlags.shouldShowPayAllButton=!0,t.arFlags.currentSelectedArTab="balance",t.showToggleFilter=!0,t.arFlags.isPayableTab=!0,t.allocatedPayment=e,t.arFlags.isPaymentSelected=!0,t.arDataObj.availableAmount=e.available_amount?parseFloat(e.available_amount).toFixed(2):"0.00",t.arFlags.isFromAddPaymentOrAllocateButton=!0;var n=0;_.each(t.arDataObj.balanceList,function(t){n=parseFloat(n)+parseFloat(t.amount)}),t.arDataObj.totalOfAllInvoicesInBalanceTab=n.toFixed(2),t.arDataObj.totalAllocatedAmount=n}),p.arTransactionTabActive=t.$on("arTransactionTabActive",function(){O(),t.arFlags.isArTabActive=!0});var P=function(a,e){switch(a){case"BALANCE":t.arDataObj.balancePageNo=e;break;case"PAID":t.arDataObj.paidPageNo=e;break;case"ALLOCATE":t.arDataObj.allocatePageNo=e;break;case"UNALLOCATE":t.arDataObj.unallocatePageNo=e;break;case"ONHOLD":t.arDataObj.onHoldPageNo=e}t.callAPI(r.fetchTransactionDetails,{successCallBack:h,params:f.createParametersFetchTheData()})};t.balancePagination={id:"BALANCE",api:[P,"BALANCE"],perPage:t.arDataObj.perPage},t.paidPagination={id:"PAID",api:[P,"PAID"],perPage:t.arDataObj.perPage},t.allocatePagination={id:"ALLOCATE",api:[P,"ALLOCATE"],perPage:t.arDataObj.perPage},t.unallocatePagination={id:"UNALLOCATE",api:[P,"UNALLOCATE"],perPage:t.arDataObj.perPage},t.onHoldPagination={id:"ONHOLD",api:[P,"ONHOLD"],perPage:t.arDataObj.perPage};var E=function(a){t.$emit("hideLoader"),a.languages&&(a.languages=_.filter(a.languages,{is_show_on_guest_card:!0})),t.languageData=a,t.filterData.locale=a.selected_language_code,n.open({template:"/assets/partials/companyCard/arTransactions/rvArStatementPopup.html",className:"",closeByDocument:!1,scope:t})},N=function(){t.invokeApi(l.fetchGuestLanguages,{},E)};t.clickedArStatementButton=function(){t.filterData.statementEmailAddress=t.contactInformation.address_details.email_address;var a=function(a){t.statementEmailAddress=a.to_address?a.to_address:"",N()},e=function(a){t.errorMessage=a},n={id:t.arDataObj.accountId},o={params:n,successCallBack:a,failureCallBack:e};t.callAPI(r.fetchArStatementData,o)},t.showIncludePayments=function(){return"balance"===t.arFlags.currentSelectedArTab||"paid-bills"===t.arFlags.currentSelectedArTab};var R=function(){var e={id:t.arDataObj.accountId,from_date:t.filterData.fromDate,to_date:t.filterData.toDate,query:t.filterData.query};return"balance"===t.arFlags.currentSelectedArTab?(e.paid=!1,e.transaction_type="CHARGES",e.include_payments=t.filterData.includePayments,e.sort_field=t.filterData.sortField):"paid-bills"===t.arFlags.currentSelectedArTab?(e.paid=!0,e.transaction_type="CHARGES",e.include_payments=t.filterData.includePayments,e.sort_field=t.filterData.sortField):"unallocated"===t.arFlags.currentSelectedArTab?(e.transaction_type="PAYMENTS",e.allocated=!1):"allocated"===t.arFlags.currentSelectedArTab&&(e.transaction_type="PAYMENTS",e.allocated=!0),a.isSingleDigitSearch&&!isNaN(t.filterData.textInQueryBox)&&t.filterData.textInQueryBox.length<3&&(e.room_search=!0),e.locale=t.filterData.locale,e.is_summary=t.filterData.isSummary,e},L=function(){$("head").append("<style id='print-orientation'>@page { size: portrait; }</style>")},F=function(){$("#print-orientation").remove()},w=function(){$("header .logo").removeClass("logo-hide"),t.$emit("PRINT_AR_STATEMENT",!1),F()};t.shouldPrintArInvoiceNumber=function(t,a){var e=!1;return t.is_print_ar_invoice_number_enabled&&a.ar_invoice_number&&(e=!0),e},t.shouldPrintFolioNumber=function(t,a){var e=!1;return a.ar_invoice_number?!t.is_print_ar_invoice_number_enabled&&t.is_print_folio_enabled&&a.folio_number?e=!0:t.is_print_folio_enabled||!a.folio_number&&a.folio_number||(e=!1):t.is_print_folio_enabled&&a.folio_number?e=!0:t.is_print_folio_enabled||!a.folio_number&&a.folio_number||(e=!1),e},t.shouldPrintInvoiceNumber=function(t,a){var e=!1;return t.is_print_invoice_enabled&&a.invoice_number&&((t.is_print_ar_invoice_number_enabled||t.is_print_folio_enabled)&&(t.is_print_ar_invoice_number_enabled||!t.is_print_folio_enabled||a.folio_number)?t.is_print_ar_invoice_number_enabled&&!a.ar_invoice_number&&t.is_print_folio_enabled&&!a.folio_number?e=!0:a.ar_invoice_number||a.folio_number||(e=!0):e=!0),e};var B=function(a){var e=function(a){t.printData=a,t.printData.is_summary=t.filterData.isSummary,t.errorMessage="",$("header .logo").addClass("logo-hide"),t.$emit("PRINT_AR_STATEMENT",!0),L(),o(function(){sntapp.cordovaLoaded?cordova.exec(w,function(){w()},"RVCardPlugin","printWebView",[]):(window.print(),w())},100)},n=function(a){t.errorMessage=a},i={params:a,successCallBack:e,failureCallBack:n};t.callAPI(r.fetchArStatementPrintData,i)};t.pritArStatement=function(){var t=R();B(t)},t.showEmailSentStatusPopup=function(){n.open({template:"/assets/partials/popups/rvEmailSentStatusPopup.html",className:"",scope:t})},t.showFormatBillPopup=function(a,e){t.is_from_ar=!0,t.is_bill_lock_enabled=t.arDataObj.is_bill_lock_enabled,t.billFormat={},t.billFormat.isInformationalInvoice=!1,t.arTransactionsData=t.arDataObj,"paid"===e?t.item=t.arDataObj.paidList[a]:"payable"===e?t.item=t.arDataObj.balanceList[a]:t.item=t.arDataObj.onHoldList[a],t.item.paid?t.item.is_locked||!t.is_bill_lock_enabled?(t.isInvoiceStepOneActive=!1,t.isInvoiceStepThreeActive=!0,t.shouldGenerateFinalInvoice=!1,t.disableInformationCheckBox=!0):(t.isInvoiceStepOneActive=!0,t.isInvoiceStepThreeActive=!1,t.shouldGenerateFinalInvoice=!0,t.disableInformationCheckBox=!0):(t.isInvoiceStepOneActive=!1,t.isInvoiceStepThreeActive=!0,t.shouldGenerateFinalInvoice=!1,t.disableInformationCheckBox=!1),t.isInvoiceStepTwoActive=!1,t.isInvoiceStepFourActive=!1,t.isInvoiceStepFiveActive=!1,n.open({template:"/assets/partials/popups/billFormat/rvBillFormatPopup.html",controller:"rvArBillFormatPopupCtrl",className:"",scope:t})};var j=function(){n.open({template:"/assets/partials/popups/billFormat/rvInvoicePendingInfoPopup.html",className:"",scope:t})};t.emailArStatement=function(){var a=R();a.to_address=t.filterData.statementEmailAddress,t.closeDialog();var e=function(){t.errorMessage="",t.statusMsg=s("translate")("EMAIL_SENT_SUCCESSFULLY"),t.status="success",t.showEmailSentStatusPopup()},n=function(a){t.errorMessage=a,t.statusMsg=s("translate")("EMAIL_SEND_FAILED"),t.status="alert",t.showEmailSentStatusPopup()},o={params:a,successCallBack:e,failureCallBack:n};t.callAPI(r.emailArStatement,o)},t.clickedEmail=function(a){t.closeDialog(),t.arDataObj.paidList.length>0&&a.is_locked&&(t.item.is_locked=a.is_locked);var e=function(a){a.is_invoice_issued?(t.statusMsg=s("translate")("EMAIL_SENT_SUCCESSFULLY"),t.status="success",t.showEmailSentStatusPopup(),t.switchArTransactionTab(t.arFlags.currentSelectedArTab)):(t.switchArTransactionTab(t.arFlags.currentSelectedArTab),o(function(){j()},500))},n=function(a){t.statusMsg=s("translate")("EMAIL_SEND_FAILED"),t.status="alert",t.showEmailSentStatusPopup()},i={params:a,successCallBack:e,failureCallBack:n};t.callAPI(r.sendEmail,i)},t.clickedPrint=function(a){u.start("PRINT_STARTED"),t.arDataObj.paidList.length>0&&a.is_locked&&(t.item.is_locked=a.is_locked),t.closeDialog(),M(a)};var k=function(){$(".nav-bar").removeClass("no-print"),$(".cards-header").removeClass("no-print"),$(".card-tabs-nav").removeClass("no-print"),$("header .nav-bar").removeClass("no-print"),
$(".billing-sidebar").removeClass("no-print"),$(".reservation-transaction").removeClass("no-print"),$(".tab-header").removeClass("no-print"),$("#add-balance").removeClass("no-print"),t.shouldGenerateFinalInvoice&&!t.billFormat.isInformationalInvoice&&t.$broadcast("UPDATE_WINDOW"),t.closeDialog(),t.printBillCardActive=!1,$("body #loading").html('<div id="loading-spinner" ></div>'),t.switchArTransactionTab(t.arFlags.currentSelectedArTab),u.stop("PRINT_STARTED")},M=function(a){var e=function(t){var a="";return t.is_copy_counter&&0===t.no_of_original_invoices?a=parseInt(t.print_counter)-1:t.is_copy_counter&&t.no_of_original_invoices>0&&(a=parseInt(t.print_counter)-parseInt(t.no_of_original_invoices)),a},n=function(a){u.stop("PRINT_STARTED"),a=a.data;var n="",r="",i=moment(a.print_ar_invoice_number_activated_at,"YYYY-MM-DD"),c=moment(a.ar_transaction_date,"YYYY-MM-DD"),s=c.diff(i,"days");t.shouldShowArInvoiceNumber=!0,s<0&&(t.shouldShowArInvoiceNumber=!1),t.isPrintRegistrationCard=!1,t.printBillCardActive=!0,t.billFormat.isInformationalInvoice?a.invoiceLabel=a.translation.information_invoice:parseInt(a.print_counter)<=parseInt(a.no_of_original_invoices)?a.invoiceLabel=a.ar_invoice_label||a.translation.ar_invoice:1===parseInt(a.print_counter)&&0===parseInt(a.no_of_original_invoices)?a.invoiceLabel=a.ar_invoice_label||a.translation.ar_invoice:parseInt(a.print_counter)>parseInt(a.no_of_original_invoices)&&!t.roverObj.noReprintReEmailInvoice?(a.is_copy_counter&&(n=e(a)),r=a.ar_invoice_copy_label||a.translation.copy_of_ar_invoice,a.invoiceLabel=r.replace("#count",n)):t.billFormat.isInformationalInvoice||(a.invoiceLabel=a.ar_invoice_label||a.translation.ar_invoice),a.is_invoice_issued?(t.printData=a,t.errorMessage="",$("header .logo").addClass("logo-hide"),$("header .h2").addClass("text-hide"),$("body #loading").html(""),$("header .nav-bar").addClass("no-print"),$(".cards-header").addClass("no-print"),$("#cards-header-id").addClass("no-print"),$(".billing-sidebar").addClass("no-print"),$(".reservation-transaction").addClass("no-print"),$(".card-tabs-nav").addClass("no-print"),$(".tab-header").addClass("no-print"),$("#add-balance").addClass("no-print"),o(function(){sntapp.cordovaLoaded?cordova.exec(k,function(t){k()},"RVCardPlugin","printWebView",[]):(window.print(),k())},700)):(t.switchArTransactionTab(t.arFlags.currentSelectedArTab),j())},i=function(a){t.errorMessage=a,u.stop("PRINT_STARTED")},c={params:a,successCallBack:n,failureCallBack:i};t.callAPI(r.fetchBillPrintData,c)};t.hasPermissionToCreateArAccount=function(){return d.getPermissionValue("CREATE_AR_ACCOUNT")},t.clearResults=function(){t.filterData.query="",f.filterChanged()},t.getAllocatedPayments=function(){t.type="REFUND",n.open({template:"/assets/partials/companyCard/arTransactions/rvCompanyTravelAgentCardArPaymentPopup.html",controller:"RVArPaymentForAllocationController",scope:t})},p.CLICKED_REFUND_BUTTON=t.$on("CLICKED_REFUND_BUTTON",function(a,e){"CC"===e.payment_type_value&&(e.card_details.ending_with=e.card_details.last_digits,e.card_details.expiry_date=e.card_details.expire_date);var r={account_id:t.arDataObj.accountId,isRefundClick:!0,is_swiped:!1,details:{firstName:"",lastName:""},payment:e};t.passData=r,o(function(){n.open({template:"/assets/partials/companyCard/arTransactions/rvArTransactionsPayCredits.html",controller:"RVArTransactionsPayCreditsController",className:"",scope:t}),t.paymentModalOpened=!0},500)}),p.BACK_FROM_STAY_CARD=t.$on("BACK_FROM_STAY_CARD",function(){"undefined"==typeof t.arDataObj.accountId&&o(function(){"on-hold"===e.isBackFromStaycardToARTab&&(t.arFlags.isPayableTab=!1),t.switchArTransactionTab(e.isBackFromStaycardToARTab),O()},2e3)}),t.clickedMoveZeroInvoicesAsPaid=function(){var a={account_id:t.arDataObj.accountId},e=function(){t.errorMessage="",f.fetchTransactions()},n=function(a){t.errorMessage=a},o={params:a,successCallBack:e,failureCallBack:n};t.callAPI(r.moveZeroInvoiceAsPaid,o)},angular.forEach(p,function(a){t.$on("$destroy",a)})}]),sntRover.controller("RvArAddBalanceController",["$scope","$rootScope","ngDialog","rvAccountsArTransactionsSrv","$stateParams","$timeout","$log",function(t,a,e,n,o,r,i){BaseCtrl.call(this,t);var c=function(){r(function(){t.refreshScroller("arAddBalanceScroller")},500)};t.setScroller("arAddBalanceScroller");var s=function(){t.manualBalanceObj={manualBalanceList:[{name:"Manual Balance",invoiceNo:"",departureDate:"",amount:""}],selectedIndex:0},c()};t.removeBalanceRow=function(a){t.manualBalanceObj.manualBalanceList.splice(a,1),c()},t.addBalanceRow=function(){var a={name:"Manual Balance",invoiceNo:"",departureDate:"",amount:""};t.manualBalanceObj.manualBalanceList.push(a),c()},t.clickedCancelAddBalance=function(){s(),t.arFlags.isAddBalanceScreenVisible=!1};var l=function(a){var e=t.manualBalanceObj.manualBalanceList[a],n=!1;return""===e.name&&""===e.invoiceNo&&""===e.departureDate&&""===e.amount&&(n=!0),n},d=function(){var a=[];_.each(t.manualBalanceObj.manualBalanceList,function(t,e){if(!l(e)){var n={manual_charge_name:t.name,invoice_number:t.invoiceNo,aging_date:t.departureDate,amount:t.amount};a.push(n)}});var e={manual_balance_data:a,account_id:t.arDataObj.accountId};return e};t.clickedSaveAddBalance=function(){var a=function(){t.$emit("hideLoader"),t.$emit("REFRESH_PAYABLE_LIST"),t.arFlags.isAddBalanceScreenVisible=!1},e=function(a){t.$emit("hideLoader"),t.$emit("SHOW_ERROR_MSG",a)},o=d();o.manual_balance_data.length>0?t.invokeApi(n.saveArBalance,o,a,e):i.info("Data Validation :: No data to save !!")},t.popupArDateCalendar=function(a){t.manualBalanceObj.selectedIndex=a,e.open({template:"/assets/partials/companyCard/contracts/rvCompanyCardContractsCalendar.html",controller:"RVArAddBalanceDatePickerController",className:"",scope:t})},t.clearDateSelection=function(a){t.manualBalanceObj.manualBalanceList[a].departureDate=""},t.balanceObjIsEmpty=function(t){return l(t)},t.calculateTotalBalance=function(){var a=0,e=t.manualBalanceObj.manualBalanceList;return e.length>0&&_.each(e,function(t){""!==t.amount&&(a+=parseFloat(t.amount))}),a},t.$on("ADD_BALANCE_TAB",function(){s()}),s()}]),sntRover.controller("RVArAddBalanceDatePickerController",["$scope","$rootScope","ngDialog",function(t,a,e){t.date=tzIndependentDate(a.businessDate),t.setUpData=function(){t.dateOptions={changeYear:!0,changeMonth:!0,yearRange:"0:+5",onSelect:function(){var a=t.manualBalanceObj;a.manualBalanceList[a.selectedIndex].departureDate=t.date,e.close()}}},t.setUpData()}]),sntRover.controller("rvArMoveInvoiceCtrl",["$scope","ngDialog","rvAccountsArTransactionsSrv","$timeout",function(t,a,e,n){BaseCtrl.call(this,t);var o=function(){setTimeout(function(){t.refreshScroller("arMoveInvoiceListScroll")},500)},r=function(){if(t.moveInvoiceData={isConfirmInvoiceMoveScreen:!1,searchResult:{},fromAccount:{},toAccount:{},query:"",perPage:50,page:1},t.contactInformation&&t.contactInformation.account_details){var a=t.contactInformation.account_details,e=t.contactInformation.address_details;t.moveInvoiceData.fromAccount={accountId:t.arDataObj.accountId,accountName:a.account_name,accountNumber:a.account_number,arNumber:a.accounts_receivable_number,type:a.account_type,location:"undefined"==typeof e?"":e.location,ageingDate:a.ageing_date}}t.accountListPagination={id:"ACCOUNT_LIST",api:i,perPage:t.moveInvoiceData.perPage},t.setScroller("arMoveInvoiceListScroll",{}),o()},i=function(a){t.moveInvoiceData.page=a?a:1;var r={params:{query:t.moveInvoiceData.query,page:t.moveInvoiceData.page,per_page:t.moveInvoiceData.perPage},successCallBack:function(a){t.moveInvoiceData.searchResult=a,t.errorMessage="",o(),n(function(){t.$broadcast("updatePagination","ACCOUNT_LIST")},1e3)},failureCallBack:function(a){t.errorMessage=a}};t.callAPI(e.fetchAccountsReceivables,r)};t.changedSearchQuery=function(){var a=t.moveInvoiceData.query.length;a>2?i():0===a&&(t.moveInvoiceData.searchResult={},o())},t.clearSearchQuery=function(){t.moveInvoiceData.query="",t.moveInvoiceData.searchResult={},o()},t.clickedOnCard=function(a){t.moveInvoiceData.isConfirmInvoiceMoveScreen=!0,t.moveInvoiceData.toAccount={accountId:a.id,accountName:a.account_name,accountNumber:a.account_number,arNumber:a.ar_number,type:a.type,location:a.location,ageingDate:a.ageing_date}},t.showPagination=function(){var a=!1,e=t.moveInvoiceData.searchResult,n=t.moveInvoiceData.isConfirmInvoiceMoveScreen;return"undefined"!=typeof e&&"undefined"!=typeof e.accounts&&e.accounts.length<e.total_result&&e.accounts.length>0&&!n&&(a=!0),a},t.changeButtonClick=function(){t.moveInvoiceData.isConfirmInvoiceMoveScreen=!1,t.moveInvoiceData.toAccount={}},t.closeDialog=function(){a.close()},t.moveInvoiceButtonClick=function(){var n={params:{account_id:t.moveInvoiceData.fromAccount.accountId,to_account_id:t.moveInvoiceData.toAccount.accountId,transaction_id:t.moveInvoiceHeaderData.transactionId},successCallBack:function(){t.$emit("REFRESH_BALANCE_LIST"),t.errorMessage="",a.close()},failureCallBack:function(a){t.errorMessage=a}};t.callAPI(e.moveInvoice,n)},r()}]),sntRover.controller("RVPaymentAddPaymentCtrl",["$rootScope","$scope",function(t,a){BaseCtrl.call(this,a),a.savePayment={},a.isFromGuestCard=!("undefined"==typeof a.passData.isFromGuestCard||!a.passData.isFromGuestCard),a.initCardSwipeRenderData=function(){a.isNewCardAdded=!1,a.shouldShowIframe=!1,a.addmode=!0,a.isGiftCard=!1,a.useDepositGiftCard=!1,a.hideCancelCard=!1,a.depositWithGiftCard=!1,setTimeout(function(){a.$broadcast("addNewCardClicked"),a.$broadcast("hidePayCardToggles",{isFromSwipe:!0})},100)},a.$on("CLOSE_DIALOG",function(){a.closeDialog()}),a.getAddActionType=function(){return a.isFromGuestCard?"ADD_PAYMENT_GUEST_CARD":a.paymentData.isFromBillCard||"billcard"===a.passData.fromView?"ADD_PAYMENT_BILL":"companyTravelAgent"===a.passData.fromView?"ADD_PAYMENT_CO_TA":"ADD_PAYMENT_STAY_CARD"};var e=function(e,n,o){var r=a.billNumber-1;"CC"===n?(_.extend(a.paymentData.bills[r].credit_card_details,{card_code:o.card_code,card_number:o.ending_with,card_expiry:o.expiry_date,payment_id:e.id,is_swiped:o.is_swiped,auth_color_code:o.auth_color_code,token:o.token}),a.paymentData.bills[r].credit_card_details.payment_type=n,1===a.billNumber&&t.$emit("UPDATEDPAYMENTLIST",a.paymentData.bills[r].credit_card_details),t.$broadcast("BALANCECHANGED",{balance:e.reservation_balance,confirm_no:a.paymentData.confirm_no}),t.$broadcast("paymentChangedToCC"),a.$emit("UPDATECCATTACHEDBILLSTATUS",e.has_any_credit_card_attached_bill),e.addToGuestCard&&t.$broadcast("ADDEDNEWPAYMENTTOGUEST",{card_code:o.card_code,mli_token:o.ending_with,card_expiry:o.expiry_date,card_name:o.card_name,id:e.guest_payment_method_id,isSelected:!0,is_primary:!1,payment_type:n||"CC",payment_type_id:1})):(a.paymentData.bills[r].credit_card_details.payment_type=n,a.paymentData.bills[r].credit_card_details.payment_type_description=e.payment_type),a.closeDialog(a.ngDialogId)},n=function(e,n,o){t.$broadcast("ADDEDNEWPAYMENTTOGUEST",{card_code:o.card_code,mli_token:o.ending_with,card_expiry:o.expiry_date,card_name:o.card_name,id:e.id,isSelected:!0,is_primary:!1,payment_type:n||"CC",payment_type_id:1}),a.closeDialog()},o=function(e,n,o){"CC"===n?(a.paymentData.reservation_card.payment_method_used=n,_.extend(a.paymentData.reservation_card.payment_details,{card_type_image:"images/"+o.card_code+".png",card_number:o.ending_with,card_expiry:o.expiry_date,is_swiped:o.is_swiped,auth_color_code:o.auth_color_code})):(a.paymentData.reservation_card.payment_method_description=e.payment_type,a.paymentData.reservation_card.payment_method_used=n),a.paymentData.reservation_card.restrict_post=e.restrict_post,t.$broadcast("UPDATERESERVATIONTYPE",e.reservation_type_id,e.id),a.$emit("UPDATECCATTACHEDBILLSTATUS",e.has_any_credit_card_attached_bill||e.usedEMV&&"CC"===n),e.addToGuestCard&&t.$broadcast("ADDEDNEWPAYMENTTOGUEST",{card_code:o.card_code,mli_token:o.ending_with,card_expiry:o.expiry_date,card_name:o.card_name,id:e.guest_payment_method_id,isSelected:!0,is_primary:!1,payment_type:n||"CC",payment_type_id:1}),a.closeDialog()},r=function(e,n,o){t.$broadcast("ADDEDNEWPAYMENTTOCOTA",{card_code:o.card_code,mli_token:o.ending_with,card_expiry:o.expiry_date,card_name:o.card_name,id:e.id,isSelected:!0,is_primary:!1,payment_type:n||"CC",payment_type_id:1}),a.closeDialog()};a.$on("SUCCESS_LINK_PAYMENT",function(t,i){switch(a.getAddActionType()){case"ADD_PAYMENT_BILL":e(i.response,i.selectedPaymentType,i.cardDetails);break;case"ADD_PAYMENT_GUEST_CARD":n(i.response,i.selectedPaymentType,i.cardDetails);break;case"ADD_PAYMENT_CO_TA":r(i.response,i.selectedPaymentType,i.cardDetails);break;default:o(i.response,i.selectedPaymentType,i.cardDetails)}}),a.$on("ERROR_OCCURED",function(t,e){a.errorMessage=e}),a.$on("PAYMENT_FAILED",function(t,e){a.errorMessage=e}),function(){isEmptyObject(a.passData.details.swipedDataToRenderInScreen)||(a.selectedPaymentType="CC",a.swipedCardData=a.passData.details.swipedDataToRenderInScreen),a.billNumber=a.passData.fromBill||1}()}]),sntRover.controller("RVCardOptionsCtrl",["$rootScope","$scope","$state","ngDialog","$location","$document","RVPaymentSrv","RVReservationCardSrv",function(t,a,e,n,o,r,i,c){BaseCtrl.call(this,a),a.showAddtoGuestCard=!1,a.renderDataFromSwipe=function(e){a.cardData.cardNumber=e.cardNumber,a.cardData.userName=e.nameOnCard,a.cardData.expiryMonth=e.cardExpiryMonth,a.cardData.expiryYear=e.cardExpiryYear,a.cardData.cardType=e.cardType,"guestCard"===e.swipeFrom&&t.$broadcast("swipeAtGuestCard"),"guestCard"===e.swipeFrom?a.showAddtoGuestCard=!1:a.showAddtoGuestCard=!0,"guestCard"!==e.swipeFrom&&"stayCard"!==e.swipeFrom||setTimeout(function(){a.clickedAddNewCard()},100)},a.refreshIframe=function(){if($("#sixIframe").length){var t=document.getElementById("sixIframe");t.src=t.src}},a.$on("REFRESH_IFRAME",function(t){a.refreshIframe()}),t.$on("depositModalAllowGiftCard",function(){a.allowPmtWithGiftCard=!0}),a.checkForGiftCard=function(){a.isGiftCard=!1,t.isStandAlone||a.invokeApi(i.fetchAvailPayments,{},a.cardsListSuccess)},a.hideCardToggles=function(){return!!(a.isFromGuestCard||a.hasAccompanyguest||a.cardsList&&0===a.cardsList.length)},a.$on("isFromGuestCardFalse",function(){a.showAddtoGuestCard=!0,a.isFromGuestCard=!0}),a.$on("hidePayCardToggles",function(t,e){a.isFromGuestCard=!0,e&&e.isFromSwipe&&"guestCard"!==e.swipeFrom&&(a.isFromGuestCard=!1)}),a.$on("giftCardSelectedFromGroups",function(){a.clickedGiftCardToggle()}),a.$on("CLICK_ADD_NEW_CARD",function(){a.clickedAddNewCard()}),a.$on("SHOW_SWIPED_DATA_ON_PAY_SCREEN",function(){a.clickedAddNewCard(),a.$$phase?"":a.$apply()}),a.$on("SHOW_SWIPED_DATA_ON_BILLING_SCREEN",function(){a.clickedAddNewCard(),a.$$phase?"":a.$apply()}),a.$on("SHOW_SWIPED_DATA_ON_DEPOSIT_BALANCE_SCREEN",function(){a.clickedAddNewCard(),a.$$phase?"":a.$apply()}),a.clickedAddNewCard=function(){a.shouldShowIframe=!1,a.addmode=!0,a.isGiftCard=!1,a.useDepositGiftCard=!1,a.hideCancelCard=!1,a.depositWithGiftCard=!1},a.clickedExistingCard=function(){a.shouldShowIframe=!0,a.addmode=!1,a.isGiftCard=!1,a.useDepositGiftCard=!1,a.hideCancelCard=!1,a.depositWithGiftCard=!1},a.clickedGiftCardToggle=function(){a.shouldShowIframe=!0,a.useDepositGiftCard=!0,a.addmode=!1,a.isGiftCard=!0,a.depositWithGiftCard=!0},a.showExistingCards=function(){return!a.addmode&&!a.useDepositGiftCard},a.showGiftCardToggle=function(){return!(a.isStandAlone||!a.allowPmtWithGiftCard)},a.existingSelected=function(){return!a.addmode&&!a.isGiftCard},a.addNewSelected=function(){return!(!a.addmode||a.isGiftCard)},a.hideMLINewCard=function(){return!!("sixpayments"===a.paymentGateway&&a.addmode||a.isManual||a.isGiftCard||a.depositWithGiftCard||a.shouldShowIframe)},a.showAddToGuestCardBox=function(){return a.existingSelected()||a.isGiftCard?a.showAddtoGuestCard=!1:a.addNewSelected()&&(a.showAddtoGuestCard=!0),!!a.showAddtoGuestCard},a.showMLIAddNewCC=function(){return!!a.addNewSelected()||!(!a.isGiftCard||a.showingDepositModal||a.depositWithGiftCard||a.useDepositGiftCard)},t.$on("giftCardSelected",function(){a.shouldShowIframe=!1,t.isStandAlone&&$("#cc-new-card").addClass("ng-hide")}),t.$on("creditCardSelected",function(){t.isStandAlone||(a.shouldShowIframe=!0,$("#cc-new-card").removeClass("ng-hide")),t.isStandAlone&&($("#cc-new-card").removeClass("ng-hide"),a.clickedAddNewCard())}),a.hideIfFromStayCardDirect=function(){t.isStandAlone||(a.swippedCard?a.shouldShowIframe=!1:a.shouldShowIframe=!0)},t.$on("validatedGiftCardPmt",function(t,e){e?a.validPayment=!0:a.validPayment=!1}),a.showMakePaymentButtonStatus=function(){var t="";return t=a.depositBalanceMakePaymentData&&"undefined"!=typeof a.depositBalanceMakePaymentData.payment_type?a.depositBalanceMakePaymentData.payment_type.length>0&&a.validPayment?"green":"grey":a.validPayment?"grey":"grey overlay"},a.useDepositGiftCard=!1,a.cardsListSuccess=function(e){a.allowPmtWithGiftCard=!1,t.allowPmtWithGiftCard=!1,a.$emit("hideLoader");for(var n in e)"GIFT_CARD"===e[n].name&&(a.allowPmtWithGiftCard=!0,a.$parent.allowPmtWithGiftCard=!0,a.$parent.$parent.allowPmtWithGiftCard=!0,a.$parent.$parent.$parent.allowPmtWithGiftCard=!0,t.allowPmtWithGiftCard=!0,t.$broadcast("depositModalAllowGiftCard",!0));t.initFromCashDeposit?a.initFromCashDeposit=!0:a.initFromCashDeposit=!1},a.isGiftCard=!1,a.allowPmtWithGiftCard=!1,t.$on("depositUsingGiftCardChange",function(e,n){t.depositUsingGiftCard?(a.isGiftCard=!0,a.hideCancelCard=!0):(a.isGiftCard=!1,a.hideCancelCard=!1)}),a.refreshIframeWithGuestData=function(t){var a=(new Date).getTime(),e=t.fname,n=t.lname;iFrameUrl=domainUrl+"/api/ipage/index.html?card_holder_first_name="+e+"&card_holder_last_name="+n+"&service_action=createtoken&time="+a;var o=document.getElementById("sixIframe");try{o.src=iFrameUrl}catch(t){console.warn(t.name,t.message)}},a.$on("refreshIframe",function(t,e){a.refreshIframeWithGuestData(e)});var s=o.$$absUrl;domainUrl=s.split("/staff#/")[0],a.cardData={},a.cardData.addToGuestCard=!1,a.cardData.cardNumber="",a.cardData.CCV="",a.cardData.expiryMonth="",a.cardData.expiryYear="",a.cardData.userName="";var l=(new Date).getTime();if(a.shouldShowAddNewCard=!0,"undefined"!=typeof a.passData)var d="undefined"==typeof a.passData.details.firstName?"":a.passData.details.firstName,u="undefined"==typeof a.passData.details.lastName?"":a.passData.details.lastName;if(a.iFrameUrl=domainUrl+"/api/ipage/index.html?card_holder_first_name="+d+"&card_holder_last_name="+u+"&service_action=createtoken&time="+l,"sixpayments"===t.paymentGateway){a.shouldShowAddNewCard=!1;var m=r.find("sixIframe");m.attr("src",a.iFrameUrl),a.showAddtoGuestCard=!1}else a.isFromGuestCard||(a.showAddtoGuestCard=!0);"undefined"==typeof a.passData||isEmptyObject(a.passData.details.swipedDataToRenderInScreen)||a.renderDataFromSwipe(a.passData.details.swipedDataToRenderInScreen),a.shouldShowIframe=!1,a.changeOnsiteCallIn=function(){a.shouldShowIframe=!a.shouldShowIframe,a.isFromGuestCard||(a.shouldShowIframe?(a.showAddtoGuestCard=!0,a.refreshIframe()):a.showAddtoGuestCard=!1)};var f=function(){a.cardData.cardNumber="",a.cardData.CCV="",a.cardData.expiryMonth="",a.cardData.expiryYear=""};a.$on("clearCardDetails",function(){f()});var p=function(t){var e={};e.cardDetails=angular.copy(a.cardData),e.tokenDetails=t,a.$emit("TOKEN_CREATED",e),a.$digest(),a.refreshIframe()},_=function(t){a.$emit("MLI_ERROR",t)},v=function(){var t={};return t.cardNumber=a.cardData.cardNumber,t.cardSecurityCode=a.cardData.CCV,t.cardExpiryMonth=a.cardData.expiryMonth,t.cardExpiryYear=a.cardData.expiryYear,t};a.getToken=function(t){if(t.preventDefault(),isEmptyObject(a.passData.details.swipedDataToRenderInScreen)){var e=v(),n=function(t){t.isSixPayment=!1,p(t)},o=function(t){_(t)};a.fetchMLI(e,n,o)}else{var r=new SwipeOperation,i=r.createSWipedDataToSave(a.passData.details.swipedDataToRenderInScreen);i.addToGuestCard=a.cardData.addToGuestCard,i.card_name&&""!==i.card_name||(i.card_name=a.cardData.userName),a.$emit("SWIPED_DATA_TO_SAVE",i)}},a.$on("six_token_recived",function(t,e){e.six_payment_data.isSixPayment=!0,a.shouldShowAddNewCard=!1,p(e.six_payment_data)}),a.setCreditCardFromList=function(t){a.$emit("cardSelected",{index:t}),a.cardselectedIndex=t},a.setToShowCancelCard=function(){a.hideCancelCard=!1,a.depositWithGiftCard=!1},a.setToHideCancelCard=function(){a.hideCancelCard=!0},a.showCancelCardSelection=function(){return!a.hideCancelCard&&!a.depositWithGiftCard},a.isSixPayPayment=function(){return!!("sixpayments"===a.paymentGateway&&a.addmode||a.isManual)},a.cancelCardSelection=function(){t.isStandAlone?(a.$emit("cancelCardSelection"),a.cardselectedIndex=-1,a.refreshIframe()):n.close()},a.$on("cancelCardSelection",function(){a.depositWithGiftCard=!1,a.isGiftCard=!1,a.hideCancelCard=!1}),a.$on("showCancelCreditCardButton",function(){a.setToShowCancelCard()}),a.giftCardAmountAvailable=!1,a.giftCardAvailableBalance=0,a.$on("giftCardAvailableBalance",function(t,e){a.giftCardAvailableBalance=e.amount}),a.timer=null,a.cardNumberInput=function(e,n,o){if(o?(a.isGiftCard=!0,a.useDepositGiftCard=!0,t.useDepositGiftCard=!0):t.useDepositGiftCard=!1,a.isGiftCard||o){var r=e.length;a.num=e,r>=8&&r<=22?$("[name=card-number]").keydown(function(){clearTimeout(a.timer),a.timer=setTimeout(a.fetchGiftCardBalance,1500)}):a.giftCardAmountAvailable=!1}},a.num,a.fetchGiftCardBalance=function(){if(a.isGiftCard){var t=function(t){a.giftCardAvailableBalance=t.amount,a.giftCardAmountAvailable=!0,a.$emit("giftCardAvailableBalance",t),a.$emit("hideLoader")};a.invokeApi(c.checkGiftCardBalance,{card_number:a.num},t)}else a.giftCardAmountAvailable=!1},a.$on("addNewCardClicked",function(){a.clickedAddNewCard()}),a.$on("existingCardClicked",function(){a.clickedExistingCard()}),a.$on("RENDER_SWIPED_DATA",function(t,e){a.swippedCard=!0,a.renderDataFromSwipe(e),a.passData.details.swipedDataToRenderInScreen=e,setTimeout(function(){a.clickedAddNewCard()},100)})}]),angular.module("sntRover").service("RVCompanyCardSrv",["$q","rvBaseWebSrvV2",function(t,a){var e=this,n={},o=6e4;e.companyTaArDetailsCached=[],e.companyTaNotes=[],e.cachedTime="",this.DEFAULT_PER_PAGE=10,this.DEFAULT_PAGE=1;var r={},i=this;this.fetchContactInformation=function(e){var n=e.id,o=t.defer(),r="/api/accounts/"+n,i=["is_eod_failed","is_eod_in_progress","is_eod_manual_started","is_eod_process_running"];return a.getJSON(r).then(function(t){o.resolve(_.omit(t,i))},function(t){o.reject(t)}),o.promise},this.fetchCompanyPaymentData=function(e){var n=t.defer(),o="/staff/payments/payment.json?account_id="+e;return a.getJSON(o).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},this.setAsPrimary=function(e){var n=t.defer(),o="api/accounts/"+e.account_id+"/set_wallet_payment_method_primary";return a.postJSON(o,e).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},this.deletePayment=function(e){var n=t.defer(),o="api/accounts/"+e.account_id+"/delete_wallet_payment_methods";return a.postJSON(o,e).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},this.fetchContactInformationMandatoryFields=function(){var e=t.defer(),n="/admin/co_ta_settings/current_settings.json";return a.getJSON(n).then(function(t){e.resolve(t)},function(t){e.reject(t)}),e.promise},this.fetchAccountPaymentData=function(e){var n=t.defer(),o="/staff/payments/payment.json?account_id="+e;return a.getJSON(o).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},this.fetchContactInformationAndMandatoryFields=function(a){var e=t.defer(),n={};return t.when().then(function(){return i.fetchContactInformation(a).then(function(t){n=t})}).then(function(){return i.fetchContactInformationMandatoryFields().then(function(t){n.mandatoryFields=t})}).then(function(){e.resolve(n)},function(t){e.reject(t)}),e.promise},this.fetchCommissionDetail=function(){var e=t.defer(),n=" /api/hotel_settings/default_agent_commission_details";return a.getJSON(n).then(function(t){e.resolve(t)},function(t){e.reject(t)}),e.promise},this.fetchCommissionDetailsAndMandatoryFields=function(){var a=t.defer(),e={};return t.when().then(function(){return i.fetchCommissionDetail().then(function(t){e=t})}).then(function(){return i.fetchContactInformationMandatoryFields().then(function(t){e.mandatoryFields=t})}).then(function(){a.resolve(e)},function(t){a.reject(t)}),a.promise},this.fetchMultiProperties=function(e){var n=t.defer(),o="/api/accounts/"+e.accountId+"/subscribed_properties";return a.getJSON(o).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise};var c=[];this.fetchCountryList=function(){var e=t.defer(),n="/ui/country_list";return c.length?e.resolve(c):a.getJSON(n).then(function(t){c=t,e.resolve(t)},function(t){e.reject(t)}),e.promise},this.saveContactInformation=function(e){var n,o,i=t.defer(),c="api/accounts/save.json",s=parseInt(e.id,10),l=_.omit(e,["workstation_id"]),d={data:l,deferred:i};return r[s]=r[s]||[],n=r[s],(o=n.find(function(t){return angular.equals(t.data,l)&&!t.resolved}))?o.deferred.promise:(n.push(d),a.postJSON(c,e).then(function(t){d.resolved=!0,i.resolve(t)},function(t){d.resolved=!0,i.reject(t)}),i.promise)},this.fetchRates=function(e){var n=t.defer(),o="/api/rates/contract_rates";return a.getJSON(o,e).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},this.replaceCard=function(e){var n={old:{type:e.cardType},new:{type:e.cardType,id:e.id,use_card_rate:e.useCardRate},change_all_reservations:e.future},o=t.defer(),r="/api/reservations/"+e.reservation+"/cards/replace";return a.putJSON(r,n).then(function(t){o.resolve(t)},function(t){o.reject(t)}),o.promise},this.removeCard=function(e){var n={type:e.cardType,id:e.cardId},o=t.defer(),r="/api/reservations/"+e.reservation+"/cards/remove";return a.deleteJSON(r,n).then(function(t){o.resolve(t)},function(t){o.reject(t)}),o.promise},this.fetchArAccountDetails=function(n){var r=n.id,i=t.defer(),c="/api/accounts/"+r+"/ar_details";if(!e.companyTaArDetailsCached[r]||e.companyTaArDetailsCached[r].expiry&&Date.now()>e.companyTaArDetailsCached[r].expiry)e.companyTaArDetailsCached[r]=i,a.getJSON(c).then(function(t){e.companyTaArDetailsCached[r]={response:t,expiry:Date.now()+o},i.resolve(t)},function(t){i.reject(t)});else{if(!e.companyTaArDetailsCached[r].response)return e.companyTaArDetailsCached[r].promise;i.resolve(e.companyTaArDetailsCached[r].response)}return i.promise},this.fetchArAccountNotes=function(n){var r=n.id,i=t.defer(),c="/api/accounts/"+r+"/ar_notes";if(!e.companyTaNotes[r]||e.companyTaNotes[r].expiry&&Date.now()>e.companyTaNotes[r].expiry)e.companyTaNotes[r]=i,a.getJSON(c).then(function(t){e.companyTaNotes[r]={response:t,expiry:Date.now()+o},i.resolve(t)},function(t){i.reject(t)});else{if(!e.companyTaNotes[r].response)return e.companyTaNotes[r].promise;i.resolve(e.companyTaNotes[r].response)}return i.promise},this.saveARNote=function(n){var o=t.defer(),r="/api/accounts/save_ar_note",i=n.id;return a.postJSON(r,n).then(function(t){e.companyTaNotes[i]=null,o.resolve(t)},function(t){o.reject(t)}),o.promise},this.saveARDetails=function(n){var o=t.defer(),r="api/accounts/save_ar_details",i=n.id;return a.postJSON(r,n).then(function(t){e.companyTaArDetailsCached[i]=null,o.resolve(t)},function(t){o.reject(t)}),o.promise},this.deleteARNote=function(n){var o=t.defer(),r="/api/accounts/delete_ar_note",i=n.id;return a.postJSON(r,n).then(function(t){e.companyTaNotes[i]=null,o.resolve(t)},function(t){o.reject(t)}),o.promise},this.deleteArAccount=function(n){var o=n.id,r=t.defer(),i="api/accounts/"+o+"/delete_ar_detail";return a.deleteJSON(i).then(function(t){e.companyTaArDetailsCached[o]=null,r.resolve(t)},function(t){r.reject(t)}),r.promise},this.fetchArAccountsList=function(e){var n=t.defer(),o="/api/accounts/"+e.id+"/ar_transactions?paid="+e.paid+"&from_date="+e.from_date+"&to_date="+e.to_date+"&query="+e.query+"&page="+e.page_no+"&per_page="+e.per_page+"&transaction_type="+e.transaction_type;return a.getJSON(o).then(function(t){t.ar_transactions&&t.ar_transactions.length>0&&angular.forEach(t.ar_transactions,function(t){"DEBIT"===t.transaction_type&&(t.active=!1)}),n.resolve(t)},function(t){n.reject(t)}),n.promise},this.addCreditAmount=function(e){var n=t.defer(),o="api/accounts/"+e.id+"/ar_transactions";return a.postJSON(o,e).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},this.payForReservation=function(e){var n=t.defer(),o="api/accounts/"+e.id+"/ar_transactions/"+e.transaction_id+"/pay";return a.postJSON(o).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},this.openForReservation=function(e){var n=t.defer(),o="api/accounts/"+e.id+"/ar_transactions/"+e.transaction_id+"/open";return a.postJSON(o).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},this.payAll=function(e){var n=t.defer(),o="api/accounts/"+e.id+"/ar_transactions/pay_all";return a.postJSON(o).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},e.fetchHotelLoyaltiesHlps=function(){var e=t.defer(),o="/staff/user_memberships/get_available_hlps.json";return n.fetchHotelLoyaltiesHlps?e.resolve(n.fetchHotelLoyaltiesHlps):a.getJSON(o).then(function(t){n.fetchHotelLoyaltiesHlps=t,e.resolve(t)},function(t){e.reject(t)}),e.promise},e.fetchHotelLoyaltiesFfp=function(){var e=t.defer(),o="/staff/user_memberships/get_available_ffps.json";return n.fetchHotelLoyaltiesFfp?e.resolve(n.fetchHotelLoyaltiesFfp):a.getJSON(o).then(function(t){n.fetchHotelLoyaltiesFfp=t,e.resolve(t)},function(t){e.reject(t)}),e.promise},this.fetchTACommissionDetails=function(e){var n=t.defer(),o=" api/accounts/"+e.accountId+"/commission_details";return a.getJSON(o,e.params).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},this.saveTACommissionDetails=function(e){var n=t.defer(),o={};o.reservations=e.commissionDetails;var r="api/accounts/"+e.accountId+"/save_commission_details";return a.postJSON(r,o).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},this.fetchTransactionDetails=function(e){var n=t.defer(),o=" /api/bills/"+e.bill_id+"/transactions";return a.getJSON(o,e).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},this.fetchArStatementPrintData=function(e){var n=t.defer(),o="/api/ar_transactions/print";return a.postJSON(o,e).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},this.emailArStatement=function(e){var n=t.defer(),o="/api/ar_transactions/email";return a.postJSON(o,e).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},this.fetchArStatementData=function(e){var n=t.defer(),o="/api/ar_transactions/get_email?id="+e.id;return a.getJSON(o).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},this.groupChargeDetailsFetch=function(e){var n=t.defer(),o="/staff/reservation/transaction_details";return a.getJSON(o,e).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},this.recalculateCommission=function(e){var n=t.defer(),o="/api/reservations/recalculate_commission_details";return a.postJSON(o,e).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},this.fetchCompanyTravelAgentStatisticsSummary=function(e){var n=t.defer(),o="/api/accounts/"+e.accountId+"/statistics?view=SUMMARY";return delete e.accountId,a.getJSON(o,e).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},this.fetchCompanyTravelAgentStatisticsDetails=function(e){var n=t.defer(),o="/api/accounts/"+e.accountId+"/statistics?view=DETAILED";return delete e.accountId,a.getJSON(o,e).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},this.fetchCompanyTravelAgentMonthlyReservations=function(e){var n=t.defer(),o="/api/accounts/"+e.accountId+"/statistics?view=RESERVATIONS";return delete e.accountId,a.getJSON(o,e).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},this.verifyTravelAgentCompanyCardMerge=function(e){var n=t.defer(),o="/api/accounts/validate_card_merge";return a.postJSON(o,e).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},this.mergeCards=function(e){var n=t.defer(),o="/api/accounts/merge_cards";return a.postJSON(o,e).then(function(t){
n.resolve(t)},function(t){n.reject(t)}),n.promise}}]),angular.module("sntRover").service("RVCompanyCardActivityLogSrv",["$q","rvBaseWebSrvV2",function(t,a){this.fetchActivityLog=function(e){var n=t.defer(),o="/api/account_actions";return a.getJSON(o,e).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},this.fetchFilterData=function(e){var n=t.defer(),o="/api/account_actions/"+e.id+"/account_action_types";return a.getJSON(o).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise}}]),angular.module("sntRover").service("rvCompanyCardContractsSrv",["$q","sntBaseWebSrv",function(t,a){this.fetchRateContract=function(t){return a.getJSON("/api/rates/contract_rates",t)},this.deleteContract=function(t){var e="/api/accounts/"+t.account_id+"/contracts/"+t.contract_id;return a.deleteJSON(e)},this.fetchContractsDetails=function(t){var e="/api/accounts/"+t.account_id+"/contracts/"+t.contract_id;return a.getJSON(e)};var e=[];this.fetchContractsList=function(n){var o=t.defer(),r="/api/accounts/"+n.account_id+"/contracts";return a.getJSON(r).then(function(t){e=t,o.resolve(t)},function(t){o.reject(t)}),o.promise},this.getContractedRates=function(){return e},this.addNewContract=function(t){var e="/api/accounts/"+t.account_id+"/contracts";return a.postJSON(e,t.postData)},this.updateContract=function(t){var e="/api/accounts/"+t.account_id+"/contracts/"+t.contract_id;return a.putJSON(e,t.postData)},this.updateNight=function(t){var e="/api/accounts/"+t.account_id+"/contracts/"+t.contract_id+"/contract_nights";return a.postJSON(e,t.postData)},this.fetchContractsForLinking=function(t){return a.getJSON("/api/contracts/search_contracts",t)},this.linkContract=function(t){return a.postJSON("/api/contracts/link_contract",t)},this.unLinkContract=function(t){return a.postJSON("/api/contracts/unlink_contract",t)},this.linkRate=function(t){return a.postJSON("/api/contracts/link_rate",t)},this.unlinkRate=function(t){return a.postJSON("/api/contracts/unlink_rate",t)},this.fetchOwners=function(t){return t.id=t.contract_id,a.getJSON("/api/contracts/contract_owners",t)};var n=this;this.fetchDetailsWithOwnersList=function(a){var e=[],o={},r=t.defer();return e.push(n.fetchOwners(a).then(function(t){o.ownersList=t.data})),e.push(n.fetchContractsDetails(a).then(function(t){o.contractDetails=t})),t.all(e).then(function(){r.resolve(o)}),r.promise}}]),angular.module("sntRover").service("rvCompanyCardNotesSrv",["$q","rvBaseWebSrvV2",function(t,a){this.fetchNotes=function(e){var n="/api/accounts/"+e.accountID+"/account_notes",o=t.defer();return a.getJSON(n).then(function(t){o.resolve(t.notes)},function(t){o.reject(t)}),o.promise},this.updateNote=function(e){var n="/api/accounts/"+e.accountID+"/update_account_note",o=t.defer(),r={description:e.text,note_id:e.noteID};return a.putJSON(n,r).then(function(t){o.resolve(t)},function(t){o.reject(t)}),o.promise},this.deleteNote=function(e){var n="/api/accounts/"+e.accountID+"/delete_account_note/",o=t.defer(),r={note_id:e.noteID};return a.deleteJSON(n,r).then(function(t){o.resolve(t)},function(t){o.reject(t)}),o.promise},this.createNote=function(e){var n={description:e.text},o="/api/accounts/"+e.accountID+"/save_account_note",r=t.defer();return a.postJSON(o,n).then(function(t){r.resolve(t)},function(t){r.reject(t)}),r.promise}}]),angular.module("sntRover").service("RVPaymentSrv",["$http","$q","RVBaseWebSrv","rvBaseWebSrvV2","$rootScope","sntBaseWebSrv",function(t,a,e,n,o,r){var i={PAYMENT_TYPES:{}};this.renderPaymentScreen=function(t){var n=a.defer(),o="/staff/payments/addNewPayment.json",r=angular.toJson(t||"default");return i.PAYMENT_TYPES[r]?n.resolve(i.PAYMENT_TYPES[r]):e.getJSON(o,t).then(function(t){i.PAYMENT_TYPES[r]=t,n.resolve(t)},function(t){n.reject(t)}),n.promise},this.fetchAvailPayments=function(t){var n=a.defer(),o="/staff/payments/addNewPayment.json";return e.getJSON(o,t).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},this.savePaymentDetails=function(t){var n=a.defer(),o="staff/reservation/save_payment";return e.postJSON(o,t).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},this.saveGuestPaymentDetails=function(t){var n=a.defer(),o="staff/payments/save_new_payment";return e.postJSON(o,t).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},this.setAsPrimary=function(t){var n=a.defer(),o="/staff/payments/setCreditAsPrimary";return e.postJSON(o,t).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},this.deletePayment=function(t){var n=a.defer(),o="/staff/payments/deleteCreditCard";return e.postJSON(o,t).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},this.getPaymentList=function(t){var n=a.defer(),o="/staff/staycards/get_credit_cards.json?reservation_id="+t;return e.getJSON(o).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},this.getReceiptsList=function(t){var e=a.defer(),o="/api/bills/payment_receipts";return n.getJSON(o,t).then(function(t){e.resolve(t)},function(t){e.reject(t)}),e.promise},this.getExistingPaymentsForBill=function(t){var n=a.defer(),o="/staff/staycards/get_credit_cards.json";return e.getJSON(o,t).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},this.mapPaymentToReservation=function(t){var n=a.defer(),o="/staff/reservation/link_payment";return e.postJSON(o,t).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},this.submitPaymentOnBill=function(t){var e=0,r=function(){e++},i=setInterval(r,1e3),c=a.defer(),s="api/reservations/"+t.reservation_id+"/submit_payment",l=function t(a){if(e>=o.emvTimeout){var r=["Request timed out. Unable to process the transaction"];c.reject(r)}else n.getJSONWithSpecialStatusHandling(a).then(function(e){e.status&&"processing_not_completed"===e.status||"null"===e?setTimeout(function(){console.info("POLLING::-> for emv terminal response"),t(a)},5e3):(clearInterval(i),c.resolve(e))},function(e){"undefined"==typeof e?t(a):(clearInterval(i),c.reject(e))})};return n.postJSONWithSpecialStatusHandling(s,t.postData).then(function(a){t.postData.is_emv_request&&a.status&&"processing_not_completed"===a.status?l(a.location_header):(clearInterval(i),c.resolve(a))},function(t){clearInterval(i),c.reject(t)}),c.promise},this.makePaymentOnDepositBalance=function(t){var n=a.defer(),o="staff/reservation/post_payment";return e.postJSON(o,t).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},this.chipAndPinGetToken=function(t){var e=0,r=function(){e++},i=setInterval(r,1e3),c=a.defer(),s="/api/cc/get_token.json",l=function t(a){if(e>=o.emvTimeout){var r=["Request timed out. Unable to process the transaction"];c.reject(r)}else n.getJSONWithSpecialStatusHandling(a).then(function(e){e.status&&"processing_not_completed"===e.status||"null"===e?setTimeout(function(){console.info("POLLING::-> for emv terminal response"),t(a)},5e3):(clearInterval(i),c.resolve(e))},function(e){"undefined"==typeof e?t(a):(clearInterval(i),c.reject(e))})};return n.postJSONWithSpecialStatusHandling(s,t).then(function(t){t.status&&"processing_not_completed"===t.status?l(t.location_header):(clearInterval(i),c.resolve(t))},function(t){clearInterval(i),c.reject(t)}),c.promise},this.deleteCreditCard=function(t){var e=a.defer(),n="api/reservations/"+t.reservation_id+"/delete_credit_card";return delete t.reservation_id,r.postJSON(n,t).then(function(t){e.resolve(t)},function(t){e.reject(t)}),e.promise}}]);var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t};angular.module("sntRover").service("RVReservationCardSrv",["$http","$q","RVBaseWebSrv","rvBaseWebSrvV2","RVGAHelperSrv","$rootScope",function(t,a,e,n,o,r){this.reservationData={};var i=this;this.fetch=function(t){var n=a.defer(),o=t.reservationId,r=t.isRefresh,c=!1;if(angular.forEach(i.reservationIdsArray,function(t,a){r&&null!==r&&""!==r||t===o&&(c=!0)}),c)n.resolve(i.reservationData[o]);else{i.storeReservationIds(o);var s="api/reservations/"+o+".json";e.getJSON(s).then(function(t){i.reservationData[o]=t,n.resolve(t)},function(t){n.reject(t)})}return n.promise},this.reservationDetails={},this.confirmationNumbersArray=[],this.reservationIdsArray=[];var i=this;this.emptyConfirmationNumbers=function(){i.confirmationNumbersArray=[],i.reservationDetails={}},this.storeConfirmationNumbers=function(t){i.confirmationNumbersArray.push(t)},this.storeReservationIds=function(t){i.reservationIdsArray.push(t)},this.fetchReservationDetails=function(t){var n=t.confirmationNumber,r=t.isRefresh,c=!1,s=!0;angular.forEach(i.confirmationNumbersArray,function(t,a){r&&null!==r||t===n&&(c=!0)});var l=a.defer();if(c)l.resolve(i.reservationDetails[n]);else{i.storeConfirmationNumbers(n);var d="/staff/staycards/reservation_details.json?reservation="+n+"&is_dep_date_allowed="+s;e.getJSON(d).then(function(t){i.reservationDetails[n]=t,o.sendEventToGA("LOAD_RESERVATION",n),l.resolve(t)},function(t){l.reject(t)})}return l.promise},this.updateResrvationForConfirmationNumber=function(t,a){i.reservationDetails[t]=a},this.getResrvationForConfirmationNumber=function(t){return i.reservationDetails[t]},this.guestData="",this.setGuestData=function(t){this.guestData=t},this.getGuestData=function(){return this.guestData},this.fetchGuestcardData=function(t){var n=a.defer(),o="/staff/guestcard/show.json";return e.getJSON(o,t).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},this.fetchCancellationPolicies=function(t){var e=a.defer(),o="/api/reservations/"+t.id+"/cancellation_policies";return n.getJSON(o,t).then(function(t){e.resolve(t)},function(t){e.reject(t)}),e.promise},this.cancelReservation=function(t){var e=a.defer(),o="/api/reservations/"+t.id+"/cancel";return n.postJSON(o,t).then(function(t){e.resolve(t)},function(t){e.reject(t)}),e.promise},this.tokenize=function(t){var n=a.defer(),o="/staff/payments/tokenize";return e.postJSON(o,t).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},this.getLastRateAdjustmentReason=function(t){var e=a.defer(),o="api/reservations/"+t.reservation_id+"/reason_for_last_adjusted_rate";return n.getJSON(o).then(function(t){e.resolve(t)},function(t){e.reject(t)}),e.promise},this.saveReservationNote=function(t){var n=a.defer(),o="/reservation_notes";return e.postJSON(o,t).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},this.deleteReservationNote=function(t){var n=a.defer(),o="/reservation_notes/"+t;return e.deleteJSON(o,"").then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},this.updateReservationNote=function(t){var e=a.defer(),o="/reservation_notes/"+t.id;return n.putJSON(o,t).then(function(t){e.resolve(t)},function(t){e.reject(t)}),e.promise},this.getGuestDetails=function(t){var e=a.defer(),o="/api/guest_details/"+t.id;return null===t.id?e.reject([""]):n.getJSON(o).then(function(t){e.resolve(t)},function(t){e.reject(t)}),e.promise},this.modifyRoomQueueStatus=function(t){var e=a.defer(),o={status:t.status};t.viaAdvancedQueue&&(o.signature=t.signature,o.is_promotions_and_email_set=t.is_promotions_and_email_set);var r="/api/reservations/"+t.reservationId+"/queue";return n.postJSON(r,o).then(function(a){e.resolve(t)},function(t){e.reject(t)}),e.promise},this.fetchDepositDetails=function(t){var e=a.defer(),o="api/reservations/"+t+"/deposit_policy";return n.getJSON(o).then(function(t){e.resolve(t)},function(t){e.reject(t)}),e.promise},this.sendConfirmationEmail=function(t){var e=a.defer(),o="/api/reservations/"+t.reservationId+"/email_confirmation";return n.postJSON(o,t.postData).then(function(t){e.resolve(t)},function(t){e.reject(t)}),e.promise},this.validateStayDateChange=function(t){var e=a.defer(),o="/staff/change_stay_dates/validate_stay_dates_change";return n.postJSON(o,t).then(function(t){e.resolve(t)},function(t){e.reject(t)}),e.promise},this.detachGroupReservation=function(t){var e=a.defer(),o="/api/group_reservations/"+t.id+"/detach_group_reservation";return n.postJSON(o,t).then(function(t){e.resolve(t)},function(t){e.reject(t)}),e.promise},this.reinstateReservation=function(t){var e=a.defer(),o="/api/reservations/"+t.reservationId+"/reinstate";return n.postJSON(o,t).then(function(t){e.resolve(t)},function(t){e.reject(t)}),e.promise},this.checkReinstationAvailbility=function(t){var e=a.defer(),o="/api/reservations/"+t+"/check_reinstate_availability";return n.getJSON(o).then(function(t){e.resolve(t)},function(t){e.reject(t)}),e.promise},this.checkGiftCardBalance=function(t){var e={card_number:t.card_number},o=a.defer(),r="/api/gift_cards/balance_inquiry";return n.postJSON(r,e).then(function(t){t&&_typeof(t.amount)===_typeof(123)&&(t.amount=parseFloat(t.amount).toFixed(2)),o.resolve(t)},function(t){o.reject(t)}),o.promise},this.fetchGuestIdentity=function(t){var e=a.defer(),o="/api/guest_identity/"+t.reservation_id;return n.getJSON(o,t).then(function(t){e.resolve(t)},function(t){e.reject(t)}),e.promise},this.reverseCheckIn=function(t){var e=a.defer(),o="/api/reservations/"+t.reservationId+"/reverse_check_in";return n.postJSON(o).then(function(t){e.resolve(t)},function(t){e.reject(t)}),e.promise},this.attachGuestToReservation=function(t){var e=a.defer(),o="/api/reservations/"+t.reservation_id+"/reservations_guest_details/attach_guest_details";return delete t.reservation_id,n.postJSON(o,t).then(function(t){e.resolve(t)},function(t){e.reject(t)}),e.promise},this.getConfirmationData=function(t){var e=a.defer(),o="/api/reservations/"+t.reservation_id+"/confirmation_data";return n.getJSON(o).then(function(t){e.resolve(t)},function(t){e.reject(t)}),e.promise},this.createActivityLog=function(t){var e=a.defer();return n.postJSON("/api/reservation_actions",t).then(function(t){e.resolve(t)},function(t){e.reject(t)}),e.promise}}]),angular.module("sntRover").service("rvAccountsArTransactionsSrv",["$q","rvBaseWebSrvV2",function(t,a){this.fetchTransactionDetails=function(e){var n=t.defer(),o="/api/accounts/"+e.account_id+"/ar_transactions";return a.getJSON(o,e.getParams).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},this.fetchBillPrintData=function(e){var n=t.defer(),o="/api/accounts/"+e.account_id+"/ar_transactions/"+e.id+"/print_ar_invoice";return a.postJSON(o,e).then(function(t){t.charge_details_list=[],t.credit_details_list=[],angular.forEach(t.fee_details,function(a,e){angular.forEach(a.charge_details,function(e,n){e.date=a.date,t.charge_details_list.push(e)}),angular.forEach(a.credit_details,function(e,n){e.date=a.date,t.credit_details_list.push(e)})}),n.resolve(t)},function(t){n.reject(t)}),n.promise},this.sendEmail=function(e){var n=t.defer(),o="/api/accounts/"+e.account_id+"/ar_transactions/"+e.id+"/email_ar_invoice";return a.postJSON(o,e).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},this.saveArBalance=function(e){var n=t.defer(),o="/api/accounts/"+e.account_id+"/ar_transactions/create_manual_balances";return a.postJSON(o,e).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},this.fetchPaymentMethods=function(e){var n=t.defer(),o="api/accounts/"+e.id+"/ar_transactions/payments_for_allocation";return a.getJSON(o).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},this.paySelected=function(e){var n=t.defer(),o="/api/accounts/"+e.account_id+"/ar_transactions/allocate_payment";return a.postJSON(o,e.data).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},this.holdSelectedInvoices=function(e){var n=t.defer(),o="/api/accounts/"+e.account_id+"/ar_transactions/add_hold";return a.putJSON(o,e.data).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},this.releaseSelectedInvoices=function(e){var n=t.defer(),o="/api/accounts/"+e.account_id+"/ar_transactions/release_hold";return a.putJSON(o,e.data).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},this.expandPaidAndUnpaidList=function(e){var n=t.defer(),o="/api/accounts/"+e.account_id+"/ar_transactions/"+e.id+"/invoice_details";return a.getJSON(o).then(function(t){n.resolve(t.data)},function(t){n.reject(t)}),n.promise},this.fetchArStatementData=function(e){var n=t.defer(),o="/api/ar_transactions/get_email?id="+e.id;return a.getJSON(o).then(function(t){n.resolve(t.data)},function(t){n.reject(t)}),n.promise},this.fetchArStatementPrintData=function(e){var n=t.defer(),o="/api/ar_transactions/print";return a.postJSON(o,e).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},this.emailArStatement=function(e){var n=t.defer(),o="/api/ar_transactions/email";return a.postJSON(o,e).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},this.expandPaidAndUnpaidList=function(e){var n=t.defer(),o="/api/accounts/"+e.account_id+"/ar_transactions/"+e.id+"/invoice_details";return a.getJSON(o,e).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},this.expandAllocateAndUnallocatedList=function(e){var n=t.defer(),o="/api/accounts/"+e.account_id+"/ar_transactions/"+e.id+"/payment_details";return a.getJSON(o,e).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},this.getUnAllocateDetails=function(e){var n=t.defer(),o="/api/accounts/"+e.account_id+"/ar_transactions/"+e.id+"/payment_details";return a.getJSON(o).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},this.unAllocateSelectedPayment=function(e){var n=t.defer(),o="/api/accounts/"+e.account_id+"/ar_transactions/unallocate_payment";return a.postJSON(o,e.data).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},this.unAllocateData=function(e){var n=t.defer(),o="/api/accounts/"+e.account_id+"/ar_transactions/unallocate_info";return a.getJSON(o,e.data).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},this.fetchAccountsReceivables=function(e){var n=t.defer(),o="/api/accounts/ar_overview";return a.getJSON(o,e).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},this.moveInvoice=function(e){var n=t.defer(),o="/api/accounts/"+e.account_id+"/ar_transactions/move_invoice";return a.postJSON(o,e).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},this.getAdjustmentInfo=function(e){var n=t.defer(),o="api/accounts/"+e.accountId+"/ar_transactions/"+e.arTransactionId+"/adjustment_info";return a.postJSON(o,e.requestParams).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},this.postAdjustmentInfo=function(e){var n=t.defer(),o="api/accounts/"+e.accountId+"/ar_transactions/"+e.arTransactionId+"/post_adjustment";return a.postJSON(o,e.postData).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},this.moveToCreditInvoice=function(e){var n=t.defer(),o="/api/accounts/"+e.account_id+"/ar_transactions/post_manual_credit";return a.postJSON(o,e).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},this.lockBill=function(e){var n=t.defer(),o="/api/accounts/"+e.account_id+"/ar_transactions/"+e.id+"/ar_final_invoice_settlement";return a.postJSON(o,e).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},this.moveZeroInvoiceAsPaid=function(e){var n=t.defer(),o="/api/accounts/"+e.account_id+"/ar_transactions/move_zero_invoices_as_paid";return a.postJSON(o,e).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise}}]),angular.module("sntRover").service("RVPostChargeSrvV2",["$http","$q","BaseWebSrvV2","RVBaseWebSrv",function(t,a,e,n){this.fetchChargeGroups=function(){var t=a.defer(),n="/api/charge_groups.json";return e.getJSON(n).then(function(a){t.resolve(a)},function(a){t.reject(a)}),t.promise},this.postCharges=function(t){var e=a.defer(),o="/staff/items/post_items_to_bill";return n.postJSON(o,t).then(function(t){e.resolve(t)},function(t){e.reject(t)}),e.promise},this.getReservationBillDetails=function(t){var n=a.defer(),o="/api/reservations/"+t+"/bills";return e.getJSON(o).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},this.searchChargeItems=function(t){var n=a.defer(),o="/api/charge_codes/items_and_charge_codes.json?query="+t.query+"&page="+t.page+"&per_page="+t.per_page+"&charge_group_id="+t.charge_group_id+"&is_favorite="+t.is_favorite;return e.getJSON(o).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},this.postChargesFromArInvoice=function(t){var n=a.defer(),o="/api/accounts/"+t.accountId+"/ar_transactions/"+t.arTransactionId+"/post_charge_to_invoice";return e.postJSON(o,t.postChargeData).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise}}]),angular.module("sntRover").service("RVBillCardSrv",["$http","$q","BaseWebSrvV2","RVBaseWebSrv","rvBaseWebSrvV2","sntBaseWebSrv","RVGAHelperSrv",function(t,a,e,n,o,r,i){var c=this;this.fetchReservationBillData=function(t){var e=a.defer(),n="/api/reservations/"+t+"/bills_summary";return o.getJSON(n).then(function(t){e.resolve(t.data)},function(t){e.reject(t)}),e.promise},this.fetchAllowanceData=function(t,a,e){var n="/api/bills/"+a+"/allowance_transactions";return o.getJSON(n).then(function(a){a.allowance_data&&a.allowance_data.allowance_entries&&a.allowance_data.allowance_entries.length&&(_.each(a.allowance_data.allowance_entries,function(t,e){t.entriesForTheDate=_.filter(a.allowance_data.allowance_entries,function(a){return a.date===t.date}),t.amount=t.amount?parseFloat(t.amount):t.amount}),e.allowance_data=a.allowance_data),t.resolve(e)},function(a){t.reject(a)}),t.promise},this.fetchReservationAllowanceTransactions=function(t){var a="/api/reservations/"+t+"/allowance_transactions";return o.getJSON(a).then(function(t){var a={dataByAllowance:[],dataByDate:[]};return t.allowance_data&&t.allowance_data.allowance_entries&&t.allowance_data.allowance_entries.length&&(a.dataByAllowance=_.groupBy(t.allowance_data.allowance_entries,function(t){return t.addon_id}),a.dataByDate=_.groupBy(t.allowance_data.allowance_entries,function(t){return t.date})),a.amount=t.allowance_data.amount,a},function(){})},this.searchAllowanceShares=function(t){var e=a.defer(),n="/api/reservations/"+t.reservationId+"/search_reservations_for_allowance_share";return o.getJSON(n,{query:t.query}).then(function(t){e.resolve(t.data)},function(t){e.reject(t)}),e.promise},this.saveAllowanceShares=function(t){var n=a.defer(),o="/api/reservations/"+t.reservationId+"/route_allowance";return e.postJSON(o,t.data).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},this.fetchBillData=function(t){var e=a.defer(),n="/api/bills/"+t;return o.getJSON(n).then(function(t){e.resolve(t.data)},function(t){e.reject(t)}),e.promise},this.fetch=function(t){var e="",n=a.defer(),o="",r="";return a.when().then(function(){return c.fetchReservationBillData(t).then(function(t){e=t})}).then(function(){return o=e.bills[0].bill_id,r=parseInt(e.bills[0].bill_number)-1,c.fetchBillData(o).then(function(t){e.bills[r]=t})}).then(function(){e.groupedAllowances={},n.resolve(e)},function(t){n.reject(t)}),n.promise},this.fetchBillPrintData=function(t){var e=a.defer(),o="staff/bills/print_guest_bill";return n.postJSON(o,t).then(function(t){t.charge_details_list=[],angular.forEach(t.fee_details,function(a,e){angular.forEach(a.charge_details,function(e){e.date=a.date,e.isCredit=!1,t.charge_details_list.push(e)}),angular.forEach(a.credit_details,function(e){e.date=a.date,e.isCredit=!0,t.charge_details_list.push(e)})}),e.resolve(t)},function(t){e.reject(t)}),e.promise},this.fetchRegistrationCardPrintData=function(t){var e=a.defer(),n="/api/registration_cards/"+t.reservation_id;return o.getJSON(n,t).then(function(t){e.resolve(t)},function(t){e.reject(t)}),e.promise},this.movetToAnotherBill=function(t){var n=a.defer(),o="/staff/bills/transfer_transaction";return e.postJSON(o,t).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},this.setBillAddressType=function(t){var n=a.defer(),o="/api/bills/"+t.bill_id+"/save_address_type";return e.postJSON(o,t.parmasToApi).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},this.completeCheckin=function(t){var e=a.defer(),o="/staff/checkin";return n.postJSON(o,t).then(function(a){i.sendEventToGA("CHECKIN",t.reservation_id),e.resolve(a)},function(t){e.reject(t)}),e.promise},this.completeCheckout=function(t){var e=a.defer(),o="/staff/checkout";return n.postJSON(o,t).then(function(a){i.sendEventToGA("CHECKOUT",t.reservation_id),e.resolve(a)},function(t){e.reject(t)}),e.promise},this.getAdvanceBill=function(t){var e=a.defer(),o="api/reservations/"+t.id+"/advance_bill";return n.postJSON(o).then(function(t){e.resolve(t)},function(t){e.reject(t)}),e.promise},this.transactionEdit=function(t){var n=a.defer(),o="api/financial_transactions/"+t.id;return e.putJSON(o,t.updatedData).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},this.transactionEditChargeDescription=function(t){var n=a.defer(),o="api/financial_transactions/"+t.id+"/save_custom_description";return e.postJSON(o,t.postData).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},this.transactionDelete=function(t){var n=a.defer(),o=t.id,r="api/financial_transactions/"+o;return e.putJSON(r,t.data).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},this.transactionSplit=function(t){var n=a.defer(),o=t.id,r="api/financial_transactions/"+o;return e.putJSON(r,t.data).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},this.fetchChargeCodes=function(){var t=a.defer(),n="/api/charge_codes?exclude_payments=true&per_page=1000";return e.getJSON(n).then(function(a){t.resolve(a)},function(a){t.reject(a)}),t.promise},this.fetchAdjustmentReasons=function(){var t=a.defer(),n="/admin/force_adjustment_reasons";return e.getJSON(n).then(function(a){t.resolve(a)},function(a){t.reject(a)}),t.promise},this.sendEmail=function(t){var n=a.defer(),o="api/reservations/email_guest_bill.json";return e.postJSON(o,t).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},this.createAnotherBill=function(t){var n=a.defer(),o="/api/bills/create_bill";return e.postJSON(o,t).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},this.changeHousekeepingStatus=function(t){var n=a.defer(),o="/house/change_house_keeping_status.json";return e.postJSON(o,t).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},this.completeReverseCheckout=function(t){var n=a.defer(),o="/staff/reverse_checkout";return e.postJSON(o,t).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},this.toggleHideRate=function(t){var n=a.defer(),o="api/reservations/"+t.reservation_id+"/hide_rates";return e.postJSON(o,t).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},this.getBillSettingsInfo=function(t){var n=a.defer(),o="/api/bills/get_settings_info";return e.getJSON(o,t).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},this.groupChargeDetailsFetch=function(t){var n=a.defer(),o="/staff/reservation/transaction_details";return e.getJSON(o,t).then(function(t){n.resolve(t.data)},function(t){n.reject(t)}),n.promise},this.hideBill=function(t){var n=a.defer(),o="/api/bills/"+t.bill_id+"/hide_bill";return e.postJSON(o).then(function(t){n.resolve(t.data)},function(t){n.reject(t)}),n.promise},this.fetchGuestLanguages=function(t){var e=a.defer(),n="/api/guest_languages";return o.getJSON(n,t).then(function(t){t.languages&&(t.languages=_.filter(t.languages,{is_show_on_guest_card:!0})),e.resolve(t)},function(t){e.reject(t)}),e.promise},this.callBlackBoxApi=function(t){var n=a.defer(),o="/api/hotel_settings/infrasec/generate_control_code";return e.postJSON(o,t).then(function(t){n.resolve(t.data)},function(t){n.reject(t)}),n.promise},this.generateFolioNumber=function(t){var n=a.defer(),o="/api/bills/"+t.bill_id+"/generate_folio_number";return e.postJSON(o,t).then(function(t){n.resolve(t.data)},function(t){n.reject(t)}),n.promise},this.generateVoidBill=function(t){var n=a.defer(),o="/api/bills/"+t.bill_id+"/void_bill";return e.postJSON(o,t.data).then(function(t){n.resolve(t.data)},function(t){n.reject(t)}),n.promise},this.settleFinalInvoice=function(t){var n=a.defer(),o="/api/bills/"+t.bill_id+"/final_invoice_settlement";return e.postJSON(o,t).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},this.printReceiptData=function(t){var e=a.defer(),n="/api/bills/"+t.bill_id+"/print_payment_receipt";return r.postJSON(n,t).then(function(t){e.resolve(t)},function(t){e.reject(t)}),e.promise},this.emailReceiptData=function(t){var e=a.defer(),n="/api/bills/"+t.bill_id+"/email_payment_receipt";return r.postJSON(n,t).then(function(t){e.resolve(t)},function(t){e.reject(t)}),e.promise}}]),angular.module("sntRover").service("RVContactInfoSrv",["$q","RVBaseWebSrv","rvBaseWebSrvV2",function(t,a,e){var n=this;n.saveContactInfo=function(e){var n=t.defer(),o=e.data,r=e.userId,i="/staff/guest_cards/"+r;return a.putJSON(i,o).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},n.createGuest=function(a){var n=t.defer(),o=a.data,r="/api/guest_details";return e.postJSON(r,o).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},n.updateGuest=function(a){var n=t.defer(),o="/api/guest_details/"+a.userId;return a.check_validation_only&&(o+="?check_validation_only=true"),e.putJSON(o,a.data).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},n.fetchGuestLanguages=function(a){var n=t.defer(),o="/api/guest_languages";return e.getJSON(o,a).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},n.removeGuestDetails=function(a){var n=t.defer(),o="/api/guest_details/"+a+"/anonymize";return e.putJSON(o).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},n.getGuestDetailsById=function(a){var n=t.defer(),o="/api/guest_details/"+a;return null===a?n.reject([""]):e.getJSON(o).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},n.parseGuestData=function(t,a){var e={};return e.id=a,e.firstName=t.first_name,e.lastName=t.last_name,e.image=t.image_url,e.vip=t.vip,t.address&&(e.address={},e.address.city=t.address.city,e.address.state=t.address.state,e.address.postalCode=t.address.postal_code),e.stayCount=t.stay_count,e.lastStay={},e.phone=t.home_phone,e.email=t.email,t.last_stay&&(e.lastStay.date=t.last_stay.date,e.lastStay.room=t.last_stay.room,e.lastStay.roomType=t.last_stay.room_type),e},n.deleteGuest=function(a){var n=t.defer(),o="/api/guest_details/"+a;return e.deleteJSON(o).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},n.checkIfCommisionWasRecalculated=function(a){var n=t.defer(),o="/api/reservations/"+a.reservation_id+"/commission_transaction_info";return e.getJSON(o).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise}}]),angular.module("sntRover").service("rvAccountTransactionsSrv",["$q","rvBaseWebSrvV2","$rootScope",function(t,a,e){this.fetchGroupAllowances=function(t){var e="/api/groups/"+t.id+"/group_allowance_transactions";return a.getJSON(e,{associated_type:t.type}).then(function(t){var a={dataByAllowance:[],dataByDate:[]};t.allowance_data=_.map(t.allowance_data,function(t){return t.ptime=parseInt(t.time.replace(":",""),10),t});try{t.allowance_data&&t.allowance_data.length&&(a.dataByAllowance=_.groupBy(t.allowance_data,function(t){return t.addon_id}),a.dataByDate=_.groupBy(t.allowance_data,function(t){return t.date}),_.each(a.dataByAllowance,function(t,e){a.dataByAllowance[e]=_.sortBy(t,function(t){return t.ptime})}),_.each(a.dataByDate,function(t,e){a.dataByDate[e]=_.sortBy(t,function(t){return t.ptime})}))}catch(t){console.error(t)}return a},function(){})},this.searchAllowanceShares=function(e){var n=t.defer(),o="/api/groups/"+e.groupId+"/group_allowance_search";return a.getJSON(o,{query:e.query,associated_type:e.type}).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},this.saveAllowanceShares=function(e){var n=t.defer(),o="/api/groups/"+e.groupId+"/group_allowance_share";return a.postJSON(o,{shared_allowances:e.data,associated_type:e.type}).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},this.fetchTransactionDetails=function(e){
var n=t.defer(),o="/api/posting_accounts/"+e.account_id+"/bill_card";return a.getJSON(o).then(function(t){angular.forEach(t.bills,function(t){t.page_no=1,t.transactions=[],t.activeDate=t.days.length>0?_.last(t.days).date:null}),n.resolve(t)},function(t){n.reject(t)}),n.promise},this.fetchBillTransactionDetails=function(e){var n=t.defer(),o="/api/bills/"+e.bill_id+"/transactions?date="+e.date+"&page="+e.page+"&per_page="+e.per_page;return a.getJSON(o).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},this.createAnotherBill=function(e){var n=t.defer(),o="api/bills/create_bill";return a.postJSON(o,e).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},this.moveToAnotherBill=function(e){var n=t.defer(),o="api/bills/transfer_transaction";return a.postJSON(o,e).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},this.transactionEdit=function(e){var n=t.defer(),o=e.id,r=e.updatedDate,i="api/financial_transactions/"+o;return a.putJSON(i,r).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},this.transactionEditChargeDescription=function(e){var n=t.defer(),o="api/financial_transactions/"+e.id+"/save_custom_description";return a.postJSON(o,e.postData).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},this.transactionDelete=function(e){var n=t.defer(),o=e.id,r="api/financial_transactions/"+o;return a.putJSON(r,e.data).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},this.transactionSplit=function(e){var n=t.defer(),o=e.id,r="api/financial_transactions/"+o;return a.putJSON(r,e.data).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},this.savePaymentDetails=function(e){var n=t.defer(),o="/api/bills/"+e.bill_id+"/add_payment_method";return a.postJSON(o,e.data_to_pass).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},this.submitPaymentOnBill=function(n){var o=0,r=function(){o++},i=setInterval(r,1e3),c=t.defer(),s="/api/bills/"+n.bill_id+"/submit_payment",l=function t(n){if(o>=e.emvTimeout){var r=["Request timed out. Unable to process the transaction"];c.reject(r)}else a.getJSONWithSpecialStatusHandling(n).then(function(a){a.status&&"processing_not_completed"===a.status||"null"===a?setTimeout(function(){console.info("POLLING::-> for emv terminal response"),t(n)},5e3):(clearInterval(i),c.resolve(a))},function(a){"undefined"==typeof a?t(n):(clearInterval(i),c.reject(a))})};return a.postJSONWithSpecialStatusHandling(s,n.data_to_pass).then(function(t){n.data_to_pass.is_emv_request&&t.status&&"processing_not_completed"===t.status?l(t.location_header):(clearInterval(i),c.resolve(t))},function(t){clearInterval(i),c.reject(t)}),c.promise},this.postCharges=function(e){var n=t.defer(),o="/staff/items/post_items_to_bill";return a.postJSON(o,e).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},this.checkForArAccount=function(e){var n=t.defer(),o="/api/posting_accounts/"+e.account_id+"/check_ar_account_attached";return a.getJSON(o).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},this.fetchAccountBillsForPrint=function(e){var n=t.defer(),o="/api/posting_accounts/print_bill_card";return a.postJSON(o,e).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},this.groupChargeDetailsFetch=function(e){var n=t.defer(),o="/api/posting_accounts/transaction_details";return a.getJSON(o,e).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise}}]),sntRover.controller("RVCommissionsDatePickerController",["$scope","$rootScope","ngDialog","dateFilter",function(t,a,e,n){var o=tzIndependentDate(a.businessDate);"FROM"===t.clickedOn?t.date=t.filterData.fromDate?t.filterData.fromDate:o:"TO"===t.clickedOn&&(t.date=t.filterData.toDate?t.filterData.toDate:o),t.setUpData=function(){t.dateOptions={changeYear:!0,changeMonth:!0,yearRange:"-5:+5",onSelect:function(a,n){"FROM"===t.clickedOn?(t.filterData.fromDate=t.date,t.$emit("fromDateChanged")):"TO"===t.clickedOn&&(t.filterData.toDate=t.date,t.$emit("toDateChanged")),e.close()}}},t.setUpData()}]),angular.module("sntRover").service("RVGuestCardsSrv",["$q","rvBaseWebSrvV2","sntBaseWebSrv","$rootScope","$log","$http",function(t,a,e,n,o,r){var i,c={},s=this,l={id:null,isFetched:!1};s.setGuest=function(t){s.resetGuest(),l.id=parseInt(t,10)},s.isGuestFetchComplete=function(t){return t=parseInt(t,10),l.id===t&&l.isFetched},s.resetGuest=function(){l.id=null,l.isFetched=!1},this.PER_PAGE_COUNT=50,s.fetchGuestDetails=function(a){var r=t.defer(),i="/api/guest_details/"+a;return n.isStandAlone||(i+="?sync_with_external_pms=true"),l.id?e.getJSON(i).then(function(t){l.isFetched=!0,r.resolve(t)},function(t){r.reject(t)}):(o.debug("Guest not set!"),r.reject(["Guest not set"])),r.promise},s.fetchGuestAdminSettings=function(){var a=t.defer(),n="/admin/guest_card_settings/current_settings";return e.getJSON(n).then(function(t){a.resolve(t)},function(t){a.reject(t)}),a.promise},this.fetchGuestAdminSettingsAndGender=function(a){var e=t.defer(),n={},o=[];return o.push(t.when().then(function(){return s.fetchGuestAdminSettings(a).then(function(t){n.guest_admin_settings=t})})),o.push(t.when().then(function(){return s.fetchGenderTypes().then(function(t){n.genderTypeList=t})})),o.push(t.when().then(function(){return s.fetchIdTypes().then(function(t){n.idTypeList=t})})),t.all(o).then(function(){e.resolve(n)},function(t){e.reject(t)}),e.promise},this.fetchGuestDetailsInformation=function(a){var e=t.defer(),n={},o=[];return o.push(s.fetchGuestDetails(a)),o.push(s.fetchGuestAdminSettingsAndGender()),t.all(o).then(function(t){n=t[0],n.guest_admin_settings=t[1].guest_admin_settings,n.genderTypeList=t[1].genderTypes,e.resolve(n)},function(t){e.reject(t)}),e.promise},this.fetchGuests=function(a){var n=t.defer(),o="/api/guest_details";return e.getJSON(o,a).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},this.setGuestFields=function(){return c},this.setGuestFields=function(){return c},this.fetchGuestCardStatisticsSummary=function(e){var n=t.defer(),o="/api/guest_details/"+e.guestId+"/statistics?view=SUMMARY";return delete e.guestId,a.getJSON(o,e).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},this.fetchGuestCardStatisticsDetails=function(e){var n=t.defer(),o="/api/guest_details/"+e.guestId+"/statistics?view=DETAILED";return delete e.guestId,a.getJSON(o,e).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise};var d=[];this.fetchNationsList=function(){var e=t.defer(),n="/ui/country_list";return d.length?e.resolve(d):a.getJSON(n).then(function(t){d=t,e.resolve(t)},function(t){e.reject(t)}),e.promise},this.saveGuestIdDetails=function(t){var e="/api/guest_identity";return a.postJSON(e,t)},this.saveFaceImage=function(t){var e="/staff/guest_cards/"+t.guest_id+".json";return a.putJSON(e,t)},this.verifyGuestCardMerge=function(e){var n=t.defer(),o="/api/guest_details/validate_card_merge";return a.postJSON(o,e).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},this.mergeCards=function(e){var n=t.defer(),o="/api/guest_details/merge_cards";return a.postJSON(o,e).then(function(t){n.resolve(t)},function(t){n.reject(t)}),n.promise},this.fetchGenderTypes=function(){var a=t.defer(),n="api/guest_details/gender_types";return e.getJSON(n).then(function(t){a.resolve(t.gender_list)},function(t){a.resolve(t)}),a.promise},this.fetchIdTypes=function(){var a=t.defer(),n="api/guest_details/government_id_types";return i?a.resolve(i):e.getJSON(n).then(function(t){i=t.id_type_list,a.resolve(i)},function(t){a.resolve(t)}),a.promise},this.fetchGuestList=function(e){var n="/api/guest_details",o=t.defer(),i={method:"GET",url:n,params:e};return r(i).then(function(t){var a={data:t.data,params:t.config&&t.config.params};o.resolve(a)},function(t){a.webserviceErrorActions(n,o,t.data,t.status)}),o.promise}}]),window.StatisticsBaseCtrl=function(t,a){t.getStatusIconClass=function(t){var a="neutral";return t<0?a="icons time check-out rotate-right":t>0&&(a="icons time check-in rotate-right"),a},t.getStatusClass=function(t){var a="";return t>0?a="green":t<0&&(a="red"),a},t.absVal=function(t){return t?Math.abs(t):""},t.getCurrentYear=function(){var t=tzIndependentDate(a.businessDate),e=t.getFullYear();return e},t.populateYearDropDown=function(a){var e,n="";t.yearOptions=[],"summary"===t.activeView?(a=a===t.getCurrentYear()?a-1:a,e=t.getCurrentYear()-1):e=t.getCurrentYear();for(var o=e;o>=a;o--)n=o===e?"summary"===t.activeView?"LAST YEAR ("+o+")":"YEAR TO DATE ("+o+")":o,t.yearOptions.push({name:n,value:o})},t.getReservationClass=function(t){var a={RESERVED:"arrival",CHECKING_IN:"check-in",CHECKEDIN:"inhouse",CHECKING_OUT:"check-out",CHECKEDOUT:"departed",CANCELED:"cancel",NOSHOW:"no-show",NOSHOW_CURRENT:"no-show"};return a[t.reservation_status.toUpperCase()]||""}},sntRover.controller("rvArBillFormatPopupCtrl",["$scope","$rootScope","$filter","RVBillCardSrv","RVContactInfoSrv","rvAccountsArTransactionsSrv","ngDialog","$timeout",function(t,a,e,n,o,r,i,c){var s=200,l=500;BaseCtrl.call(this,t),t.isCompanyCardInvoice=!0,t.disableCompanyCardInvoice=!1,t.hideCompanyCardInvoiceToggle=!0,t.billFormat.isInformationalInvoice=!t.shouldGenerateFinalInvoice,t.billFormat.isInformationalInvoiceDisabled=!t.disableInformationCheckBox;var d=function(){var a={};return a.is_type="ArAccount",a.id=t.item.transaction_id,a};t.closeDialog=function(){a.modalOpened=!1,c(function(){i.close()},s)};var u=function(a){a.languages&&(a.languages=_.filter(a.languages,{is_show_on_guest_card:!0})),t.languageData=a,t.data.locale=a.selected_language_code},m=function(){var a={params:{},successCallBack:u};t.callAPI(o.fetchGuestLanguages,a)},f=function(){var a=d(),e=function(a){m(),a.data&&a.data.default_bill_settings&&(a.data.default_bill_settings=a.data.default_bill_settings.toString()),t.data=a.data,t.setEmailAddress()},o={params:a,successCallBack:e};t.callAPI(n.getBillSettingsInfo,o)},p=function(){var a={};return a.id=t.item.transaction_id,a.account_id=t.arTransactionsData.accountId,a.locale=t.data.locale,a};t.printBill=function(a){var e=p();e.is_locked=a,t.$emit("UPDATE_INFORMATIONAL_INVOICE",t.billFormat.isInformationalInvoice),e.bill_layout=t.data.default_bill_settings,e.is_informational_invoice=t.billFormat.isInformationalInvoice,t.clickedPrint(e)},t.clickedContinueButtonPrintOrEmail=function(){var a={},e=!1;a.id=t.item.transaction_id,a.account_id=t.arTransactionsData.accountId;var n=function(){t.is_bill_lock_enabled&&(e=!0),t.isClickedPrint?t.printBill(e):t.sendEmail(e)},o=function(a){e=!1,t.errorMessage=a},i={params:a,successCallBack:n,failureCallBack:o};t.callAPI(r.lockBill,i)},t.clickedPrintBill=function(){!t.shouldGenerateFinalInvoice||t.billFormat.isInformationalInvoice||t.item.is_locked?t.printBill():(t.isClickedPrint=!0,t.isInvoiceStepThreeActive=!1,c(function(){t.isInvoiceStepFourActive=!0},l))},t.sendEmail=function(a){var e=p();e.is_locked=a,e.bill_layout=t.data.default_bill_settings,e.to_address=t.data.mailto_address,e.is_informational_invoice=t.billFormat.isInformationalInvoice,t.clickedEmail(e)},t.emailBill=function(){!t.shouldGenerateFinalInvoice||t.billFormat.isInformationalInvoice||t.item.is_locked?t.sendEmail():(t.isClickedPrint=!1,t.isInvoiceStepThreeActive=!1,c(function(){t.isInvoiceStepFourActive=!0},l))},t.clickedFinalInvoiceButton=function(){t.isInvoiceStepOneActive=!1,c(function(){t.isInvoiceStepTwoActive=!0},l)},t.clickedProceedButton=function(){t.isInvoiceStepTwoActive=!1,t.isInvoiceStepFourActive=!1,c(function(){t.isInvoiceStepThreeActive=!0},l)},t.clickedCancelButtonProceedScreen=function(){t.isInvoiceStepTwoActive=!1,c(function(){t.isInvoiceStepOneActive=!0},l)};var v=t.$on("UPDATE_WINDOW",function(){t.isInvoiceStepFourActive=!1,c(function(){t.item.is_locked||(t.isInvoiceStepFiveActive=!0)},l)});t.getPrintButtonClass=function(){var a="blue";return 0===parseInt(t.item.print_counter,10)&&0===parseInt(t.transactionsDetails.no_of_original_invoices,10)&&t.roverObj.noReprintReEmailInvoice?a="blue":!t.billFormat.isInformationalInvoice&&parseInt(t.item.print_counter,10)>0&&0===parseInt(t.transactionsDetails.no_of_original_invoices,10)&&t.roverObj.noReprintReEmailInvoice?a="grey":!t.billFormat.isInformationalInvoice&&parseInt(t.item.print_counter,10)>=parseInt(t.transactionsDetails.no_of_original_invoices,10)&&t.roverObj.noReprintReEmailInvoice&&(a="grey"),a},t.isPrintButtonDisabled=function(){var a=!1;return 0===parseInt(t.item.print_counter,10)&&0===parseInt(t.transactionsDetails.no_of_original_invoices,10)&&t.roverObj.noReprintReEmailInvoice?a=!1:!t.billFormat.isInformationalInvoice&&parseInt(t.item.print_counter,10)>0&&0===parseInt(t.transactionsDetails.no_of_original_invoices,10)&&t.roverObj.noReprintReEmailInvoice?a=!0:!t.billFormat.isInformationalInvoice&&parseInt(t.item.print_counter,10)>=parseInt(t.transactionsDetails.no_of_original_invoices,10)&&t.roverObj.noReprintReEmailInvoice&&(a=!0),a},t.getEmailButtonClass=function(){var a="blue";return t.data.mailto_address?0===parseInt(t.item.email_counter,10)&&0===parseInt(t.transactionsDetails.no_of_original_emails,10)&&t.roverObj.noReprintReEmailInvoice?a="blue":!t.billFormat.isInformationalInvoice&&parseInt(t.item.email_counter,10)>0&&0===parseInt(t.transactionsDetails.no_of_original_emails,10)&&t.roverObj.noReprintReEmailInvoice?a="grey":!t.billFormat.isInformationalInvoice&&parseInt(t.item.email_counter,10)>=parseInt(t.transactionsDetails.no_of_original_emails,10)&&t.roverObj.noReprintReEmailInvoice&&0!==parseInt(t.transactionsDetails.no_of_original_emails,10)&&(a="grey"):a="grey",a},t.isEmailButtonDisabled=function(){var a=!1;return t.data.mailto_address?0===parseInt(t.item.email_counter,10)&&0===parseInt(t.transactionsDetails.no_of_original_emails,10)&&t.roverObj.noReprintReEmailInvoice?a=!1:!t.billFormat.isInformationalInvoice&&parseInt(t.item.email_counter,10)>0&&0===parseInt(t.transactionsDetails.no_of_original_emails,10)&&t.roverObj.noReprintReEmailInvoice?a=!0:!t.billFormat.isInformationalInvoice&&parseInt(t.item.email_counter,10)>=parseInt(t.transactionsDetails.no_of_original_emails,10)&&t.roverObj.noReprintReEmailInvoice&&0!==parseInt(t.transactionsDetails.no_of_original_emails,10)&&(a=!0):a=!0,a},t.clickedInformationalButton=function(){t.billFormat.isInformationalInvoice=!0,t.isInvoiceStepOneActive=!1,c(function(){t.isInvoiceStepThreeActive=!0},l)},t.setEmailAddress=function(){t.isCompanyCardInvoice?t.data.mailto_address=t.data.company_address?t.data.company_address:t.data.to_address:t.data.mailto_address=t.data.travel_agent_address?t.data.travel_agent_address:t.data.to_address};var h=function(){t.data={},f()};t.changeCompanyCardInvoiceToggle=function(){t.isCompanyCardInvoice=!t.isCompanyCardInvoice},t.$on("$destroy",v),h()}]),angular.module("sntRover").controller("RVCompanyCardTravelAgentStatisticsController",["$scope","$rootScope","RVCompanyCardSrv","$timeout","$vault","$state","$stateParams",function(t,a,e,n,o,r,i){var c=[],s="cc-sidebar-scroller",l="cc-monthly-data-scroller",d="cc-statistics-summary-sidebar-scroller",u="cc-statistics-summary-data-scroller",m=25;BaseCtrl.call(this,t),StatisticsBaseCtrl.call(this,t,a);var f=function(){var a=function(a){t.statistics.summary=a,n(function(){S(!0)},200),O()},o=function(){t.statistics.summary={}},r={params:{year:t.filterData.selectedYear,accountId:h()},onSuccess:a,onFailure:o};t.callAPI(e.fetchCompanyTravelAgentStatisticsSummary,r)},p=function(){var a=function(a){t.statistics.details=a,t.statistics.details.monthly_data=t.statistics.details.monthly_data.reverse(),n(function(){S(!0)},500),T()},o=function(){t.statistics.details={}},r={params:{year:t.filterData.selectedYear,accountId:h()},onSuccess:a,onFailure:o};t.callAPI(e.fetchCompanyTravelAgentStatisticsDetails,r)},_=function(){c.LOAD_GUEST_STATISTICS=t.$on("LOAD_GUEST_STATISTICS",function(){f()}),c.UPDATE_CONTACT_INFO=t.$on("UPDATE_CONTACT_INFO",function(){g()})},v=function(){angular.forEach(function(a){t.$on("$destroy",a)})},h=function(){var a="";return t.contactInformation&&t.contactInformation.id&&(a=t.contactInformation.id),a||(a=i.id),a};t.setActiveView=function(a,e){t.activeView=a,"details"===a?(t.filterData.selectedYear=e||t.getCurrentYear(),A(),T(),C(),p()):(t.filterData.selectedYear=t.getCurrentYear()-1,A(),O(),C(),f())},t.getReservationByPage=function(a){D(a,t.selectedMonthData)};var D=function(a,o){var r=function(a){t.totalResultCount=a.total_count,o.reservations=a.reservations,y(),n(function(){S(),t.getScroller(l).scrollToElement(".res-active",500,0,0)},1e3),T()},i=function(){o.reservations=[]},c={params:{year:t.filterData.selectedYear,month:o.month,accountId:h(),per_page:m,page:a},onSuccess:r,onFailure:i};t.callAPI(e.fetchCompanyTravelAgentMonthlyReservations,c)},y=function(){n(function(){t.$broadcast("updatePagination","STATISTICS_PAGINATION")},200)};t.shouldShowReservations=function(t){return 0!==t.reservations_count},t.showMonthlyReservations=function(a){return!!t.shouldShowReservations(a)&&void(a.isOpen?(a.isOpen=!a.isOpen,n(function(){S()},200)):(t.totalResultCount=0,y(),t.selectedMonthData=a,t.statistics.details.monthly_data.forEach(function(e,n){e.month!==a.month&&(t.statistics.details.monthly_data[n].isOpen=!1,e.reservations=[])}),D(1,a),a.isOpen=!a.isOpen))},t.onChangeYear=function(){"summary"===t.activeView?f():p()};var C=function(){t.populateYearDropDown(t.contactInformation.first_stay_year)};t.navigateToStayCard=function(a){return"rover.companycarddetails"===r.current.name&&(o.set("cardId",t.accountId),o.set("type",t.contactInformation.account_details.account_type),o.set("selectedYear",t.filterData.selectedYear),void r.go("rover.reservation.staycard.reservationcard.reservationdetails",{id:a.reservation_id,confirmationId:a.confirmation_no,isrefresh:!0,isFromCardStatistics:!0}))},t.shouldShowNavigation=function(){var t=!0;return"rover.companycarddetails"===r.current.name&&(t=!1),t},t.getStyleForExpandedView=function(a){var e={},n=a.reservations&&a.reservations.length;if(a.isOpen){var o=70*n+30;t.totalResultCount>t.perPage&&(o+=60),e["margin-bottom"]=o+"px"}return e};var g=function(){t.accountId=h(),t.currentYear=t.getCurrentYear(),C()},A=function(){t.setScroller(s,{preventDefault:!1,probeType:3}),t.setScroller(l,{preventDefault:!1,probeType:3,scrollX:!0}),t.setScroller(d,{preventDefault:!1,probeType:3}),t.setScroller(u,{preventDefault:!1,probeType:3,scrollX:!0})},S=function(a){n(function(){t.myScroll.hasOwnProperty(s)&&(t.refreshScroller(s),a&&t.myScroll[s].scrollTo(0,0,100)),t.myScroll.hasOwnProperty(l)&&(t.refreshScroller(l),a&&t.myScroll[l].scrollTo(0,0,100)),t.myScroll.hasOwnProperty(d)&&(t.refreshScroller(d),a&&t.myScroll[d].scrollTo(0,0,100)),t.myScroll.hasOwnProperty(u)&&(t.refreshScroller(u),a&&t.myScroll[u].scrollTo(0,0,100))},200)},b=function(){t.myScroll.hasOwnProperty(s)&&t.myScroll.hasOwnProperty(l)&&(t.myScroll[s].on("scroll",function(){t.myScroll[l].scrollTo(0,this.y)}),t.myScroll[l].on("scroll",function(){t.myScroll[s].scrollTo(0,this.y)}))},I=function(){t.myScroll.hasOwnProperty(d)&&t.myScroll.hasOwnProperty(u)&&(t.myScroll[d].on("scroll",function(){t.myScroll[u].scrollTo(0,this.y)}),t.myScroll[u].on("scroll",function(){t.myScroll[d].scrollTo(0,this.y)}))},T=function a(){t.myScroll.hasOwnProperty(s)&&t.myScroll.hasOwnProperty(l)?b():n(a,1e3)},O=function a(){t.myScroll.hasOwnProperty(d)&&t.myScroll.hasOwnProperty(u)?I():n(a,1e3)},P=function(){t.perPage=m,t.page=1},E=function(){t.pageOptions={id:"STATISTICS_PAGINATION",perPage:t.perPage,api:t.getReservationByPage}},N=function(){t.activeView="summary",t.statistics={summary:{},details:{}},t.filterData={selectedYear:t.getCurrentYear()-1},g(),T(),O(),_(),v(),P(),E(),i.isBackFromStaycard?(t.filterData.selectedYear=i.selectedStatisticsYear?i.selectedStatisticsYear:t.filterData.selectedYear,t.setActiveView("details",t.filterData.selectedYear)):t.setActiveView("summary")};N()}]);