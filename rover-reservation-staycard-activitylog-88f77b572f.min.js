angular.module("sntRover").service("RVActivityLogSrv",["$q","rvBaseWebSrvV2",function(t,e){this.cacheReportList={},this.fetchActivityLog=function(r){var i=t.defer(),o="/api/reservation_actions/"+r;return e.getJSON(o,{per_page:50,page:1}).then(function(t){this.cacheReportList=t,i.resolve(this.cacheReportList)}.bind(this),function(t){i.reject(t)}),i.promise},this.filterActivityLog=function(r){var i=t.defer(),o="/api/reservation_actions/"+r.id;return r=_.omit(r,"id"),e.getJSON(o,r).then(function(t){this.cacheReportList=t,i.resolve(this.cacheReportList)}.bind(this),function(t){i.reject(t)}),i.promise},this.fetchActiveUsers=function(){var r=t.defer(),i="/api/users/active";return e.getJSON(i).then(function(t){r.resolve(t)},function(t){r.reject(t)}),r.promise}}]),sntRover.controller("RVActivityLogCtrl",["$scope","$rootScope","$filter","activityLogResponse","activeUserList","$state","RVActivityLogSrv","$timeout",function(t,e,r,i,o,a,n,s){function c(t){return t.split(/,\s*/)}function d(t){return c(t).pop()}BaseCtrl.call(this,t);var l=30,u=260,p="RESERVATION_ACTIVITY_LOGS";t.backToStayCard=function(){a.go("rover.reservation.staycard.reservationcard.reservationdetails",{id:t.$parent.reservation.reservation_card.reservation_id,confirmationId:t.$parent.reservation.reservation_card.confirmation_num,isrefresh:!0})},t.$on("NG_REPEAT_COMPLETED_RENDERING",function(e){setTimeout(function(){t.refreshScroller("report_content")},100)}),t.clickedOnReportUpdate=function(e){getParentWithSelector(e,document.getElementsByClassName("ui-resizable-e")[0])&&(t.reportUpdateVisible?(t.reportUpdateWidth=l,t.reportUpdateVisible=!1):(t.reportUpdateVisible=!0,t.reportUpdateWidth=u))},t.$on("closeSidebar",function(){t.reportUpdateWidth=l,t.reportUpdateVisible=!1});var f=function(){var r={dateFormat:e.jqDateFormat,numberOfMonths:1,changeYear:!0,changeMonth:!0,yearRange:"-50:+50",beforeShow:function(t,e){$("#ui-datepicker-div"),$('<div id="ui-datepicker-overlay">').insertAfter("#ui-datepicker-div")},onClose:function(t){$("#ui-datepicker-div"),$("#ui-datepicker-overlay").remove()}};t.fromDateOptions=angular.extend({onSelect:function(e){t.untilDateOptions.minDate=e}},r),t.untilDateOptions=angular.extend({onSelect:function(e){t.fromDateOptions.maxDate=e}},r)};t.isOldValue=function(t){return""!==t&&"undefined"!=typeof t&&null!==t},t.updateReportFilter=function(){t.isUpdateReportFilter=!0,v(),t.initSort(),t.updateReport()},t.updateReport=function(e){e=e||1;var i=function(e){t.totalResults=e.total_count,t.activityLogData=e.results,t.nextAction&&(t.start=t.start+t.perPage,t.nextAction=!1,t.initSort()),t.prevAction&&(t.start=t.start-t.perPage,t.prevAction=!1,t.initSort()),t.end=t.start+t.activityLogData.length-1,t.$emit("hideLoader"),S()},o={id:t.$parent.reservation.reservation_card.reservation_id,page:e,per_page:t.perPage};t.isUpdateReportFilter&&(o.from_date=r("date")(t.fromDate,"yyyy-MM-dd"),o.to_date=r("date")(t.toDate,"yyyy-MM-dd"),t.user_id&&(o.user_id=t.user_id)),o.sort_order=t.sort_order,o.sort_field=t.sort_field,t.invokeApi(n.filterActivityLog,o,i)},t.initSort=function(){t.sortOrderOfUserASC=!1,t.sortOrderOfDateASC=!1,t.sortOrderOfActionASC=!1,t.sortOrderOfUserDSC=!1,t.sortOrderOfDateDSC=!1,t.sortOrderOfActionDSC=!1},t.sortByUserName=function(){t.sort_field="USERNAME",t.sortOrderOfUserASC?(t.initSort(),t.sortOrderOfUserDSC=!0,t.sort_order="desc"):(t.initSort(),t.sortOrderOfUserASC=!0,t.sort_order="asc"),t.updateReport()},t.sortByDate=function(){t.sort_field="DATE",t.sortOrderOfDateASC?(t.initSort(),t.sortOrderOfDateDSC=!0,t.sort_order="desc"):(t.initSort(),t.sortOrderOfDateASC=!0,t.sort_order="asc"),t.updateReport()},t.sortByAction=function(){t.sort_field="ACTION",t.sortOrderOfActionASC?(t.initSort(),t.sortOrderOfActionDSC=!0,t.sort_order="desc"):(t.initSort(),t.sortOrderOfActionASC=!0,t.sort_order="asc"),t.updateReport()};var v=function(){t.page=1,t.perPage=50},h=function(){var e=[];_.each(t.activeUserList,function(t){e.push({label:t.email,value:t.id})});var r={source:function(t,r){r($.ui.autocomplete.filter(e,d(t.term)))},select:function(e,r){t.user_id=r.item.value;var i=c(this.value);return i.pop(),i.push(r.item.label),i.push(""),this.value=r.item.label,!1},close:function(e,r){var i=c(this.value),o=[];_.each(t.activeUserAutoCompleteObj,function(t){var e=_.find(i,function(e){return e===t.label});e&&o.push(t.value)})},focus:function(t,e){return!1}};t.listUserAutoCompleteOptions=angular.extend({position:{my:"left bottom",at:"left top",collision:"flip"}},r),t.detailsUserAutoCompleteOptions=angular.extend({position:{my:"left bottom",at:"right+20 bottom",collision:"flip"}},r)},m=function(){t.refreshScroller("report-update")};t.clearToDate=function(){t.toDate=""},t.clearFromDate=function(){t.fromDate=""},t.userChanged=function(){""===t.userEmail&&(t.user_id=0)},t.userEmail="";var O=function(){t.pageOptions={id:p,perPage:t.perPage,api:t.updateReport}},S=function(){s(function(){t.$broadcast("updatePagination",p)},100)};t.shouldShowPagination=function(){return t.totalResults>t.perPage},t.init=function(){var a=t.$parent.reservation.reservation_card;t.$emit("HeaderChanged",r("translate")("ACTIVITY_LOG_TITLE")),t.errorMessage="",t.activityLogData=i.results,t.activityLogData.total_count=i.total_count,t.activeUserList=o,t.isUpdateReportFilter=!1,t.reportUpdateVisible=!1,t.reportUpdateWidth=l,tzIndependentDate(a.arrival_date)>tzIndependentDate(e.businessDate)?t.fromDate=e.businessDate:t.fromDate=a.arrival_date,t.toDate=e.businessDate,t.user_id=0,t.totalResults=i.total_count,v(),t.initSort(),f(),e.setPrevState={title:r("translate")("STAY_CARD"),callback:"backToStayCard",scope:t};var n=r("translate")("ACTIVITY_LOG_TITLE");t.setTitle(n),t.setScroller("report-update"),t.setScroller("report_content"),t.resizableOptions={minWidth:l,maxWidth:u,handles:"e",resize:function(t,e){},stop:function(e,r){preventClicking=!0,t.eventTimestamp=e.timeStamp}},t.accordionInitiallyNotCollapsedOptions={header:"a.toggle",heightStyle:"content",collapsible:!0,activate:function(t,e){isEmpty(e.newHeader)&&isEmpty(e.newPanel)?e.oldHeader.removeClass("active"):isEmpty(e.oldHeader)&&e.newHeader.addClass("active"),m()}},h(),O(),S()},t.init()}]);