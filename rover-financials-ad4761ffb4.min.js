"use strict";sntRover.controller("RVFinancialsController",["$scope",function(e){BaseCtrl.call(this,e),e.$on("HeaderChanged",function(t,a){e.$parent.heading=a})}]),sntRover.controller("RVAccountsReceivablesController",["$scope","$rootScope","$stateParams","$filter","rvAccountsArTransactionsSrv","$timeout",function(e,t,a,n,o,i){BaseCtrl.call(this,e),e.$emit("HeaderChanged",n("translate")("MENU_ACCOUNTS_RECEIVABLES")),e.setTitle(n("translate")("MENU_ACCOUNTS_RECEIVABLES")),e.$emit("updateRoverLeftMenu","accountsReceivables"),e.setScroller("arOverViewScroll",{});var r=function(){setTimeout(function(){e.refreshScroller("arOverViewScroll")},500)};r();var s=function(t){e.filterData.page=t||1;var a=function(t){e.arOverviewData={},e.arOverviewData=t,e.filterData.totalCount=t.total_result,i(function(){e.$broadcast("updatePagination","AR_PAGINATION"),e.errorMessage="",e.$emit("hideLoader"),r()},500),""!==e.filterData.searchQuery||""!==e.filterData.minAmount||""!==e.filterData.ageingDays||"ALL"!==e.filterData.showOptions?e.filterData.hideArHeader=!0:e.filterData.hideArHeader=!1},n={query:e.filterData.searchQuery,page:e.filterData.page,per_page:e.filterData.perPage,min_amount:e.filterData.minAmount,ageing_days:e.filterData.ageingDays,sort_by:e.filterData.sortBy,ar_balance_type:e.filterData.showOptions};e.invokeApi(o.fetchAccountsReceivables,n,a)};e.filterData={page:1,perPage:50,totalCount:0,searchQuery:"",minAmount:"",sortBy:"NAME_ASC",ageingDays:"",hideArHeader:!1,showOptions:"ALL",ageingDaysList:[{value:"",name:""},{value:"30",name:"30"},{value:"60",name:"60"},{value:"90",name:"90"},{value:"120",name:"120"}],sortList:[{value:"NAME_ASC",name:"NAME ASC"},{value:"NAME_DESC",name:"NAME DESC"},{value:"AMOUNT_ASC",name:"AMOUNT ASC"},{value:"AMOUNT_DESC",name:"AMOUNT DESC"}],showOptionsList:[{value:"ALL",name:"All"},{value:"ZERO_BALANCE_ONLY",name:"Zero Balance Only"},{value:"OPEN_BALANCE_ONLY",name:"Open Balance Only"}]},e.arPaginationObj={id:"AR_PAGINATION",api:s,perPage:e.filterData.perPage},e.changedSearchQuery=function(){(e.filterData.searchQuery.length>2||""===e.filterData.searchQuery)&&(e.filterData.minAmount="",e.filterData.ageingDays="",s())},e.clearSearchQuery=function(){e.filterData.searchQuery="",s()},e.changedMinAmount=function(){s()},e.changedSortBy=function(){s()},e.changedAgeingDays=function(){s()},e.changedShowOptions=function(){s()},s(),e.escapeNullStr=function(e,t){var a="";"undefined"!=typeof t&&null!==t&&(a=t);var n=null===e||"undefined"==typeof e?a:e;return n.indexOf("null")!==-1&&(n=""),n},e.isShowPagination=function(){var t=e.arOverviewData;return!!t&&t.total_result>=e.filterData.perPage&&t.accounts.length>0}}]),sntRover.controller("RVAutoChargeController",["$scope","$rootScope","$timeout","RVAutoChargeSrv","ngDialog","$filter","RVBillCardSrv","$window","$stateParams","rvUtilSrv",function(e,t,a,n,o,i,r,s,c,l){BaseCtrl.call(this,e);var d=this,u=c.isFromStayCard,m={dateFormat:t.jqDateFormat,changeYear:!0,changeMonth:!0,yearRange:"-10:",maxDate:tzIndependentDate(t.businessDate)},f="EOD_TAB",p="DEPOSIT_TAB",v=function(t,a){var n=new tzIndependentDate(l.get_date_from_date_picker(a));e.filters.due_date=i("date")(tzIndependentDate(n),"dd/MM/yyyy"),e.due_date=t,e.fetchAutoCharge()},h=function(){$("head").append("<style id='print-orientation'>@page { size: portrait; }</style>")},g=function(){$("#print-orientation").remove()},D=function(){a(function(){e.refreshScroller("chargeScroller")},1e3)},y=function(){e.paginationConfig={id:"AUTO_CHARGE",api:e.fetchAutoCharge,perPage:25}},S=function(){e.dueDateOptions=_.extend({onSelect:v},m)},A=function(){var t={preventDefaultException:{tagName:/^(INPUT|LI)$/},preventDefault:!1};e.setScroller("chargeScroller",t)},C=function(){var t=i("translate")("AUTO_CHARGE");e.setTitle(t),e.$parent.heading=t},I=function(){u?(e.filters=n.getStateData().filters,e.due_date=n.getStateData().due_date,e.selectedTab=n.getStateData().selectedTab,e.fetchAutoCharge(e.filters.page_no)):(e.filters={status:"ALL",due_date:i("date")(tzIndependentDate(t.businessDate),"dd/MM/yyyy")},e.due_date=i("date")(tzIndependentDate(t.businessDate),t.dateFormat),e.selectedTab=p,e.fetchAutoCharge())},b=function(e,t){return _.map(e,function(e){return e.bill_balance=e.debits-e.credits,_.extend(e,{isSelected:t})})},E=function(){e.isPartiallySelected=!1,e.isAllSelected=!1},T=function(){var t=[];return _.map(e.autoCharges,function(e){e.isSelected&&t.push({reservation_id:e.reservation_id,amount:e.deposit_paid})}),t};e.handleAutoChargeSelection=function(t){var a=_.filter(e.autoCharges,function(e){return e.is_declined&&e.can_retry_processing});e.isDeclinedAutoChargesPresent=0!==a.length,"ALL"===t?(e.autoCharges=b(e.autoCharges,e.isAllSelected),e.isPartiallySelected=!1):(e.isAllSelected=_.every(a,function(e){return e.isSelected}),e.isPartiallySelected=_.some(a,function(e){return e.isSelected}))},d.printBill=function(){$("header .logo").addClass("logo-hide"),$("header .h2").addClass("text-hide"),h();var e=function(){a(function(){$("header .logo").removeClass("logo-hide"),$("header .h2").addClass("text-hide"),g()},100)};a(function(){sntapp.cordovaLoaded?cordova.exec(e,function(t){e()},"RVCardPlugin","printWebView",["","0","","P"]):(s.print(),e())},100)},e.clickedPrint=function(){e.closeDialog(),d.printBill()},e.selectHeaderTab=function(t){e.selectedTab=t,e.fetchAutoCharge()},e.fetchAutoCharge=function(t){var o={page_no:t||1,status:e.filters.status,due_date:e.filters.due_date,per_page:e.paginationConfig.perPage},i={filters:o,due_date:e.due_date,selectedTab:e.selectedTab};n.setStateData(i);var r={params:o,successCallBack:function(t){E(),e.autoCharges=b(t.details,!1),e.totalCount=t.total_count,t.total_deposit&&(e.totalDeposite=t.total_deposit),e.isAutoChargeProcessing=!!t.auto_charge_deposit_running,a(function(){e.handleAutoChargeSelection(),e.$broadcast("updatePagination","AUTO_CHARGE"),e.$broadcast("updatePageNo",o.page_no),D()},100)}};e.selectedTab!==f?e.callAPI(n.fetchAutoCharge,r):e.callAPI(n.fetchEodAutoCharge,r)},e.processSelectedAutoCharges=function(){var t={due_date:e.filters.due_date,retry_data:T()},o={params:t,successCallBack:function(){a(function(){e.fetchAutoCharge()},3e3)}};e.callAPI(n.processAutoCharges,o)},d.init=function(){e.filters={},A(),y(),S(),C(),I()},d.init()}]),sntRover.controller("RVBudgetDatePickerController",["$scope","$rootScope","$filter",function(e,t,a){var n="",o="";e.data={},"startDate"===e.datePickerFor?(e.data.selectedDate=tzIndependentDate(e.selectedMonth.fromDate),n=tzIndependentDate(e.selectedMonth.fromDateObj),o=tzIndependentDate(e.selectedMonth.toDate)):(e.data.selectedDate=tzIndependentDate(e.selectedMonth.toDate),n=tzIndependentDate(e.selectedMonth.fromDate),o=tzIndependentDate(e.selectedMonth.toDateObj)),e.setUpData=function(){e.dateOptions={minDate:n,maxDate:o,onSelect:function(){"startDate"===e.datePickerFor?(e.selectedMonth.start_date=a("date")(e.data.selectedDate,t.dateFormat),e.selectedMonth.fromDate=tzIndependentDate(e.data.selectedDate)):(e.selectedMonth.end_date=a("date")(e.data.selectedDate,t.dateFormat),e.selectedMonth.toDate=tzIndependentDate(e.data.selectedDate)),e.dateSelected(e.data.selectedDate),e.closeCalendar()}}},e.setUpData()}]);var _extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e};sntRover.controller("RVBudgetsController",["$scope","$rootScope","$timeout","ngDialog","$filter","$window","RVBudgetsSrv",function(e,t,a,n,o,i,r){BaseCtrl.call(this,e);var s=tzIndependentDate(t.businessDate),c=s.getMonth(),l=s.getFullYear(),d=!1,u=!0,m="market_segments",f="budget-header-horizontal",p="budget-content-dual",v="left-vertical-scroll",h="modal-vertical-scroll";e.isYearlyView=!0,e.showNights=!1,e.isRoomRevenueSelected=!0,e.defaultWeekDays=_.map(daysInWeek,function(e,t){return{dayName:e,dayIndex:t,selected:!0}}),e.weekDays=angular.copy(e.defaultWeekDays),e.budgetOption={value:m,selectedYear:l},e.selectedMonth={month:c,startDate:"",endDate:"",monthDays:[]};var g=function(t){var a=e.$parent.myScroll&&e.$parent.myScroll[t];return _.isUndefined(a)&&(a=e.myScroll[t]),a},D=function(){var t={tap:!0,preventDefault:!1,probeType:3,mouseWheel:!0},n=_.extend({scrollX:!0,scrollY:!1},angular.copy(t)),o=_.extend({scrollY:!0,scrollX:!0},angular.copy(t));e.setScroller(f,n),e.setScroller(p,o),e.setScroller(v,t),e.setScroller(h,t);var i=function(){e.$$phase||e.$digest()};a(function(){g(f).on("scroll",function(){var e=this.x,t=g(p);t.scrollTo(e,t.y),Math.abs(this.maxScrollX)-Math.abs(this.x)<=150?d||(d=!0,i()):d&&(d=!1,i())}),g(v).on("scroll",function(){var e=this.y,t=g(p);t.scrollTo(t.x,e)}),g(p).on("scroll",function(){var e=this.x,t=this.y;g(f).scrollTo(e,0),g(v).scrollTo(0,t),Math.abs(this.maxScrollX)-Math.abs(this.x)<=150?d||(d=!0,i()):d&&(d=!1,i())})},1e3)};D();var y=function(){e.refreshScroller(f),e.refreshScroller(p),e.refreshScroller(v);var t=e.getScroller(f),a=e.getScroller(p);t.scrollTo(0,0,0),a.scrollTo(0,0,0)},S=function(){var t={year:e.budgetOption.selectedYear,budget_for:e.budgetOption.value},a=function(t){u&&(e.isYearlyView=!0),e.budgetData=t,A(),C(),e.gridContentData=I(e.isMarketView()?e.marketSegmentGridData:e.chargeCodeGridData),b(e.selectedMonth.month),e.leftDataList=angular.copy(e.leftColumnData)};e.invokeApi(r.getBudgetData,t,a)},A=function(){e.marketSegmentGridData=[],e.chargeCodeGridData=[],_.each(e.marketSegments,function(t){e.marketSegmentGridData.push({id:t.id,budgets:[],months:[],dates:[]})}),_.each(e.chargeCodes,function(t){e.chargeCodeGridData.push({id:t.id,budgets:[],months:[],dates:[]})})},C=function(){e.monthOptions=[],e.yearOptions=[];for(var t=l-2,a=l+2,n=0,o=11,i=t;i<=a;i++)e.yearOptions.push(i);for(var r=n;r<=o;r++)e.monthOptions.push({monthIndex:r,monthName:getMonthName(r),selected:!0});_.each(e.monthOptions,function(t){for(var a=new Date(e.budgetOption.selectedYear,t.monthIndex,1),n=[];a.getMonth()===t.monthIndex;)n.push(new Date(a)),a.setDate(a.getDate()+1);t.monthDays=n})},I=function(t){var a=e.isMarketView()?"market_segment_id":"charge_code_id",n=e.isMarketView()?e.marketSegments:e.chargeCodes;return _.each(n,function(n){_.each(e.budgetData,function(e){n.id===e[a]&&_.each(t,function(t){t.id===n.id&&t.budgets.push(e)})})}),_.each(t,function(t){_.each(e.monthOptions,function(a){var n,o=0,i=0,r=!1;_.each(t.budgets,function(e){var t=getMonthName(tzIndependentDate(e.date).getMonth());a.monthName===t&&(r=!0,o+=e.revenue,i+=e.room_nights)}),n=_.find(e.leftColumnData,function(e){return e.id===t.id}),t.months.push({monthIndex:a.monthIndex,monthName:a.monthName,budgetData:{totalRevenue:o.toFixed(2),totalNights:i.toFixed(2)},isPastMonth:e.isPastMonth(a.monthIndex),itemId:t.id,itemName:n.name,isBudgetCreated:r})})}),t};e.onChangeBudgetOption=function(){u=!0,e.leftColumnData=e.isMarketView()?e.marketSegments:e.chargeCodes,S()},e.onChangeShowNights=function(){e.showNights=!e.showNights,a(function(){y()},100)},e.openAddBudgetModal=function(){if(e.selectedMonth.fromDate=o("date")(tzIndependentDate(e.selectedMonth.startDate,t.dateFormat)),e.selectedMonth.month===c){var a=new Date(e.budgetOption.selectedYear,e.selectedMonth.month,s.getDate()+1);e.selectedMonth.fromDate=o("date")(tzIndependentDate(a,t.dateFormat))}e.selectedMonth.toDate=o("date")(tzIndependentDate(e.selectedMonth.endDate,t.dateFormat)),e.selectedMonth.fromDateObj=tzIndependentDate(e.selectedMonth.fromDate),e.selectedMonth.toDateObj=tzIndependentDate(e.selectedMonth.toDate),e.selectedMonth.fromDate=e.selectedMonth.fromDateObj,e.selectedMonth.toDate=e.selectedMonth.toDateObj,e.selectedMonth.start_date=o("date")(e.selectedMonth.fromDate,t.dateFormat),e.selectedMonth.end_date=o("date")(e.selectedMonth.toDate,t.dateFormat),O(),N(e.selectedMonth.fromDate,e.selectedMonth.toDate),n.open({template:"/assets/partials/financials/budgets/rvAddBudgetModal.html",controller:"",className:"",scope:e})},e.openUpdateModal=function(t){O(),e.selectedCellData=t;var a=e.isYearlyView?!e.isPastMonth(t.monthIndex):!e.isPastDate(t.date);a&&n.open({template:"/assets/partials/financials/budgets/rvUpdateBudgetModal.html",controller:"",className:"",scope:e})},e.onChangeYear=function(){u=!0,C(),S()},e.isMarketView=function(){return e.budgetOption.value===m},e.switchBudgetType=function(t){(e.isRoomRevenueSelected&&!t||!e.isRoomRevenueSelected&&t)&&(e.isRoomRevenueSelected=!e.isRoomRevenueSelected)};var b=function(t){e.monthGridData=[],e.dayGridData=[],_.each(e.gridContentData,function(a){a.dates=[],_.each(e.monthOptions,function(n){t===n.monthIndex&&_.each(n.monthDays,function(t){var n=_.filter(a.budgets,function(e){return tzIndependentDate(e.date).getTime()===tzIndependentDate(t).getTime()}),o=_.find(e.leftColumnData,function(e){return e.id===a.id}),i={date:tzIndependentDate(t),isPastDate:e.isPastDate(tzIndependentDate(t)),itemId:o.id,itemName:o.name,isWeekEnd:isWeekendDay(e.weekEndDays,tzIndependentDate(t))};i=0!==n.length?_extends({},i,{budget:{revenue:n[0].revenue.toFixed(2),room_nights:n[0].room_nights.toFixed(2),budget_id:n[0].id},isBudgetCreated:!0}):e.isMarketView()?_extends({},i,{budget:{revenue:0,room_nights:0,market_segment_id:a.id},isBudgetCreated:!1}):_extends({},i,{budget:{revenue:0,room_nights:0,charge_code_id:a.id},isBudgetCreated:!1}),a.dates.push(i)})})}),_.each(e.gridContentData,function(t){e.monthGridData.push({id:t.id,months:t.months}),e.dayGridData.push({id:t.id,dates:t.dates})}),a(function(){y()},100)};e.onSelectMonth=function(t){e.isYearlyView=!1,e.selectedMonth.month=t,_.each(e.monthOptions,function(a){a.monthIndex===t&&(e.selectedMonth.startDate=a.monthDays[0],e.selectedMonth.monthDays=a.monthDays,e.selectedMonth.endDate=a.monthDays[a.monthDays.length-1])}),b(e.selectedMonth.month),a(function(){y()},100)},e.getDayName=function(e){return daysInWeek[e.getDay()]},e.monthName=function(e){return getMonthName(e)},e.backToYearlyView=function(){e.isYearlyView=!0,a(function(){y()},100)};var E;e.clickedOnDatePicker=function(t){e.datePickerFor=t,E=n.open({template:"/assets/partials/common/rvDatePicker.html",controller:"RVBudgetDatePickerController",className:"",scope:e,closeByDocument:!0})},e.dateSelected=function(t){"startDate"===e.datePickerFor?e.selectedMonth.fromDate=tzIndependentDate(t):e.selectedMonth.toDate=tzIndependentDate(t),N(e.selectedMonth.fromDate,e.selectedMonth.toDate)},e.closeModal=function(){n.close()},e.closeCalendar=function(){E.close()},e.isPastMonth=function(t){var a=new Date(e.budgetOption.selectedYear,t,1),n=new Date(l,c,1);return a<n},e.isPastDate=function(e){var t=new Date(s.getFullYear(),s.getMonth(),s.getDate()),a=new Date(e.getFullYear(),e.getMonth(),e.getDate());return a<=t},e.isPastWeekday=function(t){var a=!0;return _.each(e.selectedMonth.monthDays,function(n){e.isPastDate(n)||t.dayIndex===n.getDay()&&(a=!1)}),a};var T=function(e){return e<l};e.saveBudgetAndReset=function(){var a,n=[],i=[];if(_.each(e.leftColumnData,function(e){e.selected&&n.push(e.id.toString())}),a={budget_for:e.budgetOption.value,market_segment_ids:n,revenue:e.roomBudget.revenue,room_nights:e.roomBudget.nights},e.isYearlyView)_.each(e.monthOptions,function(a){if(a.selected&&!e.isPastMonth(a.monthIndex)){var n=new Date(e.budgetOption.selectedYear,a.monthIndex,1);i.push(o("date")(n,t.dateFormatForAPI))}}),a.date_format="months",a.months=i,u=!0;else{var s=[];_.each(e.weekDays,function(e){e.selected&&s.push(e.dayIndex)}),a=_extends({},a,{date_format:"range",weekdays:s,from_date:o("date")(tzIndependentDate(e.selectedMonth.fromDate),t.dateFormatForAPI),to_date:o("date")(tzIndependentDate(e.selectedMonth.toDate),t.dateFormatForAPI)}),u=!1}var c=function(){n=[],O(),S()};e.invokeApi(r.saveBudget,a,c)},e.saveBudgetAndCloseModal=function(){e.saveBudgetAndReset(),a(function(){e.closeModal()},200)};var R=function(t,a){return e.isRoomRevenueSelected?!_.isNull(t):!_.isNull(a)};e.shouldDisableAddBudgetButton=function(){return e.isYearlyView?T(e.budgetOption.selectedYear):e.isPastMonth(e.selectedMonth.month)},e.disableSaveButtons=function(){var t=!1,a=!1;return _.each(e.leftColumnData,function(e){e.selected&&(t=!0)}),e.isYearlyView?_.each(e.monthOptions,function(t){!e.isPastMonth(t.monthIndex)&&t.selected&&(a=!0)}):_.each(e.weekDays,function(t){!e.isPastWeekday(t)&&t.selected&&(a=!0)}),!t||!a||!R(e.roomBudget.revenue,e.roomBudget.nights)},e.disableUpdateButtons=function(){return!R(e.roomBudget.updateRevenue,e.roomBudget.updateNights)},e.updateBudget=function(){var a=function(){O(),S(),e.closeModal()},n={budget_for:e.budgetOption.value,revenue:e.roomBudget.updateRevenue,room_nights:e.roomBudget.updateNights};if(e.isYearlyView){var i=[],s=[],c=new Date(e.budgetOption.selectedYear,e.selectedCellData.monthIndex,1);i.push(o("date")(c,t.dateFormatForAPI)),n.months=angular.copy(i),n.date_format="months",e.isMarketView()?(s.push(e.selectedCellData.itemId),n.market_segment_ids=angular.copy(s)):(s.push(e.selectedCellData.itemId),n.charge_code_ids=angular.copy(s)),u=!0,e.invokeApi(r.saveBudget,n,a)}else n.budget_id=e.selectedCellData.isBudgetCreated?e.selectedCellData.budget.budget_id:"",n.date=o("date")(e.selectedCellData.date,t.dateFormatForAPI),e.isMarketView()?n.market_segment_id=e.selectedCellData.itemId:n.charge_code_id=e.selectedCellData.itemId,u=!1,e.invokeApi(r.updateBudget,n,a)};var N=function(t,a){t=tzIndependentDate(t),a=tzIndependentDate(a);var n,o=(moment(a)-moment(t))/864e5;if(o<=6){e.weekDaysCopy=[],n=t.getDay();for(var i=0;i<=o;i++)n<7?e.weekDaysCopy.push({dayIndex:n,dayName:daysInWeek[n],selected:!0}):e.weekDaysCopy.push({dayIndex:n-7,dayName:daysInWeek[n-7],selected:!0}),n++;e.weekDays=angular.copy(e.weekDaysCopy)}else e.weekDays=angular.copy(e.defaultWeekDays)},O=function(){e.roomBudget={revenue:null,nights:null,updateRevenue:null,updateNights:null},e.roomNights=0,e.isRoomRevenueSelected=!0,_.each(e.leftColumnData,function(e){e.selected=!1})},P=function(){var t=function(t){e.marketSegments=t.market_segment,e.chargeCodes=t.charge_codes,e.leftColumnData=t.market_segment,e.weekEndDays=t.weekend_days,S()};e.invokeApi(r.getBudgetAssociatedTypes,{},t)};P()}]),sntRover.controller("RVccAuthorizationController",["$scope","$filter","$stateParams","ngDialog","$rootScope","RVccTransactionsSrv","$timeout","$state",function(e,t,a,n,o,i,r,s){BaseCtrl.call(this,e),e.setScroller("authorization-scroll",{});var c=function(){var t=function(t){e.data.authData=t,l()},a={successCallBack:t};e.callAPI(i.fetchAuthData,a)},l=function(){setTimeout(function(){e.refreshScroller("authorization-scroll")},500)};a.isRefresh||e.previousState&&"rover.reservation.staycard.reservationcard.reservationdetails"!==e.previousState.name?c():l(),e.$on("mainTabSwiched",function(){1===e.data.activeTab&&l()}),e.clickedApprovedTab=function(){return!isEmptyObject(e.data.authData.approved)&&(e.data.authData.approved.active=!e.data.authData.approved.active,void l())},e.clickedDeclinedTab=function(){return!isEmptyObject(e.data.authData.declined)&&(e.data.authData.declined.active=!e.data.authData.declined.active,void l())},e.clickedReversalsTab=function(){return!isEmptyObject(e.data.authData.reversals)&&(e.data.authData.reversals.active=!e.data.authData.reversals.active,void l())},e.clickedApprovedTransactionItem=function(e){return 0!==e.cc_transactions.length&&(e.active=!e.active,void l())},e.clickedDeclinedTransactionItem=function(e){return 0!==e.cc_transactions.length&&(e.active=!e.active,void l())},e.clickedReversalTransactionItem=function(e){return 0!==e.cc_transactions.length&&(e.active=!e.active,void l())},e.gotoStayCard=function(t,a){i.updateCache(e.data),s.go("rover.reservation.staycard.reservationcard.reservationdetails",{id:t,confirmationId:a,isrefresh:!0})}}]),sntRover.controller("RVccPaymentsController",["$scope","$filter","$stateParams","ngDialog","$rootScope","RVccTransactionsSrv","$timeout","$state",function(e,t,a,n,o,i,r,s){BaseCtrl.call(this,e),o.manualCCEnabled="SHIJI"===o.hotelDetails.payment_gateway&&o.hotelDetails.shiji_token_enable_offline,e.setScroller("payment_content",{});var c=function(){setTimeout(function(){e.refreshScroller("payment_content")},500)};c();var l=function(){var t=function(t){e.data.paymentData={},e.data.paymentData=t,e.errorMessage="",e.$emit("hideLoader"),c()};e.invokeApi(i.fetchPayments,{date:e.data.transactionDate},t)};a.isRefresh||e.previousState&&"rover.reservation.staycard.reservationcard.reservationdetails"!==e.previousState.name?l():c(),e.$on("transactionDateChanged",function(){l()}),e.$on("showErrorMessage",function(t,a){e.errorMessage=a}),e.clickedApprovedTab=function(){return!isEmptyObject(e.data.paymentData.approved)&&(e.data.paymentData.approved.active=!e.data.paymentData.approved.active,void c())},e.clickedDeclinedTab=function(){return!isEmptyObject(e.data.paymentData.declined)&&(e.data.paymentData.declined.active=!e.data.paymentData.declined.active,void c())},e.clickedApprovedTransactionItem=function(e){return 0!==e.cc_transactions.length&&(e.active=!e.active,void c())},e.clickedDeclinedTransactionItem=function(e){return 0!==e.cc_transactions.length&&(e.active=!e.active,void c())},e.$on("mainTabSwiched",function(){0===e.data.activeTab&&c()}),e.gotoStayCard=function(t,a){i.updateCache(e.data),s.go("rover.reservation.staycard.reservationcard.reservationdetails",{id:t,confirmationId:a,isrefresh:!0})}}]),sntRover.controller("RVCcPrintTransactionsController",["$scope","$rootScope","$timeout",function(e,t,a){BaseCtrl.call(this,e);var n=0,o=90;e.eventTimestamp="",e.data.printBoxHeight=n;var i=function(t){t>5?(e.data.isDrawerOpened=!0,e.data.printBoxHeight=t,e.$apply()):t<5&&e.closeDrawer()};e.resizableOptions={minHeight:n,maxHeight:o,handles:"s",resize:function(e,t){var a=$(this).height();i(a)},stop:function(t,a){var n=$(this).height();preventClicking=!0,e.eventTimestamp=t.timeStamp,i(n)}},e.clickedDrawer=function(t){if(t.stopPropagation(),t.stopImmediatePropagation(),getParentWithSelector(t,document.getElementsByClassName("ui-resizable-handle")[0])){if(parseInt(e.eventTimestamp)&&t.timeStamp-e.eventTimestamp<2)return;e.data.printBoxHeight===n||e.data.printBoxHeight===o?e.data.isDrawerOpened?e.closeDrawer():e.openDrawer():e.closeDrawer()}},e.openDrawer=function(){e.data.printBoxHeight=o,e.data.isDrawerOpened=!0},e.closeDrawer=function(){e.data.printBoxHeight=n,e.data.isDrawerOpened=!1},e.$on("CLOSEPRINTBOX",function(){e.closeDrawer()});var r="L",s=function(){var t="portrait";switch(e.data.activeTab){case 0:t="landscape",r="L";break;case 1:t="landscape",r="L";break;default:t="portrait",r="P"}$("head").append("<style id='print-orientation'>@page { size: "+t+"; }</style>")},c=function(){$("#print-orientation").remove()};e.printButtonClick=function(){s(),a(function(){sntapp.cordovaLoaded?cordova.exec(c,function(e){c()},"RVCardPlugin","printWebView",["","","",r]):(window.print(),c())},100)}}]),sntRover.controller("RVccTransactionsController",["$scope","$filter","$stateParams","ngDialog","$rootScope","RVccTransactionsSrv","$timeout","$window","rvPermissionSrv",function(e,t,a,n,o,i,r,s,c){BaseCtrl.call(this,e),e.$emit("HeaderChanged",t("translate")("MENU_CC_TRANSACTIONS")),e.setTitle(t("translate")("MENU_CC_TRANSACTIONS")),e.$emit("updateRoverLeftMenu","ccTransactions");var l=function(){e.data={},e.data.activeTab=0,e.data.transactionDate=o.businessDate,e.data.paymentData={},e.data.authData={}};e.clickedTransactionDate=function(){e.popupCalendar("TRANSACTIONS")},e.clickedSubmitBatch=function(){var t=function(t){e.$broadcast("showErrorMessage",""),e.$emit("hideLoader")},a=function(t){e.$broadcast("showErrorMessage",t),e.$emit("hideLoader")};e.invokeApi(i.submitBatch,{},t,a)},e.popupCalendar=function(t){e.clickedOn=t,n.open({template:"/assets/partials/financials/journal/rvJournalCalendarPopup.html",controller:"RVJournalDatePickerController",className:"single-date-picker",scope:e})},e.activatedTab=function(t){e.data.activeTab=t,e.$broadcast("mainTabSwiched"),e.$broadcast("CLOSEPRINTBOX")},e.clickedOnTransactionContents=function(){e.$broadcast("CLOSEPRINTBOX")},e.hasAnyElements=function(e){var t=!0;return isEmptyObject(e)&&(t=!1),t},e.hasPermissionToSubmitCCBatch=function(){return c.getPermissionValue("SUBMIT_CC_BATCH")},a.isRefresh?l():e.data=i.getCache()}]),sntRover.controller("RVCommisionsHeaderCtrl",["$scope","ngDialog","$log","$timeout","RVCommissionsSrv","$filter",function(e,t,a,n,o,i){BaseCtrl.call(this,e);var r=function(t){return t.selected_tas=[],_.each(e.selectedAgentIds,function(e){t.selected_tas.push(e)}),t},s=function(t){return t.un_selected_tas=[],_.each(e.commissionsData.accounts,function(e){e.isSelected||t.un_selected_tas.push(e.id)}),t},c=function(){var t={};return e.areAllAgentsSelected()?t.update_all_tas=!0:(t=e.noOfTASelected<=e.filterData.perPage?r(t):s(t),t.partially_selected_tas=[],t.selected_reservations_ids=[],_.each(e.commissionsData.accounts,function(e){e.isExpanded&&e.selectedReservations.length&&e.selectedReservations.length!==e.reservationsData.total_count&&(t.partially_selected_tas.push(e.id),t.selected_reservations_ids=t.selected_reservations_ids.concat(e.selectedReservations))})),t.begin_date=""!==e.dateData.fromDateForAPI?i("date")(e.dateData.fromDateForAPI,"yyyy-MM-dd"):"",t.end_date=""!==e.dateData.toDateForAPI?i("date")(e.dateData.toDateForAPI,"yyyy-MM-dd"):"",t},l=function(t,a,n){e.exportSuccess=n,e.exportFailed=a,e.exportInProgess=t};e.isValidEmail=function(){return/^([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/.test(e.filterData.receipientEmail)},e.exportCommisions=function(){var a={min_commission_amount:e.filterData.minAmount,query:e.filterData.searchQuery,sort_by:e.filterData.sort_by.value,receipient_email:e.filterData.receipientEmail,begin_date:""!==e.dateData.fromDateForAPI?i("date")(e.dateData.fromDateForAPI,"yyyy-MM-dd"):"",end_date:""!==e.dateData.toDateForAPI?i("date")(e.dateData.toDateForAPI,"yyyy-MM-dd"):"",include_non_commissionable:e.filterData.non_commissionable,email_report:e.filterData.email_report,travel_agent_ids:_.pluck(e.commissionsData.accounts,"id")},r={params:a,loader:"NONE",successCallBack:function(){n(function(){l(!1,!1,!0),t.close()},4e3)},failureCallBack:function(){l(!1,!0,!1)}};l(!0,!1,!1),"standard"===e.filterData.selectedExportType?e.callAPI(o.exportCommissions,r):"onyx"===e.filterData.selectedExportType?e.callAPI(o.onyxExportCommissions,r):n(function(){l(!1,!1,!0),t.close()},4e3)},e.showExportPopup=function(){e.filterData.receipientEmail="","onyx"===e.filterData.exportType&&(e.filterData.selectedExportType="onyx"),l(!1,!1,!1),t.open({template:"/assets/partials/financials/commissions/rvCommissionsExport.html",className:"",scope:e})},e.popupBtnAction=function(a){var n=c();n.action_type=a;var i=function(){t.close(),e.fetchAgentsData()};e.invokeApi(o.updateCommissionPaidStatus,n,i)};var d=function(a){t.open({template:"/assets/partials/financials/commissions/"+a+".html",className:"",scope:e})};e.openPopupWithTemplate=function(e){d(e)}}]),sntRover.controller("RVCommissionsSummaryController",["$scope","$rootScope","$stateParams","$filter","RVCommissionsSrv","$timeout","$window","$state","businessDate","rvUtilSrv","sntActivity",function(e,t,a,n,o,i,r,s,c,l,d){BaseCtrl.call(this,e),e.filterData=o.filterData;var u=function(){e.$$phase||e.$digest()},m=function(){var t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],a=t?n("translate")("COMMISSIONS_REPORT_TITLE"):n("translate")("MENU_COMMISIONS");e.$emit("HeaderChanged",a),e.setTitle(a),e.$emit("updateRoverLeftMenu","commisions")},f=function(){i(function(){e.refreshScroller("commissionOverViewScroll")},500)},p=function(){var t=0,a=0;if(_.each(e.commissionsData.accounts,function(e){a+=parseFloat(e.commission_amount),e.isSelected?t+=parseFloat(e.commission_amount):e.reservationsData&&e.reservationsData.reservations&&_.each(e.reservationsData.reservations,function(e){e.isSelected&&(t+=parseFloat(e.commission_amount))})}),"PAID"===e.filterData.filterTab)e.commissionsData.selectedBillsAmount=e.commissionsData.amount_totals.paid;else if(e.allCommisionsSelected){var n;n="ON_HOLD"===e.filterData.filterTab?e.commissionsData.amount_totals.on_hold:"PAYABLE"===e.filterData.filterTab?e.commissionsData.amount_totals.unpaid:e.commissionsData.amount_totals.paid,e.commissionsData.selectedBillsAmount=parseFloat(n)-a+t}else e.commissionsData.selectedBillsAmount=t};e.resetSelections=function(){e.noOfTASelected=0,e.noOfBillsSelected=0,e.noOfTAInOtherPagesSelected=0,e.allCommisionsSelected=!1,e.selectedAgentIds=[],e.commissionsData.selectedBillsAmount=0,_.each(e.commissionsData.accounts,function(e){e.isSelected=!1,e.isSemiSelected=!1,e.isExpanded=!1,e.isSemiSelected=!1,e.reservationsData={},e.selectedReservations=[]})},e.expandCommision=function(e){e.reservationsData={},e.selectedReservations=[],e.isExpanded?(e.isExpanded=!1,e.isSemiSelected=!1):e.fetchReservationData(),p()},e.areAllAgentsSelected=function(){return e.commissionsData.total_count>0&&e.commissionsData.total_count===e.noOfTASelected},e.areAgentsPartialySelected=function(){return e.noOfTASelected>0&&e.commissionsData.total_count!==e.noOfTASelected},e.areAnyReservationsPartialySelected=function(){if(e.commissionsData.accounts){var t=!1;return _.each(e.commissionsData.accounts,function(e){e.isExpanded&&e.selectedReservations.length&&(t=!0)}),t}return!1};var v=function(t){var a=e.selectedAgentIds.indexOf(t.id);a!==-1&&e.selectedAgentIds.splice(a,1)},h=function(e,t,a){e.isSelected=t,e.isSemiSelected=a},g=function(t,a){var n=t.selectedReservations.indexOf(a.id);t.isSelected&&(e.noOfBillsSelected=e.noOfBillsSelected-t.number_of_bills+t.selectedReservations.length),a.isSelected&&n===-1?(t.selectedReservations.push(a.id),e.noOfBillsSelected=e.noOfBillsSelected+1):a.isSelected||n===-1||(t.selectedReservations.splice(n,1),e.noOfBillsSelected=e.noOfBillsSelected-1,t.isSelected&&e.noOfTASelected--,t.selectedReservations.length>0&&(t.isSemiSelected=!0),t.isSelected=!1)};e.reservationSelectionChanged=function(t,a){if(g(t,a),0===t.selectedReservations.length)h(t,!1,!1),v(t);else if(t.selectedReservations.length!==t.reservationsData.total_count)h(t,!1,!0),v(t);else{if(t.selectedReservations.length!==t.reservationsData.total_count)return;h(t,!0,!1),e.selectedAgentIds.indexOf(t.id)===-1&&e.selectedAgentIds.push(t.id),e.noOfTASelected++}p()};var D=function(e){e.isSelected?_.each(e.reservationsData.reservations,function(t){t.isSelected=!0;var a=e.selectedReservations.indexOf(t.id);t.isSelected&&a===-1?e.selectedReservations.push(t.id):t.isSelected||a===-1||e.selectedReservations.slice(a,1)}):(_.each(e.reservationsData.reservations,function(e){e.isSelected=!1}),e.selectedReservations=[])};e.commisionSelectionChanged=function(t){t.isSemiSelected=!1,e.selectedAgentIds=[],t.isSelected?(e.noOfTASelected++,e.noOfBillsSelected=e.noOfBillsSelected-t.selectedReservations.length+t.number_of_bills):e.noOfTASelected>0?(e.noOfTASelected--,e.noOfBillsSelected=e.noOfBillsSelected-t.number_of_bills):(e.noOfTASelected=0,e.noOfBillsSelected=e.noOfBillsSelected-t.number_of_bills),_.each(e.commissionsData.accounts,function(t){t.isSelected&&e.selectedAgentIds.push(t.id)}),t.isExpanded&&D(t),p()},e.allCommisionsSelectionChanged=function(){e.selectedAgentIds=[],_.each(e.commissionsData.accounts,function(t){t.isSelected=e.allCommisionsSelected,t.isExpanded=!1,t.reservationsData={},t.selectedReservations=[],t.isSemiSelected=!1,t.isSelected&&e.selectedAgentIds.push(t.id)}),e.allCommisionsSelected?(e.noOfTASelected=e.commissionsData.total_count,e.noOfTAInOtherPagesSelected=e.commissionsData.total_count-e.commissionsData.accounts.length,e.noOfBillsSelected="ON_HOLD"===e.filterData.filterTab?e.commissionsData.bill_count_totals.on_hold:e.commissionsData.bill_count_totals.open):(e.noOfTASelected=0,e.noOfTAInOtherPagesSelected=0,e.noOfBillsSelected=0),p()},e.setFilterTab=function(t){e.commissionsData={},"ON_HOLD"===t?e.filterData.billStatus.value="ON_HOLD":"PAYABLE"===t?e.filterData.billStatus.value="UN_PAID":e.filterData.billStatus.value="PAID",e.fetchAgentsData(),e.filterData.filterTab=t;
};var y=function(t,a){t.isExpanded=!0,t.reservationsData=a,_.each(t.reservationsData.reservations,function(e){var a=t.selectedReservations.indexOf(e.id);e.isSelected=t.isSelected,e.isSelected&&a===-1&&t.selectedReservations.push(e.id)}),t.reservationsPageNo=1,t.showResPagination=t.reservationsData.total_count>e.filterData.innerPerPage,i(function(){e.$broadcast("updatePagination","RESERVATION_LIST_"+t.id)},100),f()},S=function(){_.each(e.commissionsData.accounts,function(t){t.isExpanded=!1,t.fetchReservationData=function(a){var i=a?a:1,r=function(e){t.selectedReservations=[],t.isSemiSelected=!1,y(t,e)};e.callAPI(o.fetchReservationOfCommissions,{params:{id:t.id,page:i,per_page:e.filterData.innerPerPage,action_type:e.filterData.filterTab,begin_date:""!==e.dateData.fromDateForAPI?n("date")(e.dateData.fromDateForAPI,"yyyy-MM-dd"):"",end_date:""!==e.dateData.toDateForAPI?n("date")(e.dateData.toDateForAPI,"yyyy-MM-dd"):"",include_non_commissionable:e.filterData.non_commissionable},successCallBack:r,failureCallBack:function(t){e.errorMessage=t}})},t.paginationData={id:"RESERVATION_LIST_"+t.id,api:t.fetchReservationData,perPage:e.filterData.innerPerPage}})},A=function(){return{query:e.filterData.searchQuery,page:e.filterData.page,per_page:e.filterData.perPage,bill_status:e.filterData.billStatus.value,sort_by:e.filterData.sort_by.value,min_commission_amount:e.filterData.minAmount,begin_date:""!==e.dateData.fromDateForAPI?n("date")(e.dateData.fromDateForAPI,"yyyy-MM-dd"):"",end_date:""!==e.dateData.toDateForAPI?n("date")(e.dateData.toDateForAPI,"yyyy-MM-dd"):"",include_non_commissionable:e.filterData.non_commissionable}};e.fetchAgentsData=function(t){e.filterData.page=t?t:1;var a=function(t){e.commissionsData=t,S(),e.resetSelections(),e.showPagination=!(e.commissionsData.total_count<=e.filterData.perPage),e.errorMessage="",e.$emit("hideLoader"),f(),i(function(){e.$broadcast("updatePagination","TA_LIST")},100),e.initialLoading=!1,e.sideFilterData.openSideFilter=!1,p(),e.filterData.noCommissionsMsg=C()};e.callAPI(o.fetchCommissions,{params:A(),successCallBack:a,failureCallBack:function(t){e.errorMessage=t}})};var C=function(){var t="";return t="PAYABLE"===e.filterData.filterTab?"There are no Travel Agents with Payable commission records":"ON_HOLD"===e.filterData.filterTab?"There are no Travel Agents with On Hold commission records":"There are no Travel Agents with Paid commission records",t+=e.filterData.searchQuery?" that match your search.":"."};e.clearSearchQuery=function(){e.filterData.searchQuery="",e.fetchAgentsData()},e.openSideFilters=function(){e.sideFilterData.minAmount=angular.copy(e.filterData.minAmount),e.sideFilterData.sort_by.value=angular.copy(e.filterData.sort_by.value),e.sideFilterData.non_commissionable=angular.copy(e.filterData.non_commissionable),e.sideFilterData.openSideFilter=!e.sideFilterData.openSideFilter},e.returnNumberOfFilterApplied=function(){var t=0;return e.filterData.minAmount.length&&t++,e.filterData.sort_by.value.length&&t++,e.filterData.non_commissionable&&t++,t},e.applyFilter=function(){e.filterData.minAmount=angular.copy(e.sideFilterData.minAmount),e.filterData.sort_by.value=angular.copy(e.sideFilterData.sort_by.value),e.filterData.non_commissionable=angular.copy(e.sideFilterData.non_commissionable),e.fetchAgentsData()},e.printButtonClick=function(){var t=function(){i(function(){n()},100)},a=function(){$("head").append("<style id='print-orientation'>@page { size: landscape; }</style>")},n=function(){$("#print-orientation").remove()},s=function(n){e.printData=n,e.$emit("hideLoader"),m(!0),i(function(){a(),sntapp.cordovaLoaded?cordova.exec(t,function(e){t()},"RVCardPlugin","printWebView",["","0","","L"]):(r.print(),t()),m()},500)},c=A();c.travel_agent_ids=_.pluck(e.commissionsData.accounts,"id"),e.callAPI(o.printCommissionOverview,{params:c,successCallBack:s,failureCallBack:function(t){e.errorMessage=t}})},e.navigateToTA=function(t){d.start("NAVIGATING_TO_TA_COMMISSIONS"),s.go("rover.companycarddetails",{id:t.id,fromDate:""!==e.dateData.fromDateForAPI?n("date")(e.dateData.fromDateForAPI,"yyyy-MM-dd"):"",toDate:""!==e.dateData.toDateForAPI?n("date")(e.dateData.toDateForAPI,"yyyy-MM-dd"):"",type:"TRAVELAGENT",origin:"COMMISION_SUMMARY"})};var I=function(){var t={params:{},successCallBack:function(t){e.filterData.exportType=t.export_type,e.filterData.non_commissionable=angular.copy("onyx"===t.export_type),e.sideFilterData.non_commissionable=angular.copy("onyx"===t.export_type),e.fetchAgentsData()},failureCallBack:function(){e.filterData.exportType=""}};e.callAPI(o.fetchExportTypeData,t)};e.dateData={};var b=new Date(tzIndependentDate(c.business_date));b.setDate(b.getDate()-7),e.fromDate=n("date")(b,t.dateFormat),e.dateData.fromDateForAPI=n("date")(b,"yyyy-MM-dd");var E=new Date(tzIndependentDate(c.business_date));E.setDate(E.getDate()-1),e.toDate=n("date")(E,t.dateFormat),e.dateData.toDateForAPI=n("date")(E,"yyyy-MM-dd");var T=function(t,a){e.fromDate=t,e.dateData.fromDateForAPI=tzIndependentDate(l.get_date_from_date_picker(a)),u(),e.fetchAgentsData()},R=function(t,a){e.toDate=t,e.dateData.toDateForAPI=tzIndependentDate(l.get_date_from_date_picker(a)),u(),e.fetchAgentsData()};e.clearFromDate=function(){e.fromDate="",e.dateData.fromDateForAPI="",$("#commisions-date-from").val(""),u(),e.fetchAgentsData()},e.clearToDate=function(){e.toDate="",e.dateData.toDateForAPI="",$("#commisions-date-to").val(""),u(),e.fetchAgentsData()};var N={showOn:"button",dateFormat:t.jqDateFormat,changeYear:!0,changeMonth:!0,yearRange:"-5:+5"};e.fromDateOptions=_.extend({onSelect:T},N),e.toDateOptions=_.extend({onSelect:R},N),function(){m(),e.errorMessage="",e.commissionsData={},e.filterData.filterTab="PAYABLE",e.filterData.billStatus.value="UN_PAID",e.sideFilterData={openSideFilter:!1,minAmount:"",sort_by:{value:"NAME_ASC",name:"NAME_ASC"},non_commissionable:!1},e.filterData.non_commissionable=e.sideFilterData.non_commissionable,e.filterData.minAmount="",e.filterData.searchQuery="",e.filterData.selectedExportType="standard",e.filterData.receipientEmail="",e.filterData.noCommissionsMsg="",I(),e.noOfTASelected=0,e.noOfTAInOtherPagesSelected=0,e.allCommisionsSelected=!1,e.selectedAgentIds=[],e.pageNo=1,e.noOfBillsSelected=0,e.paginationData={id:"TA_LIST",api:e.fetchAgentsData,perPage:e.filterData.perPage},e.setScroller("commissionOverViewScroll",{}),e.initialLoading=!0}()}]),sntRover.controller("RVCurrencyExchangeModalController",["$scope","$rootScope","$filter","$timeout","rvUtilSrv","ngDialog","RVMultiCurrencyExchangeSrv","rvPermissionSrv",function(e,t,a,n,o,i,r,s){BaseCtrl.call(this,e),e.exchangeRatesData=[],e.exchangeCurrencyList=t.exchangeCurrencyList,e.selected_rate_currency=_.first(e.exchangeCurrencyList).id,e.selected_rate_currency_symbol=_.first(e.exchangeCurrencyList).symbol,e.isInvoiceCurrency=""!==t.invoiceCurrencyObject&&e.selected_rate_currency===_.find(t.exchangeCurrencyList,{id:t.invoiceCurrencyObject.id}).id;var c,l,d,u=200,m=7,f=7,p={dateFormat:t.jqDateFormat,changeYear:!0,changeMonth:!0,yearRange:"-10:"},v=function(){e.startDateOptions=_.extend({onSelect:h},p)},h=function(i,r){var s=tzIndependentDate(o.get_date_from_date_picker(r));e.start_date=a("date")(s,t.dateFormatForAPI);var c=moment(moment(s).add(m,"days"),"YYYY-MM-DD"),l=moment(moment().format("YYYY-MM-DD")),d=l.diff(c,"days");d>5?e.end_date=a("date")(tzIndependentDate(moment(s).add(m,"days").calendar()),t.dateFormatForAPI):e.end_date=a("date")(tzIndependentDate(moment(s).add(m,"days")),t.dateFormatForAPI),y(),n(function(){t.apply()},u)},g=function(){e.endDateOptions=_.extend({onSelect:D},p)},D=function(i,r){var s=tzIndependentDate(o.get_date_from_date_picker(r));e.end_date=a("date")(s,t.dateFormatForAPI);var c=moment(moment(s).subtract(m,"days"),"YYYY-MM-DD"),l=moment(moment().format("YYYY-MM-DD")),d=l.diff(c,"days");d>5?e.start_date=a("date")(tzIndependentDate(moment(s).subtract(m,"days").calendar()),t.dateFormatForAPI):e.start_date=a("date")(tzIndependentDate(moment(s).subtract(m,"days")),t.dateFormatForAPI),y(),n(function(){t.apply()},u)},y=function(){var n=function(t){t.length>0?(e.exchangeRatesData=t,e.exchangeRates=A(e.start_date)):(e.exchangeRatesData=[],e.exchangeRates=A(e.start_date)),e.refreshScroller("CURRENCY_SCROLLER")},o={start_date:a("date")(e.start_date,t.dateFormatForAPI),end_date:a("date")(e.end_date,t.dateFormatForAPI),is_invoice_currency:e.isInvoiceCurrency,selected_currency:e.selected_rate_currency};e.invokeApi(r.fetchExchangeRates,o,n)},S=function(e){return e<t.businessDate},A=function(n){for(var o=moment(n),i=moment(o).format("YYYY-MM-DD"),r=[],s=0;s<m;s++){var c=_.findWhere(e.exchangeRatesData,{date:moment(tzIndependentDate(o)).format(t.momentFormatForAPI)});r[s]={day:o.format("dddd"),date:a("date")(tzIndependentDate(i),t.dateFormatForAPI),conversion_rate:angular.isUndefined(c)?null:c.conversion_rate,isDisabled:S(i)||!e.hasPermissionToMCExchangeRate},o=o.add(1,"days"),i=moment(o).format("YYYY-MM-DD")}return r};e.changeCurrency=function(){e.selected_rate_currency_symbol=_.find(t.exchangeCurrencyList,{id:e.selected_rate_currency}).symbol,e.isInvoiceCurrency=""!==t.invoiceCurrencyObject&&e.selected_rate_currency===_.find(t.exchangeCurrencyList,{id:t.invoiceCurrencyObject.id}).id,y()},e.hasPermissionToMCExchangeRate=function(){return s.getPermissionValue("EDIT_MULTI_CURRENCY_EXCHANGE_RATES")},e.saveExchangeRate=function(){var a=function(){e.closeDialog()};angular.forEach(e.exchangeRates,function(e){e.date=moment(tzIndependentDate(e.date)).format(t.momentFormatForAPI)});var n={is_invoice_currency:e.isInvoiceCurrency,selected_currency:e.selected_rate_currency,exchange_rates:e.exchangeRates};e.invokeApi(r.saveExchangeRates,n,a)},e.copyToNext=function(t){e.exchangeRates[t+1].conversion_rate=e.exchangeRates[t].conversion_rate};var C={tap:!0,preventDefault:!1,showScrollbar:!0};e.setScroller("CURRENCY_SCROLLER",C),e.closeDialog=function(){t.modalOpened=!1,n(function(){i.close()},u)};var I=function(){e.start_date=a("date")(tzIndependentDate(t.businessDate),t.dateFormatForAPI),e.hasPermissionToMCExchangeRate=e.hasPermissionToMCExchangeRate(),c=moment(tzIndependentDate(t.businessDate)).add(m,"days"),l=moment().startOf("day"),d=moment.duration(l.diff(c)).asDays(),d<f?e.end_date=a("date")(tzIndependentDate(c.format("L")),t.dateFormatForAPI):e.end_date=a("date")(tzIndependentDate(moment(t.businessDate).add(m,"days").calendar()),t.dateFormatForAPI),v(),g(),y()};I()}]),sntRover.controller("RVInvoiceSearchController",["$scope","$rootScope","$timeout","RVInvoiceSearchSrv","ngDialog","$filter","RVBillCardSrv","$window","$state","$stateParams","$vault","rvAccountTransactionsSrv","rvAccountsConfigurationSrv","filterOptions","RVCompanyCardSrv",function(e,t,a,n,o,i,r,s,c,l,d,u,m,f,p){BaseCtrl.call(this,e);var v={preventDefaultException:{tagName:/^(INPUT|LI)$/},preventDefault:!1},h=this,g=10;e.currentActivePage=1,e.filterOptions=f.filters,e.invoiceSearchData={},e.invoiceSearchData.filter_id=_.first(e.filterOptions).id,e.paymentDataArray=[],e.shouldShowReservationInvoices=function(){return _.findWhere(e.filterOptions,{name:"Reservation Invoices"}).id===e.invoiceSearchData.filter_id},e.shouldShowAccountInvoices=function(){return _.findWhere(e.filterOptions,{name:"Account Invoices"}).id===e.invoiceSearchData.filter_id},e.shouldShowReservationReceipts=function(){return _.findWhere(e.filterOptions,{name:"Reservation Receipts"}).id===e.invoiceSearchData.filter_id},e.shouldShowAccountReceipts=function(){return _.findWhere(e.filterOptions,{name:"Account Receipts"}).id===e.invoiceSearchData.filter_id},e.shouldShowARInvoices=function(){return _.findWhere(e.filterOptions,{name:"AR Invoices"}).id===e.invoiceSearchData.filter_id},e.setScroller("invoice-list",v),e.setTitleAndHeading=function(t){e.setTitle(t),e.$parent.heading=t},e.clickedItem=function(t){d.set("searchQuery",e.invoiceSearchData.query),d.set("filterOption",e.invoiceSearchData.filter_id),"RESERVATION"===e.invoiceSearchData.reservationsList.results[t].associated_item.type?c.go("rover.reservation.staycard.reservationcard.reservationdetails",{id:e.invoiceSearchData.reservationsList.results[t].associated_item.item_id,confirmationId:e.invoiceSearchData.reservationsList.results[t].associated_item.number,isrefresh:!0,searchQuery:e.invoiceSearchData.query}):c.go("rover.accounts.config",{id:e.invoiceSearchData.reservationsList.results[t].associated_item.item_id,activeTab:"ACCOUNT"})};var D=function(){a(function(){e.refreshScroller("invoice-list")},1e3)};e.clearQuery=function(){e.invoiceSearchFlags.showFindInvoice=!0,e.invoiceSearchData.query="",e.invoiceSearchFlags.isQueryEntered=!1,e.totalResultCount=0,e.invoiceSearchData.reservationsList=[],D()},e.searchInvoice=function(o){a(function(){if(e.shouldShowReservationInvoices()&&t.isDepositInvoiceEnabled?e.searchPlaceHolder=i("translate")("SEARCH_PLACE_HOLDER_WITH_FOLIO_NUMBER_RESERVATION_DEPOSIT"):e.shouldShowReservationInvoices()&&(e.searchPlaceHolder=i("translate")("SEARCH_PLACE_HOLDER_WITH_FOLIO_NUMBER_RESERVATION")),e.shouldShowAccountInvoices()&&(e.searchPlaceHolder=i("translate")("SEARCH_PLACE_HOLDER_WITH_FOLIO_NUMBER_ACCOUNT")),e.shouldShowReservationReceipts()&&(e.searchPlaceHolder=i("translate")("SEARCH_PLACE_HOLDER_WITH_RECEIPTS_RESERVATION")),e.shouldShowAccountReceipts()&&(e.searchPlaceHolder=i("translate")("SEARCH_PLACE_HOLDER_WITH_RECEIPTS_ACCOUNTS")),e.shouldShowARInvoices()&&(e.searchPlaceHolder=i("translate")("SEARCH_PLACE_HOLDER_WITH_AR_INVOICE")),(e.shouldShowReservationInvoices()||e.shouldShowAccountInvoices())&&(e.paymentDataArray=[]),e.currentActivePage=o||1,e.invoiceSearchData.query.length>0){e.invoiceSearchFlags.isQueryEntered=!0;var r=function(t){e.invoiceSearchFlags.showFindInvoice=!1,e.invoiceSearchData.reservationsList=t.data,angular.forEach(e.invoiceSearchData.reservationsList.results,function(e,t){angular.forEach(e.bills,function(e,t){e.isOpened=!1,e.billIndex=t}),e.itemIndex=t}),e.totalResultCount=t.data.total_count,0===e.totalResultCount&&(e.invoiceSearchFlags.showFindInvoice=!0),a(function(){e.$broadcast("updatePagination","INVOICE_SEARCH")},800),D()},s={query:e.invoiceSearchData.query,filter_id:e.invoiceSearchData.filter_id,page_no:o||1,per_page:g,from_date:e.invoiceSearchData.from_date,to_date:e.invoiceSearchData.to_date};(e.shouldShowReservationInvoices()||e.shouldShowAccountInvoices())&&(s.no_folio_number_only=e.invoiceSearchData.no_folio_number_only),(e.shouldShowReservationReceipts()||e.shouldShowAccountReceipts())&&(s.no_qr_code_only=e.invoiceSearchData.no_qr_code_only);var c={params:s,successCallBack:r};e.callAPI(n.searchForInvoice,c)}else e.totalResultCount=0,e.invoiceSearchData.reservationsList=[],e.invoiceSearchFlags.isQueryEntered=!1,e.invoiceSearchFlags.showFindInvoice=!0},800)},e.expandBill=function(t,a){if(e.invoiceSearchData.reservationsList.results[t].bills[a].isOpened=!e.invoiceSearchData.reservationsList.results[t].bills[a].isOpened,e.invoiceSearchData.reservationsList.results[t].bills[a].isOpened){var n=function(n){angular.forEach(n.transactions,function(n){n.isChecked=!1,n.bill_id=e.invoiceSearchData.reservationsList.results[t].bills[a].bill_id}),e.invoiceSearchData.reservationsList.results[t].bills[a].transactions=n.transactions,D()},o={params:{bill_id:e.invoiceSearchData.reservationsList.results[t].bills[a].bill_id,payments_only:!0,no_qr_code_only:e.invoiceSearchData.no_qr_code_only},successCallBack:n};e.callAPI(p.fetchTransactionDetails,o)}},e.openRetriggerMessagePopup=function(){o.open({template:"/assets/partials/financials/invoiceSearch/rvRetriggerSuccessMessagePopup.html",className:"",scope:e})},e.reTriggerPaymentReceipt=function(){var t=function(t){e.searchInvoice(e.currentActivePage),e.isSuccess=!0,e.retriggerMessage=t.message,e.openRetriggerMessagePopup()},a=function(t){e.isSuccess=!1,e.retriggerMessage=t.errors,e.openRetriggerMessagePopup()},o={params:{transactions:e.paymentDataArray},successCallBack:t,failureCallBack:a};e.callAPI(n.triggerPaymentReceipt,o)},e.clickedCancelOfRetrigger=function(){e.paymentDataArray=[],angular.forEach(e.invoiceSearchData.reservationsList.results,function(e){angular.forEach(e.bills,function(e){angular.forEach(e.transactions,function(e){e.isChecked=!1})})})},e.clickedTransactionCheckbox=function(t,a,n,o){var i={};i.transaction_id=t,i.bill_id=e.invoiceSearchData.reservationsList.results[o].bills[a].transactions[n].bill_id,e.invoiceSearchData.reservationsList.results[o].bills[a].transactions[n].isChecked=!e.invoiceSearchData.reservationsList.results[o].bills[a].transactions[n].isChecked,e.invoiceSearchData.reservationsList.results[o].bills[a].transactions[n].isChecked?e.paymentDataArray.push(i):e.paymentDataArray.pop(i)};var y=e.$on("UPDATE_INFORMATIONAL_INVOICE",function(t,a){e.isInformationalInvoice=a});e.getInvoiceButtonClass=function(t,a){var n="blue";return!e.invoiceSearchData.reservationsList.results[t].bills[a].is_active&&e.invoiceSearchData.reservationsList.results[t].bills[a].is_folio_number_exists&&e.roverObj.noReprintReEmailInvoice&&e.invoiceSearchData.reservationsList.results[t].bills[a].is_printed_once&&e.invoiceSearchData.reservationsList.results[t].bills[a].is_emailed_once&&(n="grey"),n},e.isInvoiceButtonDisabled=function(t,a){var n=!1;return!e.transactionsDetails.bills[e.currentActiveBill].is_active&&e.transactionsDetails.bills[e.currentActiveBill].is_folio_number_exists&&e.roverObj.noReprintReEmailInvoice&&e.invoiceSearchData.reservationsList.results[t].bills[a].is_printed_once&&e.invoiceSearchData.reservationsList.results[t].bills[a].is_emailed_once&&(n=!0),n},e.showFormatBillPopup=function(t,a){e.billNo=e.invoiceSearchData.reservationsList.results[t].bills[a].bill_no,e.billFormat={},e.billFormat.isInformationalInvoice=!1,e.currentActiveBill=a,e.currentSelectedItem=t,e.reservationBillData={is_bill_lock_enabled:e.invoiceSearchData.reservationsList.is_bill_lock_enabled,no_of_original_emails:e.invoiceSearchData.reservationsList.no_of_original_emails,no_of_original_invoices:e.invoiceSearchData.reservationsList.no_of_original_invoices},e.reservationBillData.bills=e.invoiceSearchData.reservationsList.results[t].bills,e.invoiceSearchFlags.itemType=e.invoiceSearchData.reservationsList.results[t].associated_item.type,"RESERVATION"===e.invoiceSearchData.reservationsList.results[t].associated_item.type?(e.invoiceSearchFlags.isClickedReservation=!0,e.reservationBillData.reservation_id=e.invoiceSearchData.reservationsList.results[t].associated_item.item_id):(e.isFromInvoiceSearchScreen=!0,e.clickedInvoiceData=e.invoiceSearchData.reservationsList.results[t],e.invoiceSearchFlags.isClickedReservation=!1),e.invoiceSearchData.reservationsList.results[t].bills[a].is_transactions_exist&&0===e.invoiceSearchData.reservationsList.results[t].bills[a].balance&&e.invoiceSearchData.reservationsList.is_bill_lock_enabled&&e.invoiceSearchData.reservationsList.results[t].bills[a].is_active&&(!e.invoiceSearchFlags.isClickedReservation||("CHECKING_OUT"===e.invoiceSearchData.reservationsList.results[t].associated_item.reservation_status||"CHECKEDIN"===e.invoiceSearchData.reservationsList.results[t].associated_item.reservation_status))?(e.isInvoiceStepOneActive=!0,e.isInvoiceStepThreeActive=!1,e.shouldGenerateFinalInvoice=!0):(e.isInvoiceStepOneActive=!1,e.isInvoiceStepThreeActive=!0,e.shouldGenerateFinalInvoice=!1),e.isInvoiceStepTwoActive=!1,e.isInvoiceStepFourActive=!1,e.isInvoiceStepFiveActive=!1,e.isSettledBill=e.invoiceSearchData.reservationsList.results[t].bills[a].is_active,e.isEmailedOnce=e.invoiceSearchData.reservationsList.results[t].bills[a].is_emailed_once,e.isPrintedOnce=e.invoiceSearchData.reservationsList.results[t].bills[a].is_printed_once,e.isFolioNumberExists=e.invoiceSearchData.reservationsList.results[t].bills[a].is_folio_number_exists,o.open({template:"/assets/partials/popups/billFormat/rvBillFormatPopup.html",controller:"rvBillFormatPopupCtrl",className:"",scope:e})};var S=function(){o.open({template:"/assets/partials/popups/billFormat/rvInvoicePendingInfoPopup.html",className:"",scope:e})},A=function(t,a){var n=function(){e.shouldGenerateFinalInvoice=!1,e.searchInvoice(e.currentActivePage),a?h.printBill(t):e.clickedEmail(t)},o={params:{bill_id:e.invoiceSearchData.reservationsList.results[e.currentSelectedItem].bills[e.currentActiveBill].bill_id},successCallBack:n};e.callAPI(r.settleFinalInvoice,o)},C=function(){$("head").append("<style id='print-orientation'>@page { size: portrait; }</style>")},I=function(){$("#print-orientation").remove()},b=function(){$("header .logo").removeClass("logo-hide"),$("header .h2").addClass("text-hide"),e.$parent.addNoPrintClass=!1,I(),e.searchInvoice(e.currentActivePage)};h.printBill=function(t){if(e.shouldGenerateFinalInvoice&&!e.billFormat.isInformationalInvoice)A(t,!0);else{var n=function(e){var t="";return e.is_copy_counter&&(t=parseInt(e.print_counter,10)-parseInt(e.no_of_original_invoices,10)),t},o=function(t,a){var n=t.translation.invoice;return a?n=t.guest_bill_invoice_label||t.translation.invoice:"POSTING_ACCOUNT"===e.invoiceSearchFlags.itemType&&(n=t.posting_account_invoice_label||t.translation.invoice),n},i=function(t,a){var n=t.translation.copy_of_invoice;return a?n=t.guest_bill_invoice_copy_label||t.translation.copy_of_invoice:"POSTING_ACCOUNT"===e.invoiceSearchFlags.itemType&&(n=t.posting_account_invoice_copy_label||t.translation.copy_of_invoice),n},s=function(t){var r="",s=moment(t.print_ar_invoice_number_activated_at,"YYYY-MM-DD"),c=moment(t.ar_transaction_date,"YYYY-MM-DD"),l=c.diff(s,"days");if(e.shouldShowArInvoiceNumber=!0,l<0&&(e.shouldShowArInvoiceNumber=!1),e.invoiceSearchFlags.isClickedReservation||(t=t.data),t.is_deposit_invoice)t.invoiceLabel=t.translation.deposit_invoice;else if(e.billFormat.isInformationalInvoice)t.invoiceLabel=t.translation.information_invoice;else if(null!==t.no_of_original_invoices||t.is_void_bill){if(t.is_void_bill)null===t.no_of_original_invoices||parseInt(t.print_counter,10)<=parseInt(t.no_of_original_invoices,10)?t.invoiceLabel=t.translation.void_invoice:parseInt(t.print_counter,10)>parseInt(t.no_of_original_invoices,10)&&(r=n(t),t.invoiceLabel=t.translation.copy_of_void_invoice.replace("#count",r));else if(e.reservationBillData.is_bill_lock_enabled&&parseInt(t.print_counter,10)<=parseInt(t.no_of_original_invoices,10)||!e.reservationBillData.is_bill_lock_enabled&&parseInt(t.print_counter,10)<=parseInt(t.no_of_original_invoices,10))t.invoiceLabel=o(t,e.invoiceSearchFlags.isClickedReservation);else if(e.reservationBillData.is_bill_lock_enabled&&parseInt(t.print_counter,10)>parseInt(t.no_of_original_invoices,10)||!e.reservationBillData.is_bill_lock_enabled&&parseInt(t.print_counter,10)>parseInt(t.no_of_original_invoices,10)){var r="";t.is_copy_counter&&(r=parseInt(t.print_counter,10)-parseInt(t.no_of_original_invoices,10)),t.invoiceLabel=i(t,e.invoiceSearchFlags.isClickedReservation).replace("#count",r)}}else t.invoiceLabel=o(t,e.invoiceSearchFlags.isClickedReservation);t.is_invoice_issued?(e.printData=t,e.errorMessage="",$("header .logo").addClass("logo-hide"),$("header .h2").addClass("text-hide"),e.$parent.addNoPrintClass=!0,C(),a(function(){sntapp.cordovaLoaded?cordova.exec(b,function(){b()},"RVCardPlugin","printWebView",[]):(window.print(),b())},1e3)):S()},c=function(t){e.errorMessage=t},l={params:t,successCallBack:s,failureCallBack:c};e.invoiceSearchFlags.isClickedReservation?e.callAPI(r.fetchBillPrintData,l):e.callAPI(u.fetchAccountBillsForPrint,l)}},e.clickedPrint=function(t){e.closeDialog(),h.printBill(t)},e.clickedEmail=function(t){if(e.closeDialog(),e.shouldGenerateFinalInvoice&&!e.billFormat.isInformationalInvoice)A(t,!1);else{var n=function(t){e.statusMsg=i("translate")("EMAIL_SENT_SUCCESSFULLY"),t.is_invoice_issued?(e.status="success",e.showEmailSentStatusPopup()):a(function(){S()},500)},o=function(){e.statusMsg=i("translate")("EMAIL_SEND_FAILED"),e.status="alert",e.showEmailSentStatusPopup()},s={params:t,successCallBack:n,failureCallBack:o};e.invoiceSearchFlags.isClickedReservation?e.callAPI(r.sendEmail,s):e.callAPI(m.emailInvoice,s)}},e.clickedReceiptIcon=function(t,a,n){e.entityType=t,e.isFromBillCard="RESERVATION"===t,e.transactionId=a,e.billId=n,o.open({template:"/assets/partials/popups/rvReceiptPopup.html",controller:"RVReceiptPopupController",className:"",scope:e})};var E=function(){e.printReceiptActive=!1,$("header .logo").removeClass("logo-hide"),$("header .h2").removeClass("text-hide"),$("body #loading").html('<div id="loading-spinner" ></div>')};e.addListener("PRINT_RECEIPT",function(t,n){e.printReceiptActive=!0,e.receiptPrintData=n,e.errorMessage="",$("header .logo").addClass("logo-hide"),$("header .h2").addClass("text-hide"),$("body #loading").html(""),e.$parent.addNoPrintClass=!0,C(),a(function(){sntapp.cordovaLoaded?cordova.exec(E,function(e){E()},"RVCardPlugin","printWebView",[]):(window.print(),E())},700)}),h.init=function(){e.invoiceSearchData.query=l.isFromStayCard?d.get("searchQuery"):"",e.invoiceSearchData.filter_id=l.isFromStayCard?d.get("filterOption"):1,e.invoiceSearchFlags={},e.invoiceSearchFlags.showFindInvoice=!0,e.invoiceSearchFlags.isQueryEntered=!1,e.invoiceSearchFlags.isClickedReservation=!0,e.invoiceSearchData.no_folio_number_only=!1,e.invoiceSearchData.no_qr_code_only=!1,e.totalResultCount=0,e.printData={},e.invoiceSearchPagination={id:"INVOICE_SEARCH",api:e.searchInvoice,perPage:g},e.invoiceSearchDateFromOptions={dateFormat:t.jqDateFormat,maxDate:e.invoiceSearchData.to_date&&e.invoiceSearchData.to_date&&e.invoiceSearchData.to_date<e.invoiceSearchData.from_date?tzIndependentDate(e.invoiceSearchData.to_date):tzIndependentDate(t.businessDate)},e.invoiceSearchDateToOptions={dateFormat:t.jqDateFormat,maxDate:e.invoiceSearchData.to_date&&e.invoiceSearchData.to_date&&e.invoiceSearchData.from_date>e.invoiceSearchData.to_date?tzIndependentDate(e.invoiceSearchData.from_date):tzIndependentDate(t.businessDate)};var a=i("translate")("FIND_INVOICE");e.setTitleAndHeading(a),e.searchInvoice(1)},h.init(),e.$on("$destroy",y)}]),sntRover.controller("RVJournalBalanceController",["$scope","$rootScope","RVJournalSrv","$timeout","$state",function(e,t,a,n,o){BaseCtrl.call(this,e);var i=function(){var t=function(t){e.balanceData=t},n={date:e.data.balanceDate};e.invokeApi(a.fetchBalanceTabDetails,n,t)};e.clickedNavigationToSearch=function(e){var t={type:e,from_page:"JOURNAL"};o.go("rover.search",t)},e.addListener("balanceDateChanged",function(){i()}),i()}]),sntRover.controller("RVJournalCashierController",["$scope","RVJournalSrv","$rootScope",function(e,t,a){var n=function(a){var n=function(t){e.$emit("hideLoader"),e.lastCashierId=t.last_cashier_period_id,e.detailsList=t.history,e.selectedHistory=e.detailsList.length>0?0:"",e.details=e.detailsList.length>0?e.detailsList[0]:{},e.selectedHistoryId=e.detailsList.length>0?e.detailsList[0].id:"",e.isLoading=!1,e.details.opening_balance_cash=e.details.opening_balance_cash||0,e.details.total_cash_received=e.details.total_cash_received||0,e.details.cash_submitted=e.details.cash_submitted||0,e.details.opening_balance_check=e.details.opening_balance_check||0,e.details.total_check_received=e.details.total_check_received||0,e.details.check_submitted=e.details.check_submitted||0,e.totalClosingBalanceInCash=parseFloat(e.details.opening_balance_cash)+parseFloat(e.details.total_cash_received)-parseFloat(e.details.cash_submitted),e.totalClosingBalanceInCheck=parseFloat(e.details.opening_balance_check)+parseFloat(e.details.total_check_received)-parseFloat(e.details.check_submitted),setTimeout(function(){e.refreshScroller("cashier_history"),e.refreshScroller("cashier_shift")},200)};e.data.filterData.selectedCashier=e.data.filterData.selectedCashier||e.data.filterData.loggedInUserId;var a={user_id:e.data.filterData.selectedCashier,date:e.data.cashierDate,report_type_id:e.data.reportType};e.invokeApi(t.fetchCashierDetails,a,n)},o=function(){BaseCtrl.call(this,e),e.errorMessage="",e.selectedHistory=0,e.setScroller("cashier_history",{}),e.setScroller("cashier_shift",{}),e.isLoading=!0,n()};o(),e.isDateBeforeBusinnesDate=function(e){return a.businessDate!==e},e.isLastCashierPeriod=function(t){return parseInt(e.lastCashierId)===parseInt(e.details.id)},e.historyClicked=function(t){e.selectedHistory=t,e.details=e.detailsList[t],e.details.cash_submitted=null===e.details.cash_submitted||""===e.details.cash_submitted?0:e.details.cash_submitted,e.details.check_submitted=null===e.details.check_submitted||""===e.details.check_submitted?0:e.details.check_submitted,e.selectedHistoryId=e.detailsList[t].id,e.totalClosingBalanceInCash=parseFloat(e.details.opening_balance_cash)+parseFloat(e.details.total_cash_received)-parseFloat(e.details.cash_submitted),e.totalClosingBalanceInCheck=parseFloat(e.details.opening_balance_check)+parseFloat(e.details.total_check_received)-parseFloat(e.details.check_submitted)},e.closeShift=function(){var a=function(t){e.$emit("hideLoader"),e.detailsList[e.selectedHistory]=t,e.details=t,e.lastCashierId=e.details.id,e.data.filterData.cashierStatus="CLOSED"},n={};n.id=e.selectedHistoryId;var o=parseFloat(e.details.opening_balance_cash)+parseFloat(e.details.total_cash_received)-parseFloat(e.details.cash_submitted),i=parseFloat(e.details.opening_balance_check)+parseFloat(e.details.total_check_received)-parseFloat(e.details.check_submitted);n.data={cash_submitted:e.details.cash_submitted,check_submitted:e.details.check_submitted,closing_balance_cash:o,closing_balance_check:i},e.invokeApi(t.closeCashier,n,a)},e.reOpen=function(){var a=function(t){e.$emit("hideLoader"),e.detailsList[e.selectedHistory]=t,e.details=t,e.data.filterData.cashierStatus="OPEN"},n={};n.id=e.selectedHistoryId,e.invokeApi(t.reOpenCashier,n,a)},e.$on("cashierTabActive",function(){setTimeout(function(){e.refreshScroller("cashier_history")},200),setTimeout(function(){e.refreshScroller("cashier_shift")},200)}),e.$on("refreshDetails",function(){n()}),e.changedCash=function(){e.totalClosingBalanceInCash=parseFloat(e.details.opening_balance_cash)+parseFloat(e.details.total_cash_received)-parseFloat(e.details.cash_submitted)},e.changedCheck=function(){e.totalClosingBalanceInCheck=parseFloat(e.details.opening_balance_check)+parseFloat(e.details.total_check_received)-parseFloat(e.details.check_submitted)}}]),sntRover.controller("RVJournalController",["$scope","$filter","$stateParams","ngDialog","$rootScope","RVJournalSrv","journalResponse","$timeout","rvPermissionSrv","journalFilters",function(e,t,a,n,o,i,r,s,c,l){BaseCtrl.call(this,e),e.$emit("HeaderChanged",t("translate")("MENU_JOURNAL")),e.setTitle(t("translate")("MENU_JOURNAL")),e.data={},e.data.filterData={},e.data.summaryData={},e.data.revenueData={},e.data.paymentData={},e.data.filterData=r,e.data.filterData.checkedAllDepartments=!0,e.data.filterData.checkedAllEmployees=!0,e.data.filterData.isSelectButtonActive=!1,e.data.filterData.perPage=50,e.data.selectedChargeGroup="",e.data.selectedChargeCode="",e.data.selectedPaymentType="",e.data.filterTitle="All Departments and All Employees",e.data.isExpandedViewSummary=!1,e.data.isExpandedViewRevenue=!1,e.data.isExpandedViewPayment=!1,e.data.isActiveRevenueFilter=!1,e.data.activeChargeGroups=[],e.data.activeChargeCodes=[],e.data.activePaymentTypes=[],e.data.selectedDepartmentList=[],e.data.selectedEmployeeList=[],e.data.reportType="",e.data.isInactiveCashier=!1,e.data.query="",e.data.isShowSummaryTab=!0,e.data.isDrawerOpened=!0,e.data.isRevenueToggleSummaryActive=!0,e.data.isPaymentToggleSummaryActive=!0,e.data.selectedCashier="",e.data.activePaymentTab="",e.setScroller("employee-content"),e.setScroller("department-content"),e.data.selectedDepartmentName=[],e.data.selectedDepartmentName.push("ALL"),e.data.selectedEmployeesName=[],e.data.selectedEmployeesName.push("ALL"),e.isDetailsSelected=!1,e.isPrintClicked=!1;var d=function(){""!==e.data.filterData.selectedCashier&&angular.forEach(e.data.filterData.cashiers,function(t,a){t.id===e.data.filterData.selectedCashier&&(e.data.selectedCashier=t.name)})};d();var u=function(t){e.clickedOn=t,
n.open({template:"/assets/partials/financials/journal/rvJournalCalendarPopup.html",controller:"RVJournalDatePickerController",className:"single-date-picker",scope:e})};e.clickedFromDate=function(){u("FROM")},e.clickedToDate=function(){u("TO")},e.clickedCashierDate=function(){u("CASHIER")},e.clickedSummaryDate=function(){u("SUMMARY")},e.clickedBalanceDate=function(){u("BALANCE")};var m=function(){angular.forEach(e.data.filterData.employees,function(t,a){t.id===e.data.filterData.loggedInUserId&&(t.checked=!0,e.data.filterData.isSelectButtonActive=!0,e.clickedSelectButton())})};e.clickedJournalToggle=function(t,a){var n=e.data.activeTab;"SUMMARY"===n?(""===e.data.query||a?e.data.isExpandedViewSummary=!e.data.isExpandedViewSummary:e.data.isExpandedViewSummary=!0,e.$broadcast("EXPAND_SUMMARY_SCREEN")):"PAYMENTS"===n?(t||(e.data.isExpandedViewPayment=!e.data.isExpandedViewPayment),e.$broadcast("EXPAND_PAYMENT_SCREEN")):"REVENUE"===n&&(t||(e.data.isExpandedViewRevenue=!e.data.isExpandedViewRevenue),e.data.isExpandedViewRevenue?e.$broadcast("EXPAND_REVENUE_SCREEN"):e.searchJournal())},e.clickedRevenueFilter=function(){e.data.isActiveRevenueFilter=!e.data.isActiveRevenueFilter,setTimeout(function(){e.refreshScroller("employee-content"),e.refreshScroller("department-content")},200)};var f=function(){var t=!0;return angular.forEach(e.data.filterData.departments,function(e,a){e.checked&&(t=!1)}),t},p=function(){g()&&f()?e.data.filterData.isSelectButtonActive=!1:e.data.filterData.isSelectButtonActive=!0},v=function(t){angular.forEach(e.data.filterData.departments,function(e,t){e.checked=!1})},h=function(t){angular.forEach(e.data.filterData.employees,function(e,t){e.checked=!1})},g=function(){var t=!0;return angular.forEach(e.data.filterData.employees,function(e,a){e.checked&&(t=!1)}),t};e.selectAllDepartment=function(){e.data.filterData.checkedAllDepartments=!0,e.data.selectedDepartmentName=[],e.data.selectedDepartmentName.push("ALL"),v(),e.data.selectedDepartmentList=[],p(),0===e.data.selectedDepartmentList.length&&0===e.data.selectedEmployeeList.length?e.data.filterTitle="All Departments and All Employees":0===e.data.selectedDepartmentList.length&&0!==e.data.selectedEmployeeList.length&&(e.data.filterTitle="Multiple"),"PAYMENTS"===e.data.activeTab&&e.$broadcast("PAYMENTSSEARCH"),"REVENUE"===e.data.activeTab&&e.$broadcast("REVENUESEARCH")},e.selectAllEmployees=function(){e.data.filterData.checkedAllEmployees=!0,e.data.selectedEmployeesName=[],e.data.selectedEmployeeList=[],e.data.selectedEmployeesName.push("ALL"),h(),p(),0===e.data.selectedDepartmentList.length&&0===e.data.selectedEmployeeList.length?e.data.filterTitle="All Departments and All Employees":0!==e.data.selectedDepartmentList.length&&0===e.data.selectedEmployeeList.length&&(e.data.filterTitle="Multiple"),"PAYMENTS"===e.data.activeTab&&e.$broadcast("PAYMENTSSEARCH"),"REVENUE"===e.data.activeTab&&e.$broadcast("REVENUESEARCH")},e.clickedDepartment=function(t){e.data.filterData.departments[t].checked=!e.data.filterData.departments[t].checked,p(),f()?e.selectAllDepartment():e.data.filterData.checkedAllDepartments=!1},e.clickedEmployees=function(t){e.data.filterData.employees[t].checked=!e.data.filterData.employees[t].checked,p(),g()?e.selectAllEmployees():e.data.filterData.checkedAllEmployees=!1};var D=function(){var t="";e.data.selectedDepartmentList=[],e.data.selectedDepartmentName=[],angular.forEach(e.data.filterData.departments,function(a,n){a.checked&&(e.data.selectedDepartmentList.push(a.id),e.data.selectedDepartmentName.push(a.name),t=a.name)}),e.data.selectedEmployeeList=[],e.data.selectedEmployeesName=[],angular.forEach(e.data.filterData.employees,function(a,n){a.checked&&(e.data.selectedEmployeeList.push(a.id),e.data.selectedEmployeesName.push(a.name),t=a.name)}),e.data.selectedDepartmentList.length+e.data.selectedEmployeeList.length>1?e.data.filterTitle="Multiple":0===e.data.selectedDepartmentList.length&&0===e.data.selectedEmployeeList.length?(e.data.filterTitle="All Departments and All Employees",e.data.selectedDepartmentName=[],e.data.selectedDepartmentName.push("ALL")):e.data.filterTitle=t,0===e.data.selectedEmployeesName.length&&(e.data.selectedEmployeesName=[],e.data.selectedEmployeesName.push("ALL")),"PAYMENTS"===e.data.activeTab&&e.$broadcast("PAYMENTSSEARCH"),"REVENUE"===e.data.activeTab&&e.$broadcast("REVENUESEARCH")};if(e.clickedSelectButton=function(){e.data.filterData.isSelectButtonActive&&(D(),e.data.isActiveRevenueFilter=!1)},"CASHIER"===a.id)e.data.isShowSummaryTab=!1,e.data.activeTab="CASHIER",e.$emit("updateRoverLeftMenu","cashier"),e.data.fromDate=o.businessDate,e.data.toDate=o.businessDate,e.data.cashierDate=o.businessDate,e.data.summaryDate=o.businessDate,e.data.balanceDate=moment(tzIndependentDate(o.businessDate)).subtract(1,"days").format(o.momentFormatForAPI),e.data.isDrawerOpened=!1,s(function(){m()},2e3);else{e.data.activeTab=o.isHourlyRateOn?"REVENUE":"SUMMARY",e.$emit("updateRoverLeftMenu","journals");var y=tzIndependentDate(o.businessDate);y.setDate(y.getDate()-1),e.data.fromDate=t("date")(y,"yyyy-MM-dd"),e.data.toDate=t("date")(y,"yyyy-MM-dd"),e.data.cashierDate=t("date")(y,"yyyy-MM-dd"),e.data.summaryDate=t("date")(y,"yyyy-MM-dd"),e.data.balanceDate=moment(tzIndependentDate(o.businessDate)).subtract(1,"days").format(o.momentFormatForAPI),o.isHourlyRateOn&&(e.data.isShowSummaryTab=!1)}var S=function(){e.$broadcast("refreshDetails")};e.$on("cashierDateChanged",function(){S()}),e.toggleInactiveCashier=function(){e.data.isInactiveCashier=!e.data.isInactiveCashier},e.cashierFilterChanged=function(){e.data.filterData.selectedCashier?(S(),d()):S()},e.activatedTab=function(t){e.data.activeTab=t,"REVENUE"===t?(e.data.searchFilterOptions.splice(5,1),e.data.isExpandedViewRevenue||o.$broadcast("REFRESHREVENUECONTENT")):"CASHIER"===t?e.$broadcast("cashierTabActive"):"PAYMENTS"===t?(o.$broadcast("REFRESHPAYMENTCONTENT"),e.data.searchFilterOptions.splice(5,1)):"SUMMARY"===t&&(o.$broadcast("REFRESHSUMMARYCONTENT"),_.indexOf(e.data.searchFilterOptions,_.findWhere(e.data.searchFilterOptions,{value:"AR_INVOICE_NUMBER"}))===-1&&e.data.searchFilterOptions.push(e.data.arInvoiceFilter),e.data.isDrawerOpened=!0),"SUMMARY"!==t&&e.$broadcast("CLOSEPRINTBOX"),e.data.isActiveRevenueFilter=!1,v(),h()},e.escapeNullData=function(e){var t=e;return""!==e&&"undefined"!=typeof e&&null!==e||(t="-"),t},e.searchJournal=function(){var a=e.data.activeTab;e.data.filterName=t("filter")(e.data.searchFilterOptions,e.data.filterId)[0].name,"SUMMARY"===a?o.$broadcast("SUMMARYSEARCH"):"PAYMENTS"===a?o.$broadcast("PAYMENTSSEARCH"):"REVENUE"===a&&o.$broadcast("REVENUESEARCH")},e.getTimeString=function(e,a){var e=t("date")(e,o.dateFormat);return e+", "+a},e.printSummary=function(){e.isDetailsSelected?(o.$broadcast("INITIALIZESUMMARYDETAILS"),e.isPrintClicked=!0):e.$broadcast("PRINTSUMMARY")},e.addListener("EXPAND_PAYMENT",function(){e.clickedJournalToggle(!0)}),e.addListener("EXPAND_REVENUE",function(){e.clickedJournalToggle(!0)});var A=function(){e.data.arInvoiceFilter=l.filters[5],e.data.searchFilterOptions=l.filters,e.data.filterId=_.first(e.data.searchFilterOptions).id,e.data.filterName=_.first(e.data.searchFilterOptions).name,"BALANCE"===a.tab&&e.activatedTab("BALANCE")};A()}]),sntRover.controller("RVJournalPaymentController",["$scope","$rootScope","RVJournalSrv","$timeout",function(e,t,a,n){BaseCtrl.call(this,e),e.errorMessage="",e.setScroller("payment_content",{});var o=function(){setTimeout(function(){e.refreshScroller("payment_content")},500)};e.addListener("REFRESHPAYMENTCONTENT",function(){o()});var i=function(t){var n=function(a){e.data.paymentData={},e.data.paymentData=a,e.data.activePaymentTypes=a.payment_types,e.errorMessage="",o(),"SUMMARY_DATE_CHANGED"!==t&&e.$emit("hideLoader"),e.data.isExpandedViewPayment&&e.$emit("EXPAND_PAYMENT")},i={from_date:e.data.fromDate,to_date:e.data.toDate,employee_ids:e.data.selectedEmployeeList,department_ids:e.data.selectedDepartmentList,type:""===e.data.activePaymentTab?"":e.data.activePaymentTab.toLowerCase()};""!==e.data.query&&(i.filter_id=e.data.filterId,i.query=e.data.query),e.invokeApi(a.fetchPaymentDataByPaymentTypes,i,n)};e.data.isExpandedViewPayment||i(),e.addListener("fromDateChanged",function(){i("")}),e.addListener("toDateChanged",function(){i("")}),e.addListener("PAYMENTSSEARCH",function(){i()}),e.addListener("REFRESH_REVENUE_PAYMENT_DATA",function(t,a){e.data.fromDate=a.date,e.data.toDate=a.date,i(a.origin)});var r=function(t,i,r){t.page_no=r||1;var s=function(a){t.transactions=[],t.transactions=a.transactions,t.total_count=a.total_count,!i&&a.transactions.length>0&&(t.active=!t.active),n(function(){var a=t.charge_code_id;e.$broadcast("updatePagination",a),o(),e.errorMessage="",e.$emit("hideLoader")},500)};if(!t.active||i){var c={from_date:e.data.fromDate,to_date:e.data.toDate,charge_code_id:t.charge_code_id,employee_ids:e.data.selectedEmployeeList,department_ids:e.data.selectedDepartmentList,page_no:t.page_no,per_page:e.data.filterData.perPage,type:""===e.data.activePaymentTab?"":e.data.activePaymentTab.toLowerCase()};""!==e.data.query&&(c.filter_id=e.data.filterId,c.query=e.data.query),e.invokeApi(a.fetchPaymentDataByTransactions,c,s)}else t.active=!t.active};e.addListener("EXPAND_PAYMENT_SCREEN",function(){angular.forEach(e.data.paymentData.payment_types,function(t,a){e.checkHasArrowFirstLevel(a)&&e.clickedFirstLevel(a,!0)})}),e.clickedFirstLevel=function(t,a){var n=e.data.paymentData.payment_types[t];"Credit Card"!==n.payment_type?(n.paymentTypesPagination={id:n.charge_code_id,api:[r,n,!0],perPage:e.data.filterData.perPage},r(n,!1)):(n.active=!n.active,o(),a&&angular.forEach(e.data.paymentData.payment_types[t].credit_cards,function(a,n){e.checkHasArrowSecondLevel(t,n)&&e.clickedSecondLevel(t,n)}))},e.clickedSecondLevel=function(t,a){var n=e.data.paymentData.payment_types[t].credit_cards[a];n.creditCardPagination={id:n.charge_code_id,api:[r,n,!0],perPage:e.data.filterData.perPage},r(n,!1)},e.checkHasArrowFirstLevel=function(t){var a=!1,n=e.data.paymentData.payment_types[t];return"undefined"!=typeof n.credit_cards&&n.credit_cards.length>0?a=!0:n.number>0&&(a=!0),a},e.checkHasArrowSecondLevel=function(t,a){var n=!1,o=e.data.paymentData.payment_types[t].credit_cards[a];return o.number>0&&(n=!0),n},e.clickedOnPayment=function(a){a.stopPropagation(),e.data.isDrawerOpened&&t.$broadcast("CLOSEPRINTBOX"),e.errorMessage=""},e.clickedPaymentGroup=function(t){e.data.activePaymentTab=t,i("")}}]),sntRover.controller("RVJournalPrintController",["$scope","$rootScope","$timeout","$window","RVJournalSrv",function(e,t,a,n,o){BaseCtrl.call(this,e);var i=0,r=60;e.eventTimestamp="",e.data.printBoxHeight=i,e.data.uiSelectedPaymentType="ALL",e.data.uiSelectedChargeGroup="ALL";var s=function(t){t>5?(e.data.isDrawerOpened=!0,e.data.printBoxHeight=t,e.$apply()):t<5&&e.closeDrawer()};e.resizableOptions={minHeight:i,maxHeight:r,handles:"s",resize:function(e,t){var a=$(this).height();s(a)},stop:function(t,a){var n=$(this).height();preventClicking=!0,e.eventTimestamp=t.timeStamp,s(n)}},e.clickedDrawer=function(t){if(t.stopPropagation(),t.stopImmediatePropagation(),getParentWithSelector(t,document.getElementsByClassName("ui-resizable-handle")[0])){if(parseInt(e.eventTimestamp)&&t.timeStamp-e.eventTimestamp<2)return;e.data.printBoxHeight===i||e.data.printBoxHeight===r?e.data.isDrawerOpened?e.closeDrawer():e.openDrawer():e.closeDrawer()}},e.openDrawer=function(){e.data.printBoxHeight=r,e.data.isDrawerOpened=!0},e.closeDrawer=function(){e.data.printBoxHeight=i,e.data.isDrawerOpened=!1},e.$on("CLOSEPRINTBOX",function(){e.closeDrawer()}),e.chargeGroupChanged=function(){e.data.activeChargeCodes=[];var a=function(a){e.data.revenueData={},e.data.revenueData=a,e.chargeCodeChanged(),e.errorMessage="",t.$broadcast("REFRESHREVENUECONTENT"),e.$emit("hideLoader")},n={from_date:e.data.fromDate,to_date:e.data.toDate,employee_ids:e.data.selectedEmployeeList,department_ids:e.data.selectedDepartmentList,charge_group_id:e.data.selectedChargeGroup};""!==e.data.query&&(n.filter_id=e.data.filterId,n.query=e.data.query),e.data.activeRevenueTab?n.type=e.data.activeRevenueTab.toLowerCase():e.data.activeRevenueTab="",e.invokeApi(o.fetchRevenueDataByChargeGroups,n,a);var i=_.find(e.data.activeChargeGroups,function(t){return t.id.toString()===e.data.selectedChargeGroup});e.data.uiSelectedChargeGroup=i?i.name:"ALL"},e.chargeCodeChanged=function(){var a=function(a){e.data.revenueData.total_revenue=a.total_revenue,e.data.revenueData.charge_groups[0].charge_codes=[],e.data.revenueData.charge_groups[0].charge_codes=a.charge_codes,e.data.revenueData.charge_groups[0].active=!0;var n=a.group_charge_codes;e.data.activeChargeCodes=n.length>0?n:[],t.$broadcast("REFRESHREVENUECONTENT"),e.errorMessage="",e.$emit("hideLoader")},n={from_date:e.data.fromDate,to_date:e.data.toDate,charge_group_id:e.data.selectedChargeGroup,charge_code_id:e.data.selectedChargeCode,employee_ids:e.data.selectedEmployeeList,department_ids:e.data.selectedDepartmentList};""!==e.data.query&&(n.filter_id=e.data.filterId,n.query=e.data.query),e.data.activeRevenueTab?n.type=e.data.activeRevenueTab.toLowerCase():e.data.activeRevenueTab="",e.invokeApi(o.fetchRevenueDataByChargeCodes,n,a);var i=_.find(e.data.activeChargeCodes,function(t){return t.id===e.data.selectedChargeCode});e.data.uiSelectedChargeCode=i?i.name:""},e.toggleSummaryOrDeatilsRevenue=function(){e.data.isRevenueToggleSummaryActive=!e.data.isRevenueToggleSummaryActive},e.toggleSummaryOrDeatilsPayment=function(){e.data.isPaymentToggleSummaryActive=!e.data.isPaymentToggleSummaryActive},e.paymentTypeChanged=function(){var a=function(a){e.data.paymentData={},e.data.paymentData=a,"Credit Card"===a.payment_type&&(e.data.paymentData.payment_types[0].active=!0),e.errorMessage="",t.$broadcast("REFRESHPAYMENTCONTENT"),e.$emit("hideLoader")},n={from_date:e.data.fromDate,to_date:e.data.toDate,employee_ids:e.data.selectedEmployeeList,department_ids:e.data.selectedDepartmentList};""!==e.data.query&&(n.filter_id=e.data.filterId,n.query=e.data.query),e.data.activePaymentTab?n.type=e.data.activePaymentTab.toLowerCase():e.data.activePaymentTab="",""===e.data.selectedPaymentType?n.charge_code_id="":""===e.data.selectedPaymentType||"undefined"==typeof e.data.selectedPaymentType?n.charge_code_id="CC":n.charge_code_id=e.data.selectedPaymentType,e.invokeApi(o.fetchPaymentDataByPaymentTypes,n,a);var i=_.find(e.data.activePaymentTypes,function(t){return t.charge_code_id===parseInt(e.data.selectedPaymentType)});e.data.uiSelectedPaymentType=i?i.payment_type:"ALL"},e.$on("PRINTSUMMARY",function(){d()}),e.printRevenue=function(){d()},e.printPayment=function(){d()},e.printCashier=function(){d()};var c=function(){var t="portrait";switch(e.data.activeTab){case"SUMMARY":t="landscape";break;case"REVENUE":case"PAYMENTS":t="landscape";break;default:t="portrait"}$("head").append("<style id='print-orientation'>@page { size: "+t+"; }</style>")},l=function(){$("#print-orientation").remove()},d=function(){var t=function(t){e.$emit("hideLoader"),a(function(){e.data.printDate=t.print_date,e.data.printTime=t.print_time,e.printFilterValues={},e.printFilterValues.selectedChargeGroup=$("#revenue-charge-group option:selected").text(),e.printFilterValues.selectedChargeCode=$("#revenue-charge-code:selected").text(),e.printFilterValues.selectedPaymentType=$("#payments-payment-type option:selected").text(),c(),a(function(){sntapp.cordovaLoaded?cordova.exec(l,function(e){l()},"RVCardPlugin","printWebView",[]):a(function(){window.print(),l()},700)},100)},250)},n={},i={params:n,successCallBack:t};e.callAPI(o.fetchPrintDateTime,i)}}]),sntRover.controller("RVJournalRevenueController",["$scope","$rootScope","RVJournalSrv","$timeout",function(e,t,a,n){BaseCtrl.call(this,e),e.errorMessage="",e.setScroller("revenue_content",{}),e.data.activeRevenueTab="";var o=function(){n(function(){e.refreshScroller("revenue_content")},500)},i=function(){var t=function(t){e.data.filterData.departments=t.departments,e.$emit("hideLoader")};e.invokeApi(a.fetchDepartments,{},t)},r=function(t){var n=function(a){e.data.revenueData={},e.data.revenueData=a,""===e.data.selectedChargeGroup&&(e.data.activeChargeGroups=[],e.data.activeChargeGroups=a.charge_groups),e.errorMessage="",o(),"SUMMARY_DATE_CHANGED"!==t&&e.$emit("hideLoader"),e.data.isExpandedViewRevenue&&e.$emit("EXPAND_REVENUE")},i={from_date:e.data.fromDate,to_date:e.data.toDate,employee_ids:e.data.selectedEmployeeList,department_ids:e.data.selectedDepartmentList,charge_group_id:e.data.selectedChargeGroup,type:""===e.data.activeRevenueTab?"":e.data.activeRevenueTab.toLowerCase()};""!==e.data.query&&(i.filter_id=e.data.filterId,i.query=e.data.query),e.invokeApi(a.fetchRevenueDataByChargeGroups,i,n)};e.data.isExpandedViewRevenue||r(),i(),e.addListener("REFRESHREVENUECONTENT",function(){o()}),e.addListener("fromDateChanged",function(){r("")}),e.addListener("toDateChanged",function(){r("")}),e.addListener("REVENUESEARCH",function(){r()}),e.addListener("REFRESH_REVENUE_PAYMENT_DATA",function(t,a){e.data.fromDate=a.date,e.data.toDate=a.date,r(a.origin)}),e.addListener("EXPAND_REVENUE_SCREEN",function(){angular.forEach(e.data.revenueData.charge_groups,function(t,a){e.checkHasArrowFirstLevel(a)&&e.clickedFirstLevel(a,!0)})}),e.clickedFirstLevel=function(t,n){var i=e.data.revenueData.charge_groups[t],r=function(a){a.charge_codes.length>0&&(i.charge_codes=a.charge_codes,i.active=!i.active,o(),e.data.selectedChargeCode="",n&&angular.forEach(i.charge_codes,function(a,n){e.checkHasArrowSecondLevel(t,n)&&e.clickedSecondLevel(t,n)})),e.errorMessage="",e.$emit("hideLoader")};if(i.active)i.active=!i.active;else{var s={from_date:e.data.fromDate,to_date:e.data.toDate,charge_group_id:i.id,employee_ids:e.data.selectedEmployeeList,department_ids:e.data.selectedDepartmentList,type:""===e.data.activeRevenueTab?"":e.data.activeRevenueTab.toLowerCase()};""!==e.data.query&&(s.filter_id=e.data.filterId,s.query=e.data.query),e.invokeApi(a.fetchRevenueDataByChargeCodes,s,r)}};var s=function(t,i,r){t.page_no=r||1;var s=function(a){t.transactions=[],t.transactions=a.transactions,t.total_count=a.total_count,!i&&a.transactions.length>0&&(t.active=!t.active),n(function(){var a=t.id;e.$broadcast("updatePagination",a),o(),e.errorMessage="",e.$emit("hideLoader")},500)};if(!t.active||i){var c={from_date:e.data.fromDate,to_date:e.data.toDate,charge_code_id:t.id,employee_ids:e.data.selectedEmployeeList,department_ids:e.data.selectedDepartmentList,page_no:t.page_no,per_page:e.data.filterData.perPage,type:""===e.data.activeRevenueTab?"":e.data.activeRevenueTab.toLowerCase()};""!==e.data.query&&(c.filter_id=e.data.filterId,c.query=e.data.query),e.invokeApi(a.fetchRevenueDataByTransactions,c,s)}else t.active=!t.active};e.clickedSecondLevel=function(t,a){var n=e.data.revenueData.charge_groups[t].charge_codes[a];n.chargeCodePagination={id:n.id,api:[s,n,!0],perPage:e.data.filterData.perPage},s(n,!1)},e.checkHasArrowFirstLevel=function(t){var a=!1,n=e.data.revenueData.charge_groups[t].charge_codes_count;return n>0&&(a=!0),a},e.checkHasArrowSecondLevel=function(t,a){var n=!1,o=e.data.revenueData.charge_groups[t].charge_codes[a].number;return o>0&&(n=!0),n},e.clickedOnRevenue=function(a){a.stopPropagation(),e.data.isDrawerOpened&&t.$broadcast("CLOSEPRINTBOX"),e.errorMessage=""},e.clickedRevenueGroup=function(t){e.data.activeRevenueTab=t,r("")}}]),sntRover.controller("RVJournalSummaryController",["$scope","$rootScope","RVJournalSrv","$timeout",function(e,t,a,n){BaseCtrl.call(this,e);var o=800;e.errorMessage="",e.perPage=50,e.setScroller("summary_content",{});var i=function(){setTimeout(function(){e.refreshScroller("summary_content")},o)};e.addListener("REFRESHSUMMARYCONTENT",function(){i()}),e.addListener("RELOADSUMMARYOVERVIEW",function(){c()}),e.addListener("SUMMARYSEARCH",function(){c(!0)}),e.addListener("fromDateChanged",function(t,a){e.data.summaryDate=a,c()});var r=function(t){var a="";switch(t){case"DEPOSIT_BALANCE":a=e.data.summaryData.deposit_balance;break;case"GUEST_BALANCE":a=e.data.summaryData.guest_balance;break;case"AR_BALANCE":a=e.data.summaryData.ar_balance}return a},s=function(t,a,n,o,i){switch(t){case"DEPOSIT_BALANCE":e.data.summaryData.deposit_closing_balance=i,e.data.summaryData.deposit_credits=o,e.data.summaryData.deposit_debits=n,e.data.summaryData.deposit_opening_balance=a;break;case"GUEST_BALANCE":e.data.summaryData.guest_closing_balance=i,e.data.summaryData.guest_credits=o,e.data.summaryData.guest_debits=n,e.data.summaryData.guest_opening_balance=a;break;case"AR_BALANCE":e.data.summaryData.ar_closing_balance=i,e.data.summaryData.ar_credits=o,e.data.summaryData.ar_debits=n,e.data.summaryData.ar_opening_balance=a}},c=function(t){var n=function(a){e.data.summaryData={},e.data.summaryData=a.data,e.data.printDate="",e.data.printTime="",e.data.summaryData.deposit_balance={active:!1,page_no:1,start:1,end:1,nextAction:!1,prevAction:!1},e.data.summaryData.guest_balance={active:!1,page_no:1,start:1,end:1,nextAction:!1,prevAction:!1},e.data.summaryData.ar_balance={active:!1,page_no:1,start:1,end:1,nextAction:!1,prevAction:!1},e.errorMessage="",i(),e.$emit("hideLoader"),t&&(""!==e.data.query?e.clickedJournalToggle(!1,!1):e.data.isExpandedViewSummary=!1)},o={date:e.data.summaryDate,is_summary:e.data.isExpandedView};""!==e.data.query&&(o.filter_id=e.data.filterId,o.query=e.data.query),e.invokeApi(a.fetchSummaryData,o,n)};e.addListener("summaryDateChanged",function(){c(),t.$broadcast("REFRESH_REVENUE_PAYMENT_DATA",{date:e.data.summaryDate,origin:"SUMMARY_DATE_CHANGED"})});var l=function(t,c){var l=r(t),d=function(a){l.transactions=[],l.transactions=a.transactions,l.total_count=a.total_count,s(t,a.opening_balance,a.debit_sum,a.credit_sum,a.closing_balance),!c&&l.transactions.length>0&&(l.active=!l.active),e.errorMessage="",i(),n(function(){e.$broadcast("updatePagination",t)},o),e.$emit("hideLoader")};if(!l.active||c){var u={date:e.data.summaryDate,page_no:l.page_no,per_page:e.perPage,type:t,is_summary:e.data.isExpandedView};""!==e.data.query&&(u.filter_id=e.data.filterId,u.query=e.data.query),e.invokeApi(a.fetchBalanceDetails,u,d)}else l.active=!l.active,i()};e.toggleJournalSummaryItem=function(e){l(e,!1)},e.addListener("EXPAND_SUMMARY_SCREEN",function(){e.toggleJournalSummaryItem("DEPOSIT_BALANCE"),e.toggleJournalSummaryItem("GUEST_BALANCE"),e.toggleJournalSummaryItem("AR_BALANCE")}),c();var d=function(e,t){var a=r(e);a.page_no=t,l(e,!0)};e.guestPagination={id:"GUEST_BALANCE",api:[d,"GUEST_BALANCE"],perPage:e.perPage},e.depositPagination={id:"DEPOSIT_BALANCE",api:[d,"DEPOSIT_BALANCE"],perPage:e.perPage},e.arPagination={id:"AR_BALANCE",api:[d,"AR_BALANCE"],perPage:e.perPage}}]),sntRover.controller("RVJournalSummaryDetailsController",["$scope","$rootScope","RVJournalSrv","$timeout",function(e,t,a,n){BaseCtrl.call(this,e),e.errorMessage="",e.setScroller("summary_content",{});var o=function(){setTimeout(function(){e.refreshScroller("summary_content")},500)};e.$on("INITIALIZESUMMARYDETAILS",function(){s()});var i=function(t){var a="";switch(t){case"DEPOSIT_BALANCE":a=e.details.summaryData.deposit_balance;break;case"GUEST_BALANCE":a=e.details.summaryData.guest_balance;break;case"AR_BALANCE":a=e.details.summaryData.ar_balance}return a},r=function(t,a,n,o,i){switch(t){case"DEPOSIT_BALANCE":e.details.summaryData.deposit_closing_balance=i,e.details.summaryData.deposit_credits=o,e.details.summaryData.deposit_debits=n,e.details.summaryData.deposit_opening_balance=a;break;case"GUEST_BALANCE":e.details.summaryData.guest_closing_balance=i,e.details.summaryData.guest_credits=o,e.details.summaryData.guest_debits=n,e.details.summaryData.guest_opening_balance=a;break;case"AR_BALANCE":e.details.summaryData.ar_closing_balance=i,e.details.summaryData.ar_credits=o,e.details.summaryData.ar_debits=n,e.details.summaryData.ar_opening_balance=a}},s=function(){var n=function(a){e.details={},e.details.summaryData={},e.details.summaryData=a.data,e.data.printDate="",e.data.printTime="",e.details.summaryData.deposit_balance={active:!1,page_no:1,start:1,end:1,nextAction:!1,prevAction:!1},e.details.summaryData.guest_balance={active:!1,page_no:1,start:1,end:1,nextAction:!1,prevAction:!1},e.details.summaryData.ar_balance={active:!1,page_no:1,start:1,end:1,nextAction:!1,prevAction:!1},e.errorMessage="",c("DEPOSIT_BALANCE",function(){c("GUEST_BALANCE",function(){c("AR_BALANCE",function(){o(),e.$emit("hideLoader"),t.$broadcast("PRINTSUMMARY")})})})},i={date:e.data.summaryDate};e.invokeApi(a.fetchSummaryData,i,n)},c=function(t,n){var o=i(t),s=function(a){o.transactions=[],o.transactions=a.transactions,o.total_count=a.total_count,o.end=o.start+o.transactions.length-1,e.data.printDate=a.print_date,e.data.printTime=a.print_time,r(t,a.opening_balance,a.debit_sum,a.credit_sum,a.closing_balance),o.active=o.transactions.length>0,n()},c={date:e.data.summaryDate,page_no:o.page_no,per_page:2e3,type:t};e.invokeApi(a.fetchBalanceDetails,c,s)}}]),sntRover.controller("RVJournalDatePickerController",["$scope","$rootScope","ngDialog","dateFilter",function(e,t,a,n){var o="",i=tzIndependentDate(t.businessDate),r=5;if("FROM"===e.clickedOn)e.date=e.data.fromDate,o=moment(tzIndependentDate(e.data.toDate)).add(-1*r,"y").format(t.momentFormatForAPI);else if("TO"===e.clickedOn){e.date=e.data.toDate,o=tzIndependentDate(e.data.fromDate);var s=tzIndependentDate(t.businessDate),c=moment(tzIndependentDate(e.data.fromDate)).add(r,"y");i=s<c?s:moment(tzIndependentDate(e.data.fromDate)).add(r,"y").format(t.momentFormatForAPI)}else"CASHIER"===e.clickedOn?e.date=e.data.cashierDate:"TRANSACTIONS"===e.clickedOn?e.date=e.data.transactionDate:"SUMMARY"===e.clickedOn&&(e.date=e.data.summaryDate);e.setUpData=function(){e.dateOptions={changeYear:!0,changeMonth:!0,minDate:tzIndependentDate(o),maxDate:tzIndependentDate(i),yearRange:"-100:+0",onSelect:function(t,n){"FROM"===e.clickedOn?(e.data.fromDate=e.date,e.data.toDate=e.date,e.broadcastFromRoot("fromDateChanged",e.data.fromDate)):"TO"===e.clickedOn?(e.data.toDate=e.date,e.broadcastFromRoot("toDateChanged")):"CASHIER"===e.clickedOn?(e.data.cashierDate=e.date,e.broadcastFromRoot("cashierDateChanged")):"TRANSACTIONS"===e.clickedOn?(e.data.transactionDate=e.date,e.broadcastFromRoot("transactionDateChanged")):"SUMMARY"===e.clickedOn?(e.data.summaryDate=e.date,e.broadcastFromRoot("summaryDateChanged")):"BALANCE"===e.clickedOn&&(e.data.balanceDate=e.date,e.broadcastFromRoot("balanceDateChanged")),a.close()}}},e.setUpData()}]),angular.module("sntRover").service("RVAccountsReceivablesSrv",["$http","$q","BaseWebSrvV2",function(e,t,a){var n=this;n.fetchAccountsReceivables=function(e){var n=t.defer(),o="/api/accounts/ar_overview";return a.getJSON(o,e).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise}}]),angular.module("sntRover").service("RVAutoChargeSrv",["$http","$q","rvBaseWebSrvV2",function(e,t,a){var n=this;n.stateData={},n.getStateData=function(){return n.stateData},n.setStateData=function(e){n.stateData=e},n.fetchAutoCharge=function(e){var t="/api/hotels/auto_charge_deposit_report";return a.getJSON(t,e)},n.fetchEodAutoCharge=function(e){var t="/api/auto_charge/auto_charge_checkout";return a.getJSON(t,e)},n.processAutoCharges=function(e){var t="/api/reservations/re_process_auto_charge";return a.postJSON(t,e)}}]),angular.module("sntRover").service("RVBudgetsSrv",["$q","BaseWebSrvV2",function(e,t){this.getBudgetAssociatedTypes=function(){var a=e.defer(),n="/admin/budget_associated_types";return t.getJSON(n).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.getBudgetData=function(a){var n=e.defer(),o="/admin/budgets";return t.getJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.saveBudget=function(a){var n=e.defer(),o="/admin/budgets";return t.postJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.updateBudget=function(a){var n=e.defer(),o="/admin/update_budgets";return t.putJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise}}]),angular.module("sntRover").service("RVccTransactionsSrv",["$http","$q","BaseWebSrvV2","RVBaseWebSrv","$rootScope",function(e,t,a,n,o){var i=this;this.fetchAuthData=function(){return a.getJSON("/api/cc?type=authorization")},i.fetchPayments=function(e){var t="/api/cc?date="+(e.date||o.businessDate);return a.getJSON(t)},i.submitBatch=function(){var e=t.defer(),n="/api/cc/batch_settle";return a.postJSON(n).then(function(t){e.resolve(t)},function(t){e.reject(t)}),e.promise},i.updateCache=function(e){i.ccTransactionData=e},i.getCache=function(){return i.ccTransactionData}}]),sntRover.service("RVCommissionsSrv",["$http","$q","BaseWebSrvV2",function(e,t,a){var n=this;n.fetchCommissions=function(e){var n=t.defer(),o="/api/accounts/commission_overview";return a.getJSON(o,e).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},n.printCommissionOverview=function(e){var n=t.defer(),o="/api/accounts/print_commission_overview";return a.postJSON(o,e).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},n.fetchReservationOfCommissions=function(e){var n=t.defer(),o="/api/accounts/"+e.id+"/commissionable_reservations_data";return a.getJSON(o,e).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},n.updateCommissionPaidStatus=function(e){var n=t.defer(),o="/api/accounts/update_commission_paid_status";return a.postJSON(o,e).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},n.exportCommissions=function(e){var n=t.defer(),o="/api/reports/unpaid_commission_export";return a.postJSON(o,e).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.filterData={page:1,perPage:50,innerPerPage:25,searchQuery:"",minAmount:"",selectedExportType:"standard",receipientEmail:"",billStatus:{value:"PAID",name:"PAID"},sort_by:{value:"NAME_ASC",name:"NAME_ASC"},filterTab:"PAYABLE",billStatusOptions:[{value:"OPEN",name:"OPEN"},{value:"PAID",name:"PAID"},{value:"ALL",name:"ALL"}],sortOptions:[{value:"NAME_ASC",name:"NAME ASC"},{value:"NAME_DESC",name:"NAME DESC"},{value:"AMOUNT_ASC",name:"AMOUNT ASC"},{value:"AMOUNT_DESC",name:"AMOUNT DESC"}],non_commissionable:!1},n.onyxExportCommissions=function(e){var n=t.defer(),o="/api/reports/onyx_commission_export";return a.postJSON(o,e).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},n.fetchExportTypeData=function(){var e=t.defer(),n="/api/accounts/fetch_enabled_commission_interface";return a.getJSON(n).then(function(t){e.resolve(t)},function(t){e.reject(t)}),e.promise},this.fetchHotelBusinessDate=function(){var e=t.defer(),n="/api/business_dates/active";return a.getJSON(n).then(function(t){e.resolve(t)},function(t){e.reject(t)}),e.promise}}]),angular.module("sntRover").service("RVInvoiceSearchSrv",["$http","$q","sntBaseWebSrv",function(e,t,a){var n=this;n.searchForInvoice=function(e){var n=t.defer(),o="/api/bills/search_invoice";return a.getJSON(o,e).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},n.getFilterOptions=function(e){var n=t.defer(),o="/api/bills/invoice_filter_options";return a.getJSON(o,e).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.triggerPaymentReceipt=function(e){var n=t.defer(),o="/api/bills/fiskalize_payment";return a.postJSON(o,e).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise}}]),angular.module("sntRover").service("RVJournalSrv",["$http","$q","BaseWebSrvV2","RVBaseWebSrv","$rootScope","sntBaseWebSrv",function(e,t,a,n,o,i){this.filterData={},this.revenueData={},this.paymentData={};var r=this;this.fetchGenericData=function(){r.fetchCashiers=function(){var t="/api/cashier_periods",n={date:o.businessDate};a.getJSON(t,n).then(function(t){r.filterData.cashiers=t.cashiers,r.filterData.selectedCashier=t.current_user_id,r.filterData.loggedInUserId=t.current_user_id,r.filterData.cashierStatus=t.status,e.resolve(r.filterData)},function(t){e.reject(t)})};var e=t.defer(),n="/api/users/active.json?journal=true";
return a.getJSON(n).then(function(e){r.filterData.employees=e,angular.forEach(r.filterData.employees,function(e,t){e.checked=!1,e.name=e.full_name,delete e.full_name,delete e.email}),r.fetchCashiers()},function(t){e.reject(t)}),e.promise},r.fetchDepartments=function(){var e=t.defer(),a="/admin/departments.json";return n.getJSON(a).then(function(t){angular.forEach(t.departments,function(e,t){e.checked=!1,e.id=e.value,delete e.value}),e.resolve(t)},function(t){e.reject(t)}),e.promise},r.getFilterData=function(){var e=t.defer(),a="/api/financial_transactions/journal_filter_options";return i.getJSON(a).then(function(t){e.resolve(t)},function(t){e.reject(t)}),e.promise},r.fetchSummaryData=function(e){var n=t.defer(),o="api/financial_transactions/daily_balance_details";return a.getJSON(o,e).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},r.fetchPrintDateTime=function(){var e=t.defer(),n="api/financial_transactions/print_date_time";return a.getJSON(n).then(function(t){e.resolve(t)},function(t){e.reject(t)}),e.promise},r.fetchBalanceDetails=function(e){var n=t.defer(),o="api/financial_transactions/daily_balance_details";return a.postJSON(o,e).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},r.fetchBalanceTabDetails=function(e){var n=t.defer(),o="api/financial_transactions/journal_balance_details";return a.getJSON(o,e).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchRevenueDataByChargeGroups=function(e){"undefined"==typeof e.charge_group_id&&(e.charge_group_id="");var n=t.defer(),o="/api/financial_transactions/revenue_by_charge_groups";return a.postJSON(o,e).then(function(e){angular.forEach(e.charge_groups,function(e,t){e.active=!1}),n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchRevenueDataByChargeCodes=function(e){"undefined"==typeof e.charge_code_id&&(e.charge_code_id="");var n=t.defer(),o="/api/financial_transactions/revenue_by_charge_codes";return a.postJSON(o,e).then(function(e){angular.forEach(e.charge_codes,function(e,t){e.active=!1}),n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchRevenueDataByTransactions=function(e){var n=t.defer(),o="/api/financial_transactions/revenue_by_transactions";return a.postJSON(o,e).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchPaymentDataByPaymentTypes=function(e){"undefined"==typeof e.charge_code_id&&(e.charge_code_id="");var n=t.defer(),o="/api/financial_transactions/payments_by_payment_types";return a.postJSON(o,e).then(function(e){angular.forEach(e.payment_types,function(e,t){"Credit Card"===e.payment_type?angular.forEach(e.credit_cards,function(e,t){e.active=!1}):e.active=!1}),n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchPaymentDataByTransactions=function(e){var n=t.defer(),o="/api/financial_transactions/payments_by_transactions";return a.postJSON(o,e).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchCashierDetails=function(e){var n=t.defer(),o="/api/cashier_periods/history";return a.postJSON(o,e).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.reOpenCashier=function(e){var n=t.defer(),o="/api/cashier_periods/"+e.id+"/reopen";return a.postJSON(o).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.closeCashier=function(e){var n=t.defer(),o="/api/cashier_periods/"+e.id+"/close";return a.postJSON(o,e.data).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise}}]),angular.module("sntRover").service("RVMultiCurrencyExchangeSrv",["$http","$q","BaseWebSrvV2",function(e,t,a){var n=this;n.fetchExchangeRates=function(e){var n=t.defer(),o="/api/exchange_rates/current_exchange_rates";return a.getJSON(o,e).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},n.saveExchangeRates=function(e){var n=t.defer(),o="/api/exchange_rates/save_exchange_rates";return a.postJSON(o,e).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise}}]),angular.module("sntRover").service("rvAccountsArTransactionsSrv",["$q","rvBaseWebSrvV2",function(e,t){this.fetchTransactionDetails=function(a){var n=e.defer(),o="/api/accounts/"+a.account_id+"/ar_transactions";return t.getJSON(o,a.getParams).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchBillPrintData=function(a){var n=e.defer(),o="/api/accounts/"+a.account_id+"/ar_transactions/"+a.id+"/print_ar_invoice";return t.postJSON(o,a).then(function(e){e.charge_details_list=[],e.credit_details_list=[],angular.forEach(e.fee_details,function(t,a){angular.forEach(t.charge_details,function(a,n){a.date=t.date,e.charge_details_list.push(a)}),angular.forEach(t.credit_details,function(a,n){a.date=t.date,e.credit_details_list.push(a)})}),n.resolve(e)},function(e){n.reject(e)}),n.promise},this.sendEmail=function(a){var n=e.defer(),o="/api/accounts/"+a.account_id+"/ar_transactions/"+a.id+"/email_ar_invoice";return t.postJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.saveArBalance=function(a){var n=e.defer(),o="/api/accounts/"+a.account_id+"/ar_transactions/create_manual_balances";return t.postJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchPaymentMethods=function(a){var n=e.defer(),o="api/accounts/"+a.id+"/ar_transactions/payments_for_allocation";return t.getJSON(o).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.paySelected=function(a){var n=e.defer(),o="/api/accounts/"+a.account_id+"/ar_transactions/allocate_payment";return t.postJSON(o,a.data).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.holdSelectedInvoices=function(a){var n=e.defer(),o="/api/accounts/"+a.account_id+"/ar_transactions/add_hold";return t.putJSON(o,a.data).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.releaseSelectedInvoices=function(a){var n=e.defer(),o="/api/accounts/"+a.account_id+"/ar_transactions/release_hold";return t.putJSON(o,a.data).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.expandPaidAndUnpaidList=function(a){var n=e.defer(),o="/api/accounts/"+a.account_id+"/ar_transactions/"+a.id+"/invoice_details";return t.getJSON(o).then(function(e){n.resolve(e.data)},function(e){n.reject(e)}),n.promise},this.fetchArStatementData=function(a){var n=e.defer(),o="/api/ar_transactions/get_email?id="+a.id;return t.getJSON(o).then(function(e){n.resolve(e.data)},function(e){n.reject(e)}),n.promise},this.fetchArStatementPrintData=function(a){var n=e.defer(),o="/api/ar_transactions/print";return t.postJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.emailArStatement=function(a){var n=e.defer(),o="/api/ar_transactions/email";return t.postJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.expandPaidAndUnpaidList=function(a){var n=e.defer(),o="/api/accounts/"+a.account_id+"/ar_transactions/"+a.id+"/invoice_details";return t.getJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.expandAllocateAndUnallocatedList=function(a){var n=e.defer(),o="/api/accounts/"+a.account_id+"/ar_transactions/"+a.id+"/payment_details";return t.getJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.getUnAllocateDetails=function(a){var n=e.defer(),o="/api/accounts/"+a.account_id+"/ar_transactions/"+a.id+"/payment_details";return t.getJSON(o).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.unAllocateSelectedPayment=function(a){var n=e.defer(),o="/api/accounts/"+a.account_id+"/ar_transactions/unallocate_payment";return t.postJSON(o,a.data).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.unAllocateData=function(a){var n=e.defer(),o="/api/accounts/"+a.account_id+"/ar_transactions/unallocate_info";return t.getJSON(o,a.data).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchAccountsReceivables=function(a){var n=e.defer(),o="/api/accounts/ar_overview";return t.getJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.moveInvoice=function(a){var n=e.defer(),o="/api/accounts/"+a.account_id+"/ar_transactions/move_invoice";return t.postJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.getAdjustmentInfo=function(a){var n=e.defer(),o="api/accounts/"+a.accountId+"/ar_transactions/"+a.arTransactionId+"/adjustment_info";return t.postJSON(o,a.requestParams).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.postAdjustmentInfo=function(a){var n=e.defer(),o="api/accounts/"+a.accountId+"/ar_transactions/"+a.arTransactionId+"/post_adjustment";return t.postJSON(o,a.postData).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.moveToCreditInvoice=function(a){var n=e.defer(),o="/api/accounts/"+a.account_id+"/ar_transactions/post_manual_credit";return t.postJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.lockBill=function(a){var n=e.defer(),o="/api/accounts/"+a.account_id+"/ar_transactions/"+a.id+"/ar_final_invoice_settlement";return t.postJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.moveZeroInvoiceAsPaid=function(a){var n=e.defer(),o="/api/accounts/"+a.account_id+"/ar_transactions/move_zero_invoices_as_paid";return t.postJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise}}]),angular.module("sntRover").service("rvAccountsConfigurationSrv",["$q","rvBaseWebSrvV2",function(e,t){var a=this;this.baseAccountSummaryData={posting_account_id:"",posting_account_name:"",posting_account_number:"",posting_account_type:"HOUSE",posting_account_status:"OPEN",demographics:{market_segment_id:"",source_id:"",booking_origin_id:""},notes:[],travel_agent:null,company:null},this.getAccountSummary=function(n){var o=e.defer();if("NEW_ACCOUNT"===n.accountId)o.resolve(angular.copy(a.baseAccountSummaryData));else{var i="api/posting_accounts/"+n.accountId;t.getJSON(i).then(function(e){o.resolve(e)},function(e){o.reject(e)})}return o.promise},this.updateAccountSummary=function(a){var n=e.defer(),o="api/posting_accounts/"+a.summary.posting_account_id;return t.putJSON(o,a.summary).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.updateBillingRefNumber=function(a){var n=e.defer(),o="api/posting_accounts/"+a.summary.posting_account_id;return a.summary.custom_reference_number=a.custom_reference_number,t.putJSON(o,a.summary).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.saveAccountSummary=function(a){var n=e.defer(),o="api/posting_accounts";return t.postJSON(o,a.summary).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.saveAccountNote=function(a){var n=e.defer(),o="api/posting_accounts/save_posting_account_note";return t.postJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.updateAccountNote=function(a){var n=e.defer(),o="api/notes/"+a.id;return t.putJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.removeAccountNote=function(a){var n=e.defer(),o="api/posting_accounts/delete_posting_account_note";return t.deleteJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.emailInvoice=function(a){var n=e.defer(),o="api/posting_accounts/email_bill_card";return t.postJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise}}]),angular.module("sntRover").service("rvAccountsSrv",["$q","rvBaseWebSrvV2",function(e,t){this.DEFAULT_PER_PAGE=50,this.DEFAULT_PAGE=1,this.getAccountsList=function(a){var n=e.defer(),o="/api/posting_accounts/search",i={q:a.query,status:a.status,per_page:a.per_page,page:a.page,account_type:a.account_type,is_non_zero:a.is_non_zero};return t.getJSON(o,i).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise}}]),angular.module("sntRover").service("rvAccountTransactionsSrv",["$q","rvBaseWebSrvV2","$rootScope",function(e,t,a){this.fetchGroupAllowances=function(e){var a="/api/groups/"+e.id+"/group_allowance_transactions";return t.getJSON(a,{associated_type:e.type}).then(function(e){var t={dataByAllowance:[],dataByDate:[]};e.allowance_data=_.map(e.allowance_data,function(e){return e.ptime=parseInt(e.time.replace(":",""),10),e});try{e.allowance_data&&e.allowance_data.length&&(t.dataByAllowance=_.groupBy(e.allowance_data,function(e){return e.addon_id}),t.dataByDate=_.groupBy(e.allowance_data,function(e){return e.date}),_.each(t.dataByAllowance,function(e,a){t.dataByAllowance[a]=_.sortBy(e,function(e){return e.ptime})}),_.each(t.dataByDate,function(e,a){t.dataByDate[a]=_.sortBy(e,function(e){return e.ptime})}))}catch(e){console.error(e)}return t},function(){})},this.searchAllowanceShares=function(a){var n=e.defer(),o="/api/groups/"+a.groupId+"/group_allowance_search";return t.getJSON(o,{query:a.query,associated_type:a.type}).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.saveAllowanceShares=function(a){var n=e.defer(),o="/api/groups/"+a.groupId+"/group_allowance_share";return t.postJSON(o,{shared_allowances:a.data,associated_type:a.type}).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchTransactionDetails=function(a){var n=e.defer(),o="/api/posting_accounts/"+a.account_id+"/bill_card";return t.getJSON(o).then(function(e){angular.forEach(e.bills,function(e){e.page_no=1,e.transactions=[],e.activeDate=e.days.length>0?_.last(e.days).date:null}),n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchBillTransactionDetails=function(a){var n=e.defer(),o="/api/bills/"+a.bill_id+"/transactions?date="+a.date+"&page="+a.page+"&per_page="+a.per_page;return t.getJSON(o).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.createAnotherBill=function(a){var n=e.defer(),o="api/bills/create_bill";return t.postJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.moveToAnotherBill=function(a){var n=e.defer(),o="api/bills/transfer_transaction";return t.postJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.transactionEdit=function(a){var n=e.defer(),o=a.id,i=a.updatedDate,r="api/financial_transactions/"+o;return t.putJSON(r,i).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.transactionEditChargeDescription=function(a){var n=e.defer(),o="api/financial_transactions/"+a.id+"/save_custom_description";return t.postJSON(o,a.postData).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.transactionDelete=function(a){var n=e.defer(),o=a.id,i="api/financial_transactions/"+o;return t.putJSON(i,a.data).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.transactionSplit=function(a){var n=e.defer(),o=a.id,i="api/financial_transactions/"+o;return t.putJSON(i,a.data).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.savePaymentDetails=function(a){var n=e.defer(),o="/api/bills/"+a.bill_id+"/add_payment_method";return t.postJSON(o,a.data_to_pass).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.submitPaymentOnBill=function(n){var o=0,i=function(){o++},r=setInterval(i,1e3),s=e.defer(),c="/api/bills/"+n.bill_id+"/submit_payment",l=function e(n){if(o>=a.emvTimeout){var i=["Request timed out. Unable to process the transaction"];s.reject(i)}else t.getJSONWithSpecialStatusHandling(n).then(function(t){t.status&&"processing_not_completed"===t.status||"null"===t?setTimeout(function(){console.info("POLLING::-> for emv terminal response"),e(n)},5e3):(clearInterval(r),s.resolve(t))},function(t){"undefined"==typeof t?e(n):(clearInterval(r),s.reject(t))})};return t.postJSONWithSpecialStatusHandling(c,n.data_to_pass).then(function(e){n.data_to_pass.is_emv_request&&e.status&&"processing_not_completed"===e.status?l(e.location_header):(clearInterval(r),s.resolve(e))},function(e){clearInterval(r),s.reject(e)}),s.promise},this.postCharges=function(a){var n=e.defer(),o="/staff/items/post_items_to_bill";return t.postJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.checkForArAccount=function(a){var n=e.defer(),o="/api/posting_accounts/"+a.account_id+"/check_ar_account_attached";return t.getJSON(o).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchAccountBillsForPrint=function(a){var n=e.defer(),o="/api/posting_accounts/print_bill_card";return t.postJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.groupChargeDetailsFetch=function(a){var n=e.defer(),o="/api/posting_accounts/transaction_details";return t.getJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise}}]),sntRover.controller("companyCardCommissionsCtrl",["$scope","$state","$rootScope","$stateParams","RVCompanyCardSrv","ngDialog","$timeout","rvPermissionSrv","rvUtilSrv","$window","$vault","sntActivity",function(e,t,a,n,o,i,r,s,c,l,d,u){BaseCtrl.call(this,e);var m=function(){var t={};return e.filterData.fromDate&&(t.from_date=e.filterData.fromDate),e.filterData.toDate&&(t.to_date=e.filterData.toDate),t.paid_status=e.filterData.paidStatus,t.commission_status=e.filterData.commissionStatus,t.per_page=e.filterData.perPage,t.page=e.filterData.page,t.hotel_id=parseInt(e.filterData.selectedHotel),t};e.setScroller("commission-list");var f=function(){r(function(){e.refreshScroller("commission-list")},3e3)};f(),e.$on("commissionsTabActive",function(){v(!0)});var p=function(t){e.filterData.page=t||1,v(!0)},v=function(t){var a=function(){e.filterData.commissionsLoaded||"COMMISION_SUMMARY"!==n.origin||u.stop("NAVIGATING_TO_TA_COMMISSIONS")},i=function(t){_.each(t.commission_details,function(e,t){_.extend(e,{is_checked:!1})}),e.currencySymbol=t.currency.symbol,e.commissionDetails=t.commission_details,e.commissionSummary.totalCommissionableRevenue=t.total_commissionable_revenue,e.commissionSummary.totalReservationsRevenue=t.total_reservations_revenue,e.commissionSummary.totalCommission=t.total_commission-t.total_commission_unpaid,e.commissionSummary.totalUnpaidCommission=t.total_commission_unpaid,e.commissionSummary.taxOnCommissions=t.tax_on_commissions,e.pagination.totalResultCount=t.total_count,r(function(){e.$broadcast("updatePagination",e.paginationData.id)},1e3),e.$emit("hideLoader"),f(),a(),e.filterData.commissionsLoaded=!0,y()},s=function(t){e.$emit("hideLoader"),e.commissionDetails=[],e.commissionSummary={},a()},c={};c.params=m(),c.accountId=e.accountId,"add"!==e.accountId&&e.invokeApi(o.fetchTACommissionDetails,c,i,s)};e.hasPermissionToEditPaid=function(){return s.getPermissionValue("EDIT_COMMISSIONS_TAB")},e.goToStayCard=function(n,o){a.hotelDetails.userHotelsData.current_hotel_id===parseInt(e.filterData.selectedHotel)&&t.go("rover.reservation.staycard.reservationcard.reservationdetails",{id:n,confirmationId:o,isrefresh:!0,isFromTACommission:!0},{reload:!0})},e.clearToDateField=function(){e.filterData.toDate="",e.onFilterChange()},e.clearFromDateField=function(){e.filterData.fromDate="",e.onFilterChange()},e.shouldShowPagination=function(){return e.commissionDetails.length>0&&e.pagination.totalResultCount>e.filterData.perPage},e.$on("fromDateChanged",function(){e.onFilterChange()}),e.$on("toDateChanged",function(){e.onFilterChange()}),e.onFilterChange=function(){e.selectedCommissions=[],e.prePaidCommissions=[],v(!0)},e.clickedFromDate=function(){e.popupCalendar("FROM")},e.clickedToDate=function(){e.popupCalendar("TO")},e.popupCalendar=function(t){e.clickedOn=t,i.open({template:"/assets/partials/companyCard/contracts/rvCompanyCardContractsCalendar.html",controller:"RVCommissionsDatePickerController",className:"",scope:e})};var h=function(t){var a=0,n=0,o=0;t.forEach(function(e){isEmptyObject(e.commission_data)||("Unpaid"===e.commission_data.paid_status||"On Hold"===e.commission_data.paid_status?a+=e.commission_data.amount:o+=e.commission_data.amount),n+=e.commissionable_revenue}),e.commissionSummary.totalUnpaidCommission=a,e.commissionSummary.totalRevenue=n,e.commissionSummary.totalCommission=o};e.onCheckBoxSelection=function(t){if(e.filterData.commssionRecalculationValue="",t.is_checked?"Prepaid"==t.commission_data.paid_status?e.prePaidCommissions.push(t):e.selectedCommissions.push(t):(e.selectedCommissions=_.filter(e.selectedCommissions,function(e){return e.reservation_id!=t.reservation_id}),e.prePaidCommissions=_.filter(e.prePaidCommissions,function(e){return e.reservation_id!=t.reservation_id}),e.filterData.selectAll=!1),0==e.selectedCommissions.length&&0==e.prePaidCommissions.length)v(!1),e.status.groupPaidStatus="";else{e.status.groupPaidStatus="";var a=e.selectedCommissions.concat(e.prePaidCommissions);h(a)}var n=_.every(e.commissionDetails,function(e){return e.is_checked});0===e.selectedCommissions.length&&0===e.prePaidCommissions.length?(e.filterData.selectAll=!1,e.toggleSelection()):n&&(e.filterData.selectAll=!0,e.toggleSelection())};var g=function(t){for(var a in e.commissionDetails)e.commissionDetails[a].is_checked=t};e.toggleSelection=function(){e.filterData.commssionRecalculationValue="",e.filterData.selectAll?(g(!0),e.selectedCommissions=Object.assign([],e.commissionDetails),e.prePaidCommissions=[],h(e.commissionDetails),e.status.groupPaidStatus=""):(g(!1),e.selectedCommissions=[],e.prePaidCommissions=[],v(!1),e.status.groupPaidStatus=""),e.isCommissionFilterTabOpened=!0};var D=function(t){var a=function(e){y(),v(!1)},n=function(e){y(),v(!1)};e.invokeApi(o.saveTACommissionDetails,t,a,n)},y=function(){e.selectedCommissions=[],e.prePaidCommissions=[],e.filterData.selectAll=!1};e.isTogglePaidStatusEnabled=function(){var t=!0;return e.contactInformation.is_global_enabled&&(t=!1,s.getPermissionValue("GLOBAL_CARD_UPDATE")&&(t=!0)),t},e.togglePaidStatus=function(t){var a={};a.reservation_id=t.reservation_id,a.status="Paid"==t.commission_data.paid_status?"Unpaid":"Paid";var n={};n.accountId=e.accountId,n.commissionDetails=[a],D(n)},e.toggleHoldStatus=function(t,a){if("Paid"==a.commission_data.paid_status||"Prepaid"==a.commission_data.paid_status)return e.errorMessage=["Only transactions on 'UNPAID' status can be set to On Hold"],void t.stopPropagation();var n={};n.reservation_id=a.reservation_id,n.status="On Hold"==a.commission_data.paid_status?"Unpaid":"On Hold";var o={};o.accountId=e.accountId,o.commissionDetails=[n],D(o)},e.onGroupPaidStatusChange=function(t){var a=[],n=!1;e.filterData.selectAll?e.commissionDetails.forEach(function(o){t&&"Unpaid"!=o.commission_data.paid_status&&"On Hold"!=o.commission_data.paid_status&&(n=!0),"Prepaid"!=o.commission_data.paid_status&&a.push({reservation_id:o.reservation_id,status:e.status.groupPaidStatus})}):e.selectedCommissions.forEach(function(o){t&&"Unpaid"!=o.commission_data.paid_status&&"On Hold"!=o.commission_data.paid_status&&(n=!0),"Prepaid"!=o.commission_data.paid_status&&a.push({reservation_id:o.reservation_id,status:e.status.groupPaidStatus})});var o={};o.accountId=e.accountId,o.commissionDetails=a,n?r(function(){e.errorMessage=["The hold status can be updated only for unpaid or on hold commissions"]},500):D(o)},e.showToggleButton=function(e){var t="Paid"==e.commission_data.paid_status||"Unpaid"==e.commission_data.paid_status;return t?{visibility:"visible"}:{visibility:"hidden"}};var S=function(){$("head").append("<style id='print-orientation'>@page { size: landscape; }</style>")},A=function(){$("#print-orientation").remove()};e.$on("CLEAR_ERROR_MESSAGE",function(){e.errorMessage=""}),e.clickedPrintButton=function(){S(),$("header .logo").addClass("logo-hide"),$("header .h2").addClass("text-hide");var e=function(){r(function(){$("header .logo").removeClass("logo-hide"),$("header .h2").addClass("text-hide"),A()},100)};r(function(){sntapp.cordovaLoaded?cordova.exec(e,function(t){e()},"RVCardPlugin","printWebView",["","0","","L"]):(l.print(),e())},100)},e.toggleCommission=function(){e.filterData.toggleCommission=!e.filterData.toggleCommission};var C=function(){var t=[];return e.filterData.selectAll?e.commissionDetails.forEach(function(e){"Prepaid"!=e.commission_data.paid_status&&t.push(e.reservation_id)}):e.selectedCommissions.forEach(function(e){"Prepaid"!=e.commission_data.paid_status&&t.push(e.reservation_id)}),t},I=function(){var t="percent";return e.filterData.toggleCommission&&(t="amount"),t};e.recalculationValueChanged=function(){isNaN(e.filterData.commssionRecalculationValue)&&(e.filterData.commssionRecalculationValue="")},e.clickedRecalculate=function(){var t=function(e){y(),r(function(){v(!1)},2e3)},a=function(t){e.errorMessage=t,e.$emit("hideLoader")},n={type:I(),value:e.filterData.commssionRecalculationValue,reservation_ids:C()};e.invokeApi(o.recalculateCommission,n,t,a)};var b=function(){var t=function(t){e.multiProperies=t.multi_properties,e.$emit("hideLoader")},a={};a.accountId="add"===e.accountId?e.contactInformation.id:e.accountId,e.invokeApi(o.fetchMultiProperties,a,t)};e.toggleFilter=function(){e.isCommissionFilterTabOpened=!e.isCommissionFilterTabOpened},e.$on("LOAD_SUBSCRIBED_MPS",function(){e.contactInformation.is_global_enabled&&a.isAnMPHotel&&s.getPermissionValue("GLOBAL_CARD_UPDATE")&&a.hotelDetails.userHotelsData.hotel_list.length>0&&s.getPermissionValue("MULTI_PROPERTY_SWITCH")?(e.shouldShowPropertyDropDown=!0,b()):(e.shouldShowPropertyDropDown=!1,E())}),e.onPropertyFilterChange=function(){a.hotelDetails.userHotelsData.current_hotel_id!==parseInt(e.filterData.selectedHotel)&&(e.filterData.commissionStatus="Commissionable"),e.onFilterChange()};var E=function(){e.commissionDetails=[],e.commissionSummary={},e.isCommissionFilterTabOpened=!0,e.shouldShowPropertyDropDown=!1,e.filterData={fromDate:n.fromDate,toDate:n.toDate,paidStatus:"Unpaid",commissionStatus:"Commissionable",perPage:25,page:1,start:1,selectAll:!1,toggleCommission:!1,commssionRecalculationValue:"",selectedHotel:parseInt(a.hotelDetails.userHotelsData.current_hotel_id),commissionsLoaded:!1},e.accountId="rover.reservation.staycard.reservationcard.reservationdetails"===t.current.name?e.travelAgentInformation.id:n.id,e.isEmpty=c.isEmpty,e.isEmptyObject=isEmptyObject,e.pagination={start:1,end:o.DEFAULT_PER_PAGE,totalResultCount:0},e.selectedCommissions=[],e.prePaidCommissions=[],e.status={groupPaidStatus:""},e.businessDate=a.businessDate,"cc-commissions"===e.currentSelectedTab&&v(!0),"rover.companycarddetails"===t.current.name&&(d.set("travelAgentId",n.id),d.set("travelAgentType",n.type),d.set("travelAgentQuery",n.query)),e.paginationData={id:"RESERVATION_LIST_"+e.accountId,api:p,perPage:e.filterData.perPage}};E()}]),angular.module("sntRover").controller("companyCardDetailsController",["$scope","RVCompanyCardSrv","rvCompanyCardContractsSrv","$state","$stateParams","ngDialog","$filter","$timeout","$rootScope","rvPermissionSrv","$interval","$log",function(e,t,a,n,o,i,r,s,c,l,d,u){e.isAddNewCard="add"===o.id,e.disableGlobalToggle=!e.isAddNewCard;var m=[];e.hasPermissionToViewCommissionTab=function(){return l.getPermissionValue("VIEW_COMMISSIONS_TAB")},e.hasPermissionToCreateArAccount=function(){return l.getPermissionValue("CREATE_AR_ACCOUNT")},e.isCommissionTabAvailable=e.hasPermissionToViewCommissionTab(),e.isDiscard=!1,e.isPromptOpened=!1,e.isLogoPrint=!0,e.isPrintArStatement=!1,e.contactInformation={},e.isGlobalToggleReadOnly=!l.getPermissionValue("GLOBAL_CARD_UPDATE");var f=!1;"COMPANY"===o.type?(e.isAddNewCard?e.heading=r("translate")("NEW_COMPANY_CARD"):e.heading=r("translate")("COMPANY_CARD"),e.cardTypeText=r("translate")("COMPANY"),e.dataIdHeader="company-card-header"):"TRAVELAGENT"===o.type&&(e.isAddNewCard?e.heading=r("translate")("NEW_TA_CARD"):e.heading=r("translate")("TA_CARD"),e.cardTypeText=r("translate")("TRAVELAGENT"),e.dataIdHeader="travel-agent-card-header"),e.setTitle(e.heading),e.$on("ARTransactionSearchFilter",function(t,a){e.isWithFilters=a});var p=function(){"rvAllotmentConfigurationCtrl"===c.previousState.controller?e.searchBackButtonCaption=r("translate")("ALLOTMENTS"):"rvGroupConfigurationCtrl"===c.previousState.controller?e.searchBackButtonCaption=r("translate")("GROUPS"):"rvAccountsConfigurationCtrl"===c.previousState.controller?e.searchBackButtonCaption=r("translate")("ACCOUNTS"):"AR_OVERVIEW"===o.origin?e.searchBackButtonCaption=r("translate")("MENU_ACCOUNTS_RECEIVABLES"):"COMMISION_SUMMARY"===o.origin?e.searchBackButtonCaption=r("translate")("MENU_COMMISIONS"):o.isMergeViewSelected?e.searchBackButtonCaption=r("translate")("MERGE_CARDS"):e.searchBackButtonCaption=r("translate")("FIND_CARDS")};c.$broadcast("viewFromCardsOutside"),p(),e.headerBackButtonClicked=function(){return"cc-contact-info"===e.currentSelectedTab?void b(e.contactInformation,!1,!0):("cc-contracts"===e.currentSelectedTab?e.$broadcast("saveContract"):"cc-ar-accounts"===e.currentSelectedTab&&e.$broadcast("saveArAccount"),void("COMMISION_SUMMARY"===o.origin?n.go("rover.financials.commisions"):n.go(c.previousState,c.previousStateParams)))},e.isContactInformationSaved=!1,BaseCtrl.call(this,e),e.currentSelectedTab="cc-contact-info","undefined"!=typeof o.type&&""!==o.type&&(e.account_type=o.type),e.companyCardClicked=function(t){t.stopPropagation(),getParentWithSelector(t,document.getElementById("cc-contact-info"))&&"cc-contact-info"===e.currentSelectedTab||getParentWithSelector(t,document.getElementById("cc-contracts"))&&"cc-contracts"===e.currentSelectedTab||(getParentWithSelector(t,document.getElementById("company-card-nested-first"))&&e.$emit("saveContactInformation"),getParentWithSelector(t,document.getElementById("cc-ar-accounts"))||e.$broadcast("saveArAccount"),e.$broadcast("CLEAR_ERROR_MESSAGE"))},e.$on("ERRORONARTAB",function(t){e.isArTabAvailable=!0,e.switchTabTo("","cc-ar-accounts")}),e.showArAccountButtonClick=function(t){e.switchTabTo(t,"cc-ar-accounts")},e.switchTabTo=function(t,a){void 0!==t&&""!==t&&(t.stopPropagation(),t.stopImmediatePropagation());var n=!!e.contactInformation&&!!e.contactInformation.account_details&&!!e.contactInformation.account_details.accounts_receivable_number;if("cc-contact-info"===e.currentSelectedTab&&"cc-contact-info"!==a){if(e.isAddNewCard&&!e.isContactInformationSaved)return e.errorMessage=["Please save "+e.cardTypeText+" card first"],void("COMPANY"===o.type?e.$broadcast("setCardContactErrorMessage",[r("translate")("COMPANY_SAVE_PROMPT")]):e.$broadcast("setCardContactErrorMessage",[r("translate")("TA_SAVE_PROMPT")]));"cc-ar-accounts"===a?e.showARTab():(b(e.contactInformation),e.$broadcast("ContactTabActivated"))}"cc-contracts"===e.currentSelectedTab&&"cc-contracts"!==a?e.$broadcast("saveContract"):"cc-ar-accounts"===e.currentSelectedTab&&"cc-ar-accounts"!==a&&e.$broadcast("saveArAccount"),"cc-ar-accounts"===a&&(e.$broadcast("arAccountTabActive"),e.$broadcast("refreshAccountsScroll")),"cc-contracts"===a&&e.$broadcast("refreshContractsScroll"),"cc-ar-transactions"===a&&n&&(c.$broadcast("arTransactionTabActive"),e.isWithFilters=!1),"cc-notes"===a&&e.$broadcast("fetchNotes"),"cc-contact-info"===a&&e.$broadcast("contactTabActive"),"cc-commissions"===a&&e.$broadcast("commissionsTabActive"),"cc-activity-log"===a&&e.$broadcast("activityLogTabActive"),"statistics"===a&&e.$broadcast("LOAD_STATISTICS"),"wallet"===a&&e.$broadcast("wallet"),"cc-ar-transactions"!==a||n?e.currentSelectedTab=a:console.warn("Save AR Account and Navigate to AR Transactions")},e.openCompanyTravelAgentCardMandatoryFieldsPopup=function(){e.shouldSaveArDataFromPopup=!1,i.open({template:"/assets/partials/companyCard/rvCompanyTravelAgentCardMandatoryFieldsPopup.html",className:"ngdialog-theme-default1 calendar-single1",controller:"companyTravelAgentMandatoryFieldsController",closeByDocument:!1,scope:e})},e.clickedCreateArAccountButton=function(){e.shouldShowARMandatoryPopup()?(f=!0,e.showARTab()):(e.isMandatoryPopupOpen=!0,e.openCompanyTravelAgentCardMandatoryFieldsPopup())},e.$on("UPDATE_MANDATORY_POPUP_OPEN_FLAG",function(){e.isMandatoryPopupOpen=!1}),e.showARTab=function(){b(e.contactInformation)},e.$on("saveArAccountFromMandatoryPopup",function(t,a){
e.arAccountDetails=a,e.isArTabAvailable=!0,e.shouldSaveArDataFromPopup=!0,e.contactInformation.account_details.accounts_receivable_number=a.ar_number}),e.$on("UPDATE_AR_ACCOUNT_DETAILS_AFTER_DELETE",function(t,a){e.arAccountDetails=a}),o.isBackFromStaycard||(o.isMergeViewSelected?c.prevStateBookmarkDataFromAR={title:e.searchBackButtonCaption,name:c.previousState.name}:c.prevStateBookmarkDataFromAR={title:e.searchBackButtonCaption,name:c.previousState.name}),o.isBackFromStaycard&&(e.isArTabAvailable=!o.isBackToTACommission&&!o.isBackToStatistics,c.prevStateBookmarkDataFromAR.title!==r("translate")("FIND_CARDS")&&c.prevStateBookmarkDataFromAR.title!==r("translate")("MENU_ACCOUNTS_RECEIVABLES")||(c.setPrevState={title:c.prevStateBookmarkDataFromAR.title,name:c.prevStateBookmarkDataFromAR.name}),"undefined"==typeof e.contactInformation&&(e.contactInformation=angular.copy(c.prevStateBookmarkDataFromAR.contactInformation)),o.isBackToStatistics?(e.currentSelectedTab="statistics",e.$broadcast("LOAD_STATISTICS")):e.isArTabAvailable&&(s(function(){e.currentSelectedTab="cc-ar-transactions",e.$broadcast("setgenerateNewAutoAr",!0),e.switchTabTo("","cc-ar-transactions")},500),s(function(){e.$broadcast("BACK_FROM_STAY_CARD")},1e3))),o.isBackToTACommission&&(e.currentSelectedTab="cc-commissions"),e.$on("ARNumberChanged",function(t,a){e.contactInformation.account_details.accounts_receivable_number=a.newArNumber,e.isMandatoryPopupOpen&&(e.arAccountDetails.payment_due_days=null,e.arAccountDetails.ar_number=a.newArNumber,e.openCompanyTravelAgentCardMandatoryFieldsPopup())}),e.deleteArAccount=function(){e.errorMessage="",i.open({template:"/assets/partials/companyCard/rvCompanyCardDeleteARaccountPopup.html",className:"ngdialog-theme-default1 calendar-single1",closeByDocument:!1,scope:e})},e.deleteARAccountConfirmed=function(){var a=function(){e.$emit("hideLoader"),e.isArTabAvailable=!1,e.$broadcast("setgenerateNewAutoAr",!1),e.$broadcast("ArAccountDeleted"),e.contactInformation.account_details.accounts_receivable_number="",i.close()},n={id:e.contactInformation.id};e.invokeApi(t.deleteArAccount,n,a)},e.clikedDiscardDeleteAr=function(){i.close()},e.toggleGlobalButton=function(){l.getPermissionValue("GLOBAL_CARD_UPDATE")&&(e.contactInformation.is_global_enabled=!e.contactInformation.is_global_enabled,e.contactInformation.account_type=e.account_type),s(function(){e.$broadcast("LOAD_SUBSCRIBED_MPS"),e.activateSelectedTab()},1e3)},e.activateSelectedTab=function(){"cc-contact-info"===e.currentSelectedTab&&(e.$broadcast("ContactTabActivated"),e.$broadcast("contactTabActive")),"cc-contracts"===e.currentSelectedTab&&e.$broadcast("refreshContractsScroll"),"cc-ar-accounts"===e.currentSelectedTab&&(e.$broadcast("arAccountTabActive"),e.$broadcast("refreshAccountsScroll")),"cc-ar-transactions"===e.currentSelectedTab&&(c.$broadcast("arTransactionTabActive"),e.isWithFilters=!1),"cc-notes"===e.currentSelectedTab&&e.$broadcast("fetchNotes"),"cc-commissions"===e.currentSelectedTab&&e.$broadcast("commissionsTabActive")},e.shouldShowCommissionsTab=function(){return"TRAVELAGENT"===e.account_type},e.isUpdateEnabled=function(t){if(void 0!==e.contactInformation.is_global_enabled){var a=!1;return e.contactInformation.is_global_enabled?l.getPermissionValue("GLOBAL_CARD_UPDATE")||(a=!0):l.getPermissionValue("EDIT_COMPANY_CARD")||(a=!0),t?a||!e.isUpdateEnabledForName():a}},e.isUpdateEnabledForTravelAgent=function(t){if(void 0!==e.contactInformation.is_global_enabled){var a=!1;return e.contactInformation.is_global_enabled?l.getPermissionValue("GLOBAL_CARD_UPDATE")||(a=!0):l.getPermissionValue("EDIT_TRAVEL_AGENT_CARD")||(a=!0),t?a||!e.isUpdateEnabledForName():a}},e.isUpdateEnabledForName=function(){var e=a.getContractedRates(),t=!0;return(e.current_contracts&&e.current_contracts.length>0||e.future_contracts&&e.future_contracts.length>0||e.history_contracts&&e.history_contracts.length>0)&&(t=!1),t};var v=function(){var a={id:e.contactInformation.id},n=function(t){e.$emit("hideLoader"),e.arAccountNotes=t,e.$broadcast("ARDetailsRecieved")},o=function(){e.invokeApi(t.fetchArAccountNotes,a,n)},i=function(t){e.$emit("hideLoader"),e.arAccountDetails=t,e.arAccountDetails.is_use_main_contact!==!1&&(e.arAccountDetails.is_use_main_contact=!0),e.arAccountDetails.is_use_main_address!==!1&&(e.arAccountDetails.is_use_main_address=!0),o()};e.invokeApi(t.fetchArAccountDetails,a,i)};e.addListener("MANDATORY_CHECK_FAILED",function(t,a){e.isArTabAvailable=!1,e.switchTabTo("","cc-contact-info"),e.mandatoryErrorMessage=a,e.openCompanyTravelAgentCardMandatoryFieldsPopup()});var h={},g=function(t){e.$emit("hideLoader"),e.contactInformation=t,e.contactInformation.emailStyleClass=c.roverObj.eInvoiceVisible?"margin":"full-width",e.$broadcast("LOAD_SUBSCRIBED_MPS"),e.$broadcast("UPDATE_CONTACT_INFO"),""!==e.contactInformation.alert_message&&(e.errorMessage=[e.contactInformation.alert_message]),"undefined"!=typeof o.id&&""!==o.id&&(e.contactInformation.id=o.id,v()),h=JSON.parse(JSON.stringify(e.contactInformation)),c.prevStateBookmarkDataFromAR.contactInformation=angular.copy(e.contactInformation),"AR_OVERVIEW"===o.origin?e.switchTabTo("","cc-ar-transactions"):"COMMISION_SUMMARY"===o.origin&&e.switchTabTo("","cc-commissions"),e.displayShowPropertiesButton=!e.contactInformation.commission_details.is_global_commission},D=function(t){e.$emit("hideLoader"),angular.isDefined(e.contactInformation.address_details)||(e.contactInformation.address_details={street1:"",street2:"",street3:"",city:"",state:"",postal_code:"",country_id:"",email_address:"",phone:"",fax:"",location:""}),angular.isDefined(e.contactInformation.primary_contact_details)||(e.contactInformation.primary_contact_details={contact_first_name:"",contact_last_name:"",contact_job_title:"",contact_phone:"",contact_email:""}),e.contactInformation.mandatoryFields=t.mandatoryFields,e.contactInformation.emailStyleClass=e.contactInformation.mandatoryFields.e_invoice_mandatory.is_visible?"margin":"full-width",e.contactInformation.commission_details=t.commission_details,e.displayShowPropertiesButton=!e.contactInformation.commission_details.is_global_commission},y=function(t){e.countries=t};e.invokeApi(t.fetchCountryList,A,y);var S=o.id;if(e.shouldShowStatisticsTab="add"!==o.id,"undefined"!=typeof S&&"add"===S)e.contactInformation={},"undefined"!=typeof o.query&&""!==o.query&&(e.contactInformation.account_details={organization_id:null,reg_tax_office:null,tax_number:null},e.contactInformation.account_details.account_name=o.query),e.arAccountNotes={},e.arAccountDetails={},h={},e.invokeApi(t.fetchCommissionDetailsAndMandatoryFields,A,D);else if("undefined"!=typeof S&&""!==S){var A={id:S};e.invokeApi(t.fetchContactInformationAndMandatoryFields,A,g)}var C=function(t,a,s){if(a&&i.close(),e.contactInformation.commission_details.is_global_commission&&angular.forEach(e.contactInformation.commission_details.other_hotels_info,function(t){t.commission_type=e.contactInformation.commission_details.commission_type,t.type=e.contactInformation.commission_details.type,t.value=e.contactInformation.commission_details.value,t.is_prepaid=e.contactInformation.commission_details.is_prepaid}),e.shouldSaveArDataFromPopup&&(e.shouldSaveArDataFromPopup=!1,e.$broadcast("UPDATE_AR_ACCOUNT_DETAILS",e.arAccountDetails),e.$broadcast("saveArAccount")),f)return f=!1,e.$broadcast("setgenerateNewAutoAr",!0),e.$broadcast("saveArAccount"),void(e.isArTabAvailable=!0);if("undefined"!=typeof t.id&&""!==t.id){var l=!!e.contactInformation.id;e.contactInformation.id=t.id,l||v()}else"undefined"!=typeof o.id&&""!==o.id&&(e.contactInformation.id=o.id);h=JSON.parse(JSON.stringify(e.contactInformation)),e.isAddNewCard&&(e.disableGlobalToggle=!1,"COMPANY"===o.type?e.heading=r("translate")("COMPANY_CARD"):"TRAVELAGENT"===o.type&&(e.heading=r("translate")("TA_CARD"))),e.isAddNewCard=!1,e.disableGlobalToggle=!0,e.errorMessage="",e.$broadcast("clearCardContactErrorMessage"),e.$broadcast("IDGENERATED",{id:t.id}),s&&n.go(c.previousState,c.previousStateParams)},I=function(t){return e.$broadcast("setCardContactErrorMessage",t),e.errorMessage=t,e.currentSelectedTab="cc-contact-info",!1},b=function(a,r,s){var l=!1;if(m=[],angular.equals(a,h)||(l=!0,angular.forEach(a.commission_details.other_hotels_info,function(e){angular.forEach(h.commission_details.other_hotels_info,function(t){e.id!==t.id||_.isMatch(e,t)||m.push(e)})})),l){var d=JSON.parse(JSON.stringify(a));d.commission_details.other_hotels_info=angular.copy(m),"undefined"!=typeof d.countries&&delete d.countries,""===d.account_details.account_number&&(d.account_details.account_number=null),"undefined"==typeof d.primary_contact_details?(d.primary_contact_details={},d.primary_contact_details.contact_email=null):""===d.primary_contact_details.contact_email&&(d.primary_contact_details.contact_email=null),"undefined"==typeof d.address_details&&(d.address_details={}),d.account_type=o.type;var u={params:d,successCallBack:function(e){C(e,r,s)},failureCallBack:I};e.callAPI(t.saveContactInformation,u)}else e.shouldSaveArDataFromPopup&&(e.shouldSaveArDataFromPopup=!1,e.$broadcast("UPDATE_AR_ACCOUNT_DETAILS",e.arAccountDetails),e.$broadcast("saveArAccount")),f&&(e.$broadcast("setgenerateNewAutoAr",!0),e.$broadcast("saveArAccount"),e.isArTabAvailable=!0),f=!1,r&&i.close(),s&&n.go(c.previousState,c.previousStateParams)};e.$on("saveContactInformation",function(t,a){t.preventDefault(),t.stopPropagation(),e.isAddNewCard||e.isDiscard||(a&&a.other_hotels_info?(e.contactInformation.commission_details.other_hotels_info=a.other_hotels_info,b(e.contactInformation,a.hotel_info_changed_from_popup)):b(e.contactInformation))}),e.$on("OUTSIDECLICKED",function(t){t.preventDefault(),e.isMandatoryPopupOpen||(e.isAddNewCard&&!e.isContactInformationSaved?e.isPromptOpened||e.saveNewCardPrompt():e.isDiscard||o.isBackFromStaycard||e.isContactInformationSaved||("cc-contact-info"===e.currentSelectedTab?b(e.contactInformation):"cc-contracts"===e.currentSelectedTab?e.$broadcast("saveContract"):"cc-ar-accounts"===e.currentSelectedTab&&e.$broadcast("saveArAccount")))}),e.clikedSaveNewCard=function(){b(e.contactInformation),e.isContactInformationSaved=!0},e.clikedSaveNewCardViaPopup=function(){b(e.contactInformation),e.isContactInformationSaved=!0,i.close()},e.clikedDiscardCard=function(){e.isDiscard=!0,n.go("rover.companycardsearch",{textInQueryBox:o.query}),e.isAddNewCard=!1,e.disableGlobalToggle=!0,i.close()},e.saveNewCardPrompt=function(){e.isPromptOpened=!0,i.open({template:"/assets/partials/companyCard/rvSaveNewCardPrompt.html",controller:"saveNewCardPromptCtrl",className:"ngdialog-theme-default1 calendar-single1",closeByDocument:!1,scope:e})},e.clickedLogo=function(){"TRAVELAGENT"===o.type?e.isUpdateEnabledForTravelAgent()||s(function(){angular.element("#uplaodCompanyLogo").trigger("click")},0,!1):"COMPANY"===o.type&&(e.isUpdateEnabled()||s(function(){angular.element("#uplaodCompanyLogo").trigger("click")},0,!1))},e.shouldShowARMandatoryPopup=function(){var t=(!e.contactInformation.mandatoryFields.address_line1_mandatory.is_mandatory_on_ar_account_creation&&!e.contactInformation.mandatoryFields.address_line1_mandatory.is_mandatory||!isEmpty(e.contactInformation.address_details.street1))&&(!e.contactInformation.mandatoryFields.city_mandatory.is_mandatory_on_ar_account_creation&&!e.contactInformation.mandatoryFields.city_mandatory.is_mandatory||!isEmpty(e.contactInformation.address_details.city))&&(!e.contactInformation.mandatoryFields.postal_code_mandatory.is_mandatory_on_ar_account_creation&&!e.contactInformation.mandatoryFields.postal_code_mandatory.is_mandatory||!isEmpty(e.contactInformation.address_details.postal_code))&&(!e.contactInformation.mandatoryFields.country_mandatory.is_mandatory_on_ar_account_creation&&!e.contactInformation.mandatoryFields.country_mandatory.is_mandatory||""!==e.contactInformation.address_details.country_id&&null!==e.contactInformation.address_details.country_id)&&(!e.contactInformation.mandatoryFields.contact_phone_mandatory.is_mandatory_on_ar_account_creation&&!e.contactInformation.mandatoryFields.contact_phone_mandatory.is_mandatory||!isEmpty(e.contactInformation.address_details.phone))&&(!e.contactInformation.mandatoryFields.contact_email_address_mandatory.is_mandatory_on_ar_account_creation&&!e.contactInformation.mandatoryFields.contact_email_address_mandatory.is_mandatory||!isEmpty(e.contactInformation.address_details.email_address)&&isValidEmail(e.contactInformation.address_details.email_address))&&(!e.contactInformation.mandatoryFields.e_invoice_mandatory.is_mandatory_on_ar_account_creation&&!e.contactInformation.mandatoryFields.e_invoice_mandatory.is_mandatory||!isEmpty(e.contactInformation.e_invoice_address))&&(!e.contactInformation.mandatoryFields.organization_id_mandatory.is_mandatory_on_ar_account_creation&&!e.contactInformation.mandatoryFields.organization_id_mandatory.is_mandatory||!isEmpty(e.contactInformation.account_details.organization_id))&&(!e.contactInformation.mandatoryFields.tax_id_mandatory.is_mandatory_on_ar_account_creation&&!e.contactInformation.mandatoryFields.tax_id_mandatory.is_mandatory||!isEmpty(e.contactInformation.account_details.tax_number))&&(!e.contactInformation.mandatoryFields.regd_tax_office_mandatory.is_mandatory_on_ar_account_creation&&!e.contactInformation.mandatoryFields.regd_tax_office_mandatory.is_mandatory||!isEmpty(e.contactInformation.account_details.reg_tax_office))&&(!e.contactInformation.mandatoryFields.contact_name_mandatory.is_mandatory_on_ar_account_creation&&!e.contactInformation.mandatoryFields.contact_name_mandatory.is_mandatory||!isEmpty(e.contactInformation.primary_contact_details.contact_first_name)&&!isEmpty(e.contactInformation.primary_contact_details.contact_last_name))&&(!!e.arAccountDetails.is_auto_assign_ar_numbers||""!==e.arAccountDetails.ar_number&&null!==e.arAccountDetails.ar_number)&&(!e.contactInformation.mandatoryFields.payment_due_days_mandatory.is_mandatory_on_ar_account_creation&&!e.contactInformation.mandatoryFields.payment_due_days_mandatory.is_mandatory||""!==e.arAccountDetails.payment_due_days&&null!==e.arAccountDetails.payment_due_days);return t},e.isEmptyObject=isEmptyObject,e.$on("PRINT_AR_STATEMENT",function(t,a){e.isPrintArStatement=a}),c.disableObserveForSwipe||(CardReaderCtrl.call(this,e,c,s,d,u),e.observeForSwipe())}]);var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};angular.module("sntRover").controller("companyCardNotesController",["$scope","rvCompanyCardNotesSrv","$timeout","$filter","$rootScope",function(e,t,a,n,o){BaseCtrl.call(this,e);var i=null,r=function(){var t=e.getScroller("companycard_notes_scroller");a(function(){t.scrollTo(0,0,300)},0)},s=function(t){e.notes=t,e.refreshScroller("companycard_notes_scroller"),e.contactInformation.account_notes_count=e.notes.length},c=function(){i=e.contactInformation.id;var a={accountID:i},n={params:a,successCallBack:s};e.callAPI(t.fetchNotes,n)},l=function(t,a){var n=a.index;e.notes.splice(n,1),e.refreshScroller("companycard_notes_scroller"),e.contactInformation.account_notes_count=e.notes.length},d=function(t){e.errorMessage=t,c()};e.deleteNote=function(a,n,o){a.stopPropagation(),e.cancelEditMode(),e.errorMessage="";var r={noteID:n,accountID:i},s={params:r,successCallBack:l,failureCallBack:d,successCallBackParameters:{index:o}};e.callAPI(t.deleteNote,s)};var u=function(t){var a={user_name:t.user_name,avatar:t.avatar,note:t.note,time:t.time,date:t.date,id:t.id,hotel_name:t.hotel_name,is_editable:t.is_editable};e.notes.unshift(0),e.notes[0]=a,e.noteText="",e.refreshScroller("companycard_notes_scroller"),r(),e.contactInformation.account_notes_count=e.notes.length};e.createNote=function(){i=e.contactInformation.id;var a={accountID:i,text:e.noteText};e.errorMessage="";var n={params:a,successCallBack:u};e.callAPI(t.createNote,n)};var m=function(t){var n=_.findIndex(e.notes,{id:e.editingNote.id})+1;e.cancelEditMode(),c();var o=e.getScroller("companycard_notes_scroller");a(function(){o.scrollToElement(".notes.wrapper li:nth-child("+n+")",300)},0)};e.updateActiveNote=function(){if(null===e.editingNote)return void(e.errorMessage=["Something went wrong, please switch tab and comeback"]);e.errorMessage="";var a={noteID:e.editingNote.id,accountID:i,text:e.noteText},n={params:a,successCallBack:m};e.callAPI(t.updateNote,n)},e.clickedOnNote=function(t){t.is_editable&&(e.editingNote=t,e.noteText=t.note)},e.cancelEditMode=function(){e.editingNote=null,e.noteText=""},e.formatDateForUI=function(e){var t="undefined"==typeof e?"undefined":_typeof(e),a="";switch(t){case"string":a=n("date")(new tzIndependentDate(e),o.dateFormat);break;case"object":a=n("date")(e,o.dateFormat)}return a};(function(){e.editingNote=null,e.notes=[],e.noteText="",e.setScroller("companycard_notes_scroller",{})})();e.$on("fetchNotes",function(){i=e.contactInformation&&e.contactInformation.id||!1,i&&c()})}]),sntRover.controller("companyCardArAccountCtrl",["$scope","RVCompanyCardSrv","$timeout","rvPermissionSrv",function(e,t,a,n){BaseCtrl.call(this,e),e.setScroller("cardAccountsScroller");var o=function(){a(function(){e.myScroll&&e.myScroll.cardAccountsScroller&&e.myScroll.cardAccountsScroller.refresh(),e.refreshScroller("cardAccountsScroller")},500)};e.$on("refreshAccountsScroll",o);var i=function(){e.ARData={},e.ARData.note="",e.shouldValidate=!0};i();var r={};e.$on("setgenerateNewAutoAr",function(t,a){e.$parent.generateNewAutoAr=a,!e.arAccountDetails.is_auto_assign_ar_numbers&&a&&s(!0)});var s=function(a){var n=function(t){e.$emit("hideLoader"),e.errorMessage="",e.arAccountDetails.is_auto_assign_ar_numbers&&!e.arAccountDetails.ar_number&&(e.arAccountDetails.ar_number=t.ar_number,e.$parent.generateNewAutoAr=!1),e.$emit("ARNumberChanged",{newArNumber:e.arAccountDetails.ar_number})},o=function(t){e.$emit("hideLoader"),e.errorMessage=""},i=function(t){e.$emit("hideLoader"),e.errorMessage=t,"Please complete required AR Account Information"!==t[0]&&"Please provide payment due days since it is mandatory"!==t[0]||e.$emit("MANDATORY_CHECK_FAILED",e.errorMessage)},s=e.arAccountDetails;_.isEmpty(r)&&(r=angular.fromJson(angular.toJson(e.arAccountDetails))),e.contactInformation.id&&(s.id=e.contactInformation.id,r.id=e.contactInformation.id);var c=JSON.parse(JSON.stringify(e.arAccountDetails)),l=!1,d=["workstation_id"];angular.equals(_.omit(c,d),_.omit(r,d))||(l=!0,r=c),e.$parent.generateNewAutoAr&&e.arAccountDetails.is_auto_assign_ar_numbers||l?e.invokeApi(t.saveARDetails,s,n,i):(!e.arAccountDetails.is_auto_assign_ar_numbers&&l||a)&&e.invokeApi(t.saveARDetails,s,o,i)};e.$on("arAccountTabActive",function(){setTimeout(function(){o()},500),e.arAccountDetails&&e.arAccountDetails.is_auto_assign_ar_numbers&&!e.arAccountDetails.ar_number&&s()}),e.$on("ARDetailsRecieved",function(){r=JSON.parse(JSON.stringify(e.arAccountDetails))}),e.checkboxModelChanged=function(){o()},e.saveNote=function(){var a=function(t){e.$emit("hideLoader"),e.arAccountNotes.ar_notes.push(t),e.ARData.note="",o()},n={id:e.contactInformation.id,note:e.ARData.note,ar_number:e.arAccountDetails.ar_number};e.invokeApi(t.saveARNote,n,a)},e.deletePost=function(a,n){var i=function(){e.$emit("hideLoader"),e.arAccountNotes.ar_notes.splice(n,1),o()},r={id:e.contactInformation.id,note_id:a};e.invokeApi(t.deleteARNote,r,i)},e.$on("UPDATE_AR_ACCOUNT_DETAILS",function(t,a){e.arAccountDetails=a,e.arAccountDetails.payment_due_days=null===a.payment_due_days?"":a.payment_due_days}),e.$on("saveArAccount",function(e){e.preventDefault(),s()}),e.$on("ArAccountDeleted",function(t){var a=e.arAccountDetails.is_auto_assign_ar_numbers;e.arAccountDetails={},e.arAccountDetails.is_use_main_contact=!0,e.arAccountDetails.is_use_main_address=!0,e.arAccountDetails.is_auto_assign_ar_numbers=a,e.arAccountDetails.ar_number="",e.arAccountDetails.payment_due_days="",e.arAccountNotes.ar_notes=[],e.$emit("UPDATE_AR_ACCOUNT_DETAILS_AFTER_DELETE",e.arAccountDetails)}),e.clearErrorMessage=function(){e.errorMessage=""},e.hasPermissionToEditDirectBillRestriction=function(){return n.getPermissionValue("EDIT_DIRECT_BILL_RESTRICTION")},e.hasPermissionToCreateArAccount=function(){return n.getPermissionValue("CREATE_AR_ACCOUNT")}}]),angular.module("sntRover").controller("companyCardDetailsContactCtrl",["$scope","$q","jsMappings","RVCompanyCardSrv","rvPermissionSrv","$state","$stateParams","ngDialog","$rootScope",function(e,t,a,n,o,i,r,s,c){BaseCtrl.call(this,e),e.setScroller("companyCardDetailsContactCtrl"),e.$on("contactTabActive",function(){l()}),e.isEmpty=function(e){return _.isEmpty(e)},e.toggleCommission=function(){e.contactInformation.commission_details.is_on=!e.contactInformation.commission_details.is_on},e.openBillingInformation=function(t){if(null===e.contactInformation.id||void 0===e.contactInformation.id)return e.$emit("OUTSIDECLICKED"),!1;if("TRAVELAGENT"===t)e.attachedEntities={},e.attachedEntities.travel_agent={},e.attachedEntities.travel_agent.id=e.contactInformation.id,e.attachedEntities.travel_agent.name=e.contactInformation.account_details.account_name,e.attachedEntities.travel_agent.logo=e.contactInformation.account_details.company_logo,e.billingEntity="TRAVEL_AGENT_DEFAULT_BILLING";else{if("COMPANY"!==t)return!1;e.attachedEntities={},e.attachedEntities.company_card={},e.attachedEntities.company_card.id=e.contactInformation.id,e.attachedEntities.company_card.name=e.contactInformation.account_details.account_name,e.attachedEntities.company_card.logo=e.contactInformation.account_details.company_logo,e.billingEntity="COMPANY_CARD_DEFAULT_BILLING"}e.$emit("showLoader"),a.fetchAssets(["addBillingInfo","directives"]).then(function(){e.$emit("hideLoader"),c.UPDATED_BI_ENABLED_ON.CARDS?(console.log("##Billing-info updated version"),s.open({template:"/assets/partials/billingInformation/cards/rvBillingInfoCardsMain.html",controller:"rvBillingInfoCardsMainCtrl",className:"",scope:e})):(console.log("##Billing-info old version"),s.open({template:"/assets/partials/bill/rvBillingInformationPopup.html",controller:"rvBillingInformationPopupCtrl",className:"",scope:e}))})},e.$on("setCardContactErrorMessage",function(t,a){e.errorMessage=a}),e.$on("clearCardContactErrorMessage",function(){e.errorMessage=""});var l=function(){e.refreshScroller("companyCardDetailsContactCtrl")};e.$on("BILLINGINFODELETED",function(){e.contactInformation.account_details.routes_count=0}),e.$on("BILLINGINFOADDED",function(){e.contactInformation.account_details.routes_count=1}),e.openPropertiesPopup=function(){s.open({template:"/assets/partials/companyCard/rvTACardPropertiesCommissionsPopup.html",controller:"rvTACardPropertiesCommissionsPopupCtrl",className:"",scope:e})},e.toggleGlobalCommission=function(){e.displayShowPropertiesButton=!e.contactInformation.commission_details.is_global_commission},e.displayShowPropertiesButtonFn=function(){return e.displayShowPropertiesButton&&"TRAVELAGENT"===e.account_type&&!e.isEmpty(e.contactInformation.commission_details)&&e.contactInformation.is_global_enabled&&c.isAnMPHotel&&c.hotelDetails.userHotelsData.hotel_list.length>0&&o.getPermissionValue("MULTI_PROPERTY_SWITCH")&&o.getPermissionValue("GLOBAL_CARD_UPDATE")&&!e.isUpdateEnabledForTravelAgent()},e.showGlobalCommissionCheckbox=function(){return e.contactInformation.is_global_enabled&&c.hotelDetails.userHotelsData.hotel_list.length>0&&o.getPermissionValue("MULTI_PROPERTY_SWITCH")}}]),sntRover.controller("companyTravelAgentMandatoryFieldsController",["$scope","$timeout","ngDialog",function(e,t,a){BaseCtrl.call(this,e),e.setScroller("companyTravelAgentMandatory"),e.closeDialog=function(){e.$emit("UPDATE_MANDATORY_POPUP_OPEN_FLAG"),a.close()},e.saveCoTaMandatoryData=function(){e.$emit("saveContactInformation"),e.$emit("saveArAccountFromMandatoryPopup",e.arAccountDetails),e.closeDialog()},e.shouldEnableSubmitButton=function(){return e.shouldShowARMandatoryPopup()};var n=function(){e.errorMessage=angular.isUndefined(e.mandatoryErrorMessage)?"":e.mandatoryErrorMessage,t(function(){e.refreshScroller("companyTravelAgentMandatory")},200),angular.isUndefined(e.contactInformation.e_invoice_address)&&(e.contactInformation.e_invoice_address=null),null!==e.contactInformation.address_details.street1&&""!==e.contactInformation.address_details.street1||!e.contactInformation.mandatoryFields.address_line1_mandatory.is_mandatory_on_ar_account_creation&&!e.contactInformation.mandatoryFields.address_line1_mandatory.is_mandatory||(e.shouldShowAddress=!0),null!==e.contactInformation.address_details.city&&""!==e.contactInformation.address_details.city||!e.contactInformation.mandatoryFields.city_mandatory.is_mandatory_on_ar_account_creation&&!e.contactInformation.mandatoryFields.city_mandatory.is_mandatory||(e.shouldShowCity=!0),null!==e.contactInformation.address_details.postal_code&&""!==e.contactInformation.address_details.postal_code||!e.contactInformation.mandatoryFields.postal_code_mandatory.is_mandatory_on_ar_account_creation&&!e.contactInformation.mandatoryFields.postal_code_mandatory.is_mandatory||(e.shouldShowPostalCode=!0),null!==e.contactInformation.address_details.country_id&&""!==e.contactInformation.address_details.country_id||!e.contactInformation.mandatoryFields.country_mandatory.is_mandatory_on_ar_account_creation&&!e.contactInformation.mandatoryFields.country_mandatory.is_mandatory||(e.shouldShowCountry=!0),null!==e.contactInformation.address_details.phone&&""!==e.contactInformation.address_details.phone||!e.contactInformation.mandatoryFields.contact_phone_mandatory.is_mandatory_on_ar_account_creation&&!e.contactInformation.mandatoryFields.contact_phone_mandatory.is_mandatory||(e.shouldShowPhone=!0),null!==e.contactInformation.address_details.email_address&&""!==e.contactInformation.address_details.email_address||!e.contactInformation.mandatoryFields.contact_email_address_mandatory.is_mandatory_on_ar_account_creation&&!e.contactInformation.mandatoryFields.contact_email_address_mandatory.is_mandatory||(e.shouldShowEmail=!0),null!==e.contactInformation.e_invoice_address&&""!==e.contactInformation.e_invoice_address||!e.contactInformation.mandatoryFields.e_invoice_mandatory.is_mandatory_on_ar_account_creation&&!e.contactInformation.mandatoryFields.e_invoice_mandatory.is_mandatory||(e.shouldShowEInvoice=!0),null!==e.contactInformation.account_details.organization_id&&""!==e.contactInformation.account_details.organization_id||!e.contactInformation.mandatoryFields.organization_id_mandatory.is_mandatory_on_ar_account_creation&&!e.contactInformation.mandatoryFields.organization_id_mandatory.is_mandatory||(e.shouldShowOrganization=!0),null!==e.contactInformation.account_details.tax_number&&""!==e.contactInformation.account_details.tax_number||!e.contactInformation.mandatoryFields.tax_id_mandatory.is_mandatory_on_ar_account_creation&&!e.contactInformation.mandatoryFields.tax_id_mandatory.is_mandatory||(e.shouldShowTaxNumber=!0),null!==e.contactInformation.account_details.reg_tax_office&&""!==e.contactInformation.account_details.reg_tax_office||!e.contactInformation.mandatoryFields.regd_tax_office_mandatory.is_mandatory_on_ar_account_creation&&!e.contactInformation.mandatoryFields.regd_tax_office_mandatory.is_mandatory||(e.shouldShowRegisteredTaxOffice=!0),null!==e.contactInformation.primary_contact_details.contact_first_name&&""!==e.contactInformation.primary_contact_details.contact_first_name||!e.contactInformation.mandatoryFields.contact_name_mandatory.is_mandatory_on_ar_account_creation&&!e.contactInformation.mandatoryFields.contact_name_mandatory.is_mandatory||(e.shouldShowPrimaryContactFirstName=!0),null!==e.contactInformation.primary_contact_details.contact_last_name&&""!==e.contactInformation.primary_contact_details.contact_last_name||!e.contactInformation.mandatoryFields.contact_name_mandatory.is_mandatory_on_ar_account_creation&&!e.contactInformation.mandatoryFields.contact_name_mandatory.is_mandatory||(e.shouldShowPrimaryContactLastName=!0),null!==e.arAccountDetails.payment_due_days&&""!==e.arAccountDetails.payment_due_days||!e.contactInformation.mandatoryFields.payment_due_days_mandatory.is_mandatory_on_ar_account_creation&&!e.contactInformation.mandatoryFields.payment_due_days_mandatory.is_mandatory||(e.shouldShowPayDays=!0),e.arAccountDetails.is_auto_assign_ar_numbers||(e.shouldShowArNumber=!0)};n()}]),sntRover.controller("rvTACardPropertiesCommissionsPopupCtrl",["$scope","$rootScope","$filter","$timeout","rvUtilSrv","ngDialog",function(e,t,a,n,o,i){BaseCtrl.call(this,e);var r={tap:!0,preventDefault:!1,showScrollbar:!0};e.clickedCancel=function(){i.close()},e.saveChanges=function(){e.$emit("saveContactInformation",{hotel_info_changed_from_popup:!0,other_hotels_info:e.hotelCommissionDetails})};var s=function(){e.hotelCommissionDetails=angular.copy(e.contactInformation.commission_details.other_hotels_info),e.setScroller("rvTACardPropertiesCommissionsScroll",r),n(function(){e.refreshScroller("rvTACardPropertiesCommissionsScroll")},2e3)};s()}]),angular.module("sntRover").service("RVContactInfoSrv",["$q","RVBaseWebSrv","rvBaseWebSrvV2",function(e,t,a){var n=this;n.saveContactInfo=function(a){var n=e.defer(),o=a.data,i=a.userId,r="/staff/guest_cards/"+i;return t.putJSON(r,o).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},n.createGuest=function(t){var n=e.defer(),o=t.data,i="/api/guest_details";return a.postJSON(i,o).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},n.updateGuest=function(t){var n=e.defer(),o="/api/guest_details/"+t.userId;return t.check_validation_only&&(o+="?check_validation_only=true"),a.putJSON(o,t.data).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},n.fetchGuestLanguages=function(t){var n=e.defer(),o="/api/guest_languages";return a.getJSON(o,t).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},n.removeGuestDetails=function(t){var n=e.defer(),o="/api/guest_details/"+t+"/anonymize";return a.putJSON(o).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},n.getGuestDetailsById=function(t){var n=e.defer(),o="/api/guest_details/"+t;return null===t?n.reject([""]):a.getJSON(o).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},n.parseGuestData=function(e,t){var a={};return a.id=t,a.firstName=e.first_name,a.lastName=e.last_name,a.image=e.image_url,a.vip=e.vip,e.address&&(a.address={},a.address.city=e.address.city,a.address.state=e.address.state,a.address.postalCode=e.address.postal_code),a.stayCount=e.stay_count,a.lastStay={},a.phone=e.home_phone,a.email=e.email,e.last_stay&&(a.lastStay.date=e.last_stay.date,a.lastStay.room=e.last_stay.room,a.lastStay.roomType=e.last_stay.room_type),a},n.deleteGuest=function(t){var n=e.defer(),o="/api/guest_details/"+t;return a.deleteJSON(o).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},n.checkIfCommisionWasRecalculated=function(t){var n=e.defer(),o="/api/reservations/"+t.reservation_id+"/commission_transaction_info";return a.getJSON(o).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise}}]),sntRover.controller("rvBillFormatPopupCtrl",["$scope","$rootScope","$filter","RVBillCardSrv","RVContactInfoSrv","ngDialog","$timeout",function(e,t,a,n,o,i,r){var s=200,c=500;BaseCtrl.call(this,e),e.isCompanyCardInvoice=!0,e.disableCompanyCardInvoice=!1,e.disableCompanyGuestToggle=!1,e.hideCompanyCardInvoiceToggle=!0,e.billFormat.isInformationalInvoice=!e.shouldGenerateFinalInvoice&&e.isSettledBill&&e.reservationBillData.is_bill_lock_enabled,e.billFormat.isInformationalInvoiceDisabled=e.isSettledBill&&e.reservationBillData.is_bill_lock_enabled,e.disableToggleAccount=!1;var l=function(){var t={};return e.reservationBillData&&e.reservationBillData.reservation_id?(t.id=e.reservationBillData.reservation_id,t.is_type="Reservation"):(e.hideCompanyCardInvoiceToggle=!1,e.isFromInvoiceSearchScreen&&(null===e.clickedInvoiceData.associated_item.company_card&&null===e.clickedInvoiceData.associated_item.travel_agent_card?e.hideCompanyCardInvoiceToggle=!0:null===e.clickedInvoiceData.associated_item.company_card&&null!==e.clickedInvoiceData.associated_item.travel_agent_card?(e.isCompanyCardInvoice=!1,
e.disableCompanyCardInvoice=!0):null!==e.clickedInvoiceData.associated_item.company_card&&null===e.clickedInvoiceData.associated_item.travel_agent_card&&(e.disableCompanyCardInvoice=!0)),e.groupConfigData?(t.id=e.groupConfigData.summary.group_id,t.is_group=!0,t.is_type="Account",d(e.groupConfigData.summary)):(t.id=e.accountConfigData?e.accountConfigData.summary.posting_account_id:e.clickedInvoiceData.associated_item.item_id,t.is_group=!1,t.is_type="Account",e.accountConfigData&&d(e.accountConfigData.summary))),t.bill_no=e.billNo,t};e.closeDialog=function(){t.modalOpened=!1,r(function(){i.close()},s)};var d=function(t){(u(t.company)||u(t.travel_agent))&&(u(t.company)&&u(t.travel_agent)?e.hideCompanyCardInvoiceToggle=!0:!u(t.company)&&u(t.travel_agent)?(e.isCompanyCardInvoice=!0,e.disableCompanyCardInvoice=!0):(e.isCompanyCardInvoice=!1,e.disableCompanyCardInvoice=!0))},u=function(e){return!e||0===e.length},m=function(t){e.$emit("hideLoader"),t.languages&&(t.languages=_.filter(t.languages,{is_show_on_guest_card:!0})),e.languageData=t,e.data.locale=t.selected_language_code},f=function(){var t={};e.reservationBillData&&e.reservationBillData.reservation_id&&(t.reservation_id=e.reservationBillData.reservation_id),e.invokeApi(o.fetchGuestLanguages,t,m)},p=function(){var t=l(),a=function(t){f(),t.data&&t.data.default_bill_settings&&(t.data.default_bill_settings=t.data.default_bill_settings.toString());var a=t.data&&t.data.bill_paid_account_type;"COMPANY"===a?(e.isCompanyCardInvoice=!0,e.disableToggleAccount=!0):"TRAVELAGENT"===a&&(e.isCompanyCardInvoice=!1,e.disableToggleAccount=!0),e.data=t.data,e.setEmailAddress()};e.invokeApi(n.getBillSettingsInfo,t,a)},v=function(){var t={};return e.reservationBillData&&e.reservationBillData.reservation_id?t.reservation_id=e.reservationBillData.reservation_id:(e.groupConfigData?(t.group_id=e.groupConfigData.summary.group_id,t.is_group=!0):(t.account_id=e.isFromInvoiceSearchScreen?e.clickedInvoiceData.associated_item.item_id:e.accountConfigData.summary.posting_account_id,t.is_group=!1),t.type=e.isCompanyCardInvoice?"COMPANY":"TRAVELAGENT"),t.bill_number=e.billNo,t.locale=e.data.locale,e.$emit("hideLoader"),t};e.printBill=function(){var t=v();e.$emit("UPDATE_INFORMATIONAL_INVOICE",e.billFormat.isInformationalInvoice),t.bill_layout=e.data.default_bill_settings,t.is_informational_invoice=e.billFormat.isInformationalInvoice,e.clickedPrint(t)},e.clickedContinueButtonPrintOrEmail=function(){e.isClickedPrint?e.printBill():e.sendEmail()},e.clickedPrintBill=function(){e.shouldGenerateFinalInvoice&&!e.billFormat.isInformationalInvoice?(e.isClickedPrint=!0,e.isInvoiceStepThreeActive=!1,r(function(){e.isInvoiceStepFourActive=!0},c)):e.printBill()},e.sendEmail=function(){var t=v();t.bill_layout=e.data.default_bill_settings,t.to_address=e.data.mailto_address,t.is_informational_invoice=e.billFormat.isInformationalInvoice,e.clickedEmail(t)},e.emailBill=function(){e.shouldGenerateFinalInvoice&&!e.billFormat.isInformationalInvoice?(e.isClickedPrint=!1,e.isInvoiceStepThreeActive=!1,r(function(){e.isInvoiceStepFourActive=!0},c)):e.sendEmail()},e.clickedFinalInvoiceButton=function(){e.isInvoiceStepOneActive=!1,r(function(){e.isInvoiceStepTwoActive=!0},c)},e.clickedProceedButton=function(){e.isInvoiceStepTwoActive=!1,e.isInvoiceStepFourActive=!1,r(function(){e.isInvoiceStepThreeActive=!0},c)},e.clickedCancelButtonProceedScreen=function(){e.isInvoiceStepTwoActive=!1,r(function(){e.isInvoiceStepOneActive=!0},c)};var h=e.$on("UPDATE_WINDOW",function(){e.isInvoiceStepFourActive=!1,r(function(){e.isInvoiceStepFiveActive=!0},c)});e.getPrintButtonClass=function(){var t="blue";return!e.billFormat.isInformationalInvoice&&parseInt(e.reservationBillData.bills[e.currentActiveBill].print_counter,10)>=parseInt(e.reservationBillData.no_of_original_invoices,10)&&e.roverObj.noReprintReEmailInvoice&&0!==parseInt(e.reservationBillData.no_of_original_invoices,10)&&(t="grey"),t},e.isPrintButtonDisabled=function(){var t=!1;return!e.billFormat.isInformationalInvoice&&parseInt(e.reservationBillData.bills[e.currentActiveBill].print_counter,10)>=parseInt(e.reservationBillData.no_of_original_invoices,10)&&e.roverObj.noReprintReEmailInvoice&&0!==parseInt(e.reservationBillData.no_of_original_invoices,10)&&(t=!0),t},e.getEmailButtonClass=function(){var t="blue";return e.data.mailto_address?!e.billFormat.isInformationalInvoice&&parseInt(e.reservationBillData.bills[e.currentActiveBill].email_counter,10)>=parseInt(e.reservationBillData.no_of_original_emails,10)&&e.roverObj.noReprintReEmailInvoice&&0!==parseInt(e.reservationBillData.no_of_original_invoices,10)&&(t="grey"):t="grey",t},e.isEmailButtonDisabled=function(){var t=!1;return e.data.mailto_address?!e.billFormat.isInformationalInvoice&&parseInt(e.reservationBillData.bills[e.currentActiveBill].email_counter,10)>=parseInt(e.reservationBillData.no_of_original_emails,10)&&e.roverObj.noReprintReEmailInvoice&&0!==parseInt(e.reservationBillData.no_of_original_invoices,10)&&(t=!0):t=!0,t},e.clickedInformationalButton=function(){e.billFormat.isInformationalInvoice=!0,e.isInvoiceStepOneActive=!1,r(function(){e.isInvoiceStepThreeActive=!0},c)},e.setEmailAddress=function(){e.isCompanyCardInvoice?e.data.mailto_address=e.data.company_address?e.data.company_address:e.data.to_address:e.data.mailto_address=e.data.travel_agent_address?e.data.travel_agent_address:e.data.to_address};var g=function(){e.data={},p()};e.changeCompanyCardInvoiceToggle=function(){e.isCompanyCardInvoice=!e.isCompanyCardInvoice,e.setEmailAddress()},e.$on("$destroy",h),g()}]),sntRover.controller("rvArBillFormatPopupCtrl",["$scope","$rootScope","$filter","RVBillCardSrv","RVContactInfoSrv","rvAccountsArTransactionsSrv","ngDialog","$timeout",function(e,t,a,n,o,i,r,s){var c=200,l=500;BaseCtrl.call(this,e),e.isCompanyCardInvoice=!0,e.disableCompanyCardInvoice=!1,e.hideCompanyCardInvoiceToggle=!0,e.billFormat.isInformationalInvoice=!e.shouldGenerateFinalInvoice,e.billFormat.isInformationalInvoiceDisabled=!e.disableInformationCheckBox;var d=function(){var t={};return t.is_type="ArAccount",t.id=e.item.transaction_id,t};e.closeDialog=function(){t.modalOpened=!1,s(function(){r.close()},c)};var u=function(t){t.languages&&(t.languages=_.filter(t.languages,{is_show_on_guest_card:!0})),e.languageData=t,e.data.locale=t.selected_language_code},m=function(){var t={params:{},successCallBack:u};e.callAPI(o.fetchGuestLanguages,t)},f=function(){var t=d(),a=function(t){m(),t.data&&t.data.default_bill_settings&&(t.data.default_bill_settings=t.data.default_bill_settings.toString()),e.data=t.data,e.setEmailAddress()},o={params:t,successCallBack:a};e.callAPI(n.getBillSettingsInfo,o)},p=function(){var t={};return t.id=e.item.transaction_id,t.account_id=e.arTransactionsData.accountId,t.locale=e.data.locale,t};e.printBill=function(t){var a=p();a.is_locked=t,e.$emit("UPDATE_INFORMATIONAL_INVOICE",e.billFormat.isInformationalInvoice),a.bill_layout=e.data.default_bill_settings,a.is_informational_invoice=e.billFormat.isInformationalInvoice,e.clickedPrint(a)},e.clickedContinueButtonPrintOrEmail=function(){var t={},a=!1;t.id=e.item.transaction_id,t.account_id=e.arTransactionsData.accountId;var n=function(){e.is_bill_lock_enabled&&(a=!0),e.isClickedPrint?e.printBill(a):e.sendEmail(a)},o=function(t){a=!1,e.errorMessage=t},r={params:t,successCallBack:n,failureCallBack:o};e.callAPI(i.lockBill,r)},e.clickedPrintBill=function(){!e.shouldGenerateFinalInvoice||e.billFormat.isInformationalInvoice||e.item.is_locked?e.printBill():(e.isClickedPrint=!0,e.isInvoiceStepThreeActive=!1,s(function(){e.isInvoiceStepFourActive=!0},l))},e.sendEmail=function(t){var a=p();a.is_locked=t,a.bill_layout=e.data.default_bill_settings,a.to_address=e.data.mailto_address,a.is_informational_invoice=e.billFormat.isInformationalInvoice,e.clickedEmail(a)},e.emailBill=function(){!e.shouldGenerateFinalInvoice||e.billFormat.isInformationalInvoice||e.item.is_locked?e.sendEmail():(e.isClickedPrint=!1,e.isInvoiceStepThreeActive=!1,s(function(){e.isInvoiceStepFourActive=!0},l))},e.clickedFinalInvoiceButton=function(){e.isInvoiceStepOneActive=!1,s(function(){e.isInvoiceStepTwoActive=!0},l)},e.clickedProceedButton=function(){e.isInvoiceStepTwoActive=!1,e.isInvoiceStepFourActive=!1,s(function(){e.isInvoiceStepThreeActive=!0},l)},e.clickedCancelButtonProceedScreen=function(){e.isInvoiceStepTwoActive=!1,s(function(){e.isInvoiceStepOneActive=!0},l)};var v=e.$on("UPDATE_WINDOW",function(){e.isInvoiceStepFourActive=!1,s(function(){e.item.is_locked||(e.isInvoiceStepFiveActive=!0)},l)});e.getPrintButtonClass=function(){var t="blue";return 0===parseInt(e.item.print_counter,10)&&0===parseInt(e.transactionsDetails.no_of_original_invoices,10)&&e.roverObj.noReprintReEmailInvoice?t="blue":!e.billFormat.isInformationalInvoice&&parseInt(e.item.print_counter,10)>0&&0===parseInt(e.transactionsDetails.no_of_original_invoices,10)&&e.roverObj.noReprintReEmailInvoice?t="grey":!e.billFormat.isInformationalInvoice&&parseInt(e.item.print_counter,10)>=parseInt(e.transactionsDetails.no_of_original_invoices,10)&&e.roverObj.noReprintReEmailInvoice&&(t="grey"),t},e.isPrintButtonDisabled=function(){var t=!1;return 0===parseInt(e.item.print_counter,10)&&0===parseInt(e.transactionsDetails.no_of_original_invoices,10)&&e.roverObj.noReprintReEmailInvoice?t=!1:!e.billFormat.isInformationalInvoice&&parseInt(e.item.print_counter,10)>0&&0===parseInt(e.transactionsDetails.no_of_original_invoices,10)&&e.roverObj.noReprintReEmailInvoice?t=!0:!e.billFormat.isInformationalInvoice&&parseInt(e.item.print_counter,10)>=parseInt(e.transactionsDetails.no_of_original_invoices,10)&&e.roverObj.noReprintReEmailInvoice&&(t=!0),t},e.getEmailButtonClass=function(){var t="blue";return e.data.mailto_address?0===parseInt(e.item.email_counter,10)&&0===parseInt(e.transactionsDetails.no_of_original_emails,10)&&e.roverObj.noReprintReEmailInvoice?t="blue":!e.billFormat.isInformationalInvoice&&parseInt(e.item.email_counter,10)>0&&0===parseInt(e.transactionsDetails.no_of_original_emails,10)&&e.roverObj.noReprintReEmailInvoice?t="grey":!e.billFormat.isInformationalInvoice&&parseInt(e.item.email_counter,10)>=parseInt(e.transactionsDetails.no_of_original_emails,10)&&e.roverObj.noReprintReEmailInvoice&&0!==parseInt(e.transactionsDetails.no_of_original_emails,10)&&(t="grey"):t="grey",t},e.isEmailButtonDisabled=function(){var t=!1;return e.data.mailto_address?0===parseInt(e.item.email_counter,10)&&0===parseInt(e.transactionsDetails.no_of_original_emails,10)&&e.roverObj.noReprintReEmailInvoice?t=!1:!e.billFormat.isInformationalInvoice&&parseInt(e.item.email_counter,10)>0&&0===parseInt(e.transactionsDetails.no_of_original_emails,10)&&e.roverObj.noReprintReEmailInvoice?t=!0:!e.billFormat.isInformationalInvoice&&parseInt(e.item.email_counter,10)>=parseInt(e.transactionsDetails.no_of_original_emails,10)&&e.roverObj.noReprintReEmailInvoice&&0!==parseInt(e.transactionsDetails.no_of_original_emails,10)&&(t=!0):t=!0,t},e.clickedInformationalButton=function(){e.billFormat.isInformationalInvoice=!0,e.isInvoiceStepOneActive=!1,s(function(){e.isInvoiceStepThreeActive=!0},l)},e.setEmailAddress=function(){e.isCompanyCardInvoice?e.data.mailto_address=e.data.company_address?e.data.company_address:e.data.to_address:e.data.mailto_address=e.data.travel_agent_address?e.data.travel_agent_address:e.data.to_address};var h=function(){e.data={},f()};e.changeCompanyCardInvoiceToggle=function(){e.isCompanyCardInvoice=!e.isCompanyCardInvoice},e.$on("$destroy",v),h()}]),angular.module("sntRover").service("RVBillCardSrv",["$http","$q","BaseWebSrvV2","RVBaseWebSrv","rvBaseWebSrvV2","sntBaseWebSrv","RVGAHelperSrv",function(e,t,a,n,o,i,r){var s=this;this.fetchReservationBillData=function(e){var a=t.defer(),n="/api/reservations/"+e+"/bills_summary";return o.getJSON(n).then(function(e){a.resolve(e.data)},function(e){a.reject(e)}),a.promise},this.fetchAllowanceData=function(e,t,a){var n="/api/bills/"+t+"/allowance_transactions";return o.getJSON(n).then(function(t){t.allowance_data&&t.allowance_data.allowance_entries&&t.allowance_data.allowance_entries.length&&(_.each(t.allowance_data.allowance_entries,function(e,a){e.entriesForTheDate=_.filter(t.allowance_data.allowance_entries,function(t){return t.date===e.date}),e.amount=e.amount?parseFloat(e.amount):e.amount}),a.allowance_data=t.allowance_data),e.resolve(a)},function(t){e.reject(t)}),e.promise},this.fetchReservationAllowanceTransactions=function(e){var t="/api/reservations/"+e+"/allowance_transactions";return o.getJSON(t).then(function(e){var t={dataByAllowance:[],dataByDate:[]};return e.allowance_data&&e.allowance_data.allowance_entries&&e.allowance_data.allowance_entries.length&&(t.dataByAllowance=_.groupBy(e.allowance_data.allowance_entries,function(e){return e.addon_id}),t.dataByDate=_.groupBy(e.allowance_data.allowance_entries,function(e){return e.date})),t.amount=e.allowance_data.amount,t},function(){})},this.searchAllowanceShares=function(e){var a=t.defer(),n="/api/reservations/"+e.reservationId+"/search_reservations_for_allowance_share";return o.getJSON(n,{query:e.query}).then(function(e){a.resolve(e.data)},function(e){a.reject(e)}),a.promise},this.saveAllowanceShares=function(e){var n=t.defer(),o="/api/reservations/"+e.reservationId+"/route_allowance";return a.postJSON(o,e.data).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchBillData=function(e){var a=t.defer(),n="/api/bills/"+e;return o.getJSON(n).then(function(e){a.resolve(e.data)},function(e){a.reject(e)}),a.promise},this.fetch=function(e){var a="",n=t.defer(),o="",i="";return t.when().then(function(){return s.fetchReservationBillData(e).then(function(e){a=e})}).then(function(){return o=a.bills[0].bill_id,i=parseInt(a.bills[0].bill_number)-1,s.fetchBillData(o).then(function(e){a.bills[i]=e})}).then(function(){a.groupedAllowances={},n.resolve(a)},function(e){n.reject(e)}),n.promise},this.fetchBillPrintData=function(e){var a=t.defer(),o="staff/bills/print_guest_bill";return n.postJSON(o,e).then(function(e){e.charge_details_list=[],angular.forEach(e.fee_details,function(t,a){angular.forEach(t.charge_details,function(a){a.date=t.date,a.isCredit=!1,e.charge_details_list.push(a)}),angular.forEach(t.credit_details,function(a){a.date=t.date,a.isCredit=!0,e.charge_details_list.push(a)})}),a.resolve(e)},function(e){a.reject(e)}),a.promise},this.fetchRegistrationCardPrintData=function(e){var a=t.defer(),n="/api/registration_cards/"+e.reservation_id;return o.getJSON(n,e).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.movetToAnotherBill=function(e){var n=t.defer(),o="/staff/bills/transfer_transaction";return a.postJSON(o,e).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.setBillAddressType=function(e){var n=t.defer(),o="/api/bills/"+e.bill_id+"/save_address_type";return a.postJSON(o,e.parmasToApi).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.completeCheckin=function(e){var a=t.defer(),o="/staff/checkin";return n.postJSON(o,e).then(function(t){r.sendEventToGA("CHECKIN",e.reservation_id),a.resolve(t)},function(e){a.reject(e)}),a.promise},this.completeCheckout=function(e){var a=t.defer(),o="/staff/checkout";return n.postJSON(o,e).then(function(t){r.sendEventToGA("CHECKOUT",e.reservation_id),a.resolve(t)},function(e){a.reject(e)}),a.promise},this.getAdvanceBill=function(e){var a=t.defer(),o="api/reservations/"+e.id+"/advance_bill";return n.postJSON(o).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.transactionEdit=function(e){var n=t.defer(),o="api/financial_transactions/"+e.id;return a.putJSON(o,e.updatedData).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.transactionEditChargeDescription=function(e){var n=t.defer(),o="api/financial_transactions/"+e.id+"/save_custom_description";return a.postJSON(o,e.postData).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.transactionDelete=function(e){var n=t.defer(),o=e.id,i="api/financial_transactions/"+o;return a.putJSON(i,e.data).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.transactionSplit=function(e){var n=t.defer(),o=e.id,i="api/financial_transactions/"+o;return a.putJSON(i,e.data).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchChargeCodes=function(){var e=t.defer(),n="/api/charge_codes?exclude_payments=true&per_page=1000";return a.getJSON(n).then(function(t){e.resolve(t)},function(t){e.reject(t)}),e.promise},this.fetchAdjustmentReasons=function(){var e=t.defer(),n="/admin/force_adjustment_reasons";return a.getJSON(n).then(function(t){e.resolve(t)},function(t){e.reject(t)}),e.promise},this.sendEmail=function(e){var n=t.defer(),o="api/reservations/email_guest_bill.json";return a.postJSON(o,e).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.createAnotherBill=function(e){var n=t.defer(),o="/api/bills/create_bill";return a.postJSON(o,e).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.changeHousekeepingStatus=function(e){var n=t.defer(),o="/house/change_house_keeping_status.json";return a.postJSON(o,e).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.completeReverseCheckout=function(e){var n=t.defer(),o="/staff/reverse_checkout";return a.postJSON(o,e).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.toggleHideRate=function(e){var n=t.defer(),o="api/reservations/"+e.reservation_id+"/hide_rates";return a.postJSON(o,e).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.getBillSettingsInfo=function(e){var n=t.defer(),o="/api/bills/get_settings_info";return a.getJSON(o,e).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.groupChargeDetailsFetch=function(e){var n=t.defer(),o="/staff/reservation/transaction_details";return a.getJSON(o,e).then(function(e){n.resolve(e.data)},function(e){n.reject(e)}),n.promise},this.hideBill=function(e){var n=t.defer(),o="/api/bills/"+e.bill_id+"/hide_bill";return a.postJSON(o).then(function(e){n.resolve(e.data)},function(e){n.reject(e)}),n.promise},this.fetchGuestLanguages=function(e){var a=t.defer(),n="/api/guest_languages";return o.getJSON(n,e).then(function(e){e.languages&&(e.languages=_.filter(e.languages,{is_show_on_guest_card:!0})),a.resolve(e)},function(e){a.reject(e)}),a.promise},this.callBlackBoxApi=function(e){var n=t.defer(),o="/api/hotel_settings/infrasec/generate_control_code";return a.postJSON(o,e).then(function(e){n.resolve(e.data)},function(e){n.reject(e)}),n.promise},this.generateFolioNumber=function(e){var n=t.defer(),o="/api/bills/"+e.bill_id+"/generate_folio_number";return a.postJSON(o,e).then(function(e){n.resolve(e.data)},function(e){n.reject(e)}),n.promise},this.generateVoidBill=function(e){var n=t.defer(),o="/api/bills/"+e.bill_id+"/void_bill";return a.postJSON(o,e.data).then(function(e){n.resolve(e.data)},function(e){n.reject(e)}),n.promise},this.settleFinalInvoice=function(e){var n=t.defer(),o="/api/bills/"+e.bill_id+"/final_invoice_settlement";return a.postJSON(o,e).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.printReceiptData=function(e){var a=t.defer(),n="/api/bills/"+e.bill_id+"/print_payment_receipt";return i.postJSON(n,e).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.emailReceiptData=function(e){var a=t.defer(),n="/api/bills/"+e.bill_id+"/email_payment_receipt";return i.postJSON(n,e).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise}}]),angular.module("sntRover").service("RVBillinginfoSrv",["$http","$q","BaseWebSrvV2","RVBaseWebSrv",function(e,t,a,n){this.fetchRoutes=function(e){var n=t.defer(),o="api/bill_routings/"+e+"/attached_entities";return a.getJSON(o).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchAttachedCards=function(e){var n=t.defer(),o="api/bill_routings/"+e+"/attached_cards";return a.getJSON(o).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchAvailableBillingGroups=function(e){var n=t.defer(),o="api/bill_routings/billing_groups?id="+e.id+"&to_bill="+e.to_bill+"&is_new="+e.is_new;return e.from_date&&(o=o+"&from_date="+e.from_date),e.to_date&&(o=o+"&to_date="+e.to_date),a.getJSON(o).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchAvailableChargeCodes=function(e){var n=t.defer(),o="api/bill_routings/charge_codes?id="+e.id+"&to_bill="+e.to_bill+"&is_new="+e.is_new;return e.from_date&&(o=o+"&from_date="+e.from_date),e.to_date&&(o=o+"&to_date="+e.to_date),a.getJSON(o).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchAllBillingGroups=function(){var e=t.defer(),n="/api/bill_routings/billing_groups?is_default_routing=true";return a.getJSON(n).then(function(t){e.resolve(t)},function(t){e.reject(t)}),e.promise},this.fetchAllChargeCodes=function(){var e=t.defer(),n="/api/bill_routings/charge_codes?is_default_routing=true";return a.getJSON(n).then(function(t){e.resolve(t)},function(t){e.reject(t)}),e.promise},this.fetchBillsForReservation=function(e){var n=t.defer(),o="api/bill_routings/"+e.id+"/bills.json";return""!==e.entity_type&&(o="api/bill_routings/"+e.id+"/bills.json?entity_type="+e.entity_type),a.getJSON(o).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.saveRoute=function(e){var n=t.defer(),o="api/bill_routings/save_routing";return a.postJSON(o,e).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.saveDefaultAccountRouting=function(e){var n=t.defer(),o="api/default_account_routings/save";return a.postJSON(o,e).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.saveAllotmentDefaultAccountRouting=function(e){var n=t.defer(),o="api/default_account_routings/save_allotment_default_billing_info";return a.postJSON(o,e).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.deleteRoute=function(e){var n=t.defer(),o="api//bill_routings/delete_routing";return a.postJSON(o,e).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchDefaultAccountRouting=function(e){var n=t.defer(),o="undefined"!=typeof e.entity_type&&""!==e.entity_type?"/api/default_account_routings/"+e.id+"?entity_type="+e.entity_type:"/api/default_account_routings/"+e.id;return a.getJSON(o).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.deleteDefaultRouting=function(e){var n=t.defer(),o="api/default_account_routings/"+e.id;return a.deleteJSON(o).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise}}]),angular.module("sntRover").service("RVMoveChargeSrv",["$http","$q","BaseWebSrvV2",function(e,t,a){this.fetchSearchedItems=function(e){var n=t.defer(),o="/api/bills/search_for_associated?search_by_no="+e.number_search+"&search_by_name="+e.text_search+"&bill_id="+e.bill_id;return a.getJSON(o).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.moveChargesToTargetEntity=function(e){var n=t.defer(),o="/api/bills/move_txn_diff_accounts";return a.postJSON(o,e).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise}}]),angular.module("sntRover").service("RVCompanyCardSrv",["$q","rvBaseWebSrvV2",function(e,t){var a=this,n={},o=6e4;a.companyTaArDetailsCached=[],a.companyTaNotes=[],a.cachedTime="",this.DEFAULT_PER_PAGE=10,this.DEFAULT_PAGE=1;var i={},r=this;this.fetchContactInformation=function(a){var n=a.id,o=e.defer(),i="/api/accounts/"+n,r=["is_eod_failed","is_eod_in_progress","is_eod_manual_started","is_eod_process_running"];return t.getJSON(i).then(function(e){o.resolve(_.omit(e,r))},function(e){o.reject(e)}),o.promise},this.fetchCompanyPaymentData=function(a){var n=e.defer(),o="/staff/payments/payment.json?account_id="+a;return t.getJSON(o).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.setAsPrimary=function(a){var n=e.defer(),o="api/accounts/"+a.account_id+"/set_wallet_payment_method_primary";return t.postJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.deletePayment=function(a){var n=e.defer(),o="api/accounts/"+a.account_id+"/delete_wallet_payment_methods";return t.postJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchContactInformationMandatoryFields=function(){var a=e.defer(),n="/admin/co_ta_settings/current_settings.json";return t.getJSON(n).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.fetchAccountPaymentData=function(a){var n=e.defer(),o="/staff/payments/payment.json?account_id="+a;return t.getJSON(o).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchContactInformationAndMandatoryFields=function(t){var a=e.defer(),n={};return e.when().then(function(){return r.fetchContactInformation(t).then(function(e){n=e})}).then(function(){return r.fetchContactInformationMandatoryFields().then(function(e){n.mandatoryFields=e})}).then(function(){a.resolve(n)},function(e){a.reject(e)}),a.promise},this.fetchCommissionDetail=function(){var a=e.defer(),n=" /api/hotel_settings/default_agent_commission_details";return t.getJSON(n).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.fetchCommissionDetailsAndMandatoryFields=function(){var t=e.defer(),a={};return e.when().then(function(){return r.fetchCommissionDetail().then(function(e){a=e})}).then(function(){return r.fetchContactInformationMandatoryFields().then(function(e){a.mandatoryFields=e})}).then(function(){t.resolve(a)},function(e){t.reject(e)}),t.promise},this.fetchMultiProperties=function(a){var n=e.defer(),o="/api/accounts/"+a.accountId+"/subscribed_properties";return t.getJSON(o).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise};var s=[];this.fetchCountryList=function(){var a=e.defer(),n="/ui/country_list";return s.length?a.resolve(s):t.getJSON(n).then(function(e){s=e,a.resolve(e)},function(e){a.reject(e)}),a.promise},this.saveContactInformation=function(a){var n,o,r=e.defer(),s="api/accounts/save.json",c=parseInt(a.id,10),l=_.omit(a,["workstation_id"]),d={data:l,deferred:r};return i[c]=i[c]||[],n=i[c],(o=n.find(function(e){return angular.equals(e.data,l)&&!e.resolved}))?o.deferred.promise:(n.push(d),t.postJSON(s,a).then(function(e){d.resolved=!0,r.resolve(e)},function(e){d.resolved=!0,r.reject(e)}),r.promise)},this.fetchRates=function(a){var n=e.defer(),o="/api/rates/contract_rates";return t.getJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.replaceCard=function(a){var n={old:{type:a.cardType},new:{type:a.cardType,id:a.id,use_card_rate:a.useCardRate},change_all_reservations:a.future},o=e.defer(),i="/api/reservations/"+a.reservation+"/cards/replace";return t.putJSON(i,n).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.removeCard=function(a){var n={type:a.cardType,id:a.cardId},o=e.defer(),i="/api/reservations/"+a.reservation+"/cards/remove";return t.deleteJSON(i,n).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.fetchArAccountDetails=function(n){var i=n.id,r=e.defer(),s="/api/accounts/"+i+"/ar_details";if(!a.companyTaArDetailsCached[i]||a.companyTaArDetailsCached[i].expiry&&Date.now()>a.companyTaArDetailsCached[i].expiry)a.companyTaArDetailsCached[i]=r,t.getJSON(s).then(function(e){a.companyTaArDetailsCached[i]={response:e,expiry:Date.now()+o},r.resolve(e)},function(e){r.reject(e)});else{if(!a.companyTaArDetailsCached[i].response)return a.companyTaArDetailsCached[i].promise;r.resolve(a.companyTaArDetailsCached[i].response)}return r.promise},this.fetchArAccountNotes=function(n){var i=n.id,r=e.defer(),s="/api/accounts/"+i+"/ar_notes";if(!a.companyTaNotes[i]||a.companyTaNotes[i].expiry&&Date.now()>a.companyTaNotes[i].expiry)a.companyTaNotes[i]=r,t.getJSON(s).then(function(e){a.companyTaNotes[i]={response:e,expiry:Date.now()+o},r.resolve(e)},function(e){r.reject(e)});else{if(!a.companyTaNotes[i].response)return a.companyTaNotes[i].promise;r.resolve(a.companyTaNotes[i].response)}return r.promise},this.saveARNote=function(n){var o=e.defer(),i="/api/accounts/save_ar_note",r=n.id;return t.postJSON(i,n).then(function(e){a.companyTaNotes[r]=null,o.resolve(e)},function(e){o.reject(e)}),o.promise},this.saveARDetails=function(n){var o=e.defer(),i="api/accounts/save_ar_details",r=n.id;return t.postJSON(i,n).then(function(e){a.companyTaArDetailsCached[r]=null,o.resolve(e)},function(e){o.reject(e)}),o.promise},this.deleteARNote=function(n){var o=e.defer(),i="/api/accounts/delete_ar_note",r=n.id;return t.postJSON(i,n).then(function(e){a.companyTaNotes[r]=null,o.resolve(e)},function(e){o.reject(e)}),o.promise},this.deleteArAccount=function(n){var o=n.id,i=e.defer(),r="api/accounts/"+o+"/delete_ar_detail";return t.deleteJSON(r).then(function(e){a.companyTaArDetailsCached[o]=null,i.resolve(e)},function(e){i.reject(e)}),i.promise},this.fetchArAccountsList=function(a){var n=e.defer(),o="/api/accounts/"+a.id+"/ar_transactions?paid="+a.paid+"&from_date="+a.from_date+"&to_date="+a.to_date+"&query="+a.query+"&page="+a.page_no+"&per_page="+a.per_page+"&transaction_type="+a.transaction_type;return t.getJSON(o).then(function(e){e.ar_transactions&&e.ar_transactions.length>0&&angular.forEach(e.ar_transactions,function(e){"DEBIT"===e.transaction_type&&(e.active=!1)}),n.resolve(e)},function(e){n.reject(e)}),n.promise},this.addCreditAmount=function(a){var n=e.defer(),o="api/accounts/"+a.id+"/ar_transactions";return t.postJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.payForReservation=function(a){var n=e.defer(),o="api/accounts/"+a.id+"/ar_transactions/"+a.transaction_id+"/pay";return t.postJSON(o).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.openForReservation=function(a){var n=e.defer(),o="api/accounts/"+a.id+"/ar_transactions/"+a.transaction_id+"/open";return t.postJSON(o).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.payAll=function(a){var n=e.defer(),o="api/accounts/"+a.id+"/ar_transactions/pay_all";return t.postJSON(o).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},a.fetchHotelLoyaltiesHlps=function(){var a=e.defer(),o="/staff/user_memberships/get_available_hlps.json";return n.fetchHotelLoyaltiesHlps?a.resolve(n.fetchHotelLoyaltiesHlps):t.getJSON(o).then(function(e){n.fetchHotelLoyaltiesHlps=e,a.resolve(e)},function(e){a.reject(e)}),a.promise},a.fetchHotelLoyaltiesFfp=function(){var a=e.defer(),o="/staff/user_memberships/get_available_ffps.json";return n.fetchHotelLoyaltiesFfp?a.resolve(n.fetchHotelLoyaltiesFfp):t.getJSON(o).then(function(e){n.fetchHotelLoyaltiesFfp=e,a.resolve(e)},function(e){a.reject(e)}),a.promise},this.fetchTACommissionDetails=function(a){var n=e.defer(),o=" api/accounts/"+a.accountId+"/commission_details";return t.getJSON(o,a.params).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.saveTACommissionDetails=function(a){var n=e.defer(),o={};o.reservations=a.commissionDetails;var i="api/accounts/"+a.accountId+"/save_commission_details";return t.postJSON(i,o).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchTransactionDetails=function(a){var n=e.defer(),o=" /api/bills/"+a.bill_id+"/transactions";return t.getJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchArStatementPrintData=function(a){var n=e.defer(),o="/api/ar_transactions/print";return t.postJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.emailArStatement=function(a){var n=e.defer(),o="/api/ar_transactions/email";return t.postJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchArStatementData=function(a){var n=e.defer(),o="/api/ar_transactions/get_email?id="+a.id;return t.getJSON(o).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.groupChargeDetailsFetch=function(a){var n=e.defer(),o="/staff/reservation/transaction_details";return t.getJSON(o,a).then(function(e){
n.resolve(e)},function(e){n.reject(e)}),n.promise},this.recalculateCommission=function(a){var n=e.defer(),o="/api/reservations/recalculate_commission_details";return t.postJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchCompanyTravelAgentStatisticsSummary=function(a){var n=e.defer(),o="/api/accounts/"+a.accountId+"/statistics?view=SUMMARY";return delete a.accountId,t.getJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchCompanyTravelAgentStatisticsDetails=function(a){var n=e.defer(),o="/api/accounts/"+a.accountId+"/statistics?view=DETAILED";return delete a.accountId,t.getJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchCompanyTravelAgentMonthlyReservations=function(a){var n=e.defer(),o="/api/accounts/"+a.accountId+"/statistics?view=RESERVATIONS";return delete a.accountId,t.getJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.verifyTravelAgentCompanyCardMerge=function(a){var n=e.defer(),o="/api/accounts/validate_card_merge";return t.postJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.mergeCards=function(a){var n=e.defer(),o="/api/accounts/merge_cards";return t.postJSON(o,a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise}}]),sntRover.controller("RVReceiptPopupController",["$scope","$rootScope","RVBillCardSrv","RVContactInfoSrv","ngDialog","$filter",function(e,t,a,n,o,i){BaseCtrl.call(this,e),e.getEmailButtonClass=function(){var t="blue";return e.data.mailto_address||(t="grey"),t},e.isEmailButtonDisabled=function(){var t=!1;return e.data.mailto_address||(t=!0),t},e.printReceipt=function(){var t=function(t){var a=t.data;if(a.is_copy_of_receipt){var n=a.copy_counter||"";a.receiptHeading=a.receipt_translations.copy_of_receipt.replace("#count",n)}else a.receiptHeading=a.receipt_translations.payment_receipt;e.$emit("PRINT_RECEIPT",a)},n={params:{bill_id:e.billId,transaction_id:e.transactionId,locale:e.data.locale},successCallBack:t};e.callAPI(a.printReceiptData,n)},e.closeDialog=function(){o.close()},e.showEmailSentStatusPopup=function(){o.open({template:"/assets/partials/popups/rvEmailSentStatusPopup.html",className:"",scope:e})},e.emailReceipt=function(){var t=function(){e.statusMsg=i("translate")("EMAIL_SEND_FAILED"),e.status="alert",e.showEmailSentStatusPopup()},n=function(t){e.statusMsg=i("translate")("EMAIL_SENT_SUCCESSFULLY"),e.status="success",e.showEmailSentStatusPopup()},o={params:{bill_id:e.billId,transaction_id:e.transactionId,to_address:e.data.mailto_address,locale:e.data.locale},successCallBack:n,failureCallBack:t};e.callAPI(a.emailReceiptData,o)};var r=function(t){t.languages&&(t.languages=_.filter(t.languages,{is_show_on_guest_card:!0})),e.languageData=t,e.data.locale=t.selected_language_code},s=function(){e.data={};var t={successCallBack:r};e.callAPI(n.fetchGuestLanguages,t)};s()}]);