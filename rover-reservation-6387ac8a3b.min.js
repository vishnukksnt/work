!function(a,b,c){!function(a){"use strict";"function"==typeof define&&define.amd?define(["jquery"],a):jQuery&&!jQuery.fn.qtip&&a(jQuery)}(function(d){"use strict";function e(a,b,c,e){this.id=c,this.target=a,this.tooltip=G,this.elements={target:a},this._id=T+"-"+c,this.timers={img:{}},this.options=b,this.plugins={},this.cache={event:{},target:d(),disabled:F,attr:e,onTooltip:F,lastClass:""},this.rendered=this.destroyed=this.disabled=this.waiting=this.hiddenDuringWait=this.positioning=this.triggering=F}function f(a){return a===G||"object"!==d.type(a)}function g(a){return!(d.isFunction(a)||a&&a.attr||a.length||"object"===d.type(a)&&(a.jquery||a.then))}function h(a){var b,c,e,h;return f(a)?F:(f(a.metadata)&&(a.metadata={type:a.metadata}),"content"in a&&(b=a.content,f(b)||b.jquery||b.done?b=a.content={text:c=g(b)?F:b}:c=b.text,"ajax"in b&&(e=b.ajax,h=e&&e.once!==F,delete b.ajax,b.text=function(a,b){var f=c||d(this).attr(b.options.content.attr)||"Loading...",g=d.ajax(d.extend({},e,{context:b})).then(e.success,G,e.error).then(function(a){return a&&h&&b.set("content.text",a),a},function(a,c,d){b.destroyed||0===a.status||b.set("content.text",c+": "+d)});return h?f:(b.set("content.text",f),g)}),"title"in b&&(f(b.title)||(b.button=b.title.button,b.title=b.title.text),g(b.title||F)&&(b.title=F))),"position"in a&&f(a.position)&&(a.position={my:a.position,at:a.position}),"show"in a&&f(a.show)&&(a.show=a.show.jquery?{target:a.show}:a.show===E?{ready:E}:{event:a.show}),"hide"in a&&f(a.hide)&&(a.hide=a.hide.jquery?{target:a.hide}:{event:a.hide}),"style"in a&&f(a.style)&&(a.style={classes:a.style}),d.each(S,function(){this.sanitize&&this.sanitize(a)}),a)}function i(a,b){for(var c,d=0,e=a,f=b.split(".");e=e[f[d++]];)d<f.length&&(c=e);return[c||a,f.pop()]}function j(a,b){var c,d,e;for(c in this.checks)for(d in this.checks[c])(e=new RegExp(d,"i").exec(a))&&(b.push(e),("builtin"===c||this.plugins[c])&&this.checks[c][d].apply(this.plugins[c]||this,b))}function k(a){return W.concat("").join(a?"-"+a+" ":" ")}function l(c){return c&&{type:c.type,pageX:c.pageX,pageY:c.pageY,target:c.target,relatedTarget:c.relatedTarget,scrollX:c.scrollX||a.pageXOffset||b.body.scrollLeft||b.documentElement.scrollLeft,scrollY:c.scrollY||a.pageYOffset||b.body.scrollTop||b.documentElement.scrollTop}||{}}function m(a,b){return b>0?setTimeout(d.proxy(a,this),b):(a.call(this),void 0)}function n(a){return this.tooltip.hasClass(bb)?F:(clearTimeout(this.timers.show),clearTimeout(this.timers.hide),this.timers.show=m.call(this,function(){this.toggle(E,a)},this.options.show.delay),void 0)}function o(a){if(this.tooltip.hasClass(bb))return F;var b=d(a.relatedTarget),c=b.closest(X)[0]===this.tooltip[0],e=b[0]===this.options.show.target[0];if(clearTimeout(this.timers.show),clearTimeout(this.timers.hide),this!==b[0]&&"mouse"===this.options.position.target&&c||this.options.hide.fixed&&/mouse(out|leave|move)/.test(a.type)&&(c||e))try{a.preventDefault(),a.stopImmediatePropagation()}catch(f){}else this.timers.hide=m.call(this,function(){this.toggle(F,a)},this.options.hide.delay,this)}function p(a){return this.tooltip.hasClass(bb)||!this.options.hide.inactive?F:(clearTimeout(this.timers.inactive),this.timers.inactive=m.call(this,function(){this.hide(a)},this.options.hide.inactive),void 0)}function q(a){this.rendered&&this.tooltip[0].offsetWidth>0&&this.reposition(a)}function r(a,c,e){d(b.body).delegate(a,(c.split?c:c.join(ib+" "))+ib,function(){var a=z.api[d.attr(this,V)];a&&!a.disabled&&e.apply(a,arguments)})}function s(a,c,f){var g,i,j,k,l,m=d(b.body),n=a[0]===b?m:a,o=a.metadata?a.metadata(f.metadata):G,p="html5"===f.metadata.type&&o?o[f.metadata.name]:G,q=a.data(f.metadata.name||"qtipopts");try{q="string"==typeof q?d.parseJSON(q):q}catch(r){}if(k=d.extend(E,{},z.defaults,f,"object"==typeof q?h(q):G,h(p||o)),i=k.position,k.id=c,"boolean"==typeof k.content.text){if(j=a.attr(k.content.attr),k.content.attr===F||!j)return F;k.content.text=j}if(i.container.length||(i.container=m),i.target===F&&(i.target=n),k.show.target===F&&(k.show.target=n),k.show.solo===E&&(k.show.solo=i.container.closest("body")),k.hide.target===F&&(k.hide.target=n),k.position.viewport===E&&(k.position.viewport=i.container),i.container=i.container.eq(0),i.at=new B(i.at,E),i.my=new B(i.my),a.data(T))if(k.overwrite)a.qtip("destroy",!0);else if(k.overwrite===F)return F;return a.attr(U,c),k.suppress&&(l=a.attr("title"))&&a.removeAttr("title").attr(db,l).attr("title",""),g=new e(a,k,c,(!!j)),a.data(T,g),a.one("remove.qtip-"+c+" removeqtip.qtip-"+c,function(){var a;(a=d(this).data(T))&&a.destroy(!0)}),g}function t(a){return a.charAt(0).toUpperCase()+a.slice(1)}function u(a,b){var d,e,f=b.charAt(0).toUpperCase()+b.slice(1),g=(b+" "+tb.join(f+" ")+f).split(" "),h=0;if(sb[b])return a.css(sb[b]);for(;d=g[h++];)if((e=a.css(d))!==c)return sb[b]=d,e}function v(a,b){return Math.ceil(parseFloat(u(a,b)))}function w(a,b){this._ns="tip",this.options=b,this.offset=b.offset,this.size=[b.width,b.height],this.init(this.qtip=a)}function x(a,b){this.options=b,this._ns="-modal",this.init(this.qtip=a)}function y(a){this._ns="ie6",this.init(this.qtip=a)}var z,A,B,C,D,E=!0,F=!1,G=null,H="x",I="y",J="width",K="height",L="top",M="left",N="bottom",O="right",P="center",Q="flipinvert",R="shift",S={},T="qtip",U="data-hasqtip",V="data-qtip-id",W=["ui-widget","ui-tooltip"],X="."+T,Y="click dblclick mousedown mouseup mousemove mouseleave mouseenter".split(" "),Z=T+"-fixed",$=T+"-default",_=T+"-focus",ab=T+"-hover",bb=T+"-disabled",cb="_replacedByqTip",db="oldtitle",eb={ie:function(){for(var a=3,c=b.createElement("div");(c.innerHTML="<!--[if gt IE "+ ++a+"]><i></i><![endif]-->")&&c.getElementsByTagName("i")[0];);return a>4?a:0/0}(),iOS:parseFloat((""+(/CPU.*OS ([0-9_]{1,5})|(CPU like).*AppleWebKit.*Mobile/i.exec(navigator.userAgent)||[0,""])[1]).replace("undefined","3_2").replace("_",".").replace("_",""))||F};A=e.prototype,A._when=function(a){return d.when.apply(d,a)},A.render=function(a){if(this.rendered||this.destroyed)return this;var b,c=this,e=this.options,f=this.cache,g=this.elements,h=e.content.text,i=e.content.title,j=e.content.button,k=e.position,l=("."+this._id+" ",[]);return d.attr(this.target[0],"aria-describedby",this._id),this.tooltip=g.tooltip=b=d("<div/>",{id:this._id,class:[T,$,e.style.classes,T+"-pos-"+e.position.my.abbrev()].join(" "),width:e.style.width||"",height:e.style.height||"",tracking:"mouse"===k.target&&k.adjust.mouse,role:"alert","aria-live":"polite","aria-atomic":F,"aria-describedby":this._id+"-content","aria-hidden":E}).toggleClass(bb,this.disabled).attr(V,this.id).data(T,this).appendTo(k.container).append(g.content=d("<div />",{class:T+"-content",id:this._id+"-content","aria-atomic":E})),this.rendered=-1,this.positioning=E,i&&(this._createTitle(),d.isFunction(i)||l.push(this._updateTitle(i,F))),j&&this._createButton(),d.isFunction(h)||l.push(this._updateContent(h,F)),this.rendered=E,this._setWidget(),d.each(S,function(a){var b;"render"===this.initialize&&(b=this(c))&&(c.plugins[a]=b)}),this._unassignEvents(),this._assignEvents(),this._when(l).then(function(){c._trigger("render"),c.positioning=F,c.hiddenDuringWait||!e.show.ready&&!a||c.toggle(E,f.event,F),c.hiddenDuringWait=F}),z.api[this.id]=this,this},A.destroy=function(a){function b(){if(!this.destroyed){this.destroyed=E;var a=this.target,b=a.attr(db);this.rendered&&this.tooltip.stop(1,0).find("*").remove().end().remove(),d.each(this.plugins,function(){this.destroy&&this.destroy()}),clearTimeout(this.timers.show),clearTimeout(this.timers.hide),this._unassignEvents(),a.removeData(T).removeAttr(V).removeAttr(U).removeAttr("aria-describedby"),this.options.suppress&&b&&a.attr("title",b).removeAttr(db),this._unbind(a),this.options=this.elements=this.cache=this.timers=this.plugins=this.mouse=G,delete z.api[this.id]}}return this.destroyed?this.target:(a===E&&"hide"!==this.triggering||!this.rendered?b.call(this):(this.tooltip.one("tooltiphidden",d.proxy(b,this)),!this.triggering&&this.hide()),this.target)},C=A.checks={builtin:{"^id$":function(a,b,c,e){var f=c===E?z.nextid:c,g=T+"-"+f;f!==F&&f.length>0&&!d("#"+g).length?(this._id=g,this.rendered&&(this.tooltip[0].id=this._id,this.elements.content[0].id=this._id+"-content",this.elements.title[0].id=this._id+"-title")):a[b]=e},"^prerender":function(a,b,c){c&&!this.rendered&&this.render(this.options.show.ready)},"^content.text$":function(a,b,c){this._updateContent(c)},"^content.attr$":function(a,b,c,d){this.options.content.text===this.target.attr(d)&&this._updateContent(this.target.attr(c))},"^content.title$":function(a,b,c){return c?(c&&!this.elements.title&&this._createTitle(),this._updateTitle(c),void 0):this._removeTitle()},"^content.button$":function(a,b,c){this._updateButton(c)},"^content.title.(text|button)$":function(a,b,c){this.set("content."+b,c)},"^position.(my|at)$":function(a,b,c){"string"==typeof c&&(a[b]=new B(c,"at"===b))},"^position.container$":function(a,b,c){this.rendered&&this.tooltip.appendTo(c)},"^show.ready$":function(a,b,c){c&&(!this.rendered&&this.render(E)||this.toggle(E))},"^style.classes$":function(a,b,c,d){this.rendered&&this.tooltip.removeClass(d).addClass(c)},"^style.(width|height)":function(a,b,c){this.rendered&&this.tooltip.css(b,c)},"^style.widget|content.title":function(){this.rendered&&this._setWidget()},"^style.def":function(a,b,c){this.rendered&&this.tooltip.toggleClass($,!!c)},"^events.(render|show|move|hide|focus|blur)$":function(a,b,c){this.rendered&&this.tooltip[(d.isFunction(c)?"":"un")+"bind"]("tooltip"+b,c)},"^(show|hide|position).(event|target|fixed|inactive|leave|distance|viewport|adjust)":function(){if(this.rendered){var a=this.options.position;this.tooltip.attr("tracking","mouse"===a.target&&a.adjust.mouse),this._unassignEvents(),this._assignEvents()}}}},A.get=function(a){if(this.destroyed)return this;var b=i(this.options,a.toLowerCase()),c=b[0][b[1]];return c.precedance?c.string():c};var fb=/^position\.(my|at|adjust|target|container|viewport)|style|content|show\.ready/i,gb=/^prerender|show\.ready/i;A.set=function(a,b){if(this.destroyed)return this;{var c,e=this.rendered,f=F,g=this.options;this.checks}return"string"==typeof a?(c=a,a={},a[c]=b):a=d.extend({},a),d.each(a,function(b,c){if(e&&gb.test(b))return delete a[b],void 0;var h,j=i(g,b.toLowerCase());h=j[0][j[1]],j[0][j[1]]=c&&c.nodeType?d(c):c,f=fb.test(b)||f,a[b]=[j[0],j[1],c,h]}),h(g),this.positioning=E,d.each(a,d.proxy(j,this)),this.positioning=F,this.rendered&&this.tooltip[0].offsetWidth>0&&f&&this.reposition("mouse"===g.position.target?G:this.cache.event),this},A._update=function(a,b){var c=this,e=this.cache;return this.rendered&&a?(d.isFunction(a)&&(a=a.call(this.elements.target,e.event,this)||""),d.isFunction(a.then)?(e.waiting=E,a.then(function(a){return e.waiting=F,c._update(a,b)},G,function(a){return c._update(a,b)})):a===F||!a&&""!==a?F:(a.jquery&&a.length>0?b.empty().append(a.css({display:"block",visibility:"visible"})):b.html(a),this._waitForContent(b).then(function(a){a.images&&a.images.length&&c.rendered&&c.tooltip[0].offsetWidth>0&&c.reposition(e.event,!a.length)}))):F},A._waitForContent=function(a){var b=this.cache;return b.waiting=E,(d.fn.imagesLoaded?a.imagesLoaded():d.Deferred().resolve([])).done(function(){b.waiting=F}).promise()},A._updateContent=function(a,b){this._update(a,this.elements.content,b)},A._updateTitle=function(a,b){this._update(a,this.elements.title,b)===F&&this._removeTitle(F)},A._createTitle=function(){var a=this.elements,b=this._id+"-title";a.titlebar&&this._removeTitle(),a.titlebar=d("<div />",{class:T+"-titlebar "+(this.options.style.widget?k("header"):"")}).append(a.title=d("<div />",{id:b,class:T+"-title","aria-atomic":E})).insertBefore(a.content).delegate(".qtip-close","mousedown keydown mouseup keyup mouseout",function(a){d(this).toggleClass("ui-state-active ui-state-focus","down"===a.type.substr(-4))}).delegate(".qtip-close","mouseover mouseout",function(a){d(this).toggleClass("ui-state-hover","mouseover"===a.type)}),this.options.content.button&&this._createButton()},A._removeTitle=function(a){var b=this.elements;b.title&&(b.titlebar.remove(),b.titlebar=b.title=b.button=G,a!==F&&this.reposition())},A.reposition=function(c,e){if(!this.rendered||this.positioning||this.destroyed)return this;this.positioning=E;var f,g,h=this.cache,i=this.tooltip,j=this.options.position,k=j.target,l=j.my,m=j.at,n=j.viewport,o=j.container,p=j.adjust,q=p.method.split(" "),r=i.outerWidth(F),s=i.outerHeight(F),t=0,u=0,v=i.css("position"),w={left:0,top:0},x=i[0].offsetWidth>0,y=c&&"scroll"===c.type,z=d(a),A=o[0].ownerDocument,B=this.mouse;if(d.isArray(k)&&2===k.length)m={x:M,y:L},w={left:k[0],top:k[1]};else if("mouse"===k)m={x:M,y:L},!B||!B.pageX||!p.mouse&&c&&c.pageX?c&&c.pageX||((!p.mouse||this.options.show.distance)&&h.origin&&h.origin.pageX?c=h.origin:(!c||c&&("resize"===c.type||"scroll"===c.type))&&(c=h.event)):c=B,"static"!==v&&(w=o.offset()),A.body.offsetWidth!==(a.innerWidth||A.documentElement.clientWidth)&&(g=d(b.body).offset()),w={left:c.pageX-w.left+(g&&g.left||0),top:c.pageY-w.top+(g&&g.top||0)},p.mouse&&y&&B&&(w.left-=(B.scrollX||0)-z.scrollLeft(),w.top-=(B.scrollY||0)-z.scrollTop());else{if("event"===k?c&&c.target&&"scroll"!==c.type&&"resize"!==c.type?h.target=d(c.target):c.target||(h.target=this.elements.target):"event"!==k&&(h.target=d(k.jquery?k:this.elements.target)),k=h.target,k=d(k).eq(0),0===k.length)return this;k[0]===b||k[0]===a?(t=eb.iOS?a.innerWidth:k.width(),u=eb.iOS?a.innerHeight:k.height(),k[0]===a&&(w={top:(n||k).scrollTop(),left:(n||k).scrollLeft()})):S.imagemap&&k.is("area")?f=S.imagemap(this,k,m,S.viewport?q:F):S.svg&&k&&k[0].ownerSVGElement?f=S.svg(this,k,m,S.viewport?q:F):(t=k.outerWidth(F),u=k.outerHeight(F),w=k.offset()),f&&(t=f.width,u=f.height,g=f.offset,w=f.position),w=this.reposition.offset(k,w,o),(eb.iOS>3.1&&eb.iOS<4.1||eb.iOS>=4.3&&eb.iOS<4.33||!eb.iOS&&"fixed"===v)&&(w.left-=z.scrollLeft(),w.top-=z.scrollTop()),(!f||f&&f.adjustable!==F)&&(w.left+=m.x===O?t:m.x===P?t/2:0,w.top+=m.y===N?u:m.y===P?u/2:0)}return w.left+=p.x+(l.x===O?-r:l.x===P?-r/2:0),w.top+=p.y+(l.y===N?-s:l.y===P?-s/2:0),S.viewport?(w.adjusted=S.viewport(this,w,j,t,u,r,s),g&&w.adjusted.left&&(w.left+=g.left),g&&w.adjusted.top&&(w.top+=g.top)):w.adjusted={left:0,top:0},this._trigger("move",[w,n.elem||n],c)?(delete w.adjusted,e===F||!x||isNaN(w.left)||isNaN(w.top)||"mouse"===k||!d.isFunction(j.effect)?i.css(w):d.isFunction(j.effect)&&(j.effect.call(i,this,d.extend({},w)),i.queue(function(a){d(this).css({opacity:"",height:""}),eb.ie&&this.style.removeAttribute("filter"),a()})),this.positioning=F,this):this},A.reposition.offset=function(a,c,e){function f(a,b){c.left+=b*a.scrollLeft(),c.top+=b*a.scrollTop()}if(!e[0])return c;var g,h,i,j,k=d(a[0].ownerDocument),l=!!eb.ie&&"CSS1Compat"!==b.compatMode,m=e[0];do"static"!==(h=d.css(m,"position"))&&("fixed"===h?(i=m.getBoundingClientRect(),f(k,-1)):(i=d(m).position(),i.left+=parseFloat(d.css(m,"borderLeftWidth"))||0,i.top+=parseFloat(d.css(m,"borderTopWidth"))||0),c.left-=i.left+(parseFloat(d.css(m,"marginLeft"))||0),c.top-=i.top+(parseFloat(d.css(m,"marginTop"))||0),g||"hidden"===(j=d.css(m,"overflow"))||"visible"===j||(g=d(m)));while(m=m.offsetParent);return g&&(g[0]!==k[0]||l)&&f(g,1),c};var hb=(B=A.reposition.Corner=function(a,b){a=(""+a).replace(/([A-Z])/," $1").replace(/middle/gi,P).toLowerCase(),this.x=(a.match(/left|right/i)||a.match(/center/)||["inherit"])[0].toLowerCase(),this.y=(a.match(/top|bottom|center/i)||["inherit"])[0].toLowerCase(),this.forceY=!!b;var c=a.charAt(0);this.precedance="t"===c||"b"===c?I:H}).prototype;hb.invert=function(a,b){this[a]=this[a]===M?O:this[a]===O?M:b||this[a]},hb.string=function(){var a=this.x,b=this.y;return a===b?a:this.precedance===I||this.forceY&&"center"!==b?b+" "+a:a+" "+b},hb.abbrev=function(){var a=this.string().split(" ");return a[0].charAt(0)+(a[1]&&a[1].charAt(0)||"")},hb.clone=function(){return new B(this.string(),this.forceY)},A.toggle=function(a,c){var e=this.cache,f=this.options,g=this.tooltip;if(c){if(/over|enter/.test(c.type)&&/out|leave/.test(e.event.type)&&f.show.target.add(c.target).length===f.show.target.length&&g.has(c.relatedTarget).length)return this;e.event=l(c)}if(this.waiting&&!a&&(this.hiddenDuringWait=E),!this.rendered)return a?this.render(1):this;if(this.destroyed||this.disabled)return this;var h,i,j,k=a?"show":"hide",m=this.options[k],n=(this.options[a?"hide":"show"],this.options.position),o=this.options.content,p=this.tooltip.css("width"),q=this.tooltip.is(":visible"),r=a||1===m.target.length,s=!c||m.target.length<2||e.target[0]===c.target;return(typeof a).search("boolean|number")&&(a=!q),h=!g.is(":animated")&&q===a&&s,i=h?G:!!this._trigger(k,[90]),this.destroyed?this:(i!==F&&a&&this.focus(c),!i||h?this:(d.attr(g[0],"aria-hidden",!a),a?(e.origin=l(this.mouse),d.isFunction(o.text)&&this._updateContent(o.text,F),d.isFunction(o.title)&&this._updateTitle(o.title,F),!D&&"mouse"===n.target&&n.adjust.mouse&&(d(b).bind("mousemove."+T,this._storeMouse),D=E),p||g.css("width",g.outerWidth(F)),this.reposition(c,arguments[2]),p||g.css("width",""),m.solo&&("string"==typeof m.solo?d(m.solo):d(X,m.solo)).not(g).not(m.target).qtip("hide",d.Event("tooltipsolo"))):(clearTimeout(this.timers.show),delete e.origin,D&&!d(X+'[tracking="true"]:visible',m.solo).not(g).length&&(d(b).unbind("mousemove."+T),D=F),this.blur(c)),j=d.proxy(function(){a?(eb.ie&&g[0].style.removeAttribute("filter"),g.css("overflow",""),"string"==typeof m.autofocus&&d(this.options.show.autofocus,g).focus(),this.options.show.target.trigger("qtip-"+this.id+"-inactive")):g.css({display:"",visibility:"",opacity:"",left:"",top:""}),this._trigger(a?"visible":"hidden")},this),m.effect===F||r===F?(g[k](),j()):d.isFunction(m.effect)?(g.stop(1,1),m.effect.call(g,this),g.queue("fx",function(a){j(),a()})):g.fadeTo(90,a?1:0,j),a&&m.target.trigger("qtip-"+this.id+"-inactive"),this))},A.show=function(a){return this.toggle(E,a)},A.hide=function(a){return this.toggle(F,a)},A.focus=function(a){if(!this.rendered||this.destroyed)return this;var b=d(X),c=this.tooltip,e=parseInt(c[0].style.zIndex,10),f=z.zindex+b.length;return c.hasClass(_)||this._trigger("focus",[f],a)&&(e!==f&&(b.each(function(){this.style.zIndex>e&&(this.style.zIndex=this.style.zIndex-1)}),b.filter("."+_).qtip("blur",a)),c.addClass(_)[0].style.zIndex=f),this},A.blur=function(a){return!this.rendered||this.destroyed?this:(this.tooltip.removeClass(_),this._trigger("blur",[this.tooltip.css("zIndex")],a),this)},A.disable=function(a){return this.destroyed?this:("toggle"===a?a=!(this.rendered?this.tooltip.hasClass(bb):this.disabled):"boolean"!=typeof a&&(a=E),this.rendered&&this.tooltip.toggleClass(bb,a).attr("aria-disabled",a),this.disabled=!!a,this)},A.enable=function(){return this.disable(F)},A._createButton=function(){var a=this,b=this.elements,c=b.tooltip,e=this.options.content.button,f="string"==typeof e,g=f?e:"Close tooltip";b.button&&b.button.remove(),b.button=e.jquery?e:d("<a />",{class:"qtip-close "+(this.options.style.widget?"":T+"-icon"),title:g,"aria-label":g}).prepend(d("<span />",{class:"ui-icon ui-icon-close",html:"&times;"})),b.button.appendTo(b.titlebar||c).attr("role","button").click(function(b){return c.hasClass(bb)||a.hide(b),F})},A._updateButton=function(a){if(!this.rendered)return F;var b=this.elements.button;a?this._createButton():b.remove()},A._setWidget=function(){var a=this.options.style.widget,b=this.elements,c=b.tooltip,d=c.hasClass(bb);c.removeClass(bb),bb=a?"ui-state-disabled":"qtip-disabled",c.toggleClass(bb,d),c.toggleClass("ui-helper-reset "+k(),a).toggleClass($,this.options.style.def&&!a),b.content&&b.content.toggleClass(k("content"),a),b.titlebar&&b.titlebar.toggleClass(k("header"),a),b.button&&b.button.toggleClass(T+"-icon",!a)},A._storeMouse=function(a){(this.mouse=l(a)).type="mousemove"},A._bind=function(a,b,c,e,f){var g="."+this._id+(e?"-"+e:"");b.length&&d(a).bind((b.split?b:b.join(g+" "))+g,d.proxy(c,f||this))},A._unbind=function(a,b){d(a).unbind("."+this._id+(b?"-"+b:""))};var ib="."+T;d(function(){r(X,["mouseenter","mouseleave"],function(a){var b="mouseenter"===a.type,c=d(a.currentTarget),e=d(a.relatedTarget||a.target),f=this.options;b?(this.focus(a),c.hasClass(Z)&&!c.hasClass(bb)&&clearTimeout(this.timers.hide)):"mouse"===f.position.target&&f.hide.event&&f.show.target&&!e.closest(f.show.target[0]).length&&this.hide(a),c.toggleClass(ab,b)}),r("["+V+"]",Y,p)}),A._trigger=function(a,b,c){var e=d.Event("tooltip"+a);return e.originalEvent=c&&d.extend({},c)||this.cache.event||G,this.triggering=a,this.tooltip.trigger(e,[this].concat(b||[])),this.triggering=F,!e.isDefaultPrevented()},A._bindEvents=function(a,b,c,e,f,g){if(e.add(c).length===e.length){var h=[];b=d.map(b,function(b){var c=d.inArray(b,a);return c>-1?(h.push(a.splice(c,1)[0]),void 0):b}),h.length&&this._bind(c,h,function(a){var b=this.rendered?this.tooltip[0].offsetWidth>0:!1;(b?g:f).call(this,a)})}this._bind(c,a,f),this._bind(e,b,g)},A._assignInitialEvents=function(a){function b(a){return this.disabled||this.destroyed?F:(this.cache.event=l(a),this.cache.target=a?d(a.target):[c],clearTimeout(this.timers.show),this.timers.show=m.call(this,function(){this.render("object"==typeof a||e.show.ready)},e.show.delay),void 0)}var e=this.options,f=e.show.target,g=e.hide.target,h=e.show.event?d.trim(""+e.show.event).split(" "):[],i=e.hide.event?d.trim(""+e.hide.event).split(" "):[];/mouse(over|enter)/i.test(e.show.event)&&!/mouse(out|leave)/i.test(e.hide.event)&&i.push("mouseleave"),this._bind(f,"mousemove",function(a){this._storeMouse(a),this.cache.onTarget=E}),this._bindEvents(h,i,f,g,b,function(){clearTimeout(this.timers.show)}),(e.show.ready||e.prerender)&&b.call(this,a)},A._assignEvents=function(){var c=this,e=this.options,f=e.position,g=this.tooltip,h=e.show.target,i=e.hide.target,j=f.container,k=f.viewport,l=d(b),m=(d(b.body),d(a)),r=e.show.event?d.trim(""+e.show.event).split(" "):[],s=e.hide.event?d.trim(""+e.hide.event).split(" "):[];d.each(e.events,function(a,b){c._bind(g,"toggle"===a?["tooltipshow","tooltiphide"]:["tooltip"+a],b,null,g)}),/mouse(out|leave)/i.test(e.hide.event)&&"window"===e.hide.leave&&this._bind(l,["mouseout","blur"],function(a){/select|option/.test(a.target.nodeName)||a.relatedTarget||this.hide(a)}),e.hide.fixed?i=i.add(g.addClass(Z)):/mouse(over|enter)/i.test(e.show.event)&&this._bind(i,"mouseleave",function(){clearTimeout(this.timers.show)}),(""+e.hide.event).indexOf("unfocus")>-1&&this._bind(j.closest("html"),["mousedown","touchstart"],function(a){var b=d(a.target),c=this.rendered&&!this.tooltip.hasClass(bb)&&this.tooltip[0].offsetWidth>0,e=b.parents(X).filter(this.tooltip[0]).length>0;b[0]===this.target[0]||b[0]===this.tooltip[0]||e||this.target.has(b[0]).length||!c||this.hide(a)}),"number"==typeof e.hide.inactive&&(this._bind(h,"qtip-"+this.id+"-inactive",p),this._bind(i.add(g),z.inactiveEvents,p,"-inactive")),this._bindEvents(r,s,h,i,n,o),this._bind(h.add(g),"mousemove",function(a){if("number"==typeof e.hide.distance){var b=this.cache.origin||{},c=this.options.hide.distance,d=Math.abs;(d(a.pageX-b.pageX)>=c||d(a.pageY-b.pageY)>=c)&&this.hide(a)}this._storeMouse(a)}),"mouse"===f.target&&f.adjust.mouse&&(e.hide.event&&this._bind(h,["mouseenter","mouseleave"],function(a){this.cache.onTarget="mouseenter"===a.type}),this._bind(l,"mousemove",function(a){this.rendered&&this.cache.onTarget&&!this.tooltip.hasClass(bb)&&this.tooltip[0].offsetWidth>0&&this.reposition(a)})),(f.adjust.resize||k.length)&&this._bind(d.event.special.resize?k:m,"resize",q),f.adjust.scroll&&this._bind(m.add(f.container),"scroll",q)},A._unassignEvents=function(){var c=[this.options.show.target[0],this.options.hide.target[0],this.rendered&&this.tooltip[0],this.options.position.container[0],this.options.position.viewport[0],this.options.position.container.closest("html")[0],a,b];this._unbind(d([]).pushStack(d.grep(c,function(a){return"object"==typeof a})))},z=d.fn.qtip=function(a,b,e){var f=(""+a).toLowerCase(),g=G,i=d.makeArray(arguments).slice(1),j=i[i.length-1],k=this[0]?d.data(this[0],T):G;return!arguments.length&&k||"api"===f?k:"string"==typeof a?(this.each(function(){var a=d.data(this,T);if(!a)return E;if(j&&j.timeStamp&&(a.cache.event=j),!b||"option"!==f&&"options"!==f)a[f]&&a[f].apply(a,i);else{if(e===c&&!d.isPlainObject(b))return g=a.get(b),F;a.set(b,e)}}),g!==G?g:this):"object"!=typeof a&&arguments.length?void 0:(k=h(d.extend(E,{},a)),this.each(function(a){var b,c;return c=d.isArray(k.id)?k.id[a]:k.id,c=!c||c===F||c.length<1||z.api[c]?z.nextid++:c,b=s(d(this),c,k),b===F?E:(z.api[c]=b,d.each(S,function(){"initialize"===this.initialize&&this(b)}),b._assignInitialEvents(j),void 0)}))},d.qtip=e,z.api={},d.each({attr:function(a,b){if(this.length){var c=this[0],e="title",f=d.data(c,"qtip");if(a===e&&f&&"object"==typeof f&&f.options.suppress)return arguments.length<2?d.attr(c,db):(f&&f.options.content.attr===e&&f.cache.attr&&f.set("content.text",b),this.attr(db,b))}return d.fn["attr"+cb].apply(this,arguments)},clone:function(a){var b=(d([]),d.fn["clone"+cb].apply(this,arguments));return a||b.filter("["+db+"]").attr("title",function(){return d.attr(this,db)}).removeAttr(db),b}},function(a,b){if(!b||d.fn[a+cb])return E;var c=d.fn[a+cb]=d.fn[a];d.fn[a]=function(){return b.apply(this,arguments)||c.apply(this,arguments)}}),d.ui||(d["cleanData"+cb]=d.cleanData,d.cleanData=function(a){for(var b,c=0;(b=d(a[c])).length;c++)if(b.attr(U))try{b.triggerHandler("removeqtip")}catch(e){}d["cleanData"+cb].apply(this,arguments)}),z.version="@@VERSION",z.nextid=0,z.inactiveEvents=Y,z.zindex=15e3,z.defaults={prerender:F,id:F,overwrite:E,suppress:E,content:{text:E,attr:"title",title:F,button:F},position:{my:"top left",at:"bottom right",target:F,container:F,viewport:F,adjust:{x:0,y:0,mouse:E,scroll:E,resize:E,method:"flipinvert flipinvert"},effect:function(a,b){d(this).animate(b,{duration:200,queue:F})}},show:{target:F,event:"mouseenter",effect:E,delay:90,solo:F,ready:F,autofocus:F},hide:{target:F,event:"mouseleave",effect:E,delay:0,fixed:F,inactive:F,leave:"window",distance:F},style:{classes:"",widget:F,width:F,height:F,def:E},events:{render:G,move:G,show:G,hide:G,toggle:G,visible:G,hidden:G,focus:G,blur:G}};var jb,kb="margin",lb="border",mb="color",nb="background-color",ob="transparent",pb=" !important",qb=!!b.createElement("canvas").getContext,rb=/rgba?\(0, 0, 0(, 0)?\)|transparent|#123456/i,sb={},tb=["Webkit","O","Moz","ms"];if(qb)var ub=a.devicePixelRatio||1,vb=function(){var a=b.createElement("canvas").getContext("2d");return a.backingStorePixelRatio||a.webkitBackingStorePixelRatio||a.mozBackingStorePixelRatio||a.msBackingStorePixelRatio||a.oBackingStorePixelRatio||1}(),wb=ub/vb;else var xb=function(a,b,c){return"<qtipvml:"+a+' xmlns="urn:schemas-microsoft.com:vml" class="qtip-vml" '+(b||"")+' style="behavior: url(#default#VML); '+(c||"")+'" />'};d.extend(w.prototype,{init:function(a){var b,c;c=this.element=a.elements.tip=d("<div />",{class:T+"-tip"}).prependTo(a.tooltip),qb?(b=d("<canvas />").appendTo(this.element)[0].getContext("2d"),b.lineJoin="miter",b.miterLimit=1e5,b.save()):(b=xb("shape",'coordorigin="0,0"',"position:absolute;"),this.element.html(b+b),a._bind(d("*",c).add(c),["click","mousedown"],function(a){a.stopPropagation()},this._ns)),a._bind(a.tooltip,"tooltipmove",this.reposition,this._ns,this),this.create()},_swapDimensions:function(){this.size[0]=this.options.height,this.size[1]=this.options.width},_resetDimensions:function(){this.size[0]=this.options.width,this.size[1]=this.options.height},_useTitle:function(a){var b=this.qtip.elements.titlebar;return b&&(a.y===L||a.y===P&&this.element.position().top+this.size[1]/2+this.options.offset<b.outerHeight(E))},_parseCorner:function(a){var b=this.qtip.options.position.my;return a===F||b===F?a=F:a===E?a=new B(b.string()):a.string||(a=new B(a),a.fixed=E),a},_parseWidth:function(a,b,c){var d=this.qtip.elements,e=lb+t(b)+"Width";return(c?v(c,e):v(d.content,e)||v(this._useTitle(a)&&d.titlebar||d.content,e)||v(d.tooltip,e))||0},_parseRadius:function(a){var b=this.qtip.elements,c=lb+t(a.y)+t(a.x)+"Radius";return eb.ie<9?0:v(this._useTitle(a)&&b.titlebar||b.content,c)||v(b.tooltip,c)||0},_invalidColour:function(a,b,c){var d=a.css(b);return!d||c&&d===a.css(c)||rb.test(d)?F:d},_parseColours:function(a){var b=this.qtip.elements,c=this.element.css("cssText",""),e=lb+t(a[a.precedance])+t(mb),f=this._useTitle(a)&&b.titlebar||b.content,g=this._invalidColour,h=[];return h[0]=g(c,nb)||g(f,nb)||g(b.content,nb)||g(b.tooltip,nb)||c.css(nb),h[1]=g(c,e,mb)||g(f,e,mb)||g(b.content,e,mb)||g(b.tooltip,e,mb)||b.tooltip.css(e),d("*",c).add(c).css("cssText",nb+":"+ob+pb+";"+lb+":0"+pb+";"),h},_calculateSize:function(a){var b,c,d,e=a.precedance===I,f=this.options.width,g=this.options.height,h="c"===a.abbrev(),i=(e?f:g)*(h?.5:1),j=Math.pow,k=Math.round,l=Math.sqrt(j(i,2)+j(g,2)),m=[this.border/i*l,this.border/g*l];return m[2]=Math.sqrt(j(m[0],2)-j(this.border,2)),m[3]=Math.sqrt(j(m[1],2)-j(this.border,2)),b=l+m[2]+m[3]+(h?0:m[0]),c=b/l,d=[k(c*f),k(c*g)],e?d:d.reverse()},_calculateTip:function(a,b,c){c=c||1,b=b||this.size;var d=b[0]*c,e=b[1]*c,f=Math.ceil(d/2),g=Math.ceil(e/2),h={br:[0,0,d,e,d,0],bl:[0,0,d,0,0,e],tr:[0,e,d,0,d,e],tl:[0,0,0,e,d,e],tc:[0,e,f,0,d,e],bc:[0,0,d,0,f,e],rc:[0,0,d,g,0,e],lc:[d,0,d,e,0,g]};return h.lt=h.br,h.rt=h.bl,h.lb=h.tr,h.rb=h.tl,h[a.abbrev()]},_drawCoords:function(a,b){a.beginPath(),a.moveTo(b[0],b[1]),a.lineTo(b[2],b[3]),a.lineTo(b[4],b[5]),a.closePath()},create:function(){var a=this.corner=(qb||eb.ie)&&this._parseCorner(this.options.corner);return(this.enabled=!!this.corner&&"c"!==this.corner.abbrev())&&(this.qtip.cache.corner=a.clone(),this.update()),this.element.toggle(this.enabled),this.corner},update:function(b,c){if(!this.enabled)return this;var e,f,g,h,i,j,k,l,m=this.qtip.elements,n=this.element,o=n.children(),p=this.options,q=this.size,r=p.mimic,s=Math.round;b||(b=this.qtip.cache.corner||this.corner),r===F?r=b:(r=new B(r),r.precedance=b.precedance,"inherit"===r.x?r.x=b.x:"inherit"===r.y?r.y=b.y:r.x===r.y&&(r[b.precedance]=b[b.precedance])),f=r.precedance,b.precedance===H?this._swapDimensions():this._resetDimensions(),e=this.color=this._parseColours(b),e[1]!==ob?(l=this.border=this._parseWidth(b,b[b.precedance]),p.border&&1>l&&!rb.test(e[1])&&(e[0]=e[1]),this.border=l=p.border!==E?p.border:l):this.border=l=0,k=this.size=this._calculateSize(b),n.css({width:k[0],height:k[1],lineHeight:k[1]+"px"}),j=b.precedance===I?[s(r.x===M?l:r.x===O?k[0]-q[0]-l:(k[0]-q[0])/2),s(r.y===L?k[1]-q[1]:0)]:[s(r.x===M?k[0]-q[0]:0),s(r.y===L?l:r.y===N?k[1]-q[1]-l:(k[1]-q[1])/2)],qb?(g=o[0].getContext("2d"),g.restore(),g.save(),g.clearRect(0,0,6e3,6e3),h=this._calculateTip(r,q,wb),i=this._calculateTip(r,this.size,wb),o.attr(J,k[0]*wb).attr(K,k[1]*wb),o.css(J,k[0]).css(K,k[1]),this._drawCoords(g,i),g.fillStyle=e[1],g.fill(),g.translate(j[0]*wb,j[1]*wb),this._drawCoords(g,h),g.fillStyle=e[0],g.fill()):(h=this._calculateTip(r),h="m"+h[0]+","+h[1]+" l"+h[2]+","+h[3]+" "+h[4]+","+h[5]+" xe",j[2]=l&&/^(r|b)/i.test(b.string())?8===eb.ie?2:1:0,o.css({coordsize:k[0]+l+" "+(k[1]+l),antialias:""+(r.string().indexOf(P)>-1),left:j[0]-j[2]*Number(f===H),top:j[1]-j[2]*Number(f===I),width:k[0]+l,height:k[1]+l}).each(function(a){var b=d(this);b[b.prop?"prop":"attr"]({coordsize:k[0]+l+" "+(k[1]+l),path:h,fillcolor:e[0],filled:!!a,stroked:!a}).toggle(!(!l&&!a)),!a&&b.html(xb("stroke",'weight="'+2*l+'px" color="'+e[1]+'" miterlimit="1000" joinstyle="miter"'))})),a.opera&&setTimeout(function(){m.tip.css({display:"inline-block",visibility:"visible"})},1),c!==F&&this.calculate(b,k)},calculate:function(a,b){if(!this.enabled)return F;var c,e,f=this,g=this.qtip.elements,h=this.element,i=this.options.offset,j=(g.tooltip.hasClass("ui-widget"),{});return a=a||this.corner,c=a.precedance,b=b||this._calculateSize(a),e=[a.x,a.y],c===H&&e.reverse(),d.each(e,function(d,e){var h,k,l;e===P?(h=c===I?M:L,j[h]="50%",j[kb+"-"+h]=-Math.round(b[c===I?0:1]/2)+i):(h=f._parseWidth(a,e,g.tooltip),
k=f._parseWidth(a,e,g.content),l=f._parseRadius(a),j[e]=Math.max(-f.border,d?k:i+(l>h?l:-h)))}),j[a[c]]-=b[c===H?0:1],h.css({margin:"",top:"",bottom:"",left:"",right:""}).css(j),j},reposition:function(a,b,d){function e(a,b,c,d,e){a===R&&j.precedance===b&&k[d]&&j[c]!==P?j.precedance=j.precedance===H?I:H:a!==R&&k[d]&&(j[b]=j[b]===P?k[d]>0?d:e:j[b]===d?e:d)}function f(a,b,e){j[a]===P?p[kb+"-"+b]=o[a]=g[kb+"-"+b]-k[b]:(h=g[e]!==c?[k[b],-g[b]]:[-k[b],g[b]],(o[a]=Math.max(h[0],h[1]))>h[0]&&(d[b]-=k[b],o[b]=F),p[g[e]!==c?e:b]=o[a])}if(this.enabled){var g,h,i=b.cache,j=this.corner.clone(),k=d.adjusted,l=b.options.position.adjust.method.split(" "),m=l[0],n=l[1]||l[0],o={left:F,top:F,x:0,y:0},p={};this.corner.fixed!==E&&(e(m,H,I,M,O),e(n,I,H,L,N),j.string()===i.corner.string()||i.cornerTop===k.top&&i.cornerLeft===k.left||this.update(j,F)),g=this.calculate(j),g.right!==c&&(g.left=-g.right),g.bottom!==c&&(g.top=-g.bottom),g.user=this.offset,(o.left=m===R&&!!k.left)&&f(H,M,O),(o.top=n===R&&!!k.top)&&f(I,L,N),this.element.css(p).toggle(!(o.x&&o.y||j.x===P&&o.y||j.y===P&&o.x)),d.left-=g.left.charAt?g.user:m!==R||o.top||!o.left&&!o.top?g.left+this.border:0,d.top-=g.top.charAt?g.user:n!==R||o.left||!o.left&&!o.top?g.top+this.border:0,i.cornerLeft=k.left,i.cornerTop=k.top,i.corner=j.clone()}},destroy:function(){this.qtip._unbind(this.qtip.tooltip,this._ns),this.qtip.elements.tip&&this.qtip.elements.tip.find("*").remove().end().remove()}}),jb=S.tip=function(a){return new w(a,a.options.style.tip)},jb.initialize="render",jb.sanitize=function(a){if(a.style&&"tip"in a.style){var b=a.style.tip;"object"!=typeof b&&(b=a.style.tip={corner:b}),/string|boolean/i.test(typeof b.corner)||(b.corner=E)}},C.tip={"^position.my|style.tip.(corner|mimic|border)$":function(){this.create(),this.qtip.reposition()},"^style.tip.(height|width)$":function(a){this.size=[a.width,a.height],this.update(),this.qtip.reposition()},"^content.title|style.(classes|widget)$":function(){this.update()}},d.extend(E,z.defaults,{style:{tip:{corner:E,mimic:F,width:6,height:6,border:E,offset:0}}});var yb,zb,Ab="qtip-modal",Bb="."+Ab;zb=function(){function a(a){if(d.expr[":"].focusable)return d.expr[":"].focusable;var b,c,e,f=!isNaN(d.attr(a,"tabindex")),g=a.nodeName&&a.nodeName.toLowerCase();return"area"===g?(b=a.parentNode,c=b.name,a.href&&c&&"map"===b.nodeName.toLowerCase()?(e=d("img[usemap=#"+c+"]")[0],!!e&&e.is(":visible")):!1):/input|select|textarea|button|object/.test(g)?!a.disabled:"a"===g?a.href||f:f}function c(a){k.length<1&&a.length?a.not("body").blur():k.first().focus()}function e(a){if(i.is(":visible")){var b,e=d(a.target),h=f.tooltip,j=e.closest(X);b=j.length<1?F:parseInt(j[0].style.zIndex,10)>parseInt(h[0].style.zIndex,10),b||e.closest(X)[0]===h[0]||c(e),g=a.target===k[k.length-1]}}var f,g,h,i,j=this,k={};d.extend(j,{init:function(){return i=j.elem=d("<div />",{id:"qtip-overlay",html:"<div></div>",mousedown:function(){return F}}).hide(),d(b.body).bind("focusin"+Bb,e),d(b).bind("keydown"+Bb,function(a){f&&f.options.show.modal.escape&&27===a.keyCode&&f.hide(a)}),i.bind("click"+Bb,function(a){f&&f.options.show.modal.blur&&f.hide(a)}),j},update:function(b){f=b,k=b.options.show.modal.stealfocus!==F?b.tooltip.find("*").filter(function(){return a(this)}):[]},toggle:function(a,e,g){var k=(d(b.body),a.tooltip),l=a.options.show.modal,m=l.effect,n=e?"show":"hide",o=i.is(":visible"),p=d(Bb).filter(":visible:not(:animated)").not(k);return j.update(a),e&&l.stealfocus!==F&&c(d(":focus")),i.toggleClass("blurs",l.blur),e&&i.appendTo(b.body),i.is(":animated")&&o===e&&h!==F||!e&&p.length?j:(i.stop(E,F),d.isFunction(m)?m.call(i,e):m===F?i[n]():i.fadeTo(parseInt(g,10)||90,e?1:0,function(){e||i.hide()}),e||i.queue(function(a){i.css({left:"",top:""}),d(Bb).length||i.detach(),a()}),h=e,f.destroyed&&(f=G),j)}}),j.init()},zb=new zb,d.extend(x.prototype,{init:function(a){var b=a.tooltip;return this.options.on?(a.elements.overlay=zb.elem,b.addClass(Ab).css("z-index",z.modal_zindex+d(Bb).length),a._bind(b,["tooltipshow","tooltiphide"],function(a,c,e){var f=a.originalEvent;if(a.target===b[0])if(f&&"tooltiphide"===a.type&&/mouse(leave|enter)/.test(f.type)&&d(f.relatedTarget).closest(zb.elem[0]).length)try{a.preventDefault()}catch(g){}else(!f||f&&"tooltipsolo"!==f.type)&&this.toggle(a,"tooltipshow"===a.type,e)},this._ns,this),a._bind(b,"tooltipfocus",function(a,c){if(!a.isDefaultPrevented()&&a.target===b[0]){var e=d(Bb),f=z.modal_zindex+e.length,g=parseInt(b[0].style.zIndex,10);zb.elem[0].style.zIndex=f-1,e.each(function(){this.style.zIndex>g&&(this.style.zIndex-=1)}),e.filter("."+_).qtip("blur",a.originalEvent),b.addClass(_)[0].style.zIndex=f,zb.update(c);try{a.preventDefault()}catch(h){}}},this._ns,this),a._bind(b,"tooltiphide",function(a){a.target===b[0]&&d(Bb).filter(":visible").not(b).last().qtip("focus",a)},this._ns,this),void 0):this},toggle:function(a,b,c){return a&&a.isDefaultPrevented()?this:(zb.toggle(this.qtip,!!b,c),void 0)},destroy:function(){this.qtip.tooltip.removeClass(Ab),this.qtip._unbind(this.qtip.tooltip,this._ns),zb.toggle(this.qtip,F),delete this.qtip.elements.overlay}}),yb=S.modal=function(a){return new x(a,a.options.show.modal)},yb.sanitize=function(a){a.show&&("object"!=typeof a.show.modal?a.show.modal={on:!!a.show.modal}:"undefined"==typeof a.show.modal.on&&(a.show.modal.on=E))},z.modal_zindex=z.zindex-200,yb.initialize="render",C.modal={"^show.modal.(on|blur)$":function(){this.destroy(),this.init(),this.qtip.elems.overlay.toggle(this.qtip.tooltip[0].offsetWidth>0)}},d.extend(E,z.defaults,{show:{modal:{on:F,effect:E,blur:E,stealfocus:E,escape:E}}}),S.viewport=function(c,d,e,f,g,h,i){function j(a,b,c,e,f,g,h,i,j){var k=d[f],m=v[a],t=w[a],u=c===R,x=m===f?j:m===g?-j:-j/2,y=t===f?i:t===g?-i:-i/2,z=r[f]+s[f]-(o?0:n[f]),A=z-k,B=k+j-(h===J?p:q)-z,C=x-(v.precedance===a||m===v[b]?y:0)-(t===P?i/2:0);return u?(C=(m===f?1:-1)*x,d[f]+=A>0?A:B>0?-B:0,d[f]=Math.max(-n[f]+s[f],k-C,Math.min(Math.max(-n[f]+s[f]+(h===J?p:q),k+C),d[f],"center"===m?k-x:1e9))):(e*=c===Q?2:0,A>0&&(m!==f||B>0)?(d[f]-=C+e,l.invert(a,f)):B>0&&(m!==g||A>0)&&(d[f]-=(m===P?-C:C)+e,l.invert(a,g)),d[f]<r&&-d[f]>B&&(d[f]=k,l=v.clone())),d[f]-k}var k,l,m,n,o,p,q,r,s,t=e.target,u=c.elements.tooltip,v=e.my,w=e.at,x=e.adjust,y=x.method.split(" "),z=y[0],A=y[1]||y[0],B=e.viewport,C=e.container,D=c.cache,E={left:0,top:0};return B.jquery&&t[0]!==a&&t[0]!==b.body&&"none"!==x.method?(n=C.offset()||E,o="static"===C.css("position"),k="fixed"===u.css("position"),p=B[0]===a?B.width():B.outerWidth(F),q=B[0]===a?B.height():B.outerHeight(F),r={left:k?0:B.scrollLeft(),top:k?0:B.scrollTop()},s=B.offset()||E,("shift"!==z||"shift"!==A)&&(l=v.clone()),E={left:"none"!==z?j(H,I,z,x.x,M,O,J,f,h):0,top:"none"!==A?j(I,H,A,x.y,L,N,K,g,i):0},l&&D.lastClass!==(m=T+"-pos-"+l.abbrev())&&u.removeClass(c.cache.lastClass).addClass(c.cache.lastClass=m),E):E},S.polys={polygon:function(a,b){var c,d,e,f={width:0,height:0,position:{top:1e10,right:0,bottom:0,left:1e10},adjustable:F},g=0,h=[],i=1,j=1,k=0,l=0;for(g=a.length;g--;)c=[parseInt(a[--g],10),parseInt(a[g+1],10)],c[0]>f.position.right&&(f.position.right=c[0]),c[0]<f.position.left&&(f.position.left=c[0]),c[1]>f.position.bottom&&(f.position.bottom=c[1]),c[1]<f.position.top&&(f.position.top=c[1]),h.push(c);if(d=f.width=Math.abs(f.position.right-f.position.left),e=f.height=Math.abs(f.position.bottom-f.position.top),"c"===b.abbrev())f.position={left:f.position.left+f.width/2,top:f.position.top+f.height/2};else{for(;d>0&&e>0&&i>0&&j>0;)for(d=Math.floor(d/2),e=Math.floor(e/2),b.x===M?i=d:b.x===O?i=f.width-d:i+=Math.floor(d/2),b.y===L?j=e:b.y===N?j=f.height-e:j+=Math.floor(e/2),g=h.length;g--&&!(h.length<2);)k=h[g][0]-f.position.left,l=h[g][1]-f.position.top,(b.x===M&&k>=i||b.x===O&&i>=k||b.x===P&&(i>k||k>f.width-i)||b.y===L&&l>=j||b.y===N&&j>=l||b.y===P&&(j>l||l>f.height-j))&&h.splice(g,1);f.position={left:h[0][0],top:h[0][1]}}return f},rect:function(a,b,c,d){return{width:Math.abs(c-a),height:Math.abs(d-b),position:{left:Math.min(a,c),top:Math.min(b,d)}}},_angles:{tc:1.5,tr:7/4,tl:5/4,bc:.5,br:.25,bl:.75,rc:2,lc:1,c:0},ellipse:function(a,b,c,d,e){var f=S.polys._angles[e.abbrev()],g=0===f?0:c*Math.cos(f*Math.PI),h=d*Math.sin(f*Math.PI);return{width:2*c-Math.abs(g),height:2*d-Math.abs(h),position:{left:a+g,top:b+h},adjustable:F}},circle:function(a,b,c,d){return S.polys.ellipse(a,b,c,c,d)}},S.svg=function(a,c,e){for(var f,g,h,i,j,k,l,m,n,o,p,q=d(b),r=c[0],s=d(r.ownerSVGElement),t=1,u=1,v=!0;!r.getBBox;)r=r.parentNode;if(!r.getBBox||!r.parentNode)return F;f=s.attr("width")||s.width()||parseInt(s.css("width"),10),g=s.attr("height")||s.height()||parseInt(s.css("height"),10);var w=(parseInt(c.css("stroke-width"),10)||0)/2;switch(w&&(t+=w/f,u+=w/g),r.nodeName){case"ellipse":case"circle":o=S.polys.ellipse(r.cx.baseVal.value,r.cy.baseVal.value,(r.rx||r.r).baseVal.value+w,(r.ry||r.r).baseVal.value+w,e);break;case"line":case"polygon":case"polyline":for(n=r.points||[{x:r.x1.baseVal.value,y:r.y1.baseVal.value},{x:r.x2.baseVal.value,y:r.y2.baseVal.value}],o=[],m=-1,k=n.numberOfItems||n.length;++m<k;)l=n.getItem?n.getItem(m):n[m],o.push.apply(o,[l.x,l.y]);o=S.polys.polygon(o,e);break;default:o=r.getBoundingClientRect(),o={width:o.width,height:o.height,position:{left:o.left,top:o.top}},v=!1}return p=o.position,s=s[0],v&&(s.createSVGPoint&&(h=r.getScreenCTM(),n=s.createSVGPoint(),n.x=p.left,n.y=p.top,i=n.matrixTransform(h),p.left=i.x,p.top=i.y),s.viewBox&&(j=s.viewBox.baseVal)&&j.width&&j.height&&(t*=f/j.width,u*=g/j.height)),p.left+=q.scrollLeft(),p.top+=q.scrollTop(),o},S.imagemap=function(a,b,c){b.jquery||(b=d(b));var e,f,g,h,i,j=b.attr("shape").toLowerCase().replace("poly","polygon"),k=d('img[usemap="#'+b.parent("map").attr("name")+'"]'),l=d.trim(b.attr("coords")),m=l.replace(/,$/,"").split(",");if(!k.length)return F;if("polygon"===j)h=S.polys.polygon(m,c);else{if(!S.polys[j])return F;for(g=-1,i=m.length,f=[];++g<i;)f.push(parseInt(m[g],10));h=S.polys[j].apply(this,f.concat(c))}return e=k.offset(),e.left+=Math.ceil((k.outerWidth(F)-k.width())/2),e.top+=Math.ceil((k.outerHeight(F)-k.height())/2),h.position.left+=e.left,h.position.top+=e.top,h};var Cb,Db='<iframe class="qtip-bgiframe" frameborder="0" tabindex="-1" src="javascript:\'\';"  style="display:block; position:absolute; z-index:-1; filter:alpha(opacity=0); -ms-filter:"progid:DXImageTransform.Microsoft.Alpha(Opacity=0)";"></iframe>';d.extend(y.prototype,{_scroll:function(){var b=this.qtip.elements.overlay;b&&(b[0].style.top=d(a).scrollTop()+"px")},init:function(c){var e=c.tooltip;d("select, object").length<1&&(this.bgiframe=c.elements.bgiframe=d(Db).appendTo(e),c._bind(e,"tooltipmove",this.adjustBGIFrame,this._ns,this)),this.redrawContainer=d("<div/>",{id:T+"-rcontainer"}).appendTo(b.body),c.elements.overlay&&c.elements.overlay.addClass("qtipmodal-ie6fix")&&(c._bind(a,["scroll","resize"],this._scroll,this._ns,this),c._bind(e,["tooltipshow"],this._scroll,this._ns,this)),this.redraw()},adjustBGIFrame:function(){var a,b,c=this.qtip.tooltip,d={height:c.outerHeight(F),width:c.outerWidth(F)},e=this.qtip.plugins.tip,f=this.qtip.elements.tip;b=parseInt(c.css("borderLeftWidth"),10)||0,b={left:-b,top:-b},e&&f&&(a="x"===e.corner.precedance?[J,M]:[K,L],b[a[1]]-=f[a[0]]()),this.bgiframe.css(b).css(d)},redraw:function(){if(this.qtip.rendered<1||this.drawing)return this;var a,b,c,d,e=this.qtip.tooltip,f=this.qtip.options.style,g=this.qtip.options.position.container;return this.qtip.drawing=1,f.height&&e.css(K,f.height),f.width?e.css(J,f.width):(e.css(J,"").appendTo(this.redrawContainer),b=e.width(),1>b%2&&(b+=1),c=e.css("maxWidth")||"",d=e.css("minWidth")||"",a=(c+d).indexOf("%")>-1?g.width()/100:0,c=(c.indexOf("%")>-1?a:1)*parseInt(c,10)||b,d=(d.indexOf("%")>-1?a:1)*parseInt(d,10)||0,b=c+d?Math.min(Math.max(b,d),c):b,e.css(J,Math.round(b)).appendTo(g)),this.drawing=0,this},destroy:function(){this.bgiframe&&this.bgiframe.remove(),this.qtip._unbind([a,this.qtip.tooltip],this._ns)}}),Cb=S.ie6=function(a){return 6===eb.ie?new y(a):F},Cb.initialize="render",C.ie6={"^content|style$":function(){this.redraw()}}})}(window,document);
var saveAs=saveAs||function(e){"use strict";if(typeof e==="undefined"||typeof navigator!=="undefined"&&/MSIE [1-9]\./.test(navigator.userAgent)){return}var t=e.document,n=function(){return e.URL||e.webkitURL||e},r=t.createElementNS("http://www.w3.org/1999/xhtml","a"),o="download"in r,a=function(e){var t=new MouseEvent("click");e.dispatchEvent(t)},i=/constructor/i.test(e.HTMLElement)||e.safari,f=/CriOS\/[\d]+/.test(navigator.userAgent),u=function(t){(e.setImmediate||e.setTimeout)(function(){throw t},0)},s="application/octet-stream",d=1e3*40,c=function(e){var t=function(){if(typeof e==="string"){n().revokeObjectURL(e)}else{e.remove()}};setTimeout(t,d)},l=function(e,t,n){t=[].concat(t);var r=t.length;while(r--){var o=e["on"+t[r]];if(typeof o==="function"){try{o.call(e,n||e)}catch(a){u(a)}}}},p=function(e){if(/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(e.type)){return new Blob([String.fromCharCode(65279),e],{type:e.type})}return e},v=function(t,u,d){if(!d){t=p(t)}var v=this,w=t.type,m=w===s,y,h=function(){l(v,"writestart progress write writeend".split(" "))},S=function(){if((f||m&&i)&&e.FileReader){var r=new FileReader;r.onloadend=function(){var t=f?r.result:r.result.replace(/^data:[^;]*;/,"data:attachment/file;");var n=e.open(t,"_blank");if(!n)e.location.href=t;t=undefined;v.readyState=v.DONE;h()};r.readAsDataURL(t);v.readyState=v.INIT;return}if(!y){y=n().createObjectURL(t)}if(m){e.location.href=y}else{var o=e.open(y,"_blank");if(!o){e.location.href=y}}v.readyState=v.DONE;h();c(y)};v.readyState=v.INIT;if(o){y=n().createObjectURL(t);setTimeout(function(){r.href=y;r.download=u;a(r);h();c(y);v.readyState=v.DONE});return}S()},w=v.prototype,m=function(e,t,n){return new v(e,t||e.name||"download",n)};if(typeof navigator!=="undefined"&&navigator.msSaveOrOpenBlob){return function(e,t,n){t=t||e.name||"download";if(!n){e=p(e)}return navigator.msSaveOrOpenBlob(e,t)}}w.abort=function(){};w.readyState=w.INIT=0;w.WRITING=1;w.DONE=2;w.error=w.onwritestart=w.onprogress=w.onwrite=w.onabort=w.onerror=w.onwriteend=null;return m}(typeof self!=="undefined"&&self||typeof window!=="undefined"&&window||this.content);if(typeof module!=="undefined"&&module.exports){module.exports.saveAs=saveAs}else if(typeof define!=="undefined"&&define!==null&&define.amd!==null){define("FileSaver.js",function(){return saveAs})}
"use strict";function _defineProperty(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function _defineProperty(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function _defineProperty(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function _defineProperty(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function _defineProperty(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}!function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){function r(e,t){"number"==typeof t&&(t=t.toString());var a=e-t.length;if(a<=0)return t;for(var r="",n=1;n<=a;n++)r+="0";return r+t}angular.module("sntRover").filter("makeRange",function(){return function(e){var t,a,n=1,o=0;switch(e.length){case 1:t=0,a=parseInt(e[0])-1;break;case 2:t=parseInt(e[0]),a=parseInt(e[1]);break;case 3:t=parseInt(e[0]),a=parseInt(e[1]),n=parseInt(e[2]);break;case 4:t=parseInt(e[0]),a=parseInt(e[1]),n=parseInt(e[2]),o=parseInt(e[3]);break;default:return e}for(var i=[],s="",c=t;c<=a;c+=n)s=r(o,c),i.push(s);return i}})},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){angular.module("sntRover").controller("guestCardController",["$scope","$window","RVCompanyCardSrv","$q","RVReservationAllCardsSrv","RVGuestCardsSrv","RVContactInfoSrv","$stateParams","$timeout","ngDialog","$rootScope","RVSearchSrv","RVReservationDataService","rvGroupSrv","$state","rvAllotmentSrv","$vault","rvPermissionSrv","rvFileCloudStorageSrv","rvUtilSrv",function(e,t,a,r,n,o,i,s,c,d,l,u,m,f,p,v,D,h,y,g){function C(e,t){var a=e.target;return t.contains(a)}function A(){e.reservationData.guest.id&&"guest-card"===e.UICards[0]&&!o.isGuestFetchComplete(e.reservationData.guest.id)&&e.callAPI(o.fetchGuestDetailsInformation,{successCallBack:function(t){e.$emit("UPDATE_GUEST_CARD_DETAILS",t),e.$broadcast("UPDATE_CONTACT_INFO")},failureCallBack:function(t){e.errorMessage=t,e.$emit("hideLoader")},params:e.reservationData.guest.id})}var S=90,I=$(window).height()-S,T=this,E=function(){if(T.newUpdatedData=e.decloneUnwantedKeysFromContactInfo(),""!==T.newUpdatedData.email&&!g.isEmailValid(T.newUpdatedData.email))return void c(function(){e.errorMessage=["Email is Invalid"],e.guestCardData.contactInfo.email=k.email},100);var t=function(){e.$emit("contactInfoError",!0)},a=function(t){e.$emit("hideLoader"),e.reservationData.guest.email=T.newUpdatedData.email,e.updateSearchCache(),e.isGuestCardSaveInProgress=!1,e.$broadcast("RESETCONTACTINFO",T.newUpdatedData)};if(JSON.stringify(e.getContactInfo(k))!==JSON.stringify(e.getContactInfo(T.newUpdatedData))){k=T.newUpdatedData;var r={data:k,userId:e.guestCardData.contactInfo.user_id};"undefined"!=typeof r.userId&&(e.isGuestCardSaveInProgress=!0,e.invokeApi(i.updateGuest,r,a,t))}};e.dimensionsLookup={resizableMaxHeight:I,cardTabContentOffset:170},e.cardVisible=!1,e.activeCard="companyCard",e.isPrintArStatement=!1;var R="rover.reservation.staycard.mainCard.room-rates",b="rover.reservation.staycard.reservationcard.reservationdetails";BaseCtrl.call(this,e),GuestCardBaseCtrl.call(this,e,u,i,h,l),e.hasOverBookRoomTypePermission=h.getPermissionValue("OVERBOOK_ROOM_TYPE"),e.hasOverBookHousePermission=h.getPermissionValue("OVERBOOK_HOUSE"),e.hasBorrowFromHousePermission=h.getPermissionValue("GROUP_HOUSE_BORROW");var N=function(){var t=D.get("searchReservationData"),a=t?JSON.parse(t):{};if(t&&(e.searchData.guestCard.guestFirstName=a.guestFirstName,e.searchData.guestCard.guestLastName=a.guestLastName,D.remove("searchReservationData")),s.guestId&&(e.reservationDetails.guestCard.id=s.guestId),e.reservationData.isSameCard&&e.otherData.reservationCreated)e.closeGuestCard(),(e.reservationDetails.guestCard.id||e.reservationData.guest.id)&&e.initGuestCard({id:e.reservationDetails.guestCard.id||e.reservationData.guest.id}),e.reservationDetails.companyCard.id&&!e.reservationData.group.id&&e.initCompanyCard({id:e.reservationDetails.companyCard.id}),e.reservationDetails.travelAgent.id&&!e.reservationData.group.id&&e.initTravelAgentCard({id:e.reservationDetails.travelAgent.id}),e.reservationData.group.id&&l.isStandAlone&&(e.initGroupCard(e.reservationData.group.id),e.reservationData.group.travelAgent&&(e.reservationDetails.travelAgent.id=e.reservationData.group.travelAgent,e.initTravelAgentCard()),e.reservationData.group.company&&(e.reservationDetails.companyCard.id=e.reservationData.group.company,e.initCompanyCard())),e.reservationData.allotment.id&&l.isStandAlone&&(e.initAllotmentCard(e.reservationData.allotment.id),e.reservationData.allotment.travelAgent&&(e.reservationDetails.travelAgent.id=e.reservationData.allotment.travelAgent,e.initTravelAgentCard()),e.reservationData.allotment.company&&(e.reservationDetails.companyCard.id=e.reservationData.allotment.company,e.initCompanyCard())),e.reservationData.isSameCard=!1;else{var r=e.reservationData;if(""!==e.searchData.guestCard.guestFirstName||""!==e.searchData.guestCard.guestLastName||null!==r.company.id||null!==r.travelAgent.id||e.reservationData.group.id||e.reservationData.allotment.id){if(e.reservationData.guest&&e.reservationData.guest.id)e.openGuestCard();else if(""===e.reservationDetails.guestCard.id)""===e.searchData.guestCard.guestFirstName&&""===e.searchData.guestCard.guestLastName||(e.openGuestCard(),e.searchGuest());else{var n,o=D.get("guestDetails"),c=o?JSON.parse(o):{};n=_.isEmpty(c)?"":i.parseGuestData(c,e.reservationDetails.guestCard.id),n&&(e.openGuestCard(),e.selectGuest(n))}r.company.id&&!e.reservationData.group.id&&(""===e.searchData.guestCard.guestFirstName&&""===e.searchData.guestCard.guestLastName&&s.reservation&&"HOURLY"!==s.reservation&&s.mode&&"OTHER"!==s.mode&&e.switchCard("company-card"),e.reservationDetails.companyCard.id=r.company.id,e.initCompanyCard({id:r.company.id})),r.travelAgent.id&&!e.reservationData.group.id&&(""===e.searchData.guestCard.guestFirstName&&""===e.searchData.guestCard.guestLastName&&s.reservation&&"HOURLY"!==s.reservation&&s.mode&&"OTHER"!==s.mode&&e.switchCard("travel-agent-card"),e.reservationDetails.travelAgent.id=r.travelAgent.id,e.initTravelAgentCard({id:r.travelAgent.id})),e.reservationData.group.id&&l.isStandAlone&&(e.initGroupCard(e.reservationData.group.id),e.reservationData.group.travelAgent&&(e.reservationDetails.travelAgent.id=e.reservationData.group.travelAgent,e.initTravelAgentCard()),e.reservationData.group.company&&(e.reservationDetails.companyCard.id=e.reservationData.group.company,e.initCompanyCard())),e.reservationData.allotment.id&&l.isStandAlone&&(e.initAllotmentCard(e.reservationData.allotment.id),e.reservationData.allotment.travelAgent&&(e.reservationDetails.travelAgent.id=e.reservationData.allotment.travelAgent,e.initTravelAgentCard()),e.reservationData.allotment.company&&(e.reservationDetails.companyCard.id=e.reservationData.allotment.company,e.initCompanyCard()))}}e.otherData.fromSearch&&(e.otherData.fromSearch=!1)};e.init=function(){if("CREATION"===e.viewState.identifier)N();else{e.contactInfoError=!1,e.eventTimestamp="";e.guestCardData.contactInfo.address.state||(e.guestCardData.contactInfo.address.state=e.reservationData.guest.address.state),e.guestCardData.contactInfo.address.city||(e.guestCardData.contactInfo.address.city=e.reservationData.guest.address.city)}e.hasPermissionToCreateTACard=h.getPermissionValue("CREATE_TRAVEL_AGENT_CARD"),e.hasPermissionToCreateCCard=h.getPermissionValue("CREATE_COMPANY_CARD")},e.emailTabKey=function(t){t.preventDefault(),e.openGuestCard(),document.getElementById("titleId")?document.getElementById("titleId").getElementsByTagName("input")[0].focus():""},e.$on("swipeAtGuestCard",function(){e.guestCardTabSwitch("guest-wallet")}),e.$on("resetGuestTab",function(){e.guestCardTabSwitch("guest-contact")}),e.$on("guest_email_updated",function(t,a){e.guestCardData.contactInfo.email=a}),e.$on("reservationCardisClicked",function(){$("#guest-card").css("height",e.resizableOptions.minHeight),e.guestCardVisible=!1,e.cardVisible=!1}),e.guestCardVisible=!1,e.guestCardHeight=90,e.$watch("windowHeight",function(t,a){e.windowHeight=t}),e.shouldDisableCompanyCardDetachButton=function(){return!!e.reservationData.groupCompanyCardId},e.shouldDisableTACardDetachButton=function(){return!!e.reservationData.groupTravelAgentId},e.resizableOptions={minHeight:S,maxHeight:I,handles:"s",resize:function(t,a){$(this).height()>120&&!e.guestCardVisible?(e.guestCardVisible=!0,e.cardVisible=!0,e.$emit("GUESTCARDVISIBLE",!0),e.$apply()):$(this).height()<=120&&e.guestCardVisible&&(e.guestCardVisible=!1,e.cardVisible=!1,e.handleDrawClosing(),e.$emit("GUESTCARDVISIBLE",!1),e.$apply()),e.guestCardHeight=$(this).height(),"guest-card"===e.UICards[0]?(e.$broadcast("CONTACTINFOLOADED"),e.$broadcast("REFRESHLIKESSCROLL")):(e.$broadcast("contactTabActive"),e.$broadcast("contractTabActive"),e.$broadcast("refreshAccountsScroll"))},stop:function(t,a){preventClicking=!0,e.eventTimestamp=t.timeStamp},start:A},e.decloneUnwantedKeysFromContactInfo=function(){var t=["birthday","country","is_opted_promotion_email","job_title","passport_expiry","passport_number","postal_code","reservation_id","title","user_id","works_at","avatar"],a=dclone(e.guestCardData.contactInfo,t);return a};var P=e.decloneUnwantedKeysFromContactInfo(),k=P;e.current="guest-contact",e.$on("RESETHEADERDATA",function(e,t){k.address=t.address,k.phone=t.phone,k.email=t.email,k.first_name=t.first_name,k.last_name=t.last_name}),e.guestCardTabSwitch=function(t){"guest-contact"===e.current&&"guest-contact"!==t&&(e.viewState.isAddNewCard?e.$broadcast("showSaveMessage"):e.$broadcast("saveContactInfo")),"guest-like"===e.current&&"guest-like"!==t&&e.$broadcast("SAVELIKES"),"guest-wallet"===t?e.$broadcast("PAYMENTSCROLL"):"guest-like"===t?(e.$broadcast("GUESTLIKETABACTIVE"),e.$broadcast("REFRESHLIKESSCROLL")):"guest-contact"===t?e.$broadcast("CONTACTINFOLOADED"):"activity-log"===t?e.$broadcast("GUEST_ACTIVITY_LOADED"):"guest-statistics"===t&&e.$broadcast("LOAD_GUEST_STATISTICS"),e.$broadcast("REFRESHLIKESSCROLL"),e.viewState.isAddNewCard||(e.current=t)},e.$on("contactInfoError",function(t,a){a&&(e.current="guest-contact")}),e.$on("likesInfoError",function(t,a){e.likesInfoError=a}),e.updateContactInfo=function(){E()},e.guestCardClick=function(t){l.$emit("clearErroMessages"),e.$broadcast("clearNotifications");t.target;if(t.stopPropagation(),t.stopImmediatePropagation(),e.isMenuOpen())return e.closeDrawer(),!1;if(C(t,document.getElementsByClassName("ui-resizable-handle")[0])){if(e.$broadcast("saveContactInfo"),e.$broadcast("SAVELIKES"),parseInt(e.eventTimestamp)&&t.timeStamp-e.eventTimestamp<100)return;var a=e.guestCardHeight;a===S||a===I?e.guestCardVisible?e.guestCardVisible&&a===I&&(e.closeGuestCard(),e.$emit("GUESTCARDVISIBLE",!1)):(e.openGuestCard(),e.$broadcast("CONTACTINFOLOADED"),e.$emit("GUESTCARDVISIBLE",!0)):(e.closeGuestCard(),e.$emit("GUESTCARDVISIBLE",!1))}else if(C(t,document.getElementById("guest-card-content"))){if("guest-card-tabs-nav"!==t.target.id&&"cards-header"!==t.target.id)return;e.$broadcast("saveContactInfo"),e.$broadcast("SAVELIKES")}},e.$on("OPEN_GUEST_CARD",function(){e.openGuestCard()}),e.checkOutsideClick=function(t){e.cardVisible&&(e.$broadcast("saveContactInfo"),e.$broadcast("SAVELIKES")),$(t).closest(".nav-bar").length<1&&$(t).closest(".stay-card-alerts").length<1&&$(t).closest(".guest-card").length<1&&$(t).closest(".ngdialog").length<1&&$(t).find("#loading").length<1&&$(t).closest("#loading").length<1&&$(t).closest(".nav-toggle").length<1&&e.closeGuestCard()},e.UICards=["guest-card","company-card","travel-agent-card","group-card","allotment-card"];var O=["first","second","third","fourth","fifth"];e.UICardClass=function(t){var a="";return a=t!==e.UICards[0]?"change-card "+O[e.UICards.indexOf(t)]:O[0]},e.UICardContentCls=function(t){var a="";return a=t!==e.UICards[0]?"hidden":"visible"},e.cardCls=function(){var t=e.UICards[0];return"group-card"===t&&(e.reservationData.allotment.id&&(t="allotment-card"),e.reservationData.allotment.id||e.reservationData.group.id||(t="group-allotment-card")),e.cardVisible&&(t+=" open"),(l.isHourlyRateOn||"FULL"===l.hotelDiaryConfig.mode)&&(t+=" hourly"),e.isPrintArStatement&&(t+=" print-statement"),t},e.switchCard=function(t){var a=e.UICards.indexOf(t),r=e.UICards[0];e.UICards[0]=t,e.UICards[a]=r,"company-card"!==e.UICards[0]&&"travel-agent-card"!==e.UICards[0]||(e.activeCard="company-card"===e.UICards[0]?"companyCard":"travelAgent",e.$broadcast("activeCardChanged"))},e.openGuestCard=function(){e.cardVisible=!0,e.guestCardVisible=!0,e.guestCardHeight=I,e.isGuestCardVisible=!0,e.$broadcast("contactTabActive"),A()},e.closeGuestCard=function(){e.guestCardHeight=S,e.handleDrawClosing(),e.cardVisible=!1,e.guestCardVisible=!1},e.handleDrawClosing=function(){e.viewState.pendingRemoval.status&&e.removeCard(e.viewState.pendingRemoval.cardType)},e.clickedDiscardCard=function(e,t){w(e,t)};var w=function(t,a){e.viewState.isAddNewCard=!1,"travel_agent"===t?e.$broadcast("travelAgentDetached"):"company"===t?e.$broadcast("companyCardDetached"):"guest"===t&&e.$broadcast("guestCardDetached")},M={resetGuest:function(){e.reservationData.guest.id="",e.reservationData.guest.firstName="",e.reservationData.guest.lastName="",e.reservationData.guest.city="",e.reservationData.guest.loyaltyNumber="",e.reservationData.guest.email="",e.guestFirstName="",e.guestLastName="",e.guestCity="",e.guestCardData.cardHeaderImage=""},resetCompanyCard:function(){e.reservationData.company.id="",e.reservationData.company.name="",e.reservationData.company.corporateid="",e.companyName="",e.companyCity="",e.reservationDetails.companyCard.id=""},resetTravelAgent:function(){e.reservationData.travelAgent.id="",e.reservationData.travelAgent.name="",e.reservationData.travelAgent.iataNumber="",e.travelAgentName="",e.travelAgentCity="",e.reservationDetails.travelAgent.id=""}},L=function(){M.resetCompanyCard(),M.resetTravelAgent(),e.reservationDetails.companyCard.id="",e.reservationDetails.travelAgent.id="",e.$broadcast("companyCardDetached"),e.$broadcast("travelAgentDetached")},x=function(){if(L(),"CREATION"===e.viewState.identifier)e.reservationData.group={id:"",name:"",code:"",company:"",travelAgent:""},e.showContractedRates({companyCard:e.reservationDetails.companyCard.id,travelAgent:e.reservationDetails.travelAgent.id}),e.$broadcast("groupCardDetached"),e.closeGuestCard();else{e.closeGuestCard(),re();var t={isGroupDetachmentRequested:!0};e.navigateToRoomAndRates(t)}},F=function(){L(),"CREATION"===e.viewState.identifier?(e.reservationData.allotment={id:"",name:"",code:"",company:"",travelAgent:""},e.showContractedRates({companyCard:e.reservationDetails.companyCard.id,travelAgent:e.reservationDetails.travelAgent.id}),e.$broadcast("groupCardDetached"),e.closeGuestCard()):ie()},B=function(t){d.open({template:"/assets/partials/cards/popups/detachCardsAPIWarningPopup.html",scope:e,closeByDocument:!1,closeByEscape:!1,data:JSON.stringify(t)})};e.detachCompanyCard=function(){if("CREATION"===e.viewState.identifier){var t=e.reservationDetails;M.resetCompanyCard(),e.showContractedRates({companyCard:t.companyCard.id,travelAgent:t.travelAgent.id}),e.$broadcast("companyCardDetached")}else{var a={cardTypeText:"Company Card",cardType:"company",cardId:e.reservationDetails.companyCard.id};B(a)}};var G=function(){return"CHECKEDOUT"===e.reservationData.status&&new Date(e.userInfo.business_date)>new Date(e.reservationData.departureDate)};e.detachTravelAgent=function(){if(G()){var t=function(t){if(t.commission_info&&t.commission_info.is_paid_or_held)d.open({template:"/assets/partials/cards/popups/rvCommisonHoldOrPaidWarning.html",className:"ngdialog-theme-default stay-card-alerts",scope:e,closeByDocument:!1,closeByEscape:!1});else{var a=!0;e.detachTACard(a)}};e.callAPI(i.checkIfCommisionWasRecalculated,{params:{reservation_id:e.reservationData.reservationId},successCallBack:t})}else e.detachTACard()},e.detachTACard=function(t){if("CREATION"===e.viewState.identifier){var a=e.reservationDetails;M.resetTravelAgent(),e.showContractedRates({companyCard:a.companyCard.id,travelAgent:a.travelAgent.id}),e.$broadcast("travelAgentDetached")}else{var r={cardTypeText:"Travel Agent Card",cardType:"travel_agent",cardId:e.reservationDetails.travelAgent.id,showCommisionWarning:t||!1};B(r)}},e.detachGuestCard=function(){if("CREATION"===e.viewState.identifier)M.resetGuest(),e.$broadcast("guestCardDetached");else{var t={cardTypeText:"Guest Card",cardType:"guest",cardId:e.reservationDetails.guestCard.id};d.open({template:"/assets/partials/cards/alerts/detachCard.html",className:"ngdialog-theme-default stay-card-alerts",scope:e,closeByDocument:!1,closeByEscape:!1,data:JSON.stringify(t)})}};var V=function(t){"travel_agent"===t?e.$broadcast("travelAgentDetached"):"company"===t?e.$broadcast("companyCardDetached"):"guest"===t&&e.$broadcast("guestCardDetached")};e.deleteCard=function(t,a){e.closeDialog(),V(t),c(function(){e.closeGuestCard(),e.removeCard(t,a)},700)},e.$on("CARD_REMOVED",function(e,t){V(t)});var U=function(e,t){var a=e.guestFirstName===t.first_name;return a=a&&e.guestLastName===t.last_name,a=a&&e.guestCity===t.city,a=a&&e.guestLoyaltyNumber===t.membership_no,a=a&&e.email===t.email};e.searchGuest=function(){var t=function(t){var a=t.data,r=t.params;e.$emit("hideLoader"),e.guestSearchIntiated=!0,e.guestCardData.contactInfo=a,U(e.searchData.guestCard,r)&&(a.results.length>0?(e.searchedGuests=[],angular.forEach(a.results,function(t){var a={};a.id=t.id,a.firstName=t.first_name,a.lastName=t.last_name,a.image=t.image_url,a.vip=t.vip,a.is_flagged=t.is_flagged,null!==t.address&&(a.address={},a.address.city=t.address.city,a.address.state=t.address.state,a.address.postalCode=t.address.postal_code),a.stayCount=t.stay_count,a.lastStay={},a.phone=t.home_phone,a.email=t.email,a.lastStay.date=t.last_stay.date,a.lastStay.room=t.last_stay.room,a.lastStay.roomType=t.last_stay.room_type,e.searchedGuests.push(a)})):e.searchedGuests=[]),e.$broadcast("guestSearchInitiated")};if(""!==e.searchData.guestCard.guestFirstName||""!==e.searchData.guestCard.guestLastName||""!==e.searchData.guestCard.guestCity||""!==e.searchData.guestCard.guestLoyaltyNumber||""!==e.searchData.guestCard.email){var a={first_name:e.searchData.guestCard.guestFirstName,last_name:e.searchData.guestCard.guestLastName,city:e.searchData.guestCard.guestCity,membership_no:e.searchData.guestCard.guestLoyaltyNumber,email:e.searchData.guestCard.email};q()&&e.invokeApi(n.fetchGuests,a,t)}else e.guestSearchIntiated=!1,e.searchedGuests=[],e.$apply(),e.$broadcast("guestSearchStopped")};var q=function(){return e.searchData.guestCard.guestLastName.length>=2||e.searchData.guestCard.guestFirstName.length>=1||""!==e.searchData.guestCard.guestCity||""!==e.searchData.guestCard.guestLoyaltyNumber||""!==e.searchData.guestCard.email};e.searchGroups=function(){var t=function(t){e.searchingGroups=!0,e.searchedGroups=_.map(t.groups,function(e){return _.extend(e,{type:"GROUP"})}),e.searchedGroups=e.searchedGroups.concat(_.map(t.allotments,function(e){return _.extend(e,{type:"ALLOTMENT"})})),e.$broadcast("GROUP_SEARCH_ON")},a=function(t){e.errorMessage=t};e.searchData.groupCard.name||e.searchData.groupCard.code?e.callAPI(f.searchGroupCard,{params:{name:e.searchData.groupCard.name,code:e.searchData.groupCard.code,from_date:e.reservationData.arrivalDate,to_date:e.reservationData.departureDate,is_take_from_inventory:!0},successCallBack:t,failureCallBack:a}):(e.searchingGroups=!1,e.searchedGroups=[],e.$apply(),e.$broadcast("GROUP_SEARCH_OFF"))},e.searchCompany=function(){var t=function(t){e.$emit("hideLoader"),e.companySearchIntiated=!0,e.searchedCompanies=[],t.accounts.length>0&&angular.forEach(t.accounts,function(t){if("COMPANY"===t.account_type){var a={};a.id=t.id,a.account_name=t.account_name,a.account_type=t.account_type,a.isMultipleContracts=!1,t.current_contracts.length>1&&(a.isMultipleContracts=!0),a.logo=t.company_logo,null!==t.address&&(a.address={},a.address.postalCode=t.address.postal_code,a.address.city=t.address.city,a.address.state=t.address.state),t.current_contracts.length>0&&(a.rateList=t.current_contracts,a.rate=t.current_contracts[0],_.isEmpty(a.rate)||(a.contract_access_code=a.rate.access_code,a.rate.difference=function(){return parseInt(a.rate.based_on&&a.rate.based_on.value)<0?"amount"===a.rate.based_on.type?e.currencySymbol+(parseFloat(a.rate.based_on.value)*-1).toFixed(2)+" off ":parseFloat(a.rate.based_on.value)*-1+"% off ":""}(),a.rate.surplus=function(){return parseInt(a.rate.based_on&&a.rate.based_on.value)>0?"amount"===a.rate.based_on.type?" plus "+e.currencySymbol+parseFloat(a.rate.based_on.value).toFixed(2):" plus "+parseFloat(a.rate.based_on.value)+"%":""}())),a.email=t.email,a.phone=t.phone,e.searchedCompanies.push(a),a.account_address=t.account_address}}),e.$broadcast("companySearchInitiated")};if(""!==e.searchData.companyCard.companyName||""!==e.searchData.companyCard.companyCity||""!==e.searchData.companyCard.companyCorpId){var a={name:e.searchData.companyCard.companyName,city:e.searchData.companyCard.companyCity,account_number:e.searchData.companyCard.companyCorpId,from_date:"CREATION"===e.viewState.identifier||"CONFIRM"===e.viewState.identifier?e.reservationData.arrivalDate:new Date(e.reservation.reservation_card.arrival_date).toISOString().slice(0,10).replace(/-/g,"-"),to_date:"CREATION"===e.viewState.identifier||"CONFIRM"===e.viewState.identifier?e.reservationData.departureDate:new Date(e.reservation.reservation_card.departure_date).toISOString().slice(0,10).replace(/-/g,"-"),reservation_id:"STAY_CARD"===e.viewState.identifier?e.reservationData.reservationId:null};e.invokeApi(n.fetchCompaniesOrTravelAgents,a,t)}else e.companySearchIntiated=!1,e.searchedCompanies=[],e.$apply(),e.$broadcast("companySearchStopped")},e.searchTravelAgent=function(){var t=function(t){e.$emit("hideLoader"),e.travelAgentSearchIntiated=!0,e.searchedtravelAgents=[],t.accounts.length>0&&angular.forEach(t.accounts,function(t){if("TRAVELAGENT"===t.account_type){var a={};a.id=t.id,a.account_name=t.account_name,a.account_address=t.account_address,a.account_type=t.account_type,a.isMultipleContracts=!1,t.current_contracts.length>1&&(a.isMultipleContracts=!0),a.logo=t.company_logo,null!==t.address&&(a.address={},a.address.postalCode=t.address.postal_code,a.address.city=t.address.city,a.address.state=t.address.state),t.current_contracts.length>0&&(a.activeContracts=t.current_contracts,a.rate=t.current_contracts[0],_.isEmpty(a.rate)||(a.contract_access_code=a.rate.access_code,a.rate.difference=function(){return parseInt(a.rate.based_on&&a.rate.based_on.value)<0?"amount"===a.rate.based_on.type?e.currencySymbol+(parseFloat(a.rate.based_on.value)*-1).toFixed(2)+" off ":parseFloat(a.rate.based_on.value)*-1+"% off ":""}(),a.rate.surplus=function(){return parseInt(a.rate.based_on&&a.rate.based_on.value)>0?"amount"===a.rate.based_on.type?" plus "+e.currencySymbol+parseFloat(a.rate.based_on.value).toFixed(2):" plus "+parseFloat(a.rate.based_on.value)+"%":""}())),a.email=t.email,a.phone=t.phone,e.searchedtravelAgents.push(a)}}),e.$broadcast("travelAgentSearchInitiated")};if(""!==e.searchData.travelAgentCard.travelAgentName||""!==e.searchData.travelAgentCard.travelAgentCity||""!==e.searchData.travelAgentCard.travelAgentIATA){var a={name:e.searchData.travelAgentCard.travelAgentName,city:e.searchData.travelAgentCard.travelAgentCity,account_number:e.searchData.travelAgentCard.travelAgentIATA,from_date:"CREATION"===e.viewState.identifier||"CONFIRM"===e.viewState.identifier?e.reservationData.arrivalDate:new Date(e.reservation.reservation_card.arrival_date).toISOString().slice(0,10).replace(/-/g,"-"),to_date:"CREATION"===e.viewState.identifier||"CONFIRM"===e.viewState.identifier?e.reservationData.departureDate:new Date(e.reservation.reservation_card.departure_date).toISOString().slice(0,10).replace(/-/g,"-"),reservation_id:"STAY_CARD"===e.viewState.identifier?e.reservationData.reservationId:null};e.invokeApi(n.fetchCompaniesOrTravelAgents,a,t)}else e.searchedtravelAgents=[],e.travelAgentSearchIntiated=!1,e.$broadcast("travelAgentSearchStopped")};var H="";e.getRateName=function(){return H},e.ratesCount=function(e){var t,a=0;return"TRAVELAGENT"===e.account_type?t=e.activeContracts:"COMPANY"===e.account_type&&(t=e.rateList),t&&0!==t.length&&angular.forEach(t,function(e){0!==e.contract_rates.length&&(a+=e.contract_rates.length,H=e.contract_rates[0].rate_name)}),a},e.checkFuture=function(t,a,r){if(!e.isHourly){var n="/assets/partials/cards/alerts/futureReservationsAccounts.html";"guest"===t&&(n="/assets/partials/cards/alerts/futureReservationsGuest.html"),d.open({template:n,className:"ngdialog-theme-default stay-card-alerts",scope:e,closeByDocument:!1,closeByEscape:!1,useCardRate:r,data:JSON.stringify({cardType:t,card:a})})}},e.replaceCardCaller=function(t,a,r,n){e.replaceCard(t,a,r,n)};var Y=function(){d.open({template:"/assets/partials/cards/popups/group/rvResAttachingToGroupOtherRoomTypeAvailabe.html",className:"",scope:e,closeByDocument:!1,closeByEscape:!1})},j=function(){d.open({template:"/assets/partials/cards/popups/group/rvResAttachingToGroupNoAvailability.html",className:"",scope:e,closeByDocument:!1,closeByEscape:!1})},W=function(){d.open({template:"/assets/partials/cards/popups/group/rvResAttachingToGroupRoomTypeIsNotConfigured.html",className:"",scope:e,closeByDocument:!1,closeByEscape:!1})},K=function(){d.open({template:"/assets/partials/bill/rvBillingInfoCreditLimitExceededPopup.html",className:"",closeByDocument:!1,scope:e})};e.gotoGroupDetails=function(){p.go("rover.groups.config",{id:e.reservationData.group.id,activeTab:"SUMMARY"})};var J=function(t){_.extend(e.reservationData.group,{id:t.id,name:t.name,code:t.code,company:t.company_id,travelAgent:t.travel_agent_id})},z=function(t,a){e.closeBorrowPopup=function(t){t&&(e.borrowData={}),d.close()},e.performBorrowFromHouse=function(){e.borrowData.isBorrowFromHouse?(ee(a,!0),e.closeBorrowPopup(!0)):(e.closeBorrowPopup(),d.open({template:"/assets/partials/common/group/rvGroupOverbookPopup.html",className:"",closeByDocument:!1,closeByEscape:!0,scope:e}))},e.closeOverbookPopup=function(){e.borrowData={},d.close()},e.performOverBook=function(){ee(a,!0),e.closeOverbookPopup()},e.borrowData={},t.room_overbooked||t.house_overbooked||(e.borrowData.isBorrowFromHouse=!0),t.room_overbooked&&!t.house_overbooked?(e.borrowData.shouldShowOverBookBtn=e.hasOverBookRoomTypePermission,e.borrowData.isRoomTypeOverbooked=!0):!t.room_overbooked&&t.house_overbooked?(e.borrowData.shouldShowOverBookBtn=e.hasOverBookHousePermission,e.borrowData.isHouseOverbooked=!0):t.room_overbooked&&t.house_overbooked&&(e.borrowData.shouldShowOverBookBtn=e.hasOverBookRoomTypePermission&&e.hasOverBookHousePermission,e.borrowData.isHouseAndRoomTypeOverbooked=!0),d.open({template:"/assets/partials/common/group/rvGroupBorrowPopup.html",className:"",closeByDocument:!1,closeByEscape:!0,scope:e})},Q=function(t,a){t.hasOwnProperty("httpStatus")?470===t.httpStatus&&t.is_borrowed_from_house?z(t,a.selectedGroup):470!==t.httpStatus||t.is_borrowed_from_house?471===t.httpStatus?j():472===t.httpStatus&&W():Y():e.errorMessage=t},X=function(){e.viewState.isAddNewCard=!1},Z=function(t,a){var r=a.selectedGroup;J(r),e.closeGuestCard(),X(),e.isInStayCardScreen()&&e.reloadTheStaycard(!0)},ee=function(t,a){var r={reservation_id:e.reservationData.reservationId,group_id:t.id,forcefully_overbook:a},n={params:r,successCallBack:Z,failureCallBack:Q,successCallBackParameters:{selectedGroup:t},failureCallBackParameters:{selectedGroup:t}};e.callAPI(f.attachGroupToReservation,n)},te=function(t){e.errorMessage=t},ae=function(){e.viewState.isAddNewCard=!0},re=function(){e.reservationData.group={id:"",name:"",code:"",company:"",travelAgent:""}},ne=function(t){re(),e.closeGuestCard(),ae(),e.$broadcast("groupCardDetached"),l.$broadcast("UPDATE_RATE_POST_GROUP_DETACH")},oe=function(){var t=e.reservationData,a={reservation_id:t.reservationId,group_id:t.group.id},r={params:a,successCallBack:ne,failureCallBack:te};e.callAPI(f.detachGroupFromReservation,r)},ie=function(){e.callAPI(v.detachAllotmentFromReservation,{params:e.reservationData.reservationId,successCallBack:function(){e.reservationData.allotment={id:"",name:"",code:"",company:"",travelAgent:""},e.closeGuestCard(),ae(),e.$broadcast("groupCardDetached"),e.navigateToRoomAndRates()},failureCallBack:function(){console.warn("Detach Allotment FAILED")}})};e.detachFromGroupORAllotment=function(){e.reservationData.group.id?x():e.reservationData.allotment.id&&F()},e.selectToGroupORAllotment=function(t,a){a.stopPropagation(),"CREATION"===e.viewState.identifier?"GROUP"===t.type?e.selectGroup(t):"ALLOTMENT"===t.type&&e.selectAllotment(t):d.open({template:"/assets/partials/cards/alerts/warnCardOverride.html",className:"",scope:e,closeByDocument:!1,closeByEscape:!1,data:JSON.stringify({card:t})})},e.selectGroup=function(t){e.closeDialog(),setTimeout(function(){"CREATION"===e.viewState.identifier?(e.reservationData.group={id:t.id,name:t.name,code:t.code,company:t.company_id,travelAgent:t.travel_agent_id},e.closeGuestCard(),e.viewState.isAddNewCard=!1,e.initGroupCard(t.id),e.reservationData.group.travelAgent&&(e.reservationDetails.travelAgent.id=e.reservationData.group.travelAgent,e.initTravelAgentCard()),e.reservationData.group.company&&(e.reservationDetails.companyCard.id=e.reservationData.group.company,e.initCompanyCard()),e.showContractedRates({companyCard:e.reservationDetails.companyCard.id,travelAgent:e.reservationDetails.travelAgent.id}),e.navigateToRoomAndRates()):ee(t)},1e3)};var se=function(){return"CREATION"===e.viewState.identifier},ce=function(){d.open({template:"/assets/partials/cards/popups/allotment/rvResAttachingToAllotmentOtherRoomTypeAvailabe.html",className:"",scope:e,closeByDocument:!1,closeByEscape:!1})},de=function(){d.open({template:"/assets/partials/cards/popups/allotment/rvResAttachingToAllotmentNoAvailability.html",className:"",scope:e,closeByDocument:!1,closeByEscape:!1})},le=function(){d.open({template:"/assets/partials/cards/popups/allotment/rvResAttachingToAllotmentRoomTypeIsNotConfigured.html",className:"",scope:e,closeByDocument:!1,closeByEscape:!1})};e.gotoAllotmentDetails=function(){p.go("rover.allotments.config",{id:e.reservationData.allotment.id,activeTab:"SUMMARY"})};var ue=function(t){_.extend(e.reservationData.allotment,{id:t.id,name:t.name,code:t.code,company:t.company_id,travelAgent:t.travel_agent_id})},me=function(t){t.hasOwnProperty("httpStatus")?470===t.httpStatus?ce():471===t.httpStatus?de():472===t.httpStatus?le():473===t.httpStatus&&K():e.errorMessage=t},fe=function(t,a){var r=a.selectedAllotment;ue(r),e.closeGuestCard(),X(),e.initAllotmentCard(r.id),p.current.name===b&&e.reloadTheStaycard()},pe=function(t){var a={reservationId:e.reservationData.reservationId,allotmentId:t.id},r={params:a,successCallBack:fe,failureCallBack:me,successCallBackParameters:{selectedAllotment:t}};e.callAPI(v.attachAllotmentToReservation,r);
};e.selectAllotment=function(t){e.closeDialog(),setTimeout(function(){se()?(e.reservationData.allotment={id:t.id,name:t.name,code:t.code,company:t.company_id,travelAgent:t.travel_agent_id},e.closeGuestCard(),e.viewState.isAddNewCard=!1,e.initAllotmentCard(t.id),e.reservationData.allotment.travelAgent&&(e.reservationDetails.travelAgent.id=e.reservationData.allotment.travelAgent,e.initTravelAgentCard()),e.reservationData.allotment.company&&(e.reservationDetails.companyCard.id=e.reservationData.allotment.company,e.initCompanyCard()),e.showContractedRates({companyCard:e.reservationDetails.companyCard.id,travelAgent:e.reservationDetails.travelAgent.id}),e.navigateToRoomAndRates()):pe(t)},1e3)},e.searchAllotments=function(){e.$broadCast("FETCH_ALLOTMENT_SEARCH_DATA")};var ve=function(t){e.cardData=t,d.open({template:"/assets/partials/cards/alerts/contractRatesConfirmation.html",className:"",closeByDocument:!1,closeByEscape:!1,scope:e})};e.reservationData.keepExistingRate=!1,e.selectCard=function(t,a){"COMPANY"===t.account_type&&e.selectCompany(t,a),"TRAVELAGENT"===t.account_type&&e.selectTravelAgent(t,a),a||(e.reservationData.keepExistingRate=!0)},e.changeToContractedRate=function(t){e.selectCard(t,!0),e.closeGuestCard()},e.setSelectedTACard=function(t){e.selectTravelAgent(t)};var _e=function(t){d.open({template:"/assets/partials/cards/popups/rvCommissionsWarningPopup.html",className:"",closeByDocument:!1,closeByEscape:!1,scope:e,data:JSON.stringify({cardData:t})})};e.selectCardType=function(t,a){a.stopPropagation(),e.closeGuestCard(),"COMPANY"===t.account_type?t.rate&&p.current.name!==R&&!e.reservationData.group.id?ve(t):e.selectCompany(t):"TRAVELAGENT"===t.account_type&&(t.showCommisionWarning=G(),t.rate&&p.current.name!==R&&!e.reservationData.group.id?ve(t):t.showCommisionWarning?_e(t):e.selectTravelAgent(t))},e.selectCompany=function(t,a){"CREATION"===e.viewState.identifier?(e.closeDialog(),e.reservationData.company.id=t.id,e.showContractedRates({companyCard:t.id,travelAgent:e.reservationData.travelAgent.id}),e.reservationData.company.name=t.account_name,e.reservationData.company.corporateid=e.companyCorpId,e.companyName=t.account_name,e.companyCity=t.city,e.closeGuestCard(),e.reservationDetails.companyCard.id=t.id,e.initCompanyCard(t),e.viewState.isAddNewCard=!1,e.navigateToRoomAndRates()):!e.reservationDetails.companyCard.futureReservations||e.reservationDetails.companyCard.futureReservations<=0?e.replaceCardCaller("company",t,!1,a):(e.closeDialog(),e.checkFuture("company",t,a))},e.selectTravelAgent=function(t,a){"CREATION"===e.viewState.identifier?(e.closeDialog(),e.reservationData.travelAgent.id=t.id,e.showContractedRates({companyCard:e.reservationData.company.id,travelAgent:t.id}),e.reservationData.travelAgent.name=t.account_name,e.reservationData.travelAgent.iataNumber=e.travelAgentIATA,e.travelAgentName=t.account_name,e.travelAgentCity=t.city,e.closeGuestCard(),e.reservationDetails.travelAgent.id=t.id,e.initTravelAgentCard(t),e.viewState.isAddNewCard=!1,e.navigateToRoomAndRates()):!e.reservationDetails.travelAgent.futureReservations||e.reservationDetails.travelAgent.futureReservations<=0?e.replaceCardCaller("travel_agent",t,!1,a):(e.closeDialog(),e.checkFuture("travel_agent",t,a))},e.selectGuest=function(t,a){if(a&&a.stopPropagation(),"CREATION"===e.viewState.identifier)e.reservationData.guest.id=t.id,e.reservationData.guest.firstName=t.firstName,e.reservationData.guest.lastName=t.lastName,e.reservationData.guest.city=t.address?t.address.city:"",e.reservationData.guest.loyaltyNumber=e.guestLoyaltyNumber,e.guestFirstName=t.firstName,e.guestLastName=t.lastName,e.guestCity=t.address?t.address.city:"",e.guestCardData.cardHeaderImage=t.image,e.viewState.isAddNewCard=!1,e.reservationDetails.guestCard.id=t.id,e.initGuestCard(t),e.callAPI(o.fetchGuestDetailsInformation,{successCallBack:function(a){var r={check_validation_only:!0,data:a,userId:t.id};e.invokeApi(i.updateGuest,r,function(t){""!==t.mandatory_field_missing_message&&null!==t.mandatory_field_missing_message&&(e.errorMessage=t.mandatory_field_missing_message,e.$emit("contactInfoError",!0))},function(){}),a.stayCount=t.stayCount,e.$emit("UPDATE_GUEST_CARD_DETAILS",a),e.closeGuestCard()},failureCallBack:function(t){e.$emit("hideLoader")},params:t.id});else if(!e.reservationDetails.guestCard.futureReservations||e.reservationDetails.guestCard.futureReservations<=0){var r=e.reservationData&&e.reservationData.reservationIds&&e.reservationData.reservationIds.length;e.replaceCardCaller("guest",t,!!r)}else e.checkFuture("guest",t)},e.refreshScroll=function(t){"undefined"!=typeof e.$parent.myScroll&&c(function(){e.$parent.myScroll[t].refresh()},300)},e.createNewGuest=function(){var t=[],a=function(t){e.guestCardData.contactInfo.guest_admin_settings=t},n=function(t){e.guestCardData.contactInfo.genderTypeList=t},i=function(t){e.idTypeList=t};t.push(o.fetchGuestAdminSettings().then(a)),t.push(o.fetchGenderTypes().then(n)),t.push(o.fetchIdTypes().then(i)),r.all(t).then();var s={contactInfo:e.guestCardData.contactInfo,countries:e.countries,userId:"",avatar:"",guestId:"",vip:!1};e.guestCardData.contactInfo=s.contactInfo,e.guestCardData.contactInfo.avatar=s.avatar,e.guestCardData.contactInfo.vip=s.vip,e.countriesList=s.countries,e.guestCardData.userId=s.userId,e.guestCardData.guestId=s.guestId,e.guestCardData.contactInfo.birthday=null;e.guestCardData.contactInfo.first_name=e.searchData.guestCard.guestFirstName,e.guestCardData.contactInfo.last_name=e.searchData.guestCard.guestLastName,e.guestCardData.contactInfo.email=e.searchData.guestCard.email,e.guestCardData.contactInfo.address={},e.guestCardData.contactInfo.address.city=e.searchData.guestCard.guestCity,e.guestCardData.membership_no=e.searchData.guestCard.guestLoyaltyNumber,e.$broadcast("guestCardAvailable"),e.current="guest-contact",e.viewState.isAddNewCard=!0},e.createNewCompany=function(){e.companyContactInformation=m.getEmptyAccountData(),e.reservationDetails.companyCard.id="",e.reservationDetails.companyCard.futureReservations=0,e.viewState.isAddNewCard=!0,e.$broadcast("companyCardAvailable",!0)},e.createNewTravelAgent=function(){e.travelAgentInformation=m.getEmptyAccountData(),e.reservationDetails.travelAgent.id="",e.reservationDetails.travelAgent.futureReservations=0,e.viewState.isAddNewCard=!0,e.$broadcast("travelAgentFetchComplete",!0)},e.clickedSaveCard=function(t){"guest"===t&&e.$broadcast("saveContactInfo")},e.newGuestAdded=function(t){e.viewState.isAddNewCard=!1,e.viewState.pendingRemoval.status=!1,e.viewState.pendingRemoval.cardType="",e.initGuestCard({id:t})},e.$on("updateGuestEmail",function(t){e.guestCardData.contactInfo.email=e.reservationData.guest.email}),e.$on("CardInfoUpdated",function(t,a,r){"COMPANY_CARD"===r?(e.reservationDetails.companyCard.id=a,e.initCompanyCard()):(e.reservationDetails.travelAgent.id=a,e.initTravelAgentCard())}),e.$on("PROMPTCARDENTRY",function(){e.reservationDetails.guestCard.id||e.openGuestCard()}),e.init(),e.vipToggleClicked=function(){e.updateContactInfo()},e.allowDetachAgent=function(){return!e.reservationData.group.id},e.allowDetachCompany=function(){return!e.reservationData.group.id},e.guestCardClicked=function(){e.viewState.isAddNewCard||e.$broadcast("saveContactInfo"),y.activeCardType="guest_card"},e.$on("SHOWERRORMESSAGE",function(t,a){e.errorMessage=a}),e.$on("PRINT_AR_STATEMENT",function(t,a){e.isPrintArStatement=a});var De=e.$on("SET_GUEST_CARD_DATA",function(t,a){e.guestCardData.contactInfo=e.getUpdatedContactInfo(a.contactInfo,a.guestId)});e.$on("$destroy",De),e.addListener("DETACH_GROUP_FROM_RESERVATION",function(){oe()})}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){sntRover.controller("RVAllContactInfoDatePickerController",["$scope","$rootScope","ngDialog","dateFilter",function(e,t,a,r){e.setUpData=function(){e.dateOptions={changeYear:!0,changeMonth:!0,maxDate:tzIndependentDate(t.businessDate),yearRange:"-100:+0",onSelect:function(t,r){t=moment(t,"MM/DD/YYYY").format("YYYY-MM-DD"),"idDate"===e.calenderFor&&(e.guestCardData.contactInfo.id_issue_date=t),"entryDate"===e.calenderFor&&(e.guestCardData.contactInfo.entry_date=t),"birthday"===e.calenderFor&&(e.guestCardData.contactInfo.birthday=t),"validate"===e.calenderFor&&(e.saveData.birth_day=t),e.datePicker?a.close(e.datePicker.id):a.close()}},"idExpirationDate"!==e.calenderFor&&"idExpirationDateValidate"!==e.calenderFor||(e.dateOptions={changeYear:!0,changeMonth:!0,yearRange:"-100:+10",onSelect:function(t,r){t=moment(t,"MM/DD/YYYY").format("YYYY-MM-DD"),e.guestCardData.contactInfo.id_expiration_date=t,"idExpirationDateValidate"===e.calenderFor&&(e.saveData.id_expiration_date=t),e.datePicker?a.close(e.datePicker.id):a.close()}})},e.setUpData()}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){sntRover.controller("RVAddonDatePickerController",["$scope",function(e){var t="",a="";e.data={},"start_date"===e.datePickerFor?(e.data.selectedDate=tzIndependentDate(e.selectedPurchesedAddon.startDateObj),t=tzIndependentDate(e.addonPostingDate.startDate),a=tzIndependentDate(e.selectedPurchesedAddon.endDateObj)):(e.data.selectedDate=tzIndependentDate(e.selectedPurchesedAddon.endDateObj),t=tzIndependentDate(e.selectedPurchesedAddon.startDateObj),a=tzIndependentDate(e.addonPostingDate.endDate)),e.setUpData=function(){e.dateOptions={changeYear:!0,changeMonth:!0,yearRange:"0:+10",minDate:t,maxDate:a,onSelect:function(){"start_date"===e.datePickerFor?e.selectedPurchesedAddon.startDateObj=tzIndependentDate(e.data.selectedDate):e.selectedPurchesedAddon.endDateObj=tzIndependentDate(e.data.selectedDate),e.dateSelected(e.data.selectedDate),e.closeCalendar()}}},e.setUpData()}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){sntRover.controller("rvAddLoyaltyProgramController",["$scope","$rootScope","$filter","RVLoyaltyProgramSrv","ngDialog",function(e,t,a,r,n){BaseCtrl.call(this,e),e.availableFFPS=[],e.availableHLPS=[],e.loyaltyPrograms=[{name:"Frequent Flyer Program",code:"FFP"},{name:"Hotel Loyalty Program",code:"HLP"}],e.selectedLoyaltyProgram="",e.selectedLoyaltyType="",e.selectedLevel="",e.loyaltyCode="",e.dimissLoaderAndDialog=function(){e.$emit("hideLoader"),e.closeDialog()},e.addLoyaltyProgram=function(){var a={};a.reservation_id=e.$parent.reservationData.reservation_card.reservation_id,a.user_id=e.$parent.$parent.guestCardData.userId,a.user_membership={},a.user_membership.membership_type=e.selectedLoyaltyType,a.user_membership.membership_card_number=e.loyaltyCode,a.user_membership.membership_class=e.selectedLoyaltyProgram,a.user_membership.membership_level=e.selectedLevel,e.newLoyalty=a.user_membership;var n=function(a){e.newLoyalty.id=a.id,e.dimissLoaderAndDialog(),t.$broadcast("loyaltyProgramAdded",e.newLoyalty,"fromReservationCard")},o=function(t){e.errorMessage=t},i={params:a,successCallBack:n,failureCallBack:o};e.callAPI(r.addLoyaltyProgram,i)},e.setupLoyaltyPrograms=function(){if(e.$parent.reservationData){var t=e.$parent.reservationData.use_ffp,a=e.$parent.reservationData.use_hlp;t===!0&&a===!1?e.loyaltyPrograms=[{name:"Frequent Flyer Program",code:"FFP"}]:t===!1&&a===!0?e.loyaltyPrograms=[{name:"Hotel Loyalty Program",code:"HLP"}]:t===!0&&a===!0?e.loyaltyPrograms=[{name:"Frequent Flyer Program",code:"FFP"},{name:"Hotel Loyalty Program",code:"HLP"}]:t===!1&&a===!1&&(e.loyaltyPrograms=[])}e.getFFPS(),e.getHLPS()},e.getFFPS=function(){var t=function(t){e.setAvailableFFPS(t),e.$emit("hideLoader")},a=function(t){e.$emit("hideLoader"),e.errorMessage=t};e.invokeApi(r.getAvailableFFPS,"",t,a)},e.getHLPS=function(){var t=function(t){e.setAvailableHLPS(t),e.$emit("hideLoader")},a=function(t){e.$emit("hideLoader"),e.errorMessage=t};e.invokeApi(r.getAvailableHLPS,"",t,a)},e.setAvailableFFPS=function(t){for(var a,r=0;r<t.length;r++)a={},a.name=t[r].ff_description,a.code=t[r].ff_value,a.levels=t[r].levels,e.availableFFPS.push(a)},e.setAvailableHLPS=function(t){for(var a,r=0;r<t.length;r++)a={},a.name=t[r].hl_description,a.code=t[r].hl_value,a.levels=t[r].levels,e.availableHLPS.push(a)},e.getLoyaltyTypes=function(){if(e.selectedLoyaltyProgram)return"HLP"===e.selectedLoyaltyProgram?e.availableHLPS:"FFP"===e.selectedLoyaltyProgram?e.availableFFPS:[]},e.getLoyaltyLevels=function(){if(e.$parent.reservationData){var t=e.$parent.reservationData.use_ffp,a=e.$parent.reservationData.use_hlp;if(t===!0&&a===!1){if(e.selectedLoyaltyProgram===e.loyaltyPrograms[0].code)return e.getLoyaltyLevelsfromCode()}else if(t===!1&&a===!0){if(e.selectedLoyaltyProgram===e.loyaltyPrograms[0].code)return e.getLoyaltyLevelsfromCode()}else{if(t===!0&&a===!0)return e.selectedLoyaltyProgram===e.loyaltyPrograms[1].code?e.getLoyaltyLevelsfromCode():e.getLoyaltyLevelsfromCode();t===!1&&a===!1&&(e.loyaltyPrograms=[])}}},e.getLoyaltyLevelsfromCode=function(){var t,a=[];if(e.selectedLoyaltyProgram){"HLP"===e.selectedLoyaltyProgram?t=e.availableHLPS:"FFP"===e.selectedLoyaltyProgram&&(t=e.availableFFPS);for(var r=0;r<t.length;r++)if(e.selectedLoyaltyType===t[r].code){a=t[r].levels;break}}return a},e.setupLoyaltyPrograms()}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){angular.module("sntRover").controller("RVGuestCardLoyaltyController",["$scope","$rootScope","RVGuestCardLoyaltySrv","ngDialog","RVLoyaltyProgramSrv",function(e,t,a,r,n){BaseCtrl.call(this,e);var o={};e.init=function(){var r=function(a){e.$emit("hideLoader"),t.$broadcast("detect-hlps-ffp-active-status",a),e.loyaltyData=a,e.checkForHotelLoyaltyLevel(),setTimeout(function(){e.refreshScroller("loyaltyList")},3e3),s()},n=function(t){e.$emit("hideLoader"),e.errorMessage=t},i={userID:e.$parent.guestCardData.userId};e.invokeApi(a.fetchLoyalties,i,r,n,"NONE"),o.guestInfo=e.$parent.guestCardData.contactInfo},e.reloadOnSet=!1,e.reloadOnSet&&(t.$on("reload-loyalty-section-data",function(t,a){e.init()}),e.reloadOnSet=!0),e.$watch(function(){return""!==e.$parent.$parent.guestCardData.userId},function(t){t&&e.init()}),e.addListener("reload-loyalty-section-data",function(a,r){r&&r.reload&&t.goToReservationCalled&&(e.init(),t.goToReservationCalled=!1)}),e.checkForHotelLoyaltyLevel=function(){if(e.$parent.$parent.guestCardData.use_hlp)for(var t=0;t<e.loyaltyData.userMemberships.hotelLoyaltyProgram.length;t++)if(""!==e.loyaltyData.userMemberships.hotelLoyaltyProgram.membership_level){e.$emit("loyaltyLevelAvailable",e.loyaltyData.userMemberships.hotelLoyaltyProgram[t].membership_level);break}},e.addListener("clearNotifications",function(){e.errorMessage="",e.successMessage=""});var i={preventDefault:!1};e.setScroller("loyaltyList",i),e.addListener("REFRESHLIKESSCROLL",function(){e.refreshScroller("loyaltyList")}),e.addNewFreaquentLoyality=function(){r.open({template:"/assets/partials/guestCard/rvGuestCardaddFreaquentLoyaltyPopup.html",controller:"RVAddNewFreaquentLoyaltyContrller",className:"",scope:e})},e.addNewHotelLoyality=function(){var t={template:"/assets/partials/reservationCard/rvGMSLoyality.html",controller:"rvGMSLoyalityController",className:"ngdialog-theme-default",scope:e,data:o,preCloseCallback:e.loadLoyaltyPrograms},a={template:"/assets/partials/guestCard/rvGuestCardaddHotelLoyaltyPopup.html",controller:"RVAddNewHotelLoyaltyController",className:"",scope:e};o.GMSSettings.membership_feature&&o.GMSSettings.enabled?r.open(t):r.open(a)},e.showDeleteModal=function(t,a,n){e.loaytyID=t,e.loyaltyIndexToDelete=a,e.loyaltyProgramToDelete=n,r.open({template:"/assets/partials/guestCard/rvGuestCardDeleteLoyaltyModal.html",controller:"rvDeleteLoyaltyModalController",className:"ngdialog-theme-default",scope:e})},e.addListener("loyaltyProgramAdded",function(t,a,r){"undefined"!=typeof e.loyaltyData&&("HLP"===a.membership_class?e.loyaltyData.userMemberships.hotelLoyaltyProgram.push(a):e.loyaltyData.userMemberships.frequentFlyerProgram.push(a))}),e.loyaltyProgramDeleted=function(t,a,r){"undefined"!=typeof e.loyaltyData&&("FFP"===r?e.loyaltyData.userMemberships.frequentFlyerProgram.splice(a,1):e.loyaltyData.userMemberships.hotelLoyaltyProgram.splice(a,1))},e.addListener("loyaltyDeletionError",function(t,a){e.$parent.myScroll.loyaltyList.scrollTo(0,0),e.errorMessage=a}),e.addListener("detect-hlps-ffp-active-status",function(t,a){a.userMemberships.use_hlp?(e.loyaltyProgramsActive(!0),e.$parent.guestCardData.use_hlp=!0):(e.loyaltyProgramsActive(!1),e.$parent.guestCardData.use_hlp=!1),a.userMemberships.use_ffp?(e.ffpProgramsActive(!0),e.$parent.guestCardData.use_ffp=!0):(e.ffpProgramsActive(!1),e.$parent.guestCardData.use_ffp=!1)}),e.loyaltyProgramsActive=function(t){e.hotelLoyaltyProgramEnabled=t,e.$parent.guestCardData.use_ffp=t},e.ffpProgramsActive=function(t){e.hotelFrequentFlyerProgramEnabled=t,e.$parent.guestCardData.use_ffp=t};var s=function(){var t={},a=function(e){o.GMSSettings=e},r={params:t,successCallBack:a};e.callAPI(n.getGMSSettings,r)}}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){angular.module("sntRover").controller("reservationRoomStatus",["$state","$rootScope","$scope","ngDialog","$stateParams","RVKeyPopupSrv","RVReservationCardSrv","rvPermissionSrv","RVReservationSummarySrv","$timeout",function(e,t,a,r,n,o,i,s,c,d){BaseCtrl.call(this,a),a.encoderTypes=[],d(function(){a.$apply()},3e3),a.getRoomClass=function(e,r){var n="";return"CANCELED"===e?n="overlay":r&&""!==a.reservationData.reservation_card.room_number?n="has-lock hover-hand":t.isStandAlone||"NOSHOW"===e||"CHECKEDOUT"===e||"CANCELED"===e||"CHECKEDIN"===e||"CHECKING_OUT"===e?t.isStandAlone&&"NOSHOW"!==e&&"CHECKEDOUT"!==e&&"CANCELED"!==e&&(n="has-arrow hover-hand"):n="has-arrow hover-hand",s.getPermissionValue("MOVE_ROOM")||"CANCELED"===e||(n+=" overlay"),n},a.getRoomStatusClass=function(e,t,a,r,n,o){var i="";if("OUT_OF_SERVICE"===o||"OUT_OF_ORDER"===o)return"room-grey";if("CHECKING_IN"===e&&""!==r)if("VACANT"===a)switch(r){case"INSPECTED":i=" room-green";break;case"CLEAN":if("true"===n){i=" room-orange";break}i=" room-green";break;case"PICKUP":i=" room-orange";break;case"DIRTY":i=" room-red"}else i="room-red";return i},a.shouldEnableUpgradeButton=function(){var e=!1,r=a.reservationData.reservation_card.reservation_status,n=a.reservationData.reservation_card.is_upsell_available;return!(a.hasAnySharerCheckedin()||a.reservationData.reservation_card.is_suite||t.isHourlyRateOn)&&("true"===n&&a.isFutureReservation(r)&&(e=!0),e)},a.isFutureReservation=function(e){return"RESERVED"===e||"CHECKING_IN"===e},a.showKeysButton=function(e){var t=a.reservationData.reservation_card.key_settings,r=!1;return"no_key_delivery"!==t&&("CHECKING_IN"===e&&""!==a.reservationData.reservation_card.room_number&&"pin"!==a.reservationData.reservation_card.key_settings||"CHECKING_OUT"===e||"CHECKEDIN"===e)&&(r=!0),a.hasPermissionToCreateKeys()||(r=!1),r},a.hasPermissionToCreateKeys=function(){return s.getPermissionValue("CREATE_KEY")},a.addHasButtonClass=function(e){var t=!_()&&a.isFutureReservation(e);return t&&a.showKeysButton(e)?"has-buttons":t||a.showKeysButton(e)?"has-button":""},a.$on("clickedIconKeyFromQueue",function(){a.clickedIconKey()}),a.clickedIconKey=function(){var e=a.reservationData.reservation_card.key_settings;if(a.viewFromBillScreen=!1,"email"===e)r.open({template:"/assets/partials/keys/rvKeyEmailPopup.html",controller:"RVKeyEmailPopupController",className:"",scope:a});else if("pin"===e){var t={params:{reservation_id:a.reservationData.reservation_card.reservation_id},successCallBack:function(e){a.reservationData.room_pin=e.room_pin,l()}};a.callAPI(c.retrieveRoomPin,t)}else"CHECKING_IN"!==a.reservationData.reservation_card.reservation_status?r.open({template:"/assets/partials/keys/rvKeyPopupNewDuplicate.html",controller:"RVKeyQRCodePopupController",className:"",scope:a}):"CHECKING_IN"===a.reservationData.reservation_card.reservation_status&&a.newKeyInit()},a.keyInitPopup=function(){var e=a.reservationData.reservation_card.key_settings;if("qr_code_tablet"===e){var t=a.reservationData.reservation_card.reservation_id,n=function(e){a.$emit("hideLoader"),a.data=e,r.open({template:"/assets/partials/keys/rvKeyQrcodePopup.html",controller:"RVKeyQRCodePopupController",className:"",scope:a})};a.invokeApi(o.fetchKeyQRCodeData,{reservationId:t},n)}else"encode"!==e&&"mobile_key_encode"!==e||(a.reservationData.reservation_card.is_remote_encoder_enabled&&void 0!==a.encoderTypes&&a.encoderTypes.length<=0?u():l())},a.duplicateKeyInit=function(){a.$emit("showLoader"),a.keyType="Duplicate",d(function(){a.keyInitPopup()},150)},a.newKeyInit=function(){a.$emit("showLoader"),a.keyType="New",d(function(){a.keyInitPopup()},150)};var l=function(){r.open({template:"/assets/partials/keys/rvKeyEncodePopup.html",controller:"RVKeyEncodePopupCtrl",className:"",scope:a,closeByDocument:!1}),d(function(){"New"===a.keyType?t.$broadcast("MAKE_KEY_TYPE",{type:"New"}):t.$broadcast("MAKE_KEY_TYPE",{type:"Duplicate"})},0)},u=function(){var e=function(e){a.$emit("hideLoader"),a.encoderTypes=e,l()};a.invokeApi(o.fetchActiveEncoders,{},e)};a.closeActivityIndication=function(){a.$emit("hideLoader")},a.goToRoomUpgrades=function(){var t=a.reservationData.reservation_card.cannot_move_room&&""!==a.reservationData.reservation_card.room_number;e.go("rover.reservation.staycard.upgrades",{reservation_id:a.reservationData.reservation_card.reservation_id,clickedButton:"upgradeButton",cannot_move_room:t})};var m=function(){i.checkinDateForDiary=a.reservationData.reservation_card.arrival_date.replace(/-/g,"/"),e.go("rover.diary",{reservation_id:a.reservationData.reservation_card.reservation_id,checkin_date:a.reservationData.reservation_card.arrival_date,is_nightly_reservation:!a.reservationData.reservation_card.is_hourly_reservation})},f=function(){var t={start_date:a.reservationData.reservation_card.arrival_date,reservation_id:a.reservationData.reservation_card.reservation_id,confirm_id:a.reservationData.reservation_card.confirmation_num,room_id:a.reservationData.reservation_card.room_id,origin:"STAYCARD_ROOM"};""===t.room_id?t.action="SELECT_UNASSIGNED_RESERVATION":t.action="SELECT_RESERVATION",e.go("rover.nightlyDiary",t)};a.goToroomAssignment=function(){if(a.hasAnySharerCheckedin()||a.reservationData.reservation_card.cannot_move_room&&!s.getPermissionValue("DO_NOT_MOVE_RESERVATION"))return!1;var r=a.reservationData.reservation_card.reservation_status,n="true"===a.reservationData.reservation_card.is_upsell_available&&("RESERVED"===r||"CHECKING_IN"===r),o=a.reservationData.reservation_card.cannot_move_room&&""!==a.reservationData.reservation_card.room_number,i=a.reservationData.reservation_card.is_hourly_reservation;"FULL"===t.hotelDiaryConfig.mode&&i||i?m():"FULL"!==t.hotelDiaryConfig.mode||i?a.isFutureReservation(a.reservationData.reservation_card.reservation_status)?e.go("rover.reservation.staycard.roomassignment",{reservation_id:a.reservationData.reservation_card.reservation_id,room_type:a.reservationData.reservation_card.room_type_code,clickedButton:"roomButton",upgrade_available:n,cannot_move_room:o,roomTypeId:a.reservationData.reservation_card.room_type_id}):"CHECKEDIN"===a.reservationData.reservation_card.reservation_status&&t.isStandAlone&&e.go("rover.reservation.staycard.roomassignment",{reservation_id:a.reservationData.reservation_card.reservation_id,room_type:a.reservationData.reservation_card.room_type_code,clickedButton:"roomButton",upgrade_available:n,cannot_move_room:o,roomTypeId:a.reservationData.reservation_card.room_type_id}):f()};var p=function(){a.reservationData.reservation_card.cannot_move_room=!a.reservationData.reservation_card.cannot_move_room};a.toggleDoNotMove=function(){var e={no_room_move:!a.reservationData.reservation_card.cannot_move_room,reservationId:a.reservationData.reservation_card.reservation_id},t={params:e,successCallBack:p};a.callAPI(c.updateNoRoomMove,t)},a.showDoNotMoveToggleButton=function(){var e=!0,t=a.reservationData.reservation_card.reservation_status,r=a.reservationData.reservation_card.cannot_move_room;return a.isStandAlone&&"NOSHOW"!==t&&"CHECKEDOUT"!==t&&"CANCELED"!==t&&(""!==a.reservationData.reservation_card.room_number||r)&&s.getPermissionValue("DO_NOT_MOVE_RESERVATION")||(e=!1),e};var v=a.reservationData.reservation_card.key_settings;a.showPopupsOnlineOfflineRoomMove=function(){setTimeout(function(){"email"===v?r.open({template:"/assets/partials/keys/rvKeyEmailPopup.html",controller:"RVKeyEmailPopupController",className:"",scope:a}):a.keyInitPopup()},700)},t.isStandAlone&&!t.isHourlyRateOn&&(null==n.isOnlineRoomMove&&n.isKeySystemAvailable||"false"==n.isOnlineRoomMove||"true"==n.isOnlineRoomMove&&("email"===v||"qr_code_tablet"===v))&&a.showKeysButton(a.reservationData.reservation_card.reservation_status)&&"CHECKEDIN"===a.reservationData.reservation_card.reservation_status&&a.showPopupsOnlineOfflineRoomMove(),a.$watch("reservationData.reservation_card.room_number",function(){t.viaSharerPopup&&(t.$broadcast("SETPREV_RESERVATION",t.viaSharerName),t.viaSharerPopup=!1)}),t.$on("VIA_SHARER_ON",function(e){a.reservationData.viaSharerName=e,t.viaSharerPopup=!0});var _=function(){return a.hasAnySharerCheckedin()||a.reservationData.reservation_card.is_suite||t.isHourlyRateOn};a.shouldShowOriginalRoomType=function(){return a.reservationData.reservation_card.room_type_description&&a.reservationData.reservation_card.original_room_type_desc&&a.reservationData.reservation_card.room_type_description!==a.reservationData.reservation_card.original_room_type_desc},function(){!_()&&a.isFutureReservation(a.reservationData.reservation_card.reservation_status)&&(a.showUpgradeButton=!0,a.callAPI(c.checkUpsellAvailability,{loader:"NONE",params:a.reservationData.reservation_card.reservation_id,successCallBack:function(e){a.isUpsellAvailabilityKnown=!0,a.reservationData.reservation_card.is_upsell_available=e}}))}()}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){angular.module("sntRover").controller("RVContactInfoController",["$scope","$rootScope","RVContactInfoSrv","ngDialog","dateFilter","$timeout","RVSearchSrv","$stateParams","rvPermissionSrv","RVReservationCardSrv","$state","RVGuestCardsSrv","rvUtilSrv",function(e,t,a,r,n,o,i,s,c,d,l,u,m){BaseCtrl.call(this,e);var f;GuestCardBaseCtrl.call(this,e,i,a,c,t);var p="rover.reservation.staycard.reservationcard.reservationdetails",v=JSON.parse(JSON.stringify(e.guestCardData.contactInfo));e.errorMessage="",e.$on("clearNotifications",function(){e.successMessage="",e.$emit("contactInfoError",!1)}),e.$on("RESETCONTACTINFO",function(e,t){v.address=t.address,v.phone=t.phone,v.email=t.email,v.first_name=t.first_name,v.last_name=t.last_name});var D=function(t){e.$emit("hideLoader"),e.errorMessage=t,e.saveGuestCardInfoInProgress=!1},h=function(t){""!==t.mandatory_field_missing_message&&null!==t.mandatory_field_missing_message&&(e.errorMessage=t.mandatory_field_missing_message,e.$emit("contactInfoError",!0)),e.reservationData&&(e.reservationData.guest.email=e.guestCardData.contactInfo.email,e.reservationData.guest.email&&e.reservationData.guest.email.length>0?e.otherData.isGuestPrimaryEmailChecked=!0:e.otherData.isGuestPrimaryEmailChecked=!1);var a=getAvatharUrl(e.guestCardData.contactInfo.title);e.$emit("CHANGEAVATAR",a),e.$emit("RESETHEADERDATA",e.guestCardData.contactInfo),e.updateSearchCache(a),e.$emit("hideLoader")},y=function(t){e.$emit("hideLoader"),e.errorMessage=t,e.$emit("GUESTCARDVISIBLE",!0),e.$emit("contactInfoError",!0)},g=function(t,a,r,n){var o=function(){};e.callAPI(d.attachGuestToReservation,{onSuccess:o,params:{reservation_id:t,guest_detail_id:a,is_primary:r,guest_type:n}})};e.saveContactInfo=function(t){var r=function(t){""!==t.mandatory_field_missing_message&&null!==t.mandatory_field_missing_message&&(e.errorMessage=t.mandatory_field_missing_message,e.$emit("contactInfoError",!0)),e.$emit("hideLoader"),"undefined"!=typeof e.guestCardData.contactInfo.user_id&&""!==e.guestCardData.userId&&null!==e.guestCardData.userId&&"undefined"!=typeof e.guestCardData.userId||("STAY_CARD"===e.viewState.identifier||"CREATION"===e.viewState.identifier&&e.viewState.reservationStatus.confirm)&&(e.viewState.pendingRemoval.status=!1,e.viewState.pendingRemoval.cardType="",e.reservationDetails.guestCard.futureReservations<=0?e.replaceCardCaller("guest",{id:t.id},!1):e.checkFuture("guest",{id:t.id})),e.guestCardData.contactInfo.user_id=t.id,e.reservationDetails&&(e.reservationDetails.guestCard.id=t.id,e.reservationDetails.guestCard.futureReservations=0),e.saveGuestCardInfoInProgress=!1,e.reservationData&&e.reservationData.guest&&(e.reservationData.guest.id=t.id,e.reservationData.guest.firstName=e.guestCardData.contactInfo.first_name,e.reservationData.guest.lastName=e.guestCardData.contactInfo.last_name,e.reservationData.guest.phone=e.guestCardData.contactInfo.phone,e.reservationData.guest.mobile=e.guestCardData.contactInfo.mobile,e.reservationData.guest.is_vip=e.guestCardData.contactInfo.vip,e.reservationData.guest.email=e.guestCardData.contactInfo.email,e.reservationData.guest.image=e.guestCardData.contactInfo.avatar,e.reservationData.guest.address=e.guestCardData.contactInfo.address,e.reservationData.guest.loyaltyNumber=e.guestLoyaltyNumber,l.current.name!==p&&e.reservationData.reservationId&&g(e.reservationData.reservationId,e.reservationData.guest.id,!0)),e.guestCardData.userId=t.id,e.isGuestCardFromMenu||e.showGuestPaymentList(e.guestCardData.contactInfo),e.newGuestAdded(t.id),""===e.errorMessage&&"rover.guest.details"!==l.current.name&&e.closeGuestCard(),e.guestCardData.contactInfo.can_guest_details_anonymized=!0,
e.guestCardData.contactInfo.can_guest_card_delete=!0,s.fromStaycard&&!s.guestId&&g(s.reservationId,t.id,s.isPrimary,s.guestType)};v=a.completeContactInfoClone?JSON.parse(JSON.stringify(a.completeContactInfoClone)):{};var n=JSON.parse(JSON.stringify(e.guestCardData.contactInfo)),i=!1;if(angular.equals(n,v))i=!0;else{a.completeContactInfoClone=JSON.parse(JSON.stringify(n)),e.guestCardData.contactInfo.birthday?n.birthday=moment(e.guestCardData.contactInfo.birthday).format("MM-DD-YYYY"):n.birthday=null,e.guestCardData.contactInfo.id_issue_date?n.id_issue_date=moment(e.guestCardData.contactInfo.id_issue_date).format("YYYY-MM-DD"):n.id_issue_date=null,e.guestCardData.contactInfo.entry_date?n.entry_date=moment(e.guestCardData.contactInfo.entry_date).format("YYYY-MM-DD"):n.entry_date=null,e.guestCardData.contactInfo.id_expiration_date?n.id_expiration_date=moment(e.guestCardData.contactInfo.id_expiration_date).format("YYYY-MM-DD"):n.id_expiration_date=null;var c=["guestImageBase64"];"Invalid date"===n.birthday&&(n.birthday=null,e.guestCardData.contactInfo.birthday=null),n.avatar=n.guestImageBase64?n.guestImageBase64:"",n=dclone(n,c)}"undefined"==typeof n.address&&(n.address={});var d=e.guestCardData.userId||e.guestCardData.contactInfo.user_id;""===n.email||m.isEmailValid(n.email)||o(function(){e.guestCardData.contactInfo.email=e.reservationData.guest.email},100);var C={data:n,userId:d};_.isUndefined(e.viewState.identifier)?C.data.current_page="always":C.data.current_page="CREATION"===e.viewState.identifier||"CONFIRM"===e.viewState.identifier?"at_booking":"at_checkin",e.invokeApi(u.fetchGuestAdminSettings,"",function(o){C.data.guest_admin_settings=o,t&&!n.user_id?("undefined"==typeof C.data.is_opted_promotion_email&&(C.data.is_opted_promotion_email=!1),s.guestType&&(C.data.guest_type=s.guestType),e.invokeApi(a.createGuest,C,r,D)):i||angular.equals(n,f)||(f=dclone(n,["confirmation_num"]),(e.isGuestCardVisible||e.isFromMenuGuest)&&e.invokeApi(a.updateGuest,C,h,y))},function(){})},e.$on("saveContactInfo",function(){e.errorMessage="",e.reservationData&&!e.reservationData.guest.id&&!e.guestCardData.contactInfo.user_id||e.viewState.isAddNewCard?e.saveGuestCardInfoInProgress||e.isGuestCardSaveInProgress||(e.saveGuestCardInfoInProgress=!0,e.saveContactInfo(!0)):e.isGuestCardSaveInProgress||e.saveContactInfo()}),e.$on("updateEmailFromGMS",function(t,r){e.guestCardData.contactInfo.email=r;var n=JSON.parse(JSON.stringify(e.guestCardData.contactInfo)),o={data:n,userId:e.guestCardData.contactInfo.user_id};e.invokeApi(a.updateGuest,o,h,y)}),e.$on("showSaveMessage",function(){e.errorMessage=["Please save the Guest Card first"]}),e.popupCalendarForGuestContactInfoDate=function(t){e.calenderFor=t,r.open({template:"/assets/partials/guestCard/contactInfoCalendarPopup.html",controller:"RVAllContactInfoDatePickerController",className:"single-date-picker",scope:e})},e.setScroller("contact_info");var C=function(){o(function(){e.refreshScroller("contact_info")},700)};e.$on("CONTACTINFOLOADED",C),e.$on("REFRESHLIKESSCROLL",C);var A=function(t){e.$emit("hideLoader"),e.languageData=t},S=function(){e.invokeApi(a.fetchGuestLanguages,{},A)},I=function(){S();var t=["confirmation_num"];f=dclone(e.guestCardData.contactInfo,t),e.hasPermissionToFlagGuest=c.getPermissionValue("FLAG_GUEST")},T=e.$on("UPDATE_STAY_COUNT",function(e,t){f.stayCount=t.stayCount});e.$on("$destroy",T),e.getStyleClassForPrint=function(e,t){return t=t||"",(""===e||null===e||_.isUndefined(e))&&(t+=" no-print"),t},e.onBlackListToggle=function(){e.guestCardData.contactInfo.is_flagged=!e.guestCardData.contactInfo.is_flagged,e.guestCardData.contactInfo.is_flagged||(e.guestCardData.contactInfo.flagged_reason="")},e.addMarginClass=function(){if(e.guestCardData.contactInfo.guest_admin_settings.id_place_of_issue.is_visible&&!$("#place-of-issue").hasClass("margin"))return!0},e.addMarginClassForExpirationDate=function(){if(!e.guestCardData.contactInfo.guest_admin_settings.id_country_of_issue.is_visible){var t=e.addMarginClass();return t}if(!$("#country-of-issue").hasClass("margin"))return!0},e.addMarginClassForEntryDate=function(){if(!e.guestCardData.contactInfo.guest_admin_settings.id_expiration_date.is_visible){var t=e.addMarginClassForExpirationDate();return t}if(!$("#expiry-date").hasClass("margin"))return!0},I()}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){angular.module("sntRover").controller("RVCheckInAuthCtrl",["$scope","$rootScope","$log","RVCCAuthorizationSrv","rvPermissionSrv",function(e,t,a,r,n){var o=function(){return"SHIJI"===t.hotelDetails.payment_gateway&&t.hotelDetails.shiji_token_enable_offline};e.onClickContinueWithoutCC=function(){e.$emit("CONTINUE_CHECKIN",e.authResponse)},e.authorize=function(){var a={};e.checkInState.swipedCardData&&(a=angular.copy(e.checkInState.swipedCardData)),a=_.extend(a,{is_emv_request:e.ngDialogData.is_emv_request,amount:e.ngDialogData.amount||0,payment_method_id:e.ngDialogData.payment_method_id,reservation_id:e.ngDialogData.reservation_id}),o()&&(a.auth_code=e.authData.auth_code,a.amount=e.authData.amount),a.isShift4Request="SHIFT4"===t.hotelDetails.payment_gateway,e.callAPI(r.manualAuthorization,{params:a,successCallBack:function(t){e.authResponse=t,e.authState="SUCCESS",o()&&e.onClickContinueWithoutCC()},failureCallBack:function(t){e.authResponse=t,e.authState="FAILURE"}})},e.onClickContinue=function(){e.$emit("CONTINUE_CHECKIN",e.authResponse)},e.cancelAuthProcess=function(){e.$emit("STOP_CHECKIN_PROCESS")},function(){e.authState="IN_PROGRESS",e.authResponse={},e.canCheckInWithoutCC=n.getPermissionValue("OVERRIDE_CC_AUTHORIZATION"),o()?e.authData={amount:angular.copy(e.ngDialogData.amount),auth_code:""}:e.authorize()}()}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){angular.module("sntRover").controller("RVReservationCheckInFlowCtrl",["$scope","$rootScope","RVHotelDetailsSrv","$log","RVCCAuthorizationSrv","ngDialog","$timeout","RVBillCardSrv","$state","sntActivity","sntEMVSharedSrv",function(e,t,a,r,n,o,i,s,c,d,l){var u={},m=function(){var t=e.reservationBillData.bills[e.currentActiveBill];return t.credit_card_details&&t.credit_card_details.payment_id||""},f=function(){e.callAPI(n.fetchPendingAuthorizations,{loader:!1,params:e.reservationBillData.reservation_id,successCallBack:function(t){var a=e.reservationBillData.routing_info,r=t.is_cc_authorize_for_incidentals_active&&(a.out_going_to_room||a.out_going_to_comp_tra);e.authorizationInfo=t,e.checkInState.authorizationAmount=t.pre_auth_amount_at_checkin||0,angular.extend(e.authorizationInfo,{routingToRoom:a.out_going_to_room,routingFromRoom:a.incoming_from_room,routingToAccount:a.out_going_to_comp_tra,canPayIncidentalsOnly:r}),e.checkInState.isAuthInfoFetchComplete=!0,d.stop("REFRESH_PRE_AUTH_INFO")},failureCallBack:function(t){e.errorMessage=t,e.checkInState.isAuthInfoFetchComplete=!0}})},p=function(){o.open({template:"/assets/partials/authorization/rvCheckInAuthUserActionPopup.html",className:"",closeByDocument:!1,closeByEscape:!1,scope:e})},v=function(){e.checkInState.hasActiveEMV&&!e.authorizationInfo.is_cc_authorize_at_checkin_enabled?h():e.reservationBillData.is_disabled_cc_swipe?e.checkInState.hasCardOnFile&&t.isStandAlone?D({is_emv_request:!1,amount:e.checkInState.authorizationAmount,payment_method_id:m()}):(r.info("prompt for swipe disabled in settings AND cannot authorize WITHOUT card on file"),h()):(e.checkInState.isListeningSwipe=!0,o.open({template:"/assets/partials/payment/rvPleaseSwipeModal.html",className:"",scope:e}))},D=function(t){_.extend(t,{reservation_id:e.reservationBillData.reservation_id}),t.amount>0&&e.authorizationInfo.is_cc_authorize_at_checkin_enabled?o.open({template:"/assets/partials/authorization/ccAuthorization.html",className:"",closeByDocument:!1,scope:e,controller:"RVCheckInAuthCtrl",data:angular.toJson(t)}):h()},h=function(){var t=e.getSignature(),a={is_promotions_and_email_set:e.saveData.promotions,reservation_id:e.reservationBillData.reservation_id,restrict_post:!!e.reservationBillData.restrict_post};r.info("completeCheckIn",a),"isSigned"!==t&&"[]"!==t&&(a.signature=e.getSignatureBase64Data()),e.swippedCard&&_.extend(a,e.checkInState.swipedCardData),"false"===e.reservationBillData.is_disabled_terms_conditions_checkin&&(a.accepted_terms_and_conditions=e.saveData.termsAndConditions),o.close(),e.callAPI(s.completeCheckin,{params:a,successCallBack:e.completeCheckinSuccessCallback,failureCallBack:e.completeCheckinFailureCallback})};e.checkInState={authorizeIncidentalOnly:!1,authorizationAmount:0,hasActiveEMV:a.isActiveMLIEMV(),hasSuccessfulAuthorization:!1,hasCardOnFile:e.billHasCreditCard(),isAuthInfoFetchComplete:!1,isAuthorizationInProgress:!1,requireSignature:e.signatureNeeded(),requireTerms:e.termsConditionsNeeded(),isListeningSwipe:!1,swipedCardData:{}},e.onClickEMV=function(){var t=e.checkInState.authorizationAmount;e.checkInState.authorizeIncidentalOnly||(t=e.authorizationInfo.original_pre_auth_amount_at_checkin),D({is_emv_request:!0,amount:t})};var y=function(a){var r=a.cardDetails,n=a.response,o=e.reservationBillData;_.extend(o.bills[0].credit_card_details,{card_code:r.card_code,card_number:r.ending_with,card_expiry:r.expiry_date,payment_id:n.id,is_swiped:r.is_swiped,auth_color_code:r.auth_color_code}),o.bills[0].credit_card_details.payment_type="CC",1===e.billNumber&&t.$emit("UPDATEDPAYMENTLIST",o.bills[0].credit_card_details),t.$broadcast("BALANCECHANGED",{balance:n.reservation_balance,confirm_no:o.confirm_no}),t.$broadcast("paymentChangedToCC"),i(h,300),e.$emit("UPDATECCATTACHEDBILLSTATUS",n.has_any_credit_card_attached_bill)};e.addCardWithEMV=function(){o.close(),l.addCardInTerminal({workstation_id:e.workstation_id,bill_number:e.reservationData.bills[e.currentActiveBill].bill_number,reservation_id:e.reservationData.reservationId,emvTimeout:e.emvTimeout}).then(y,function(t){r.warn(t),e.errorMessage=t})},e.onClickUseCardOnFile=function(){D({is_emv_request:!1,amount:e.checkInState.authorizationAmount,payment_method_id:m()})},e.onClickNoSwipe=function(){o.close(),h()};var g=function(){i(v,700)};e.onClickIncidentalsOnly=function(){e.checkInState.authorizeIncidentalOnly=!0,e.checkInState.authorizationAmount=e.authorizationInfo.pre_auth_amount_for_incidentals,o.close(),g()},e.onClickFullAuth=function(){e.checkInState.authorizeIncidentalOnly=!1,e.checkInState.authorizationAmount=e.authorizationInfo.pre_auth_amount_at_checkin,o.close(),g()},e.onClickManualAuth=function(){h()},e.checkIn=function(){var a,r=e.getSignature(),n=e.reservationBillData.reservation_status;if(!t.isStandAlone)return e.clickedCompleteCheckin(),!1;if(e.signatureNeeded(r)&&!e.reservation.reservation_card.is_pre_checkin)return a="Signature is missing",void e.showErrorPopup(a);if(e.termsConditionsNeeded())return a="Please check agree to the Terms & Conditions",void e.showErrorPopup(a);if(e.validateEmailNeeded())return void o.open({template:"/assets/partials/validateCheckin/rvAskEmailFromCheckin.html",controller:"RVValidateEmailPhoneCtrl",className:"",scope:e});if(e.guestCardData&&e.guestCardData.contactInfo&&(e.guestCardData.contactInfo.is_opted_promotion_email=e.saveData.promotions),e.hasAnySharerCheckedin());else if(("NOTREADY"===e.reservationBillData.room_status||"OCCUPIED"===e.reservationBillData.fo_status)&&!t.queuedCheckIn)return c.go("rover.reservation.staycard.roomassignment",{reservation_id:e.reservationBillData.reservation_id,room_type:e.reservationBillData.room_type,clickedButton:"checkinButton",upgrade_available:e.reservationBillData.is_upsell_available&&("RESERVED"===n||"CHECKING_IN"===n),roomTypeId:e.reservation.reservation_card.room_type_id}),!1;if(e.checkInState.isAuthInfoFetchComplete){d.stop("FETCH_PRE_AUTH"),e.checkInState.hasCardOnFile=e.billHasCreditCard();var s=e.authorizationInfo.routingToRoom||e.authorizationInfo.routingFromRoom||e.authorizationInfo.routingToAccount;e.authorizationInfo.is_cc_authorize_at_checkin_enabled||!e.reservationBillData.is_disabled_cc_swipe?s&&e.authorizationInfo.is_cc_authorize_at_checkin_enabled&&(e.checkInState.hasCardOnFile||!e.reservationBillData.is_disabled_cc_swipe)?p():v():h()}else d.start("FETCH_PRE_AUTH"),i(e.checkIn,700)};var C=function(){u.CONTINUE_CHECKIN=e.$on("CONTINUE_CHECKIN",function(e){r.info("CONTINUE_CHECKIN",e),h()}),u.SWIPED_CARD_ADDED=e.$on("SWIPED_CARD_ADDED",function(t,a){e.checkInState.isListeningSwipe&&i(function(){e.checkInState.swipedCardData=a,e.onClickUseCardOnFile()},700)}),u.STOP_CHECKIN_PROCESS=e.$on("STOP_CHECKIN_PROCESS",function(){e.checkInState.isListeningSwipe=!1,e.checkInState.authorizationAmount=e.authorizationInfo.pre_auth_amount_at_checkin,o.close()}),u.FETCH_REMAINING_AUTH=e.$on("FETCH_REMAINING_AUTH",function(){e.checkInState.isAuthInfoFetchComplete=!1,d.start("REFRESH_PRE_AUTH_INFO"),f()}),e.$on("$destroy",u.CONTINUE_CHECKIN),e.$on("$destroy",u.SWIPED_CARD_ADDED),e.$on("$destroy",u.STOP_CHECKIN_PROCESS),e.$on("$destroy",u.FETCH_REMAINING_AUTH)};!function(){e.authorizationInfo=null,f(),t.isStandAlone&&C()}()}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){sntRover.controller("RVSelectRoomAndRateCtrl",["$rootScope","$scope","areReservationAddonsAvailable","$stateParams","rates","ratesMeta","$timeout","$state","RVReservationBaseSearchSrv","RVReservationStateService","RVReservationDataService","house","RVSelectRoomRateSrv","rvPermissionSrv","ngDialog","$filter","RVRoomRatesSrv","rvGroupConfigurationSrv","rvAllotmentConfigurationSrv","dateFilter","houseRestrictions",function(e,t,a,r,n,o,i,s,c,d,l,u,m,f,p,v,D,h,y,g,C){if(BaseCtrl.call(this,t),t.borrowForGroups="true"===r.borrow_for_groups,t.stateCheck={pagination:{roomType:{perPage:25,page:1,ratesList:{perPage:25}},rate:{perPage:25,page:1,roomsList:{perPage:25}}},house:u,baseInfo:{roomTypes:[],totalCount:n.total_count,rates:[],maxAvblRates:n.total_count},activeMode:r.view&&"CALENDAR"===r.view?"CALENDAR":"ROOM_RATE",activeView:"",stayDatesMode:!1,calendarState:{showOnlyAvailableRooms:!0,searchWithRestrictions:!0,calendarType:"BEST_AVAILABLE"},roomDetails:{},preferredType:"",taxInfo:null,showClosedRates:!1,rateSelected:{allDays:!1,oneDay:!1},selectedStayDate:"",dateModeActiveDate:"",dateButtonContainerWidth:80*t.reservationData.stayDays.length,guestOptionsIsEditable:!1,exhaustedAddons:[],showLessRooms:!r.room_type_id,maxRoomsToShow:0,selectedRoomType:-1,stayDates:{},isFromNightlyDiary:"NIGHTLY_DIARY"===r.fromState,roomTypeIdFromNightlyDiary:"NIGHTLY_DIARY"===r.fromState?r.room_type_id:""},t.display={roomFirstGrid:[],rateFirstGrid:[]},t.restrictionColorClass=m.restrictionColorClass,t.restrictionsMapping=o.restrictions,t.stateCheck.isFromNightlyDiary){t.reservationData.isFromNightlyDiary=!0,t.reservationData.arrivalDate=r.from_date,t.reservationData.departureDate=r.to_date,t.reservationData.tabs[0].checkinTime=r.arrivalTime,t.reservationData.tabs[0].checkoutTime=r.departureTime,t.reservationData.tabs[0].roomCount=1,t.reservationData.numNights=r.numNights,t.reservationData.roomTypeIdFromNightlyDiary=r.room_type_id;for(var A=function(e){0===e&&(t.reservationData.stayDays=[]),t.reservationData.rooms[e].stayDates={};for(var a=1*new tzIndependentDate(t.reservationData.arrivalDate),r=1*new tzIndependentDate(t.reservationData.departureDate);a<=r;a+=864e5)0===e&&t.reservationData.stayDays.push({date:g(new tzIndependentDate(a),"yyyy-MM-dd"),dayOfWeek:g(new tzIndependentDate(a),"EEE"),day:g(new tzIndependentDate(a),"dd")}),t.reservationData.rooms[e].stayDates[g(new tzIndependentDate(a),"yyyy-MM-dd")]={guests:{adults:parseInt(t.reservationData.rooms[e].numAdults),children:parseInt(t.reservationData.rooms[e].numChildren),infants:parseInt(t.reservationData.rooms[e].numInfants)},rate:{id:"",name:""}}},S=0;S<t.reservationData.rooms.length;S++)A(S)}"STAY_CARD"===r.fromState&&angular.forEach(t.reservation.reservation_card.stay_dates,function(e){t.reservationData.rooms[0].stayDates[e.date].contractId=e.contract_id});var I=t.reservationData.tabs,T=t.reservationData.rooms,E=t.reservationData.arrivalDate,R=t.reservationData.departureDate,b=0,N=!1,P=function(e){var a=t.$parent.myScroll&&t.$parent.myScroll[e];return _.isUndefined(a)&&(a=t.myScroll[e]),a},k=function(){t.stateCheck.activeView="ROOM_TYPE","Recommended"===t.otherData.defaultRateDisplayName?t.stateCheck.activeView="RECOMMENDED":"By Rate"===t.otherData.defaultRateDisplayName&&(t.stateCheck.activeView="RATE")},O=function(){return s.params.travel_agent_id||t.reservationData.travelAgent.id||s.params.company_id||t.reservationData.company.id||s.params.group_id||t.reservationData.group.id||s.params.allotment_id||t.reservationData.allotment.id||s.params.promotion_id||t.reservationData.promotionId||0===t.reservationData.numNights||s.params.is_member},w=function(){var a=t.reservationData.guestMemberships,r=t.reservationData.member.value,n=_.findWhere(a.ffp,{membership_type:r}),o=_.findWhere(a.hlp,{membership_type:r});return e.isFFPActive&&!!n||e.isHLPActive&&!!o},M=function(){var e=t.reservationData.code.from,a=t.reservationData.code.to,r=!0,n={};return _.each(T[t.stateCheck.roomDetails.firstIndex].stayDates,function(t,o){o===R&&o!==E||(e&&(r=new tzIndependentDate(e)<=new tzIndependentDate(o)),a&&(r=new tzIndependentDate(a)>=new tzIndependentDate(o))),n[o]=r}),n},L=function(e){var t=parseInt(I[e].roomTypeId,10)||"",a=_.indexOf(T,_.findWhere(T,{roomTypeId:t})),r=_.lastIndexOf(T,_.last(_.where(T,{roomTypeId:t})));return{roomTypeId:t,firstIndex:a,lastIndex:r}},x=function(){return L(t.activeRoom)},F=function(){var e={allDays:!0,oneDay:!1};return _.each(T[t.stateCheck.roomDetails.firstIndex].stayDates,function(t,a){t.rate.id&&(e.oneDay=!0),e.allDays&&a!==R&&!t.rate.id&&(e.allDays=!1)}),e},B=function(e,a,n){var o=_.pluck(T[t.stateCheck.roomDetails.firstIndex].stayDates,"guests");o.length>1&&o.splice(-1,1);var i={from_date:E,to_date:R,company_id:"RECOMMENDED"==t.stateCheck.activeView?t.reservationData.company.id:null,travel_agent_id:"RECOMMENDED"==t.stateCheck.activeView?t.reservationData.travelAgent.id:null,group_id:t.reservationData.group.id||t.reservationData.allotment.id,promotion_code:"RECOMMENDED"==t.stateCheck.activeView?t.reservationData.searchPromoCode:null,promotion_id:"RECOMMENDED"==t.stateCheck.activeView?t.reservationData.promotionId:null,override_restrictions:t.stateCheck.showClosedRates,adults:o[0]?o[0].adults:1,children:o[0]?o[0].children:"",include_expired_promotions:!!t.reservationData.promotionId&&t.stateCheck.showClosedRates,per_page:t.stateCheck.pagination.rate.roomsList.perPage,page:n,is_member:"RECOMMENDED"===t.stateCheck.activeView?!!t.reservationData.member.isSelected||r.is_member:"",is_zero_night:"RECOMMENDED"===t.stateCheck.activeView&&0===t.reservationData.numNights};if(t.stateCheck.stayDatesMode){var s=T[t.stateCheck.roomDetails.firstIndex].stayDates[t.stateCheck.dateModeActiveDate].guests;i.restrictions_on_date=t.stateCheck.dateModeActiveDate,i.adults=s.adults,i.children=s.children,t.stateCheck.rateSelected.oneDay&&(i.room_type_id=t.stateCheck.preferredType,i.per_page=1,i.page=n)}"RATE"===t.stateCheck.activeView?i.order="LOW_TO_HIGH":"ROOM_TYPE"===t.stateCheck.activeView&&(i.order="ROOM_LEVEL"),t.stateCheck.preferredType&&(i.room_type_id=t.stateCheck.preferredType),a&&"string"!=typeof a&&(i.rate_id=a),t.stateCheck.stayDatesMode&&t.reservationData.numNights>1&&""!==t.reservationData.currentSelectedRateCurrencyId&&(i.rate_currency_id=t.reservationData.currentSelectedRateCurrencyId),t.callAPI(D.fetchRoomTypeADRs,{params:i,successCallBack:e})},G=function(){_.each(c.rateDetailsList,function(e){t.reservationData.ratesMeta[e.details.id]=e.details})},V=function(e){e||(t.stateCheck.pagination.roomType.page=1);var a=_.pluck(T[t.stateCheck.roomDetails.firstIndex].stayDates,"guests");a.length>1&&a.splice(-1,1);var n={from_date:E,to_date:R,group_id:t.reservationData.group.id||t.reservationData.allotment.id,override_restrictions:t.stateCheck.showClosedRates,adults:a[0]?a[0].adults:1,children:a[0]?a[0].children:"",include_expired_promotions:!!t.reservationData.promotionId&&t.stateCheck.showClosedRates,per_page:t.stateCheck.pagination.roomType.perPage,page:t.stateCheck.pagination.roomType.page,is_member:!!t.reservationData.member.isSelected},o=null===I[0].room_id;if(t.stateCheck.isFromNightlyDiary&&!o&&(n.room_type_id=r.room_type_id),t.stateCheck.stayDatesMode){var i=T[t.stateCheck.roomDetails.firstIndex].stayDates[t.stateCheck.dateModeActiveDate].guests;n.restrictions_on_date=t.stateCheck.dateModeActiveDate,n.adults=i.adults,n.children=i.children,t.stateCheck.rateSelected.oneDay&&(n.room_type_id=t.stateCheck.preferredType,n.per_page=1,n.page=1)}t.stateCheck.preferredType&&(n.room_type_id=t.stateCheck.preferredType),"ROOM_TYPE"===t.stateCheck.activeView&&(n.order="ROOM_LEVEL"),t.stateCheck.stayDatesMode&&t.reservationData.numNights>1&&""!==t.reservationData.currentSelectedRateCurrencyId&&(n.rate_currency_id=t.reservationData.currentSelectedRateCurrencyId),t.invokeApi(D.fetchRoomTypeADRs,n,function(a){e?t.stateCheck.baseInfo.roomTypes=t.stateCheck.baseInfo.roomTypes.concat(a.results):(t.stateCheck.baseInfo.totalCount=a.total_count,t.stateCheck.baseInfo.roomTypes=a.results),H(),t.stateCheck.showLessRooms=!1,t.$emit("hideLoader")})},U=function(){var e;t.reservationData.group.id&&(e=d.getCustomRateModel(t.reservationData.group.id,t.reservationData.group.name,"GROUP"),o.customRates.custom_group_taxes&&(e.taxes=o.customRates.custom_group_taxes),t.reservationData.ratesMeta[e.id]=e),t.reservationData.allotment.id&&(e=d.getCustomRateModel(t.reservationData.allotment.id,t.reservationData.allotment.name,"ALLOTMENT"),t.reservationData.ratesMeta[e.id]=e)},q=function(e,a,n,o){var i=_.pluck(T[t.stateCheck.roomDetails.firstIndex].stayDates,"guests");(t.reservationData.inHouse||t.stateCheck.isFromNightlyDiary)&&(e=r.room_type_id);var s={page:n,from_date:E,to_date:R,room_type_id:e,rate_id:a,override_restrictions:t.stateCheck.showClosedRates,adults:i[0]?i[0].adults:1,children:i[0]?i[0].children:"",include_expired_promotions:!!t.reservationData.promotionId&&t.stateCheck.showClosedRates};if(t.stateCheck.stayDatesMode){var c=T[t.stateCheck.roomDetails.firstIndex].stayDates[t.stateCheck.dateModeActiveDate].guests;s.restrictions_on_date=t.stateCheck.dateModeActiveDate,s.adults=c.adults,s.children=c.children}"ROOM_TYPE"===t.stateCheck.activeView?s.per_page=t.stateCheck.pagination.roomType.ratesList.perPage:(s.per_page=t.stateCheck.pagination.rate.perPage,s.order="RATE",t.stateCheck.preferredType&&!e&&(s.room_type_id=t.stateCheck.preferredType)),"RECOMMENDED"===t.stateCheck.activeView&&(s.company_id=t.reservationData.company.id,s.travel_agent_id=t.reservationData.travelAgent.id,s.group_id=t.reservationData.group.id||t.reservationData.allotment.id,s.promotion_code=r.promotion_code,s.is_member=!!t.reservationData.member.isSelected||r.is_member,s.promotion_id=t.reservationData.promotionId,s.is_zero_night=0===t.reservationData.numNights),s.is_promotion_selected=!!t.reservationData.promotionId,t.stateCheck.stayDatesMode&&t.reservationData.numNights>1&&""!==t.reservationData.currentSelectedRateCurrencyId&&(s.rate_currency_id=t.reservationData.currentSelectedRateCurrencyId),T&&T.length&&T[0].stayDates&&T[0].stayDates[E]&&T[0].stayDates[E].rate&&T[0].stayDates[E].rate.id&&(s.arrivalDateRateId=T[0].stayDates[E].rate.id),t.callAPI(D.fetchRateADRs,{params:s,successCallBack:o})},H=function(){G(),t.display.roomFirstGrid=[],t.stateCheck.preferredType||(t.stateCheck.selectedRoomType=-1),_.each(t.stateCheck.baseInfo.roomTypes,function(e){var a=ve(e.multiple_restrictions,e.rate_id),r=l.getDatesModel(E,R);t.reservationData.ratesMeta[e.rate_id]||U();var n=!("RECOMMENDED"!=t.stateCheck.activeView||!t.reservationData.group.id)&&!!t.reservationData.group.id,i=!("RECOMMENDED"!=t.stateCheck.activeView||!t.reservationData.ratesMeta[e.rate_id].is_suppress_rate_on)&&!!t.reservationData.ratesMeta[e.rate_id].is_suppress_rate_on,s=!("RECOMMENDED"!=t.stateCheck.activeView||!t.reservationData.member.isSelected||!t.reservationData.ratesMeta[e.rate_id].is_member)&&(!!t.reservationData.member.isSelected&&t.reservationData.ratesMeta[e.rate_id].is_member),c="RECOMMENDED"==t.stateCheck.activeView&&!a.isPromoInvalid&&_.indexOf(t.reservationData.ratesMeta[e.rate_id].linked_promotion_ids,t.reservationData.code.id)>-1&&(!a.isPromoInvalid&&_.indexOf(t.reservationData.ratesMeta[e.rate_id].linked_promotion_ids,t.reservationData.code.id)>-1);_.each(e.restrictions,function(e){var t=e.restriction_type_id;e.restrictionBgClass="bg-"+getRestrictionClass(o.restrictions[t].key),e.restrictionIcon=getRestrictionIcon(o.restrictions[t].key)});var d="undefined"!=typeof e.restrictions?e.restrictions.length:0,u={isCollapsed:t.stateCheck.selectedRoomType!=e.id,name:t.reservationData.roomsMeta[e.id].name,id:e.id,rateCurrency:e.rate_currency,ratesArray:[],restriction:e.restrictions,availability:e.availability,isSuiteUnavailable:t.reservationData.roomsMeta[e.id].is_suite&&(e.availability<=0||e.availability<t.reservationData.rooms.length)},m={id:e.rate_id,name:t.reservationData.ratesMeta[e.rate_id].name,rateCurrency:e.rate_currency,rateCurrencyId:e.rate_currency_id,adr:e.adr,dates:angular.copy(r),bestAvailableRateRestrictions:e.restrictions,numRestrictions:d,forRoomType:e.id,buttonClass:ce(d,e.rate_id,e.availability),showDays:!1,totalAmount:0,isGroupRate:n,isSuppressed:i,isMember:s,isPromotion:c};u.ratesArray.push(m),_.extend(u.ratesArray[0].dates[t.reservationData.arrivalDate],{availability:e.availability}),u.defaultRate=u.ratesArray[0],t.display.roomFirstGrid.push(u)}),t.refreshScroll()},Y=function(e,a){G(),a||(t.display.rateFirstGrid=[]),_.each(e,function(e){var a="RECOMMENDED"==t.stateCheck.activeView&&t.reservationData.group.id,r="RECOMMENDED"==t.stateCheck.activeView&&t.reservationData.allotment.id,n=!1,i=e.id&&t.reservationData.ratesMeta[e.id].is_suppress_rate_on,s=!1,c=!1;e.id&&"RECOMMENDED"==t.stateCheck.activeView&&(n=!!e.contract_name,s=!(!t.reservationData.member.isSelected||!t.reservationData.ratesMeta[e.id].is_member)&&(!!t.reservationData.member.isSelected&&t.reservationData.ratesMeta[e.id].is_member),c=_.indexOf(t.reservationData.ratesMeta[e.id].linked_promotion_ids,t.reservationData.code.id)>-1&&_.indexOf(t.reservationData.ratesMeta[e.id].linked_promotion_ids,t.reservationData.code.id)>-1),_.each(e.restrictions,function(e){var t=e.restriction_type_id;e.restrictionBgClass="bg-"+getRestrictionClass(o.restrictions[t].key),e.restrictionIcon=getRestrictionIcon(o.restrictions[t].key)});var d=ve(e.multiple_restrictions,e.id),l={isCollapsed:!0,name:e.id?t.reservationData.ratesMeta[e.id].name:"Custom Rate for "+t.reservationData.group.name,id:e.id,rateCurrency:e.rate_currency,rateCurrencyId:e.rate_currency_id,defaultRoomTypeId:e.room_type_id,defaultRoomTypeAvailability:e.availability,defaultADR:e.adr,contractName:n?e.contract_name:"",contractId:n?e.contract_id:"",rooms:[],restriction:e.restrictions,hasRoomsList:!1,buttonClass:ce(d.restrictionCount||0,e.id,e.availability),isGroupRate:a,isAllotmentRate:r,isCorporate:n,isSuppressed:i,isMember:s,isPromotion:c,isDefaultRoomTypeSuiteUnavailable:t.reservationData.roomsMeta[e.room_type_id].is_suite&&(e.availability<=0||e.availability<t.reservationData.rooms.length),isDayUse:t.reservationData.ratesMeta[e.id].is_day_use};l.rooms.push({id:e.room_type_id,name:t.reservationData.roomsMeta[e.room_type_id].name,availability:e.availability,forRate:e.id}),t.display.rateFirstGrid.push(l)}),t.refreshScroll()},j=function(){s.go("rover.reservation.staycard.mainCard.addons",{from_date:E,to_date:R,rate_id:t.stateCheck.selectedStayDate.rate.id})},W=function(){var r=function(){(t.reservationData.guest.id||t.reservationData.company.id||t.reservationData.travelAgent.id||t.reservationData.group.id)&&(!e.isAddonOn||!a||"FULL"===e.hotelDiaryConfig.mode&&t.stateCheck.isFromNightlyDiary?s.go("rover.reservation.staycard.mainCard.summaryAndConfirm"):j())};if(!e.isAddonOn||!a||"FULL"===e.hotelDiaryConfig.mode&&t.stateCheck.isFromNightlyDiary){var n=_.reduce(_.pluck(T,"rateId"),function(e,t){return!!e&&!!t});if(n)t.reservationData.guest.id||t.reservationData.company.id||t.reservationData.travelAgent.id||t.reservationData.group.id?r():(t.$emit("PROMPTCARD"),t.$watch("reservationData.guest.id",r),t.$watch("reservationData.company.id",r),t.$watch("reservationData.travelAgent.id",r));else{var o=_.findIndex(T,{rateId:""}),i=_.findIndex(I,{roomTypeId:T[o].roomTypeId});t.changeActiveRoomType(i||0)}}else j()},K=function(){for(var e=t.stateCheck.roomDetails.firstIndex;e<=t.stateCheck.roomDetails.lastIndex;e++)_.each(T[e].stayDates,function(e,t){e.rate.id="",e.rate.name=""});t.stateCheck.rateSelected.allDays=!1,t.stateCheck.rateSelected.oneDay=!1,t.stateCheck.stayDates=angular.copy(T[t.stateCheck.roomDetails.firstIndex].stayDates)},J=function(){"REINSTATE"===t.viewState.identifier||"rover.reservation.staycard.reservationcard.reservationdetails"!==r.fromState&&"STAY_CARD"!==r.fromState?W():r.isGroupDetachmentRequested?e.$broadcast("DETACH_GROUP_FROM_RESERVATION"):se()},z=function(){t.setScroller("room_types",{preventDefault:!1,probeType:3}),t.setScroller("stayDates",{scrollX:!0,scrollY:!1}),i(function(){P("room_types").on("scroll",function(){var e=t.stateCheck,a=t.display.roomFirstGrid.length,r=t.display.rateFirstGrid.length;this.y<b-10&&Math.abs(this.y-this.maxScrollY)<Math.abs(this.maxScrollY/4)&&(!e.showLessRooms&&"ROOM_TYPE"===e.activeView&&e.baseInfo.totalCount>a?(e.pagination.roomType.page++,V(!0)):"RATE"===e.activeView&&e.baseInfo.maxAvblRates>r?(e.pagination.rate.page++,q(null,null,e.pagination.rate.page,function(e){t.stateCheck.baseInfo.maxAvblRates=e.total_count,Y(e.results,!0),t.refreshScroll()})):"RECOMMENDED"===e.activeView&&e.baseInfo.maxAvblRates>r&&(e.pagination.rate.page++,q(null,null,e.pagination.rate.page,function(e){t.stateCheck.baseInfo.maxAvblRates=e.total_count,Y(e.results,!0),t.refreshScroll()}))),b=this.y})},3e3)},Q=function(){r.disable_back_staycard||(t.stateCheck.isFromNightlyDiary?e.setPrevState={title:"ROOM DIARY",name:"rover.nightlyDiary"}:s.params&&s.params.isFromChangeStayDates?e.setPrevState={title:"Stay Dates",name:"rover.reservation.staycard.changestaydates"}:t.reservationData&&t.reservationData.confirmNum&&t.reservationData.reservationId?e.setPrevState={title:v("translate")("STAY_CARD"),name:"rover.reservation.staycard.reservationcard.reservationdetails",param:{confirmationId:t.reservationData.confirmNum,id:t.reservationData.reservationId,isrefresh:!0}}:e.setPrevState={title:v("translate")("CREATE_RESERVATION"),callback:"setSameCardNgo",scope:t})},X=function(){for(var e=t.stateCheck.roomDetails.firstIndex;e<=t.stateCheck.roomDetails.lastIndex;e++)t.reservationData.rooms[e].isSuppressed=!1,_.each(t.reservationData.rooms[e].stayDates,function(a,r){
var n=!!a.rate.id&&t.reservationData.ratesMeta[a.rate.id]&&!!t.reservationData.ratesMeta[a.rate.id].is_suppress_rate_on;"undefined"==typeof t.reservationData.rooms[e].isSuppressed?t.reservationData.rooms[e].isSuppressed=n:t.reservationData.rooms[e].isSuppressed=t.reservationData.rooms[e].isSuppressed||n})},Z=function(){var e=[],a={};_.each(n.results,function(t){e.push(t.rate_id?t.rate_id:t.id)}),a.rate_ids=e,a.is_zero_night=0===t.reservationData.numNights,c.fetchRatesDetails(a).then(function(){t.reservationData.ratesMeta={},ee()})},ee=function(){if(t.heading="Rooms & Rates",t.setHeadingTitle(t.heading),t.activeRoom=t.viewState.currentTab,t.stateCheck.preferredType=I[t.activeRoom].roomTypeId,t.stateCheck.roomDetails=x(),(l.isVaryingRates(T[t.stateCheck.roomDetails.firstIndex].stayDates,E,R,t.reservationData.numNights)||l.isVaryingOccupancy(T[t.stateCheck.roomDetails.firstIndex].stayDates,E,R,t.reservationData.numNights))&&"rover.reservation.staycard.reservationcard.reservationdetails"===r.fromState&&(t.reservationData.currentSelectedRateCurrencyId=r.selectedCurrencyId),!t.stateCheck.dateModeActiveDate){var a=T[t.stateCheck.roomDetails.firstIndex].stayDates;t.reservationData.midStay&&new tzIndependentDate(R)>new tzIndependentDate(e.businessDate)?(t.stateCheck.dateModeActiveDate=e.businessDate,t.stateCheck.selectedStayDate=a[e.businessDate]):(t.stateCheck.dateModeActiveDate=E,t.stateCheck.selectedStayDate=a[E])}U(),t.stateCheck.stayDates=angular.copy(T[t.stateCheck.roomDetails.firstIndex].stayDates),_.each(t.stateCheck.stayDates,function(e){e.amount=e.rateDetails&&e.rateDetails.modified_amount||null,e.rateCurrency=e.rateDetails&&(e.rateDetails.rateCurrency||e.rateDetails.rate_currency)}),(l.isVaryingRates(T[t.stateCheck.roomDetails.firstIndex].stayDates,E,R,t.reservationData.numNights)||l.isVaryingOccupancy(T[t.stateCheck.roomDetails.firstIndex].stayDates,E,R,t.reservationData.numNights))&&(t.stateCheck.stayDatesMode=!0,t.stateCheck.rateSelected.allDays=F().allDays,t.stateCheck.rateSelected.oneDay=F().oneDay),k(),(r.travel_agent_id||r.company_id||r.group_id||r.allotment_id||r.is_member||r.promotion_id)&&(t.stateCheck.activeView="RECOMMENDED"),0===t.reservationData.numNights?(t.stateCheck.activeView="RECOMMENDED",t.setActiveView("RECOMMENDED")):t.stateCheck.isFromNightlyDiary&&(t.stateCheck.activeView="ROOM_TYPE",t.setActiveView("ROOM_TYPE")),t.reservationData.code&&t.reservationData.code.id&&(t.stateCheck.promotionValidity=M()),Q(),"ROOM_TYPE"===t.stateCheck.activeView?(t.stateCheck.baseInfo.roomTypes=n.results,H()):("RATE"===t.stateCheck.activeView||"RECOMMENDED"===t.stateCheck.activeView&&O())&&(t.stateCheck.baseInfo.rates=n.results,Y(t.stateCheck.baseInfo.rates)),z(),De()},te=function(e,a){var r=[],n=function(e){var a=d.getApplicableAddonsCount(e.amountType,e.postType,parseInt(e.postFrequency,10),parseInt(I[t.viewState.currentTab].numAdults,10),parseInt(I[t.viewState.currentTab].numChildren,10),parseInt(t.reservationData.numNights,10))*parseInt(I[t.viewState.currentTab].roomCount,10);if(_.isNumber(e.inventory)&&e.inventory<a){var n=_.findIndex(r,{id:e.id});n>-1?r[n].inventory>e.inventory&&(r[n].inventory=e.inventory):r.push(e)}},o=function(e){if(e===E||e!==R){var t=d.fetchAssociatedAddons(a);_.each(t,function(t){var a=_.findWhere(t.inventory,{date:e});n({name:t.name,postType:t.post_type.value,amountType:t.amount_type.value,postFrequency:t.post_type.frequency,id:t.id,inventory:a&&_.isNumber(a.available_count)?a.available_count:null})})}};return t.stateCheck.stayDatesMode?o(t.stateCheck.dateModeActiveDate):_.each(t.reservationData.stayDays,function(e){o(e.date)}),r},ae=function(e){var a=0,r=0;e&&(t.closeDialog(),r=1500),i(function(){for(;a<t.stateCheck.exhaustedAddons.length;a++){var e=t.stateCheck.exhaustedAddons[a];if(!e.isAlerted){e.isAlerted=!0,p.open({template:"/assets/partials/reservationCard/rvInsufficientInventory.html",className:"ngdialog-theme-default",closeByDocument:!0,scope:t,data:JSON.stringify({name:e.name,count:e.inventory,canOverbookInventory:f.getPermissionValue("OVERRIDE_ITEM_INVENTORY")})});break}}a===t.stateCheck.exhaustedAddons.length&&t.handleBooking(t.stateCheck.selectedRoomRate.roomId,t.stateCheck.selectedRoomRate.rateId,!1,{skipAddonCheck:!0})},r)},re=function(e,a){a||(a=function(){console.log("No call back for tax and rate addon meta fetching")}),t.invokeApi(c.fetchTaxRateAddonMeta,{from_date:E,to_date:R,rate_id:e},function(e){t.stateCheck.taxInfo=!0,d.metaData.taxDetails=angular.copy(e.taxInfo),d.updateRateAddonsMeta(e.rateAddons),a(),t.$emit("hideLoader")})},ne=function(e,t){if("rover.reservation.staycard.reservationcard.reservationdetails"===r.fromState||"STAY_CARD"===r.fromState)return t&&t.length>0;var a=[];return _.each(e,function(e){_.find(t,{id:e.id})||a.push(e.id)}),a.length>0},oe=function(){if(X(),t.reservationData.isRoomRateSuppressed=_.reduce(_.pluck(T,"isSuppressed"),function(e,t){return e||t}),d.bookMark.lastPostedRate){var e=T[0],a=e.rateId,r=e.addons,n=_.filter(r,function(e){return e.is_rate_addon}),o=_.filter(r,function(e){return!e.is_rate_addon}),i=d.fetchAssociatedAddons(a),s=!1;if(d.setReservationFlag("RATE_CHANGED",!0),e.addons=_.map(i,function(e){return _.extend(e,{is_rate_addon:!0})}),_.each(o,function(t){!t.allow_rate_exclusion||t.allow_rate_exclusion&&_.indexOf(t.excluded_rate_ids,a)<0?e.addons.push(t):s=!0}),s||ne(r,n))return p.open({template:"/assets/partials/reservation/alerts/rateChangeAddonsAlert.html",scope:t,closeByDocument:!1,closeByEscape:!1}),!1}J()},ie=function(a,r,n,o,i){var s=tzIndependentDate(e.businessDate);_.each(T[n].stayDates,function(e,n){if(tzIndependentDate(n)>=s){e.rate.id=r;var c=a[n],d=c&&c.rate||a[E].rate,l=c&&c.rate_currency||a[E].rate_currency;d=Number(parseFloat(d).toFixed(2)),e.rateDetails={actual_amount:d,modified_amount:d,rate_currency:l},r&&(e.rateDetails.is_discount_allowed=null===t.reservationData.ratesMeta[r].is_discount_allowed_on?"false":t.reservationData.ratesMeta[r].is_discount_allowed_on.toString(),e.rateDetails.is_suppressed=null===t.reservationData.ratesMeta[r].is_suppress_rate_on?"false":t.reservationData.ratesMeta[r].is_suppress_rate_on.toString()),e.roomTypeId=o,e.contractId=i}})},se=function(){var e={title:v("translate")("STAY_CARD"),name:"rover.reservation.staycard.reservationcard.reservationdetails",param:{confirmationId:t.reservationData.confirmNum,id:t.reservationData.reservationId,isrefresh:!0,isGroupDetachmentRequested:r.isGroupDetachmentRequested}};t.borrowForGroups&&d.setReservationFlag("borrowForGroups",!0),t.saveReservation(e.name,e.param)},ce=function(e,a,r){var n=void 0!==r&&r>0;return a&&e>0&&!n||t.reservationData.group.id&&!n?"red":t.stateCheck.stayDatesMode?e>0||!n?"white brand-text":"white green-text":e>0||!n?"brand-colors":"green"},de=function(e){if(t.stateCheck.roomDetails=x(),t.stateCheck.pagination.roomType.page=1,t.stateCheck.pagination.rate.page=1,"RATE"===t.stateCheck.activeView||"RECOMMENDED"===t.stateCheck.activeView){t.stateCheck.rateFilterText="";var a=!1;"RATE"===t.stateCheck.activeView?a=!0:"RECOMMENDED"===t.stateCheck.activeView&&(O()?a=!0:e||k()),a?q(null,null,t.stateCheck.pagination.rate.page,function(e){t.stateCheck.baseInfo.maxAvblRates=e.total_count,Y(e.results),t.refreshScroll()}):"ROOM_TYPE"===t.stateCheck.activeView?V():Y([])}else"ROOM_TYPE"===t.stateCheck.activeView&&V();le()};t.refreshScroll=function(){i(function(){t.refreshScroller("room_types"),t.$parent&&t.$parent.myScroll.room_types&&t.$parent.myScroll.room_types.refresh()},700)};var le=function(){t.$parent&&t.$parent.myScroll.room_types&&t.$parent.myScroll.room_types.scrollTo(0,0)};t.restrictIfOverbook=function(e,a,r){var n=f.getPermissionValue("OVERBOOK_HOUSE"),o=f.getPermissionValue("OVERBOOK_ROOM_TYPE"),i=f.getPermissionValue("GROUP_HOUSE_BORROW"),s=parseInt(I[t.viewState.currentTab].roomCount);if("undefined"==typeof r)throw new Error("availability cannot be undefined here");return!!(t.reservationData.allotment.id&&(n=!0,r<s))||(t.reservationData.group.id?!(r>=s||r<s&&i):r<s&&!o||(!n||!o)&&(!n&&t.getLeastHouseAvailability()<T.length))},t.toggleClosedRates=function(){t.stateCheck.showClosedRates=!t.stateCheck.showClosedRates,t.stateCheck.pagination.roomType.page=1,t.stateCheck.pagination.rate.page=1,"RATE"===t.stateCheck.activeView||"RECOMMENDED"===t.stateCheck.activeView&&O()?(t.stateCheck.rateFilterText="",q(null,null,t.stateCheck.pagination.rate.page,function(e){t.stateCheck.baseInfo.maxAvblRates=e.total_count,Y(e.results),t.refreshScroll()})):"ROOM_TYPE"===t.stateCheck.activeView&&V()},t.toggleStayDaysMode=function(){t.stateCheck.stayDatesMode=!t.stateCheck.stayDatesMode,t.stateCheck.stayDatesMode||(t.reservationData.currentSelectedRateCurrencyId=""),t.stateCheck.stayDatesMode?(t.stateCheck.rateSelected.allDays=F().allDays,t.stateCheck.rateSelected.oneDay=F().oneDay):(t.stateCheck.preferredType="",t.stateCheck.dateModeActiveDate=E,t.reservationData.inHouse&&(t.stateCheck.preferredType=r.room_type_id),K()),t.refreshScroll(),i(function(){t.refreshScroller("stayDates")},150),de()},t.showStayDateDetails=function(e){if(e===R||e.shouldDisable)return!1;t.stateCheck.dateModeActiveDate=e,t.stateCheck.selectedStayDate=T[t.stateCheck.roomDetails.firstIndex].stayDates[e];var a=Object.keys(T[t.stateCheck.roomDetails.firstIndex].stayDates).indexOf(e);a>0&&t.stateCheck.stayDatesMode&&null!==t.reservationData.rateCurrencyId&&""!==t.reservationData.rateCurrencyId&&(t.reservationData.currentSelectedRateCurrencyId=t.reservationData.rateCurrencyId),de()},t.toggleEditGuestOptions=function(){t.stateCheck.guestOptionsIsEditable=!t.stateCheck.guestOptionsIsEditable},t.updateDayOccupancy=function(e){if(T[t.stateCheck.roomDetails.firstIndex].stayDates[t.stateCheck.dateModeActiveDate].guests[e]=parseInt(t.stateCheck.selectedStayDate.guests[e]),E===t.stateCheck.dateModeActiveDate)for(var a=T[t.stateCheck.roomDetails.firstIndex].stayDates[t.stateCheck.dateModeActiveDate].guests,r=t.stateCheck.roomDetails.firstIndex;r<=t.stateCheck.roomDetails.lastIndex;r++)T[r].numAdults=a.adults,T[r].numChildren=a.children,T[r].numInfants=a.infants;if(!t.checkOccupancyLimit(t.stateCheck.dateModeActiveDate)){t.preferredType="",t.stateCheck.rateSelected.oneDay=!1,t.stateCheck.rateSelected.allDays=!1;for(var r=t.stateCheck.roomDetails.firstIndex;r<=t.stateCheck.roomDetails.lastIndex;r++)_.each(T[r].stayDates,function(e){e.rate={id:""}})}V()},t.setActiveView=function(e){t.stateCheck.activeView=e,D.setRoomAndRateActiveTab(e),de(!0)};var ue=function(e,a){m.houseAvailability=t.stateCheck.house,m.isGroupReservation=!!t.reservationData.group.id||!!t.reservationData.allotment.id;var r=_.pluck(T[t.stateCheck.roomDetails.firstIndex].stayDates,"guests"),n={from_date:E,to_date:R,group_id:t.reservationData.group.id||t.reservationData.allotment.id,promotion_id:t.reservationData.promotionId,is_rate_for_dep_date_allowed:e.is_rate_for_dep_date_allowed||null,include_expired_promotions:!!t.reservationData.promotionId&&t.stateCheck.showClosedRates,adults:r[0]?r[0].adults:1,children:r[0]?r[0].children:""};if("RATE"===t.stateCheck.activeView||"RECOMMENDED"===t.stateCheck.activeView?(n.room_type_id=e.id,n.rate_id=e.forRate):"ROOM_TYPE"===t.stateCheck.activeView&&(n.rate_id=e.id,n.room_type_id=e.forRoomType),t.reservationData.code&&t.reservationData.code.id&&!_.reduce(t.stateCheck.promotionValidity,function(e,t){return e&&t})&&_.indexOf(t.reservationData.ratesMeta[n.rate_id].linked_promotion_ids,t.reservationData.code.id)>-1?m.promotionValidity=t.stateCheck.promotionValidity:m.promotionValidity=null,e.dates||(e.dates=angular.copy(l.getDatesModel(E,R))),t.stateCheck.stayDatesMode){var o=T[t.stateCheck.roomDetails.firstIndex].stayDates[t.stateCheck.dateModeActiveDate].guests;n.restrictions_on_date=t.stateCheck.dateModeActiveDate,n.adults=o.adults,n.children=o.children,t.stateCheck.rateSelected.oneDay&&(n.room_type_id=t.stateCheck.preferredType)}"RATE"===t.stateCheck.activeView&&delete n.group_id,t.invokeApi(m.getRateDetails,n,function(r){t.$emit("hideLoader"),angular.forEach(r.dates,function(t){t.rate_currency=e.rateCurrency}),e.dates=r.dates,e.total=r.total_room_cost,e.stayTaxExcl=r.excl_stay_tax,e.stayTaxIncl=r.incl_stay_tax,e.restrictions=r.summary,e.is_rate_for_dep_date_allowed=null,a&&a(),t.refreshScroll()},function(e){t.$emit("hideLoader"),t.errorMessage=e})};t.viewRateBreakUp=function(e,a){var r=function(){e.showDays=!e.showDays,t.refreshScroll()};return a?void ue(e):void(e.showDays||e.total?i(r,300):re(e.forRate||e.id,function(){ue(e,r)}))},t.handleNoEdit=function(e,a,r){t.reservationData.totalStayCost=0,e.stopPropagation(),T[t.stateCheck.roomDetails.firstIndex].rateName=t.reservationData.ratesMeta[r].name,t.reservationData.rateDetails[t.activeRoom]=angular.copy(T[t.stateCheck.roomDetails.firstIndex].stayDates),t.stateCheck.stayDatesMode||J()},t.handleDaysBooking=function(e){if(e.stopPropagation(),!t.stateCheck.rateSelected.allDays)return!1;var a,n,o=!!t.reservationData.group.id||!!t.reservationData.allotment.id,i=t.stateCheck.roomDetails.firstIndex;for(o&&(n=angular.copy(h.lastFetchedGroup)),a=t.stateCheck.roomDetails.firstIndex;a<=t.stateCheck.roomDetails.lastIndex;a++){l.isVaryingRates(T[i].stayDates,E,R,t.reservationData.numNights)?T[a].rateName="Multiple Rates Selected":T[a].rateName=t.reservationData.ratesMeta[T[i].stayDates[E].rate.id].name;var s=t.reservationData.ratesMeta[T[i].stayDates[E].rate.id];if(o){if(n.id===t.reservationData.group.id&&"CREATION"===t.viewState.identifier){var c=n.demographics;T[a].demographics.market=null===c.market_segment_id?"":c.market_segment_id,T[a].demographics.source=null===c.source_id?"":c.source_id,T[a].demographics.origin=null===c.booking_origin_id?"":c.booking_origin_id,T[a].demographics.reservationType=null===c.reservation_type_id?"":c.reservation_type_id,T[a].demographics.segment=null===c.segment_id?"":c.segment_id,0===a&&(t.reservationData.demographics=angular.copy(T[a].demographics))}}else T[a].demographics.market=null===s.market_segment_id?"":s.market_segment_id,T[a].demographics.source=null===s.source_id?"":s.source_id,T[a].demographics.origin=null===s.booking_origin_id?"":s.booking_origin_id,0===a&&(t.reservationData.demographics.source=T[a].demographics.source,t.reservationData.demographics.market=T[a].demographics.market,t.reservationData.demographics.origin=T[a].demographics.origin);t.reservationData.rateDetails[a]=angular.copy(T[t.stateCheck.roomDetails.firstIndex].stayDates),"rover.reservation.staycard.reservationcard.reservationdetails"!==r.fromState&&"STAY_CARD"!==r.fromState||_.each(T[a].stayDates,function(e,r){var n=T[a].stayDates[r].rate.id;T[a].roomTypeId;if(e.rate.id=n,n){var o=t.reservationData.ratesMeta[n];e.rate.name=o&&o.name;var i=Number(parseFloat(t.stateCheck.stayDates[r].amount).toFixed(2));e.rateDetails={actual_amount:i,modified_amount:i,rateCurrency:e.rateCurrency},e.rateDetails.is_discount_allowed=o&&null===o.is_discount_allowed_on?"false":o&&o.is_discount_allowed_on.toString(),e.rateDetails.is_suppressed=o&&null===o.is_suppress_rate_on?"false":o&&o.is_suppress_rate_on.toString()}})}oe()},t.handleBooking=function(e,a,r,n,o,i,s){t.reservationData.totalStayCost=0,r&&r.stopPropagation();var d,l,u;if("ROOM_TYPE"===t.stateCheck.activeView){var m=_.find(t.display.roomFirstGrid,{id:e});d=_.find(m.ratesArray,{id:a}),d.rateCurrency=s,l=m,u=d}else if("RATE"===t.stateCheck.activeView||"RECOMMENDED"===t.stateCheck.activeView){var f=_.find(t.display.rateFirstGrid,{id:a,contractId:i||""});d=_.find(f.rooms,{id:e}),d.rateCurrency=s,l=d,u=f}if("INCLUDE_DEP_DATE"===n?d.is_rate_for_dep_date_allowed=!0:d.is_rate_for_dep_date_allowed=null,t.reservationData.rateCurrency=s,t.reservationData.rateCurrencyId=u.rateCurrencyId,t.stateCheck.stayDatesMode&&t.reservationData.numNights>1&&(t.reservationData.currentSelectedRateCurrencyId=u.rateCurrencyId),t.checkOccupancyLimit(null,null,null,e),o){if(t.stateCheck.preferredType=parseInt(t.stateCheck.preferredType,10)||"",t.stateCheck.exhaustedAddons=[],n&&n.skipAddonCheck||(t.stateCheck.exhaustedAddons=te(e,a)),t.stateCheck.exhaustedAddons.length>0)return t.stateCheck.selectedRoomRate={roomId:e,rateId:a},ae(),!1;if(t.stateCheck.stayDatesMode){if(t.stateCheck.preferredType>0&&e!==t.stateCheck.preferredType)return!1;var v,D,g=t.stateCheck.dateModeActiveDate;if(!t.stateCheck.rateSelected.oneDay)for(t.stateCheck.preferredType=parseInt(e),I[t.activeRoom].roomTypeId=t.stateCheck.preferredType,v=t.stateCheck.roomDetails.firstIndex;v<=t.stateCheck.roomDetails.lastIndex;v++)D=T[v],D.roomTypeId=e,D.rateId=[],D.rateId.push(a),D.stayDates[t.stateCheck.dateModeActiveDate].rate.id=a,D.stayDates[t.stateCheck.dateModeActiveDate].contractId=i,D.roomTypeName=t.reservationData.roomsMeta[e].name,t.reservationData.rateDetails[S]=angular.copy(T[t.stateCheck.roomDetails.firstIndex].stayDates);t.stateCheck.selectedStayDate.rate.id=a,t.stateCheck.selectedStayDate.roomType={id:e},t.stateCheck.selectedStayDate.contractId=i;var C=d.dates[g].rate,A=Number(parseFloat(C).toFixed(2));for(t.stateCheck.stayDates[t.stateCheck.dateModeActiveDate].amount=A,t.stateCheck.stayDates[t.stateCheck.dateModeActiveDate].rateCurrency=u.rateCurrency,v=t.stateCheck.roomDetails.firstIndex;v<=t.stateCheck.roomDetails.lastIndex;v++)D=T[v],D.stayDates[g].rateCurrency=u.rateCurrency,D.stayDates[g].contractId=u.contractId,D.stayDates[g].rateDetails={actual_amount:A,modified_amount:A,rate_currency:u.rateCurrency,is_discount_allowed:null===t.reservationData.ratesMeta[a].is_discount_allowed_on?"false":t.reservationData.ratesMeta[a].is_discount_allowed_on.toString(),is_suppressed:null===t.reservationData.ratesMeta[a].is_suppress_rate_on?"false":t.reservationData.ratesMeta[a].is_suppress_rate_on.toString()},D.stayDates[g].rate.id=a,D.rateId||(D.rateId=[]),D.rateId.push(a);t.stateCheck.rateSelected.allDays=F().allDays,t.stateCheck.rateSelected.oneDay=F().oneDay}else{var S,b,N,P=!!t.reservationData.group.id||!!t.reservationData.allotment.id;for(t.reservationData.group.id?b=angular.copy(h.lastFetchedGroup):t.reservationData.allotment.id&&(N=angular.copy(y.lastFetchedAllotment)),I[t.activeRoom].roomTypeId&&parseInt(I[t.activeRoom].roomTypeId)===parseInt(e)||(I[t.activeRoom].roomTypeId=parseInt(e)),S=t.stateCheck.roomDetails.firstIndex;S<=t.stateCheck.roomDetails.lastIndex;S++)if(_.extend(T[S],{roomTypeId:parseInt(e),roomTypeName:l.name,rateId:a,isSuppressed:u.isSuppressed,rateName:u.name,rateAvg:u.adr,rateTotal:u.totalAmount}),ie(d.dates,a,S,e,u.contractId),t.reservationData.rateDetails[S]=angular.copy(T[t.stateCheck.roomDetails.firstIndex].stayDates),P){var k;t.reservationData.group.id&&b.id===t.reservationData.group.id&&"CREATION"===t.viewState.identifier?k=b.demographics:t.reservationData.allotment.id&&N.id===t.reservationData.allotment.id&&"CREATION"===t.viewState.identifier&&(k=N.demographics),k&&(T[S].demographics.market=null===k.market_segment_id?"":k.market_segment_id,T[S].demographics.source=null===k.source_id?"":k.source_id,T[S].demographics.origin=null===k.booking_origin_id?"":k.booking_origin_id,T[S].demographics.reservationType=null===k.reservation_type_id?"":k.reservation_type_id,T[S].demographics.segment=null===k.segment_id?"":k.segment_id,0===S&&(t.reservationData.demographics=angular.copy(T[S].demographics)))}else T[S].demographics.market=null===t.reservationData.ratesMeta[a].market_segment_id?"":t.reservationData.ratesMeta[a].market_segment_id,T[S].demographics.source=null===t.reservationData.ratesMeta[a].source_id?"":t.reservationData.ratesMeta[a].source_id,T[S].demographics.origin=null===t.reservationData.ratesMeta[a].booking_origin_id?"":t.reservationData.ratesMeta[a].booking_origin_id,0===S&&(t.reservationData.demographics.source=T[S].demographics.source,t.reservationData.demographics.market=T[S].demographics.market,t.reservationData.demographics.origin=T[S].demographics.origin);if(t.otherData.showOverbookingAlert&&!P){var O=t.getLeastHouseAvailability(),w=t.getLeastAvailability(e,a),M=I[t.activeRoom].roomCount;O<1||w<M?t.invokeApi(c.checkOverbooking,{from_date:E,to_date:R,group_id:t.reservationData.group.id||t.reservationData.allotment.id},function(a){t.availabilityData=a,p.open({template:"/assets/partials/reservation/alerts/availabilityCheckOverbookingAlert.html",scope:t,controller:"overbookingAlertCtrl",closeByDocument:!1,closeByEscape:!1,data:JSON.stringify({houseFull:O<1,roomTypeId:e,isRoomAvailable:w>0,activeView:function(){return O<1?"HOUSE":"ROOM"}(),isGroupRate:!!t.reservationData.group.id})})}):oe()}else oe()}}else re(a,function(){ue(d,function(){t.handleBooking(e,a,r,n,!0,i,s)})})},t.isBookingRestricted=function(e){return e&&e.length>0&&!f.getPermissionValue("BOOK_RESTRICTED_ROOM_RATE")},t.selectAddon=function(){ae(!0)},t.onResetAddonsAcknowledged=function(){J(),t.closeDialog()},t.alertOverbooking=function(e){var a=0;e&&(t.closeDialog(),a=1e3),i(oe,a)},t.getLeastAvailability=function(e,a){var r,n=0;if("ROOM_TYPE"===t.stateCheck.activeView){var o=_.find(t.display.roomFirstGrid,{id:e});r=_.find(o.ratesArray,{id:a}),n=o&&o.availability||0}else if("RATE"===t.stateCheck.activeView||"RECOMMENDED"===t.stateCheck.activeView){var i=_.find(t.display.rateFirstGrid,{id:a});r=_.find(i.rooms,{id:e}),n=r&&r.availability||0}return n},t.getLeastHouseAvailability=function(){var e=t.reservationData.numNights||1;return _.min(_.first(_.toArray(t.stateCheck.house),e))},t.showAllRooms=function(){t.stateCheck.showLessRooms=!1,t.refreshScroll(),t.stateCheck.pagination.roomType.page=1,V()},t.isRoomTypeSelected=function(e){var a=!1;return _.each(I,function(r,n){parseInt(r.roomTypeId,10)===e&&t.activeRoom!=n&&(a=!0)}),a};var me=function(){p.open({template:"/assets/partials/reservation/alerts/reseravtionFromDiaryValidation.html",scope:t,className:"",closeByDocument:!1,closeByEscape:!1})},fe=function(){I[0].room_id=r.selectedRoomId,T[0].room_id=r.selectedRoomId,I[0].roomTypeId=r.room_type_id,T[0].roomTypeId=r.room_type_id,I[0].roomName=r.selectedRoomNo,T[0].roomName=r.selectedRoomNo},pe=function(){I[0].room_id=null,T[0].room_id=null,I[0].roomName=null,T[0].roomName=null,I[0].roomTypeId=null,T[0].roomTypeId=null};t.stateCheck.isFromNightlyDiary&&fe(),t.onRoomTypeChange=function(e){var a,r=t.viewState.currentTab,n=parseInt(t.stateCheck.preferredType,10)||"",o=n!==t.stateCheck.roomTypeIdFromNightlyDiary,i=null===I[0].room_id;for(t.stateCheck.isFromNightlyDiary&&o&&!N&&!i&&(t.validationMsg="Room number will be unassigned by changing the room type",N=!0,pe(),me()),I[r].roomTypeId=n,a=t.stateCheck.roomDetails.firstIndex;a<=t.stateCheck.roomDetails.lastIndex;a++)T[a].roomTypeId=n;t.stateCheck.pagination.roomType.page=1,V(),K()};var ve=function(e,a){var r=t.reservationData.code&&t.reservationData.code.id&&!_.reduce(t.stateCheck.promotionValidity,function(e,t){return e&&t});return{isPromoInvalid:r}},_e=0;t.showRoomsList=function(e,a){if(e.isCollapsed||a){var r;e.hasRoomsList&&a?r=t.stateCheck.stayDatesMode?_e+1:e.rooms.length/t.stateCheck.pagination.rate.roomsList.perPage+1:(e.rooms=[],r=1),_e=r,B(function(r){e.totalRoomsCount=r.total_count,e.hasRoomsList=!0,_.each(r.results,function(r){_.each(r.restrictions,function(e){var t=e.restriction_type_id;e.restrictionBgClass="bg-"+getRestrictionClass(o.restrictions[t].key),e.restrictionIcon=getRestrictionIcon(o.restrictions[t].key)});var n=ve(r.multiple_restrictions,e.id),s={id:r.id,name:t.reservationData.roomsMeta[r.id].name,availability:r.availability,showDays:!1,adr:r.adr,rateCurrency:r.rate_currency,forRate:e.id,numRestrictions:n.restrictionCount||0,restriction:r.restrictions,buttonClass:ce(n.restrictionCount||0,e.id,r.availability),isSuiteUnavailable:t.reservationData.roomsMeta[r.id].is_suite&&(r.availability<=0||r.availability<t.reservationData.rooms.length)};e.rooms.push(s),i(function(){a||(e.isCollapsed=!1),t.refreshScroll()},100)})},e.id,r)}else e.isCollapsed=!0},t.showRatesList=function(e,a){if(!t.borrowForGroups){var r=function(){e.isCollapsed=!e.isCollapsed,t.refreshScroll()},n=e.ratesArray[0].id;if(!e.totalRatesCount||a){var s=1;a&&(s=e.ratesArray.length/t.stateCheck.pagination.roomType.ratesList.perPage+1),q(e.id,null,s,function(r){var i=l.getDatesModel(E,R);G(),e.totalRatesCount=r.total_count,a||(e.ratesArray=[]),_.each(r.results,function(a){t.reservationData.ratesMeta[a.id]||U(),_.each(a.restrictions,function(e){var t=e.restriction_type_id;e.restrictionBgClass="bg-"+getRestrictionClass(o.restrictions[t].key),e.restrictionIcon=getRestrictionIcon(o.restrictions[t].key)}),proccesedRestrictions=ve(a.multiple_restrictions,a.id);var r=!("RECOMMENDED"!=t.stateCheck.activeView||!t.reservationData.group.id)&&!!t.reservationData.group.id,s=!("RECOMMENDED"!=t.stateCheck.activeView||!t.reservationData.allotment.id)&&!!t.reservationData.allotment.id,c=!("RECOMMENDED"!=t.stateCheck.activeView||!a.contract_name)&&!!a.contract_name,d=!("RECOMMENDED"!=t.stateCheck.activeView||!t.reservationData.member.isSelected||!t.reservationData.ratesMeta[a.id].is_member)&&(!!t.reservationData.member.isSelected&&t.reservationData.ratesMeta[a.id].is_member),l="RECOMMENDED"==t.stateCheck.activeView&&!proccesedRestrictions.isPromoInvalid&&_.indexOf(t.reservationData.ratesMeta[a.id].linked_promotion_ids,t.reservationData.code.id)>-1&&(!proccesedRestrictions.isPromoInvalid&&_.indexOf(t.reservationData.ratesMeta[a.id].linked_promotion_ids,t.reservationData.code.id)>-1),u="undefined"!=typeof a.restrictions?a.restrictions.length:0,m={id:a.id,name:t.reservationData.ratesMeta[a.id].name,adr:a.adr,rateCurrency:a.rate_currency,rateCurrencyId:a.rate_currency_id,dates:angular.copy(i),totalAmount:0,restriction:a.restrictions,numRestrictions:u,forRoomType:a.room_type_id,buttonClass:ce(proccesedRestrictions.restrictionCount||0,a.id,e.availability),showDays:!1,isGroupRate:r,isAllotmentRate:s,isCorporate:c,isSuppressed:t.reservationData.ratesMeta[a.id].is_suppress_rate_on,isMember:d,isPromotion:l,isSuiteUnavailable:e.isSuiteUnavailable,isDayUse:t.reservationData.ratesMeta[a.id].is_day_use};n===a.id&&(m.bestAvailableRateRestrictions=a.restrictions),_.extend(m.dates[t.reservationData.arrivalDate],{availability:a.availability}),e.ratesArray.push(m)})}),e.defaultRate=e.ratesArray[0],a||i(r,300),t.refreshScroll()}else r()}},t.rateAutoCompleteOptions={delay:500,minLength:0,position:{my:"left top",at:"left bottom",of:"input#find-rates",collision:"fit"},source:function(e,a){var r={query:e.term};t.callAPI(c.searchForRates,{params:r,successCallBack:function(e){var t=[];_.each(e.results,function(e){t.push({label:e.name,value:e.name,id:e.id})}),a(t)}})},select:function(e,a){t.stateCheck.pagination.rate.page=1,q(null,a.item.id,1,function(e){Y(e.results),t.refreshScroll()})}},t.changeSelectedRoom=function(e){e.selectedRoom=_.find(e.rooms,{id:parseInt(e.selectedRoomId,10)}),e.showDays&&t.viewRateBreakUp(e,!0)},t.selectRate=function(e){t.stateCheck.rateFilterText=e.name,t.stateCheck.pagination.rate.page=1,q(null,e.id,1,function(e){Y(e.results),t.refreshScroll()})},t.hideResults=function(){i(function(){t.isRateFilterActive=!1},300)},t.filterRates=function(){if(t.rateFiltered=!1,t.stateCheck.rateFilterText.length>0){var e=new RegExp(t.stateCheck.rateFilterText,"gi");t.filteredRates=$(t.reservationData.ratesMeta).filter(function(){return this.name.match(e)}),t.filteredRates.length&&(t.isRateFilterActive=!0)}else t.filteredRates=[],q(null,null,1,function(e){Y(e.results),t.refreshScroll()});t.refreshScroll()},t.toggleCalendar=function(){t.stateCheck.activeMode="ROOM_RATE"===t.stateCheck.activeMode?"CALENDAR":"ROOM_RATE",t.heading="ROOM_RATE"===t.stateCheck.activeMode?"Rooms & Rates":" Rate Calendar",t.setHeadingTitle(t.heading),$("#rooms-and-rates-header .switch-button").toggleClass("on")},t.toggleSearchWithRestrictions=function(){t.stateCheck.calendarState.searchWithRestrictions=!t.stateCheck.calendarState.searchWithRestrictions,t.$broadcast("availableRateFiltersUpdated")},t.toggleShowOnlyAvailable=function(){t.stateCheck.calendarState.showOnlyAvailableRooms=!t.stateCheck.calendarState.showOnlyAvailableRooms,t.$broadcast("availableRateFiltersUpdated")},t.changeActiveRoomType=function(e){return!t.stateCheck.stayDatesMode&&(t.activeRoom=e,t.stateCheck.preferredType=I[t.activeRoom].roomTypeId,t.viewState.currentTab=e,void de())},t.getTabTitle=function(e){if(e>=I.length)return"INVALID TAB";var t=L(e);return t.firstIndex===t.lastIndex?"ROOM "+(t.firstIndex+1):"ROOMS "+(t.firstIndex+1)+"-"+(t.lastIndex+1)},t.setSameCardNgo=function(){t.reservationData.isSameCard=!0,s.go("rover.reservation.search")};var De=function(){t.$on("SIDE_BAR_OCCUPANCY_UPDATE",function(){de()}),t.$on("TABS_MODIFIED",function(){de()}),t.$on("resetGuestTab",function(){t.invokeApi(c.fetchUserMemberships,t.reservationDetails.guestCard.id||t.reservationData.guest.id,function(e){t.$emit("hideLoader"),t.reservationData.guestMemberships={ffp:e.frequentFlyerProgram,hlp:e.hotelLoyaltyProgram},t.reservationData.member.isSelected&&w()?de():t.reservationData.member.isSelected&&p.open({template:"/assets/partials/reservation/alerts/rvNotMemberPopup.html",className:"",scope:t,closeByDocument:!1,closeByEscape:!1})})}),t.$on("cardChanged",function(e,a){t.reservationData.company.id=a.companyCard,t.reservationData.travelAgent.id=a.travelAgent,s.params.company_id=a.companyCard,s.params.travel_agent_id=a.travelAgent,de()}),t.$on("switchToStayDatesCalendar",function(){t.stateCheck.activeMode="ROOM_RATE"===t.stateCheck.activeMode?"CALENDAR":"ROOM_RATE",$("#rooms-and-rates-header .switch-button").toggleClass("on")})};t.errorMessage="",t.$on("FAILURE_UPDATE_RESERVATION",function(e,a){t.errorMessage=a});var he=[{key:"CLOSED",name:"CLOSED"},{key:"CLOSED_ARRIVAL",name:"CLOSED TO ARRIVAL"},{key:"CLOSED_DEPARTURE",name:"CLOSED TO DEPARTURE"},{key:"MIN_STAY_LENGTH",name:"MIN LENGTH OF STAY"},{key:"MAX_STAY_LENGTH",name:"MAX LENGTH OF STAY"},{key:"MIN_STAY_THROUGH",name:"MIN STAY THROUGH"},{key:"MIN_ADV_BOOKING",name:"MIN ADVANCED BOOKING"},{key:"MAX_ADV_BOOKING",name:"MAX ADVANCED BOOKING"}];_.each(he,function(e){var t=e.key.toUpperCase(),a=getRestrictionClass(t);e.restrictionBgClass=""!==a?"bg-"+a:a,e.restrictionIcon=getRestrictionIcon(t)}),t.legendRestrictionsArray=he,t.houseRestrictionArray=[],C&&_.mapObject(C,function(e,a){var r=a.toUpperCase(),n={},o=getRestrictionClass(r);("boolean"==typeof e&&e||"number"==typeof e)&&(n.value="boolean"==typeof e?"":e,n.restrictionBgClass=""!==o?"bg-"+o:o,n.restrictionIcon=getRestrictionIcon(r),t.houseRestrictionArray.push(n))}),Z(),t.$on("FAILURE_UPDATE_RESERVATION",function(e,a){t.errorMessage=a}),t.clearErrorMessage=function(){t.errorMessage=[]},t.addListener("UPDATE_RATE_POST_GROUP_DETACH",function(){se()})}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){sntRover.controller("RVCancelReservationDepositController",["$rootScope","$scope","ngDialog","$stateParams","$state","RVReservationCardSrv","RVPaymentSrv","$timeout","RVNightlyDiarySrv",function(e,t,a,r,n,o,i,s,c){BaseCtrl.call(this,t),t.errorMessage="",t.cancellationData={reason:"",locale:t.languageData.selected_language_code},t.DailogeState.isCancelled=!1,t.completeCancellationProcess=function(){t.DailogeState.isCancelled&&("rover.reservation.staycard.reservationcard.reservationdetails"===n.current.name?(r.isrefresh=!0,n.reload(n.current.name)):n.go("rover.reservation.staycard.reservationcard.reservationdetails",{id:t.reservationData.reservationId||t.reservationData.reservation_card.reservation_id,confirmationId:t.reservationData.confirmNum||t.reservationData.reservation_card.confirmation_num,isrefresh:!0})),t.closeDialog()};var d=function(e){var a=function(e){t.DailogeState.isCancelled=!0;
var a=c.getCache();"undefined"!=typeof a&&(a.currentSelectedReservationId="",a.currentSelectedRoomId="",a.currentSelectedReservation=""),c.updateCache(a),t.$emit("hideLoader")},r={reason:t.cancellationData.reason,id:t.reservationData.reservation_card.reservation_id||t.reservationData.reservationId,application:"ROVER"};r.with_deposit_refund=e,t.invokeApi(o.cancelReservation,r,a)};t.proceedWithDepositRefund=function(){var e=!0;d(e)},t.proceedWithOutDepositRefund=function(){var e=!1;d(e)},t.closeDialog=function(){a.close()}}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){sntRover.controller("RVEditRatesCtrl",["$scope","$rootScope","$stateParams","$timeout","ngDialog","RVReservationCardSrv","rvPermissionSrv",function(e,t,a,r,n,o,i){BaseCtrl.call(this,e);var s=dclone(e.ngDialogData.room.stayDates);e.refreshRateDetails=function(){r(function(){e.refreshScroller("rateDetails")},2e3)};var c=function(){return 0===e.ngDialogData.index?e.reservationData.reservationId||e.reservationParentData.reservationId:e.reservationData.reservationIds[e.ngDialogData.index]},d=function(){return e.reservationData.confirmNum||e.reservationParentData.confirmNum};e.saveCommentAgainstRateChange=function(t){var a={},r=function(){t()};a.reservation_id=c(),a.text=e.adjustment_reason,a.is_from_rate_adjustment=!0,a.note_topic=1;var n={params:a,onSuccess:r};e.callAPI(o.saveReservationNote,n)},e.save=function(t,r){if(e.errorMessage="",!e.otherData.forceAdjustmentReason||e.otherData.forceAdjustmentReason&&e.adjustment_reason&&e.adjustment_reason.trim()){var n=!1;_.each(t.stayDates,function(e,t){s[t]&&s[t].rateDetails&&(s[t]&&s[t].rateDetails.modified_amount!==e.rateDetails.modified_amount&&(n=!0),e.rateDetails.modified_amount=parseFloat(e.rateDetails.modified_amount).toFixed(2),isNaN(e.rateDetails.modified_amount)&&(e.rateDetails.modified_amount=parseFloat(e.rateDetails.actual_amount).toFixed(2)))}),e.reservationData.rooms[r]=t,e.reservationData.has_reason=!!e.adjustment_reason.trim();var o=function(){a.id?e.saveReservation("rover.reservation.staycard.reservationcard.reservationdetails",{id:c(),confirmationId:d(),isrefresh:!1}):e.saveReservation("","",r),e.closeDialog()};n?""===e.adjustment_reason.trim()?o():e.saveCommentAgainstRateChange(o):e.closeDialog()}else e.errorMessage=["Please enter Adjustment Reason"]},e.shouldDisableRateChange=function(a,r){var n=e.reservationData,o=n.group_id||n.reservation_card.group_id,s=new tzIndependentDate(t.businessDate)>new tzIndependentDate(r);return o&&(s=new tzIndependentDate(t.businessDate)>=new tzIndependentDate(r)),!i.getPermissionValue("UPDATE_AND_OVERWRITE_RATE_AMOUNT")||"false"==a.rateDetails.is_discount_allowed||s},e.shouldSupressRateInput=function(e){return!i.getPermissionValue("UPDATE_AND_OVERWRITE_RATE_AMOUNT")&&"true"==e.rateDetails.is_suppressed};(function(){e.adjustment_reason=e.ngDialogData.lastReason,e.setScroller("rateDetails"),e.refreshRateDetails()})()}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){sntRover.controller("overbookingAlertCtrl",["$scope",function(e){BaseCtrl.call(this,e);var t={left:[],right:[]},a=e.ngDialogData.arrivalDate||e.reservationData.arrivalDate,r=e.ngDialogData.departureDate||e.reservationData.departureDate,n=tzIndependentDate(a),o=function(){e.stateVariables.eventSources.left.length=0,e.stateVariables.eventSources.right.length=0,t={left:[],right:[]},_.each(e.availabilityData,function(n){var o;"HOUSE"===e.ngDialogData.activeView?o=n.house.availability:(o=n.room_types[e.ngDialogData.roomTypeId],e.ngDialogData.isGroupRate&&(o=n.group_room_types[e.ngDialogData.roomTypeId]));var i={day:function(){return n.date>=a||n.date<=r?new tzIndependentDate(n.date).getDate().toString():""}(),className:function(){var e="";return n.date===a?e+="check-in ":n.date===r&&(e+="check-out "),o<=0?e+="unavailable ":n.date!==r&&(e+="available "),e}(),start:new tzIndependentDate(n.date),end:new tzIndependentDate(n.date),editable:!1,title:function(){return o<=0?o.toString():""}()};e.leftCalendarOptions.month===new tzIndependentDate(n.date).getMonth()?t.left.push(i):e.rightCalendarOptions.month===new tzIndependentDate(n.date).getMonth()&&t.right.push(i)}),e.stateVariables.eventSources.left.push(t.left),e.stateVariables.eventSources.right.push(t.right)},i=function(){var t,a=(t={height:300,editable:!0,droppable:!1,header:{left:"",center:"title",right:""},year:n.getFullYear(),month:n.getMonth(),day:n.getDate()},_defineProperty(t,"editable",!0),_defineProperty(t,"disableResizing",!1),_defineProperty(t,"contentHeight",240),_defineProperty(t,"weekMode","fixed"),_defineProperty(t,"ignoreTimezone",!1),t);e.leftCalendarOptions=dclone(a),e.rightCalendarOptions=dclone(a),e.rightCalendarOptions.month=e.leftCalendarOptions.month+1,o(),e.$emit("hideLoader")};e.stateVariables={eventSources:{left:[],right:[]}},e.toggleCalendarView=function(){e.ngDialogData.activeView="HOUSE"===e.ngDialogData.activeView?"ROOM":"HOUSE",o()},e.viewRoomRatesCalendar=function(){e.toggleCalendar(),e.closeDialog()},i()}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){sntRover.controller("RVReservationAddonsCtrl",["$scope","$rootScope","addonData","$state","ngDialog","RVReservationAddonsSrv","$filter","$timeout","RVReservationSummarySrv","$stateParams","$vault","RVReservationPackageSrv","RVReservationStateService","rvGroupConfigurationSrv","rvPermissionSrv",function(e,t,a,r,n,o,i,s,c,d,l,u,m,f,p){var v="rover.reservation.staycard.mainCard.room-rates",D=function(){"staycard"===d.from_screen?(e.fromPage="staycard",t.setPrevState={title:i("translate")("STAY_CARD"),callback:"goBackToStayCard",scope:e},e.goBackToStayCard=function(){e.addonsData.existingAddons=[];var t=e.reservationData.reservationId,a=e.reservationData.confirmNum;r.go("rover.reservation.staycard.reservationcard.reservationdetails",{id:t,confirmationId:a,isrefresh:!0})}):"HOURLY"===d.reservation?t.setPrevState={title:i("translate")("DIARY"),name:"rover.diary",param:{}}:(e.reservationData.number_of_adults=parseInt(e.reservationData.rooms[0].numAdults,10),e.reservationData.number_of_children=parseInt(e.reservationData.rooms[0].numChildren,10),t.setPrevState={title:i("translate")("ROOM_RATES"),name:v,param:{from_date:e.reservationData.arrivalDate,to_date:e.reservationData.departureDate,view:"ROOM_RATE",company_id:e.reservationData.company.id,travel_agent_id:e.reservationData.travelAgent.id,fromState:"rover.reservation.staycard.mainCard.addons",group_id:e.reservationData.group.id,room_type_id:e.reservationData.tabs[e.viewState.currentTab].roomTypeId,adults:e.reservationData.tabs[e.viewState.currentTab].numAdults,children:e.reservationData.tabs[e.viewState.currentTab].numChildren,promotion_id:e.reservationData.promotionId,allotment_id:e.reservationData.allotment.id}})},h=function(){e.reservationData.isHourly=!0;var t=l.get("temporaryReservationDataFromDiaryScreen");if(t=JSON.parse(t)){var a=function(a){var r={};angular.forEach(a.rooms,function(e){var t=e.id;r[t]=e}),e.populateDatafromDiary(r,t),e.roomDetails=C(),A("",!0)};e.invokeApi(c.fetchRooms,{},a)}e.duration_of_stay=1,e.is_rate_addons_fetch=!1,e.addonsData.existingAddons=[]},y=function(){$(e.reservationData.rooms).each(function(a,r){$(r.addons).each(function(a,r){var n=_.find(e.packageData.existing_packages,{id:r.id});n&&(r.selected_post_days=n.selected_post_days,r.start_date=i("date")(tzIndependentDate(n.start_date),t.dateFormatForAPI),r.end_date=i("date")(tzIndependentDate(n.end_date),t.dateFormatForAPI))})})},g=function(){if(void 0===e.packageData&&(e.packageData={existing_packages:[]}),"staycard"===e.fromPage){var a={reservationId:e.reservationData.reservationId,room_types:[{id:e.reservationData.rooms[0].roomTypeId,num_rooms:1,addons:_.filter(e.packageData.existing_packages,function(e){return e.start_date=i("date")(tzIndependentDate(e.start_date),t.dateFormatForAPI),e.end_date=i("date")(tzIndependentDate(e.end_date),t.dateFormatForAPI),!e.is_rate_addon})}]},n=function(){e.$emit("hideLoader"),r.go("rover.reservation.staycard.reservationcard.reservationdetails",{id:e.reservationData.reservationId,confirmationId:e.reservationData.confirmNum,isrefresh:!0})},o=function(t){e.$emit("hideLoader"),e.errorMessage=t};e.invokeApi(c.updateReservation,a,n,o)}else{y();var l=function(){(e.reservationData.guest.id||e.reservationData.company.id||e.reservationData.travelAgent.id||e.reservationData.group.id||e.reservationData.allotment.id)&&r.go("rover.reservation.staycard.mainCard.summaryAndConfirm",{reservation:d.reservation})};e.reservationData.guest.id||e.reservationData.company.id||e.reservationData.travelAgent.id||e.reservationData.group.id?r.go("rover.reservation.staycard.mainCard.summaryAndConfirm",{reservation:d.reservation}):(s(function(){e.$emit("PROMPTCARD")},500),e.$watch("reservationData.guest.id",l),e.$watch("reservationData.company.id",l),e.$watch("reservationData.travelAgent.id",l))}},C=function(){var t=parseInt(e.reservationData.tabs[e.activeRoom].roomTypeId,10),a=_.indexOf(e.reservationData.rooms,_.findWhere(e.reservationData.rooms,{roomTypeId:t})),r=_.lastIndexOf(e.reservationData.rooms,_.last(_.where(e.reservationData.rooms,{roomTypeId:t})));return{roomTypeId:t,firstIndex:a,lastIndex:r}},A=function(t,a){var r=function(t){var r,n=[],o=e.roomDetails.firstIndex,i=e.roomDetails.lastIndex;for("HOURLY"===d.reservation&&(o=0,i=e.reservationData.rooms.length-1),e.$emit("hideLoader"),_.each(t.rate_addons,function(e){e.is_inclusive&&n.push(e)}),r=o;r<=i;r++)e.reservationData.rooms[r].inclusiveAddons=n;e.addons=[];var s=parseInt(e.reservationData.rooms[e.roomDetails.firstIndex].rateId,10);if(_.each(t.results,function(t){t&&(!t.allow_rate_exclusion||t.allow_rate_exclusion&&_.indexOf(t.excluded_rate_ids,s)<0)&&e.addons.push(u.parseAddonItem(t))}),e.refreshAddonsScroller(),a&&(m.getReservationFlag("RATE_CHANGED")||!e.reservationData.reservationId)){if(m.setReservationFlag("RATE_CHANGED",!1),!e.is_rate_addons_fetch){for(e.addonsData.existingAddons=[],r=o;r<=i;r++)e.reservationData.rooms[r].addons=[];_.each(t.rate_addons,function(t){t.is_rate_addon=!0;var a,r="CHILD"===t.amount_type.value&&0===parseInt(e.reservationData.tabs[e.activeRoom].numChildren)||"ADULT"===t.amount_type.value&&0===parseInt(e.reservationData.tabs[e.activeRoom].numAdults);if(!r)for(e.addonsData.existingAddons.push(u.parseRateAddonItem(t)),a=o;a<=i;a++)e.reservationData.rooms[a].addons.push(u.parseAddonItem(t,!0))})}e.is_rate_addons_fetch=!0}e.existingAddonsLength=e.addonsData.existingAddons.length};e.invokeApi(o.fetchAddons,{charge_group_id:void 0===t?"":t,is_bestseller:!t,from_date:e.reservationData.arrivalDate,to_date:e.reservationData.departureDate,is_active:!0,is_not_rate_only:!0,rate_id:e.reservationData.rooms[e.roomDetails.firstIndex].rateId,reservation_id:void 0===e.reservationData.reservationId?"":e.reservationData.reservationId,no_pagination:!0,adults:e.reservationData.tabs[e.viewState.currentTab].numAdults,children:e.reservationData.tabs[e.viewState.currentTab].numChildren},r)},S=function(t,a){var r,n=_.find(e.addonsData.existingAddons,{id:t.id}),o=e.roomDetails.firstIndex,i=e.roomDetails.lastIndex;if("HOURLY"===d.reservation&&(o=0,i=e.reservationData.rooms.length-1),a=parseInt(a,10)||1,n){n.quantity=parseInt(n.quantity,10)+a,n.totalAmount=n.quantity*n.price_per_piece;var s=-1;for($(e.reservationData.rooms[o].addons).each(function(e,a){a.id===t.id&&(s=e)}),r=o;r<=i;r++)e.reservationData.rooms[r].addons[s].quantity+=a}else for(e.addonsData.existingAddons.push({id:t.id,quantity:a,title:t.title,totalAmount:a*t.price,price_per_piece:t.price,amount_type:t.amountType,post_type:t.postType,charge_full_weeks_only:t.chargefullweeksonly,posting_frequency:t.postType.frequency,rate_currency:t.rateCurrency,start_date:tzIndependentDate(e.reservationData.arrivalDate),end_date:tzIndependentDate(e.reservationData.departureDate),is_allowance:t.is_allowance,is_consume_next_day:t.is_consume_next_day,is_inclusive:t.is_inclusive,is_rate_addon:t.is_rate_addon,post_day_of_the_week:t.post_day_of_the_week,post_day_of_the_month:t.post_day_of_the_month,frequency_type:t.frequency_type,frequency:t.frequency,custom_nightly_selected_post_days:t.custom_nightly_selected_post_days}),e.existingAddonsLength=e.addonsData.existingAddons.length,r=o;r<=i;r++)e.reservationData.rooms[r].addons||(e.reservationData.rooms[r].addons=[]),e.reservationData.rooms[r].addons.push({id:t.id,title:t.title,quantity:a,price:t.price,amountType:t.amountType,postType:t.postType,taxDetail:t.taxes,chargefullweeksonly:t.chargefullweeksonly,is_rate_addon:t.is_rate_addon});e.showEnhancementsPopup()},I=function(t,a){var r=function(){k(!0)},n=function(t){e.$emit("hideLoader"),e.errorMessage=t};e.invokeApi(u.applyAddon,{id:void 0===e.reservationData.reservationId?"":e.reservationData.reservationId,addon_id:t.id,quantity:a,application:"ROVER"},r,n)},T=[];e.showEnhancementsPopup=function(){var t=e.addonsData.existingAddons;e.addonPopUpData={addonPostingMode:"reservation",cancelLabel:"Cancel",saveLabel:"staycard"===e.fromPage?"Save":"Book",shouldShowAddMoreButton:!1,number_of_adults:e.reservationData.number_of_adults,number_of_children:e.reservationData.number_of_children,duration_of_stay:e.duration_of_stay},e.packageData={existing_packages:[]},angular.forEach(e.addonsData.existingAddons,function(t){var a={id:t.id,name:t.title,addon_count:t.quantity,totalAmount:t.totalAmount,amount:t.price_per_piece,amount_type:t.amount_type,post_type:t.post_type,is_inclusive:t.is_inclusive,is_rate_addon:t.is_rate_addon,start_date:t.start_date,end_date:t.end_date,addon_currency:t.rate_currency,charge_full_weeks_only:t.charge_full_weeks_only,post_instances:t.post_instances,quantity:t.quantity,is_allowance:t.is_allowance,is_consume_next_day:t.is_consume_next_day,post_day_of_the_week:t.post_day_of_the_week,post_day_of_the_month:t.post_day_of_the_month,frequency_type:t.frequency_type,frequency:t.frequency,custom_nightly_selected_post_days:t.custom_nightly_selected_post_days};e.packageData.existing_packages.push(a)}),t.length>0&&n.open({template:"/assets/partials/packages/showPackages.html",controller:"RVReservationPackageController",scope:e})},e.closePopup=function(){n.close()},e.refreshAddonsScroller=function(){s(function(){e.$parent.myScroll.enhanceStays&&e.$parent.myScroll.enhanceStays.refresh()},700)},e.proceed=function(){e.closePopup();var t=_.reduce(_.pluck(e.reservationData.rooms,"rateId"),function(e,t){return!!e&&!!t});if("HOURLY"===d.reservation||t)g();else{var a=_.findIndex(e.reservationData.rooms,{rateId:""}),n=_.findIndex(e.reservationData.tabs,{roomTypeId:e.reservationData.rooms[a].roomTypeId});e.viewState.currentTab=n,r.go(v,{from_date:e.reservationData.arrivalDate,to_date:e.reservationData.departureDate,view:"DEFAULT",company_id:e.reservationData.company.id,travel_agent_id:e.reservationData.travelAgent.id,fromState:"rover.reservation.staycard.mainCard.addons",group_id:e.reservationData.group.id,room_type_id:e.reservationData.tabs[e.viewState.currentTab].roomTypeId,adults:e.reservationData.tabs[e.viewState.currentTab].numAdults,children:e.reservationData.tabs[e.viewState.currentTab].numChildren})}},e.selectAddonCategory=function(t,a){a.stopPropagation(),t?(e.activeAddonCategoryId=t.id,A(t.id)):(e.activeAddonCategoryId=-1,A())},e.selectAddon=function(a,r,s){if(e.closePopup(),!t.isItemInventoryOn||s)"staycard"===d.from_screen?I(a,r):S(a,r);else{e.selectedAddonName=a.title;var c=function(t,a){var r=parseInt(t.frequency,10);return 0===r?a:1===r?a*e.duration_of_stay:a*(e.duration_of_stay/r)},l=0,u=e.reservationData.tabs[e.viewState.currentTab].roomCount;"PERSON"===a.amountType.value?l=c(a.postType,e.reservationData.number_of_adults+e.reservationData.number_of_children):"ADULT"===a.amountType.value?l=c(a.postType,e.reservationData.number_of_adults):"CHILD"===a.amountType.value?l=c(a.postType,e.reservationData.number_of_children):"FLAT"!==a.amountType.value&&"ROOM"!==a.amountType.value||(l=c(a.postType,1)),l*=u;var m=0;angular.forEach(e.addonsData.existingAddons,function(e,t){e.id===a.id&&(m=parseInt(e.quantity))});var f=0;angular.forEach(T,function(e,t){e.id===a.id&&(f=parseInt(e.quantity))});var v=function(t){e.$emit("hideLoader");var o=t.available_count,i=o-(m-f)-l*r;i>=0||null===o?"staycard"===d.from_screen?I(a,r):S(a,r):(e.addon=a,e.addonQty=r,e.remainingCount=o,n.open({template:"/assets/partials/reservationCard/rvInsufficientInventory.html",className:"ngdialog-theme-default",closeByDocument:!0,scope:e,data:JSON.stringify({name:e.selectedAddonName,count:o,canOverbookInventory:p.getPermissionValue("OVERRIDE_ITEM_INVENTORY")})}))},_=new tzIndependentDate(e.reservationData.arrivalDate);_.setDate(_.getDate()+((e.reservationData.numNights||1)-1));var D={addon_id:a.id,from_date:e.reservationData.arrivalDate,to_date:i("date")(_,"yyyy-MM-dd")};e.invokeApi(o.checkInventory,D,v)}};var E=function(t,a){var r=e.reservationData.reservationId,n=function(){R(a)},o=function(t){e.errorMessage=t},i=[];i.push(t);var s={postData:{addons:i},reservationId:r};e.invokeApi(u.deleteAddonsFromReservation,s,n,o)},R=function(t){var a,r=e.roomDetails.firstIndex,n=e.roomDetails.lastIndex;for("HOURLY"===d.reservation&&(r=0,n=e.reservationData.rooms.length-1),e.addonsData.existingAddons.splice(t,1),e.packageData.existing_packages.splice(t,1),a=r;a<=n;a++)e.reservationData.rooms[a].addons.splice(t,1);e.existingAddonsLength=e.addonsData.existingAddons.length,0===e.addonsData.existingAddons.length&&e.closePopup()},b=function(){if(e.addons=[],e.activeRoom=e.viewState.currentTab,e.fromPage="",e.duration_of_stay=e.reservationData.numNights||1,e.existingAddonsLength=0,e.setHeadingTitle("Enhance Stay"),e.$parent.hideSidebar=!0,e.activeAddonCategoryId=-1,e.roomNumber="",e.addonCategories=a.addonCategories,e.bestSellerEnabled=a.bestSellerEnabled,D(),"HOURLY"===d.reservation)h();else{e.roomDetails=C(),!m.getReservationFlag("RATE_CHANGED")&&e.reservationData.reservationId?k():e.reservationData.group.id&&(e.is_rate_addons_fetch=!0,e.callAPI(f.getGroupEnhancements,{successCallBack:P,params:{id:e.reservationData.group.id}})),A("",!0);var r={click:!0,preventDefault:!1,showScrollbar:!0};e.setScroller("enhanceStays",r),s(function(){e.refreshAddonsScroller()},2e3);var n=e.$on("PROCEED_BOOKING",function(t,a){"reservation"===a.addonPostingMode&&"staycard"===e.fromPage?N(a.selectedPurchesedAddon):"reservation"===a.addonPostingMode&&e.proceed()}),o=t.$on("REMOVE_ADDON",function(t,a){"reservation"===a.addonPostingMode&&"staycard"===e.fromPage?E(a.addon.id,a.index):"reservation"===a.addonPostingMode&&R(a.index)});e.$on("$destroy",n),e.$on("$destroy",o)}},N=function(a){var r=function(){e.$emit("hideLoader"),k(!0)},n={addon_id:a.id,reservation_id:e.reservationData.reservationId,post_instances:a.post_instances,start_date:i("date")(tzIndependentDate(a.start_date),t.dateFormatForAPI),end_date:i("date")(tzIndependentDate(a.end_date),t.dateFormatForAPI),selected_post_days:a.selected_post_days};e.invokeApi(u.updateAddonPosting,n,r)},P=function(t){var a,r=e.roomDetails.firstIndex,n=e.roomDetails.lastIndex;for("HOURLY"===d.reservation&&(r=0,n=e.reservationData.rooms.length-1),e.$emit("hideLoader"),e.roomNumber=t.room_no,e.duration_of_stay=t.duration_of_stay||e.reservationData.numNights,e.addonsData.existingAddons=[],a=r;a<=n;a++)e.reservationData.rooms[a].addons=[];var o=t.existing_packages||t;e.packageData={existing_packages:[]},angular.forEach(o,function(t){var o={id:t.id,title:t.name,quantity:t.addon_count,description:t.description,totalAmount:t.addon_count*parseFloat(t.amount),price_per_piece:t.amount,amount_type:t.amount_type,post_type:t.post_type,is_inclusive:t.is_inclusive,is_rate_addon:t.is_rate_addon,rate_currency:t.addon_currency,post_instances:t.post_instances,start_date:t.start_date,end_date:t.end_date,posting_frequency:t.post_type.frequency,post_day_of_the_week:t.post_day_of_the_week,post_day_of_the_month:t.post_day_of_the_month,frequency_type:t.frequency_type,frequency:t.frequency,custom_nightly_selected_post_days:t.custom_nightly_selected_post_days};for(e.addonsData.existingAddons.push(o),e.packageData.existing_packages.push(o),a=r;a<=n;a++)e.reservationData.rooms[a].addons.push({quantity:o.quantity,id:o.id,price:parseFloat(t.amount),amountType:t.amount_type,postType:t.post_type,title:o.title,totalAmount:o.totalAmount,is_inclusive:o.is_inclusive,taxes:t.taxes,is_rate_addon:t.is_rate_addon,rate_currency:t.addon_currency})}),T=angular.copy(e.addonsData.existingAddons),e.existingAddonsLength=e.addonsData.existingAddons.length},k=function(t){var a=function(a){P(a),t&&e.showEnhancementsPopup()};e.invokeApi(u.getReservationPackages,e.reservationData.reservationId,a)};e.goToAddons=function(){e.closePopup()},e.$on("cardChanged",function(e,t){D()}),b()}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){sntRover.controller("RVReservationBaseSearchCtrl",["$rootScope","$scope","RVReservationBaseSearchSrv","dateFilter","ngDialog","$state","$timeout","$stateParams","$vault","baseData","activeCodes","flyerPrograms","loyaltyPrograms","$filter","RVReservationTabService","guestDetails","rvUtilSrv",function(e,t,a,r,n,o,i,s,c,d,l,u,m,f,p,v,D){BaseCtrl.call(this,t),t.$parent.hideSidebar=!1;e.maxStayLength;t.setScroller("search_reservation",{preventDefault:!1});t.activeCodes=l.promotions,t.loyaltyPrograms=m.data,t.flyerPrograms=u.data,t.codeSearchText="",t.validationMsg="",t.setDepartureHours=function(){var a=function(e){t.reservationData.resHours=e};(!h(t.reservationData.resHours)||t.reservationData.resHours&&t.reservationData.resHours<e.minimumHourlyReservationPeriod)&&i(a.bind(null,e.minimumHourlyReservationPeriod),100);var r=parseInt(t.reservationData.checkinTime.hh),n=(parseInt(t.reservationData.checkoutTime.hh),t.reservationData.checkinTime.ampm),o=(t.reservationData.checkoutTime.ampm,parseInt(t.reservationData.resHours));if(r+o>24){var s=(r+o)%24;s>=12?(t.reservationData.checkoutTime.hh=12===s||0===s?12:s-12,t.reservationData.checkoutTime.ampm="AM"===n?"PM":"AM"):(t.reservationData.checkoutTime.hh=s,t.reservationData.checkoutTime.ampm=n,t.reservationData.checkoutTime.hh=1===t.reservationData.checkoutTime.hh.toString().length?"0"+t.reservationData.checkoutTime.hh:t.reservationData.checkoutTime.hh)}else if(r+o>=12){var s=(r+o)%12;t.reservationData.checkoutTime.hh=0===s?12:s,t.reservationData.checkoutTime.ampm="AM"===t.reservationData.checkinTime.ampm?"PM":"AM"}else t.reservationData.checkoutTime.hh=r+o,t.reservationData.checkoutTime.ampm=n;t.reservationData.checkoutTime.hh=1===t.reservationData.checkoutTime.hh.toString().length?"0"+t.reservationData.checkoutTime.hh:t.reservationData.checkoutTime.hh,t.reservationData.checkoutTime.mm=t.reservationData.checkinTime.mm},t.mapToCheckinTime=function(){var e=t.fullCheckinTime.split(" ")[1],a=t.fullCheckinTime.split(" ")[0],r=a.length?a.split(":")[0]:"",n=a.length?a.split(":")[1]:"";t.reservationData.checkinTime.hh=r||"",t.reservationData.checkinTime.mm=n||"",t.reservationData.checkinTime.ampm=e||""},t.mapToCheckoutTime=function(){var e=t.fullCheckoutTime.split(" ")[1],a=t.fullCheckoutTime.split(" ")[0],r=a.length?a.split(":")[0]:"",n=a.length?a.split(":")[1]:"";t.reservationData.checkoutTime.hh=r||"",t.reservationData.checkoutTime.mm=n||"",t.reservationData.checkoutTime.ampm=e||""};var h=function(e){return Number(e)==e&&e%1===0};t.clearNumNightIfWrong=function(){h(t.reservationData.numNights)||(t.reservationData.numNights=1,t.errorMessage=["Number of nights can only be a numeric value"])},t.clearNumHoursIfWrong=function(){h(t.reservationData.resHours)||(t.reservationData.resHours=e.minimumHourlyReservationPeriod,t.errorMessage=["Number of hours can only be a numeric value"])};var y=function(e){var a=parseInt(e.hotel_time.hh),r=parseInt(e.hotel_time.mm),n="";if(a>12?(a-=12,n="PM"):n="AM",r>45&&a+1<12)a+=1,r="00";else if(r>45&&a+1===12)"AM"===n?(a="00",r="00",n="PM"):(a="00",r="00",n="AM");else if(15===r||30===r||45===r)r+=15;else do if(r+=1,15===r||30===r||45===r)break;while(15!==r||30!==r||45!==r);t.reservationData.checkinTime={hh:a<10&&a.length<2?"0"+a:a.toString(),mm:r.toString(),ampm:n},t.fullCheckinTime=a+":"+r+" "+n,t.setDepartureHours()},g=function(){t.refreshScroller("search_reservation")},C=t.$parent.$parent;C.callFromChildCtrl(d);var A,S;S=function(){t.fullCheckinTime="09:00 AM",t.fullCheckoutTime="05:00 PM",t.reservationData.checkinTime={ampm:"AM",hh:"09",mm:"00"},t.reservationData.checkoutTime={ampm:"PM",hh:"05",mm:"00"}},A=function(){if(t.viewState.identifier="CREATION",t.reservationData.rateDetails=[],t.heading="Reservations",t.setHeadingTitle(t.heading),t.viewState.currentTab=0,t.reservationData.isSameCard?(t.viewState.reservationStatus.confirm=!1,t.resetAddons(),""!==t.reservationDetails.guestCard.id&&(t.searchData.guestCard.guestFirstName=t.reservationData.guest.firstName,t.searchData.guestCard.guestLastName=t.reservationData.guest.lastName),t.companySearchText=function(){return t.reservationData.group.id?t.reservationData.group.name:t.reservationData.allotment.id?t.reservationData.allotment.name:t.reservationData.company.id?t.reservationData.company.name:t.reservationData.travelAgent.id?t.reservationData.travelAgent.name:""}(),t.searchPromoCode=function(){return t.reservationData.searchPromoCode?(t.codeSearchText=t.reservationData.searchPromoCode,t.reservationData.searchPromoCode):""}(),t.codeSearchText=function(){return t.reservationData.searchPromoCode?t.reservationData.searchPromoCode:t.reservationData.group.id?t.reservationData.group.code:t.reservationData.allotment.id?t.reservationData.allotment.code:t.reservationData.code?t.reservationData.code.value:""}()):(t.initReservationData(),t.initReservationDetails()),_.isEmpty(v)||(t.searchData.guestCard.guestFirstName=v.first_name,t.searchData.guestCard.guestLastName=v.last_name),c.set("guestDetails",JSON.stringify(v)),s.selectedArrivalDate?t.reservationData.arrivalDate=s.selectedArrivalDate:""===t.reservationData.arrivalDate&&(t.reservationData.arrivalDate=r(t.otherData.businessDate,"yyyy-MM-dd")),s.selectedRoomTypeId&&(t.reservationData.tabs[0].roomTypeId=s.selectedRoomTypeId,t.reservationData.rooms[0].roomTypeId=s.selectedRoomTypeId),s.numNights){var n=parseInt(s.numNights);if(n<=t.otherData.booking_max_stay_length){t.reservationData.numNights=n;var o=tzIndependentDate(t.reservationData.arrivalDate),i=o.getDate()+parseInt(n);o.setDate(i),t.reservationData.departureDate=r(o,"yyyy-MM-dd")}}""===t.reservationData.departureDate&&t.setDepartureDate(),e.isHourlyRateOn?(t.shouldShowToggle=!0,t.isNightsActive=!1,t.shouldShowNights=!1,t.shouldShowHours=!0,t.reservationData.resHours=e.minimumHourlyReservationPeriod,t.invokeApi(a.fetchCurrentTime,{},y)):(t.isNightsActive=!0,t.shouldShowNights=!0,t.shouldShowHours=!1,t.shouldShowToggle=!1,t.shouldShowHours=!1),t.otherData.fromSearch=!0,t.timeSlots=a.timeSlots,S(),t.$emit("hideLoader")},t.setDepartureDate=function(){t.errorMessage=[];var e=t.reservationData.numNights;if(h(e)&&null!==t.reservationData.numNights&&""!==t.reservationData.numNights||(e=1,t.reservationData.numNights=""),e>t.otherData.booking_max_stay_length){e=t.otherData.booking_max_stay_length;var a=angular.copy(t.reservationData.numNights);t.reservationData.numNights="",t.errorMessage=[a+" nights exceeds the maximum length of stay setting of "+e+" nights"]}var n=tzIndependentDate(t.reservationData.arrivalDate),o=n.getDate()+parseInt(e);n.setDate(o),t.reservationData.departureDate=r(n,"yyyy-MM-dd"),I()};var I=function(){t.$$phase||t.$digest()};t.showCheckinTimeslot=function(e){var a=_.find(t.timeSlots,function(e){return e.value===t.fullCheckoutTime});return!(a.fullDayValue<=e.fullDayValue||0===e.fullDayValue)},t.showCheckoutTimeslot=function(e){var a=_.find(t.timeSlots,function(e){return e.value===t.fullCheckinTime});return!(a.fullDayValue>=e.fullDayValue||2400===e.fullDayValue)},t.setNumberOfNights=function(){var e=tzIndependentDate(t.reservationData.arrivalDate),a=tzIndependentDate(t.reservationData.departureDate),r=Math.floor((Date.parse(a)-Date.parse(e))/864e5);t.reservationData.numNights=r},t.arrivalDateChanged=function(){t.reservationData.arrivalDate=r(t.reservationData.arrivalDate,"yyyy-MM-dd"),t.departureDateOptions.maxDate=O(t.reservationData.arrivalDate),t.setDepartureDate(),t.setNumberOfNights(),t.errorMessage=[]},t.departureDateChanged=function(){t.reservationData.departureDate=r(t.reservationData.departureDate,"yyyy-MM-dd"),t.setNumberOfNights(),t.errorMessage=[],L()};var T=function(e){0===e&&(t.reservationData.stayDays=[]),t.reservationData.rooms[e].stayDates={};for(var a=1*new tzIndependentDate(t.reservationData.arrivalDate),n=1*new tzIndependentDate(t.reservationData.departureDate);a<=n;a+=864e5)0===e&&t.reservationData.stayDays.push({date:r(new tzIndependentDate(a),"yyyy-MM-dd"),dayOfWeek:r(new tzIndependentDate(a),"EEE"),day:r(new tzIndependentDate(a),"dd")}),t.reservationData.rooms[e].stayDates[r(new tzIndependentDate(a),"yyyy-MM-dd")]={guests:{adults:parseInt(t.reservationData.rooms[e].numAdults),children:parseInt(t.reservationData.rooms[e].numChildren),infants:parseInt(t.reservationData.rooms[e].numInfants)},rate:{id:"",name:""}}};t.closeDialogAndRefresh=function(){n.close()};var E=function(){n.open({template:"/assets/partials/nightlyDiary/rvNightlyDiaryReservationWithUnassignedRoom.html",scope:t,className:"",closeByDocument:!1,closeByEscape:!1})},R=function(e){n.open({template:"/assets/partials/nightlyDiary/rvNightlyDiaryContinueWithBookPopup.html",scope:t,className:"",closeByDocument:!1,closeByEscape:!1,data:{callbackAction:e}})},b=function(e){n.open({template:"/assets/partials/nightlyDiary/rvNightlyDiaryNoAvailableRooms.html",className:"",scope:t,closeByDocument:!1,closeByEscape:!1,data:{warningMessage:e,isRefresh:!1}})},N=function(e){var r={params:{start_date:t.reservationData.arrivalDate,end_date:t.reservationData.departureDate,room_type_ids:_.pluck(t.reservationData.tabs,"roomTypeId")},successCallBack:function(a){var r=""!==t.reservationData.tabs[0].roomTypeId,n=a.house_availability,o=a.room_type_availability,i=t.reservationData.rooms.length,s=_.pluck(t.reservationData.tabs,"roomCount"),c=function(){var e=!1;return _.each(o,function(t,a){t.unassigned_reservations_present&&(t.availability<=0||t.availability<parseInt(s[a]))&&(e=!0)}),e},d=function(){var e=!1;return _.each(o,function(t,a){(t.availability<=0||t.availability<parseInt(s[a]))&&(e=!0);
}),e},l=function(){var e=!1;return _.each(o,function(t){t.unassigned_reservations_present&&t.availability>0&&(e=!0)}),e};r?n.unassigned_reservations_present&&(n.house_availability<=0||n.house_availability<i)?E():c()?E():n.house_availability<=0||d()?b("No additional availability exists for the selected Dates/Times"):l()?R(e):e():n.unassigned_reservations_present&&n.house_availability<=0?E():n.house_availability<=0||n.house_availability<i?b("No additional availability exists for the selected Dates/Times"):n.unassigned_reservations_present?R(e):e()}};0===t.reservationData.numNights&&(r.params.start_time=D.convertTimeHhMmAmPmTo24(t.reservationData.checkinTime),r.params.end_time=D.convertTimeHhMmAmPmTo24(t.reservationData.checkoutTime)),t.callAPI(a.checkTimeBasedAvailabilityAPI,r)};t.navigate=function(){if(t.reservationGuestSearchChanged(),t.isNightsActive){t.setNumberOfNights();for(var a=0;a<t.reservationData.rooms.length;a++)T(a);if(t.checkOccupancyLimit()){var r=function(){var a="rover.reservation.staycard.mainCard.room-rates";0!==t.reservationData.numNights&&(t.fullCheckinTime=e.hotelDetails.default_arrival_time_for_nightly,t.fullCheckoutTime=e.hotelDetails.default_dep_time_for_nightly,t.mapToCheckinTime(),t.mapToCheckoutTime()),o.go(a,{from_date:t.reservationData.arrivalDate,to_date:t.reservationData.departureDate,arrivalTime:t.reservationData.checkinTime,departureTime:t.reservationData.checkoutTime,fromState:o.current.name,company_id:t.reservationData.company.id,allotment_id:t.reservationData.allotment.id,travel_agent_id:t.reservationData.travelAgent.id,group_id:t.reservationData.group.id,promotion_code:t.reservationData.searchPromoCode,promotion_id:t.reservationData.promotionId,adults:t.reservationData.tabs[0].numAdults,children:t.reservationData.tabs[0].numChildren,room_type_id:t.reservationData.tabs[0].roomTypeId,is_member:!!t.reservationData.member.isSelected,guestId:s.guestId?s.guestId:""}),n.close()},i=D.getDiaryMode();"FULL"===i?N(r):r()}}else{var d={},l=t.reservationData.rooms[0],u=t.reservationData.resHours;h(t.reservationData.resHours)&&""!==t.reservationData.resHours&&t.reservationData.resHours||(u=e.minimumHourlyReservationPeriod),_.extend(d,{fromDate:new tzIndependentDate(t.reservationData.arrivalDate).getTime(),toDate:new tzIndependentDate(t.reservationData.departureDate).getTime(),arrivalTime:t.reservationData.checkinTime,departureTime:t.reservationData.checkoutTime,minHours:u,adults:l.numAdults,children:l.numChildren,infants:l.numInfants,roomTypeID:l.roomTypeId,guestFirstName:t.searchData.guestCard.guestFirstName,guestLastName:t.searchData.guestCard.guestLastName,companyID:t.reservationData.company.id,travelAgentID:t.reservationData.travelAgent.id,promotionCode:t.reservationData.searchPromoCode,guestId:s.guestId?s.guestId:""}),c.set("searchReservationData",JSON.stringify(d)),o.go("rover.diary",{isfromcreatereservation:!0})}},t.alertOverbooking=function(e){var a=0,r=0;e&&(t.closeDialog(),r=1e3),i(function(){for(;a<t.reservationData.tabs.length;a++){var e=t.reservationData.tabs[a];if(!(e.overbookingStatus.room&&e.overbookingStatus.house||e.overbookingStatus.alerted)){e.overbookingStatus.alerted=!0,n.open({template:"/assets/partials/reservation/alerts/availabilityCheckOverbookingAlert.html",scope:t,controller:"overbookingAlertCtrl",closeByDocument:!1,closeByEscape:!1,data:JSON.stringify({houseFull:!e.overbookingStatus.house,roomTypeId:e.roomTypeId})});break}}a===t.reservationData.tabs.length&&t.navigate()},r)},t.checkAvailability=function(){t.invokeApi(a.checkOverbooking,{from_date:t.reservationData.arrivalDate,to_date:t.reservationData.departureDate},function(e){t.availabilityData=e;var a=!0,r=_(t.reservationData.tabs.length).times(function(e){return!0});_.each(e,function(e){a=a&&e.house.availability>0,_.each(t.reservationData.tabs,function(t,a){t.roomTypeId&&(r[a]=r[a]&&e.room_types[t.roomTypeId]>0)})}),a&&_.reduce(r,function(e,t){return e&&t})?t.navigate():(_.each(t.reservationData.tabs,function(e,t){e.overbookingStatus={house:a,room:r[t],alerted:!1}}),t.alertOverbooking()),t.$emit("hideLoader")},function(e){t.$emit("hideLoader"),t.errorMessage=e})};var P=function(e,r){var n=[],o="",i={},s=!1,c=function(e){t.$emit("hideLoader"),_.each(e.accounts,function(e){i={},i={label:e.account_name,value:e.account_name,image:e.company_logo,type:e.account_type,id:e.id,corporateid:"",iataNumber:"",address:e.account_address,contract_access_code:e.current_contracts.length>0?e.current_contracts[0].access_code:null},s=_.find(t.companyCardResults,function(e){return i.id===e.id}),s||n.push(i)}),1===t.reservationData.rooms.length&&e.groups&&e.groups.length>0&&_.each(e.groups,function(e){n.push({label:e.name,value:e.name,type:"GROUP",id:e.id,code:e.code,company:e.company_id,travelAgent:e.travel_agent_id})}),1===t.reservationData.rooms.length&&e.allotments&&e.allotments.length>0&&_.each(e.allotments,function(e){n.push({label:e.name,value:e.name,type:"ALLOTMENT",id:e.id,code:e.code,company:e.company_id,travelAgent:e.travel_agent_id})}),r(n)},d=function(){""!==e.term&&o!==e.term&&(t.invokeApi(a.fetchCompanyCard,{query:e.term,include_group:1===t.reservationData.rooms.length,include_allotment:1===t.reservationData.rooms.length,from_date:t.reservationData.arrivalDate,to_date:t.reservationData.departureDate},c),o=e.term)};0===e.term.length?(n=[],o="",t.searchPromoCode="",t.reservationData.group.id&&(t.reservationData.group={id:"",name:"",code:"",company:"",travelAgent:""},t.codeSearchText="",t.companySearchText=""),t.reservationData.allotment.id&&(t.reservationData.allotment={id:"",name:"",code:"",company:"",travelAgent:""},t.codeSearchText="",t.companySearchText=""),t.reservationData.company.id="",t.reservationData.company.name="",t.reservationData.company.corporateid="",t.reservationData.travelAgent.id="",t.reservationData.travelAgent.name="",t.reservationData.travelAgent.corporateid=""):e.term.length>2&&d()},k=function(e,a){"COMPANY"===a.item.type?(t.reservationData.company.id=a.item.id,t.reservationData.company.name=a.item.label,t.reservationData.company.corporateid=a.item.corporateid):"GROUP"===a.item.type?(t.reservationData.group={id:a.item.id,name:a.item.label,code:a.item.code,company:a.item.company,travelAgent:a.item.travelAgent},t.codeSearchText=a.item.code,t.reservationData.searchPromoCode="",t.reservationData.promotionId=""):"ALLOTMENT"===a.item.type?(t.reservationData.allotment={id:a.item.id,name:a.item.label,code:a.item.code,company:a.item.company,travelAgent:a.item.travelAgent},t.codeSearchText=a.item.code,t.reservationData.searchPromoCode="",t.reservationData.promotionId=""):(t.reservationData.travelAgent.id=a.item.id,t.reservationData.travelAgent.name=a.item.label,t.reservationData.travelAgent.iataNumber=a.item.iataNumber)};t.autocompleteOptions={delay:0,minLength:0,position:{of:"#company-or-agent",my:"left top",at:"left bottom",collision:"flip",within:"#company-promo"},source:P,select:k},A();var O=function(e){var a=tzIndependentDate(e),r=f("date")(a,"yyyy-MM-dd"),n=r.match(/(\d+)/g);return new Date(n[0],parseInt(n[1])-1,parseInt(n[2],10)+t.otherData.booking_max_stay_length)};t.arrivalDateOptions={showOn:"button",dateFormat:"MM-dd-yyyy",numberOfMonths:2,yearRange:"0:+10",minDate:tzIndependentDate(t.otherData.businessDate),beforeShow:function(e,t){$("#ui-datepicker-div").addClass("reservation arriving")},onClose:function(e,t){i(function(){$("#ui-datepicker-div").removeClass("reservation arriving")},200)}},t.departureDateOptions={showOn:"button",dateFormat:"MM-dd-yyyy",numberOfMonths:2,yearRange:"0:+10",minDate:tzIndependentDate(t.otherData.businessDate),maxDate:O(tzIndependentDate(t.otherData.businessDate)),beforeShow:function(e,t){$("#ui-datepicker-div").addClass("reservation departing")},onClose:function(e,t){i(function(){$("#ui-datepicker-div").removeClass("reservation arriving")},200)}},t.reservationGuestSearchChanged=function(){t.reservationDetails.guestCard.id=""},t.reservationGuestPromoCodeChanged=function(){},t.switchNightsHours=function(){t.isNightsActive?(t.shouldShowNights=!1,t.shouldShowHours=!0):(t.shouldShowNights=!0,t.shouldShowHours=!1)};var w=function(e,r){var n=[],o="";0===e.term.length?(n=[],o="",t.searchPromoCode="",t.reservationData.searchPromoCode="",t.reservationData.group.id?(t.reservationData.group={id:"",name:"",code:"",company:"",travelAgent:""},t.codeSearchText="",t.companySearchText=""):t.reservationData.allotment.id&&(t.reservationData.allotment={id:"",name:"",code:"",company:"",travelAgent:""},t.codeSearchText=""),t.reservationData.code&&(t.reservationData.promotionId=null,t.searchPromoCode="",t.reservationData.code={id:"",type:"",discount:{}})):e.term.length>0&&""!==e.term&&o!==e.term&&(o=e.term,t.reservationData.searchPromoCode=e.term,t.invokeApi(a.autoCompleteCodes,{code:e.term,include_group:1===t.reservationData.rooms.length,include_allotment:1===t.reservationData.rooms.length,from_date:t.reservationData.arrivalDate,to_date:t.reservationData.departureDate},function(e){n=[],angular.forEach(e.promotions,function(e){eachItem={label:e.name,value:e.name,type:"PROMO",id:e.id,discount:e.discount,from:e.from_date,to:e.to_date},n.push(eachItem)}),angular.forEach(e.groups,function(e){eachItem={label:e.name,value:e.code,type:"GROUP",id:e.id,from:e.from_date,to:e.to_date,name:e.name,company:e.company_id,travelAgent:e.travel_agent_id},n.push(eachItem)}),angular.forEach(e.allotments,function(e){eachItem={label:e.name,value:e.code,type:"ALLOTMENT",id:e.id,from:e.from_date,to:e.to_date,name:e.name,company:e.company_id,travelAgent:e.travel_agent_id},n.push(eachItem)}),t.$emit("hideLoader"),r(n)}))},M=function(e,a){a.item&&(t.reservationData.searchPromoCode=a.item.label,t.searchPromoCode=a.item.label),"PROMO"===a.item.type?(t.reservationData.code=a.item,t.reservationData.searchPromoCode=a.item.label,t.reservationData.promotionId=a.item.id):"GROUP"===a.item.type?(t.reservationData.group={id:a.item.id,name:a.item.name,code:a.item.value,company:a.item.company,travelAgent:a.item.travelAgent},t.codeSearchText=a.item.value,t.companySearchText=a.item.name):"ALLOTMENT"===a.item.type&&(t.reservationData.allotment={id:a.item.id,name:a.item.name,code:a.item.value,company:a.item.company,travelAgent:a.item.travelAgent},t.codeSearchText=a.item.value,t.companySearchText=a.item.name)};t.codesACOptions={delay:0,minLength:0,position:{my:"left top",at:"left bottom",collision:"flip",of:"#codes-value",within:"#company-promo"},source:w,select:M},t.onMemberRateToggle=function(){return e.isHLPActive&&t.loyaltyPrograms.length>0?void(t.reservationData.member.value=t.loyaltyPrograms[0].hl_value):void(e.isFFPActive&&t.flyerPrograms.length>0&&(t.reservationData.member.value=t.flyerPrograms[0].ff_value))},t.addTab=function(e){return!!t.reservationData.tabs[e].roomTypeId&&(t.reservationData.tabs=t.reservationData.tabs.concat(p.newTab()),t.reservationData.rooms=t.reservationData.rooms.concat(p.newRoom()),void g())},t.onRoomTypeChange=function(e){var a,r=0,n=parseInt(t.reservationData.tabs[e].roomCount,10),o=parseInt(t.reservationData.tabs[e].roomTypeId,10)||"";for(t.reservationData.tabs[e].roomTypeId=o,a=0;a<e;a++)r+=parseInt(t.reservationData.tabs[a].roomCount,10);for(a=r;a<r+n;a++)t.reservationData.rooms[a].roomTypeId=o},t.onOccupancyChange=function(e,a){var r,n=t.reservationData.tabs[a].roomTypeId,o=_.indexOf(t.reservationData.rooms,_.findWhere(t.reservationData.rooms,{roomTypeId:n})),i=_.lastIndexOf(t.reservationData.rooms,_.last(_.where(t.reservationData.rooms,{roomTypeId:n})));for(r=o;r<=i;r++)"numChildren"==e&&0==t.reservationData.tabs[a].numChildren&&0==t.reservationData.tabs[a].numAdults?(t.reservationData.tabs[a].numAdults=1,t.reservationData.rooms[r].numAdults=1):"numAdults"==e&&0==t.reservationData.tabs[a].numAdults&&0==t.reservationData.tabs[a].numChildren&&(t.reservationData.rooms[r].numChildren=1,t.reservationData.tabs[a].numChildren=1),t.reservationData.rooms[r][e]=parseInt(t.reservationData.tabs[a][e],10)},t.isRoomTypeSelected=function(e,a){var r=!1;return _.each(t.reservationData.tabs,function(t,n){parseInt(t.roomTypeId,10)===a&&e!=n&&(r=!0)}),r},t.restrictMultipleBookings=function(){return!!e.isHourlyRateOn||!!t.reservationData.group.id};var L=function(){t.reservationData.group&&t.reservationData.group.id&&(t.reservationData.group={},t.companySearchText="",t.codeSearchText="")};t.closeDialog=function(){t.validationMsg="",n.close()}}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){sntRover.controller("RVCancelReservation",["$rootScope","$scope","$stateParams","RVPaymentSrv","$timeout","RVReservationCardSrv","$state","$filter","$q","RVReservationSummarySrv","$window","RVNightlyDiarySrv",function(e,t,a,r,n,o,i,s,c,d,l,u){BaseCtrl.call(this,t),t.errorMessage="",t.showCancelCardSelection=!0,t.showAddtoGuestCard=!0,t.addmode=!1,t.showCCPage=!1,t.referanceText="",t.isDisplayReference=!1,t.newCardAdded=!1,t.cancellationData={selectedCard:-1,reason:"",viewCardsList:!1,existingCard:!1,cardId:"",cardNumber:"",expiry_date:"",card_type:"",addToGuestCard:!1,locale:t.languageData.selected_language_code},t.cancellationData.paymentType="",t.DailogeState="undefined"!=typeof t.$parent.DailogeState?t.$parent.DailogeState:{},t.DailogeState.sendConfirmatonMailTo="undefined"!=typeof t.$parent.DailogeState?t.$parent.DailogeState.sendConfirmatonMailTo:"",t.DailogeState.isCancelled=!1,t.ngDialogData.penalty>0&&(t.$emit("UPDATE_CANCEL_RESERVATION_PENALTY_FLAG",!0),t.ngDialogData.penalty=parseFloat(t.ngDialogData.penalty).toFixed(2)),t.setScroller("cardsList",{click:!0,tap:!0});var m=function(){"CC"!==t.cancellationData.paymentType?angular.forEach(t.passData.details.paymentTypes,function(e,a){e.name===t.cancellationData.paymentType&&(t.isDisplayReference=!!e.is_display_reference,"CC"!==e.name&&(t.feeData.feesInfo=e.charge_code.fees_information),t.setupFeeData())}):angular.forEach(t.passData.details.creditCardTypes,function(e,a){t.cancellationData.card_type.toUpperCase()===e.cardcode&&(t.isDisplayReference=!!e.is_display_reference)})};t.changeOnsiteCallIn=function(){t.isManual?t.showCCPage=!0:""},t.$on("changeOnsiteCallIn",function(e){t.isManual=!t.isManual,t.changeOnsiteCallIn()}),t.changePaymentType=function(){"CC"===t.cancellationData.paymentType?"sixpayments"===e.paymentGateway?"":t.showCCPage=!0:m()},t.feeData={};var f=parseFloat("0.00");t.isShowFees=function(){var e=!1,a=t.feeData;return"undefined"==typeof a||"undefined"==typeof a.feesInfo||null===a.feesInfo?e=!1:a.defaultAmount>=a.minFees&&t.isStandAlone&&a.feesInfo.amount&&(e=!0),e},t.calculateFee=function(){if(t.isStandAlone){var e=t.feeData.feesInfo,a="",r=f,n=f;"undefined"!=typeof e&&null!==e&&(a=e.amount_symbol,r=e.amount?parseFloat(e.amount):f,n=e.minimum_amount_for_fees?parseFloat(e.minimum_amount_for_fees):f);var o=""===t.ngDialogData.penalty?f:parseFloat(t.ngDialogData.penalty);if(t.feeData.minFees=n,t.feeData.defaultAmount=o,t.isShowFees())if("percent"===a){var i=parseFloat(o*(r/100));t.feeData.calculatedFee=parseFloat(i).toFixed(2),t.feeData.totalOfValueAndFee=parseFloat(i+o).toFixed(2)}else t.feeData.calculatedFee=parseFloat(r).toFixed(2),t.feeData.totalOfValueAndFee=parseFloat(o+r).toFixed(2)}},t.setupFeeData=function(){var e=t.feeData.feesInfo?t.feeData.feesInfo:{},a=t.ngDialogData?parseFloat(t.ngDialogData.penalty):f,r=e.minimum_amount_for_fees?parseFloat(e.minimum_amount_for_fees):f;if(t.feeData.minFees=r,t.feeData.defaultAmount=a,t.isShowFees()&&"undefined"!=typeof e.amount&&null!==e){var n=e.amount_symbol,o=e.amount?parseFloat(e.amount):f;t.feeData.actualFees=o,"percent"===n?t.calculateFee():(t.feeData.calculatedFee=parseFloat(o).toFixed(2),t.feeData.totalOfValueAndFee=parseFloat(o+a).toFixed(2))}},t.calculateTotalAmount=function(e){var a="undefined"==typeof t.feeData.calculatedFee||""===t.feeData.calculatedFee||"-"===t.feeData.calculatedFee?f:parseFloat(t.feeData.calculatedFee),r="undefined"==typeof e||""===e?f:parseFloat(e);t.feeData.totalOfValueAndFee=parseFloat(r+a).toFixed(2)};var p=function(){n(function(){t.refreshScroller("cardsList")},2e3)},v=function(){var e=t.newPaymentInfo.tokenDetails.isSixPayment?getSixCreditCardType(t.newPaymentInfo.tokenDetails.card_type).toLowerCase():getCreditCardType(t.newPaymentInfo.cardDetails.cardType).toLowerCase();return e},D=function(){var e=t.newPaymentInfo.tokenDetails.isSixPayment?t.newPaymentInfo.tokenDetails.token_no.substr(t.newPaymentInfo.tokenDetails.token_no.length-4):t.newPaymentInfo.cardDetails.cardNumber.slice(-4);return e},h=function(){var e=t.newPaymentInfo.tokenDetails.isSixPayment?t.newPaymentInfo.tokenDetails.expiry.substring(2,4):t.newPaymentInfo.cardDetails.expiryMonth,a=t.newPaymentInfo.tokenDetails.isSixPayment?t.newPaymentInfo.tokenDetails.expiry.substring(0,2):t.newPaymentInfo.cardDetails.expiryYear,r=e+" / "+a;return r},y=function(){var e=t.newPaymentInfo.tokenDetails.isSixPayment?"":t.newPaymentInfo.cardDetails.userName;return e},g=function(){var e=t.newPaymentInfo.tokenDetails.isSixPayment?t.newPaymentInfo.tokenDetails.expiry.substring(2,4):t.newPaymentInfo.cardDetails.expiryMonth,a=t.newPaymentInfo.tokenDetails.isSixPayment?t.newPaymentInfo.tokenDetails.expiry.substring(0,2):t.newPaymentInfo.cardDetails.expiryYear,n=e&&a?"20"+a+"-"+e+"-01":"",o=t.newPaymentInfo.tokenDetails.isSixPayment?t.newPaymentInfo.tokenDetails.token_no:t.newPaymentInfo.tokenDetails.session,i=function(e){t.$emit("hideLoader"),t.cancellationData.selectedCard=e.id,t.cancellationData.cardNumber=D(),t.cancellationData.expiry_date=h(),t.cancellationData.card_type=v(),m(),t.showCCPage=!1,t.newCardAdded=!0},s={add_to_guest_card:t.newPaymentInfo.cardDetails.addToGuestCard,name_on_card:y(),payment_type:"CC",reservation_id:t.passData.reservationId,token:o};s.card_code=t.newPaymentInfo.tokenDetails.isSixPayment?getSixCreditCardType(t.newPaymentInfo.tokenDetails.card_type).toLowerCase():t.newPaymentInfo.cardDetails.cardType,t.newPaymentInfo.tokenDetails.isSixPayment||(s.card_expiry=n),t.invokeApi(r.savePaymentDetails,s,i)},C=function(e){t.$emit("hideLoader"),t.cardsList=_.where(e.existing_payments,{is_credit_card:!0}),t.cardsList.forEach(function(e){e.mli_token=e.ending_with,delete e.ending_with,e.card_expiry=e.expiry_date,delete e.expiry_date}),t.addmode=!(t.cardsList.length>0),p(),t.ngDialogData.state="PENALTY"};t.completeCancellationProcess=function(){t.DailogeState.isCancelled&&("rover.reservation.staycard.reservationcard.reservationdetails"===i.current.name?(a.isrefresh=!0,i.reload(i.current.name)):i.go("rover.reservation.staycard.reservationcard.reservationdetails",{id:t.reservationData.reservationId||t.reservationData.reservation_card.reservation_id,confirmationId:t.reservationData.confirmNum||t.reservationData.reservation_card.confirmation_num,isrefresh:!0})),t.closeReservationCancelModal()};var A=function(e){var a=function(e){},r=function(e){t.$emit("hideLoader"),t.DailogeState.isCancelled=!0;var a=u.getCache();"undefined"!=typeof a&&(a.currentSelectedReservationId="",a.currentSelectedRoomId="",a.currentSelectedReservation=""),u.updateCache(a)},n=function(e){t.$emit("hideLoader"),t.errorMessage=e};if(t.reservationData&&t.reservationData.reservationIds&&t.reservationData.reservationIds.length>1){var i=[];t.$emit("showLoader"),_.each(t.reservationData.reservationIds,function(r){var n={reason:t.cancellationData.reason,payment_method_id:parseInt(t.cancellationData.selectedCard)===-1?null:parseInt(t.cancellationData.selectedCard),id:r,application:"ROVER",is_with_penalty:e};t.ngDialogData.isDisplayReference&&(n.reference_text=t.referanceText),i.push(o.cancelReservation(n).then(a))}),c.all(i).then(r,n)}else{var s={reason:t.cancellationData.reason,payment_method_id:parseInt(t.cancellationData.selectedCard)===-1?null:parseInt(t.cancellationData.selectedCard),id:t.reservationData.reservationId||t.reservationParentData.reservationId||t.passData.reservationId,application:"ROVER",is_with_penalty:e};t.ngDialogData.isDisplayReference&&(s.reference_text=t.referanceText),t.invokeApi(o.cancelReservation,s,r,n)}},S=function(a){if(t.$emit("hideLoader"),t.cancellationData.addToGuestCard){var r=t.cancellationData.card_type,n=t.cancellationData.cardNumber,o={card_code:r,mli_token:n,card_expiry:t.cancellationData.expiry_date,card_name:t.newPaymentInfo.cardDetails.userName,id:a.id,isSelected:!0,is_primary:!1,payment_type:"CC",payment_type_id:1};t.cardsList.push(o),e.$broadcast("ADDEDNEWPAYMENTTOGUEST",o)}t.depositPaidSuccesFully=!0,t.authorizedCode=a.authorization_code};t.cancelReservation=function(e){A(e)},t.submitPayment=function(){t.errorMessage="",t.depositInProcess=!0;var a={postData:{bill_number:1,payment_type:t.cancellationData.paymentType,amount:t.ngDialogData.penalty,payment_type_id:"CC"===t.cancellationData.paymentType&&t.cancellationData.selectedCard!==-1?t.cancellationData.selectedCard:null},reservation_id:t.passData.reservationId};t.isShowFees()&&(t.feeData.calculatedFee&&(a.postData.fees_amount=t.feeData.calculatedFee),t.feeData.feesInfo&&(a.postData.fees_charge_code_id=t.feeData.feesInfo.charge_code_id)),t.newCardAdded?a.postData.add_to_guest_card=t.cancellationData.addToGuestCard:a.postData.add_to_guest_card=!1,t.isDisplayReference&&(a.postData.reference_text=t.referanceText),"sixpayments"!==e.paymentGateway||t.isManual||"CC"!==t.cancellationData.paymentType?t.invokeApi(r.submitPaymentOnBill,a,S):(a.postData.is_emv_request=!0,t.shouldShowWaiting=!0,r.submitPaymentOnBill(a).then(function(e){t.shouldShowWaiting=!1,S(e)},function(e){t.errorMessage=e,t.shouldShowWaiting=!1}))},t.applyPenalty=function(){var e=t.passData.reservationId;t.ngDialogData.applyPenalty=!0,t.invokeApi(r.getPaymentList,e,C)},t.onCardClick=function(){t.showCCPage=!0,t.addmode=!(t.cardsList.length>0)};var I=function(e){t.cancellationData.selectedCard=t.cardsList[e].value,t.cancellationData.cardNumber=t.cardsList[e].mli_token,t.cancellationData.expiry_date=t.cardsList[e].card_expiry,t.cancellationData.card_type=t.cardsList[e].card_code,m(),t.showCCPage=!1,t.isStandAlone&&(t.feeData.feesInfo=t.cardsList[e].fees_information,t.setupFeeData()),t.newCardAdded=!1};t.$on("TOKEN_CREATED",function(e,a){t.newPaymentInfo=a,t.showCCPage=!1,g()}),t.$on("MLI_ERROR",function(e,a){t.errorMessage=a}),t.$on("cancelCardSelection",function(e,a){t.showCCPage=!1,t.cancellationData.paymentType="",t.isManual=!1}),t.$on("cardSelected",function(e,t){I(t.index)}),t.$on("SHOW_SWIPED_DATA_ON_CANCEL_RESERVATION_PENALTY_SCREEN",function(e,a){t.$broadcast("RENDER_SWIPED_DATA",a),t.ngDialogData.state="PENALTY",t.showCCPage=!0,t.addmode=!0});var T=function(e,a){t.$emit("hideLoader"),t.cancellationData.selectedCard=e.id,t.cancellationData.cardNumber=a.cardNumber.slice(-4),t.cancellationData.expiry_date=a.cardExpiryMonth+"/"+a.cardExpiryYear,t.cancellationData.card_type=a.cardType.toLowerCase(),t.showCCPage=!1};t.$on("SWIPED_DATA_TO_SAVE",function(e,a){var n=a;n.reservation_id=t.reservationData.reservation_card.reservation_id,n.payment_credit_type=a.cardType,n.credit_card=a.cardType,n.card_expiry="20"+a.cardExpiryYear+"-"+a.cardExpiryMonth+"-01",n.add_to_guest_card=a.addToGuestCard;var o={params:n,successCallBack:T,successCallBackParameters:a};t.callAPI(r.savePaymentDetails,o)}),t.closeReservationCancelModal=function(){t.$emit("UPDATE_CANCEL_RESERVATION_PENALTY_FLAG",!1),t.closeDialog()};var E=dclone(t.DailogeState);t.DailogeState={},t.DailogeState.successMessage="",t.DailogeState.failureMessage="",t.DailogeState.isCancelled=t.passData.isCancelled||!1,t.DailogeState.bookerEmail=E.bookerEmail,t.DailogeState.isGuestEmailSelected=E.isGuestEmailSelected,t.DailogeState.isBookerEmailSelected=E.isBookerEmailSelected,t.DailogeState.guestEmail=E.guestEmail,t.isEmailAttached=function(){var e=!1;return null!==t.guestCardData.contactInfo.email&&""!==t.guestCardData.contactInfo.email&&(e=!0),e};var R=function(e){t.$emit("hideLoader"),t.DailogeState.successMessage=e.message,t.DailogeState.failureMessage=""},b=function(e){t.$emit("hideLoader"),t.DailogeState.failureMessage=e[0],t.DailogeState.successMessage=""};t.sendReservationCancellation=function(e){var a={type:"cancellation",locale:e};t.DailogeState.isGuestEmailSelected&&(a.primary_email=t.DailogeState.guestEmail),t.DailogeState.isBookerEmailSelected&&(a.booker_email=t.DailogeState.bookerEmail),!t.hasEmails()&&t.DailogeState.sendConfirmatonMailTo&&(a.primary_email=t.DailogeState.sendConfirmatonMailTo);var r={postData:a,reservationId:t.passData.reservationId};t.invokeApi(o.sendConfirmationEmail,r,R,b)};var N=function(){var e="portrait";$("head").append("<style id='print-orientation'>@page { size: "+e+"; }</style>")},P=function(){$("#print-orientation").remove()},k=function(){N(),$("header .logo").hide(),$("header .h2").hide();var e=function(){n(function(){$("header .logo").show(),$("header .h2").show(),P()},100)};n(function(){sntapp.cordovaLoaded?cordova.exec(e,function(){e()},"RVCardPlugin","printWebView",[]):(l.print(),e())},400),n(P,100)};t.printReservationCancellation=function(e){var a=function(e){t.printData=e.data,k()},r=function(e){t.DailogeState.failureMessage=e[0]};t.callAPI(d.fetchResservationCancellationPrintData,{successCallBack:a,failureCallBack:r,params:{reservation_id:t.passData.reservationId,locale:e}})},t.$on("PAYMENT_FAILED",function(e,a){t.errorMessage=a}),t.$on("CLOSE_DIALOG",t.closeReservationCancelModal),t.$on("PAYMENT_ACTION_CONTINUE",function(e,a){t.cancelReservation(a)}),t.shouldDisableSendCancellationEmailBtn=function(){return!t.DailogeState.isGuestEmailSelected&&!t.DailogeState.isBookerEmailSelected&&!t.DailogeState.sendConfirmatonMailTo},t.hasEmails=function(){return!!t.guestCardData.contactInfo.email||!!t.reservationData.reservation_card.booker_email}}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){sntRover.controller("RVReservationConfirmCtrl",["$scope","jsMappings","$state","RVReservationSummarySrv","ngDialog","RVContactInfoSrv","$filter","RVBillCardSrv","$q","RVHkRoomDetailsSrv","$vault","$rootScope","RVReservationGuestSrv","rvPermissionSrv","$timeout","$window",function(e,t,a,r,n,o,i,s,c,d,l,u,m,f,p,v){e.errorMessage="",BaseCtrl.call(this,e);var D=0;e.reservationStatus={confirmed:!1},u.setPrevState={title:i("translate")("RESERVATION_SUMMARY"),name:"rover.reservation.staycard.mainCard.summaryAndConfirm",param:{reservation:e.reservationData.isHourly?"HOURLY":"DAILY"}},e.hasPermissionToMakePayment=function(){return f.getPermissionValue("MAKE_PAYMENT")},e.hideMakePayment=function(){return!e.hasPermissionToMakePayment()};var h=function(t){e.$emit("hideLoader"),e.reservationData.languageData=t,y()},y=function(){e.refreshScroller("paymentInfo"),e.refreshScroller("reservationSummary")};e.addListener("REFRESH_SCROLL_SUMMARY",function(){y()});var g=function(){var t={reservation_id:e.reservationData.reservationId};e.invokeApi(o.fetchGuestLanguages,t,h)};e.init=function(){e.heading="Reservations",e.setHeadingTitle(e.heading),e.$parent.hideSidebar=!0,e.time={arrival:e.reservationData.checkinTime.hh+":"+e.reservationData.checkinTime.mm+" "+e.reservationData.checkinTime.ampm,departure:e.reservationData.checkoutTime.hh+":"+e.reservationData.checkoutTime.mm+" "+e.reservationData.checkoutTime.ampm},e.disableCheckin=!0,D=0,e.isConfirmationEmailSent=!(!e.otherData.isGuestPrimaryEmailChecked&&!e.otherData.isGuestAdditionalEmailChecked),e.setScroller("reservationSummary"),e.setScroller("paymentInfo"),N(),e.reservationData.enable_confirmation_custom_text=!1,g(),p(y,1e3)},e.getBillingInfoTitle=function(){return e.reservationData.is_routing_available?i("translate")("BILLING_INFO_TITLE"):i("translate")("ADD_BILLING_INFO_TITLE")},e.isCheckinTimeSet=function(){var t=!1;return""!==e.reservationData.checkinTime.hh&&""!==e.reservationData.checkinTime.mm&&""!==e.reservationData.checkinTime.ampm&&(t=!0),t},e.isCheckoutTimeSet=function(){var t=!1;return""!==e.reservationData.checkoutTime.hh&&""!==e.reservationData.checkoutTime.mm&&""!==e.reservationData.checkoutTime.ampm&&(t=!0),t},e.unflagConfirmation=function(){e.reservationStatus.confirmed=!1,u.setPrevState={title:i("translate")("RESERVATION_SUMMARY"),name:"rover.reservation.staycard.mainCard.summaryAndConfirm",param:{reservation:e.reservationData.isHourly?"HOURLY":"DAILY"}}},e.confirmationMailsSent=!1;var C=function(){var e="portrait";$("head").append("<style id='print-orientation'>@page { size: "+e+"; }</style>")},A=function(){$("#print-orientation").remove()},S=function(){C();var e=function(){p(A,100)};p(function(){sntapp.cordovaLoaded?cordova.exec(e,function(){e()},"RVCardPlugin","printWebView",[]):(v.print(),e())},100)};e.printData={};var I=function(t){e.printData=t.data,S()},T=function(t){e.errorMessage=t};e.printConfirmationReservation=function(){e.callAPI(r.fetchResservationConfirmationPrintData,{successCallBack:I,failureCallBack:T,params:{reservation_id:e.reservationData.reservationId}})},e.sendConfirmationClicked=function(t){var a=function(){e.confirmationMailsSent=!0;var t=[],a=angular.copy(e.reservationData.rooms);_.each(a,function(e,a){var r=[];_.each(e.accompanying_guest_details,function(e){_.each(e,function(e){(e.first_name||e.last_name)&&r.push(e)})}),t.push(r)});var r=function(){e.$emit("hideLoader"),u.setPrevState={title:i("translate")("CONFIRM_RESERVATION"),name:"rover.reservation.staycard.mainCard.reservationConfirm",param:{confirmationId:e.reservationData.confirmNum},callback:"unflagConfirmation",scope:e}},n=function(t){e.errorMessage=t,e.$emit("hideLoader")};_.each(e.reservationData.rooms,function(a,o){t[o].length>0&&e.invokeApi(m.updateGuestTabDetails,{accompanying_guests_details:t[o],reservation_id:e.reservationData.reservationIds&&e.reservationData.reservationIds[o]||e.reservationData.reservationId},r,n)}),"undefined"!=typeof u.searchData&&(u.searchData.guestCard.email=e.reservationData.guest.email)};if(e.confirmationMailsSent)a();else{if(!e.hotelDetails.send_confirmation_letter)return e.reservationStatus.confirmed=!0,a(),!1;if(!e.otherData.additionalEmail&&!e.reservationData.guest.email||!e.otherData.isGuestPrimaryEmailChecked&&!e.otherData.isGuestAdditionalEmailChecked)return e.reservationStatus.confirmed=!0,a(),!1;var n={};n.reservationId=e.reservationData.reservationId,n.tax_details=[],_.each(e.reservationData.taxDetails,function(e){n.tax_details.push(e)}),n.tax_total=e.reservationData.totalTax,e.reservationData.guest.email&&e.otherData.isGuestPrimaryEmailChecked&&(n.primary_email=e.reservationData.guest.email),e.otherData.additionalEmail&&e.otherData.isGuestAdditionalEmailChecked&&(n.booker_email=e.otherData.additionalEmail),e.reservationData.isHourly&&(n.reservation_ids=[],_.each(e.reservationData.reservations,function(e){n.reservation_ids.push(e.id)}));var o=function(t){e.reservationStatus.confirmed=!0,a(),e.$emit("hideLoader")};if(n.enable_confirmation_custom_text=e.reservationData.enable_confirmation_custom_text,n.confirmation_custom_title=e.reservationData.confirmation_custom_title,n.confirmation_custom_text=e.reservationData.confirmation_custom_text,n.locale=e.reservationData.languageData.selected_language_code,n.hide_rates=e.reservationData.hide_rates,e.reservationData.isHourly)e.invokeApi(r.sendHourlyConfirmationEmail,n,o);else{var s=e.reservationData.reservations;s&&s.length?s.forEach(function(t){
n.reservationId=t.id,e.invokeApi(r.sendConfirmationEmail,n,o)}):e.invokeApi(r.sendConfirmationEmail,n,o)}}},e.primaryEmailEntered=function(){if(""!==e.reservationData.guest.email&&null!==e.reservationData.guest.email)return!1;var t={email:e.reservationData.guest.sendConfirmMailTo},a={data:t,userId:e.reservationData.guest.id||e.reservationDetails.guestCard.id},r=function(t){e.reservationData.guest.email=e.reservationData.guest.sendConfirmMailTo,e.$emit("guestEmailChanged"),e.$emit("hideLoader")},n=function(t){e.$emit("hideLoader")};e.invokeApi(o.updateGuest,a,r,n)},e.goToStaycardClicked=function(){var t={id:e.reservationData.reservationId,confirmationId:e.reservationData.confirmNum,isrefresh:!0,justCreatedRes:!0};e.reservationData.reservationIds&&e.reservationData.reservationIds.splice(1),e.reservationData.rooms.splice(1),e.otherData.reservationCreated=!0,e.reservationData.rateDetails=[],a.go("rover.reservation.staycard.reservationcard.reservationdetails",t),u.$broadcast("reload-loyalty-section-data",{})},e.clickedNewReservation=function(){e.reservationData.roomCount=1,_.each(e.reservationData.rooms,function(e){e.rateId="",e.rateName="",e.rateAvg="",e.rateTotal=""}),e.reservationData.totalTaxAmount="",e.reservationData.totalTax="",e.reservationData.totalStayCost="",e.reservationData.guest.sendConfirmMailTo="";var t={type:{},ccDetails:{number:"",expMonth:"",expYear:"",nameOnCard:""}};e.reservationData.paymentType=t,e.reservationData.demographics={market:"",source:"",reservationType:"",origin:""},e.reservationData.promotion={promotionCode:"",promotionType:""},e.reservationData.reservationId="",e.reservationData.confirmNum="",e.reservationData.isSameCard=!0,e.otherData.reservationCreated=!0,_.each(e.reservationData.rooms,function(e){e.isOccupancyCheckAlerted=""}),e.reservationData.depositData=!1,a.go("rover.reservation.search")},e.gotoDiaryScreen=function(){e.reservationData={},e.initReservationDetails(),l.set("temporaryReservationDataFromDiaryScreen",JSON.stringify({})),a.go("rover.diary",{isfromcreatereservation:!1})},e.gotoNightlyDiary=function(){var t={origin:"RESERVATION_SUMMARY",reservation_id:e.reservationData.reservationId,room_id:e.reservationData.rooms[0].room_id};a.go("rover.nightlyDiary",t)};var E=function(t){e.$emit("hideLoader")},R=function(t){e.$emit("hideLoader")},b=function(e){"READY"===e.current_hk_status&&D++};e.enableCheckInButton=function(){return _.has(e.reservationData,"rooms")&&e.reservationData.rooms.length===D};var N=function(){var t,a=[];e.$emit("showLoader");for(var r=0;r<e.reservationData.rooms.length;r++)t=e.reservationData.rooms[r].room_id,t&&a.push(d.fetch(t).then(b));c.all(a).then(E,R)},P=function(t){e.$emit("hideLoader"),e.successMessage="Successful checking in."},k=function(t){e.$emit("hideLoader"),e.errorMessage=t};e.checkin=function(){var t=[],a=[],r=null;e.$emit("showLoader");for(var n=0;n<e.reservationData.rooms.length;n++)t.push(e.reservationData.rooms[n].confirm_no),r={reservation_id:e.reservationData.rooms[n].confirm_no},a.push(s.completeCheckin(r));c.all(a).then(P,k)},e.goToSearchClicked=function(){e.initReservationData(),a.go("rover.search","")},e.modifyCheckinCheckoutTime=function(){var t=function(t){e.$emit("hideLoader")},a=function(t){e.$emit("hideLoader")};if(""!==e.reservationData.checkinTime.hh&&""!==e.reservationData.checkoutTime.hh){var n=e.computeReservationDataforUpdate();n.addons=e.existingAddons,e.invokeApi(r.updateReservation,n,t,a)}},e.openBillingInformation=function(a){a?angular.forEach(e.reservationData.reservations,function(t,r){t.confirm_no===a&&(e.reservationData.confirm_no=t.confirm_no,e.reservationData.reservation_id=t.id,e.reservationData.reservation_status=t.status)}):(e.reservationData.confirm_no=e.reservationData.confirmNum,e.reservationData.reservation_id=e.reservationData.reservationId,e.reservationData.reservation_status=e.reservationData.status),null!==e.reservationData.guest.id?e.reservationData.user_id=e.reservationData.guest.id:e.reservationData.user_id=e.reservationData.company.id,e.$emit("showLoader"),t.fetchAssets(["addBillingInfo","directives"]).then(function(){e.$emit("hideLoader"),u.UPDATED_BI_ENABLED_ON.RESERVATION?(console.log("##Billing-info updated version"),n.open({template:"/assets/partials/billingInformation/reservation/rvBillingInfoReservationMain.html",controller:"rvBillingInfoReservationMainCtrl",className:"",scope:e})):(console.log("##Billing-info old version"),n.open({template:"/assets/partials/bill/rvBillingInformationPopup.html",controller:"rvBillingInformationPopupCtrl",className:"",scope:e}))})},e.setDemographics=function(){n.open({template:"/assets/partials/reservation/rvReservationDemographicsPopup.html",className:"ngdialog-theme-default",scope:e})},e.updateAdditionalDetails=function(){var t=function(t){e.$emit("hideLoader")},a=function(t){e.$emit("hideLoader"),e.errorMessage=t};e.errorMessage=[];var n=e.computeReservationDataforUpdate();n.reservationId=e.reservationData.reservationId,n.addons=e.existingAddons,e.invokeApi(r.updateReservation,n,t,a)},e.clickedShowRate=function(){var t=function(t){e.reservationData.hide_rates=!e.reservationData.hide_rates,e.$emit("hideLoader"),e.errorMessage=""},a=function(t){e.$emit("hideLoader"),e.errorMessage=t},r={reservation_id:e.reservationData.reservationId,hide_rates:!e.reservationData.hide_rates};e.invokeApi(s.toggleHideRate,r,t,a)},e.init(),e.watchEmailUpdate=function(){u.$broadcast("guest_email_updated",e.reservationData.guest.email)},e.enableConfirmationCustomText=function(){e.reservationData.enable_confirmation_custom_text=!e.reservationData.enable_confirmation_custom_text,e.refreshScroller("paymentInfo")},e.shouldShowAccompanyingGuests=function(e){return e.accompanying_guest_details&&(e.accompanying_guest_details.ADULT.length>0||e.accompanying_guest_details.CHILDREN.length>0||e.accompanying_guest_details.INFANTS.length>0)}}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){sntRover.controller("RVReservationDepositController",["$rootScope","$scope","$stateParams","RVPaymentSrv","$timeout","RVReservationCardSrv","$state","$filter","ngDialog","rvPermissionSrv","RVAutomaticEmailSrv",function(e,t,a,r,n,o,i,s,c,d,l){BaseCtrl.call(this,t),SharedMethodsBaseCtrl.call(this,t,e,l,c),t.pageloadingOver=!1,n(function(){t.pageloadingOver=!0},1e3);var u=function(){t.$$phase||t.$digest()};t.errorMessage="",t.showCancelCardSelection=!0,t.addmode=!1,t.referanceText="",t.showCCPage=!1,t.showAddtoGuestCard=!0,t.cardSelected=!1,t.isDisplayReference=!1,t.depositInProcess=!1,t.errorOccured=!1,t.errorMessage="",t.depositPaidSuccesFully=!1,t.successMessage="",t.authorizedCode="",t.swippedCard=!1,t.newCardAdded=!1,t.shouldShowWaiting=!1,t.isSwipedCardSave=!1,t.cardsList=[],t.$emit("UPDATE_STAY_CARD_DEPOSIT_FLAG",!0),t.depositData={selectedCard:-1,amount:"",viewCardsList:!1,existingCard:!1,cardId:"",cardNumber:"",expiry_date:"",card_type:"",isDisplayReference:!1,referanceText:"",addToGuestCard:!1},t.isReservationRateSuppressed=t.reservationData.reservation_card.is_rate_suppressed_present_in_stay_dates,t.depositData.paymentType=t.reservationData.reservation_card.payment_method_used?t.reservationData.reservation_card.payment_method_used:"",t.reservationData={},t.reservationData.depositAmount="",t.reservationData.depositPaymentAmount="",t.depositPolicyName="",t.reservationData.referanceText="",t.isDepositEditable=!!t.depositDetails.deposit_policy.allow_deposit_edit,t.rateCurrency=t.depositDetails.deposit_policy.rate_currency,t.depositPolicyName=t.depositDetails.deposit_policy.description,t.reservationData.depositAmount=parseFloat(t.depositDetails.deposit_amount).toFixed(2),t.reservationData.depositPaymentAmount=parseFloat(t.depositDetails.deposit_payment_amount).toFixed(2),t.closeDialog=function(){t.$emit("UPDATE_STAY_CARD_DEPOSIT_FLAG",!1),e.modalOpened=!1,n(function(){c.close()},250)},t.hasPermissionToMakePayment=function(){return d.getPermissionValue("MAKE_PAYMENT")},t.shouldHidePayNowButtonInPopUp=function(){var e=t.depositData.paymentType;t.reservationData;return""===e||null===e||!t.hasPermissionToMakePayment()},t.setScroller("cardsList",{click:!0,tap:!0});var m=function(){n(function(){t.refreshScroller("cardsList")},3e3)},f=function(){t.showCCPage=!0,t.swippedCard=!0,t.addmode=!(t.cardsList.length>0),t.addmode&&t.$broadcast("CLICK_ADD_NEW_CARD")};t.changeOnsiteCallIn=function(){t.isManual?f():"",m()},t.$on("changeOnsiteCallIn",function(e){t.isManual=!t.isManual,t.changeOnsiteCallIn()}),t.changePaymentType=function(){t.checkReferencetextAvailable(),"CC"===t.depositData.paymentType&&("sixpayments"===e.paymentGateway?"":f())},t.proceedCheckin=function(){t.closeDialog(),t.$emit("PROCEED_CHECKIN")},t.tryAgain=function(){t.depositInProcess=!1,t.errorMessage="",t.errorOccured=!1};var p=function(){var e=t.newPaymentInfo.tokenDetails.isSixPayment?getSixCreditCardType(t.newPaymentInfo.tokenDetails.card_type).toLowerCase():getCreditCardType(t.newPaymentInfo.cardDetails.cardType).toLowerCase();return e},v=function(){var e=t.newPaymentInfo.tokenDetails.isSixPayment?t.newPaymentInfo.tokenDetails.token_no.substr(t.newPaymentInfo.tokenDetails.token_no.length-4):t.newPaymentInfo.cardDetails.cardNumber.slice(-4);return e},D=function(){var e=t.newPaymentInfo.tokenDetails.isSixPayment?t.newPaymentInfo.tokenDetails.expiry.substring(2,4):t.newPaymentInfo.cardDetails.expiryMonth,a=t.newPaymentInfo.tokenDetails.isSixPayment?t.newPaymentInfo.tokenDetails.expiry.substring(0,2):t.newPaymentInfo.cardDetails.expiryYear,r=e+" / "+a;return r},h=function(){var e=t.newPaymentInfo.tokenDetails.isSixPayment?t.passData.details.firstName+" "+t.passData.details.lastName:t.newPaymentInfo.cardDetails.userName;return e};t.feeData={};var y=parseFloat("0.00");t.isShowFees=function(){var e=!1,a=t.feeData;return"undefined"==typeof a||"undefined"==typeof a.feesInfo||null===a.feesInfo?e=!1:a.defaultAmount>=a.minFees&&t.isStandAlone&&a.feesInfo.amount&&(e=!0),e},t.calculateFee=function(){if(t.isStandAlone){var e=t.feeData.feesInfo,a="",r=y,n=y;"undefined"!=typeof e&&null!==e&&(a=e.amount_symbol,r=e.amount?parseFloat(e.amount):y,n=e.minimum_amount_for_fees?parseFloat(e.minimum_amount_for_fees):y);var o=""===t.reservationData.depositAmount?y:parseFloat(t.reservationData.depositAmount);if(t.feeData.minFees=n,t.feeData.defaultAmount=o,t.isShowFees())if("percent"===a){var i=parseFloat(o*(r/100));t.feeData.calculatedFee=parseFloat(i).toFixed(2),t.feeData.totalOfValueAndFee=parseFloat(i+o).toFixed(2)}else t.feeData.calculatedFee=parseFloat(r).toFixed(2),t.feeData.totalOfValueAndFee=parseFloat(o+r).toFixed(2)}},t.setupFeeData=function(){var e=t.feeData.feesInfo?t.feeData.feesInfo:{},a=t.reservationData?parseFloat(t.reservationData.depositAmount):y,r=e.minimum_amount_for_fees?parseFloat(e.minimum_amount_for_fees):y;if(t.feeData.minFees=r,t.feeData.defaultAmount=a,t.isShowFees()&&"undefined"!=typeof e.amount&&null!==e){var n=e.amount_symbol,o=e.amount?parseFloat(e.amount):y;t.feeData.actualFees=o,"percent"===n?t.calculateFee():(t.feeData.calculatedFee=parseFloat(o).toFixed(2),t.feeData.totalOfValueAndFee=parseFloat(o+a).toFixed(2))}},t.calculateTotalAmount=function(e){var a="undefined"==typeof t.feeData.calculatedFee||""===t.feeData.calculatedFee||"-"===t.feeData.calculatedFee?y:parseFloat(t.feeData.calculatedFee),r="undefined"==typeof e||""===e?y:parseFloat(e);t.feeData.totalOfValueAndFee=parseFloat(r+a).toFixed(2)},t.isStandAlone&&(t.feeData.feesInfo=t.passData.fees_information,t.setupFeeData()),t.isReservationDeposit=!0,t.renderData={},t.renderData.paymentTypes=t.passData.details.paymentTypes,t.checkReferencetextAvailable=function(){angular.forEach(t.passData.details.paymentTypes,function(e,a){e.name===t.depositData.paymentType&&("CC"!==t.depositData.paymentType?(t.isDisplayReference=!!e.is_display_reference,"CC"!==e.name&&(t.feeData.feesInfo=e.charge_code.fees_information),t.setupFeeData()):angular.forEach(t.passData.details.creditCardTypes,function(e,a){t.depositData.card_type.toUpperCase()===e.cardcode&&(t.isDisplayReference=!!e.is_display_reference)}))})};var g=function(e){var a=t.depositDetails.attached_card;t.depositData.selectedCard=a.value,t.depositData.cardNumber=a.ending_with,t.depositData.expiry_date=a.expiry_date,t.depositData.card_type=a.card_code.toLowerCase(),t.cardSelected=!0,t.depositData.paymentType="CC"};"undefined"!=typeof t.depositDetails.attached_card&&""!==t.depositDetails.attached_card.value&&t.depositDetails.attached_card.is_credit_card&&g(t.depositDetails.attached_card.value);var C=function(e){var a=t.newPaymentInfo.tokenDetails.isSixPayment?t.newPaymentInfo.tokenDetails.expiry.substring(2,4):t.newPaymentInfo.cardDetails.expiryMonth,n=t.newPaymentInfo.tokenDetails.isSixPayment?t.newPaymentInfo.tokenDetails.expiry.substring(0,2):t.newPaymentInfo.cardDetails.expiryYear,o=a&&n?"20"+n+"-"+a+"-01":"",i=t.newPaymentInfo.tokenDetails.isSixPayment?t.newPaymentInfo.tokenDetails.token_no:t.newPaymentInfo.tokenDetails.session,s=function(a){t.$emit("hideLoader"),"undefined"==typeof e&&(t.depositData.selectedCard=a.id,t.depositData.cardNumber=v(),t.depositData.expiry_date=D(),t.depositData.card_type=p(),t.swippedCard=!1,t.showCCPage=!1,t.cardSelected=!0,t.isStandAlone&&(t.feeData.feesInfo=a.fees_information,t.setupFeeData())),t.newCardAdded=!0,"undefined"!=typeof e&&(t.$parent.reservationData.reservation_card.payment_method_used="CC",t.$parent.reservationData.reservation_card.payment_details.card_number=angular.copy(t.depositData.cardNumber),t.$parent.reservationData.reservation_card.payment_details.card_expiry=angular.copy(t.depositData.expiry_date),t.$parent.reservationData.reservation_card.payment_details.card_type_image="images/"+angular.copy(t.depositData.card_type.toLowerCase())+".png")},c={add_to_guest_card:t.newPaymentInfo.cardDetails.addToGuestCard,name_on_card:h(),payment_type:"CC",token:i};"undefined"!=typeof e&&(c.reservation_id=t.passData.reservationId),c.card_code=t.newPaymentInfo.tokenDetails.isSixPayment?getSixCreditCardType(t.newPaymentInfo.tokenDetails.card_type).toLowerCase():t.newPaymentInfo.cardDetails.cardType,t.newPaymentInfo.tokenDetails.isSixPayment||(c.card_expiry=o),t.depositData.isDisplayReference&&(c.referance_text=t.depositData.referanceText),t.invokeApi(r.savePaymentDetails,c,s)},A=function(e){t.$emit("hideLoader"),t.cardsList=_.where(e.existing_payments,{is_credit_card:!0}),t.cardsList.forEach(function(e){e.mli_token=e.ending_with,delete e.ending_with,e.card_expiry=e.expiry_date,delete e.expiry_date}),t.cardsList.length>0&&(t.addmode=!1,m())},S=a.id;t.invokeApi(r.getPaymentList,S,A);var I=function(a,r){t.$emit("hideLoader"),t.successMessage="Deposit paid",t.authorizedCode=a.authorization_code,t.errorOccured=!1,t.depositPaidSuccesFully=!0,t.isLoading=!1,t.$parent.reservationData.reservation_card.deposit_attributes.outstanding_stay_total=parseInt(t.$parent.reservationData.reservation_card.deposit_attributes.outstanding_stay_total)-parseInt(t.$parent.depositDetails.deposit_amount),u();var n="";if(t.depositData.addToGuestCard&&t.newCardAdded){n=t.isSwipedCardSave?t.swipedCardHolderName:t.newPaymentInfo.tokenDetails.isSixPayment?t.passData.details.firstName+" "+t.passData.details.lastName:t.newPaymentInfo.cardDetails.userName;var o=t.depositData.card_type,i=t.depositData.cardNumber,s={card_code:o,mli_token:i,card_expiry:t.depositData.expiry_date,card_name:n,id:t.depositData.selectedCard,isSelected:!0,is_primary:!1,payment_type:"CC",payment_type_id:1,is_credit_card:!0};t.cardsList.push(s),e.$broadcast("ADDEDNEWPAYMENTTOGUEST",s)}if("undefined"!=typeof r){var c=a.payment_method;t.newPaymentInfo={tokenDetails:{isSixPayment:!0}},t.depositData.cardNumber=c.ending_with,t.depositData.expiry_date=c.expiry_date,t.newPaymentInfo.tokenDetails.session=c.session,t.depositData.selectedCard=c.id,t.depositData.card_type=c.card_type}"CC"!==t.$parent.reservationData.reservation_card.payment_method_used&&"DB"!==t.$parent.reservationData.reservation_card.payment_method_used&&"CC"===t.depositData.paymentType&&(t.$parent.reservationData.reservation_card.payment_method_used="CC",t.$parent.reservationData.reservation_card.payment_details.card_number=angular.copy(t.depositData.cardNumber),t.$parent.reservationData.reservation_card.payment_details.card_expiry=angular.copy(t.depositData.expiry_date),t.$parent.reservationData.reservation_card.payment_details.card_type_image="images/"+angular.copy(t.depositData.card_type.toLowerCase())+".png"),e.$broadcast("UPDATE_DEPOSIT_BALANCE",a),e.$broadcast("UPDATERESERVATIONTYPE",a.reservation_type_id)},T=function(e){t.$emit("hideLoader"),t.paymentErrorMessage=e[0],t.errorOccured=!0,t.depositPaidSuccesFully=!1,t.isLoading=!1};t.$on("AUTO_TRIGGER_EMAIL_AFTER_PAYMENT",function(e,a){t.guestCardData.contactInfo.email=a,t.sendAutomaticEmails(a)}),e.$on("GIFTCARD_DETAILS",function(e,a){t.cardData.cardNumber=a}),t.submitPayment=function(){if(""===t.reservationData.depositAmount||null===t.reservationData.depositAmount)t.errorMessage=["Please enter amount"];else{t.errorMessage="",t.depositInProcess=!0;var n={postData:{bill_number:1,payment_type:t.depositData.paymentType,amount:t.reservationData.depositAmount,payment_type_id:"CC"===t.depositData.paymentType&&t.depositData.selectedCard!==-1?t.depositData.selectedCard:null},reservation_id:a.id};t.newCardAdded?n.postData.add_to_guest_card=t.depositData.addToGuestCard:n.postData.add_to_guest_card=!1,"GIFT_CARD"===t.depositData.paymentType&&(delete n.postData.payment_type_id,n.postData.card_number=t.cardData.cardNumber),t.isShowFees()&&(t.feeData.calculatedFee&&(n.postData.fees_amount=t.feeData.calculatedFee),t.feeData.feesInfo&&(n.postData.fees_charge_code_id=t.feeData.feesInfo.charge_code_id)),t.isDisplayReference&&(n.postData.reference_text=t.reservationData.referanceText),t.isLoading=!0,"sixpayments"!==e.paymentGateway||t.isManual||"CC"!==t.depositData.paymentType?t.invokeApi(r.submitPaymentOnBill,n,I,T):(n.postData.is_emv_request=!0,t.shouldShowWaiting=!0,n.postData.reservation_id=a.id,r.submitPaymentOnBill(n).then(function(e){t.shouldShowWaiting=!1;var a=!0;t.newCardAdded=!0,I(e,a)},function(e){t.shouldShowWaiting=!1,T(e)}))}},t.payDeposit=function(){t.submitPayment()},t.onCardClick=function(){t.showAddtoGuestCard=!1,t.showCCPage=!0,t.swippedCard=!0,t.addmode=!(t.cardsList.length>0),m()},t.showAddtoGuestCardBox=function(){return!(!t.cardSelected||t.showCCPage||"CC"!==t.depositData.paymentType||"sixpayments"===t.paymentGateway&&!t.isManual||t.depositPaidSuccesFully||t.errorOccured||!t.newCardAdded)},t.isNewCard=function(){var e=!0;for(var a in t.cardsList)t.depositData.cardNumber===t.cardsList[a].mli_token&&(e=!1);return e},t.showSelectedCard=function(){var e=!1;return e=!(!t.cardSelected||t.showCCPage||"CC"!==t.depositData.paymentType||"sixpayments"===t.paymentGateway&&!t.isManual),e&&(!t.showCCPage&&"CC"===t.depositData.paymentType&&t.newCardAdded||(t.showAddtoGuestCard=!1),"CC"===t.depositData.paymentType&&t.isNewCard()?t.showAddtoGuestCard=!0:t.showAddtoGuestCard=!1),e};var E=function(e){t.depositData.selectedCard=t.cardsList[e].value,t.depositData.cardNumber=t.cardsList[e].mli_token,t.depositData.expiry_date=t.cardsList[e].card_expiry,t.depositData.card_type=t.cardsList[e].card_code,t.swippedCard=!1,t.showCCPage=!1,t.cardSelected=!0,t.isStandAlone&&(t.feeData.feesInfo=t.cardsList[e].fees_information,t.setupFeeData()),t.newCardAdded=!1};t.$on("TOKEN_CREATED",function(e,a){t.newPaymentInfo=a,t.showCCPage=!1,t.swippedCard=!1,t.cardSelected=!1,C()}),t.$on("MLI_ERROR",function(e,a){t.errorMessage=a,setTimeout(function(){t.errorMessage="",t.$digest()},4e3)}),t.$on("cancelCardSelection",function(e,a){t.swippedCard=!1,t.showCCPage=!1,t.depositData.paymentType="",t.isManual=!1}),t.$on("cardSelected",function(e,t){E(t.index)}),t.$on("SHOW_SWIPED_DATA_ON_STAY_CARD_DEPOSIT_SCREEN",function(e,a){t.swippedCard=!0,t.showCCPage=!0,t.addmode=!0,t.depositData.paymentType="CC",t.swipedCardHolderName=a.nameOnCard,u(),t.$broadcast("RENDER_SWIPED_DATA",a)}),t.$on("SWIPED_DATA_TO_SAVE",function(e,a){var n=a;n.payment_credit_type=a.cardType,n.credit_card=a.cardType,n.card_expiry="20"+a.cardExpiryYear+"-"+a.cardExpiryMonth+"-01",n.add_to_guest_card=a.addToGuestCard,t.isSwipedCardSave=!0;var o={params:n,successCallBack:R,successCallBackParameters:a};t.callAPI(r.savePaymentDetails,o)});var R=function(e,a){t.$emit("hideLoader"),t.depositData.selectedCard=e.id,t.depositData.cardNumber=a.cardNumber.slice(-4),t.depositData.expiry_date=a.cardExpiryMonth+"/"+a.cardExpiryYear,t.depositData.card_type=a.cardType.toLowerCase(),t.showCCPage=!1,t.swippedCard=!1,t.cardSelected=!0};t.checkReferencetextAvailable(),t.showDepositNotice=function(){return!!(t.showCCPage||t.depositInProcess||t.depositPaidSuccesFully)&&(t.isStandAlone&&0===t.cardsList.length&&t.$broadcast("CLICK_ADD_NEW_CARD"),!0)}}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){sntRover.controller("RVReservationMainCardCtrl",["$scope",function(e){e.viewState.searching=!1}])},{}]},{},[1]);var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};!function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){sntRover.controller("RVReservationMainCtrl",["$scope","$rootScope","ngDialog","$filter","RVCompanyCardSrv","$state","dateFilter","baseSearchData","RVReservationSummarySrv","RVReservationCardSrv","RVPaymentSrv","$timeout","$stateParams","RVReservationGuestSrv","RVReservationStateService","RVReservationDataService","$interval","$log","$q","RVContactInfoSrv","RVRoomRatesSrv","rvUtilSrv","rvPermissionSrv",function(e,t,a,r,n,o,i,s,c,d,l,u,m,f,p,v,D,h,y,g,C,A,S){BaseCtrl.call(this,e),e.$emit("updateRoverLeftMenu","createReservation");var I=r("translate")("RESERVATION_TITLE");e.setTitle(I);var T=this,E="rover.reservation.staycard.mainCard.room-rates",R=470;e.hasOverBookRoomTypePermission=S.getPermissionValue("OVERBOOK_ROOM_TYPE"),e.hasOverBookHousePermission=S.getPermissionValue("OVERBOOK_HOUSE"),e.hasBorrowFromHousePermission=S.getPermissionValue("GROUP_HOUSE_BORROW"),e.heading="Reservations",e.viewState={currentTab:0,isAddNewCard:!1,pendingRemoval:{status:!1,cardType:""},identifier:"CREATION",lastCardSlot:"",reservationStatus:{confirm:!1,number:null}},e.clearArrivalAndDepartureTime=function(){e.reservationData.checkinTime=v.getTimeModel(),e.reservationData.checkoutTime=v.getTimeModel()},e.otherData={},e.addonsData={},e.addonsData.existingAddons=[],e.initreverseCheckoutDetails=function(){e.reverseCheckoutDetails={data:{is_reverse_checkout_failed:!1,errormessage:""}}},e.initreverseCheckoutDetails(),e.initReservationData=function(){p.bookMark.lastPostedRate=null,e.hideSidebar=!1,e.addonsData.existingAddons=[],e.reservationData=v.getReservationDataModel(),e.searchData=v.getSearchDataModel();var t=5,a=s.settings.max_guests,r=parseInt(s.settings.max_room_quantity,10)||5;e.otherData.taxesMeta=[],e.otherData.promotionTypes=[{value:"v1",description:"The first"},{value:"v2",description:"The Second"}],e.otherData.maxAdults=null===a.max_adults||""===a.max_adults?t:a.max_adults,e.otherData.maxChildren=null===a.max_children||""===a.max_children?t:a.max_children,e.otherData.maxInfants=null===a.max_infants||""===a.max_infants?t:a.max_infants,e.otherData.maxRoomCount=r,e.otherData.roomTypes=s.roomTypes,e.reservationData.roomsMeta={},_.each(s.roomTypes,function(t){e.reservationData.roomsMeta[t.id]=t}),e.otherData.fromSearch=!1,e.otherData.recommendedRateDisplay=s.settings.recommended_rate_display,e.otherData.defaultRateDisplayName=s.settings.default_rate_display_name,e.otherData.businessDate=s.businessDate,e.otherData.additionalEmail="",e.otherData.isGuestPrimaryEmailChecked=!1,e.otherData.isGuestAdditionalEmailChecked=!1,e.otherData.reservationCreated=!1,e.otherData.marketIsForced=s.settings.force_market_code,e.otherData.sourceIsForced=s.settings.force_source_code,e.otherData.originIsForced=s.settings.force_origin_of_booking,e.otherData.reservationTypeIsForced=s.settings.force_reservation_type,e.otherData.segmentsIsForced=s.settings.force_segments,e.otherData.forceAdjustmentReason=s.settings.force_rate_adjustment_reason,e.otherData.showOverbookingAlert=s.settings.show_overbooking_alert,e.otherData.isAddonEnabled=s.settings.is_addon_on,e.otherData.booking_max_stay_length=s.settings.max_stay_length||92,e.guestCardData={},e.guestCardData.cardHeaderImage="/ui/pms-ui/images/avatar-trans.png",e.guestCardData.contactInfo={},e.guestCardData.userId="",e.guestCardData.contactInfo.birthday="",e.reservationListData={},e.reservationDetails=v.getReservationDetailsModel()},e.initReservationDetails=function(){e.reservationDetails=v.getReservationDetailsModel(),e.viewState={currentTab:0,isAddNewCard:!1,pendingRemoval:{status:!1,cardType:""},identifier:"CREATION",lastCardSlot:"",reservationStatus:{confirm:!1,number:null}}};var b=function(t){var a=!0;return"undefined"!=typeof e.reservationData.rateDetails[t]&&_.each(e.reservationData.rateDetails[t],function(r,n){if(n!==e.reservationData.departureDate&&""!==e.reservationData.rooms[t].stayDates[n].rate.id&&0!==parseFloat(e.reservationData.rooms[t].stayDates[n].rateDetails.actual_amount)){var o=r[e.reservationData.rooms[t].stayDates[n].rate.id]?r[e.reservationData.rooms[t].stayDates[n].rate.id].rateBreakUp:null,i=parseInt(e.reservationData.rooms[t].stayDates[n].guests.adults),s=parseInt(e.reservationData.rooms[t].stayDates[n].guests.children);o&&null===o.single&&null===o.double&&null===o.extra_adult&&null===o.child?a=!1:o&&(s>0&&null===o.child?a=!1:1===i&&null===o.single?a=!1:i>=2&&null===o.double?a=!1:i>2&&null===o.extra_adult&&(a=!1))}}),a};e.checkOccupancyLimit=function(t,r,n,i){if(e.reservationData.isHourly)return!1;var s=n||0;if(b(s)){e.reservationData.rooms[s].varyingOccupancy=v.isVaryingOccupancy(e.reservationData.rooms[s].stayDates,e.reservationData.arrivalDate,e.reservationData.departureDate,e.reservationData.numNights),r&&e.saveReservation(!1,!1,s);var c=e.reservationData.rooms[s].roomTypeId,d=parseInt(e.reservationData.rooms[s].numChildren)+parseInt(e.reservationData.rooms[s].numAdults);t&&(d=parseInt(e.reservationData.rooms[s].stayDates[t].guests.adults)+parseInt(e.reservationData.rooms[s].stayDates[t].guests.children));var l=function(t){var a=-1,r="";return $(e.otherData.roomTypes).each(function(e,n){parseInt(t)===n.id&&(a=n.max_occupancy,r=n.name)}),{max:a,name:r}};!c&&i&&(c=i);var u=l(c);return"undefined"==typeof c||null===c||""===c||null===u.max||u.max>=d||(e.reservationData.rooms[s].isOccupancyCheckAlerted&&e.reservationData.rooms[s].isOccupancyCheckAlerted===c||"rover.reservation.staycard.reservationcard.reservationdetails"===o.current.name||(a.open({template:"/assets/partials/reservation/alerts/occupancy.html",className:"ngdialog-theme-default",scope:e,closeByDocument:!1,closeByEscape:!1,data:JSON.stringify({roomType:u.name,roomMax:u.max})}),e.reservationData.rooms[s].isOccupancyCheckAlerted=c),!0)}a.open({template:"/assets/partials/reservation/alerts/notConfiguredOccupancy.html",className:"ngdialog-theme-default",scope:e,closeByDocument:!1,closeByEscape:!1,data:JSON.stringify({roomIndex:s})})},e.resetRoomSelection=function(t){e.editRoomRates(t),e.closeDialog()},e.editRoomRates=function(t){e.reservationData.rooms[t].roomTypeId="",e.reservationData.rooms[t].roomTypeName="",e.reservationData.rooms[t].rateId="",e.reservationData.rooms[t].rateName="",e.reservationData.demographics={market:"",source:"",reservationType:"",origin:""};for(var a=1*new tzIndependentDate(e.reservationData.arrivalDate),r=1*new tzIndependentDate(e.reservationData.departureDate);a<=r;a+=864e5)e.reservationData.rooms[t].stayDates[i(new tzIndependentDate(a),"yyyy-MM-dd")].rate={id:""};o.go(E,{from_date:e.reservationData.arrivalDate,to_date:e.reservationData.departureDate,fromState:"rover.reservation.search",company_id:e.reservationData.company.id,travel_agent_id:e.reservationData.travelAgent.id})},e.updateOccupancy=function(t){for(var a=1*new tzIndependentDate(e.reservationData.arrivalDate),r=1*new tzIndependentDate(e.reservationData.departureDate);a<=r;a+=864e5)e.reservationData.rooms[t].stayDates[i(new tzIndependentDate(a),"yyyy-MM-dd")].guests={adults:parseInt(e.reservationData.rooms[t].numAdults),children:parseInt(e.reservationData.rooms[t].numChildren),infants:parseInt(e.reservationData.rooms[t].numInfants)}},e.populateDataModel=function(t){var a=v.parseReservationData(t.reservation_card,e.reservationListData);_.extend(e.reservationData,a.reservationData),e.reservationData.paymentMethods=t.paymentMethods,e.isManual=a.isManual,e.reservationEditMode=a.reservationEditMode,e.showSelectedCreditCard=a.showSelectedCreditCard,e.renderData=a.renderData},e.stayDatesClicked=function(){var t=o.current.name;o.go(E,{from_date:e.reservationData.arrivalDate,to_date:e.reservationData.departureDate,view:"DEFAULT",fromState:t,company_id:e.reservationData.company.id,travel_agent_id:e.reservationData.travelAgent.id,group_id:e.reservationData.group.id})},e.$on("guestEmailChanged",function(t){e.$broadcast("updateGuestEmail")}),e.validateOccupant=function(e,t){if(e){var a=parseInt(e.numAdults),r=parseInt(e.numChildren);"adult"!==t&&"numAdults"!==t||0!==a||0!==r?"children"!==t&&"numChildren"!==t||0!==r||0!==a||(e.numAdults=1):e.numChildren=1}},e.initReservationData(),e.$on("REFRESHACCORDIAN",function(){e.$broadcast("GETREFRESHACCORDIAN")}),e.$on("PROMPTCARD",function(){e.$broadcast("PROMPTCARDENTRY")}),e.callFromChildCtrl=function(t){e.otherData.marketsEnabled=t.demographics.is_use_markets,e.otherData.markets=t.demographics.markets,e.otherData.sourcesEnabled=t.demographics.is_use_sources,e.otherData.sources=t.demographics.sources,e.otherData.originsEnabled=t.demographics.is_use_origins,e.otherData.origins=t.demographics.origins,e.otherData.reservationTypes=t.demographics.reservationTypes,e.otherData.segmentsEnabled=t.demographics.is_use_segments,e.otherData.segments=t.demographics.segments};var N=function(r,n,o){var i=tzIndependentDate(Object.keys(r.stayDates)[0]),s=tzIndependentDate(t.businessDate),c=Object.keys(r.stayDates)[0];i<s&&(c=t.businessDate);var d=JSON.stringify({room:r,index:n,lastReason:o,showDate:c});e.isDateEqual=function(e,t){return Date.parse(e)===Date.parse(t)},e.getObjectLength=function(e){return getObjectLength(e)},a.open({template:"/assets/partials/reservation/rvEditRates.html",className:"ngdialog-theme-default",scope:e,closeByDocument:!1,controller:"RVEditRatesCtrl",closeByEscape:!1,data:d})},P=function(e,t){var a=t.room,r=t.index,n=e.reason;N(a,r,n)},k=function(t,a){var r={reservation_id:e.reservationData.reservationId},n={params:r,successCallBack:P,successCallBackParameters:{
room:t,index:a}};e.callAPI(d.getLastRateAdjustmentReason,n)};e.editReservationRates=function(e,t){k(e,t)};var O=function(t,a){t||(a.payment_type={},null!==e.reservationData.paymentType.type.value&&(angular.forEach(e.reservationData.paymentMethods,function(t,r){e.reservationData.paymentType.type.value===t.name&&("CC"===e.reservationData.paymentType.type.value?a.payment_type.payment_method_id=e.reservationData.selectedPaymentId:a.payment_type.type_id=t.id)}),a.payment_type.expiry_date=""===e.reservationData.paymentType.ccDetails.expYear||""===e.reservationData.paymentType.ccDetails.expYear?"":"20"+e.reservationData.paymentType.ccDetails.expYear+"-"+e.reservationData.paymentType.ccDetails.expMonth+"-01",a.payment_type.card_name=e.reservationData.paymentType.ccDetails.nameOnCard))},w=function(t,a){t||(a.confirmation_emails=[],e.otherData.isGuestPrimaryEmailChecked&&""!==e.reservationData.guest.email&&a.confirmation_emails.push(e.reservationData.guest.email),e.otherData.isGuestAdditionalEmailChecked&&""!==e.otherData.additionalEmail&&a.confirmation_emails.push(e.otherData.additionalEmail))},M=function(t){t.company_id=e.reservationData.company.id||e.reservationData.group.company||e.reservationData.allotment.company,t.travel_agent_id=e.reservationData.travelAgent.id||e.reservationData.group.travelAgent||e.reservationData.allotment.travelAgent,"RATE"!==C.getRoomAndRateActiveTab()&&(t.group_id=e.reservationData.group.id),t.allotment_id=e.reservationData.allotment.id},L=function(e,t){e.reservation_type_id=parseInt(t.reservationType),e.source_id=parseInt(t.source),e.market_segment_id=parseInt(t.market),e.booking_origin_id=parseInt(t.origin),e.segment_id=parseInt(t.segment)},x=function(t,a){angular.forEach(e.reservationData.tabs,function(r,n){var o=_.indexOf(e.reservationData.rooms,_.findWhere(e.reservationData.rooms,{roomTypeId:parseInt(r.roomTypeId,10)})),i=[];(p.getReservationFlag("RATE_CHANGED")||!e.reservationData.rooms[o].is_package_exist||e.reservationData.rooms[o].is_package_exist&&e.reservationData.rooms[o].addons.length===parseInt(e.reservationData.rooms[o].package_count))&&(n===e.reservationData.tabs.length-1&&p.setReservationFlag("RATE_CHANGED",!1),_.each(e.reservationData.rooms[o].addons,function(e){e.is_rate_addon||i.push({id:e.id,selected_post_days:e.selected_post_days,start_date:e.start_date,end_date:e.end_date,quantity:e.quantity||1})})),a&&t.room_types.push({id:parseInt(r.roomTypeId,10),num_rooms:parseInt(r.roomCount,10),addons:i})})},F=function(t,a){t.room_id=[],angular.forEach(e.reservationData.rooms,function(e,r){"undefined"!=typeof a&&r!==a||(e.room_id=""!==e.room_id?e.room_id:null,t.room_id.push(e.room_id))})},B=function(e,t){var a="";return e.stayDates&&t&&(a=e.stayDates[t].rate.id),a},G=function(t,a){var r=[],n="";if(_.each(a.stayDates,function(o,i){n=e.reservationData.inHouse?o.roomTypeId||"":a.roomTypeId;var s=o,c=String(s.rate.id).match(/_CUSTOM_/)?null:s.rate.id;c=""===c?B(a,t.arrival_date):c,r.push({date:i,rate_id:c,room_type_id:n,room_id:e.reservationData.inHouse?o.roomId:a.room_id,adults_count:parseInt(s.guests.adults),children_count:parseInt(s.guests.children),infants_count:parseInt(s.guests.infants),rate_amount:parseFloat(s.rateDetails&&s.rateDetails.modified_amount||0),contract_id:null===c?null:s.contractId})}),e.reservationData.inHouse){var o=r[r.length-1].date;r[r.length-1]=JSON.parse(JSON.stringify(r[r.length-2])),r[r.length-1].date=o}return r},V=function(t,a,r){e.reservationData.rateDetails&&e.reservationData.rateDetails[a]&&e.reservationData.rateDetails[a][e.reservationData.arrivalDate][r]&&e.reservationData.rateDetails[a][e.reservationData.arrivalDate][r].applyPromotion?(t.promotion_id=e.reservationData.rateDetails[a][e.reservationData.arrivalDate][r].appliedPromotion.id,t.promotion_status=_.findWhere(e.reservationData.rateDetails[a][e.reservationData.arrivalDate][r].restrictions,{key:"INVALID_PROMO"})?"OVERRIDE":"VALID"):t.promotion_id=e.reservationData.promotionId};e.getReservationDataforUpdate=function(t,a,r){var n={},i="rover.reservation.staycard.reservationcard.reservationdetails"===o.current.name,s=!i&&!e.reservationData.isHourly;n.is_hourly=e.reservationData.isHourly,n.arrival_date=e.reservationData.arrivalDate,n.arrival_time="",n.is_reinstate="REINSTATE"===e.viewState.identifier,""!==e.reservationData.checkinTime.hh&&""!==e.reservationData.checkinTime.mm&&""!==e.reservationData.checkinTime.ampm&&(n.arrival_time=getTimeFormated(e.reservationData.checkinTime.hh,e.reservationData.checkinTime.mm,e.reservationData.checkinTime.ampm)),n.departure_date=e.reservationData.departureDate,n.departure_time="",""!==e.reservationData.checkoutTime.hh&&""!==e.reservationData.checkoutTime.mm&&""!==e.reservationData.checkoutTime.ampm&&(n.departure_time=getTimeFormated(e.reservationData.checkoutTime.hh,e.reservationData.checkoutTime.mm,e.reservationData.checkoutTime.ampm)),n.adults_count=parseInt(e.reservationData.rooms[r].numAdults),n.children_count=parseInt(e.reservationData.rooms[r].numChildren),n.infants_count=parseInt(e.reservationData.rooms[r].numInfants),n.room_type_id=parseInt(e.reservationData.rooms[r].roomTypeId),n.guest_detail={},n.guest_detail.id=""===e.reservationData.guest.id?null:e.reservationData.guest.id,n.guest_detail_id=n.guest_detail.id,n.guest_detail.first_name=e.reservationData.guest.firstName,n.guest_detail.last_name=e.reservationData.guest.lastName,n.guest_detail.email=e.reservationData.guest.email,O(t,n),n.tax_details=[],_.each(e.reservationData.taxDetails,function(e){n.tax_details.push(e)}),n.tax_total=e.reservationData.totalTaxAmount,w(a,n);var c=[];n.room_id=[];var d=e.reservationData.rooms[r],l=d.stayDates[e.reservationData.arrivalDate].rate.id;V(n,r,l),p.bookMark.lastPostedRate=d.stayDates[e.reservationData.arrivalDate].rate.id,c.push(G(n,d)),n.stay_dates=c,M(n);var u=e.reservationData.demographics;return"undefined"!=typeof r&&(u=e.reservationData.rooms[r].demographics),void 0!==("undefined"==typeof u?"undefined":_typeof(u))&&L(n,u),n.confirmation_email=e.reservationData.guest.sendConfirmMailTo,n.room_id=[],s&&(n.room_types=[]),x(n,s),F(n,r),n.borrow_for_groups=p.getReservationFlag("borrowForGroups"),n},e.computeReservationDataforUpdate=function(t,a,r){var n={},i="rover.reservation.staycard.reservationcard.reservationdetails"===o.current.name,s=!i&&"undefined"==typeof r;n.is_hourly=e.reservationData.isHourly,n.arrival_date=e.reservationData.arrivalDate,n.arrival_time="",n.is_reinstate="REINSTATE"===e.viewState.identifier,""!==e.reservationData.checkinTime.hh&&""!==e.reservationData.checkinTime.mm&&""!==e.reservationData.checkinTime.ampm&&(n.arrival_time=getTimeFormated(e.reservationData.checkinTime.hh,e.reservationData.checkinTime.mm,e.reservationData.checkinTime.ampm)),n.departure_date=e.reservationData.departureDate,n.departure_time="",""!==e.reservationData.checkoutTime.hh&&""!==e.reservationData.checkoutTime.mm&&""!==e.reservationData.checkoutTime.ampm&&(n.departure_time=getTimeFormated(e.reservationData.checkoutTime.hh,e.reservationData.checkoutTime.mm,e.reservationData.checkoutTime.ampm)),n.adults_count=parseInt(e.reservationData.rooms[0].numAdults),n.children_count=parseInt(e.reservationData.rooms[0].numChildren),n.infants_count=parseInt(e.reservationData.rooms[0].numInfants),n.room_type_id=parseInt(e.reservationData.rooms[0].roomTypeId),n.guest_detail={},n.guest_detail.id=""===e.reservationData.guest.id?null:e.reservationData.guest.id,n.guest_detail_id=n.guest_detail.id,n.guest_detail.first_name=e.reservationData.guest.firstName,n.guest_detail.last_name=e.reservationData.guest.lastName,n.guest_detail.email=e.reservationData.guest.email,O(t,n),n.tax_details=[],_.each(e.reservationData.taxDetails,function(e){n.tax_details.push(e)}),n.tax_total=e.reservationData.totalTaxAmount,w(a,n);var c=[];n.room_id=[],_.each(e.reservationData.rooms,function(t,a){var o=t.stayDates[e.reservationData.arrivalDate].rate.id;V(n,a,o),p.bookMark.lastPostedRate=t.stayDates[e.reservationData.arrivalDate].rate.id,"undefined"!=typeof r&&a!==r||c.push(G(n,t))}),n.stay_dates=c,M(n);var d=e.reservationData.demographics;return"undefined"!=typeof r&&(d=e.reservationData.rooms[r].demographics),void 0!==("undefined"==typeof d?"undefined":_typeof(d))&&L(n,d),n.confirmation_email=e.reservationData.guest.sendConfirmMailTo,n.room_id=[],s&&(n.room_types=[]),e.reservationData.hasOwnProperty("has_reason")&&(n.has_reason=e.reservationData.has_reason),x(n,s),F(n,r),n.borrow_for_groups=p.getReservationFlag("borrowForGroups"),n.forcefully_overbook=p.getForceOverbookForGroup(),p.setForceOverbookFlagForGroup(!1),n};var U=0,q=!1,H=0;e.creditCardTypes=[],e.paymentTypes=[];var Y=function(n,o){var i=function(i){e.languageData=i,e.DailogeState={},e.DailogeState.isGuestEmailSelected=!1,e.DailogeState.guestEmail=e.guestCardData.contactInfo.email,e.DailogeState.sendConfirmatonMailTo="";var s={reservationId:e.reservationData.reservationId,details:{firstName:e.guestCardData.contactInfo.first_name,lastName:e.guestCardData.contactInfo.last_name,creditCardTypes:e.creditCardTypes,paymentTypes:e.paymentTypes}};e.passData=s,a.open({template:"/assets/partials/reservationCard/rvCancelReservation.html",controller:"RVCancelReservation",scope:e,data:JSON.stringify({state:"CONFIRM",cards:!1,penalty:n,penaltyText:function(){return o?n+(n>1?" nights":" night"):t.currencySymbol+r("number")(n,2)}()})})},s=function(t){e.$emit("hideLoader"),e.paymentTypes=t,t.forEach(function(t){"CC"===t.name&&(e.creditCardTypes=t.values)});var a={reservation_id:e.reservationData.reservationId},r={params:a,successCallBack:i};e.callAPI(g.fetchGuestLanguages,r)};e.invokeApi(l.renderPaymentScreen,"",s)};e.cancelReservation=function(){var t=function(){var t=function(t){e.$emit("hideLoader"),H=t.results.deposit_amount;var a=!t.results.is_inside_cancellation_period;if(a){if("day"===t.results.penalty_type){var r=e.reservationData.numNights>0?e.reservationData.numNights:1;U=r>t.results.penalty_value?t.results.penalty_value:r,q=!0}else U=parseFloat(t.results.calculated_penalty_amount);parseInt(H)>0?j(H,a,U):Y(U,q)}else parseInt(H)>0?j(H,a,""):Y("",q)},a=function(t){e.$emit("hideLoader"),e.errorMessage=t},r={id:e.reservationData.reservationId};e.invokeApi(d.fetchCancellationPolicies,r,t,a)};t()};var j=function(n,o,i){var s={reservation_id:e.reservationData.reservationId},c=function(s){e.languageData=s,e.DailogeState={},e.DailogeState.successMessage="",e.DailogeState.failureMessage="",e.DailogeState.isGuestEmailSelected=!1,e.DailogeState.guestEmail=e.guestCardData.contactInfo.email,e.DailogeState.sendConfirmatonMailTo="",a.open({template:"/assets/partials/reservationCard/rvCancelReservationDeposits.html",controller:"RVCancelReservationDepositController",scope:e,data:JSON.stringify({state:"CONFIRM",cards:!1,penalty:i,deposit:n,depositText:function(){return o?"Reservation outside of cancellation period. A cancellation fee of "+t.currencySymbol+r("number")(i,2)+" will be charged, deposit not refundable":"Within Cancellation Period. Deposit of "+t.currencySymbol+r("number")(n,2)+" is refundable."}()})})},d={params:s,successCallBack:c};e.callAPI(g.fetchGuestLanguages,d)},W="",K="";this.showConfirmRoutingPopup=function(t,r){u(function(){a.open({template:"/assets/partials/reservation/alerts/rvBillingInfoConfirmPopup.html",className:"ngdialog-theme-default",scope:e})},1e3)},this.showConflictingRoutingPopup=function(t,r){u(function(){a.open({template:"/assets/partials/reservation/alerts/rvBillingInfoConflictingPopup.html",className:"ngdialog-theme-default",scope:e})},1e3)},this.hasTravelAgent=function(){return hasTravelAgent=!1,null!==e.reservationData.travelAgent.id&&void 0!==e.reservationData.travelAgent.id&&(hasTravelAgent=!0),hasTravelAgent},this.hasCompanyCard=function(){return hasCompanyCard=!1,null!==e.reservationData.company.id&&void 0!==e.reservationData.company.id&&(hasCompanyCard=!0),hasCompanyCard},e.applyRoutingToReservation=function(){var t=function(t){if(e.$emit("hideLoader"),e.$broadcast("BILLINGINFOADDED"),a.close(),"TRAVEL_AGENT"===e.contractRoutingType&&T.hasCompanyCard()&&e.routingInfo.company.routings_count>0)return e.contractRoutingType="COMPANY",T.showConfirmRoutingPopup(e.contractRoutingType,e.reservationData.company.id),!1},r={};r.account_id="TRAVEL_AGENT"===e.contractRoutingType?e.reservationData.travelAgent.id:e.reservationData.company.id,r.reservation_ids=[];for(var n in e.reservationData.reservations)r.reservation_ids.push(e.reservationData.reservations[n].id);e.invokeApi(c.applyDefaultRoutingToReservation,r,t)},e.noRoutingToReservation=function(){if(a.close(),"TRAVEL_AGENT"===e.contractRoutingType&&T.hasCompanyCard()&&e.routingInfo.company.routings_count>0)return e.contractRoutingType="COMPANY",T.showConfirmRoutingPopup(e.contractRoutingType,e.reservationData.company.id),!1},e.okClickedForConflictingRoutes=function(){a.close()},this.attachCompanyTACardRoutings=function(){if(e.reservationData.group.id||e.reservationData.allotment.id)return!1;var t=function(t){return e.$emit("hideLoader"),e.routingInfo=t,t.has_conflicting_routes?(e.conflict_cards=[],T.hasTravelAgent()&&t.travel_agent.routings_count>0&&e.conflict_cards.push(e.reservationData.travelAgent.name),T.hasCompanyCard()&&t.company.routings_count>0&&e.conflict_cards.push(e.reservationData.company.name),T.showConflictingRoutingPopup(),!1):T.hasTravelAgent()&&t.travel_agent.routings_count>0?(e.contractRoutingType="TRAVEL_AGENT",T.showConfirmRoutingPopup(e.contractRoutingType,e.reservationData.travelAgent.id),!1):T.hasCompanyCard()&&t.company.routings_count>0?(e.contractRoutingType="COMPANY",T.showConfirmRoutingPopup(e.contractRoutingType,e.reservationData.company.id),!1):void 0};if(T.hasTravelAgent()||T.hasCompanyCard()){var a={};a.reservation_id=e.reservationData.reservationId,a.travel_agent_id=e.reservationData.travelAgent.id,a.company_id=e.reservationData.company.id,e.invokeApi(c.fetchDefaultRoutingInfo,a,t)}};var J=function(t,a){var r=function(a){var r={numAdults:a.data.stay_dates[0].adult_count,numChildren:a.data.stay_dates[0].child_count,numInfants:a.data.stay_dates[0].infant_count,rateAvg:a.data.rate_per_night,rateTotal:a.data.total_rate,taxInformation:a.data.tax_details,addons:a.data.addons,total_stay_cost:a.data.total_stay_cost,total_tax:a.data.total_tax};e.reservationData.rooms[t]=Object.assign(e.reservationData.rooms[t],r),e.reservationData.totalStayCost=_.reduce(e.reservationData.rooms,function(e,t){return parseFloat(e)+parseFloat(t.total_stay_cost)},0),e.reservationData.totalTax=_.reduce(e.reservationData.rooms,function(e,t){return e+t.total_tax},0),e.$broadcast("REFRESH_SCROLL_SUMMARY")},n={reservation_id:a.id},o={params:n,successCallBack:r};e.callAPI(d.getConfirmationData,o)};e.saveReservation=function(r,n,i){if(e.$emit("showLoader"),W=r,K=n,e.reservationData.guest.id||e.reservationData.company.id||e.reservationData.travelAgent.id||e.reservationData.group.id||e.reservationData.allotment.id){var s=e.computeReservationDataforUpdate(!0,!0),d=function(a){e.closeDialog(),t.$broadcast("UPDATERESERVATIONTYPE",a.reservations[0].reservation_type_id);var r=0,n=0;e.reservationsListArray=a;var i=0;angular.forEach(a.reservations,function(e){r=parseFloat(r)+parseFloat(e.deposit_amount),J(i,e),n=parseFloat(n)+parseFloat(e.deposit_payment_amount),i++}),e.reservationData.depositAmount=parseFloat(r).toFixed(2),e.reservationData.depositPaymentAmount=parseFloat(n).toFixed(2),e.reservationData.depositEditable=!(null===a.allow_deposit_edit||!a.allow_deposit_edit),e.reservationData.isValidDeposit=parseInt(e.reservationData.depositAmount)>0,"undefined"!=typeof a.reservations&&a.reservations instanceof Array?(e.reservationData.reservationIds=[],angular.forEach(a.reservations,function(t,a){e.reservationData.reservationIds.push(t.id),e.reservationData.isHourly?angular.forEach(e.reservationData.rooms,function(e,a){parseInt(t.room_id)===parseInt(e.room_id)&&(e.confirm_no=t.confirm_no)}):e.reservationData.rooms[a].confirm_no=t.confirm_no}),e.reservationData.reservations=a.reservations,e.reservationData.reservationId=e.reservationData.reservations[0].id,e.reservationData.confirmNum=e.reservationData.reservations[0].confirm_no,e.reservationData.status=e.reservationData.reservations[0].status,e.viewState.reservationStatus.number=e.reservationData.reservations[0].id,e.reservationData.is_custom_text_per_reservation=e.reservationData.reservations[0].is_custom_text_per_reservation):(e.reservationData.reservationId=a.id,e.reservationData.confirmNum=a.confirm_no,e.reservationData.rooms[0].confirm_no=a.confirm_no,e.reservationData.status=a.status,e.viewState.reservationStatus.number=a.id,e.reservationData.is_custom_text_per_reservation=a.is_custom_text_per_reservation),e.successPaymentList=function(t){e.$emit("hideLoader"),e.cardsList=t.existing_payments,angular.forEach(e.cardsList,function(e,t){e.mli_token=e.ending_with,e.card_expiry=e.expiry_date})},e.invokeApi(l.getPaymentList,e.reservationData.reservationId,e.successPaymentList),e.viewState.reservationStatus.confirm=!0,e.reservationData.is_routing_available=!1,e.viewState.identifier="CONFIRM",e.reservation={reservation_card:{}},e.reservation.reservation_card.arrival_date=e.reservationData.arrivalDate,e.reservation.reservation_card.departure_date=e.reservationData.departureDate,e.$broadcast("PROMPTCARDENTRY"),e.$emit("hideLoader"),T.attachCompanyTACardRoutings(),W&&(K||(K={}),o.go(W,K))},u=function(t){if(t.results&&t.results.status===R&&t.results.is_borrowed){var r=t.results;e.borrowData={},r.room_overbooked||r.house_overbooked||(e.borrowData.isBorrowFromHouse=!0),r.room_overbooked&&!r.house_overbooked?(e.borrowData.shouldShowOverBookBtn=e.hasOverBookRoomTypePermission,e.borrowData.isRoomTypeOverbooked=!0):!r.room_overbooked&&r.house_overbooked?(e.borrowData.shouldShowOverBookBtn=e.hasOverBookHousePermission,e.borrowData.isHouseOverbooked=!0):r.room_overbooked&&r.house_overbooked&&(e.borrowData.shouldShowOverBookBtn=e.hasOverBookRoomTypePermission&&e.hasOverBookHousePermission,e.borrowData.isHouseAndRoomTypeOverbooked=!0),a.open({template:"/assets/partials/common/group/rvGroupBorrowPopup.html",className:"",closeByDocument:!1,closeByEscape:!0,scope:e})}else e.errorMessage=t,e.$broadcast("FAILURE_SAVE_RESERVATION",t);e.$emit("hideLoader")};e.closeBorrowPopup=function(t){t&&(e.borrowData={}),a.close(),e.$broadcast("SHOW_ROOM_AND_RATES_AFTER_BORROW_DECLINE")},e.performBorrowFromHouse=function(){e.borrowData.isBorrowFromHouse?(p.setForceOverbookFlagForGroup(!0),e.$broadcast("CREATE_RESERVATION_AFTER_BORROW"),a.close()):(a.close(),a.open({template:"/assets/partials/common/group/rvGroupOverbookPopup.html",className:"",closeByDocument:!1,closeByEscape:!0,scope:e}))},e.closeOverbookPopup=function(){e.borrowData={},a.close(),e.$broadcast("SHOW_ROOM_AND_RATES_AFTER_BORROW_DECLINE")},e.performOverBook=function(){p.setForceOverbookFlagForGroup(!0),e.$broadcast("CREATE_RESERVATION_AFTER_BORROW"),a.close()};var m=function(t){e.errorMessage=t,e.$broadcast("FAILURE_UPDATE_RESERVATION",t),e.$emit("hideLoader")},f=function(t){var a=t;t=_.isArray(t)?t[0]:t;var r=0;if(e.reservationsListArray){var n=0;angular.forEach(e.reservationsListArray.reservations,function(e,a){!i&&!_.isNumber(i)||a===i?(e.deposit_amount=t.deposit_amount,r=parseFloat(r)+parseFloat(t.deposit_amount)):r=parseFloat(r)+parseFloat(e.deposit_amount),J(n,e),n++})}else r=parseFloat(t.deposit_amount);_.isArray(a)&&(r=0,_.each(a,function(t,a){e.reservationsListArray.reservations[a]&&(e.reservationsListArray.reservations[a].deposit_amount=t.deposit_amount),r=parseFloat(r)+parseFloat(t.deposit_amount)})),e.reservationData.depositAmount=parseFloat(r).toFixed(2),e.reservationData.depositEditable=!!t.allow_deposit_edit,e.reservationData.isValidDeposit=parseInt(e.reservationData.depositAmount)>0,e.reservationData.fees_details=t.fees_details,e.$broadcast("UPDATEFEE"),e.viewState.identifier="UPDATED",e.reservationData.is_routing_available=t.is_routing_available,e.reservationData.status=t.reservation_status,p.setReservationFlag("borrowForGroups",!1),W?o.$current.name===W?o.reload(W):o.go(W,K||{}):e.$emit("hideLoader")};if(""!==e.reservationData.reservationId&&null!==e.reservationData.reservationId&&"undefined"!=typeof e.reservationData.reservationId){if("undefined"!=typeof i){e.reservationsListArray?s.reservationId=e.reservationsListArray.reservations[i].id:s.reservationId=e.reservationData.reservationId;var v=s.room_id[i];s.room_id=[],s.room_id.push(v)}else s.reservationId=e.reservationData.reservationId;var D=[];e.reservationData.reservationIds&&e.reservationData.reservationIds.length>1?(_.each(e.reservationData.reservationIds,function(t,a){var r=e.getReservationDataforUpdate(!0,!0,a);r.reservationId=t,D.push(c.updateReservation(r))}),y.all(D).then(f,m)):e.invokeApi(c.updateReservation,s,f,m)}else{if(e.reservationData.isFromNightlyDiary){s.arrival_time=e.reservationData.tabs[0].checkinTime,s.departure_time=e.reservationData.tabs[0].checkoutTime;var g=A.extractHhMmAmPm(e.reservationData.tabs[0].checkinTime),C=A.extractHhMmAmPm(e.reservationData.tabs[0].checkoutTime);"00"===g.hh&&(g.hh="12"),"00"===C.hh&&(C.hh="12"),e.reservationData.checkinTime=g,e.reservationData.checkoutTime=C,s.room_type_id=e.reservationData.roomTypeIdFromNightlyDiary,h.log(s)}e.invokeApi(c.saveReservation,s,d,u)}p.setReservationFlag("outsideStaydatesForGroup",!1)}else e.$emit("PROMPTCARD")},e.fetchDemoGraphics=function(){var t=function(t){e.otherData.marketsEnabled=t.demographics.is_use_markets,e.otherData.markets=t.demographics.markets,e.otherData.sourcesEnabled=t.demographics.is_use_sources,e.otherData.sources=t.demographics.sources,e.otherData.originsEnabled=t.demographics.is_use_origins,e.otherData.origins=t.demographics.origins,e.otherData.reservationTypes=t.demographics.reservationTypes,e.otherData.segmentsEnabled=t.demographics.is_use_segments,e.otherData.segments=t.demographics.segments,e.$emit("hideLoader")},a=function(t){e.errorMessage=t,e.$emit("hideLoader")};e.invokeApi(c.fetchInitialData,{},t,a)},e.resetAddons=function(){angular.forEach(e.reservationData.rooms,function(e){e.addons=[]})},e.onOccupancyChange=function(t,a){var r,n=parseInt(e.reservationData.tabs[a].roomTypeId,10)||"",o=_.indexOf(e.reservationData.rooms,_.findWhere(e.reservationData.rooms,{roomTypeId:n})),i=_.lastIndexOf(e.reservationData.rooms,_.last(_.where(e.reservationData.rooms,{roomTypeId:n})));for(r=o;r<=i;r++)e.reservationData.rooms[r][t]=parseInt(e.reservationData.tabs[a][t],10),e.reservationData.isHourly||(e.validateOccupant(e.reservationData.rooms[r],t),e.reservationData.rooms[r].rateId&&e.checkOccupancyLimit(null,!0,r)),e.updateOccupancy(r);e.$broadcast("SIDE_BAR_OCCUPANCY_UPDATE"),z()},e.removeTab=function(t){var a=_.indexOf(e.reservationData.rooms,_.findWhere(e.reservationData.rooms,{roomTypeId:parseInt(e.reservationData.tabs[t].roomTypeId,10)||""})),r=parseInt(e.reservationData.tabs[t].roomCount,10);e.reservationData.tabs.splice(t,1),e.reservationData.rooms.splice(a,r),e.viewState.currentTab==t&&(e.viewState.currentTab=0),e.$broadcast("TABS_MODIFIED"),z()};var z=function(){console.log({size:e.reservationData.rooms.length,contents:e.reservationData.rooms})},Q=function(){a.open({template:"/assets/partials/reservation/alerts/reseravtionFromDiaryValidation.html",scope:e,className:"",closeByDocument:!1,closeByEscape:!1})},X=function(){e.reservationData.tabs[0].room_id=null,e.reservationData.rooms[0].room_id=null,e.reservationData.tabs[0].roomName=null,e.reservationData.rooms[0].roomName=null},Z=!1;e.onRoomCountChange=function(t){var a=parseInt(e.reservationData.tabs[t].roomCount,10),r=parseInt(e.reservationData.tabs[t].roomTypeId,10)||"",n=_.indexOf(e.reservationData.rooms,_.findWhere(e.reservationData.rooms,{roomTypeId:r})),o=_.lastIndexOf(e.reservationData.rooms,_.last(_.where(e.reservationData.rooms,{roomTypeId:r}))),i=o-n+1,s=null===e.reservationData.tabs[0].room_id;if("NIGHTLY_DIARY"===m.fromState&&a>1&&!Z&&!s&&(e.validationMsg="Room number will be unassigned by changing the room count",Z=!0,X(),Q()),i<a){var c,d;for(d=0;d<a-i;d++)c=angular.copy(e.reservationData.rooms[n]),e.reservationData.rooms.splice(o,0,c)}else e.reservationData.rooms.splice(n,i-a);e.$broadcast("TABS_MODIFIED"),z()},e.copySingleValueToOtherCells=function(e,a){_.each(a,function(a,r){Date.parse(r)>=Date.parse(t.businessDate)&&(a.rateDetails.modified_amount=e)})},t.disableObserveForSwipe||(CardReaderCtrl.call(this,e,t,u,D,h),e.observeForSwipe()),e.hasEmails=function(){return!!e.guestCardData.contactInfo.email},e.shouldDisableSendCancellationEmailBtn=function(){return!e.DailogeState.isGuestEmailSelected&&!e.DailogeState.sendConfirmatonMailTo}}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){sntRover.controller("rvReservationPendingDepositController",["$rootScope","$scope","$stateParams","$timeout","RVReservationCardSrv","$state","$filter","ngDialog","rvPermissionSrv","RVAutomaticEmailSrv",function(e,t,a,r,n,o,i,s,c,d){BaseCtrl.call(this,t),SharedMethodsBaseCtrl.call(this,t,e,d,s);var l=(function(){t.$emit("UPDATE_STAY_CARD_DEPOSIT_FLAG",!0),t.pageloadingOver=!1,r(function(){t.pageloadingOver=!0},3e3),t.reservationId=a.id,t.errorMessage="",t.depositPaidSuccesFully=!1,t.successMessage="",t.authorizedCode="",t.billNumber="1",t.firstName="undefined"==typeof t.passData.details.firstName?"":t.passData.details.firstName,t.lastName="undefined"==typeof t.passData.details.lastName?"":t.passData.details.lastName,t.isReservationRateSuppressed=t.reservationData.reservation_card.is_rate_suppressed_present_in_stay_dates,t.paymentType=t.reservationData.reservation_card.payment_method_used?t.reservationData.reservation_card.payment_method_used:"",t.isDepositEditable=!!t.depositDetails.deposit_policy.allow_deposit_edit,t.depositPolicyName=t.depositDetails.deposit_policy.description,t.rateCurrency=t.depositDetails.rate_currency,t.depositAmount=parseFloat(t.depositDetails.deposit_amount).toFixed(2),t.depositPaymentAmount=parseFloat(t.depositDetails.deposit_payment_amount).toFixed(2)}(),function(){t.$emit("UPDATE_STAY_CARD_DEPOSIT_FLAG",!1),e.modalOpened=!1,r(function(){s.close()},250)});t.closeDialog=function(){l()},t.hasPermissionToMakePayment=function(){return c.getPermissionValue("MAKE_PAYMENT")},t.proceedCheckin=function(){t.$emit("PROCEED_CHECKIN"),l()},t.tryAgain=function(){t.errorOccured=!1,t.errorMessage="",t.errorOccured=!1},t.$on("SET_SCROLL_FOR_EXISTING_CARDS",function(){console.log("set_scroll"),t.setScroller("cardsList",{click:!0,tap:!0})}),t.$on("SHOW_SWIPED_DATA_ON_STAY_CARD_DEPOSIT_SCREEN",function(e,a){t.$broadcast("RENDER_SWIPED_DATA",a)});t.$on("CLOSE_DIALOG",function(){l()}),t.$on("PAY_LATER",function(){t.depositDetails.isFromCheckin&&t.$emit("PROCEED_CHECKIN"),l()}),t.$on("AUTO_TRIGGER_EMAIL_AFTER_PAYMENT",function(e,a){t.guestCardData.contactInfo.email=a,t.sendAutomaticEmails(a)}),t.$on("PAYMENT_SUCCESS",function(a,r){if(t.depositPaidSuccesFully=!0,t.depositAmount=r.amountPaid,t.feePaid=r.feePaid,t.authorizationCode=r.authorizationCode,t.$parent.reservationData.reservation_card.deposit_attributes.outstanding_stay_total=r.reservation_balance,t.$parent.reservationData.reservation_card.balance_amount=r.reservation_balance,"CC"!==t.$parent.reservationData.reservation_card.payment_method_used&&"DB"!==t.$parent.reservationData.reservation_card.payment_method_used&&"undefined"!=typeof r.cc_details&&(t.$parent.reservationData.reservation_card.payment_method_used="CC",t.$parent.reservationData.reservation_card.payment_details.card_number=r.cc_details.ending_with,t.$parent.reservationData.reservation_card.payment_details.card_expiry=r.cc_details.expiry_date,t.$parent.reservationData.reservation_card.payment_details.card_type_image="images/"+r.cc_details.card_code+".png"),"undefined"!=typeof r.add_to_guest_card&&r.add_to_guest_card){var n={card_code:r.cc_details.card_code,mli_token:r.cc_details.ending_with,card_expiry:r.cc_details.expiry_date,card_name:r.cc_details.holder_name,id:r.cc_details.value,isSelected:!0,is_primary:!1,payment_type:"CC",payment_type_id:1,is_credit_card:!0};e.$broadcast("ADDEDNEWPAYMENTTOGUEST",n)}t.currentPaymentBillId=r.bill_id,t.currentPaymentTransactionId=r.transaction_id,t.isDepositPayment=r.is_deposit_payment,(e.autoEmailPayReceipt||e.autoEmailDepositInvoice&&t.isDepositPayment)&&t.autoTriggerPaymentReceiptActions()}),t.$on("PAYMENT_FAILED",function(e,a){r(function(){t.errorOccured=!0,t.errorMessage=a,t.runDigestCycle()},500)})}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){sntRover.controller("RVReservationRoomTypeCtrl",["$rootScope","$scope","roomRates","sortOrder","rateAddons","isAddonsConfigured","RVReservationBaseSearchSrv","RVReservationAddonsSrv","$timeout","$state","ngDialog","$sce","$stateParams","dateFilter","$filter","rvPermissionSrv","RVReservationStateService","RVReservationDataService",function(e,t,a,r,n,o,s,c,d,l,u,m,f,p,v,D,h,y){t.displayData={},t.selectedRoomType=-1,t.expandedRoom=-1,t.containerHeight=$(window).height()-280,t.showLessRooms=!0,t.showLessRates=!1,t.isHouseAvailable=!1,t.restrictionColorClass={CLOSED:"red",CLOSED_ARRIVAL:"red",CLOSED_DEPARTURE:"red",MIN_STAY_LENGTH:"blue",MAX_STAY_LENGTH:"grey",MIN_STAY_THROUGH:"purple",MIN_ADV_BOOKING:"green",MAX_ADV_BOOKING:"grey",DEPOSIT_REQUESTED:"grey",CANCEL_PENALTIES:"grey",LEVELS:"grey",RATE_NOT_CONFIGURED:"red"},t.restrictionsMapping={1:"CLOSED",2:"CLOSED_ARRIVAL",3:"CLOSED_DEPARTURE",4:"MIN_STAY_LENGTH",5:"MAX_STAY_LENGTH",6:"MIN_STAY_THROUGH",7:"MIN_ADV_BOOKING",8:"MAX_ADV_BOOKING",9:"DEPOSIT_REQUESTED",10:"CANCEL_PENALTIES",11:"LEVELS"},t.stateCheck={sortOrder:r.value,rateSelected:{allDays:!1,oneDay:!1},activeMode:f.view&&"CALENDAR"===f.view?"CALENDAR":"ROOM_RATE",stayDatesMode:!1,selectedStayDate:"",guestOptionsIsEditable:!1,preferredType:"",rateFilterText:"",dateModeActiveDate:"",restrictedContractedRates:{},datesContainerWidth:$(window).width()-180,dateButtonContainerWidth:80*t.reservationData.stayDays.length,suppressedRates:[],showClosedRates:!1,roomDetails:{},exhaustedAddons:[],selectedRoomRate:{rateId:"",roomId:""},calendarState:{showOnlyAvailableRooms:!0,searchWithRestrictions:!0,calendarType:"BEST_AVAILABLE"}},"Recommended"===t.otherData.defaultRateDisplayName?t.activeCriteria="RECOMMENDED":"By Rate"===t.otherData.defaultRateDisplayName?t.activeCriteria="RATE":t.activeCriteria="ROOM_TYPE";var g=function(e){var a=!1;return _.each(e,function(e){null!==t.displayData.allRates[e].account_id&&(a=!0)}),a},C=function(e){var a=parseInt(t.reservationData.tabs[e].roomTypeId,10)||"",r=_.indexOf(t.reservationData.rooms,_.findWhere(t.reservationData.rooms,{roomTypeId:a})),n=_.lastIndexOf(t.reservationData.rooms,_.last(_.where(t.reservationData.rooms,{roomTypeId:a})));return{roomTypeId:a,firstIndex:r,lastIndex:n}},A=function(){return C(t.activeRoom)},S=function(r){t.$emit("showLoader");var n=t.reservationData.arrivalDate;t.displayData.dates=[],t.filteredRates=[],t.stateCheck.restrictedContractedRates=[],t.isRateFilterActive=!0,t.rateFiltered=!1,t.otherData.taxesMeta=a.tax_codes,t.tax=a.tax||0,t.rooms=t.reservationData.rooms,t.activeRoom=t.viewState.currentTab,t.stateCheck.roomDetails=A(),"CALENDAR"===f.view&&r&&t.toggleCalendar(),
t.stateCheck.dateModeActiveDate||(t.reservationData.midStay&&new tzIndependentDate(t.reservationData.departureDate)>new tzIndependentDate(e.businessDate)?(t.stateCheck.dateModeActiveDate=e.businessDate,t.stateCheck.selectedStayDate=t.reservationData.rooms[t.stateCheck.roomDetails.firstIndex].stayDates[e.businessDate]):(t.stateCheck.dateModeActiveDate=n,t.stateCheck.selectedStayDate=t.reservationData.rooms[t.stateCheck.roomDetails.firstIndex].stayDates[n]));var o=[];if(t.days=a.results.length,t.stateCheck.suppressedRates=[],$(a.rates).each(function(e,a){o[a.id]=a,a.is_suppress_rate_on&&t.stateCheck.suppressedRates.push(a.id)}),t.reservationData.group.id){var i=h.getCustomRateModel(t.reservationData.group.id,t.reservationData.group.name,"GROUP");o[i.id]=i}if(t.reservationData.allotment.id){var i=h.getCustomRateModel(t.reservationData.allotment.id,t.reservationData.allotment.name,"ALLOTMENT");o[i.id]=i}t.displayData.allRates=o,t.reservationData.ratesMeta=o,t.roomAvailability=t.getAvailability(a),t.displayData.allRooms=$(a.room_types).filter(function(){return t.roomAvailability[this.id]&&t.roomAvailability[this.id].availability===!0&&t.roomAvailability[this.id].rates.length>0&&null!==t.roomAvailability[this.id].level}),t.displayData.allRooms.sort(function(e,a){var r=parseInt(t.roomAvailability[e.id].averagePerNight),n=parseInt(t.roomAvailability[a.id].averagePerNight);return r<n?-1:r>n?1:0}),t.displayData.allRooms.sort(function(e,t){return e.level<t.level?-1:e.level>t.level?1:0}),t.displayData.allRooms.sort(function(e,a){return g(t.roomAvailability[e.id].rates)?-1:g(t.roomAvailability[a.id].rates)?1:0}),t.displayData.roomTypes=t.displayData.allRooms,t.stateCheck.preferredType=t.reservationData.tabs[t.activeRoom].roomTypeId,t.roomTypes=a.room_types,t.filterRooms(),t.$emit("hideLoader")};t.isCorRate=function(e){var t=!1;return angular.forEach(function(a){a.id===e&&a.account_id&&(t=!0)}),t};var I=function(){var e=[],a=function(e){for(var t=e.length-1;t;)if(e[t--]!==e[t])return!1;return!0};t.reservationData.rateDetails[t.activeRoom]=t.roomAvailability[t.reservationData.tabs[t.activeRoom].roomTypeId].ratedetails,_.each(t.reservationData.rooms[0].stayDates,function(t,a){e.push(t.rate.id)}),a(e)?(t.reservationData.rooms[t.activeRoom].rateId=e,t.reservationData.rooms[t.activeRoom].rateName="Multiple Rates Selected"):(t.reservationData.rooms[t.activeRoom].rateId=e[0],t.reservationData.rooms[t.activeRoom].rateName=t.reservationData.rooms[0].stayDates[t.reservationData.arrivalDate].rate.name),t.enhanceStay()},T=function(e,a,r){_.each(t.reservationData.rooms[r].stayDates,function(r,n){r.rate.id=e,r.rate.name=t.displayData.allRates[e].name;var o=t.roomAvailability[a].ratedetails[n]&&t.roomAvailability[a].ratedetails[n][e].rate||t.roomAvailability[a].ratedetails[t.reservationData.arrivalDate][e].rate;o=Number(parseFloat(o).toFixed(2)),r.rateDetails={actual_amount:o,modified_amount:o,is_discount_allowed:null===t.reservationData.ratesMeta[e].is_discount_allowed?"false":t.reservationData.ratesMeta[e].is_discount_allowed.toString(),is_suppressed:null===t.reservationData.ratesMeta[e].is_suppress_rate_on?"false":t.reservationData.ratesMeta[e].is_suppress_rate_on.toString()}})};t.getTabTitle=function(e){if(e>=t.reservationData.tabs.length)return"INVALID TAB";var a=C(e);return a.firstIndex===a.lastIndex?"ROOM "+(a.firstIndex+1):"ROOMS "+(a.firstIndex+1)+"-"+(a.lastIndex+1)},t.initRoomRates=function(e){var r=function(r){a=r,S(),e&&(T(t.reservationData.rooms[0].stayDates[t.reservationData.arrivalDate].rate.id,t.reservationData.rooms[0].roomTypeId,t.activeRoom),I())};if(t.invokeApi(s.fetchAvailability,{from_date:t.reservationData.arrivalDate,to_date:t.reservationData.departureDate,company_id:t.reservationData.company.id,travel_agent_id:t.reservationData.travelAgent.id,group_id:t.reservationData.group.id,allotment_id:t.reservationData.allotment.id,promotion_code:t.reservationData.searchPromoCode},r),e)for(t.reservationData.stayDays=[],ms=1*new tzIndependentDate(t.reservationData.arrivalDate),last=1*new tzIndependentDate(t.reservationData.departureDate);ms<=last;ms+=864e5)t.reservationData.stayDays.push({date:p(new tzIndependentDate(ms),"yyyy-MM-dd"),dayOfWeek:p(new tzIndependentDate(ms),"EEE"),day:p(new tzIndependentDate(ms),"dd")})},t.restrictIfOverbook=function(e,a){var r=D.getPermissionValue("OVERBOOK_HOUSE"),n=D.getPermissionValue("OVERBOOK_ROOM_TYPE");return(!r||!n)&&(!r&&t.getLeastHouseAvailability(e,a)<1||(!n&&t.getLeastAvailability(e,a)<1||void 0))},t.setRates=function(){function e(e,t,a){var r=e[t];e.splice(t,1),e.splice(a,0,r)}if(t.ratesMaster=[],t.displayData.availableRates=[],$(t.displayData.allRooms).each(function(e,a){var r=t.roomAvailability[a.id];$(r.rates).each(function(e,a){"undefined"==typeof t.ratesMaster[a]&&(t.ratesMaster[a]={rooms:[],rate:t.displayData.allRates[a]}),t.ratesMaster[a].rooms.push(r)})}),$(t.ratesMaster).each(function(e,a){"undefined"!=typeof a&&(null===t.stateCheck.preferredType||""===t.stateCheck.preferredType||"undefined"==typeof t.stateCheck.preferredType?(a.rooms.sort(function(e,t){return e.total[a.rate.id].average<t.total[a.rate.id].average?-1:e.total[a.rate.id].average>t.total[a.rate.id].average?1:0}),a.preferredType=a.rooms[0].id,t.displayData.availableRates.push(a)):g([a.rate.id])?(t.displayData.availableRates.push(a),a.preferredType=a.rooms[0].id):_.where(a.rooms,{id:parseInt(t.stateCheck.preferredType)}).length>0&&(a.preferredType=parseInt(t.stateCheck.preferredType),a.rooms.sort(function(e,t){return e.total[a.rate.id].average<t.total[a.rate.id].average?-1:e.total[a.rate.id].average>t.total[a.rate.id].average?1:0}),t.displayData.availableRates.push(a)))}),t.displayData.availableRates.sort(function(e,t){return e.rate.name.toLowerCase()<t.rate.name.toLowerCase()?-1:e.rate.name.toLowerCase()>t.rate.name.toLowerCase()?1:0}),t.reservationData.member.isSelected&&t.displayData.availableRates.sort(function(e,a){return t.reservationData.member.isSelected&&e.rate.is_member?-1:t.reservationData.member.isSelected&&a.rate.is_member?1:0}),t.reservationData.code&&t.reservationData.code.id){var a=function(e){var t=!1;return _.each(e.rooms,function(a){_.each(a.ratedetails,function(a){t=t||a[e.rate.id].applyPromotion})}),t};t.displayData.availableRates.sort(function(e,t){return a(e)?-1:a(t)?1:0})}if(t.displayData.availableRates&&t.displayData.availableRates.length>1){var r=angular.copy(t.displayData.availableRates);for(i=r.length;i>0;i--){var n=r[i-1].rate;null!==n.account_id&&e(t.displayData.availableRates,i-1,0)}}};var E=function(){var e={allDays:!0,oneDay:!1};return _.each(t.reservationData.rooms[t.activeRoom].stayDates,function(a,r){null!==a.rate.id&&""!==a.rate.id&&(e.oneDay=!0),!e.allDays||r===t.reservationData.departureDate||null!==a.rate.id&&""!==a.rate.id||(e.allDays=!1)}),e};t.handleDaysBooking=function(e){if(e.stopPropagation(),!t.stateCheck.rateSelected.allDays)return!1;var a,r=t.stateCheck.roomDetails.firstIndex;for(a=t.stateCheck.roomDetails.firstIndex;a<=t.stateCheck.roomDetails.lastIndex;a++)y.isVaryingRates(t.reservationData.rooms[r].stayDates,t.reservationData.arrivalDate,t.reservationData.departureDate,t.reservationData.numNights)?t.reservationData.rooms[a].rateName="Multiple Rates Selected":t.reservationData.rooms[a].rateName=t.displayData.allRates[t.reservationData.rooms[r].stayDates[t.reservationData.arrivalDate].rate.id].name,t.reservationData.rateDetails[a]=t.roomAvailability[t.reservationData.tabs[t.activeRoom].roomTypeId].ratedetails,"rover.reservation.staycard.reservationcard.reservationdetails"!==f.fromState&&"STAY_CARD"!==f.fromState||_.each(t.reservationData.rooms[a].stayDates,function(e,r){var n=t.reservationData.rooms[a].stayDates[r].rate.id,o=t.reservationData.rooms[a].roomTypeId;e.rate.id=n,e.rate.name=t.displayData.allRates[n].name;var i=t.roomAvailability[o].ratedetails[r]&&t.roomAvailability[o].ratedetails[r][n].rate||t.roomAvailability[o].ratedetails[t.reservationData.arrivalDate][n].rate;i=Number(parseFloat(i).toFixed(2)),e.rateDetails={actual_amount:i,modified_amount:i,is_discount_allowed:null===t.reservationData.ratesMeta[n].is_discount_allowed?"false":t.reservationData.ratesMeta[n].is_discount_allowed.toString(),is_suppressed:null===t.reservationData.ratesMeta[n].is_suppress_rate_on?"false":t.reservationData.ratesMeta[n].is_suppress_rate_on.toString()}});F()},t.saveAndGotoStayCard=function(){var e={title:v("translate")("STAY_CARD"),name:"rover.reservation.staycard.reservationcard.reservationdetails",param:{confirmationId:t.reservationData.confirmNum,id:t.reservationData.reservationId,isrefresh:!0}};t.saveReservation(e.name,e.param)},t.handleNoEdit=function(e,a,r){e.stopPropagation(),t.reservationData.rooms[t.activeRoom].rateName=t.displayData.allRates[r].name,t.reservationData.rateDetails[t.activeRoom]=t.roomAvailability[a].ratedetails,t.stateCheck.stayDatesMode||t.navigateOut()};var R=function(e,a){var r=t.reservationData.arrivalDate,n=t.reservationData.departureDate,o=[],i=function(e){var a=h.getApplicableAddonsCount(e.amountType,e.postType,parseInt(e.postFrequency,10),parseInt(t.reservationData.tabs[t.viewState.currentTab].numAdults,10),parseInt(t.reservationData.tabs[t.viewState.currentTab].numChildren,10),parseInt(t.reservationData.numNights,10))*parseInt(t.reservationData.tabs[t.viewState.currentTab].roomCount,10);if(_.isNumber(e.inventory)&&e.inventory<a){var r=_.findIndex(o,{id:e.id});r>-1?o[r].inventory>e.inventory&&(o[r].inventory=e.inventory):o.push(e)}};return t.stateCheck.stayDatesMode?_.each(t.roomAvailability[e].ratedetails[t.stateCheck.dateModeActiveDate][a].associatedAddons,function(e){i(e)}):_.each(t.roomAvailability[e].ratedetails,function(e,t){t!==r&&t===n||_.each(e[a].associatedAddons,function(e){i(e)})}),o},b=function(e,t){if("rover.reservation.staycard.reservationcard.reservationdetails"===f.fromState||"STAY_CARD"===f.fromState)return t&&t.length>0;var a=[];return _.each(e,function(e){_.find(t,{id:e.id})||a.push(e.id)}),a.length>0};t.enhanceStay=function(){var a=function(){(t.reservationData.guest.id||t.reservationData.company.id||t.reservationData.travelAgent.id||t.reservationData.group.id)&&(e.isAddonOn&&o?l.go("rover.reservation.staycard.mainCard.addons",{from_date:t.reservationData.arrivalDate,to_date:t.reservationData.departureDate}):l.go("rover.reservation.staycard.mainCard.summaryAndConfirm"))};if(e.isAddonOn&&o)l.go("rover.reservation.staycard.mainCard.addons",{from_date:t.reservationData.arrivalDate,to_date:t.reservationData.departureDate});else{var r=_.reduce(_.pluck(t.reservationData.rooms,"rateId"),function(e,t){return!!e&&!!t});if(r)t.reservationData.guest.id||t.reservationData.company.id||t.reservationData.travelAgent.id||t.reservationData.group.id?a():(t.$emit("PROMPTCARD"),t.$watch("reservationData.guest.id",a),t.$watch("reservationData.company.id",a),t.$watch("reservationData.travelAgent.id",a));else{var n=_.findIndex(t.reservationData.rooms,{rateId:""}),i=_.findIndex(t.reservationData.tabs,{roomTypeId:t.reservationData.rooms[n].roomTypeId});t.changeActiveRoomType(i||0)}}};var N=function(){for(var e=t.stateCheck.roomDetails.firstIndex;e<=t.stateCheck.roomDetails.lastIndex;e++)t.reservationData.rooms[e].isSuppressed=!1,_.each(t.reservationData.rooms[e].stayDates,function(a,r){var n=t.stateCheck.suppressedRates.indexOf(a.rate.id)>-1;"undefined"==typeof t.reservationData.rooms[e].isSuppressed?t.reservationData.rooms[e].isSuppressed=n:t.reservationData.rooms[e].isSuppressed=t.reservationData.rooms[e].isSuppressed||n})},P=function(e,a){var r=D.getPermissionValue("BOOK_RESTRICTED_ROOM_RATE"),n=D.getPermissionValue("OVERBOOK_ROOM_TYPE");if(r&&n)return!0;var o=!0,i=t.stateCheck.stayDatesMode?t.roomAvailability[e].ratedetails[$scopestateCheck.dateModeActiveDate][a].restrictions:t.getAllRestrictions(e,a),s=t.stateCheck.stayDatesMode?t.roomAvailability[e].ratedetails[$scopestateCheck.dateModeActiveDate][a].availabilityCount:t.getLeastAvailability(e,a);return i.length>0&&!r&&(o=!1),s<1&&!n&&(o=!1),o};t.handleBooking=function(e,a,r,n){if(t.reservationData.totalStayCost=0,t.stateCheck.preferredType=parseInt(t.stateCheck.preferredType,10)||"",r&&r.stopPropagation(),!P(e,a))return!1;if(t.stateCheck.exhaustedAddons=[],n&&n.skipAddonCheck||(t.stateCheck.exhaustedAddons=R(e,a)),t.stateCheck.exhaustedAddons.length>0)return t.stateCheck.selectedRoomRate={roomId:e,rateId:a},B(),!1;if(t.stateCheck.preferredType>0&&e!==t.stateCheck.preferredType&&t.stateCheck.stayDatesMode)return!1;if(t.stateCheck.stayDatesMode){var o,i,c=t.stateCheck.dateModeActiveDate;if(!t.stateCheck.rateSelected.oneDay){for(t.stateCheck.preferredType=parseInt(e),o=t.stateCheck.roomDetails.firstIndex;o<=t.stateCheck.roomDetails.lastIndex;o++)i=t.reservationData.rooms[o],i.roomTypeId=e,i.rateId=[],i.rateId.push(a),i.stayDates[t.stateCheck.dateModeActiveDate].rate.id=a,i.roomTypeName=t.roomAvailability[e].name,t.reservationData.rateDetails[o]=t.roomAvailability[e].ratedetails;t.filterRooms()}t.stateCheck.selectedStayDate.rate.id=a;var d=t.roomAvailability[e].ratedetails[c]&&t.roomAvailability[e].ratedetails[c][a].rate||t.roomAvailability[e].ratedetails[c][a].rate;for(d=Number(parseFloat(d).toFixed(2)),o=t.stateCheck.roomDetails.firstIndex;o<=t.stateCheck.roomDetails.lastIndex;o++)i=t.reservationData.rooms[o],i.stayDates[c].rateDetails={actual_amount:d,modified_amount:d,is_discount_allowed:null===t.reservationData.ratesMeta[a].is_discount_allowed?"false":t.reservationData.ratesMeta[a].is_discount_allowed.toString(),is_suppressed:null===t.reservationData.ratesMeta[a].is_suppress_rate_on?"false":t.reservationData.ratesMeta[a].is_suppress_rate_on.toString()},i.stayDates[c].rate.id=a,i.rateId||(i.rateId=[]),i.rateId.push(a);N(),t.stateCheck.rateSelected.allDays=E().allDays,t.stateCheck.rateSelected.oneDay=E().oneDay}else{var l;for(t.reservationData.tabs[t.activeRoom].roomTypeId&&parseInt(t.reservationData.tabs[t.activeRoom].roomTypeId)===parseInt(e)||(t.reservationData.tabs[t.activeRoom].roomTypeId=parseInt(e)),l=t.stateCheck.roomDetails.firstIndex;l<=t.stateCheck.roomDetails.lastIndex;l++)_.extend(t.reservationData.rooms[l],{roomTypeId:parseInt(e),roomTypeName:t.roomAvailability[e].name,rateId:a,isSuppressed:t.displayData.allRates[a].is_suppress_rate_on,rateName:t.displayData.allRates[a].name,rateAvg:t.roomAvailability[e].total[a].average,rateTotal:t.roomAvailability[e].total[a].total}),T(a,e,l),t.reservationData.rooms[l].demographics.market=null===t.displayData.allRates[a].market_segment.id?"":t.displayData.allRates[a].market_segment.id,t.reservationData.rooms[l].demographics.source=null===t.displayData.allRates[a].source.id?"":t.displayData.allRates[a].source.id,t.reservationData.rooms[l].demographics.origin=t.displayData.allRates[a].origin&&null===t.displayData.allRates[a].origin.id?"":t.displayData.allRates[a].origin.id,0===l&&(t.reservationData.demographics.source=t.reservationData.rooms[l].demographics.source,t.reservationData.demographics.market=t.reservationData.rooms[l].demographics.market,t.reservationData.demographics.origin=t.reservationData.rooms[l].demographics.origin),t.reservationData.rateDetails[l]=t.roomAvailability[e].ratedetails,t.checkOccupancyLimit(null,!1,l);if(t.viewState.currentTab=t.activeRoom,t.otherData.showOverbookingAlert){var m=t.getLeastHouseAvailability(e,a),f=t.getLeastAvailability(e,a),p=t.reservationData.tabs[t.activeRoom].roomCount;m<1||f<p?t.invokeApi(s.checkOverbooking,{from_date:t.reservationData.arrivalDate,to_date:t.reservationData.departureDate,group_id:t.reservationData.group.id},function(a){t.availabilityData=a,u.open({template:"/assets/partials/reservation/alerts/availabilityCheckOverbookingAlert.html",scope:t,controller:"overbookingAlertCtrl",closeByDocument:!1,closeByEscape:!1,data:JSON.stringify({houseFull:m<1,roomTypeId:e,isRoomAvailable:f>0,activeView:function(){return m<1?"HOUSE":"ROOM"}(),isGroupRate:!!t.reservationData.group.id})})}):F()}else F()}var v=!0;t.reservationData.isRoomRateSuppressed=!1,angular.forEach(t.reservationData.rooms,function(e,a){v&&e.isSuppressed&&(t.reservationData.isRoomRateSuppressed=!0,v=!1)}),t.$emit("REFRESHACCORDIAN")},t.alertOverbooking=function(e){var a=0;e&&(t.closeDialog(),a=1e3),d(F,a)},t.showAllRooms=function(){t.showLessRooms=!1,t.refreshScroll(),t.filterRooms()},t.setSelectedType=function(e){t.selectedRoomType=t.selectedRoomType===e.id?-1:e.id,t.refreshScroll()},t.resetRates=function(){for(var e=t.stateCheck.roomDetails.firstIndex;e<=t.stateCheck.roomDetails.lastIndex;e++)_.each(t.reservationData.rooms[e].stayDates,function(e,t){e.rate.id="",e.rate.name=""});t.stateCheck.rateSelected.allDays=!1,t.stateCheck.rateSelected.oneDay=!1},t.filterRooms=function(){if(t.stateCheck.preferredType){if(t.reservationData.tabs[t.activeRoom].roomTypeId=t.stateCheck.preferredType,t.displayData.roomTypes=_.filter(t.displayData.allRooms,function(e){return e.id===parseInt(t.stateCheck.preferredType,10)||!t.reservationData.group.id&&"CREATION"===t.viewState.identifier&&g(t.roomAvailability[e.id].rates)}),t.reservationData.tabs.length<2&&t.displayData.roomTypes.length>0&&!t.stateCheck.rateSelected.oneDay&&"CHECKEDIN"!==t.reservationData.status&&"CHECKING_OUT"!==t.reservationData.status){var e=t.roomAvailability[t.displayData.roomTypes[0].id].level;if(1===e||2===e){var a=e+1,r=_.filter(t.roomAvailability,function(e){return e.level===a&&e.availability===!0&&e.rates.length>0&&!g(t.roomAvailability[e.id].rates)});if(0===r.length&&(r=_.filter(t.roomAvailability,function(a){return a.level===e&&parseInt(a.id,10)!==parseInt(t.stateCheck.preferredType,10)&&a.availability===!0&&a.rates.length>0&&parseInt(a.averagePerNight)>=parseInt(t.roomAvailability[t.stateCheck.preferredType].averagePerNight)&&!g(t.roomAvailability[a.id].rates)})),r.sort(function(e,t){return e.averagePerNight<t.averagePerNight?-1:e.averagePerNight>t.averagePerNight?1:0}),r.length>0){var n=$(t.displayData.allRooms).filter(function(){return this.id===r[0].id});n.length>0&&t.displayData.roomTypes.push(n[0])}}}t.selectedRoomType=t.stateCheck.preferredType}else{if(t.showLessRooms&&t.displayData.allRooms.length>1){t.displayData.roomTypes=t.displayData.allRooms.first();var e=t.displayData.allRooms.first()[0].level,o=t.displayData.allRooms.first()[0].id;if(1===e||2===e){var a=e+1,r=_.filter(t.roomAvailability,function(e){return e.level===a&&e.availability===!0&&e.rates.length>0});if(0===r.length&&(r=_.filter(t.roomAvailability,function(a){return a.level===e&&a.id!==o&&a.availability===!0&&a.rates.length>0&&parseInt(a.averagePerNight)>=parseInt(t.roomAvailability[o].averagePerNight)})),r.sort(function(e,t){return parseInt(e.averagePerNight)<parseInt(t.averagePerNight)?-1:parseInt(e.averagePerNight)>parseInt(t.averagePerNight)?1:0}),r.length>0){var n=$(t.displayData.allRooms).filter(function(){return this.id===r[0].id});n.length>0&&t.displayData.roomTypes.push(n[0])}}}else t.displayData.roomTypes=t.displayData.allRooms;t.selectedRoomType=-1}t.setRates(),t.refreshScroll()};var k=function(a){var r=a;return _.each(r,function(r,n){var o=r.id;r.rates.length>0&&_.each(r.rates,function(n){var i=!0,s=!0;if(_.each(r.ratedetails,function(a,r){if(r===t.reservationData.departureDate&&r!==t.reservationData.arrivalDate)"undefined"==typeof a[n].restrictions&&(a[n].restrictions=[]),_.each(a[n].rateBreakUp.restrictions,function(e){switch(t.restrictionsMapping[e.restriction_type_id]){case"CLOSED_DEPARTURE":new tzIndependentDate(r)-new tzIndependentDate(t.reservationData.departureDate)===0&&(i=!1,a[n].restrictions.push({key:"CLOSED_DEPARTURE",value:"CLOSED FOR DEPARTURE"}))}});else if(!t.stateCheck.stayDatesMode||t.stateCheck.stayDatesMode&&r===t.stateCheck.dateModeActiveDate){var o=r;if("undefined"==typeof a[n])i=!1,s=!1;else{"undefined"==typeof a[n].restrictions&&(a[n].restrictions=[]),a[n].availabilityCount<1&&(i=!1),a[n].houseAvailability<1&&(i=!1,a[n].restrictions.push({key:"",value:"NO HOUSE AVAILABILITY"}));var c=a[n].rateBreakUp,d=parseInt(t.reservationData.rooms[t.stateCheck.roomDetails.firstIndex].numAdults),l=parseInt(t.reservationData.rooms[t.stateCheck.roomDetails.firstIndex].numChildren);t.stateCheck.stayDatesMode&&(d=parseInt(t.reservationData.rooms[t.stateCheck.roomDetails.firstIndex].stayDates[t.stateCheck.dateModeActiveDate].guests.adults),l=parseInt(t.reservationData.rooms[t.stateCheck.roomDetails.firstIndex].stayDates[t.stateCheck.dateModeActiveDate].guests.children));var u=parseInt(t.reservationData.numNights),m=Math.round((new tzIndependentDate(t.reservationData.arrivalDate)-new tzIndependentDate(e.businessDate))/864e5);if(null===c.single&&null===c.double&&null===c.extra_adult&&null===c.child?(i=!1,s=!1,a[n].restrictions.push({key:"RATE_NOT_CONFIGURED",value:""})):l>0&&null===c.child?(i=!1,s=!1,a[n].restrictions.push({key:"RATE_NOT_CONFIGURED",value:""})):1===d&&null===c.single?(i=!1,s=!1,a[n].restrictions.push({key:"RATE_NOT_CONFIGURED",value:""})):d>=2&&null===c.double?(i=!1,s=!1,a[n].restrictions.push({key:"RATE_NOT_CONFIGURED",value:""})):d>2&&null===c.extra_adult&&(i=!1,s=!1,a[n].restrictions.push({key:"RATE_NOT_CONFIGURED",value:""})),c.restrictions.length>0&&_.each(c.restrictions,function(e){switch(t.restrictionsMapping[e.restriction_type_id]){case"CLOSED":i=!1,a[n].restrictions.push({key:"CLOSED",value:"CLOSED"});break;case"CLOSED_ARRIVAL":new tzIndependentDate(o)-new tzIndependentDate(t.reservationData.arrivalDate)===0&&(i=!1,a[n].restrictions.push({key:"CLOSED_ARRIVAL",value:"CLOSED FOR ARRIVAL"}));break;case"CLOSED_DEPARTURE":new tzIndependentDate(o)-new tzIndependentDate(t.reservationData.departureDate)===0&&(i=!1,a[n].restrictions.push({key:"CLOSED_DEPARTURE",value:"CLOSED FOR DEPARTURE"}));break;case"MIN_STAY_LENGTH":null!==e.days&&u<e.days&&(i=!1,a[n].restrictions.push({key:"MIN_STAY_LENGTH",value:"MIN. LENGTH OF STAY: "+e.days+" DAYS"}));break;case"MAX_STAY_LENGTH":null!==e.days&&u>e.days&&(i=!1,a[n].restrictions.push({key:"MAX_STAY_LENGTH",value:"MAX. LENGTH OF STAY: "+e.days+" DAYS"}));break;case"MIN_STAY_THROUGH":Math.round((new tzIndependentDate(t.reservationData.departureDate)-new tzIndependentDate(o))/864e5)<e.days&&(i=!1,a[n].restrictions.push({key:"MIN_STAY_THROUGH",value:"MIN. STAY THROUGH: "+e.days+" DAYS"}));break;case"MIN_ADV_BOOKING":null!==e.days&&m<e.days&&(i=!1,a[n].restrictions.push({key:"MIN_ADV_BOOKING",value:"MIN. ADVANCE BOOKING: "+e.days+" DAYS"}));break;case"MAX_ADV_BOOKING":null!==e.days&&m>e.days&&(i=!1,a[n].restrictions.push({key:"MAX_ADV_BOOKING",value:"MAX. ADVANCE BOOKING: "+e.days+" DAYS"}));break;case"DEPOSIT_REQUESTED":break;case"CANCEL_PENALTIES":break;case"LEVELS":}}),a[n].applyPromotion){var f=a[n].appliedPromotion.from,p=a[n].appliedPromotion.to,v=!0;f&&p?v=new tzIndependentDate(f)<=new tzIndependentDate(o)&&new tzIndependentDate(p)>=new tzIndependentDate(o):f?v=new tzIndependentDate(f)<=new tzIndependentDate(o):p&&(v=new tzIndependentDate(p)>=new tzIndependentDate(o)),v||a[n].restrictions.push({key:"INVALID_PROMO",value:"PROMOTION INVALID"}),i=i&&v}}}}),t.displayData.allRates[n].account_id)i||("undefined"==typeof t.stateCheck.restrictedContractedRates[o]&&(t.stateCheck.restrictedContractedRates[o]=[]),t.stateCheck.restrictedContractedRates[o].push(n));else if(!s||!i&&!t.stateCheck.showClosedRates){var c=a[o].rates,d=_.without(c,n);a[o].rates=d}})}),a},O=function(){var a=t.reservationData.guestMemberships,r=t.reservationData.member.value,n=_.findWhere(a.ffp,{membership_type:r}),o=_.findWhere(a.hlp,{membership_type:r});return e.isFFPActive&&!!n||e.isHLPActive&&!!o};t.getAvailability=function(e){var a=h.parseRoomRates(e,t.reservationData.arrivalDate,t.reservationData.departureDate,t.reservationData.rooms[t.stateCheck.roomDetails.firstIndex].stayDates,t.activeRoom,t.reservationData.numNights,{code:t.reservationData.code,group:t.reservationData.group,allotment:t.reservationData.allotment},t.reservationData.member.isSelected),r=a.rooms;return t.displayData.dates=a.displayDates,r=k(r),_.each(r,function(e){if("HIGH_TO_LOW"===t.stateCheck.sortOrder?e.rates.sort(function(t,a){var r=parseFloat(e.total[t].average),n=parseFloat(e.total[a].average);return r>n?-1:r<n?1:0}):e.rates.sort(function(t,a){var r=parseFloat(e.total[t].average),n=parseFloat(e.total[a].average);return r<n?-1:r>n?1:0}),(t.reservationDetails.companyCard.id||t.reservationDetails.travelAgent.id)&&e.rates.sort(function(e,a){if(null!==t.displayData.allRates[e].account_id&&null!==t.displayData.allRates[a].account_id){if(parseInt(t.displayData.allRates[e].account_id)===parseInt(t.reservationDetails.companyCard.id))return-1;if(parseInt(t.displayData.allRates[a].account_id)===parseInt(t.reservationDetails.companyCard.id))return 1}return null!==t.displayData.allRates[e].account_id?-1:null!==t.displayData.allRates[a].account_id?1:0}),t.reservationData.member.isSelected){var a=function(t){var a=!1;return _.each(e.ratedetails,function(e){a=a||e[t].isMember}),a};e.rates.sort(function(e,t){return a(e)?-1:a(t)?1:0})}if(t.reservationData.code){var r=function(t){var a=!1;return _.each(e.ratedetails,function(e){a=a||e[t].applyPromotion}),a};e.rates.sort(function(e,t){return r(e)?-1:r(t)?1:0})}e.rates.length>0?e.defaultRate=e.rates[0]:e.defaultRate=-1,"undefined"!=typeof e.total[e.defaultRate]&&(e.averagePerNight=e.total[e.defaultRate].average,e.isSuppressed=t.displayData.allRates[e.defaultRate].is_suppress_rate_on)}),r},t.refreshScroll=function(){d(function(){t.refreshScroller("room_types")},100)},t.selectRate=function(e){t.stateCheck.rateFilterText=e.rate.name,t.filterRates(),t.rateFiltered=!0,t.refreshScroll()},t.hideResults=function(){d(function(){t.isRateFilterActive=!1},300)},t.filterRates=function(){if(t.rateFiltered=!1,t.stateCheck.rateFilterText.length>0){var e=new RegExp(t.stateCheck.rateFilterText,"gi");t.filteredRates=$(t.displayData.availableRates).filter(function(){return this.rate.name.match(e)}),t.filteredRates.length&&(t.isRateFilterActive=!0)}else t.filteredRates=[];t.refreshScroll()},t.$watch("activeCriteria",function(){t.refreshScroll(),t.stateCheck.rateFilterText="",t.filterRates()}),t.highlight=function(e,t){return t?e.replace(new RegExp(t,"gi"),'<span class="highlight">$&</span>'):e},t.to_trusted=function(e){return m.trustAsHtml(e)},t.toggleCalendar=function(){t.stateCheck.activeMode="ROOM_RATE"===t.stateCheck.activeMode?"CALENDAR":"ROOM_RATE",t.heading="ROOM_RATE"===t.stateCheck.activeMode?"Rooms & Rates":" Rate Calendar",t.setHeadingTitle(t.heading),$("#rooms-and-rates-header .switch-button").toggleClass("on")},t.showStayDateDetails=function(e){return e!==t.reservationData.departureDate&&(t.stateCheck.dateModeActiveDate=e,t.stateCheck.selectedStayDate=t.reservationData.rooms[t.stateCheck.roomDetails.firstIndex].stayDates[e],void S())},t.toggleEditGuestOptions=function(){t.stateCheck.guestOptionsIsEditable=!t.stateCheck.guestOptionsIsEditable},t.toggleStayDaysMode=function(){t.stateCheck.stayDatesMode=!t.stateCheck.stayDatesMode,S(),t.stateCheck.stayDatesMode?(t.stateCheck.rateSelected.allDays=E().allDays,t.stateCheck.rateSelected.oneDay=E().oneDay,t.containerHeight=t.containerHeight-70):t.containerHeight=t.containerHeight+70,t.refreshScroll(),d(function(){t.refreshScroller("stayDates")},150)},t.updateDayOccupancy=function(e){if(t.reservationData.rooms[t.stateCheck.roomDetails.firstIndex].stayDates[t.stateCheck.dateModeActiveDate].guests[e]=parseInt(t.stateCheck.selectedStayDate.guests[e]),t.reservationData.arrivalDate===t.stateCheck.dateModeActiveDate)for(var a=t.reservationData.rooms[t.stateCheck.roomDetails.firstIndex].stayDates[t.stateCheck.dateModeActiveDate].guests,r=t.stateCheck.roomDetails.firstIndex;r<=t.stateCheck.roomDetails.lastIndex;r++)t.reservationData.rooms[r].numAdults=a.adults,t.reservationData.rooms[r].numChildren=a.children,t.reservationData.rooms[r].numInfants=a.infants;if(!t.checkOccupancyLimit(t.stateCheck.dateModeActiveDate)){t.preferredType="",t.stateCheck.rateSelected.oneDay=!1,t.stateCheck.rateSelected.allDays=!1;for(var r=t.stateCheck.roomDetails.firstIndex;r<=t.stateCheck.roomDetails.lastIndex;r++)_.each(t.reservationData.rooms[r].stayDates,function(e){e.rate={id:""}})}S()},t.toggleClosedRates=function(){t.$emit("showLoader"),t.stateCheck.showClosedRates=!t.stateCheck.showClosedRates,S()},t.getLeastAvailability=function(e,a){var r=t.roomAvailability[e].ratedetails[t.reservationData.arrivalDate][a].availabilityCount;return angular.forEach(t.roomAvailability[e].ratedetails,function(e,n){(n===t.reservationData.arrivalDate||n!==t.reservationData.departureDate)&&e[a].availabilityCount<r&&(r=e[a].availabilityCount)}),r},t.getLeastHouseAvailability=function(e,a){var r=t.roomAvailability[e].ratedetails[t.reservationData.arrivalDate][a].houseAvailability;return angular.forEach(t.roomAvailability[e].ratedetails,function(e,n){(n===t.reservationData.arrivalDate||n!==t.reservationData.departureDate)&&e[a].houseAvailability<r&&(r=e[a].houseAvailability)}),r},t.getAllRestrictions=function(e,a){var r=[],n=[];return angular.forEach(t.roomAvailability[e].ratedetails,function(e,t){angular.forEach(e[a].restrictions,function(e){n.indexOf(e.value)<0&&(r.push(e),n.push(e.value))})}),r},t.setSameCardNgo=function(){t.reservationData.isSameCard=!0,l.go("rover.reservation.search")};var w=function(){t.$on("SIDE_BAR_OCCUPANCY_UPDATE",function(){S()}),t.$on("TABS_MODIFIED",function(){S()}),t.$on("resetGuestTab",function(){t.invokeApi(s.fetchUserMemberships,t.reservationDetails.guestCard.id||t.reservationData.guest.id,function(e){t.$emit("hideLoader"),t.reservationData.guestMemberships={ffp:e.frequentFlyerProgram,hlp:e.hotelLoyaltyProgram},t.reservationData.member.isSelected&&O()?S():t.reservationData.member.isSelected&&u.open({template:"/assets/partials/reservation/alerts/rvNotMemberPopup.html",className:"",scope:t,closeByDocument:!1,closeByEscape:!1})})}),t.$on("cardChanged",function(e,a){t.reservationData.company.id=a.companyCard,t.reservationData.travelAgent.id=a.travelAgent,t.initRoomRates()}),t.$on("switchToStayDatesCalendar",function(){t.stateCheck.activeMode="ROOM_RATE"===t.stateCheck.activeMode?"CALENDAR":"ROOM_RATE",$("#rooms-and-rates-header .switch-button").toggleClass("on")})},M=function(){f.disable_back_staycard||(l.params&&l.params.isFromChangeStayDates?e.setPrevState={title:"Stay Dates",name:"rover.reservation.staycard.changestaydates"}:t.reservationData&&t.reservationData.confirmNum&&t.reservationData.reservationId?e.setPrevState={title:v("translate")("STAY_CARD"),name:"rover.reservation.staycard.reservationcard.reservationdetails",param:{confirmationId:t.reservationData.confirmNum,id:t.reservationData.reservationId,isrefresh:!0}}:e.setPrevState={title:v("translate")("CREATE_RESERVATION"),callback:"setSameCardNgo",scope:t})},L=function(){t.setScroller("room_types",{preventDefault:!1}),t.setScroller("stayDates",{scrollX:!0,scrollY:!1})},x=function(){BaseCtrl.call(this,t),t.heading="Rooms & Rates",t.setHeadingTitle(t.heading),h.metaData.rateAddons=angular.copy(n),h.metaData.taxDetails=angular.copy(a.tax_codes),M(),S(!0),w(),L()};t.navigateOut=function(){"REINSTATE"===t.viewState.identifier||"rover.reservation.staycard.reservationcard.reservationdetails"!==f.fromState&&"STAY_CARD"!==f.fromState?t.enhanceStay():t.saveAndGotoStayCard()},t.onResetAddonsAcknowledged=function(){t.navigateOut(),t.closeDialog()};var F=function(){if(h.bookMark.lastPostedRate){var e=t.reservationData.rooms[0],a=e.rateId,r=e.addons,n=_.filter(r,function(e){return e.is_rate_addon}),o=_.filter(r,function(e){return!e.is_rate_addon}),i=h.fetchAssociatedAddons(a),s=!1;if(h.setReservationFlag("RATE_CHANGED",!0),e.addons=_.map(i,function(e){return _.extend(e,{is_rate_addon:!0})}),_.each(o,function(t){!t.allow_rate_exclusion||t.allow_rate_exclusion&&_.indexOf(t.excluded_rate_ids,a)<0?e.addons.push(t):s=!0}),s||b(r,n))return u.open({template:"/assets/partials/reservation/alerts/rateChangeAddonsAlert.html",scope:t,closeByDocument:!1,closeByEscape:!1}),!1}t.navigateOut()};x(),t.isRoomTypeSelected=function(e){var a=!1;return _.each(t.reservationData.tabs,function(r,n){
parseInt(r.roomTypeId,10)===e&&t.activeRoom!=n&&(a=!0)}),a},t.onRoomTypeChange=function(e){var a,r=t.viewState.currentTab,n=parseInt(t.stateCheck.preferredType,10)||"";for(t.reservationData.tabs[r].roomTypeId=n,a=t.stateCheck.roomDetails.firstIndex;a<=t.stateCheck.roomDetails.lastIndex;a++)t.reservationData.rooms[a].roomTypeId=n;t.filterRooms(e),t.resetRates()},t.changeActiveRoomType=function(e){return!t.stateCheck.stayDatesMode&&(t.activeRoom=e,t.viewState.currentTab=e,void S())},t.getBookButtonStyle=function(e,a){return t.stateCheck.restrictedContractedRates[e]&&t.stateCheck.restrictedContractedRates[e].indexOf(a)>-1?"red":t.stateCheck.stayDatesMode?t.roomAvailability[e].ratedetails[t.stateCheck.dateModeActiveDate]&&t.roomAvailability[e].ratedetails[t.stateCheck.dateModeActiveDate][a]&&t.roomAvailability[e].ratedetails[t.stateCheck.dateModeActiveDate][a].restrictions.length>0?"white brand-text":"white green-text":t.getAllRestrictions(e,a).length>0?"brand-colors":"green"};var B=function(e){var a=0,r=0;e&&(t.closeDialog(),r=1500),d(function(){for(;a<t.stateCheck.exhaustedAddons.length;a++){var e=t.stateCheck.exhaustedAddons[a];if(!e.isAlerted){e.isAlerted=!0,u.open({template:"/assets/partials/reservationCard/rvInsufficientInventory.html",className:"ngdialog-theme-default",closeByDocument:!0,scope:t,data:JSON.stringify({name:e.name,count:e.inventory,canOverbookInventory:D.getPermissionValue("OVERRIDE_ITEM_INVENTORY")})});break}}a===t.stateCheck.exhaustedAddons.length&&t.handleBooking(t.stateCheck.selectedRoomRate.roomId,t.stateCheck.selectedRoomRate.rateId,!1,{skipAddonCheck:!0})},r)};t.selectAddon=function(){B(!0)},t.toggleSearchWithRestrictions=function(){t.stateCheck.calendarState.searchWithRestrictions=!t.stateCheck.calendarState.searchWithRestrictions,t.$broadcast("availableRateFiltersUpdated")},t.toggleShowOnlyAvailable=function(){t.stateCheck.calendarState.showOnlyAvailableRooms=!t.stateCheck.calendarState.showOnlyAvailableRooms,t.$broadcast("availableRateFiltersUpdated")}}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){sntRover.controller("RVReservationSettingsCtrl",["$scope","RVReservationBaseSearchSrv","$state","$stateParams","dateFilter","$timeout","RVReservationTabService","$rootScope",function(e,t,a,r,n,o,i,s){e.reservationSettingsVisible=!1;var c=30,d=260;e.reservationSettingsWidth=c,e.isHourly="HOURLY"===r.reservation,e.resizableOptions={minWidth:c,maxWidth:d,handles:"e",resize:function(e,t){},stop:function(t,a){preventClicking=!0,e.eventTimestamp=t.timeStamp}},e.refreshScroll=function(){e.refreshScroller("reservation-settings"),e.myScroll&&e.myScroll["reservation-settings"]&&o(function(){e.myScroll["reservation-settings"].refresh()},300)},e.arrivalDateOptions={showOn:"button",dateFormat:"MM-dd-yyyy",numberOfMonths:2,yearRange:"-1:",minDate:tzIndependentDate(e.otherData.businessDate),beforeShow:function(e,t){$("#ui-datepicker-div").addClass("reservation arriving"),$('<div id="ui-datepicker-overlay" class="transparent" />').insertAfter("#ui-datepicker-div")},onClose:function(e,t){$("#ui-datepicker-div").removeClass("reservation arriving"),$("#ui-datepicker-overlay").remove()}},e.departureDateOptions={showOn:"button",dateFormat:"MM-dd-yyyy",numberOfMonths:2,yearRange:"-1:",minDate:tzIndependentDate(e.otherData.businessDate),beforeShow:function(e,t){$("#ui-datepicker-div").addClass("reservation departing"),$('<div id="ui-datepicker-overlay" class="transparent" />').insertAfter("#ui-datepicker-div")},onClose:function(e,t){$("#ui-datepicker-div").removeClass("reservation departing"),$("#ui-datepicker-overlay").remove()}};var l=function(t){t?e.reservationData.rooms[t].stayDates={}:(e.reservationData.stayDays=[],_.each(e.reservationData.rooms,function(e,t){e.stayDates={},e.rateId=""}));for(var a=1*new tzIndependentDate(e.reservationData.arrivalDate),r=1*new tzIndependentDate(e.reservationData.departureDate);a<=r;a+=864e5)t?e.reservationData.rooms[t].stayDates[n(new tzIndependentDate(a),"yyyy-MM-dd")]={guests:{adults:parseInt(e.reservationData.rooms[t].numAdults),children:parseInt(e.reservationData.rooms[t].numChildren),infants:parseInt(e.reservationData.rooms[t].numInfants)},rate:{id:"",name:""}}:(e.reservationData.stayDays.push({date:n(new tzIndependentDate(a),"yyyy-MM-dd"),dayOfWeek:n(new tzIndependentDate(a),"EEE"),day:n(new tzIndependentDate(a),"dd")}),_.each(e.reservationData.rooms,function(e){e.stayDates[n(new tzIndependentDate(a),"yyyy-MM-dd")]={guests:{adults:parseInt(e.numAdults),children:parseInt(e.numChildren),infants:parseInt(e.numInfants)},rate:{id:"",name:""}}}))};e.arrivalDateChanged=function(){e.reservationData.arrivalDate=n(e.reservationData.arrivalDate,"yyyy-MM-dd"),e.setDepartureDate(),e.setNumberOfNights(),l(),e.stayDatesClicked(),"undefined"!=typeof e.groupConfigData&&(e.reservationData.arrivalDate<e.groupConfigData.summary.block_from||e.reservationData.departureDate>e.groupConfigData.summary.block_to)&&(u(),s.$broadcast("groupCardDetached"))},e.departureDateChanged=function(){e.reservationData.departureDate=n(e.reservationData.departureDate,"yyyy-MM-dd"),e.setNumberOfNights(),l(),e.stayDatesClicked(),"undefined"!=typeof e.groupConfigData&&(e.reservationData.arrivalDate<e.groupConfigData.summary.block_from||e.reservationData.departureDate>e.groupConfigData.summary.block_to)&&(u(),s.$broadcast("groupCardDetached"))};var u=function(){e.reservationData.group&&e.reservationData.group.id&&(e.reservationData.group={},e.companySearchText="",e.codeSearchText="")};e.setDepartureDate=function(){var t=e.reservationData.numNights;null!==e.reservationData.numNights&&""!==e.reservationData.numNights||(t=1);var a=tzIndependentDate(e.reservationData.arrivalDate),r=a.getDate()+parseInt(t);a.setDate(r),e.reservationData.departureDate=n(a,"yyyy-MM-dd")},e.setNumberOfNights=function(){var t=tzIndependentDate(e.reservationData.arrivalDate),a=tzIndependentDate(e.reservationData.departureDate),r=Math.floor((Date.parse(a)-Date.parse(t))/864e5);r<0?(e.reservationData.numNights=1,o(e.setDepartureDate,1)):e.reservationData.numNights=r},e.accordionInitiallyNotCollapsedOptions={header:"a.toggle",heightStyle:"content",collapsible:!0,activate:function(t,a){isEmpty(a.newHeader)&&isEmpty(a.newPanel)?a.oldHeader.removeClass("active"):isEmpty(a.oldHeader)&&a.newHeader.addClass("active"),e.refreshScroll()}},e.accordionInitiallyCollapsedOptions={header:"a.toggle",collapsible:!0,heightStyle:"content",active:!1,activate:function(t,a){isEmpty(a.newHeader)&&isEmpty(a.newPanel)?a.oldHeader.removeClass("active"):isEmpty(a.oldHeader)&&a.newHeader.addClass("active"),e.refreshScroll()}},e.clickedOnReservationSettings=function(t){getParentWithSelector(t,document.getElementsByClassName("ui-resizable-e")[0])&&(e.reservationSettingsVisible?(e.reservationSettingsWidth=c,e.reservationSettingsVisible=!1):(e.reservationSettingsVisible=!0,e.reservationSettingsWidth=d))},e.$on("closeSidebar",function(){e.reservationSettingsWidth=c,e.reservationSettingsVisible=!1}),e.$on("GETREFRESHACCORDIAN",function(){o(e.refreshScroll,3e3)}),e.addTabFromSidebar=function(){return!!e.reservationData.tabs[e.reservationData.tabs.length-1].roomTypeId&&(e.reservationData.tabs.push(i.newTab()[0]),e.reservationData.rooms.push(i.newRoom()[0]),l(e.reservationData.rooms.length-1),void e.refreshScroll())},e.restrictMultipleBookings=function(){return!!e.reservationData.reservationId||4===e.reservationData.tabs.length||!!e.reservationData.group.id},e.removeTabFromSidebar=function(t){e.removeTab(t),e.refreshScroll()},e.setScroller("reservation-settings")}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){sntRover.controller("RVReservationSummaryCtrl",["$rootScope","jsMappings","$scope","$state","RVReservationSummarySrv","RVContactInfoSrv","$filter","$location","$stateParams","dateFilter","$vault","$timeout","ngDialog","RVPaymentSrv","RVReservationCardSrv","RVGuestCardSrv","rvPermissionSrv","RVReservationGuestSrv","$q","paymentMethods","RVReservationPackageSrv","RVAutomaticEmailSrv",function(e,t,a,r,n,o,i,s,c,d,l,u,m,f,p,v,D,h,y,g,C,A){function S(t){var a={id:t.value,isSelected:!0,card_code:t.card_code,is_primary:!1,payment_type:"CC",card_expiry:t.expiry_date,mli_token:t.ending_with,card_name:t.holder_name,payment_type_id:1};e.$broadcast("ADDEDNEWPAYMENTTOGUEST",a)}BaseCtrl.call(this,a),SharedMethodsBaseCtrl.call(this,a,e,A,m),a.isSubmitButtonEnabled=!1,""!==a.reservationData.reservationId&&(a.isSubmitButtonEnabled=!0);var I="rover.reservation.staycard.mainCard.room-rates";e.setPrevState={title:e.getPrevStateTitle()},a.passData={details:{firstName:a.reservationData.guest.firstName,lastName:a.reservationData.guest.lastName}},a.isSixCardSwiped=!1,a.addmode=!0,a.showCCPage=!1,a.addToGuestCard=!1,"undefined"==typeof a.renderData&&(a.renderData={},a.reservationEditMode=!1),a.isManual=!1,a.isNewCardAdded=!1,a.errorMessage="",a.depositData={depositAttemptFailure:!1,attempted:!1},a.summaryState={forceDemographicsData:!1,computedSegment:!1,selectedCardDetails:{value:""}},a.hasPermissionToMakePayment=function(){return D.getPermissionValue("MAKE_PAYMENT")},a.hideMakePayment=function(){return!a.hasPermissionToMakePayment()},a.feeData={};var T=parseFloat("0.00");a.successPaymentList=function(e){a.$emit("hideLoader"),a.cardsList=e,angular.forEach(a.cardsList,function(e,t){e.value=e.id,delete e.id})},a.fetchGuestCreditCards=function(){"undefined"==typeof a.cardsList&&null!==a.reservationData.guest.id&&a.invokeApi(v.fetchGuestPaymentData,a.reservationData.guest.id,a.successPaymentList)},"undefined"!=typeof a.reservationData.guest.id&&""!==a.reservationData.guest.id&&null!==a.reservationData.guest.id&&a.fetchGuestCreditCards(),a.isShowFees=function(){var e=!1,t=a.feeData;return"undefined"==typeof t||"undefined"==typeof t.feesInfo||null===t.feesInfo?e=!1:t.defaultAmount>=t.minFees&&a.isStandAlone&&t.feesInfo.amount&&(e=!0),e},a.calculateFee=function(){if(a.isStandAlone){var e=a.feeData.feesInfo,t="",r=T,n=T;"undefined"!=typeof e&&null!==e&&(t=e.amount_symbol,r=e.amount?parseFloat(e.amount):T,n=e.minimum_amount_for_fees?parseFloat(e.minimum_amount_for_fees):T);var o=""===a.reservationData.depositAmount?T:parseFloat(a.reservationData.depositAmount);if(a.feeData.minFees=n,a.feeData.defaultAmount=o,a.isShowFees())if("percent"===t){var i=parseFloat(o*(r/100));a.feeData.calculatedFee=parseFloat(i).toFixed(2),a.feeData.totalOfValueAndFee=parseFloat(i+o).toFixed(2)}else a.feeData.calculatedFee=parseFloat(r).toFixed(2),a.feeData.totalOfValueAndFee=parseFloat(o+r).toFixed(2)}},a.$on("UPDATEFEE",function(){a.feeData.feesInfo=a.reservationData.fees_details,a.setupFeeData(),a.calculateFee()}),a.setupFeeData=function(){var e=a.feeData.feesInfo?a.feeData.feesInfo:{},t=a.reservationData?parseFloat(a.reservationData.depositAmount):T,r=e.minimum_amount_for_fees?parseFloat(e.minimum_amount_for_fees):T;if(a.feeData.minFees=r,a.feeData.defaultAmount=t,a.isShowFees()&&"undefined"!=typeof e.amount&&null!==e){var n=e.amount_symbol,o=e.amount?parseFloat(e.amount):T;a.feeData.actualFees=o,"percent"===n?a.calculateFee():(a.feeData.calculatedFee=parseFloat(o).toFixed(2),a.feeData.totalOfValueAndFee=parseFloat(o+t).toFixed(2))}},a.calculateTotalAmount=function(e){var t="undefined"==typeof a.feeData.calculatedFee||""===a.feeData.calculatedFee||"-"===a.feeData.calculatedFee?T:parseFloat(a.feeData.calculatedFee),r="undefined"==typeof e||""===e?T:parseFloat(e);a.feeData.totalOfValueAndFee=parseFloat(r+t).toFixed(2)},a.reservationData.referanceText="";var E=function(){var e=a.newPaymentInfo.tokenDetails.isSixPayment?getSixCreditCardType(a.newPaymentInfo.tokenDetails.card_type).toLowerCase():getCreditCardType(a.newPaymentInfo.cardDetails.cardType).toLowerCase();return e},R=function(){var e=a.newPaymentInfo.tokenDetails.isSixPayment?a.newPaymentInfo.tokenDetails.token_no.substr(a.newPaymentInfo.tokenDetails.token_no.length-4):a.newPaymentInfo.cardDetails.cardNumber.slice(-4);return e},b=function(){var e=a.newPaymentInfo.tokenDetails.isSixPayment?a.newPaymentInfo.tokenDetails.expiry.substring(2,4):a.newPaymentInfo.cardDetails.expiryMonth,t=a.newPaymentInfo.tokenDetails.isSixPayment?a.newPaymentInfo.tokenDetails.expiry.substring(0,2):a.newPaymentInfo.cardDetails.expiryYear,r=e+" / "+t;return r},N=function(){var e=a.newPaymentInfo.tokenDetails.isSixPayment?a.newPaymentInfo.tokenDetails.expiry.substring(2,4):a.newPaymentInfo.cardDetails.expiryMonth,t=a.newPaymentInfo.tokenDetails.isSixPayment?a.newPaymentInfo.tokenDetails.expiry.substring(0,2):a.newPaymentInfo.cardDetails.expiryYear,r="20"+t+"-"+e+"-01";return r};a.$on("cancelCardSelection",function(){a.depositWithGiftCard=!1,a.hideCancelCard=!1,a.showCCPage=!1,a.reservationData.paymentType.type.value="",a.isManual=!1}),a.$on("MLI_ERROR",function(e,t){a.errorMessage=t}),a.$on("FAILURE_UPDATE_RESERVATION",function(e,t){a.errorMessage=t}),a.$on("FAILURE_SAVE_RESERVATION",function(e,t){a.errorMessage=t});var P=function(){var e=function(e){a.showSelectedCreditCard=!0,a.reservationData.selectedPaymentId=e.id,a.renderData.creditCardType=E(),a.renderData.endingWith=R(),a.renderData.cardExpiry=b(),a.isStandAlone&&(a.feeData.feesInfo=e.fees_information,a.setupFeeData()),a.isNewCardAdded=!0,a.$emit("hideLoader"),L()},t={};if(t.reservation_id=a.reservationData.reservationId,t.token=a.newPaymentInfo.tokenDetails.isSixPayment?a.newPaymentInfo.tokenDetails.token_no:a.newPaymentInfo.tokenDetails.session,t.card_code=a.newPaymentInfo.tokenDetails.isSixPayment?getSixCreditCardType(a.newPaymentInfo.tokenDetails.card_type).toLowerCase():a.newPaymentInfo.cardDetails.cardType,a.newPaymentInfo.tokenDetails.isSixPayment||(t.card_expiry=N()),t.card_name=a.newPaymentInfo.tokenDetails.isSixPayment?a.passData.details.firstName+" "+a.passData.details.lastName:a.newPaymentInfo.cardDetails.userName,(a.newPaymentInfo.tokenDetails.isSixPayment||a.isGiftCard)&&(a.isManual=!0),a.isGiftCard){if(a.showSelectedCreditCard=!0,a.reservationData.selectedPaymentId=t.id,a.renderData.creditCardType=E(),a.renderData.endingWith=R(),a.renderData.cardExpiry=b(),a.isStandAlone&&(a.feeData.feesInfo=t.fees_information,a.setupFeeData()),a.isNewCardAdded=!0,a.isGiftCard){a.reservationData.paymentType.type.value="GIFT_CARD";var r=function(e){a.giftCardAvailableBalance=e.amount,a.$emit("hideLoader")};a.invokeApi(p.checkGiftCardBalance,{card_number:a.newPaymentInfo.cardDetails.cardNumber},r)}else a.$emit("hideLoader");L()}else a.invokeApi(f.savePaymentDetails,t,e)};a.$on("TOKEN_CREATED",function(t,r){e.$emit("showLoader"),a.newPaymentInfo=r,a.showSelectedCreditCard=!1,a.showCCPage=!1,P()});var k=function(e){a.reservationData.selectedPaymentId=a.cardsList[e].value,a.renderData.creditCardType=a.cardsList[e].card_code.toLowerCase(),a.renderData.endingWith=a.cardsList[e].mli_token,a.renderData.cardExpiry=a.cardsList[e].card_expiry,a.showCCPage=!1,a.showSelectedCreditCard=!0,a.isStandAlone&&(a.feeData.feesInfo=a.cardsList[e].fees_details,a.setupFeeData()),L(),a.isNewCardAdded=!1};a.$on("cardSelected",function(e,t){k(t.index)}),a.checkReferencetextAvailable=function(){var e=!1;return angular.forEach(x,function(t,r){"CC"===a.reservationData.paymentType.type.value&&"CC"===t.value?angular.forEach(t.credit_card_list,function(t,r){"undefined"!=typeof a.renderData.creditCardType&&a.renderData.creditCardType.toUpperCase()===t.cardcode&&(e=!!t.is_display_reference)}):t.value===a.reservationData.paymentType.type.value&&(e=!!t.is_display_reference)}),e},a.showSelectedCreditCardButton=function(){return!(!a.showSelectedCreditCard||a.showCCPage||"CC"!==a.reservationData.paymentType.type.value||"sixpayments"===a.paymentGateway&&!a.isManual&&!a.reservationEditMode)},a.showCardInputType=function(){return"sixpayments"===a.paymentGateway&&"CC"===a.reservationData.paymentType.type.value&&!a.showCCPage},a.hidePaymentSelection=function(){return!!(a.showCCPage||a.depositData.attempted&&!a.depositData.depositAttemptFailure)},a.tryAgain=function(){a.errorMessage="",a.depositData.attempted=!1,a.depositData.depositSuccess=!1,a.depositData.depositAttemptFailure=!1};var O=function(){a.$$phase||a.$digest()};a.payDeposit=function(){var t=function(e){"CC"!==a.reservationData.paymentType.type.value&&(a.isNewCardAdded=!1),a.depositData.attempted=!0,a.depositData.depositSuccess=!0,a.depositData.authorizationCode=e.authorization_code,a.reservationData.selectedPaymentId=e.payment_method.id,a.reservationData.depositData=angular.copy(a.depositData),O(),a.$emit("hideLoader")},r=function(e){a.depositData.attempted=!0,a.depositData.depositAttemptFailure=!0,a.reservationData.depositData=angular.copy(a.depositData),a.paymentErrorMessage=e[0],O(),a.$emit("hideLoader")},n={postData:{bill_number:1,payment_type:a.reservationData.paymentType.type.value,amount:a.reservationData.depositAmount,payment_type_id:null,reservation_ids:a.reservationData.reservationIds},reservation_id:a.reservationData.reservationId};"CC"===n.postData.payment_type&&(n.postData.payment_type_id=a.reservationData.selectedPaymentId),"GIFT_CARD"===n.postData.payment_type&&(delete n.postData.payment_type_id,n.postData.card_number=$.trim(a.num)),a.isShowFees()&&(a.feeData.calculatedFee&&(n.postData.fees_amount=a.feeData.calculatedFee),a.feeData.feesInfo&&(n.postData.fees_charge_code_id=a.feeData.feesInfo.charge_code_id)),a.checkReferencetextAvailable()&&(n.postData.reference_text=a.reservationData.referanceText),"sixpayments"!==e.paymentGateway||a.isManual||"CC"!==a.reservationData.paymentType.type.value?a.invokeApi(f.submitPaymentOnBill,n,t,r):(n.postData.is_emv_request=!0,m.open({template:"/assets/partials/reservation/rvWaitingDialog.html",className:"ngdialog-theme-default",closeByDocument:!1,scope:a}),a.shouldShowWaiting=!0,f.submitPaymentOnBill(n).then(function(e){a.shouldShowWaiting=!1,a.isSixCardSwiped=!0,a.closeDialog(),t(e)},function(e){a.shouldShowWaiting=!1,a.isSixCardSwiped=!1,r(e),a.closeDialog()}))},a.submitReservationButtonClass=function(e){var t="grey";return e&&(t="green"),t},"HOURLY"!==c.reservation&&(e.setPrevState={title:i("translate")("ROOM_RATES"),name:I,param:{from_date:a.reservationData.arrivalDate,to_date:a.reservationData.departureDate,view:"ROOM_RATE",company_id:a.reservationData.company.id,travel_agent_id:a.reservationData.travelAgent.id,group_id:a.reservationData.group.id,allotment_id:a.reservationData.allotment.id,room_type_id:a.reservationData.tabs[a.viewState.currentTab].roomTypeId,adults:a.reservationData.tabs[a.viewState.currentTab].numAdults,children:a.reservationData.tabs[a.viewState.currentTab].numChildren}});var w=function(){(a.reservationData.guest.id||a.reservationData.company.id||a.reservationData.travelAgent.id||a.reservationData.group.id||a.reservationData.allotment.id)&&a.saveReservation()},M=function(){a.reservationData.guest.id||a.reservationData.company.id||a.reservationData.travelAgent.id||a.reservationData.group.id||a.reservationData.allotment.id?a.saveReservation():(u(function(){a.$emit("PROMPTCARD")},3e3),a.$watch("reservationData.guest.id",w),a.$watch("reservationData.company.id",w),a.$watch("reservationData.travelAgent.id",w))};a.isContinueDisabled=function(){var e=!1;e=!a.depositData.isDepositRequired||!a.reservationData.isValidDeposit||!!a.depositData.attempted;var t="OTHER"!==c.mode&&"EDIT_HOURLY"!==c.mode||!(a.reservationData.guest.id||a.reservationData.company.id||a.reservationData.travelAgent.id||a.reservationData.group.id||a.reservationData.allotment.id),r=null===a.reservationData.paymentType.type.value||"undefined"==typeof a.reservationData.paymentType.type.value||0===a.reservationData.paymentType.type.value.length,n=t||!e;return e||(n=n||r),n},a.init=function(){if(a.isStandAlone){a.feeData.feesInfo=a.reservationData.selected_payment_fees_details,a.setupFeeData();var t="",r=_.sortBy(a.otherData.segments,"los");angular.forEach(r,function(e){a.reservationData.stayDays.length-1<=e.los&&(t||(t=e.value))}),t&&(a.summaryState.computedSegment=!0),a.reservationData.demographics.segment=t,angular.forEach(a.reservationData.rooms,function(e){e.demographics&&(e.demographics.segment=a.reservationData.demographics.segment)})}if(a.data={},a.cards={available:!1,activeView:"NEW"},"HOURLY"===c.reservation){if(a.$emit("showLoader"),a.reservationData.isHourly=!0,a.reservationData.paymentType.type.value="","rover.reservation.staycard.mainCard.addons"!==e.previousState.name||"EDIT_HOURLY"===c.mode){var o=l.get("temporaryReservationDataFromDiaryScreen");if(o=JSON.parse(o)){var i=function(t){var r={};if(angular.forEach(t.rooms,function(e,t){var a=e.id;r[a]=e}),"EDIT_HOURLY"===c.mode){var n=o.rooms[0];n.payment.payment_method_used&&(a.reservationData.paymentType.type.description=n.payment.payment_method_description,a.reservationData.paymentType.type.value=n.payment.payment_method_used,"CC"===a.reservationData.paymentType.type.value&&(a.renderData.creditCardType=n.payment.payment_details.card_type_image.replace(".png","").toLowerCase(),a.renderData.endingWith=n.payment.payment_details.card_number,a.renderData.cardExpiry=n.payment.payment_details.card_expiry,a.renderData.isSwiped=n.payment.payment_details.is_swiped,a.reservationData.selectedPaymentId=n.payment.payment_details.id,"sixpayments"===e.paymentGateway&&(n.payment.payment_details.is_swiped?a.reservationEditMode=!0:a.isManual=!0)),a.showSelectedCreditCard=!0),a.invokeApi(C.getReservationPackages,n.reservation_id,function(e){o.addons=e.existing_packages,a.populateDatafromDiary(r,o,!0),M(),L()})}else a.populateDatafromDiary(r,o,!0),M(),L()};a.invokeApi(n.fetchRooms,{},i)}}else M(),L();a.depositData={},a.reservationData.depositData?a.depositData=a.reservationData.depositData:(a.depositData.isDepositRequired=!1,a.depositData.description="",a.reservationData.depositAmount=0,a.depositData.depositSuccess=!a.depositData.isDepositRequired,a.depositData.attempted=!1,a.depositData.depositAttemptFailure=!1)}else{if(a.reservationData.depositData)a.depositData=a.reservationData.depositData;else{a.depositData={};var s=a.reservationData.rooms[0].stayDates[a.reservationData.arrivalDate].rate.id;a.depositData.isDepositRequired=!!a.reservationData.ratesMeta[s].deposit_policy.id,a.depositData.description=a.reservationData.ratesMeta[s].deposit_policy.description,a.depositData.depositSuccess=!a.depositData.isDepositRequired,a.depositData.attempted=!1,a.depositData.depositAttemptFailure=!1}M()}a.fetchDemoGraphics(),a.otherData.isGuestPrimaryEmailChecked=null!==a.reservationData.guest.email&&""!==a.reservationData.guest.email,a.otherData.isGuestAdditionalEmailChecked=!1,a.reservationData.paymentMethods=g,a.data.MLIData={},a.isGuestEmailAlreadyExists=null!==a.reservationData.guest.email&&""!==a.reservationData.guest.email,a.heading="Guest Details & Payment",a.setHeadingTitle(a.heading),a.setScroller("reservationSummary",{click:!0}),a.setScroller("paymentInfo",{preventDefaultException:{tagName:/^(INPUT|TEXTAREA|BUTTON|SELECT|A|DIV|SPAN|LABEL)$/}}),a.setScroller("cardsList",{click:!0,tap:!0}),L()},a.$on("UPDATEDEPOSIT",function(){a.depositData=a.reservationData.depositData});var L=function(){u(function(){a.refreshScroller("reservationSummary"),a.refreshScroller("paymentInfo"),a.refreshScroller("cardsList")},2e3)},x={};a.confirmEmailCheckboxClicked=function(){a.reservationData.guest.sendConfirmMailTo="",a.data.isConfirmationEmailSameAsGuestEmail&&(a.reservationData.guest.sendConfirmMailTo=a.reservationData.guest.email),a.refreshPaymentScroller()},a.goToConfirmationScreen=function(){r.go("rover.reservation.staycard.mainCard.reservationConfirm",{id:a.reservationData.reservationId,confirmationId:a.reservationData.confirmNum})},a.confirmReservation=function(e){if(!a.isDemographicsFormValid(!0))return a.summaryState.forceDemographicsData=!0,void a.setDemographics(!0);var t=a.computeReservationDataforUpdate(!0,!0);t.payment_type={},angular.forEach(a.reservationData.paymentMethods,function(e,r){e.value===a.reservationData.paymentType.type.value&&(t.payment_type.type_id=e.id)}),"CC"===a.reservationData.paymentType.type.value&&(t.payment_type.payment_method_id=a.reservationData.selectedPaymentId);var o=function(e){console.log(e),console.log(a.reservationData),"CC"===a.reservationData.paymentType.type.value&&a.addToGuestCard&&S(a.summaryState.selectedCardDetails),r.go("rover.reservation.staycard.mainCard.reservationConfirm",{id:a.reservationData.reservationId,confirmationId:a.reservationData.confirmNum})};e?o():""!==a.reservationData.reservationId&&null!==a.reservationData.reservationId&&"undefined"!=typeof a.reservationData.reservationId?(t.reservationId=a.reservationData.reservationId,t.reservation_ids=a.reservationData.reservationIds,t.addons=a.existingAddons,t.add_to_guest_card=a.addToGuestCard,a.invokeApi(n.updateReservation,t,o)):a.invokeApi(n.saveReservation,t,o)};var F=function(){return a.isDemographicsFormValid(!0)?void a.confirmReservation(!0):(a.summaryState.forceDemographicsData=!0,void a.setDemographics(!0))},B=function(e,t){var r=[];a.$emit("showLoader");var o=function(t){a.$emit("hideLoader"),e(!0)},i=function(e){a.$emit("hideLoader"),a.errorMessage=e},s=a.reservationData.checkinTime&&a.reservationData.checkinTime.hh?a.reservationData.checkinTime.hh+":"+a.reservationData.checkinTime.mm+" "+a.reservationData.checkinTime.ampm:null,c=a.reservationData.checkoutTime&&a.reservationData.checkoutTime.hh?a.reservationData.checkoutTime.hh+":"+a.reservationData.checkoutTime.mm+" "+a.reservationData.checkoutTime.ampm:null,d=null!==s?moment(s,"hh:mm A").format("HH:mm"):null,l=null!==c?moment(c,"hh:mm A").format("HH:mm"):null,u={arrival_time:d,departure_time:l,arrival_date:a.reservationData.arrivalDate,departure_date:a.reservationData.departureDate,payment_type:{},guest_detail_id:a.reservationData.guest.id};null!==a.reservationData.paymentType.type.value&&angular.forEach(a.reservationData.paymentMethods,function(e){a.reservationData.paymentType.type.value===e.name&&("CC"===a.reservationData.paymentType.type.value?(u.payment_type.payment_method_id=a.summaryState.selectedCardDetails.value,u.add_to_guest_card=t):u.payment_type.type_id=e.id)}),a.errorMessage=[];var m=function e(){a.reservationData.reservationId?(_.each(a.reservationData.rooms,function(e,t){u.reservationId=a.reservationData.reservationIds&&a.reservationData.reservationIds[t]||a.reservationData.reservationId,r.push(n.updateReservation(u))}),y.all(r).then(o,i)):setTimeout(e,100)};m()};a.onPayDepositLater=function(){B(a.confirmReservation)},a.clickedContinueButton=function(){B(F,a.addToGuestCard)},a.proceedCreatingReservation=function(){var e=a.computeReservationDataforUpdate(!1,!0),t=function(e){"undefined"!=typeof e.reservations&&e.reservations instanceof Array?(angular.forEach(e.reservations,function(e,t){angular.forEach(a.reservationData.rooms,function(t,a){parseInt(e.room_id)===parseInt(t.room_id)&&(t.confirm_no=e.confirm_no)})}),a.reservationData.reservations=e.reservations,a.reservationData.reservationId=a.reservationData.reservations[0].id,a.reservationData.confirmNum=a.reservationData.reservations[0].confirm_no,a.reservationData.status=a.reservationData.reservations[0].status,a.viewState.reservationStatus.number=a.reservationData.reservations[0].id):(a.reservationData.reservationId=e.id,a.reservationData.confirmNum=e.confirm_no,a.reservationData.rooms[0].confirm_no=e.confirm_no,a.reservationData.status=e.status,a.viewState.reservationStatus.number=e.id),a.viewState.reservationStatus.confirm=!0,a.reservationData.is_routing_available=!1,a.viewState.identifier="CONFIRM",a.reservation={reservation_card:{}},a.reservation.reservation_card.arrival_date=a.reservationData.arrivalDate,a.reservation.reservation_card.departure_date=a.reservationData.departure_time,a.$emit("hideLoader")},o=function(e){a.$emit("hideLoader");var t=!1,r="";angular.forEach(e,function(e,a){"Room not available for the selected number of hours. Please choose another room"===e&&(t=!0,r=e)}),t?a.showRoomNotAvailableDialog(r):a.errorMessage=e},i=function(e){a.$emit("hideLoader"),a.viewState.identifier="UPDATED",a.reservationData.is_routing_available=e.is_routing_available,"CC"===a.reservationData.paymentType.type.value&&a.addToGuestCard&&S(a.summaryState.selectedCardDetails),r.go("rover.reservation.staycard.mainCard.reservationConfirm",{id:a.reservationData.reservationId,confirmationId:a.reservationData.confirmNum})};e.payment_type={},angular.forEach(a.reservationData.paymentMethods,function(t,r){t.value===a.reservationData.paymentType.type.value&&(e.payment_type.type_id=t.id)}),"CC"===a.reservationData.paymentType.type.value&&(e.payment_type.payment_method_id=a.reservationData.selectedPaymentId),e.add_to_guest_card=a.addToGuestCard,""!==a.reservationData.reservationId&&null!==a.reservationData.reservationId&&"undefined"!=typeof a.reservationData.reservationId?(e.reservation_ids=a.reservationData.reservationIds,e.reservationId=a.reservationData.reservationId,e.addons=a.existingAddons,a.invokeApi(n.updateReservation,e,i,o)):a.invokeApi(n.saveReservation,e,t,o)},a.showRoomNotAvailableDialog=function(e){a.status="error",a.popupMessage=e,m.open({template:"/assets/partials/reservation/rvShowRoomNotAvailableMessage.html",controller:"RVShowRoomNotAvailableCtrl",className:"",scope:a})},a.submitReservation=function(){return a.errorMessage=[],(a.otherData.isGuestPrimaryEmailChecked&&""===a.reservationData.guest.email||a.otherData.isGuestAdditionalEmailChecked&&""===a.otherData.additionalEmail)&&(a.errorMessage=[i("translate")("INVALID_EMAIL_MESSAGE")]),"sixpayments"!==e.paymentGateway&&null!==a.reservationData.paymentType.type&&("CC"!==a.reservationData.paymentType.type.value||""!==a.data.MLIData.session&&void 0!==a.data.MLIData.session||(a.errorMessage=[i("translate")("INVALID_CREDIT_CARD")])),!(a.errorMessage.length>0)&&void a.proceedCreatingReservation()},a.cancelButtonClicked=function(){if("STAY_CARD"===a.viewState.identifier){var e={id:a.reservationData.reservationId,confirmationId:a.reservationData.confirmNum,isrefresh:!1,justCreatedRes:!0};r.go("rover.reservation.staycard.reservationcard.reservationdetails",e)}else a.initReservationData(),r.go("rover.reservation.search")},a.changeOnsiteCallIn=function(){a.isManual?a.showCCPage=!0:"",L()},a.$on("changeOnsiteCallIn",function(e){a.isManual=!a.isManual,a.changeOnsiteCallIn()}),a.giftCardAmountAvailable=!1,a.giftCardAvailableBalance=0,a.$on("giftCardAvailableBalance",function(e,t){a.giftCardAvailableBalance=t.amount}),a.timer=null,a.cardNumberInput=function(e,t){if(a.isGiftCard){var r=e.length;a.num=e,r>=8&&r<=22?$("[name=card-number]").keydown(function(){clearTimeout(a.timer),a.timer=setTimeout(a.fetchGiftCardBalance,1500)}):a.giftCardAmountAvailable=!1}},a.num,a.fetchGiftCardBalance=function(){if(a.isGiftCard){var e=function(e){a.giftCardAvailableBalance=e.amount,a.giftCardAmountAvailable=!0,a.$emit("giftCardAvailableBalance",e),a.$emit("hideLoader")};a.invokeApi(p.checkGiftCardBalance,{card_number:a.num},e)}else a.giftCardAmountAvailable=!1},a.setGiftCardParams=function(){a.shouldShowIframe=!1,a.addmode=!1,a.shouldShowAddNewCard=!1,a.showCCPage=!1,a.giftCardDetails=a.reservationData.paymentType},a.isGiftCardType=function(){return"GIFT_CARD"===a.reservationData.paymentType.type.value},
a.isGiftCard=!1,a.changePaymentType=function(){a.isGiftCard=a.isGiftCardType(),"CC"===a.reservationData.paymentType.type.value?("sixpayments"===e.paymentGateway?"":a.showCCPage=!0,a.isNewCardAdded="sixpayments"===e.paymentGateway,a.isManual="sixpayments"!==e.paymentGateway&&"",L(),a.cardsList="undefined"!=typeof a.cardsList?a.cardsList:[],a.addmode=!(a.cardsList.length>0),a.addmode&&e.$broadcast("CLICK_ADD_NEW_CARD"),a.isGiftCard&&a.setGiftCardParams()):(a.isSubmitButtonEnabled=!0,a.isNewCardAdded=!1,angular.forEach(x,function(e,t){e.value===a.reservationData.paymentType.type.value&&"CC"!==e.value&&(a.feeData.feesInfo=e.charge_code.fees_information,a.setupFeeData())})),a.refreshPaymentScroller()},a.refreshPaymentScroller=function(){a.refreshScroller("paymentInfo")},a.primaryEmailEntered=function(){var e={email:a.reservationData.guest.email},t={data:e,userId:a.reservationData.guest.id},r=function(e){a.$emit("guestEmailChanged"),a.$emit("hideLoader")},n=function(e){a.$emit("hideLoader")};a.invokeApi(o.updateGuest,t,r,n)},a.clickedOnsite=function(){a.isOnsiteActive=!0,a.isIframeVisible=!1,"CC"===a.reservationData.paymentType.type.value?a.isSixPaymentGatewayVisible=!0:a.isSixPaymentGatewayVisible=!1,a.isSixPaymentGatewayVisible=!1,a.refreshPaymentScroller()},a.clickedCallIn=function(){a.isOnsiteActive=!1,a.isIframeVisible=!0,a.isSixPaymentGatewayVisible=!0,a.reservationData.paymentType.type.value="CC",a.refreshPaymentScroller()},a.getBillingInfoTitle=function(){return a.reservationData.is_routing_available?i("translate")("BILLING_INFO_TITLE"):i("translate")("ADD_BILLING_INFO_TITLE")},a.$on("BILLINGINFOADDED",function(){a.reservationData.is_routing_available=!0}),a.$on("BILLINGINFODELETED",function(e,t){0===t.length&&(a.reservationData.is_routing_available=!1)}),a.openBillingInformation=function(r){r?angular.forEach(a.reservationData.reservations,function(e,t){e.confirm_no===r&&(a.reservationData.confirm_no=e.confirm_no,a.reservationData.reservation_id=e.id,a.reservationData.reservation_status=e.status)}):(a.reservationData.confirm_no=a.reservationData.confirmNum,a.reservationData.reservation_id=a.reservationData.reservationId,a.reservationData.reservation_status=a.reservationData.status),null!==a.reservationData.guest.id?a.reservationData.user_id=a.reservationData.guest.id:a.reservationData.user_id=a.reservationData.company.id,a.$emit("showLoader"),t.fetchAssets(["addBillingInfo","directives"]).then(function(){a.$emit("hideLoader"),e.UPDATED_BI_ENABLED_ON.RESERVATION?(console.log("##Billing-info updated version"),m.open({template:"/assets/partials/billingInformation/reservation/rvBillingInfoReservationMain.html",controller:"rvBillingInfoReservationMainCtrl",className:"",scope:a})):(console.log("##Billing-info old version"),m.open({template:"/assets/partials/bill/rvBillingInformationPopup.html",controller:"rvBillingInformationPopupCtrl",className:"",scope:a}))})},a.updateAdditionalDetails=function(e,t,r){var o=[];a.$emit("showLoader");var i=function(e){a.$emit("hideLoader"),a.closeDialog(),r&&u(function(){a.confirmReservation(!0)},700)},s=function(e){a.$emit("hideLoader"),a.errorMessage=e},c={reservation_type_id:parseInt(a.demographics.reservationType),source_id:parseInt(a.demographics.source),market_segment_id:parseInt(a.demographics.market),booking_origin_id:parseInt(a.demographics.origin),segment_id:parseInt(a.demographics.segment)};a.errorMessage=[],"undefined"==typeof t?_.each(a.reservationData.rooms,function(e,t){e.demographics=angular.copy(a.demographics),a.reservationData.demographics=angular.copy(a.demographics),c.reservationId=a.reservationData.reservationIds&&a.reservationData.reservationIds[t]||a.reservationData.reservationId,o.push(n.updateReservation(c))}):(a.reservationData.rooms[t].demographics=angular.copy(a.demographics),a.reservationData.demographics=angular.copy(a.demographics),c.reservationId=e,o.push(n.updateReservation(c))),y.all(o).then(i,s)},e.$on("UPDATERESERVATIONTYPE",function(e,t,r){a.reservationData.reservation_type=t,r&&(a.reservationData.reservation_card.payment_details.id=r)}),a.setDemographics=function(e,t){a.shouldShowReservationType=a.otherData.reservationTypes.length>0,a.shouldShowMarket=a.otherData.markets.length>0,a.shouldShowSource=a.otherData.sources.length>0,a.shouldShowOriginOfBooking=a.otherData.origins.length>0,a.shouldShowSegments=a.otherData.segments.length>0,a.demographics=a.reservationData.rooms[t]&&a.reservationData.rooms[t].demographics||angular.copy(a.reservationData.demographics),"undefined"==typeof a.reservationData.reservation_type||a.reservationData.group.id||(a.demographics.reservationType=a.reservationData.reservation_type),e&&(a.shouldShowReservationType=!!(a.otherData.reservationTypeIsForced&&a.otherData.reservationTypes.length>0),a.shouldShowMarket=!!(a.otherData.marketIsForced&&a.otherData.markets.length>0),a.shouldShowSource=!!(a.otherData.sourceIsForced&&a.otherData.sources.length>0),a.shouldShowOriginOfBooking=!!(a.otherData.originIsForced&&a.otherData.origins.length>0),a.shouldShowSegments=!!(a.otherData.segmentsIsForced&&a.otherData.segments.length>0)),m.open({template:"/assets/partials/reservation/rvReservationDemographicsPopup.html",className:"",scope:a,closeByDocument:!1,closeByEscape:!1,data:JSON.stringify({data:t})})};var G=function(e){var t=!0;return a.otherData.reservationTypeIsForced&&a.otherData.reservationTypes&&a.otherData.reservationTypes.length>0&&(t=""!==e.reservationType&&null!==e.reservationType),a.otherData.marketsEnabled&&a.otherData.marketIsForced&&a.otherData.markets.length>0&&t&&(t=""!==e.market),a.otherData.sourcesEnabled&&a.otherData.sourceIsForced&&a.otherData.sources.length>0&&t&&(t=""!==e.source),a.otherData.originsEnabled&&a.otherData.originIsForced&&a.otherData.origins.length>0&&t&&(t=""!==e.origin),a.otherData.segmentsEnabled&&a.otherData.segmentsIsForced&&a.otherData.segments.length>0&&t&&(t=""!==e.segment),t};a.isDemographicsFormValid=function(e){var t,r=!0;return e?(a.otherData.reservationTypeIsForced||a.otherData.marketIsForced||a.otherData.sourceIsForced||a.otherData.originIsForced)&&_.each(a.reservationData.rooms,function(e){e.demographics?(t=e.demographics,r=G(t)):r=!1}):_.each(a.reservationData.rooms,function(e){t=a.demographics||e.demographics||a.reservationData.demographics,r=G(t)}),r},a.$on("SWIPE_ACTION",function(e,t){var r=new SwipeOperation,n=r.createDataToTokenize(t),o=function(e){a.$emit("hideLoader"),t.token=e;var n=r.createSWipedDataToRender(t);a.reservationData.paymentType.type.value="CC",a.newPaymentInfo={tokenDetails:{isSixPayment:!1},cardDetails:{expiryMonth:n.cardExpiryMonth,expiryYear:n.cardExpiryYear,userName:n.nameOnCard,cardNumber:n.cardNumber,cardType:n.cardType}},a.$broadcast("RENDER_SWIPED_DATA",n)};a.invokeApi(p.tokenize,n,o)});var V=function(e,t){a.showCCPage=!1,a.showSelectedCreditCard=!0,a.reservationData.selectedPaymentId=e.id,a.renderData.creditCardType=t.cardType.toLowerCase(),a.renderData.endingWith=t.cardNumber.slice(-4),a.renderData.cardExpiry=t.cardExpiryMonth+"/"+t.cardExpiryYear,a.isNewCardAdded=!0};a.$on("SWIPED_DATA_TO_SAVE",function(e,t){var r=t;r.reservation_id=a.reservationData.reservationId,r.payment_credit_type=t.cardType,r.credit_card=t.cardType,r.card_expiry="20"+t.cardExpiryYear+"-"+t.cardExpiryMonth+"-01",r.add_to_guest_card=t.addToGuestCard;var n={params:r,successCallBack:V,successCallBackParameters:t};a.callAPI(f.savePaymentDetails,n)}),a.$on("resetGuestTab",function(e,t){var r={fname:void 0!==a.reservationData.guest.firstName?a.reservationData.guest.firstName:a.guestCardData.contactInfo.first_name,lname:void 0!==a.reservationData.guest.lastName?a.reservationData.guest.lastName:a.guestCardData.contactInfo.last_name};a.passData.details.firstName=a.reservationData.guest.firstName,a.passData.details.lastName=a.reservationData.guest.lastName,a.$broadcast("refreshIframe",r),a.fetchGuestCreditCards()}),a.addGuests=function(e){if(!e.accompanying_guest_details){var t={ADULT:[],CHILDREN:[],INFANTS:[]};a.applyGuestCountRuleOnAccompanyingGuests(e.numAdults,e.numChildren,e.numInfants,t),angular.extend(e,{accompanying_guest_details:t})}L()},a.saveAccompanyingGuests=function(e,t){a.errorMessage="";var r=[];_.each(e.accompanying_guest_details,function(e,t){_.each(e,function(e){r.push({first_name:e.first_name,last_name:e.last_name,guest_type:e.guest_type,guest_type_id:e.guest_type_id})})});var n=function(){a.$emit("hideLoader")},o=function(e){a.errorMessage=e,a.$emit("hideLoader")};r.length>0&&a.invokeApi(h.updateGuestTabDetails,{accompanying_guests_details:r,reservation_id:a.reservationData.reservationIds[t]},n,o)},a.addListener("REFRESH_SCROLL_SUMMARY",function(){a.refreshScroller("reservationSummary")}),a.$on("PAY_LATER",function(e,t){a.reservationData.paymentType.ccDetails=t.cardDetails,a.reservationData.selectedPaymentId=t.cardDetails.value,a.reservationData.paymentType.type.value=t.paymentType,B(a.confirmReservation,t.addToGuestCard)}),a.$on("PAYMENT_SUCCESS",function(t,r){"CC"!==a.reservationData.paymentType.type.value&&(a.isNewCardAdded=!1),a.depositData.attempted=!0,a.depositData.depositSuccess=!0,a.currentPaymentBillId=r.bill_id,a.currentPaymentTransactionId=r.transaction_id,a.isDepositPayment=r.is_deposit_payment,(e.autoEmailPayReceipt||e.autoEmailDepositInvoice&&a.isDepositPayment)&&a.autoTriggerPaymentReceiptActions(),a.depositData.authorizationCode=r.authorization_code,a.reservationData.selectedPaymentId=r.payment_method.id,a.isDepositPayment=r.is_deposit_payment,a.reservationData.depositData=angular.copy(a.depositData),O(),a.$emit("hideLoader")}),a.$on("AUTO_TRIGGER_EMAIL_AFTER_PAYMENT",function(e,t){a.guestCardData.contactInfo.email=t,a.sendAutomaticEmails(t)}),a.$on("PAYMENT_FAILED",function(e,t){a.depositData.attempted=!0,a.depositData.depositAttemptFailure=!0,a.reservationData.depositData=angular.copy(a.depositData),a.paymentErrorMessage=t[0],a.errorMessage=t,O(),a.$emit("hideLoader")}),a.$on("PAYMENT_TOGGLE_ATTACH_TO_GUEST_CARD",function(e,t){a.addToGuestCard=t}),a.$on("PAYMENT_SCREEN_MODE_CHANGED",function(){u(function(){a.refreshScroller("paymentInfo")},300)}),a.shouldIncludeScrollFixClass=!1,a.$on("PAYMENT_TYPE_CHANGED",function(e,t){"CC"===t?a.shouldIncludeScrollFixClass=!0:a.shouldIncludeScrollFixClass=!1,u(function(){a.refreshScroller("paymentInfo")},700)});var U=function(t){var a=_.find(e.guestTypes,{value:t});return a.id},q=function(e,t,a){if(t>0)for(var r=0;r<t;r++)a.push({first_name:"",last_name:"",guest_type:e,guest_type_id:U(e)})};a.applyGuestCountRuleOnAccompanyingGuests=function(e,t,a,r){e=parseInt(e),t=parseInt(t),a=parseInt(a);var n=e+t+a;n>1&&(q("ADULT",e-1,r.ADULT),q("CHILDREN",t,r.CHILDREN),q("INFANTS",a,r.INFANTS))},a.getGuestTypeIconClass=function(e){var t="adult";return"CHILDREN"===e?t="student":"INFANTS"===e&&(t="infant"),t},a.showAccompanyingGuestSectionBasedOnGuestCount=function(e){return e&&parseInt(e.numAdults)+parseInt(e.numChildren)+parseInt(e.numInfants)>1},a.init(),a.addListener("CREATE_RESERVATION_AFTER_BORROW",function(){a.init()}),a.addListener("SHOW_ROOM_AND_RATES_AFTER_BORROW_DECLINE",function(){r.go(I,e.setPrevState.param)})}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){sntRover.controller("RVRoomRatesCalendarCtrl",["$state","$stateParams","$rootScope","$scope","RVStayDatesCalendarSrv","$filter","$timeout",function(e,t,a,r,n,o,i){BaseCtrl.call(this,r);var s=null,c=function(e){return d(e)},d=function(e){var e=new Date(e),t=e.getFullYear(),r=e.getMonth(),n=tzIndependentDate(a.businessDate),i=n.getMonth(),s=n.getFullYear(),c=r+100*t>i+100*s?1:parseInt(tzIndependentDate(a.businessDate).getDate());return o("date")(new Date(t,r,c),a.dateFormatForAPI)},l=function(e){var e=new Date(e),t=e.getFullYear(),r=e.getMonth();return o("date")(new Date(t,r+2,0),a.dateFormatForAPI)},u=function(e){var t,a=_.findWhere(e.rates,{id:r.stateVariables.selectedRate});if(!w()&&""!==r.stateVariables.selectedRoom&&""!==r.stateVariables.selectedRate){var n="undefined"!=typeof a?_.findWhere(a.room_rates,{room_type_id:r.stateVariables.selectedRoom}):void 0;return"undefined"==typeof n||"undefined"!=typeof _.findWhere(n.restrictions,{restriction_type_id:2})}t=_.reduceRight(e.rates,function(e,t){return e.concat(t.room_rates)},[]),M()&&""!==r.stateVariables.selectedRoom?t=_.filter(t,function(e){return e.id===r.stateVariables.selectedRoom}):M()&&""!==r.stateVariables.selectedRate&&(t="undefined"!=typeof a?a.room_rates:[]);for(var o=_.pluck(t,"restrictions"),i=0;i<o.length;i++)if("undefined"==typeof _.findWhere(o[i],{restriction_type_id:2}))return!1;return!0},m=function(e){var t="",a=r.reservationData;e.house.availability;if(e.date===a.arrivalDate&&(t+="check-in ",u(e)))return t+="unavailable ";e.date===a.departureDate&&(t+="check-out ");var n=f(e);return""!==n||"undefined"==n?t+="unavailable ":e.date!==a.departureDate&&(t+="available "),t},f=function(e){var t=e.house.availability;if(r.stateVariables.selectedRoom=null==r.stateVariables.selectedRoom?"":r.stateVariables.selectedRoom,r.stateVariables.selectedRate=null==r.stateVariables.selectedRate?"":r.stateVariables.selectedRate,t<=0)return t.toString();if(w())return"";if(!p(e))return e.room_types[r.stateVariables.selectedRoom].toString();if(""!==r.stateVariables.selectedRate&&""!==r.stateVariables.selectedRoom){var a=_.findWhere(e.rates,{id:r.stateVariables.selectedRate}),n="undefined"!=typeof a?_.findWhere(a.room_rates,{room_type_id:r.stateVariables.selectedRoom}):void 0;return"undefined"!=typeof n?"":"undefined"}if(""!==r.stateVariables.selectedRate){var a=_.findWhere(e.rates,{id:r.stateVariables.selectedRate});return a&&_.reduce(a.room_rates,function(e,t){return t.availability>0?e.concat(t):e},[]).length>0?"":"undefined"}return""},p=function(e){return!(""!==r.stateVariables.selectedRoom&&e.room_types[r.stateVariables.selectedRoom]<=0)},v=function(){var e={};return e.room_type_name="",e.rate_name="",e.availability="",e.restrictions=[],e},D=function(e){for(var t=_.reject(e.rates,function(e){return r.stateVariables.selectedRate=null==r.stateVariables.selectedRate?"":r.stateVariables.selectedRate,M()&&e.id!==r.stateVariables.selectedRate&&""!=r.stateVariables.selectedRate}),a=_.pluck(t,"room_rates"),n=_.reject(a[0],function(t){return!h(t,e)}),o=a[0],i=_.min(_.pluck(n,"single")),s=_.findWhere(n,{single:i}),i=null===i?0:i,c=i,d=null,l=1;l<a.length;l++)d=_.reject(a[l],function(t){return!h(t,e)}),i=_.min(_.pluck(d,"single")),null!==i&&i<=c&&(c=i,o=a[l],s=_.findWhere(d,{single:i}));c=c==1/0?"":c;var u={};return u.bestAvailableRate=c.toString(),""!=c?(u.room_type_name=_.findWhere(r.stateVariables.rooms,{id:s.room_type_id}).name,u.rate_name=_.findWhere(r.stateVariables.rates,{id:_.findWhere(t,{room_rates:o}).id}).name,u.rateCurrency=_.findWhere(r.stateVariables.rates,{id:_.findWhere(t,{room_rates:o}).id}).rate_currency,u.availability=s.availability,_.each(s.restrictions,function(e){e.description=_.findWhere(r.stateVariables.restriction_types,{id:e.restriction_type_id}).description}),u.restrictions=s.restrictions):u=_.extend(u,v()),u},h=function(e,t){return null!=e.single&&(r.stateVariables.selectedRoom=null==r.stateVariables.selectedRoom?"":r.stateVariables.selectedRoom,"undefined"==typeof _.findWhere(e.restrictions,{restriction_type_id:1})&&((!M()||e.room_type_id===r.stateVariables.selectedRoom||""==r.stateVariables.selectedRoom)&&(!(!L()&&e.restrictions.length>0)&&(!(w()&&$()&&e.availability<=0)&&(!(M()&&""===r.stateVariables.selectedRoom&&e.availability<=0)&&(t.date!==r.reservationData.arrivalDate||"undefined"==typeof _.findWhere(e.restrictions,{restriction_type_id:2})))))))},y=function(e,t){var r=o("date")(e,a.dateFormatForAPI);_.findWhere(s.results,{date:r})},g=function(e){var t=D(e),a=f(e),r={day:new tzIndependentDate(e.date).getDate().toString(),className:m(e),start:new tzIndependentDate(e.date),end:new tzIndependentDate(e.date),editable:!1,title:""==a||"undefined"==a?t.bestAvailableRate.toString():a,toolTipData:t,currencySymbol:t.rateCurrency,currentCalendar:""};return r},C=function(e){return(r.leftCalendarOptions.month+12)%12===new tzIndependentDate(e.date).getMonth()%12},A=function(e){return(r.rightCalendarOptions.month+12)%12===new tzIndependentDate(e.date).getMonth()%12},S=function(){var e={left:[],right:[]},t=null;_.each(s.results,function(a){t=g(a),C(a)?(t.currentCalendar="left",e.left.push(t)):A(a)&&(t.currentCalendar="right",e.right.push(t))}),r.eventSources.left.push(e.left),r.eventSources.right.push(e.right),b()},I=function(e){r.stateVariables.rooms=e.room_types,r.stateVariables.rates=e.rates,r.stateVariables.restriction_types=e.restriction_types,s=e,r.showCalender=!0,N(),S()},T=function(e,t){var a={from_date:e,to_date:t},o={params:a,successCallBack:I};r.callAPI(n.fetchCalendarData,o)},E=function(){r.eventSources.left.length=0,r.eventSources.right.length=0},R=function(){r.heading=o("translate")("CHANGE_STAY_DATES_TITLE"),r.setTitle(r.heading),r.setScroller("room-rates-calendar")},b=function(){i(function(){r.refreshScroller("room-rates-calendar")},100)},N=function(){var e,t=(e={height:450,editable:!0,droppable:!0,header:{left:"",center:"title",right:""},year:r.confirmedCheckinDate.getFullYear(),month:"undefined"==typeof r.leftCalendarOptions?r.confirmedCheckinDate.getMonth():r.leftCalendarOptions.month,day:r.confirmedCheckinDate.getDate()},_defineProperty(e,"editable",!0),_defineProperty(e,"disableResizing",!1),_defineProperty(e,"contentHeight",320),_defineProperty(e,"weekMode","fixed"),_defineProperty(e,"ignoreTimezone",!1),_defineProperty(e,"dayRender",y),e);r.leftCalendarOptions=_.extend({},t),r.rightCalendarOptions=_.extend({},t),r.rightCalendarOptions.month=r.leftCalendarOptions.month+1,r.disablePrevButton=r.isPrevButtonDisabled(),b()};r.$on("availableRateFiltersUpdated",function(e){E(),S()}),r.selectedBestAvailableRatesCalOption=function(){O(),E(),S()},r.selectedRoomTypesCalOption=function(){k(),E(),S()},r.filtersUpdated=function(){E(),S()},r.isPrevButtonDisabled=function(){var e=new Date(r.leftCalendarOptions.year,r.leftCalendarOptions.month),t=new tzIndependentDate(c(e)),n=new tzIndependentDate(l(e)),o=new tzIndependentDate(a.businessDate);return o<=n&&o>=t};var P=function(e){var t;"FORWARD"===e?(r.leftCalendarOptions.month=parseInt(r.leftCalendarOptions.month)+1,r.rightCalendarOptions.month=parseInt(r.rightCalendarOptions.month)+1):(r.leftCalendarOptions.month=parseInt(r.leftCalendarOptions.month)-1,r.rightCalendarOptions.month=parseInt(r.rightCalendarOptions.month)-1),r.disablePrevButton=r.isPrevButtonDisabled(),t=new Date(r.leftCalendarOptions.year,r.leftCalendarOptions.month),E(),T(c(t),l(t))};r.nextButtonClickHandler=function(){P("FORWARD")},r.prevButtonClickHandler=function(){P("BACKWARD")};var k=function(){r.stateCheck.calendarState.calendarType="ROOM_TYPE"},O=function(){r.stateCheck.calendarState.calendarType="BEST_AVAILABLE"},w=function(){return"BEST_AVAILABLE"===r.stateCheck.calendarState.calendarType},M=function(){return"ROOM_TYPE"===r.stateCheck.calendarState.calendarType},L=function(){return r.stateCheck.calendarState.searchWithRestrictions},$=function(){return r.stateCheck.calendarState.showOnlyAvailableRooms},x=function(){var e=r.reservationData;r.showCalender=!1,r.eventSources={left:[],right:[]},r.stateVariables={selectedRoom:parseInt(e.tabs[r.viewState.currentTab].roomTypeId,10)||"",selectedRate:parseInt(e.rooms[r.stateCheck.roomDetails.firstIndex].rateId,10)||"",rooms:[],rates:[]},r.checkinDateInCalender=r.confirmedCheckinDate=tzIndependentDate(e.arrivalDate),r.checkoutDateInCalender=r.confirmedCheckoutDate=tzIndependentDate(e.departureDate),r.finalRoomType=r.roomTypeForCalendar=e.rooms[0].roomTypeId},F=function(){r.stateVariables.selectedRoom?k():O(),r.$emit("roomTypesCalOptionSelected")},B=function(){var e=d(r.checkinDateInCalender),t=l(r.checkinDateInCalender);T(e,t)};(function(){x(),R(),F(),B()})()}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){sntRover.controller("RVShowRoomNotAvailableCtrl",["$rootScope","$scope","ngDialog","$state","$vault",function(e,t,a,r,n){BaseCtrl.call(this,t),t.okButtonClicked=function(){if(e.isHourlyRateOn){var n={},o=t.reservationData.rooms[0];n.fromDate=new tzIndependentDate(t.reservationData.arrivalDate).getTime(),n.toDate=new tzIndependentDate(t.reservationData.departureDate).getTime(),n.arrivalTime=t.reservationData.checkinTime,n.departureTime=t.reservationData.checkoutTime,n.adults=o.numAdults,n.children=o.numChildren,n.infants=o.numInfants,n.roomTypeID=o.roomTypeId,n.guestFirstName=t.reservationData.guest.firstName,n.guestLastName=t.reservationData.guest.lastName,n.companyID=t.reservationData.company.id,n.travelAgentID=t.reservationData.travelAgent.id,r.go("rover.diary",{isfromcreatereservation:!0}),a.close()}else a.close()}}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){sntRover.controller("RVStayDatesCalendarCtrl",["$state","$stateParams","$rootScope","$scope","RVStayDatesCalendarSrv","$filter","ngDialog",function(e,t,a,r,n,o,i){BaseCtrl.call(this,r);var s=this;r.heading=o("translate")("CHANGE_STAY_DATES_TITLE"),r.setTitle(r.heading),r.setScroller("stay-dates-calendar"),this.init=function(){r.eventSources=[],r.calendarType="ROOM_TYPE",""===r.reservationData.rooms[0].roomTypeId&&(r.calendarType="BEST_AVAILABLE"),r.checkinDateInCalender=r.confirmedCheckinDate=tzIndependentDate(r.reservationData.arrivalDate),r.checkoutDateInCalender=r.confirmedCheckoutDate=tzIndependentDate(r.reservationData.departureDate),r.finalRoomType=r.roomTypeForCalendar=r.reservationData.rooms[0].roomTypeId,r.nights=v(),s.renderFullCalendar(),c(),r.reservationData.searchPromoCode=""};var c=function(){var e,t,i=function(a){r.$emit("hideLoader"),r.availabilityDetails=a,r.fetchedStartDate=tzIndependentDate(e),r.fetchedEndDate=tzIndependentDate(t),r.refreshCalendarEvents()};e=r.checkinDateInCalender.clone(),e.setMonth(e.getMonth()-1),e.setDate(22),e<new Date(a.businessDate)&&(e=a.businessDate),t=r.checkinDateInCalender.clone(),t.setMonth(t.getMonth()+2),t.setDate(13);var s={};s.from_date=o("date")(e,a.dateFormatForAPI),s.per_page=81,s.to_date=o("date")(t,a.dateFormatForAPI),s.status="",""!==r.reservationData.travelAgent.id&&(s.travel_agent_id=r.reservationData.travelAgent.id),""!==r.reservationData.company.id&&(s.company_id=r.reservationData.company.id),""!==r.reservationData.searchPromoCode&&(s.promotion_code=r.reservationData.searchPromoCode),n.availabilityData={},r.invokeApi(n.fetchAvailability,s,i)},d=function(){for(var e=r.checkinDateInCalender,t=r.checkoutDateInCalender,n=new Array,i=e;i<=t;)n.push(o("date")(i,a.dateFormatForAPI)),i=i.addDays(1);return n};r.updateDataModel=function(){var e=dclone(r.availabilityDetails);r.reservationData.arrivalDate=o("date")(r.checkinDateInCalender,a.dateFormatForAPI),r.reservationData.departureDate=o("date")(r.checkoutDateInCalender,a.dateFormatForAPI),r.reservationData.numNights=r.dates.length-1,r.reservationData.rooms[0].roomTypeId=r.finalRoomType;var t="";for(var n in e.room_types)if(e.room_types[n].id===r.finalRoomType){t=e.room_types[n].name;break}r.reservationData.rooms[0].roomTypeName=t;var i,s={};for(var n in r.dates){i=r.dates[n],s[i]={},s[i].guests={},s[i].guests.adults=r.reservationData.rooms[0].numAdults,s[i].guests.children=r.reservationData.rooms[0].numChildren,s[i].guests.infants=r.reservationData.rooms[0].numInfants,s[i].rate={};var c=e.results[i][r.finalRoomType].rate_id;s[i].rate.id=c;var d="";for(var l in e.rates)if(e.rates[l].id===c){d=e.rates[l].name;break}s[i].rate.name=d}r.reservationData.rooms[0].stayDates=s,r.initRoomRates(!0)},r.setDatesClicked=function(){return r.houseNotAvailableForBooking=!1,r.roomTypeNotAvailableForBooking=!1,r.dates=d(),l()?(i.open({template:"/assets/partials/reservation/alerts/overBookingAlert.html",className:"ngdialog-theme-default",closeByDocument:!1,scope:r}),!1):void r.updateDataModel()};var l=function e(t){var a,n,o,e=!1;for(var i in r.dates){if(o=r.dates[i],a=r.availabilityDetails.results[o],houseAvailabilityForTheDay=a.house.availability,houseAvailabilityForTheDay<=0){r.houseNotAvailableForBooking=!0,e=!0;break}if(n=a[r.finalRoomType].room_type_availability.availability,n<=0){r.roomTypeNotAvailableForBooking=!0,e=!0;break}}return e};this.renderFullCalendar=function(){var e,t=(e={height:450,editable:!0,droppable:!0,header:{left:"",center:"title",right:""},year:r.confirmedCheckinDate.getFullYear(),month:r.confirmedCheckinDate.getMonth(),day:r.confirmedCheckinDate.getDate()},_defineProperty(e,"editable",!0),_defineProperty(e,"disableResizing",!1),_defineProperty(e,"contentHeight",320),_defineProperty(e,"weekMode","fixed"),_defineProperty(e,"ignoreTimezone",!1),e);r.leftCalendarOptions=dclone(t),r.leftCalendarOptions.eventDrop=p,r.leftCalendarOptions.drop=dateDroppedToExternalCalendar,r.rightCalendarOptions=dclone(t),r.rightCalendarOptions.eventDrop=p,r.rightCalendarOptions.drop=dateDroppedToExternalCalendar,r.rightCalendarOptions.month=r.leftCalendarOptions.month+1,r.disablePrevButton=r.isPrevButtonDisabled(),setTimeout(function(){r.refreshScroller("stay-dates-calendar")},1500)},dateDroppedToExternalCalendar=function(e,t,n){var o,i;if(e.getTime()<tzIndependentDate(a.businessDate).getTime())return!1;if($(n.target).attr("class").indexOf("check-in")>=0){if(e.getMonth===r.checkinDateInCalender.getMonth())return!1;if(e>r.checkoutDateInCalender)return!1;o=e,i=r.checkoutDateInCalender}else if($(n.target).attr("class").indexOf("check-out")>=0){if(e.getMonth===r.checkoutDateInCalender.getMonth())return!1;if(e<r.checkinDateInCalender)return!1;o=r.checkinDateInCalender,i=e}r.checkinDateInCalender=o,r.checkoutDateInCalender=i,r.nights=v(),r.refreshCalendarEvents()};var u=function(e){var t={};return t.name="",t.value="",""===r.roomTypeForCalendar&&"ROOM_TYPE"===r.calendarType?t:("undefined"!=typeof e.room_rates.single&&(t.value=a.currencySymbol+e.room_rates.single,angular.forEach(r.availabilityDetails.rates,function(a,r){if(a.id===e.rate_id)return t.name=a.name,!1})),t)},m=function(e){var t=e.room_rates.room_type_id,a="";return angular.forEach(r.availabilityDetails.room_types,function(e,r){if(e.id===t)return a=e.description,!1}),a},f=function(e,t){var a;a="BEST_AVAILABLE"===r.calendarType?"BAR":r.roomTypeForCalendar;var n,o=[],i={},s="";return angular.forEach(r.availabilityDetails.results,function(c,d){i={},n=tzIndependentDate(d),s=u(c[a]),i.title="undefined"==typeof s.value?"":s.value,i.rate="undefined"==typeof s.name?"":s.name,i.start=n,i.end=n,i.day=n.getDate().toString(),"BEST_AVAILABLE"===r.calendarType&&(i.roomType=m(c[a])),n.getDate()===e.getDate()&&n.getMonth()===e.getMonth()&&n.getYear()===e.getYear()?(i.id="check-in",i.className="check-in","CHECKEDIN"!==r.reservationData.status&&"CHECKING_OUT"!==r.reservationData.status&&(i.startEditable="true"),i.durationEditable="false",e.getDate()===t.getDate()&&e.getMonth()===t.getMonth()&&e.getYear()===t.getYear()&&(i.className="check-in split-view",o.push(i),i={},i.title=u(c[a]).value,i.start=n,i.end=n,i.day=n.getDate().toString(),i.id="check-out",i.className="check-out split-view",i.startEditable="true",i.durationEditable="false")):n.getTime()>e.getTime()&&n.getTime()<t.getTime()?(i.id="availability",i.className="mid-stay"):n.getDate()===t.getDate()&&n.getMonth()===t.getMonth()&&n.getYear()===t.getYear()?(i.id="check-out",i.className="check-out",i.startEditable="true",i.durationEditable="false"):"BEST_AVAILABLE"===r.calendarType&&c[a].room_type_availability.availability>0||"ROOM_TYPE"===r.calendarType&&""!==r.roomTypeForCalendar&&c[a].room_type_availability.availability>0?(i.className="type-available",i.durationEditable="false"):c.house.availability>0||(i.className="house-unavailable"),o.push(i)}),o};r.roomTypeForCalendarChanged=function(){r.finalRoomType=r.roomTypeForCalendar,r.resetCalendarDates(),r.refreshCalendarEvents()};var p=function(e,t,n,o,i,s,c,d){var l=e.start,u=tzIndependentDate(a.businessDate),m="",f="";if(l.getTime()<u.getTime())return i(),!1;if("check-in"===e.id){if(l>r.checkoutDateInCalender)return i(),!1;m=l,f=r.checkoutDateInCalender}else if("check-out"===e.id){if(l<r.checkinDateInCalender)return i(),!1;m=r.checkinDateInCalender,f=l}r.checkinDateInCalender=m,r.checkoutDateInCalender=f,r.nights=v(),r.refreshCalendarEvents()};r.refreshCalendarEvents=function(){r.eventSources.length=0,r.events=f(r.checkinDateInCalender,r.checkoutDateInCalender),r.eventSources.length=0,r.eventSources.push(r.events)};var v=function(){var e=r.checkoutDateInCalender.getTime()-r.checkinDateInCalender.getTime();return Math.ceil(e/864e5)};r.resetCalendarDates=function(){r.checkinDateInCalender=r.confirmedCheckinDate,r.checkoutDateInCalender=r.confirmedCheckoutDate},r.selectedBestAvailableRatesCalOption=function(){r.calendarType="BEST_AVAILABLE",r.resetCalendarDates(),r.refreshCalendarEvents()},r.selectedRoomTypesCalOption=function(){r.calendarType="ROOM_TYPE",r.resetCalendarDates(),r.refreshCalendarEvents()},r.isRoomTypeChangeAllowed=function(){var e=!0;return"CHECKEDIN"!==r.reservationData.status&&"CHECKING_OUT"!==r.reservationData.status||(e=!1),e},r.handleCancelAction=function(){"STAY_CARD"===t.fromState?e.go("rover.reservation.staycard.reservationcard.reservationdetails",{id:r.reservationData.reservationId,confirmationId:r.reservationData.confirmNum,isrefresh:!0}):e.go(t.fromState,{})},r.isPrevButtonDisabled=function(){var e=!1;return parseInt(tzIndependentDate(a.businessDate).getMonth())===parseInt(r.leftCalendarOptions.month)&&(e=!0),e};var _=function(e){"FORWARD"===e?(r.leftCalendarOptions.month=parseInt(r.leftCalendarOptions.month)+1,r.rightCalendarOptions.month=parseInt(r.rightCalendarOptions.month)+1):(r.leftCalendarOptions.month=parseInt(r.leftCalendarOptions.month)-1,r.rightCalendarOptions.month=parseInt(r.rightCalendarOptions.month)-1),r.disablePrevButton=r.isPrevButtonDisabled()};r.nextButtonClickHandler=function(){var e,t=r.fetchedStartDate.clone(),i=r.fetchedEndDate.clone(),s=function(t){r.$emit("hideLoader"),r.availabilityDetails=t,r.refreshCalendarEvents(),r.fetchedEndDate=e,_("FORWARD")};if(e=new Date(r.rightCalendarOptions.year,r.rightCalendarOptions.month),e.setMonth(e.getMonth()+2),e.setDate(13),t<=e&&e<=i)return _("FORWARD"),!1;var c={},d=i.setDate(i.getDate()+1);c.from_date=o("date")(d,a.dateFormatForAPI),c.per_page=44,c.to_date=o("date")(e,a.dateFormatForAPI),c.status="FETCH_ADDITIONAL",""!==r.reservationData.travelAgent.id&&(c.travel_agent_id=r.reservationData.travelAgent.id),""!==r.reservationData.company.id&&(c.company_id=r.reservationData.company.id),r.invokeApi(n.fetchAvailability,c,s)},r.prevButtonClickHandler=function(){var e,t=r.fetchedStartDate.clone(),i=r.fetchedEndDate.clone(),s=function(t){r.$emit("hideLoader"),r.availabilityDetails=t,r.refreshCalendarEvents(),r.fetchedStartDate=e,
_("BACKWARD")};if(e=new Date(r.leftCalendarOptions.year,r.leftCalendarOptions.month),e.setMonth(e.getMonth()-2),e.setDate(22),e<=tzIndependentDate(a.businessDate)&&(e=tzIndependentDate(a.businessDate)),t<=e&&e<=i)return _("BACKWARD"),!1;var c={};c.from_date=o("date")(e,a.dateFormatForAPI),c.per_page=37;var d=t.setDate(t.getDate()-1);c.to_date=o("date")(d,a.dateFormatForAPI),c.status="FETCH_ADDITIONAL",""!==r.reservationData.travelAgent.id&&(c.travel_agent_id=r.reservationData.travelAgent.id),""!==r.reservationData.company.id&&(c.company_id=r.reservationData.company.id),r.invokeApi(n.fetchAvailability,c,s)},this.init()}])},{}]},{},[1]);var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};!function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){angular.module("sntRover").controller("rvCardAllomentsContentCtrl",["$scope","rvUtilSrv",function(e,t){BaseCtrl.call(this,e),e.isEmpty=t.isEmpty,e.stringify=t.stringify,e.getClassAgainstHoldStatus=function(e){return"true"===e.is_take_from_inventory?"":"tentative"};var a=function(e){return"cancel"===e.hold_status.toLowerCase()};e.getGuestClassForArrival=function(e){var t=a(e)?"cancel":"check-in";return t},e.getClassAgainstPickedStatus=function(e){var t="";return e.total_picked_count>0&&(t="green"),a(e)&&(t+=" red"),t},e.getGuestClassForDeparture=function(e){var t=a(e)?"cancel":"check-out";return t},e.formatDateForUI=function(e){var t="undefined"==typeof e?"undefined":_typeof(e),a="";switch(t){case"string":a=$filter("date")(new tzIndependentDate(e),$rootScope.dateFormat);break;case"object":a=$filter("date")(e,$rootScope.dateFormat)}return a},e.$on("NG_REPEAT_COMPLETED_RENDERING",function(t){$timeout(function(){n()},300),e.$emit("hideLoader")});var r=function(){var t={tap:!0,preventDefault:!1,deceleration:1e-4,shrinkScrollbars:"clip"};e.setScroller("result_showing_area",t)},n=function(){e.refreshScroller("result_showing_area")};e.$on("GROUP_SEARCH_STARTED",function(){e.searchingAllotment=!0,n()}),e.$on("GROUP_SEARCH_END",function(){e.searchingAllotment=!1,n()}),e.$on("FETCH_ALLOTMENT_SEARCH_DATA",function(){i()});var o=function(t){e.searchingAllotment=!0,e.allotmentList=data.allotments},i=function(){var t=e.searchData.groupCard,a=e.reservationData;if(t.name||t.code){var r={name:t.name,code:t.code,from_date:a.arrivalDate,to_date:a.departureDate},n={params:r,successCallBack:o};e.callAPI(rvGroupSrv.searchGroupCard,n)}else e.searchingAllotments=!1,e.searchedAllotments=[]};(function(){e.allotmentList=[],e.totalResultCount=0,e.searchMode=!0,r()})()}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){angular.module("sntRover").controller("rvCardAllotmentsHeaderCtrl",["$scope",function(e){BaseCtrl.call(this,e);(function(){e.searchMode=!0})()}])},{}]},{},[1]);var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};!function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){angular.module("sntRover").controller("rvGuestCardNotesCtrl",["$scope","rvGuestCardNotesSrv","RVDashboardSrv","$timeout","$filter","$rootScope",function(e,t,a,r,n,o){BaseCtrl.call(this,e);var i=null,s=function(){var t=e.getScroller("guestcard_notes_scroller");r(function(){t.scrollTo(0,0,300)},0)},c=function(t){e.notes=t,e.refreshScroller("guestcard_notes_scroller")},d=function(){var a={guestID:i},r={params:a,successCallBack:c};e.callAPI(t.fetchNotesForGuest,r)},l=function(t,a){var r=a.index;e.notes.splice(r,1),e.refreshScroller("guestcard_notes_scroller"),e.guestCardData.contactInfo.notes_count=e.notes.length},u=function(t){e.errorMessage=t,d()};e.deleteGuestcardNote=function(a,r,n){a.stopPropagation(),e.cancelEditMode(),e.errorMessage="";var o={noteID:r,guestID:i},s={params:o,successCallBack:l,failureCallBack:u,successCallBackParameters:{index:n}};e.callAPI(t.deleteNoteFromGuestCard,s)};var m=function(t){var r=a.getUserDetails(),n={posted_user_first_name:r.first_name,posted_user_last_name:r.last_name,posted_user_image_url:r.user_image_url,text:e.noteText,time:t.time,date:t.date,id:t.id};e.notes.unshift(0),e.notes[0]=n,e.noteText="",e.refreshScroller("guestcard_notes_scroller"),s(),e.guestCardData.contactInfo.notes_count=e.notes.length};e.createGuestcardNote=function(){var a={guestID:i,text:e.noteText};e.errorMessage="";var r={params:a,successCallBack:m};e.callAPI(t.createNoteFromGuestCard,r)};var f=function(t){var a=_.findIndex(e.notes,{id:e.editingNote.id})+1;e.cancelEditMode(),d();var n=e.getScroller("guestcard_notes_scroller");r(function(){n.scrollToElement(".notes.wrapper li:nth-child("+a+")",300)},0)};e.updateActiveNote=function(){if(null===e.editingNote)return void(e.errorMessage=["Something went wrong, please switch tab and comeback"]);e.errorMessage="";var a={noteID:e.editingNote.id,guestID:i,text:e.noteText},r={params:a,successCallBack:f};e.callAPI(t.updateNoteFromGuestCard,r)},e.clickedOnNote=function(t){e.editingNote=t,e.noteText=t.text},e.cancelEditMode=function(){e.editingNote=null,e.noteText=""},e.formatDateForUI=function(e){var t="undefined"==typeof e?"undefined":_typeof(e),a="";switch(t){case"string":a=n("date")(new tzIndependentDate(e),o.dateFormat);break;case"object":a=n("date")(e,o.dateFormat)}return a};(function(){i=e.guestCardData.userId,e.editingNote=null,e.notes=[],e.noteText="",e.setScroller("guestcard_notes_scroller",{}),d()})()}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){angular.module("sntRover").controller("RVCompanyCardCtrl",["$scope","$rootScope","RVCompanyCardSrv","$timeout","ngDialog","$filter","$stateParams","rvPermissionSrv","rvFileCloudStorageSrv",function(e,t,a,r,n,o,i,s,c){e.searchMode=!0,e.account_type="COMPANY",e.currentSelectedTab="cc-contact-info",e.isGlobalToggleReadOnly=!s.getPermissionValue("GLOBAL_CARD_UPDATE"),e.companySearchIntiated=!1,e.companies=[];var d={},l=!1;e.arAccountDetails={},e.switchTabTo=function(t,a){t.stopPropagation(),t.stopImmediatePropagation();var r=!!e.contactInformation.account_details.accounts_receivable_number;"cc-contact-info"===e.currentSelectedTab&&"cc-contact-info"!==a&&(e.viewState.isAddNewCard?e.$broadcast("setCardContactErrorMessage",[o("translate")("COMPANY_SAVE_PROMPT")]):p()),"cc-contracts"===e.currentSelectedTab&&"cc-contracts"!==a?(e.$broadcast("contactTabActive"),e.$broadcast("saveContract")):"cc-ar-accounts"===e.currentSelectedTab&&"cc-ar-accounts"!==a&&e.$broadcast("saveArAccount"),"cc-ar-accounts"===a?e.$broadcast("arAccountTabActive"):"cc-contracts"===a?e.$broadcast("contractTabActive"):"cc-contact-info"===a?e.$broadcast("contactTabActive"):"cc-ar-transactions"===a&&r?(e.$broadcast("arTransactionTabActive"),e.isWithFilters=!1):"cc-notes"===a?e.$broadcast("fetchNotes"):"wallet"===a?e.$broadcast("wallet"):"statistics"===a&&e.$broadcast("LOAD_STATISTICS"),"cc-activity-log"===a&&e.$broadcast("activityLogTabActive"),"cc-ar-transactions"!==a||r?e.viewState.isAddNewCard||(e.currentSelectedTab=a):console.warn("Save AR Account and Navigate to AR Transactions")},e.$on("ARTransactionSearchFilter",function(t,a){e.isWithFilters=a}),e.shouldShowARMandatoryPopup=function(){var t=(!e.contactInformation.mandatoryFields.address_line1_mandatory.is_mandatory_on_ar_account_creation&&!e.contactInformation.mandatoryFields.address_line1_mandatory.is_mandatory||!isEmpty(e.contactInformation.address_details.street1))&&(!e.contactInformation.mandatoryFields.city_mandatory.is_mandatory_on_ar_account_creation&&!e.contactInformation.mandatoryFields.city_mandatory.is_mandatory||!isEmpty(e.contactInformation.address_details.city))&&(!e.contactInformation.mandatoryFields.postal_code_mandatory.is_mandatory_on_ar_account_creation&&!e.contactInformation.mandatoryFields.postal_code_mandatory.is_mandatory||!isEmpty(e.contactInformation.address_details.postal_code))&&(!e.contactInformation.mandatoryFields.country_mandatory.is_mandatory_on_ar_account_creation&&!e.contactInformation.mandatoryFields.country_mandatory.is_mandatory||""!==e.contactInformation.address_details.country_id&&null!==e.contactInformation.address_details.country_id)&&(!e.contactInformation.mandatoryFields.contact_phone_mandatory.is_mandatory_on_ar_account_creation&&!e.contactInformation.mandatoryFields.contact_phone_mandatory.is_mandatory||!isEmpty(e.contactInformation.address_details.phone))&&(!e.contactInformation.mandatoryFields.contact_email_address_mandatory.is_mandatory_on_ar_account_creation&&!e.contactInformation.mandatoryFields.contact_email_address_mandatory.is_mandatory||!isEmpty(e.contactInformation.address_details.email_address)&&isValidEmail(e.contactInformation.address_details.email_address))&&(!e.contactInformation.mandatoryFields.e_invoice_mandatory.is_mandatory_on_ar_account_creation&&!e.contactInformation.mandatoryFields.e_invoice_mandatory.is_mandatory||!isEmpty(e.contactInformation.e_invoice_address))&&(!e.contactInformation.mandatoryFields.organization_id_mandatory.is_mandatory_on_ar_account_creation&&!e.contactInformation.mandatoryFields.organization_id_mandatory.is_mandatory||!isEmpty(e.contactInformation.account_details.organization_id))&&(!e.contactInformation.mandatoryFields.tax_id_mandatory.is_mandatory_on_ar_account_creation&&!e.contactInformation.mandatoryFields.tax_id_mandatory.is_mandatory||!isEmpty(e.contactInformation.account_details.tax_number))&&(!e.contactInformation.mandatoryFields.regd_tax_office_mandatory.is_mandatory_on_ar_account_creation&&!e.contactInformation.mandatoryFields.regd_tax_office_mandatory.is_mandatory||!isEmpty(e.contactInformation.account_details.reg_tax_office))&&(!e.contactInformation.mandatoryFields.contact_name_mandatory.is_mandatory_on_ar_account_creation&&!e.contactInformation.mandatoryFields.contact_name_mandatory.is_mandatory||!isEmpty(e.contactInformation.primary_contact_details.contact_first_name)&&!isEmpty(e.contactInformation.primary_contact_details.contact_last_name))&&(!!e.arAccountDetails.is_auto_assign_ar_numbers||""!==e.arAccountDetails.ar_number&&null!==e.arAccountDetails.ar_number)&&(!e.contactInformation.mandatoryFields.payment_due_days_mandatory.is_mandatory_on_ar_account_creation&&!e.contactInformation.mandatoryFields.payment_due_days_mandatory.is_mandatory||""!==e.arAccountDetails.payment_due_days&&null!==e.arAccountDetails.payment_due_days);return t},e.$on("saveArAccountFromMandatoryPopup",function(t,a){e.arAccountDetails=a,e.isArTabAvailable=!0,e.shouldSaveArDataFromPopup=!0,e.contactInformation.account_details.accounts_receivable_number=a.ar_number}),e.openCompanyTravelAgentCardMandatoryFieldsPopup=function(){e.shouldSaveArDataFromPopup=!1,n.open({template:"/assets/partials/companyCard/rvCompanyTravelAgentCardMandatoryFieldsPopup.html",className:"ngdialog-theme-default1 calendar-single1",controller:"companyTravelAgentMandatoryFieldsController",closeByDocument:!1,scope:e})},e.clickedCreateArAccountButton=function(){e.shouldShowARMandatoryPopup()?(l=!0,e.showARTab()):(e.isMandatoryPopupOpen=!0,e.openCompanyTravelAgentCardMandatoryFieldsPopup())},e.$on("UPDATE_MANDATORY_POPUP_OPEN_FLAG",function(){e.isMandatoryPopupOpen=!1}),e.showARTab=function(t){p(e.contactInformation)},e.$on("ARNumberChanged",function(t,a){e.contactInformation.account_details.accounts_receivable_number=a.newArNumber}),e.deleteArAccount=function(){n.open({template:"/assets/partials/companyCard/rvCompanyCardDeleteARaccountPopup.html",className:"ngdialog-theme-default1 calendar-single1",closeByDocument:!1,scope:e})},e.deleteARAccountConfirmed=function(t){var r=function(t){e.$emit("hideLoader"),e.isArTabAvailable=!1,e.$broadcast("ArAccountDeleted"),e.contactInformation.account_details.accounts_receivable_number="",e.$broadcast("setgenerateNewAutoAr",!1),n.close()},o={id:e.reservationDetails.companyCard.id};e.invokeApi(a.deleteArAccount,o,r)},e.clikedDiscardDeleteAr=function(){n.close()};var u=function(){var t={id:e.reservationDetails.companyCard.id},r=function(t){e.$emit("hideLoader"),e.arAccountNotes=t,e.$broadcast("ARDetailsRecieved")},n=function(){e.invokeApi(a.fetchArAccountNotes,t,r)},o=function(t){e.$emit("hideLoader"),e.arAccountDetails=t,e.arAccountDetails.is_use_main_contact!==!1&&(e.arAccountDetails.is_use_main_contact=!0),e.arAccountDetails.is_use_main_address!==!1&&(e.arAccountDetails.is_use_main_address=!0),n()};e.invokeApi(a.fetchArAccountDetails,t,o)};e.$on("companyCardAvailable",function(t,a){e.searchMode=!1,e.contactInformation=e.companyContactInformation,e.currentSelectedTab="cc-contact-info",d=angular.copy(e.contactInformation),a===!0&&(e.contactInformation.account_details.account_name=e.searchData.companyCard.companyName,e.contactInformation.address_details.city=e.searchData.companyCard.companyCity,e.contactInformation.account_details.account_number=e.searchData.companyCard.companyCorpId),e.$broadcast("contactTabActive"),e.$broadcast("UPDATE_CONTACT_INFO"),r(function(){e.$emit("hideLoader")},1e3),a||u()}),e.$on("companyCardDetached",function(){e.searchMode=!0,e.isArTabAvailable=!1,e.$broadcast("setgenerateNewAutoAr",!1)}),e.$on("companySearchInitiated",function(){e.companySearchIntiated=!0,e.companies=e.searchedCompanies,e.$broadcast("refreshCompaniesScroll")}),e.$on("companySearchStopped",function(){e.companySearchIntiated=!1,e.companies=[],e.$broadcast("refreshCompaniesScroll")}),e.$on("newCardSelected",function(t,a){e.searchMode=!1,e.$emit("hideLoader")}),e.toggleGlobalButton=function(){s.getPermissionValue("GLOBAL_CARD_UPDATE")&&(e.contactInformation.is_global_enabled=!e.contactInformation.is_global_enabled)},e.isUpdateEnabled=function(){var t=!1;return e.contactInformation.is_global_enabled?s.getPermissionValue("GLOBAL_CARD_UPDATE")||(t=!0):s.getPermissionValue("EDIT_COMPANY_CARD")||(t=!0),t},e.companyCardClicked=function(a){a.stopPropagation(),null!==document.getElementById("cc-contact-info")&&getParentWithSelector(a,document.getElementById("cc-contact-info"))&&"cc-contact-info"===e.currentSelectedTab||null!==document.getElementById("cc-contracts")&&getParentWithSelector(a,document.getElementById("cc-contracts"))&&"cc-contracts"===e.currentSelectedTab||null!==document.getElementById("cc-ar-accounts")&&getParentWithSelector(a,document.getElementById("cc-ar-accounts"))&&"cc-ar-accounts"===e.currentSelectedTab||(!e.viewState.isAddNewCard&&null!==document.getElementById("company-card-header")&&getParentWithSelector(a,document.getElementById("company-card-header"))&&(e.$emit("saveContactInformation"),t.$broadcast("saveArAccount")),c.activeCardType="ACCOUNT_COMPANY")},e.$on("saveContactInformation",function(e){e.preventDefault(),e.stopPropagation(),p()}),e.$on("saveCompanyContactInformation",function(e){e.preventDefault(),p()}),e.$on("OUTSIDECLICKED",function(a,r){a.preventDefault(),p(),e.checkOutsideClick(r),t.$broadcast("saveArAccount"),t.$broadcast("saveContract")});var m=function(a){e.reservationDetails.companyCard.id=a.id,e.contactInformation.id=a.id,t.$broadcast("IDGENERATED",{id:a.id}),e.shouldSaveArDataFromPopup&&(e.shouldSaveArDataFromPopup=!1,e.$broadcast("UPDATE_AR_ACCOUNT_DETAILS",e.arAccountDetails),e.$broadcast("saveArAccount")),u(),e.viewState.isAddNewCard&&"undefined"!=typeof a.id&&(("STAY_CARD"===e.viewState.identifier||"CREATION"===e.viewState.identifier&&e.viewState.reservationStatus.confirm)&&(e.viewState.pendingRemoval.status=!1,e.viewState.pendingRemoval.cardType="",e.reservationDetails.companyCard.futureReservations<=0?e.replaceCardCaller("company",{id:a.id},!1):e.checkFuture("company",{id:a.id}),e.reservationDetails.companyCard.futureReservations=0),e.viewState.isAddNewCard=!1,e.closeGuestCard(),e.cardSaved(),e.reservationDetails.companyCard.id=a.id,e.reservationData&&e.reservationData.company&&(e.reservationData.company.id=a.id,e.reservationData.company.name=e.contactInformation.account_details.account_name))};e.clickedSaveCard=function(e){p()};var f=function(t){e.errorMessage=t,e.currentSelectedTab="cc-contact-info"},p=function(t){var r=!1;if(t=t||e.contactInformation,angular.equals(_.omit(t,["commission_details"]),_.omit(d,["commission_details"]))||(r=!0,d=angular.copy(e.contactInformation)),"undefined"!=typeof t&&(r||e.viewState.isAddNewCard)){var n=JSON.parse(JSON.stringify(t));"undefined"!=typeof n.countries&&delete n.countries,""===n.account_details.account_number&&(n.account_details.account_number=null),"undefined"==typeof n.primary_contact_details?(n.primary_contact_details={},n.primary_contact_details.contact_email=null):""===n.primary_contact_details.contact_email&&(n.primary_contact_details.contact_email=null),"undefined"==typeof n.address_details&&(n.address_details={}),n.account_type=e.account_type;var o={params:n,successCallBack:m,failureCallBack:f};e.callAPI(a.saveContactInformation,o)}else e.shouldSaveArDataFromPopup&&(e.shouldSaveArDataFromPopup=!1,e.$broadcast("UPDATE_AR_ACCOUNT_DETAILS",e.arAccountDetails),e.$broadcast("saveArAccount")),l&&(e.$broadcast("setgenerateNewAutoAr",!0),e.$broadcast("saveArAccount"),e.isArTabAvailable=!0),l=!1};e.hasPermissionToCreateArAccount=function(){return s.getPermissionValue("CREATE_AR_ACCOUNT")}}]),angular.module("sntRover").controller("companyResults",["$scope","$timeout",function(e,t){BaseCtrl.call(this,e);var a={scrollX:!0,click:!0,preventDefault:!1};e.setScroller("companyResultScroll",a),e.$on("refreshCompaniesScroll",function(){t(function(){e.refreshScroller("companyResultScroll")},500)})}])},{}]},{},[1]);var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};!function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){angular.module("sntRover").controller("RVGroupCardCtrl",["$scope","$rootScope","RVCompanyCardSrv","$timeout","ngDialog","$filter","$stateParams","rvGroupSrv","rvUtilSrv","$controller",function(e,t,a,r,n,o,i,s,c,d){e.searchMode=!0,e.$on("groupCardAvailable",function(t,a){e.searchMode=!1,r(function(){e.groupSummaryMemento=angular.copy(e.groupConfigData.summary),e.$emit("hideLoader")},500)}),e.$on("allotmentCardAvailable",function(t,a){e.searchMode=!1,r(function(){e.$emit("hideLoader")},500)}),e.isInAddMode=function(){return!1},e.getMoveDatesActions=function(){return{setToDefaultMode:function(){return!1}}},e.fetchGroupAllotmentCardId=function(t){var a="HEAD"===t?"header":"content";return e.reservationData.group.id?"group-card-"+a:e.reservationData.allotment.id?"allotment-card-"+a:"group-allotment-card-"+a},e.$on("groupCardDetached",function(){e.searchMode=!0}),e.$on("GROUP_SEARCH_ON",function(){e.searchingGroups=!0,e.$broadcast("refreshGroupsListScroller")}),e.$on("GROUP_SEARCH_OFF",function(){e.searchingGroups=!1,e.$broadcast("refreshGroupsListScroller")}),e.$on("newCardSelected",function(t,a){e.searchMode=!1,e.$emit("hideLoader")}),e.companyCardClicked=function(a){a.stopPropagation(),null!==document.getElementById("cc-contact-info")&&getParentWithSelector(a,document.getElementById("cc-contact-info"))&&"cc-contact-info"===e.currentSelectedTab||null!==document.getElementById("cc-contracts")&&getParentWithSelector(a,document.getElementById("cc-contracts"))&&"cc-contracts"===e.currentSelectedTab||null!==document.getElementById("cc-ar-accounts")&&getParentWithSelector(a,document.getElementById("cc-ar-accounts"))&&"cc-ar-accounts"===e.currentSelectedTab||!e.viewState.isAddNewCard&&null!==document.getElementById("company-card-header")&&getParentWithSelector(a,document.getElementById("company-card-header"))&&(e.$emit("saveContactInformation"),t.$broadcast("saveArAccount"))},e.$on("saveContactInformation",function(t){t.preventDefault(),t.stopPropagation(),m(e.contactInformation)}),e.$on("saveCompanyContactInformation",function(t){t.preventDefault(),m(e.contactInformation)}),e.$on("OUTSIDECLICKED",function(a,r){a.preventDefault(),e.checkOutsideClick(r),t.$broadcast("saveArAccount"),t.$broadcast("saveContract")});var l=function(a){e.$emit("hideLoader"),e.reservationDetails.companyCard.id=a.id,e.contactInformation.id=a.id,t.$broadcast("IDGENERATED",{id:a.id}),callCompanyCardServices(),e.viewState.isAddNewCard&&"undefined"!=typeof a.id&&(("STAY_CARD"===e.viewState.identifier||"CREATION"===e.viewState.identifier&&e.viewState.reservationStatus.confirm)&&(e.viewState.pendingRemoval.status=!1,e.viewState.pendingRemoval.cardType="",e.reservationDetails.companyCard.futureReservations<=0?e.replaceCardCaller("company",{id:a.id},!1):e.checkFuture("company",{id:a.id}),e.reservationDetails.companyCard.futureReservations=0),e.viewState.isAddNewCard=!1,e.closeGuestCard(),e.cardSaved(),e.reservationDetails.companyCard.id=a.id,e.reservationData&&e.reservationData.company&&(e.reservationData.company.id=a.id,e.reservationData.company.name=e.contactInformation.account_details.account_name)),presentContactInfo=angular.copy(e.contactInformation)};e.clickedSaveCard=function(t){m(e.contactInformation)};var u=function(t){e.$emit("hideLoader"),e.errorMessage=t,e.currentSelectedTab="cc-contact-info"};e.getClassAgainstPickedStatus=s.getClassAgainstPickedStatus,e.getGuestClassForArrival=s.getGuestClassForArrival,e.getGuestClassForDeparture=s.getGuestClassForDeparture,e.getClassAgainstHoldStatus=s.getClassAgainstHoldStatus,e.stringify=c.stringify,e.isEmpty=_.isEmpty,e.formatDateForUI=function(e){var a="undefined"==typeof e?"undefined":_typeof(e),r="";switch(a){case"string":r=o("date")(new tzIndependentDate(e),t.dateFormat);break;case"object":r=o("date")(e,t.dateFormat)}return r};var m=function(t){var r=!1;if(angular.equals(t,presentContactInfo)||(r=!0),"undefined"!=typeof t&&(r||e.viewState.isAddNewCard)){var n=JSON.parse(JSON.stringify(t));for(key in n)if("undefined"!=typeof n[key]&&null!==t[key]&&""!==t[key]){if("{}"!==JSON.stringify(presentContactInfo))for(subDictKey in n[key])"undefined"!=typeof n[key][subDictKey]&&n[key][subDictKey]!==presentContactInfo[key][subDictKey]||delete n[key][subDictKey]}else delete n[key];"undefined"!=typeof n.countries&&delete n.countries,""===n.account_details.account_number&&(n.account_details.account_number=null),n.account_type=e.account_type,e.invokeApi(a.saveContactInformation,n,l,u)}}}]),angular.module("sntRover").controller("groupResults",["$scope","$timeout",function(e,t){BaseCtrl.call(this,e);var a={scrollX:!0,click:!0,preventDefault:!1};e.setScroller("groupResultsScroll",a),e.$on("refreshGroupsListScroller",function(){t(function(){e.refreshScroller("groupResultsScroll")},500)})}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){angular.module("sntRover").controller("RVGuestCardCtrl",["$scope","RVCompanyCardSrv","$timeout","RVContactInfoSrv","RVSearchSrv","rvPermissionSrv","$rootScope",function(e,t,a,r,n,o,i){GuestCardBaseCtrl.call(this,e,n,r,o,i),e.searchMode=!0,e.guestCardData.selectedLoyaltyLevel="",e.loyaltyTabEnabled=!1,e.reservationDetails.guestCard.id&&(e.searchMode=!1),e.$on("guestSearchInitiated",function(){e.guestSearchIntiated=!0,e.guests=e.searchedGuests,e.$broadcast("refreshGuestScroll")}),e.$on("guestSearchStopped",function(){e.guestSearchIntiated=!1,e.guests=[],e.$broadcast("refreshGuestScroll")}),e.$on("guestCardDetached",function(){e.searchMode=!0}),e.$on("guestCardAvailable",function(){e.searchMode=!1,a(function(){e.$emit("hideLoader")},1e3)}),e.$on("detect-hlps-ffp-active-status",function(t,a){a.userMemberships.use_hlp||a.userMemberships.use_ffp?e.loyaltyTabEnabled=!0:e.loyaltyTabEnabled=!1}),e.$on("loyaltyLevelAvailable",function(t,a){e.guestCardData.selectedLoyaltyLevel=a}),e.loyaltiesStatus={ffp:!1,hlps:!1},e.$setLoyaltyStatus=function(t,a){e.loyaltiesStatus[a]=t.active,e.loyaltiesStatus.ffp||e.loyaltiesStatus.hlps?e.loyaltyTabEnabled=!0:e.loyaltyTabEnabled=!1,e.loyaltiesStatus.hlps?e.guestCardData.loyaltyInGuestCardEnabled=!0:e.guestCardData.loyaltyInGuestCardEnabled=!1},e.fetchLoyaltyStatus=function(){var a=function(t){e.$setLoyaltyStatus(t,"hlps"),e.$emit("hideLoader")},r=function(t){e.$setLoyaltyStatus(t,"ffp"),e.$emit("hideLoader")};e.invokeApi(t.fetchHotelLoyaltiesHlps,{},a),e.invokeApi(t.fetchHotelLoyaltiesFfp,{},r)};var s=e.$on("UPDATE_GUEST_CARD_ACTIONS_BUTTON_STATUS",function(t,a){e.manageCardState.isOpen=a.status});e.$on("$destroy",s)}]),angular.module("sntRover").controller("guestResults",["$scope","$timeout",function(e,t){BaseCtrl.call(this,e);var a={scrollX:!0,click:!0,preventDefault:!1};e.setScroller("guestResultScroll",a),e.$on("refreshGuestScroll",function(){t(function(){e.refreshScroller("guestResultScroll")},500)})}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){sntRover.controller("RVAddNewFreaquentLoyaltyContrller",["$scope","$rootScope","RVGuestCardLoyaltySrv","ngDialog",function(e,t,a,r){BaseCtrl.call(this,e),e.userMembershipTypes=e.loyaltyData.freaquentLoyaltyData,e.userMembershipNumber="",e.userMembershipType="",e.userMembershipClass="FFP",e.save=function(){var r=function(a){e.newLoyalty.id=a.id,e.$emit("hideLoader"),e.cancel(),t.$broadcast("loyaltyProgramAdded",e.newLoyalty,"fromGuestCard")},n=function(t){e.$emit("hideLoader"),e.errorMessage=t},o={};o.membership_card_number=e.userMembershipNumber,o.membership_class=e.userMembershipClass,o.membership_type=e.userMembershipType,o.membership_level="",e.newLoyalty=o;var i=e.reservationData&&e.reservationData.reservationId?e.reservationData.reservationId:"",s={user_id:e.$parent.guestCardData.userId,guest_id:e.$parent.guestCardData.guestId,user_membership:o,reservation_id:i},c={params:s,successCallBack:r,failureCallBack:n};e.callAPI(a.createLoyalties,c)},e.cancel=function(){e.closeDialog()}}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){sntRover.controller("RVAddNewHotelLoyaltyController",["$scope","$rootScope","RVGuestCardLoyaltySrv","ngDialog",function(e,t,a,r){BaseCtrl.call(this,e),e.userMembershipTypes=e.loyaltyData.hotelLoyaltyData,e.userMembershipNumber="",e.userMembershipType="",e.userMembershipClass="HLP",e.userMembershipLevels=[],e.userMembershipLevel="",e.isLevelsAvailable=!1,e.memberShipTypeChanged=function(){angular.forEach(e.userMembershipTypes,function(t,a){e.userMembershipType===t.hl_value&&(e.userMembershipLevels=t.levels,e.userMembershipLevels.length>0?e.isLevelsAvailable=!0:e.isLevelsAvailable=!1)})},e.save=function(){var r=function(a){e.newLoyalty.id=a.id,e.$emit("hideLoader"),e.cancel(),t.$broadcast("loyaltyProgramAdded",e.newLoyalty),e.$emit("REFRESH_CONTACT_INFO",{guestId:e.$parent.guestCardData.guestId})},n=function(t){e.$emit("hideLoader"),e.errorMessage=t},o={};o.membership_card_number=e.userMembershipNumber,o.membership_class=e.userMembershipClass,o.membership_type=e.userMembershipType,o.membership_level=e.userMembershipLevel,e.newLoyalty=o;var i=e.reservationData&&e.reservationData.reservationId?e.reservationData.reservationId:"",s={user_id:e.$parent.guestCardData.userId,guest_id:e.$parent.guestCardData.guestId,user_membership:o,reservation_id:i},c={params:s,successCallBack:r,failureCallBack:n};e.callAPI(a.createLoyalties,c)},e.cancel=function(){e.closeDialog()}}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){sntRover.controller("rvDeleteLoyaltyModalController",["$scope","$rootScope","$filter","RVGuestCardLoyaltySrv","ngDialog",function(e,t,a,r,n){BaseCtrl.call(this,e),e.closeDialog=function(){n.close()},e.dimissLoaderAndDialog=function(){e.$emit("hideLoader"),e.closeDialog()},e.deleteLoyalty=function(){var a=function(){e.loyaltyProgramDeleted(e.loaytyID,e.loyaltyIndexToDelete,e.loyaltyProgramToDelete),t.$broadcast("loyaltyProgramDeleted",e.loaytyID,e.loyaltyIndexToDelete,e.loyaltyProgramToDelete),e.$emit("REFRESH_CONTACT_INFO",{guestId:e.$parent.guestCardData.userId}),e.dimissLoaderAndDialog()},n=function(t){e.dimissLoaderAndDialog(),e.$emit("loyaltyDeletionError",t)};e.invokeApi(r.deleteLoyalty,e.loaytyID,a,n)},e.validate=function(){}}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",
d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){angular.module("sntRover").controller("stayCardMainCtrl",["$rootScope","$scope","RVCompanyCardSrv","$stateParams","RVReservationCardSrv","RVGuestCardSrv","RVGuestCardsSrv","ngDialog","$state","RVReservationSummarySrv","$timeout","dateFilter","RVContactInfoSrv","$q","RVReservationStateService","RVReservationDataService","rvGroupConfigurationSrv","rvAllotmentConfigurationSrv","RVReservationPackageSrv",function(e,t,a,r,n,o,i,s,c,d,l,u,m,f,p,v,D,h,y){function g(e){var a,r;t.idTypeList=e.id_type_list,t.otherData.isGuestPrimaryEmailChecked=!!(e.email&&e.email.length>0),e.stayCount||(e.stayCount=t.guestCardData&&t.guestCardData.contactInfo&&t.guestCardData.contactInfo.stayCount),a={contactInfo:e,countries:t.countries,userId:t.reservationDetails.guestCard.id||t.reservationData.guest.id,avatar:t.guestCardData.cardHeaderImage,guestId:t.reservationDetails.guestCard.id||t.reservationData.guest.id,vip:e.vip},t.guestCardData.contactInfo=a.contactInfo,null!==t.guestCardData.contactInfo.birthday&&(t.guestCardData.contactInfo.birthday=moment(t.guestCardData.contactInfo.birthday).format("YYYY-MM-DD")),null!==t.guestCardData.contactInfo.id_issue_date&&(t.guestCardData.contactInfo.id_issue_date=moment(t.guestCardData.contactInfo.id_issue_date).format("YYYY-MM-DD")),null!==t.guestCardData.contactInfo.entry_date&&(t.guestCardData.contactInfo.entry_date=moment(t.guestCardData.contactInfo.entry_date).format("YYYY-MM-DD")),null!==t.guestCardData.contactInfo.id_expiration_date&&(t.guestCardData.contactInfo.id_expiration_date=moment(t.guestCardData.contactInfo.id_expiration_date).format("YYYY-MM-DD")),t.guestCardData.contactInfo.avatar=a.avatar,t.guestCardData.contactInfo.vip=a.vip,t.countriesList=t.countries,t.guestCardData.userId=a.userId,t.guestCardData.guestId=a.guestId,t.guestCardData.contactInfo.genderTypeList=e.gender_list,r={user_id:a.userId,guest_id:null},t.searchData.guestCard.guestFirstName="",t.searchData.guestCard.guestLastName="",t.searchData.guestCard.guestCity="",t.searchData.guestCard.guestLoyaltyNumber="",t.searchData.guestCard.email="",t.guestCardData.contactInfo.user_id=a.userId,t.reservationData.guest.email=e.email,t.showGuestPaymentList(r),m.completeContactInfoClone=JSON.parse(JSON.stringify(t.guestCardData.contactInfo)),t.$broadcast("guestSearchStopped"),t.$broadcast("guestCardAvailable"),t.$broadcast("resetGuestTab"),t.$emit("hideLoader")}BaseCtrl.call(this,t),t.addNewCards=!0;var C=this;void 0!==t.guestCardData.cardHeaderImage&&""!==t.guestCardData.cardHeaderImage||(t.guestCardData.cardHeaderImage="/ui/pms-ui/images/avatar-trans.png"),t.pendingRemoval={status:!1,cardType:""},t.$on("parentShowError",function(e,a){t.errorMessage=a});var A="rover.reservation.staycard.mainCard.room-rates",S="rover.reservation.staycard.reservationcard.reservationdetails";t.setHeadingTitle=function(e){t.heading=e,t.setTitle(e)},t.cardSaved=function(){t.viewState.isAddNewCard=!1};var I=function(e){t.countries=e};t.invokeApi(a.fetchCountryList,{},I),t.initGuestCard=function(a){if(a||(a={id:""}),a.id||t.reservationDetails.guestCard.id||t.reservationData.guest.id){var n={id:a.id||t.reservationDetails.guestCard.id||t.reservationData.guest.id};t.guestCardData.userId=n.id,t.guestCardData.guestId=n.id,angular.merge(t.guestCardData.contactInfo,_defineProperty({first_name:t.reservationData.guest.firstName,last_name:t.reservationData.guest.lastName,phone:t.reservationData.guest.phone,mobile:t.reservationData.guest.mobile,vip:t.reservationData.guest.is_vip,email:t.reservationData.guest.email,avatar:t.reservationData.guest.image,address:t.reservationData.guest.address,notes_count:t.reservationData.guest.notes_count,user_id:n.id,nationality_id:t.guestCardData.nationality_id},"address",{country_id:void 0!==t.guestCardData.contactInfo.address?t.guestCardData.contactInfo.address.country_id:""})),l(function(){t.$broadcast("loyaltyLevelAvailable",t.reservationData.guest.membership_type)},1e3),i.setGuest(n.id),t.$broadcast("guestCardAvailable"),("EDIT_HOURLY"===r.mode||e.isHourlyRateOn&&"rover.reservation.staycard.reservationcard.reservationdetails"!==c.current.name)&&t.callAPI(i.fetchGuestDetailsInformation,{successCallBack:function(e){g(e)},failureCallBack:function(e){t.errorMessage=e,t.$emit("hideLoader")},params:n.id})}},t.$on("UPDATE_GUEST_CARD_DETAILS",function(e,t){g(t)});var T=function(e){_.extend(t.groupConfigData,{activeTab:"SUMMARY",summary:e.groupSummary,selectAddons:!1,addons:{},selectedAddons:[]})},E=function(e){_.extend(t.allotmentConfigData,{activeTab:"SUMMARY",summary:e.allotmentSummary,selectAddons:!1,addons:{},selectedAddons:[]})},R=function(e){_.extend(t.allotmentConfigData,{holdStatusList:e.data.hold_status})},b=function(e){_.extend(t.groupConfigData,{holdStatusList:e.data.hold_status})},N=function(e){t.$broadcast("groupCardAvailable"),t.$broadcast("groupSummaryDataChanged",t.groupConfigData),t.$emit("hideLoader")},P=function(e){t.$broadcast("allotmentCardAvailable"),t.$broadcast("allotmentSummaryDataChanged",t.allotmentConfigData),t.$emit("hideLoader")},k=function(e){t.errorMessage=e,t.$emit("hideLoader")},O=function(e){t.invokeApi(y.getReservationPackages,t.reservationData.reservationId,function(a){t.$emit("hideLoader");var n=t.reservationData.rooms[0];n.addons=[],angular.forEach(a.existing_packages,function(e){n.addons.push({quantity:e.addon_count,id:e.id,price:parseFloat(e.amount),amountType:e.amount_type,postType:e.post_type,title:e.name,totalAmount:e.addon_count*parseFloat(e.amount),is_inclusive:e.is_inclusive,taxes:e.taxes,is_rate_addon:e.is_rate_addon,allow_rate_exclusion:e.allow_rate_exclusion,excluded_rate_ids:e.excluded_rate_ids})}),e?t.navigateToRoomAndRates(e):t.reservationData.keepExistingRate?c.go("rover.reservation.staycard.reservationcard.reservationdetails",{id:"undefined"==typeof r.id?t.reservationData.reservationId:r.id,confirmationId:r.confirmationId}):t.navigateToRoomAndRates(e)})};t.initGroupCard=function(e){var a=[];if(t.$emit("showLoader"),t.groupConfigData={activeScreen:"STAY_CARD"},e){var r={groupId:e};a.push(D.getGroupSummary(r).then(T));var n={is_group:!0};a.push(D.getHoldStatusList(n).then(b)),f.all(a).then(N,k)}},t.initAllotmentCard=function(e){var a=[];t.$emit("showLoader"),t.allotmentConfigData={activeScreen:"STAY_CARD"},a.push(h.getAllotmentSummary({allotmentId:e}).then(E)),a.push(D.getHoldStatusList({is_allotment:!0}).then(R)),f.all(a).then(P,k)},t.initCompanyCard=function(){var e=function(e){t.$emit("hideLoader"),e.id=t.reservationDetails.companyCard.id,t.companyContactInformation=e,t.$broadcast("companyCardAvailable")};if(""!==t.reservationDetails.companyCard.id&&null!==t.reservationDetails.companyCard.id){var r={id:t.reservationDetails.companyCard.id};t.invokeApi(a.fetchContactInformationAndMandatoryFields,r,e)}},t.initTravelAgentCard=function(){var e=function(e){t.$emit("hideLoader"),e.id=t.reservationDetails.travelAgent.id,t.travelAgentInformation=e,t.$broadcast("travelAgentFetchComplete")};if(""!==t.reservationDetails.travelAgent.id&&null!==t.reservationDetails.travelAgent.id){var r={id:t.reservationDetails.travelAgent.id};t.invokeApi(a.fetchContactInformationAndMandatoryFields,r,e)}},t.$on("cardIdsFetched",function(a,r){t.viewState.pendingRemoval.status=!1,t.viewState.pendingRemoval.cardType="";var n=0;r.guest||(t.$broadcast("guestCardDetached"),t.initGuestCard(),n+=300),!r.group&&e.isStandAlone&&(l(function(){t.$broadcast("groupCardDetached"),t.initGroupCard(t.reservationDetails.group.id)},n),n+=300),!r.allotment&&e.isStandAlone&&(l(function(){t.$broadcast("groupCardDetached"),t.initAllotmentCard(t.reservationDetails.allotment.id)},n),n+=300),r.company||(l(function(){t.$broadcast("companyCardDetached"),t.initCompanyCard()},n),n+=300),r.agent||l(function(){t.$broadcast("travelAgentDetached"),t.initTravelAgentCard()},n);var o=t.reservationListData.future_reservation_counts;t.reservationDetails.guestCard.futureReservations=null===o.guest?0:o.guest,t.reservationDetails.companyCard.futureReservations=null===o.company?0:o.company,t.reservationDetails.travelAgent.futureReservations=null===o.travel_agent?0:o.travel_agent}),t.navigateToRoomAndRates=function(e){var a,r=t.reservationData,n=e&&e.disableBackToStaycard,o=e&&e.isGroupDetachmentRequested;c.go(A,(a={from_date:r.arrivalDate,to_date:r.departureDate,fromState:function(){return"rover.reservation.staycard.reservationcard.reservationdetails"===c.current.name?"STAY_CARD":c.current.name}(),company_id:r.company.id,allotment_id:r.allotment.id,travel_agent_id:r.travelAgent.id,group_id:r.group&&r.group.id},_defineProperty(a,"allotment_id",r.allotment&&r.allotment.id),_defineProperty(a,"disable_back_staycard",n),_defineProperty(a,"view","ROOM_RATE"),_defineProperty(a,"room_type_id",t.$parent.reservationData.tabs[t.viewState.currentTab].roomTypeId),_defineProperty(a,"adults",t.$parent.reservationData.tabs[t.viewState.currentTab].numAdults),_defineProperty(a,"children",t.$parent.reservationData.tabs[t.viewState.currentTab].numChildren),_defineProperty(a,"isGroupDetachmentRequested",o),a))},t.reloadTheStaycard=function(e){e?c.reload(c.current.name):c.go("rover.reservation.staycard.reservationcard.reservationdetails",{id:"undefined"==typeof r.id?t.reservationData.reservationId:r.id,confirmationId:r.confirmationId||t.reservationData.confirmNum,isrefresh:!1})},t.isInStayCardScreen=function(){return"STAY_CARD"===t.viewState.identifier},function(){var e=null,r=function(a){t.$emit("hideLoader"),t.cardRemoved(e),t.$broadcast("CARD_REMOVED",e),a.contracted_rate_was_present&&"guest"!==e?O({disableBackToStaycard:!0}):C.reloadStaycard()},n=function(e){if(t.$emit("hideLoader"),e.hasOwnProperty("httpStatus"))if(470===e.httpStatus){var a={errorMessages:e.errorMessage};s.open({template:"/assets/partials/cards/popups/detachCardsAPIErrorPopup.html",className:"ngdialog-theme-default stay-card-alerts",scope:t,closeByDocument:!1,closeByEscape:!1,data:JSON.stringify(a)})}else t.errorMessage=e},o=function(e){},i=function(e,t,i){var s=[];_.each(e.reservationIds,function(e){var r={reservation:e,cardType:t,cardId:i};s.push(a.removeCard(r).then(o))}),f.all(s).then(r,n)},c=function(e,o){var i={reservation:t.reservationData.reservationId,cardType:e,cardId:o};t.invokeApi(a.removeCard,i,r,n)};t.removeCard=function(a,r){var r=r||null,n=_.filter(t.reservationDetails,function(e){return!!e.id}).length;if(e=a,n>1&&""!==a){var o=t.reservationData,d=o&&o.reservationIds&&o.reservationIds.length>1;d?(t.$emit("showLoader"),i(o,a,r)):c(a,r)}else(t.viewState.pendingRemoval.status||r)&&(t.viewState.pendingRemoval.status=!1,t.viewState.pendingRemoval.cardType="",t.viewState.lastCardSlot={cardType:a,cardId:r},l(function(){s.open({template:"/assets/partials/cards/alerts/cardRemoval.html",className:"ngdialog-theme-default stay-card-alerts",scope:t,closeByDocument:!1,closeByEscape:!1})},300))}}(),t.noRoutingToReservation=function(){s.close(),C.useCardRate?t.navigateToRoomAndRates():C.reloadStaycard()},t.applyRoutingToReservation=function(){var e=function(e){t.$emit("hideLoader"),s.close(),C.useCardRate?t.navigateToRoomAndRates():C.reloadStaycard(),t.$broadcast("paymentTypeUpdated")},a=function(e){t.errorMessage=e,t.$emit("hideLoader")},r={};r.account_id="TRAVEL_AGENT"===t.contractRoutingType?t.reservationData.travelAgent.id:t.reservationData.company.id,r.reservation_ids=[],r.reservation_ids.push(t.reservationData.reservationId),t.invokeApi(d.applyDefaultRoutingToReservation,r,e,a)},t.okClickedForConflictingRoutes=function(){s.close(),C.useCardRate?t.navigateToRoomAndRates():C.reloadStaycard()},this.showConfirmRoutingPopup=function(e,a){s.open({template:"/assets/partials/reservation/alerts/rvBillingInfoConfirmPopup.html",className:"ngdialog-theme-default",scope:t})},this.showConflictingRoutingPopup=function(e,a){s.open({template:"/assets/partials/reservation/alerts/rvBillingInfoConflictingPopup.html",className:"ngdialog-theme-default",scope:t})},this.attachCompanyTACardRoutings=function(e,a){if(t.reservationData.group.id)return!1;var r=function(a){return t.$emit("hideLoader"),t.routingInfo=a,a.has_conflicting_routes?(t.conflict_cards=[],"travel_agent"===e&&a.travel_agent.routings_count>0&&t.conflict_cards.push(t.reservationData.travelAgent.name),"company"===e&&a.company.routings_count>0&&t.conflict_cards.push(t.reservationData.company.name),C.showConflictingRoutingPopup(),!1):"travel_agent"===e&&a.travel_agent.routings_count>0?(t.contractRoutingType="TRAVEL_AGENT",C.showConfirmRoutingPopup(t.contractRoutingType,t.reservationData.travelAgent.id),!1):"company"===e&&a.company.routings_count>0?(t.contractRoutingType="COMPANY",C.showConfirmRoutingPopup(t.contractRoutingType,t.reservationData.company.id),!1):("company"===e&&0===a.company.routings_count||"travel_agent"===e&&0===a.travel_agent.routings_count||!a.has_conflicting_routes)&&C.useCardRate?(t.navigateToRoomAndRates(),!1):void C.reloadStaycard()},n={};n.reservation_id=t.reservationData.reservationId,"travel_agent"===e?n.travel_agent_id=t.reservationDetails.travelAgent.id:"company"===e&&(n.company_id=t.reservationDetails.companyCard.id),t.invokeApi(d.fetchDefaultRoutingInfo,n,r)},t.newCardData={},t.replaceCard=function(e,r,n,o){C.useCardRate=o,"company"===e?(t.reservationData.company.id=r.id,t.reservationData.company.name=r.account_name):"travel_agent"===e&&(t.reservationData.travelAgent.id=r.id,t.reservationData.travelAgent.name=r.account_name);var i=function(a){t.cardRemoved(e),t.cardReplaced(e,r),t.viewState.lastCardSlot&&t.viewState.lastCardSlot.cardType&&e!==t.viewState.lastCardSlot.cardType&&t.removeCard(t.viewState.lastCardSlot.cardType,t.viewState.lastCardSlot.cardId,!0),"travel_agent"===e&&t.$broadcast("travelagentcardreplaced",a.data),"company"===e&&t.$broadcast("COMPANY_ADDED"),t.viewState.lastCardSlot="",t.$emit("hideLoader"),t.newCardData=r,C.attachCompanyTACardRoutings(e,r),s.close(),c.current.name===S&&("company"===e?t.$broadcast("UPDATE_COMPANY_NAME_IN_STAYCARD",{name:r.account_name}):"travel_agent"===e&&t.$broadcast("UPDATE_TA_NAME_IN_STAYCARD",{name:r.account_name}))},d=function(a){t.cardRemoved(),480===a.httpStatus?(t.cardReplaced(e,r),t.viewState.lastCardSlot&&t.viewState.lastCardSlot.cardType&&(t.removeCard(t.viewState.lastCardSlot),t.viewState.lastCardSlot=""),t.newCardData=r,C.attachCompanyTACardRoutings(e,r),p.setReservationFlag("RATE_CHANGE_FAILED",!0),s.close()):t.$broadcast("SHOWERRORMESSAGE",a),t.$emit("hideLoader")},l=function(){};if(n&&t.reservationData&&t.reservationData.reservationIds&&t.reservationData.reservationIds.length>1){var u=[];t.$emit("showLoader"),_.each(t.reservationData.reservationIds,function(t){u.push(a.replaceCard({reservation:t,cardType:e,id:r.id,future:"undefined"!=typeof n&&n,useCardRate:o}).then(l))}),f.all(u).then(i,d)}else t.invokeApi(a.replaceCard,{reservation:t.reservationData.reservationId,cardType:e,id:r.id,future:"undefined"!=typeof n&&n,useCardRate:o},i,d)},this.reloadStaycard=function(){t.newCardData.hasOwnProperty("isMultipleContracts")&&1==t.newCardData.isMultipleContracts&&c.current.name!==A&&!t.reservationData.group.id?O():"STAY_CARD"!==t.viewState.identifier||"undefined"==typeof r.confirmationId||t.viewState.lastCardSlot||(p.getReservationFlag("RATE_CHANGE_FAILED")?(p.setReservationFlag("RATE_CHANGE_FAILED",!1),s.open({template:"/assets/partials/cards/alerts/contractedRateChangeFailure.html",scope:t,closeByDocument:!1,closeByEscape:!1})):c.go("rover.reservation.staycard.reservationcard.reservationdetails",{id:"undefined"==typeof r.id?t.reservationData.reservationId:r.id,confirmationId:r.confirmationId}))},t.cardRemoved=function(e){if(t.viewState.pendingRemoval.status=!1,t.viewState.pendingRemoval.cardType="","guest"===e){t.reservationDetails.guestCard.id="",t.reservationDetails.guestCard.futureReservations=0;var a={contactInfo:{},countries:t.countries,userId:"",avatar:"",guestId:"",vip:""};t.guestCardData.contactInfo=a.contactInfo,t.guestCardData.contactInfo.avatar=a.avatar,t.guestCardData.contactInfo.vip=a.vip,t.countriesList=a.countries,t.guestCardData.userId=a.userId,t.guestCardData.guestId=a.guestId,t.guestCardData.contactInfo.birthday=null}"company"===e?(t.reservationData.company.id="",t.reservationDetails.companyCard.id="",t.reservationDetails.companyCard.futureReservations=0):"travel_agent"===e&&(t.reservationData.travelAgent.id="",t.reservationDetails.travelAgent.id="",t.reservationDetails.travelAgent.futureReservations=0,t.$broadcast("travelagentcardremoved"))},t.cardReplaced=function(e,a){"company"===e?(t.reservationDetails.companyCard.id=a.id,t.reservationData.company.id=a.id,t.initCompanyCard(),t.searchData.companyCard.companyName="",t.searchData.companyCard.companyCity="",t.searchData.companyCard.companyCorpId="",t.showContractedRates({companyCard:a.id,travelAgent:t.reservationDetails.travelAgent.id}),t.$broadcast("companySearchStopped")):"travel_agent"===e?(t.reservationDetails.travelAgent.id=a.id,t.reservationData.travelAgent.id=a.id,t.initTravelAgentCard(),t.searchData.travelAgentCard.travelAgentName="",t.searchData.travelAgentCard.travelAgentCity="",t.searchData.travelAgentCard.travelAgentIATA="",t.showContractedRates({companyCard:t.reservationData.company.id,travelAgent:a.id}),t.$broadcast("travelAgentSearchStopped")):"guest"===e&&(t.reservationDetails.guestCard.id=a.id,t.searchData.guestCard.guestFirstName="",t.searchData.guestCard.guestLastName="",t.searchData.guestCard.guestCity="",t.searchData.guestCard.guestLoyaltyNumber="",t.searchData.guestCard.email="",t.initGuestCard(a),t.callAPI(i.fetchGuestDetailsInformation,{successCallBack:function(e){t.reservationData.guest&&t.reservationData.guest.id&&(t.reservationData.guest.id=a.id),g(e)},failureCallBack:function(e){t.errorMessage=e,t.$emit("hideLoader")},params:a.id}),t.$broadcast("guestSearchStopped"))},t.showGuestPaymentList=function(e){var a=e.user_id,r=e.guest_id,n=function(e){t.$emit("hideLoader");var e={data:e,user_id:a,guest_id:r};t.$emit("GUESTPAYMENTDATA",e),t.$emit("SHOWGUESTLIKES")};t.invokeApi(o.fetchGuestPaymentData,a,n,"","NONE")},t.showContractedRates=function(e){t.$broadcast("cardChanged",e)};var w=function(e,a){var r=function(){t.reservationData.guest.id||t.reservationData.company.id||t.reservationData.travelAgent.id?t.saveReservation():t.$emit("PROMPTCARD")};t.otherData.taxesMeta=e.tax_codes,t.otherData.hourlyTaxInfo=e.tax_information,p.metaData.taxDetails=angular.copy(e.tax_codes),t.reservationData.totalTax=0,a&&(t.reservationData.guest.id||t.reservationData.company.id||t.reservationData.travelAgent.id?t.saveReservation():(t.$emit("PROMPTCARD"),t.$watch("reservationData.guest.id",r),t.$watch("reservationData.company.id",r),t.$watch("reservationData.travelAgent.id",r))),l(function(){t.$emit("hideLoader")},500)};t.populateDatafromDiary=function(e,a,r){var n=[];this.rooms=[],angular.forEach(a.rooms,function(t){t.roomTypeId=parseInt(e[t.room_id].room_type_id,10),t.roomTypeName=e[t.room_id].room_type_name,t.roomNumber=e[t.room_id].room_no,n.push(parseInt(t.roomTypeId,10))}),n=_.uniq(n),t.reservationData.tabs=v.getTabDataModel(n.length,n),t.reservationData.rooms=[],_.each(t.reservationData.tabs,function(e){var r=_.filter(a.rooms,function(t){return parseInt(t.roomTypeId,10)===parseInt(e.roomTypeId,10)});e.roomCount=r.length,t.reservationData.rooms=t.reservationData.rooms.concat(r)}),t.reservationData.arrivalDate=u(new tzIndependentDate(a.arrival_date),"yyyy-MM-dd"),t.reservationData.departureDate=u(new tzIndependentDate(a.departure_date),"yyyy-MM-dd");var o=a.arrival_time.split(":");t.reservationData.checkinTime.hh=o[0],t.reservationData.checkinTime.mm=o[1].split(" ")[0],1===t.reservationData.checkinTime.mm.length&&(t.reservationData.checkinTime.mm="0"+t.reservationData.checkinTime.mm),t.reservationData.checkinTime.ampm=o[1].split(" ")[1],"AM"!==t.reservationData.checkinTime.ampm&&"PM"!==t.reservationData.checkinTime.ampm&&(parseInt(t.reservationData.checkinTime.hh)>=12?(t.reservationData.checkinTime.hh=Math.abs(parseInt(t.reservationData.checkinTime.hh)-12)+"",t.reservationData.checkinTime.ampm="PM"):t.reservationData.checkinTime.ampm="AM"),0!==Math.abs(parseInt(t.reservationData.checkinTime.hh)-12)&&"00"!==t.reservationData.checkinTime.hh&&"0"!==t.reservationData.checkinTime.hh||(t.reservationData.checkinTime.hh="12"),1===t.reservationData.checkinTime.hh.length&&(t.reservationData.checkinTime.hh="0"+t.reservationData.checkinTime.hh);var i=a.departure_time.split(":");t.reservationData.checkoutTime.hh=i[0],t.reservationData.checkoutTime.mm=i[1].split(" ")[0],1===t.reservationData.checkoutTime.mm.length&&(t.reservationData.checkoutTime.mm="0"+t.reservationData.checkoutTime.mm),t.reservationData.checkoutTime.ampm=i[1].split(" ")[1],"AM"!==t.reservationData.checkoutTime.ampm&&"PM"!==t.reservationData.checkoutTime.ampm&&(parseInt(t.reservationData.checkoutTime.hh)>=12?(t.reservationData.checkoutTime.hh=Math.abs(parseInt(t.reservationData.checkoutTime.hh)-12)+"",t.reservationData.checkoutTime.ampm="PM"):t.reservationData.checkoutTime.ampm="AM"),"0"!==Math.abs(parseInt(t.reservationData.checkoutTime.hh)-12)&&"00"!==t.reservationData.checkoutTime.hh&&"0"!==t.reservationData.checkoutTime.hh||(t.reservationData.checkoutTime.hh="12"),1===t.reservationData.checkoutTime.hh.length&&(t.reservationData.checkoutTime.hh="0"+t.reservationData.checkoutTime.hh);var s=a.rooms[0];this.reservationId=s.reservation_id,this.confirmNum=s.confirmation_id,this.reservationId?t.viewState.identifier="CONFIRM":(t.viewState.identifier="CREATION",t.viewState.reservationStatus.confirm=!1),t.reservationDetails.guestCard={},t.reservationDetails.guestCard.id=s.guest_card_id,t.reservationDetails.travelAgent={},t.reservationDetails.travelAgent.id=s.travel_agent_id,t.reservationDetails.companyCard={},t.reservationDetails.companyCard.id=s.company_card_id,t.reservationData.guest={},t.reservationData.guest.id=s.guest_card_id,t.reservationData.travelAgent={},t.reservationData.travelAgent.id=s.travel_agent_id,t.reservationData.company={},t.reservationData.company.id=s.company_card_id,t.reservationData.guest.id&&t.initGuestCard({id:t.reservationData.guest.id}),t.reservationData.company.id&&t.initCompanyCard(),t.reservationData.travelAgent.id&&t.initTravelAgentCard(),this.totalStayCost=0;var c=[],l=this;angular.forEach(t.reservationData.rooms,function(e){var r=_.findWhere(a.rooms,{roomNumber:e.roomNumber});e.stayDates={},c.push(r.rateId),e.numAdults=r.numAdults,e.numChildren=r.numChildren,e.numInfants=r.numInfants,e.roomTypeId=r.roomTypeId,e.amount=r.amount,e.room_id=r.room_id,e.room_no=r.room_no,e.room_type=r.room_type,a.addons&&(e.addons=[],angular.forEach(a.addons,function(t){e.addons.push({quantity:t.addon_count,id:t.id,price:parseFloat(t.amount),amountType:t.amount_type,postType:t.post_type,title:t.name,totalAmount:t.addon_count*parseFloat(t.amount),is_inclusive:t.is_inclusive,taxes:t.taxes,is_rate_addon:t.is_rate_addon})})),e.rateId=r.rateId,e.roomAmount=r.amount,e.demographics={market:"undefined"!=typeof r.demographics&&r.demographics.market_segment_id?r.demographics.market_segment_id:"",source:"undefined"!=typeof r.demographics&&r.demographics.source_id?r.demographics.source_id:"",reservationType:"undefined"!=typeof r.demographics&&r.demographics.reservation_type_id?r.demographics.reservation_type_id:"",origin:"undefined"!=typeof r.demographics&&r.demographics.booking_origin_id?r.demographics.booking_origin_id:"",segment:"undefined"!=typeof r.segment&&r.demographics.segment_id?r.demographics.segment_id:""},l.demographics=angular.copy(e.demographics),l.totalStayCost=parseFloat(l.totalStayCost)+parseFloat(r.amount);var n=function(a){e.rateName=a.name,t.reservationData.demographics.market||(t.reservationData.demographics.market=a.market_segment_id?a.market_segment_id:""),t.reservationData.demographics.source||(t.reservationData.demographics.source=a.source_id?a.source_id:""),t.reservationData.demographics.origin||(t.reservationData.demographics.origin=a.booking_origin_id?a.booking_origin_id:""),angular.forEach(t.reservationData.rooms,function(e,t){e.demographics.market||(e.demographics.market=a.market_segment_id?a.market_segment_id:""),e.demographics.source||(e.demographics.source=a.source_id?a.source_id:""),e.demographics.origin||(e.demographics.origin=a.booking_origin_id?a.booking_origin_id:"")}),(a.deposit_policy&&a.deposit_policy.id||a.deposit_policy_id)&&(t.reservationData.depositData={},t.reservationData.depositData.isDepositRequired=!0,t.reservationData.depositData.description=a.deposit_policy.description,t.reservationData.depositData.depositSuccess=!t.reservationData.depositData.isDepositRequired,t.reservationData.depositData.attempted=!1,t.reservationData.depositData.depositAttemptFailure=!1,t.$broadcast("UPDATEDEPOSIT"))},o=parseFloat(e.roomAmount).toFixed(2);t.invokeApi(d.getRateDetails,{id:e.rateId},n);for(var i=1*new tzIndependentDate(t.reservationData.arrivalDate),s=1*new tzIndependentDate(t.reservationData.departureDate);i<=s;i+=864e5)e.stayDates[u(new tzIndependentDate(i),"yyyy-MM-dd")]={guests:{adults:e.numAdults,children:e.numChildren,infants:e.numInfants},rate:{id:e.rateId},rateDetails:{actual_amount:o,modified_amount:o,is_discount_allowed:"true"}},e.contract_id&&(e.stayDates[u(new tzIndependentDate(i),"yyyy-MM-dd")].contractId=e.contract_id,delete e.contract_id)}),t.invokeApi(d.getTaxDetails,{rate_ids:c},w)}.bind(t.reservationData),t.loadPrevState=function(){e.loadPrevState(),e.$broadcast("OUTSIDECLICKED")},t.staycardClicked=function(){t.$broadcast("saveContactInfo")}}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){angular.module("sntRover").controller("RVTravelAgentCardCtrl",["$scope","$rootScope","$timeout","RVCompanyCardSrv","rvCompanyCardContractsSrv","ngDialog","$filter","$stateParams","rvPermissionSrv","rvFileCloudStorageSrv",function(e,t,a,r,n,o,i,s,c,d){e.searchMode=!0,e.account_type="TRAVELAGENT",e.currentSelectedTab="cc-contact-info",e.isGlobalToggleReadOnly=!c.getPermissionValue("GLOBAL_CARD_UPDATE");var l=[];e.hasPermissionToViewCommissionTab=function(){return c.getPermissionValue("VIEW_COMMISSIONS_TAB")},e.isCommissionTabAvailable=e.hasPermissionToViewCommissionTab(),e.switchTabTo=function(t,a){t.stopPropagation(),t.stopImmediatePropagation();var r=!!e.contactInformation.account_details.accounts_receivable_number;"cc-contact-info"===e.currentSelectedTab&&"cc-contact-info"!==a&&(e.viewState.isAddNewCard?e.$broadcast("setCardContactErrorMessage",[i("translate")("TA_SAVE_PROMPT")]):(h(e.contactInformation),e.$broadcast("contractTabActive"))),"cc-contracts"===e.currentSelectedTab&&"cc-contracts"!==a?(e.$broadcast("contactTabActive"),e.$broadcast("saveContract")):"cc-ar-accounts"===e.currentSelectedTab&&"cc-ar-accounts"!==a&&e.$broadcast("saveArAccount"),"cc-ar-accounts"===a?e.$broadcast("arAccountTabActive"):"cc-contracts"===a?e.$broadcast("contractTabActive"):"cc-contact-info"===a?e.$broadcast("contactTabActive"):"cc-ar-transactions"===a&&r?(e.$broadcast("arTransactionTabActive"),e.isWithFilters=!1):"cc-notes"===a?(e.$broadcast("fetchNotes"),e.isWithFilters=!1):"statistics"===a?e.$broadcast("LOAD_STATISTICS"):"wallet"===a?e.$broadcast("wallet"):"cc-commissions"===a?e.$broadcast("commissionsTabActive"):"cc-activity-log"===a&&e.$broadcast("activityLogTabActive"),"cc-ar-transactions"!==a||r?e.viewState.isAddNewCard||(e.currentSelectedTab=a):console.warn("Save AR Account and Navigate to AR Transactions")},e.$on("ARTransactionSearchFilter",function(t,a){e.isWithFilters=a});var u={},m=!1;e.shouldShowARMandatoryPopup=function(){var t=(!e.contactInformation.mandatoryFields.address_line1_mandatory.is_mandatory_on_ar_account_creation&&!e.contactInformation.mandatoryFields.address_line1_mandatory.is_mandatory||!isEmpty(e.contactInformation.address_details.street1))&&(!e.contactInformation.mandatoryFields.city_mandatory.is_mandatory_on_ar_account_creation&&!e.contactInformation.mandatoryFields.city_mandatory.is_mandatory||!isEmpty(e.contactInformation.address_details.city))&&(!e.contactInformation.mandatoryFields.postal_code_mandatory.is_mandatory_on_ar_account_creation&&!e.contactInformation.mandatoryFields.postal_code_mandatory.is_mandatory||!isEmpty(e.contactInformation.address_details.postal_code))&&(!e.contactInformation.mandatoryFields.country_mandatory.is_mandatory_on_ar_account_creation&&!e.contactInformation.mandatoryFields.country_mandatory.is_mandatory||""!==e.contactInformation.address_details.country_id&&null!==e.contactInformation.address_details.country_id)&&(!e.contactInformation.mandatoryFields.contact_phone_mandatory.is_mandatory_on_ar_account_creation&&!e.contactInformation.mandatoryFields.contact_phone_mandatory.is_mandatory||!isEmpty(e.contactInformation.address_details.phone))&&(!e.contactInformation.mandatoryFields.contact_email_address_mandatory.is_mandatory_on_ar_account_creation&&!e.contactInformation.mandatoryFields.contact_email_address_mandatory.is_mandatory||!isEmpty(e.contactInformation.address_details.email_address)&&isValidEmail(e.contactInformation.address_details.email_address))&&(!e.contactInformation.mandatoryFields.e_invoice_mandatory.is_mandatory_on_ar_account_creation&&!e.contactInformation.mandatoryFields.e_invoice_mandatory.is_mandatory||!isEmpty(e.contactInformation.e_invoice_address))&&(!e.contactInformation.mandatoryFields.organization_id_mandatory.is_mandatory_on_ar_account_creation&&!e.contactInformation.mandatoryFields.organization_id_mandatory.is_mandatory||!isEmpty(e.contactInformation.account_details.organization_id))&&(!e.contactInformation.mandatoryFields.tax_id_mandatory.is_mandatory_on_ar_account_creation&&!e.contactInformation.mandatoryFields.tax_id_mandatory.is_mandatory||!isEmpty(e.contactInformation.account_details.tax_number))&&(!e.contactInformation.mandatoryFields.regd_tax_office_mandatory.is_mandatory_on_ar_account_creation&&!e.contactInformation.mandatoryFields.regd_tax_office_mandatory.is_mandatory||!isEmpty(e.contactInformation.account_details.reg_tax_office))&&(!e.contactInformation.mandatoryFields.contact_name_mandatory.is_mandatory_on_ar_account_creation&&!e.contactInformation.mandatoryFields.contact_name_mandatory.is_mandatory||!isEmpty(e.contactInformation.primary_contact_details.contact_first_name)&&!isEmpty(e.contactInformation.primary_contact_details.contact_last_name))&&(!!e.arAccountDetails.is_auto_assign_ar_numbers||""!==e.arAccountDetails.ar_number&&null!==e.arAccountDetails.ar_number)&&(!e.contactInformation.mandatoryFields.payment_due_days_mandatory.is_mandatory_on_ar_account_creation&&!e.contactInformation.mandatoryFields.payment_due_days_mandatory.is_mandatory||""!==e.arAccountDetails.payment_due_days&&null!==e.arAccountDetails.payment_due_days);return t},e.$on("saveArAccountFromMandatoryPopup",function(t,a){e.arAccountDetails=a,e.isArTabAvailable=!0,e.shouldSaveArDataFromPopup=!0}),e.openCompanyTravelAgentCardMandatoryFieldsPopup=function(){e.shouldSaveArDataFromPopup=!1,o.open({template:"/assets/partials/companyCard/rvCompanyTravelAgentCardMandatoryFieldsPopup.html",className:"ngdialog-theme-default1 calendar-single1",controller:"companyTravelAgentMandatoryFieldsController",closeByDocument:!1,scope:e})},e.clickedCreateArAccountButton=function(){e.shouldShowARMandatoryPopup()?(m=!0,e.showARTab()):(e.isMandatoryPopupOpen=!0,e.openCompanyTravelAgentCardMandatoryFieldsPopup())},e.$on("UPDATE_MANDATORY_POPUP_OPEN_FLAG",function(){e.isMandatoryPopupOpen=!1;
}),e.showARTab=function(t){h(e.contactInformation)},e.$on("ARNumberChanged",function(t,a){e.contactInformation.account_details.accounts_receivable_number=a.newArNumber}),e.deleteArAccount=function(){o.open({template:"/assets/partials/companyCard/rvCompanyCardDeleteARaccountPopup.html",className:"ngdialog-theme-default1 calendar-single1",closeByDocument:!1,scope:e})},e.deleteARAccountConfirmed=function(){var t=function(t){e.$emit("hideLoader"),e.isArTabAvailable=!1,e.$broadcast("setgenerateNewAutoAr",!1),e.$broadcast("ArAccountDeleted"),e.contactInformation.account_details.accounts_receivable_number="",o.close()},a={id:e.reservationDetails.travelAgent.id};e.invokeApi(r.deleteArAccount,a,t)},e.clikedDiscardDeleteAr=function(){o.close()};var f=function(){var t={id:e.reservationDetails.travelAgent.id},a=function(t){e.$emit("hideLoader"),e.arAccountNotes=t,e.$broadcast("ARDetailsRecieved")},n=function(){e.invokeApi(r.fetchArAccountNotes,t,a)},o=function(t){e.$emit("hideLoader"),e.arAccountDetails=t,e.arAccountDetails.is_use_main_contact!==!1&&(e.arAccountDetails.is_use_main_contact=!0),e.arAccountDetails.is_use_main_address!==!1&&(e.arAccountDetails.is_use_main_address=!0),n()};e.invokeApi(r.fetchArAccountDetails,t,o)};e.$on("travelAgentFetchComplete",function(t,r){e.searchMode=!1,e.contactInformation=e.travelAgentInformation,e.contactInformation.id=e.reservationDetails.travelAgent.id,e.currentSelectedTab="cc-contact-info",u=angular.copy(e.contactInformation),r===!0&&(e.contactInformation.account_details.account_name=e.searchData.travelAgentCard.travelAgentName,e.contactInformation.address_details.city=e.searchData.travelAgentCard.travelAgentCity,e.contactInformation.account_details.account_number=e.searchData.travelAgentCard.travelAgentIATA),e.$broadcast("contactTabActive"),e.$broadcast("UPDATE_CONTACT_INFO"),a(function(){e.$emit("hideLoader")},1e3),r||f(),e.contactInformation.commission_details&&(e.displayShowPropertiesButton=!e.contactInformation.commission_details.is_global_commission)}),e.$on("travelAgentSearchInitiated",function(){e.companySearchIntiated=!0,e.travelAgents=e.searchedtravelAgents,e.$broadcast("refreshTravelAgentScroll")}),e.$on("travelAgentSearchStopped",function(){e.companySearchIntiated=!1,e.travelAgents=[],e.$broadcast("refreshTravelAgentScroll")}),e.$on("travelAgentDetached",function(){e.searchMode=!0,e.isArTabAvailable=!1,e.$broadcast("setgenerateNewAutoAr",!1)}),e.travelAgentCardClicked=function(a){a.stopPropagation(),null!==document.getElementById("cc-contact-info")&&getParentWithSelector(a,document.getElementById("cc-contact-info"))&&"cc-contact-info"===e.currentSelectedTab||null!==document.getElementById("cc-contracts")&&getParentWithSelector(a,document.getElementById("cc-contracts"))&&"cc-contracts"===e.currentSelectedTab||null!==document.getElementById("cc-ar-accounts")&&getParentWithSelector(a,document.getElementById("cc-ar-accounts"))&&"cc-ar-accounts"===e.currentSelectedTab||(!e.viewState.isAddNewCard&&null!==document.getElementById("travel-agent-card-header")&&getParentWithSelector(a,document.getElementById("travel-agent-card-header"))&&(e.$emit("saveContactInformation"),t.$broadcast("saveArAccount")),d.activeCardType="ACCOUNT_TRAVELAGENT")},e.$on("saveContactInformation",function(t,a){t.preventDefault(),t.stopPropagation(),a&&a.other_hotels_info?(e.contactInformation.commission_details.other_hotels_info=a.other_hotels_info,h(e.contactInformation,a.hotel_info_changed_from_popup)):h(e.contactInformation)}),e.$on("saveTravelAgentContactInformation",function(t){t.preventDefault(),h(e.contactInformation)}),e.toggleGlobalButton=function(){c.getPermissionValue("GLOBAL_CARD_UPDATE")&&(e.contactInformation.is_global_enabled=!e.contactInformation.is_global_enabled,e.contactInformation.account_type=e.account_type)},e.shouldShowCommissionsTab=function(){return"TRAVELAGENT"===e.account_type},e.isUpdateEnabledForTravelAgent=function(){if(void 0!==e.contactInformation.is_global_enabled){var t=!1;return e.contactInformation.is_global_enabled?c.getPermissionValue("GLOBAL_CARD_UPDATE")||(t=!0):c.getPermissionValue("EDIT_TRAVEL_AGENT_CARD")||(t=!0),t}},e.isUpdateEnabledForName=function(){var e=n.getContractedRates(),t=!0;return(e.current_contracts&&e.current_contracts.length>0||e.future_contracts&&e.future_contracts.length>0||e.history_contracts&&e.history_contracts.length>0)&&(t=!1),t},e.$on("OUTSIDECLICKED",function(a,r){a.preventDefault(),h(e.contactInformation),e.checkOutsideClick(r),t.$broadcast("saveArAccount"),t.$broadcast("saveContract")});var p=function(a,r){r&&o.close(),e.contactInformation.commission_details&&e.contactInformation.commission_details.is_global_commission&&angular.forEach(e.contactInformation.commission_details.other_hotels_info,function(t){t.commission_type=e.contactInformation.commission_details.commission_type,t.type=e.contactInformation.commission_details.type,t.value=e.contactInformation.commission_details.value,t.is_prepaid=e.contactInformation.commission_details.is_prepaid}),e.contactInformation.id=a.id,e.reservationDetails.travelAgent.id=a.id,t.$broadcast("IDGENERATED",{id:a.id}),e.shouldSaveArDataFromPopup&&(e.shouldSaveArDataFromPopup=!1,e.$broadcast("UPDATE_AR_ACCOUNT_DETAILS",e.arAccountDetails),e.$broadcast("saveArAccount")),f(),e.viewState.isAddNewCard&&"undefined"!=typeof a.id&&(("STAY_CARD"===e.viewState.identifier||"CREATION"===e.viewState.identifier&&e.viewState.reservationStatus.confirm)&&(e.viewState.pendingRemoval.status=!1,e.reservationDetails.travelAgent.futureReservations<=0?e.replaceCardCaller("travel_agent",{id:a.id},!1):e.checkFuture("travel_agent",{id:a.id}),e.reservationDetails.travelAgent.futureReservations=0,e.viewState.pendingRemoval.cardType=""),e.viewState.isAddNewCard=!1,e.closeGuestCard(),e.cardSaved(),e.reservationDetails.travelAgent.id=a.id,e.reservationData&&e.reservationData.travelAgent&&(e.reservationData.travelAgent.id=a.id,e.reservationData.travelAgent.name=e.contactInformation.account_details.account_name)),u=angular.copy(e.contactInformation)},v=function(a){t.$broadcast("setCardContactErrorMessage",a),e.currentSelectedTab="cc-contact-info"};e.clickedSaveCard=function(t){"travel_agent"===t&&"CHECKEDOUT"===e.reservationData.status&&new Date(e.userInfo.business_date)>new Date(e.reservationData.departureDate)?o.open({template:"/assets/partials/cards/popups/rvNewTACommissionsWarningPopup.html",className:"",closeByDocument:!1,closeByEscape:!1,scope:e}):h(e.contactInformation)},e.saveNewTACard=function(t){t.stopPropagation(),o.close(),h(e.contactInformation)};var D=function(e,t){return e&&e.commission_details&&t&&t.commission_details},h=function(t,a){var n=!1;if(l=[],D(t,u)&&!angular.equals(t,u)&&(n=!0,angular.forEach(t.commission_details.other_hotels_info,function(e){angular.forEach(u.commission_details.other_hotels_info,function(t){e.id!==t.id||_.isMatch(e,t)||l.push(e)})})),"undefined"!=typeof t&&(n||e.viewState.isAddNewCard)){var i=JSON.parse(JSON.stringify(t));i.commission_details&&(i.commission_details.other_hotels_info=angular.copy(l)),"undefined"!=typeof i.countries&&delete i.countries,""===i.account_details.account_number&&(i.account_details.account_number=null),"undefined"==typeof i.primary_contact_details?(i.primary_contact_details={},i.primary_contact_details.contact_email=null):""===i.primary_contact_details.contact_email&&(i.primary_contact_details.contact_email=null),"undefined"==typeof i.address_details&&(i.address_details={}),i.account_type=e.account_type;var s={params:i,successCallBack:function(e){p(e,a)},failureCallBack:v};e.callAPI(r.saveContactInformation,s)}else e.shouldSaveArDataFromPopup&&(e.shouldSaveArDataFromPopup=!1,e.$broadcast("UPDATE_AR_ACCOUNT_DETAILS",e.arAccountDetails),e.$broadcast("saveArAccount")),m&&(e.$broadcast("setgenerateNewAutoAr",!0),e.$broadcast("saveArAccount"),e.isArTabAvailable=!0),m=!1,a&&o.close()};e.hasPermissionToCreateArAccount=function(){return c.getPermissionValue("CREATE_AR_ACCOUNT")}}]),angular.module("sntRover").controller("travelAgentResults",["$scope","$timeout",function(e,t){BaseCtrl.call(this,e);var a={scrollX:!0,click:!0,preventDefault:!1};e.setScroller("travelAgentResultScroll",a),e.$on("refreshTravelAgentScroll",function(){t(function(){e.refreshScroller("travelAgentResultScroll")},500)})}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){sntRover.controller("RVDepositBalanceAccountsCtrl",["$scope","ngDialog","$rootScope","RVDepositBalanceSrv","RVPaymentSrv","$stateParams","$filter","$timeout","rvPermissionSrv","RVReservationCardSrv",function(e,t,a,r,n,o,i,s,c,d){BaseCtrl.call(this,e),e.pageloadingOver=!1,s(function(){e.pageloadingOver=!0},3500),e.shouldShowWaiting=!1,e.depositWithGiftCard=!1,e.depositPaidSuccesFully=!1,e.shouldShowExistingCards=!0,e.shouldShowAddNewCard=!0,e.authorizedCode="",e.showExistingAndAddNewPayments=!0,e.showOnlyAddCard=!1,e.cardsList=[],e.shouldShowMakePaymentButton=!0,e.shouldShowMakePaymentScreen=!0,e.showAddtoGuestCard=!0,e.shouldCardAvailable=!1,e.depositBalanceMakePaymentData={},e.depositBalanceMakePaymentData.amount=parseFloat(e.depositBalanceData.current_balance).toFixed(2),e.depositBalanceMakePaymentData.payment_amount=parseFloat(e.depositBalanceData.current_payment_balance).toFixed(2),e.refundAmount=0,e.depositBalanceMakePaymentData.amount<0&&(e.refundAmount=-1*parseFloat(e.depositBalanceMakePaymentData.amount),e.shouldShowMakePaymentButton=!1),e.depositBalanceMakePaymentData.add_to_guest_card=!1,e.makePaymentButtonDisabled=!0,e.isDisplayReference=!1,e.referanceText="",e.isAddToGuestCardVisible=!1,e.isSwipedCardSave=!1,e.isManual=!1,e.setScroller("cardsList",{click:!0,tap:!0}),e.setScroller("deopositdue");var l=function(){s(function(){e.refreshScroller("deopositdue")},1500)},l=function(){s(function(){e.refreshScroller("cardsList")},1500)},u=function(){setTimeout(function(){e.refreshScroller("payment-deposit-scroll")},500)};e.validPayment=!0,e.disableMakePayment=function(){return!!e.validPayment&&("undefined"==typeof e.depositBalanceMakePaymentData.payment_type||!(e.depositBalanceMakePaymentData.payment_type.length>0))},e.showingDepositModal=!1,e.giftCardAmountAvailable=!1,e.giftCardAvailableBalance=0,e.$on("giftCardAvailableBalance",function(t,a){e.giftCardAvailableBalance=a.amount}),e.timer=null,e.hasPermissionToMakePayment=function(){return c.getPermissionValue("MAKE_PAYMENT")},"sixpayments"===a.paymentGateway&&(e.shouldCardAvailable=!1,e.makePaymentButtonDisabled=!1),e.hideCreditCardFields=function(){e.addmode=!1,e.shouldShowExistingCards=!1,e.shouldCardAvailable=!1},e.changeOnsiteCallIn=function(){e.shouldShowMakePaymentScreen=!e.isManual,e.shouldShowExistingCards=e.cardsList.length>0,e.addmode=!(e.cardsList.length>0),e.shouldCardAvailable=!e.shouldShowMakePaymentScreen,l()},e.$on("changeOnsiteCallIn",function(t){e.isManual=!e.isManual,e.changeOnsiteCallIn()}),e.$on("TOKEN_CREATED",function(t,a){e.cardValues=a;var r="";if(e.cardValues.tokenDetails.isSixPayment){r=""!==e.cardValues.tokenDetails.expiry?"20"+e.cardValues.tokenDetails.expiry.substring(0,2)+"-"+e.cardValues.tokenDetails.expiry.substring(2,4)+"-01":"",e.shouldShowIframe=!1,e.shouldShowMakePaymentScreen=!0,e.showAddtoGuestCard=!1,e.shouldShowExistingCards=!1,e.addmode=!1,e.makePaymentButtonDisabled=!1,e.shouldCardAvailable=!0,e.depositBalanceMakePaymentData.card_code=getSixCreditCardType(e.cardValues.tokenDetails.card_type).toLowerCase(),e.depositBalanceMakePaymentData.ending_with=e.cardValues.tokenDetails.token_no.substr(e.cardValues.tokenDetails.token_no.length-4);var o={token:e.cardValues.tokenDetails.token_no,card_name:e.passData.details.firstName+" "+e.passData.details.lastName,card_expiry:r,payment_type:"CC"}}else{r=""!==e.cardValues.cardDetails.expiryMonth&&""!==e.cardValues.cardDetails.expiryYear?"20"+e.cardValues.cardDetails.expiryYear+"-"+e.cardValues.cardDetails.expiryMonth+"-01":"",e.depositBalanceMakePaymentData.card_code=getCreditCardType(e.cardValues.cardDetails.cardType).toLowerCase(),e.depositBalanceMakePaymentData.ending_with=e.cardValues.cardDetails.cardNumber.substr(e.cardValues.cardDetails.cardNumber.length-4);var o={token:e.cardValues.tokenDetails.session,card_name:e.cardValues.cardDetails.userName,card_expiry:r,payment_type:"CC"}}o.card_code=e.cardValues.tokenDetails.isSixPayment?getSixCreditCardType(e.cardValues.tokenDetails.card_type).toLowerCase():e.cardValues.cardDetails.cardType,e.depositBalanceMakePaymentData.card_expiry=e.cardValues.tokenDetails.isSixPayment?e.cardValues.tokenDetails.expiry.substring(2,4)+" / "+e.cardValues.tokenDetails.expiry.substring(0,2):e.cardValues.cardDetails.expiryMonth+" / "+e.cardValues.cardDetails.expiryYear,e.invokeApi(n.savePaymentDetails,o,e.successSavePayment)}),e.$on("MLI_ERROR",function(t,a){e.errorMessage=a}),e.feeData={};parseFloat("0.00");e.isShowFees=function(){var t=!1,r=e.feeData;return"undefined"==typeof r||"undefined"==typeof r.feesInfo||null===r.feesInfo?t=!1:r.defaultAmount>=r.minFees&&e.isStandAlone&&r.feesInfo.amount&&e.depositBalanceMakePaymentData.amount>=0&&(t=!("sixpayments"===a.paymentGateway&&!e.isManual&&"CC"===e.depositBalanceMakePaymentData.payment_type||""===e.depositBalanceMakePaymentData.payment_type)),t},e.emitCancelCardSelection=function(){if(a.isStandAlone||t.close(),e.depositWithGiftCard=!1,e.$emit("cancelCardSelection"),e.cardselectedIndex=-1,$("#sixIframe").length){var r=document.getElementById("sixIframe");r.src=r.src}},e.clickedMakePayment=function(){var t={postData:{payment_type:e.depositBalanceMakePaymentData.payment_type,amount:e.depositBalanceMakePaymentData.amount,payment_method_id:e.paymentId},bill_id:e.depositBalanceData.primary_bill_id};e.isShowFees()&&(e.feeData.calculatedFee&&(t.postData.fees_amount=e.feeData.calculatedFee),e.feeData.feesInfo&&(t.postData.fees_charge_code_id=e.feeData.feesInfo.charge_code_id)),e.invokeApi(r.submitPaymentOnBill,t,e.successMakePayment)},e.giftCardAvailableBalance="",e.$on("giftCardAvailableBalance",function(t,a){e.giftCardAvailableBalance=a.amount,e.giftCardAmountAvailable=!0}),a.$on("validatedGiftCardPmt",function(t,a){a?e.validPayment=!0:e.validPayment=!1}),e.updatedAmountToPay=function(t){if("GIFT_CARD"===e.depositBalanceMakePaymentData.payment_type){var r=e.giftCardAvailableBalance;if(r){var n=parseFloat(r).toFixed(2),o=parseFloat(t).toFixed(2);n=parseFloat(n),o=parseFloat(o),n<o?e.validPayment=!1:e.validPayment=!0}}else e.validPayment=!0;a.$broadcast("validatedGiftCardPmt",e.validPayment)},e.successSavePayment=function(t){e.$emit("hideLoader"),e.shouldShowIframe=!1,e.shouldShowMakePaymentScreen=!0,e.showAddtoGuestCard=!1,e.shouldShowExistingCards=!1,e.addmode=!1,e.makePaymentButtonDisabled=!1,e.paymentId=t.id,e.shouldCardAvailable=!0},e.closeDepositModal=function(){e.$emit("UPDATE_DEPOSIT_BALANCE_FLAG",!1),e.$emit("TOGGLE_PAYMET_POPUP_STATUS",!1),e.closeDialog()},e.$on("CLOSE_DIALOG",e.closeDepositModal),e.successMakePayment=function(t){e.$emit("hideLoader"),"sixpayments"===a.paymentGateway&&e.isManual&&(e.authorizedCode=t.authorization_code),e.depositPaidSuccesFully=!0,e.$emit("BALANCE_AFTER_PAYMENT",t.current_balance)},e.setCreditCardFromList=function(t){e.shouldShowIframe=!1,e.shouldShowMakePaymentScreen=!0,e.showAddtoGuestCard=!1,e.shouldShowExistingCards=!1,e.addmode=!1,e.makePaymentButtonDisabled=!1,e.shouldCardAvailable=!0,e.paymentId=e.depositBalanceData.data.existing_payments[t].value,e.depositBalanceMakePaymentData.card_code=e.depositBalanceData.data.existing_payments[t].card_code,e.depositBalanceMakePaymentData.ending_with=e.depositBalanceData.data.existing_payments[t].ending_with,e.depositBalanceMakePaymentData.card_expiry=e.depositBalanceData.data.existing_payments[t].card_expiry,e.isStandAlone},e.$on("cardSelected",function(t,a){e.shouldCardAvailable=!0,e.setCreditCardFromList(a.index)}),e.showAddCardSection=function(){e.shouldShowIframe=!1,e.shouldShowMakePaymentScreen=!1,e.showAddtoGuestCard=!1,e.shouldShowExistingCards=!0,e.addmode=!1,e.makePaymentButtonDisabled=!1,l()},e.$on("cancelCardSelection",function(t,a){e.shouldShowMakePaymentScreen=!0,e.addmode=!1,e.depositBalanceMakePaymentData.payment_type="",e.isManual=!1}),e.$on("SHOW_SWIPED_DATA_ON_DEPOSIT_BALANCE_SCREEN",function(t,r){e.shouldShowMakePaymentScreen=!1,e.addmode=!0,a.$broadcast("RENDER_SWIPED_DATA",r),e.swipedCardHolderName=r.nameOnCard}),e.$on("SWIPED_DATA_TO_SAVE",function(t,a){e.depositBalanceMakePaymentData.card_code=a.cardType.toLowerCase(),e.depositBalanceMakePaymentData.ending_with=a.cardNumber.slice(-4),e.depositBalanceMakePaymentData.card_expiry=a.cardExpiryMonth+"/"+a.cardExpiryYear,e.depositBalanceMakePaymentData.payment_type="CC",e.isSwipedCardSave=!0;var r=a;r.payment_credit_type=a.cardType,r.credit_card=a.cardType,r.card_expiry="20"+a.cardExpiryYear+"-"+a.cardExpiryMonth+"-01",e.invokeApi(n.savePaymentDetails,r,e.successSavePayment)}),e.isBalanceAmountShown=function(){return!0},e.$on("PAYMENT_SUCCESS",function(t,a){e.successMakePayment(a),u()}),e.$on("PAYMENT_FAILED",function(t,a){e.errorMessage=a}),function(){e.setScroller("payment-deposit-scroll")}()}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){sntRover.controller("RVDepositBalanceCtrl",["$scope","ngDialog","$rootScope","RVDepositBalanceSrv","RVPaymentSrv","$stateParams","$filter","$timeout","rvPermissionSrv","RVReservationCardSrv","$state","RVAutomaticEmailSrv",function(e,t,a,r,n,o,i,s,c,d,l,u){BaseCtrl.call(this,e),SharedMethodsBaseCtrl.call(this,e,a,u,t),e.isDepositEditable=void 0===e.depositDetails.deposit_policy||!!e.depositDetails.deposit_policy&&!!e.depositDetails.deposit_policy.allow_deposit_edit,a.isStandAlone||(e.isDepositEditable=!0),e.pageloadingOver=!1,s(function(){e.pageloadingOver=!0},3500),e.shouldShowWaiting=!1,e.$emit("UPDATE_DEPOSIT_BALANCE_FLAG",!0),angular.forEach(e.depositBalanceData.data.existing_payments,function(e,t){e.isSelected=!1,e.mli_token=e.ending_with,e.card_expiry=e.expiry_date}),e.depositWithGiftCard=!1,e.depositPaidSuccesFully=!1,e.shouldShowExistingCards=!0,e.shouldShowAddNewCard=!0,e.authorizedCode="",e.showExistingAndAddNewPayments=!0,e.showOnlyAddCard=!1,e.cardsList=[],angular.forEach(e.depositBalanceData.data.existing_payments,function(t,a){t.is_credit_card&&e.cardsList.push(t)}),e.addmode=!(e.cardsList.length>0),e.shouldShowMakePaymentButton=!0,e.shouldShowMakePaymentScreen=!0,e.showAddtoGuestCard=!0,e.shouldCardAvailable=!1,e.depositBalanceMakePaymentData={},e.depositBalanceMakePaymentData.rateCurrency=e.depositBalanceData.data.rate_currency,e.depositBalanceMakePaymentData.amount=parseFloat(e.depositBalanceData.data.balance_deposit_amount).toFixed(2),e.depositBalanceMakePaymentData.payment_amount=parseFloat(e.depositBalanceData.data.balance_deposit_payment_amount).toFixed(2),e.refundAmount=0,e.depositBalanceMakePaymentData.amount<0&&(e.refundAmount=-1*parseFloat(e.depositBalanceMakePaymentData.amount),e.shouldShowMakePaymentButton=!1),e.depositBalanceMakePaymentData.add_to_guest_card=!1,e.makePaymentButtonDisabled=!0,e.isDisplayReference=!1,e.referanceText="",e.isAddToGuestCardVisible=!1,e.isSwipedCardSave=!1,e.isManual=!1,e.setScroller("cardsList",{click:!0,tap:!0}),e.setScroller("deopositdue"),e.setScroller("payment-deposit-scroll",{preventDefaultException:{tagName:/^(INPUT|TEXTAREA|BUTTON|SELECT|A|LABEL|FIGURE|SPAN|IMG)$/}});var m=function(){s(function(){e.refreshScroller("deopositdue")},1500)},m=function(){s(function(){e.refreshScroller("cardsList")},1500)},f=function(){setTimeout(function(){e.refreshScroller("payment-deposit-scroll")},500)};e.$on("PAYMENT_TYPE_CHANGED",function(){f()}),e.reservationData.reservation_card.payment_method_used=e.reservationData.reservation_card.payment_method_used?e.reservationData.reservation_card.payment_method_used:"",e.validPayment=!0,e.disableMakePayment=function(){return!!e.validPayment&&("undefined"==typeof e.depositBalanceMakePaymentData.payment_type||!(e.depositBalanceMakePaymentData.payment_type.length>0))},e.showingDepositModal=!1,e.hasPermissionToMakePayment=function(){return c.getPermissionValue("MAKE_PAYMENT")},e.showMakePaymentButtonStatus=function(){var t="";return t="undefined"!=typeof e.depositBalanceMakePaymentData.payment_type?e.depositBalanceMakePaymentData.payment_type.length>0&&e.validPayment?"green":"grey":e.validPayment?"grey":"grey overlay"},e.showRefundButtonStatus=function(){var t="";return t="undefined"!=typeof e.depositBalanceMakePaymentData.payment_type&&e.depositBalanceMakePaymentData.payment_type.length>0?"blue":"grey"},"CC"===e.reservationData.reservation_card.payment_method_used||"GIFT_CARD"===e.reservationData.reservation_card.payment_method_used?(e.shouldCardAvailable=!0,e.depositBalanceMakePaymentData.payment_type="CC","GIFT_CARD"===e.reservationData.reservation_card.payment_method_used&&(e.depositBalanceMakePaymentData.payment_type="GIFT_CARD"),e.depositBalanceMakePaymentData.card_code=e.reservationData.reservation_card.payment_details.card_type_image.replace(".png",""),e.depositBalanceMakePaymentData.ending_with=e.reservationData.reservation_card.payment_details.card_number,e.depositBalanceMakePaymentData.card_expiry=e.reservationData.reservation_card.payment_details.card_expiry,e.paymentId=e.reservationData.reservation_card.payment_details.id):e.isStandAlone&&(e.depositBalanceMakePaymentData.payment_type=angular.copy(e.reservationData.reservation_card.payment_method_used)),e.showSixPayCardInput=function(){return!("sixpayments"!=e.paymentGateway||"CC"!=e.depositBalanceMakePaymentData.payment_type||!e.shouldShowMakePaymentScreen||e.depositPaidSuccesFully||e.depositWithGiftCard)},e.showCCPage=!1,e.showPaymentTypeBox=function(t){e.showCCPage=!t},e.changeOnsiteCallIn=function(){e.shouldShowMakePaymentScreen=!e.isManual,e.shouldShowExistingCards=e.cardsList.length>0,e.addmode=!(e.cardsList.length>0),e.shouldCardAvailable=!e.shouldShowMakePaymentScreen,m()},e.$on("changeOnsiteCallIn",function(t){e.isManual=!e.isManual,e.changeOnsiteCallIn()}),e.feeData={},e.emitCancelCardSelection=function(){if(a.isStandAlone||t.close(),e.depositWithGiftCard=!1,e.$emit("cancelCardSelection"),e.cardselectedIndex=-1,$("#sixIframe").length){var r=document.getElementById("sixIframe");r.src=r.src}},e.giftCardAvailableBalance="",e.$on("giftCardAvailableBalance",function(t,a){e.giftCardAvailableBalance=a.amount,e.giftCardAmountAvailable=!0}),a.$on("validatedGiftCardPmt",function(t,a){a?e.validPayment=!0:e.validPayment=!1}),e.updatedAmountToPay=function(t){if("GIFT_CARD"===e.depositBalanceMakePaymentData.payment_type){var r=e.giftCardAvailableBalance;if(r){var n=parseFloat(r).toFixed(2),o=parseFloat(t).toFixed(2);n=parseFloat(n),o=parseFloat(o),n<o?e.validPayment=!1:e.validPayment=!0}}else e.validPayment=!0;a.$broadcast("validatedGiftCardPmt",e.validPayment)},e.successSavePayment=function(t){e.$emit("hideLoader"),e.shouldShowIframe=!1,e.shouldShowMakePaymentScreen=!0,e.showAddtoGuestCard=!1,e.shouldShowExistingCards=!1,e.addmode=!1,e.makePaymentButtonDisabled=!1,e.paymentId=t.id,e.shouldCardAvailable=!0,e.isAddToGuestCardVisible=!0,f()},e.closeDepositModal=function(){e.$emit("UPDATE_DEPOSIT_BALANCE_FLAG",!1),e.closeDialog()},e.$on("CLOSE_DIALOG",function(){l.reload(l.$current.name),e.closeDepositModal()});var p=function(t){e.$emit("hideLoader"),e.errorMessage=t},v=function(t){e.$emit("hideLoader"),e.errorMessage=[],e.currentPaymentBillId=t.bill_id,e.currentPaymentTransactionId=t.transaction_id,e.isDepositPayment=t.is_deposit_payment,(a.autoEmailPayReceipt||a.autoEmailDepositInvoice&&e.isDepositPayment)&&e.autoTriggerPaymentReceiptActions();var r=t.payment_type||{},n=e.reservationData.reservation_card;if("false"!==n.is_rates_suppressed&&n.is_rates_suppressed!==!1||(n.deposit_attributes.outstanding_stay_total=parseInt(n.deposit_attributes.outstanding_stay_total)-parseInt(e.depositBalanceMakePaymentData.amount)),e.isAddToGuestCardVisible){var o=r.card_code.toLowerCase(),i=r.ending_with,s="";s=e.isSwipedCardSave?e.swipedCardHolderName:e.cardValues.tokenDetails.isSixPayment?e.passData.details.firstName+" "+e.passData.details.lastName:e.cardValues.cardDetails.userName;var c={card_code:o,mli_token:i,card_expiry:r.expiry_date,card_name:s,id:r.id,isSelected:!0,is_primary:!1,payment_type:"CC",payment_type_id:1};e.cardsList.push(c),a.$broadcast("ADDEDNEWPAYMENTTOGUEST",c)}"sixpayments"===a.paymentGateway&&e.isManual&&(e.authorizedCode=t.authorization_code),e.depositPaidSuccesFully=!0,a.$broadcast("UPDATE_DEPOSIT_BALANCE",t),a.$broadcast("UPDATERESERVATIONTYPE",t.reservation_type_id),a.$broadcast("UPDATE_DEPOSIT_BALANCE_FLAG",!1)};e.$on("AUTO_TRIGGER_EMAIL_AFTER_PAYMENT",function(t,a){e.guestCardData.contactInfo.email=a,e.sendAutomaticEmails(a),l.reload(l.$current.name)}),e.$on("PAYMENT_SUCCESS",function(e,t){v(t),f()}),e.$on("PAYMENT_FAILED",function(e,t){p(t),f()}),e.$on("SHOW_SWIPED_DATA_ON_DEPOSIT_BALANCE_SCREEN",function(t,a){e.$broadcast("RENDER_SWIPED_DATA",a)}),e.$on("PAYMENT_SCREEN_MODE_CHANGED",function(){f()})}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){sntRover.controller("RVEarlyCheckoutCtrl",["$rootScope","$scope","ngDialog",function(e,t,a){BaseCtrl.call(this,t),t.okButtonClicked=function(){t.saveData.isEarlyDepartureFlag=!0,t.callBackMethodCheckout&&t.callBackMethodCheckout(),a.close()}}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){sntRover.controller("RVKeyEmailPopupController",["$rootScope","$scope","ngDialog","RVKeyPopupSrv","$state","$filter",function(e,t,a,r,n,o){BaseCtrl.call(this,t),t.errorMessage="";var i=function(){var e="",a="";"checkin"===t.fromView?(e=t.reservationBillData.reservation_id,a=t.reservationBillData.reservation_status):(e=t.reservationData.reservation_card.reservation_id,a=t.reservationData.reservation_card.reservation_status);var n=function(e){t.$emit("hideLoader"),t.data={},t.data=e,t.errorMessage="","CHECKING_IN"===a?(t.data.reservationStatusText=o("translate")("KEY_CHECKIN_STATUS"),t.data.colorCodeClass="check-in",t.data.colorCodeClassForClose="green"):"CHECKEDIN"===a?(t.data.reservationStatusText=o("translate")("KEY_INHOUSE_STATUS"),t.data.colorCodeClass="inhouse",t.data.colorCodeClassForClose="blue"):"CHECKING_OUT"===a&&(t.data.reservationStatusText=o("translate")("KEY_CHECKOUT_STATUS"),t.data.colorCodeClass="check-out",t.data.colorCodeClassForClose="red")},i=function(e){t.$emit("hideLoader"),t.errorMessage=e};t.invokeApi(r.fetchKeyEmailData,{reservationId:e},n,i)};i(),t.goToStaycard=function(){t.closeDialog(),n.go("rover.reservation.staycard.reservationcard.reservationdetails",{id:t.reservationBillData.reservation_id,confirmationId:t.reservationBillData.confirm_no,isrefresh:!0})},t.goToSearch=function(){t.closeDialog(),n.go("rover.search")},t.closeDialog=function(){a.close()}}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){sntRover.controller("RVKeyEncodePopupCtrl",["$rootScope","$scope","$state","ngDialog","RVKeyPopupSrv","$filter","$timeout","$log","sntActivity","$window","rvUtilSrv",function(e,t,a,r,n,o,i,s,c,d,l){BaseCtrl.call(this,t);var u,m=this,f={isCheckingDeviceConnection:!1};this.setStatusAndMessage=function(e,a){t.statusMessage=e,t.status=a},e.$on("MAKE_KEY_TYPE",function(e,a){t.keyType=a.type}),t.init=function(){var e;t.$emit("HOLD_OBSERVE_FOR_SWIPE_RESETS"),$("#encoder-type").blur(),"checkin"===t.fromView?t.isRemoteEncodingEnabled=t.reservationBillData.is_remote_encoder_enabled:t.isRemoteEncodingEnabled=t.reservationData.reservation_card.is_remote_encoder_enabled,t.encoderSelected=sessionStorage.encoderSelected||"";var a="";t.data={},"checkin"===t.fromView?(a=t.reservationBillData.reservation_status,t.data.is_late_checkout=!1,t.data.confirmNumber=t.reservationBillData.confirm_no,t.data.roomNumber=t.reservationBillData.room_number,t.data.key_settings=t.reservationBillData.key_settings,t.data.reservation_id=t.reservationBillData.reservation_id):(a=t.reservationData.reservation_card.reservation_status,t.data.is_late_checkout=t.reservationData.reservation_card.is_opted_late_checkout,t.data.confirmNumber=t.reservationData.reservation_card.confirmation_num,t.data.roomNumber=t.reservationData.reservation_card.room_number,t.data.key_settings=t.reservationData.reservation_card.key_settings,t.data.room_pin=t.reservationData.room_pin,t.data.reservation_id=t.reservationData.reservation_card.reservation_id,t.data.room_pin_interface=t.reservationData.reservation_card.room_pin_interface),t.data.is_late_checkout&&(t.data.late_checkout_time=t.reservationData.reservation_card.late_checkout_time);var r=o("translate")("KEY_CONNECTED_STATUS");m.setStatusAndMessage(r,"success"),"CHECKING_IN"===a?(t.data.reservationStatusText=o("translate")("KEY_CHECKIN_STATUS"),t.data.colorCodeClass="check-in",t.data.colorCodeClassForClose="green"):"CHECKEDIN"===a?(t.data.reservationStatusText=o("translate")("KEY_INHOUSE_STATUS"),t.data.colorCodeClass="inhouse",t.data.colorCodeClassForClose="blue"):"CHECKING_OUT"===a&&(t.data.reservationStatusText=o("translate")("KEY_CHECKOUT_STATUS"),t.data.colorCodeClass="check-out",t.data.colorCodeClassForClose="red"),t.deviceConnecting=!1,t.showPrintKeyOptions=!1,t.deviceNotConnected=!1,t.keysPrinted=!1,t.pressedCancelStatus=!1,t.showTabletOption=!0,m.noOfErrorMethodCalled=0,m.MAX_SEC_FOR_DEVICE_CONNECTION_CHECK=1e4,t.numberOfKeysSelected=0,t.printedKeysCount=0,t.writingInProgress=!1,m.numOfKeys=0,m.printKeyStatus=[],m.isAdditional=!1,m.isSmartbandCreateWithKeyWrite=t.isSmartbandCreateWithKeyWrite,m.lastSuccessfulCardIDReaded="","New"===t.keyType?t.buttonText=o("translate")("KEY_PRINT_BUTTON_TEXT"):t.buttonText=o("translate")("KEY_DUPLICATE_BUTTON_TEXT"),t.isIpad="rv_native"===sntapp.browser&&sntapp.cordovaLoaded,e=!t.hotelDetails.disable_tablet_key_encoding&&t.isIpad,e&&t.isRemoteEncodingEnabled?(t.deviceConnecting=!0,m.setStatusAndMessage(o("translate")("CONNECTING_TO_KEY_CARD_READER"),"pending"),t.showDeviceConnectingMessge(),t.showPrintKeyOptions=!0,
t.encoderSelected=""):!e&&t.isRemoteEncodingEnabled?(t.showTabletOption=!1,g(!0)):t.showDeviceConnectingMessge()};var p=function(){var e='<div class="only-print" style="height: 320px;display: table;position: absolute;top:10px;padding: 20px;text-align: center;float: left;    width: 100%;"><h1 style="font-size: 48px;font-weight: 300;width: 100%;margin: 0 auto;text-overflow: ellipsis;overflow: hidden;white-space: nowrap;display: block;"><span >'+t.guestCardData.contactInfo.first_name+" "+t.guestCardData.contactInfo.last_name+"</span></br><span >Room: "+t.data.roomNumber+"</span></h1></br><span > Reservation "+t.data.confirmNumber+'</span></div><div class="only-print" style="height: 320px;display: table;position: absolute;bottom:100px;padding: 20px;text-align: center;float: left;    width: 100%;"> <span >Pin Code</span></br></br><span >Room Pin Code is</span></br><span style="font-size: 80px;font-weight: 700;letter-spacing: 10px;display: block;line-height: 80px;height: 80px;margin-top: 50px;margin-bottom: 40px;">'+t.data.room_pin+"</span></div>";return e};t.printPinCode=function(){$(".nav-bar").addClass("no-print"),$(".cards-header").addClass("no-print"),$(".card-tabs-nav").addClass("no-print");var e=document.createElement("div");e.innerHTML=p(),document.body.appendChild(e);var t=function(){i(function(){$(".nav-bar").removeClass("no-print"),$(".cards-header").removeClass("no-print"),$(".card-tabs-nav").removeClass("no-print"),document.body.removeChild(e)},100)};i(function(){sntapp.cordovaLoaded?cordova.exec(t,function(e){t()},"RVCardPlugin","printWebView",["","0","","L"]):(d.print(),t())},100)},t.isPrintKeyEnabled=function(){return 0!==t.numberOfKeysSelected&&(t.numberOfKeysSelected>0?!(t.isRemoteEncodingEnabled&&""===t.encoderSelected):void 0)},t.selectedEncoder=function(){sessionStorage.encoderSelected=t.encoderSelected};var v=function(){t.$emit("hideLoader");var e=0;f.isCheckingDeviceConnection=!1,m.noOfErrorMethodCalled++,e=1e3*m.noOfErrorMethodCalled,u=i(function(){if(e<=m.MAX_SEC_FOR_DEVICE_CONNECTION_CHECK){t.showDeviceConnectingMessge()}},1e3),e>m.MAX_SEC_FOR_DEVICE_CONNECTION_CHECK&&(t.encoderTypes=_.filter(t.encoderTypes,function(e){return"Tablet"!==e.description}),t.isRemoteEncodingEnabled?(t.showTabletOption=!1,m.setStatusAndMessage(o("translate")("ERROR_CONNECTING_TO_KEY_CARD_READER"),"error"),g(!0)):(t.deviceConnecting=!1,t.keysPrinted=!1,t.showPrintKeyOptions=!1,t.deviceNotConnected=!0),t.$$phase||t.$apply(),c.stop("CHECK_DEVICE_CONNECTION"))};t.tryAgainButtonPressed=function(){m.noOfErrorMethodCalled=0,t.showDeviceConnectingMessge()},t.showDeviceConnectingMessge=function(){t.deviceConnecting=!0,t.deviceNotConnected=!1,t.keysPrinted=!1,t.showPrintKeyOptions=t.isIpad&&t.isRemoteEncodingEnabled,f.isCheckingDeviceConnection=!0,i(function(){f.isCheckingDeviceConnection&&v()},2e3);var e={successCallBack:C,failureCallBack:v};if(sntapp.cardSwipeDebug)sntapp.cardReader.checkDeviceConnectedDebug(e);else try{c.start("CHECK_DEVICE_CONNECTION"),sntapp.cardReader.checkDeviceConnected(e)}catch(e){v(),c.stop("CHECK_DEVICE_CONNECTION")}},t.keySelected=function(e){m.numOfKeys=0,t.numberOfKeysSelected=t.numberOfKeysSelected===e?--t.numberOfKeysSelected:e,m.numOfKeys=t.numberOfKeysSelected,t.printedKeysCount=0,m.numOfKeys>0&&("New"===t.keyType?t.buttonText=o("translate")("KEY_PRINT_BUTTON_TEXT_KEY1"):t.buttonText=o("translate")("KEY_DUPLICATE_BUTTON_TEXT_KEY1"));var a={};m.printKeyStatus=[];for(var r=1;r<=t.numberOfKeysSelected;r++)a={},a.key="key"+r,a.printed=!1,a.fetched=!1,m.printKeyStatus.push(a)},t.clickedPrintKey=function(){if(0!==t.numberOfKeysSelected&&t.isPrintKeyEnabled())return"-1"===t.encoderSelected?(t.writingInProgress=!0,m.getCardInfo(),!1):t.isRemoteEncodingEnabled?(m.callKeyFetchAPI(),!1):(t.writingInProgress=!0,void m.getCardInfo())},m.getCardInfo=function(){m.setStatusAndMessage(o("translate")("KEY_READING_STATUS"),"pending"),t.$emit("showLoader");var e={successCallBack:m.callKeyFetchAPI,failureCallBack:m.showCardInfoFetchFailedMsg};sntapp.cardSwipeDebug?sntapp.cardReader.retrieveCardInfoDebug(e):(c.start("RETRIEVE_CARD_INFO"),sntapp.cardReader.retrieveCardInfo(e))},m.showCardInfoFetchFailedMsg=function(e){c.stop("RETRIEVE_CARD_INFO"),t.$apply();var a=o("translate")("KEY_UNABLE_TO_READ_STATUS")+e.RVErrorDesc;m.showKeyPrintFailure(a)},t.sendEmailWithPincode=function(){var e=function(){h()},a=function(){y()},r={reservation_id:t.data.reservation_id};t.callAPI(n.sendEmailWithPincode,{params:r,successCallBack:e,failureCallBack:a})},t.generatePinCode=function(){var e=function(e){t.data.room_pin=e.pin},a=function(e){t.errorMessage=e},r={confirmation_number:t.data.confirmNumber,interface:t.data.room_pin_interface};t.callAPI(n.generatePinCode,{params:r,successCallBack:e,failureCallBack:a})};var D=function(){r.open({template:"/assets/partials/popups/rvEmailSentStatusPopup.html",className:"",scope:t})},h=function(){t.statusMsg=o("translate")("EMAIL_SENT_SUCCESSFULLY"),t.status="success",D()},y=function(){t.statusMsg=o("translate")("EMAIL_SEND_FAILED"),t.status="alert",D()};this.callKeyFetchAPI=function(e){c.start("GET_KEY_IMAGE"),m.setStatusAndMessage(o("translate")("KEY_GETTING_KEY_IMAGE_STATUS"),"pending");var a={reservation_id:t.data.reservation_id,key:1,is_additional:!0};if(!m.isAdditional){m.isAdditional=!0;var a={reservation_id:t.data.reservation_id,key:1,is_additional:!1}}"undefined"!=typeof e?(a.card_info=e,m.lastSuccessfulCardIDReaded=e.card_uid):t.isRemoteEncodingEnabled&&(a.card_info="",a.key_encoder_id=t.encoderSelected),"Duplicate"===t.keyType&&(a.is_additional=!0),t.invokeApi(n.fetchKeyFromServer,a,m.keyFetchSuccess,m.keyFetchFailed),c.stop("RETRIEVE_CARD_INFO")},this.keyFetchSuccess=function(e){m.keyData=e,m.printKeys(),c.stop("GET_KEY_IMAGE")},this.keyFetchFailed=function(e){t.errorMessage=e;var a=o("translate")("KEY_CREATION_FAILED_STATUS");m.showKeyPrintFailure(a),c.stop("GET_KEY_IMAGE")},m.printKeys=function(){for(var e=-1,a=0;a<m.printKeyStatus.length;a++)if(m.printKeyStatus[a].printed===!1){e=a+1;break}return t.isRemoteEncodingEnabled&&"-1"!==t.encoderSelected?(m.numOfKeys--,m.printKeyStatus[e-1].printed=!0,t.printedKeysCount=e,t.buttonText="Print key "+(e+1)+"/"+m.printKeyStatus.length,0===m.numOfKeys&&(m.showKeyPrintSuccess(),!0)):void m.writeKey(m.keyData,e)},this.writeKey=function(e,a){var r=[];r.push(JSON.stringify(e)),t.$emit("showLoader"),m.setStatusAndMessage(o("translate")("KEY_WRITING_PROGRESS_STATUS"),"pending");var n={successCallBack:function(e){if(t.$emit("hideLoader"),m.setStatusAndMessage(o("translate")("KEY_CREATED_STATUS"),"success"),"true"===m.isSmartbandCreateWithKeyWrite&&""!==m.lastSuccessfulCardIDReaded){var e={};return e.first_name="",e.last_name="",e.is_fixed=!1,e.account_number=m.lastSuccessfulCardIDReaded,m.addNewSmartbandWithKey(e,a)}if(m.numOfKeys--,m.printKeyStatus[a-1].printed=!0,t.printedKeysCount=a,t.buttonText="Print key "+(a+1)+"/"+m.printKeyStatus.length,t.$apply(),c.stop("WRITE_KEY_CARD"),0===m.numOfKeys)return m.showKeyPrintSuccess(),!0},failureCallBack:function(e){if(m.numOfKeys>0)m.setStatusAndMessage(o("translate")("KEY_CREATION_FAILED_STATUS_LONG")+": "+e.RVErrorDesc,"error");else{var a=o("translate")("KEY_CREATION_FAILED_STATUS")+": "+e.RVErrorDesc;m.showKeyPrintFailure(a)}t.$apply(),c.stop("WRITE_KEY_CARD")},arguments:r};sntapp.cardSwipeDebug?sntapp.cardReader.writeKeyDataDebug(n):(c.start("WRITE_KEY_CARD"),sntapp.cardReader.writeKeyData(n))},this.writeBandType=function(e){m.setStatusAndMessage(o("translate")("WRITING_BAND_TYPE"),"pending");var a=e,r=e.index,n=[],i="00000002";a.is_fixed&&(i="00000001"),n.push(i),n.push(m.lastSuccessfulCardIDReaded),n.push("19");var s={successCallBack:function(e){return t.$emit("hideLoader"),m.numOfKeys--,0===m.numOfKeys?(t.$emit("hideLoader"),m.showKeyPrintSuccess(),!0):(m.setStatusAndMessage(o("translate")("KEY_BAND_CREATED_SUCCESSFULLY"),"success"),m.printKeyStatus[r-1].printed=!0,t.printedKeysCount=r,t.buttonText="Print key "+(r+1)+"/"+m.printKeyStatus.length,void t.$apply())},failureCallBack:function(e){if(t.$emit("hideLoader"),m.numOfKeys--,m.numOfKeys>0)m.setStatusAndMessage(o("translate")("KEY_BAND_CREATED_FAILED_WRITING_BANDTYPE")+": "+e.RVErrorDesc,"error"),m.printKeyStatus[r-1].printed=!0,t.printedKeysCount=r,t.buttonText="Print key "+(r+1)+"/"+m.printKeyStatus.length,t.$apply();else{var a=o("translate")("KEY_BAND_CREATED_FAILED_WRITING_BANDTYPE")+": "+e.RVErrorDesc;m.showKeyPrintFailure(a)}},arguments:n};sntapp.cardSwipeDebug?sntapp.cardReader.setBandTypeDebug(s):sntapp.cardReader.setBandType(s)},this.addNewSmartbandWithKey=function(e,a){var r=e.is_fixed;m.setStatusAndMessage(o("translate")("ADDING_BAND"),"pending");var i=function(e){m.setStatusAndMessage(o("translate")("BAND_ADDED"),"success"),t.$emit("showLoader");var n={};n.index=a,n.is_fixed=r,n.account_number=e.account_number,m.writeBandType(n)},s=function(e){if(m.setStatusAndMessage(o("translate")("KEY_CREATED_BAND_ADDING_FAILED")+": "+e,"error"),t.$emit("hideLoader"),m.numOfKeys--,m.numOfKeys>0)m.printKeyStatus[a-1].printed=!0,t.printedKeysCount=a,t.buttonText="Print key "+(a+1)+"/"+m.printKeyStatus.length,t.$apply();else{var r=o("translate")("KEY_CREATED_BAND_ADDING_FAILED")+": "+e;m.showKeyPrintFailure(r)}},c="";c=t.viewFromBillScreen?t.reservationBillData.reservation_id:t.reservationData.reservation_card.reservation_id,e.index=a,e.reservationId=c,t.invokeApi(n.addNewSmartBand,e,i,s)};var g=function(e){if(e===!1||0===e)return v();if(t.showTabletOption){var a=_.findWhere(t.encoderTypes,{description:"Tablet"});"undefined"==typeof a&&t.encoderTypes.push({id:"-1",description:"Tablet"}),t.encoderSelected="-1"}else t.encoderSelected=sessionStorage.encoderSelected||"";t.$emit("hideLoader"),t.deviceConnecting=!1,t.deviceNotConnected=!1,t.keysPrinted=!1,t.showPrintKeyOptions=!0,t.$$phase||t.$apply()},C=function(e){f.isCheckingDeviceConnection=!1,e&&m.setStatusAndMessage(o("translate")("KEY_CONNECTED_STATUS"),"success"),g(e),c.stop("CHECK_DEVICE_CONNECTION")},A=function(){t.$emit("hideLoader"),t.deviceConnecting=!1,t.keysPrinted=!0,t.showPrintKeyOptions=!1,t.deviceNotConnected=!1,t.$$phase||t.$apply()};t.init(),t.pressedCancel=function(e){t.$emit("hideLoader"),t.printKeyFailMsg=o("translate")("KEY_NOT_PRINTED"),void 0!==e&&(t.printKeyFailMsg=e),t.deviceConnecting=!1,t.keysPrinted=!1,t.showPrintKeyOptions=!1,t.deviceNotConnected=!1,t.pressedCancelStatus=!0,i.cancel(u),$("#encoder-type").blur()},this.showKeyPrintSuccess=function(){A()},this.showKeyPrintFailure=function(e){if(t.$emit("hideLoader"),"undefined"==typeof e)var e=o("translate")("KEY_CREATION_FAILED_STATUS");t.pressedCancel(e),t.$$phase||t.$apply()},t.closeDialog=function(){"checkin"===t.fromView&&"pin"===t.data.key_settings?t.goToStaycard():"checkin"===t.fromView?t.pressedCancel():(t.$emit("RESUME_OBSERVE_FOR_SWIPE_RESETS"),r.close())},t.goToStaycard=function(){t.fromView="",t.closeDialog(),a.go("rover.reservation.staycard.reservationcard.reservationdetails",{id:t.reservationBillData.reservation_id,confirmationId:t.reservationBillData.confirm_no,isrefresh:!0})},t.goToSearch=function(){t.fromView="",t.closeDialog(),a.go("rover.search")};var S=t.guestCardData.contactInfo.email?t.guestCardData.contactInfo.email:"";t.hasValidEmail=l.isEmailValid(S)}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){sntRover.controller("RVKeyQRCodePopupController",["$rootScope","$scope","$state","ngDialog","RVKeyPopupSrv","$filter",function(e,t,a,r,n,o){BaseCtrl.call(this,t);var i=function(){var e="";e="checkin"===t.fromView?t.reservationBillData.reservation_status:t.reservationData.reservation_card.reservation_status,"CHECKING_IN"===e?(t.data.reservationStatusText=o("translate")("KEY_CHECKIN_STATUS"),t.data.colorCodeClass="check-in",t.data.colorCodeClassForClose="green"):"CHECKEDIN"===e?(t.data.reservationStatusText=o("translate")("KEY_INHOUSE_STATUS"),t.data.colorCodeClass="inhouse",t.data.colorCodeClassForClose="blue"):"CHECKING_OUT"===e&&(t.data.reservationStatusText=o("translate")("KEY_CHECKOUT_STATUS"),t.data.colorCodeClass="check-out",t.data.colorCodeClassForClose="red")};i(),t.goToStaycard=function(){t.closeDialog(),a.go("rover.reservation.staycard.reservationcard.reservationdetails",{id:t.reservationBillData.reservation_id,confirmationId:t.reservationBillData.confirm_no,isrefresh:!0})},t.goToSearch=function(){t.closeDialog(),a.go("rover.search")},t.closeDialog=function(){r.close()}}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){sntRover.controller("RVLikesController",["$scope","RVLikesSrv","RVGuestCardsSrv","dateFilter","$stateParams",function(e,t,a,r,n){e.errorMessage="",e.guestCardData.likes={},e.guestLikesData={},e.setScroller("likes_info"),e.calculatedHeight=274;var o={},i={},s=!1;e.$on("clearNotifications",function(){e.errorMessage="",e.successMessage=""}),e.init=function(){BaseCtrl.call(this,e);var a=function(t){e.$emit("hideLoader"),e.errorMessage=t},r={userId:e.guestCardData.contactInfo.user_id,isRefresh:n.isrefresh||!0};e.guestCardData.contactInfo&&e.guestCardData.contactInfo.user_id&&e.invokeApi(t.fetchLikes,r,e.fetchLikesSuccessCallback,a,"NONE")},e.fetchLikesSuccessCallback=function(t){e.$emit("hideLoader"),e.guestLikesData=t;var a,r,n,o,i,s,c;for(a=0,r=e.guestLikesData.preferences.length;a<r;a++)for(i=e.guestLikesData.preferences[a],s=i.values,"dropdown"!=i.type&&"radio"!=i.type||(e.guestLikesData.user_preference.length?(c=_.find(s,function(t){return _.contains(e.guestLikesData.user_preference,t.id)}),c?i.isChecked=c.id:i.isChecked=""):i.isChecked=""),n=0,o=s.length;n<o;n++)s[n].isChecked=!1,_.contains(e.guestLikesData.user_preference,s[n].id)&&(s[n].isChecked=!0);var d=0;angular.forEach(e.guestLikesData.room_features,function(t,a){angular.forEach(t.values,function(a,r){d++,d>6&&e.guestLikesData.preferences.length<=2&&(e.calculatedHeight+=50);var n=t.user_selection;n.indexOf(a.id)!==-1?a.isSelected=!0:a.isSelected=!1})}),e.guestCardData.likes=e.guestLikesData,setTimeout(function(){e.refreshScroller("likes_info")},1e3)},e.$on("SHOWGUESTLIKESINFO",function(){e.init()}),e.$on("REFRESHLIKESSCROLL",function(){e.refreshScroller("likes_info")}),e.$on("$viewContentLoaded",function(){e.refreshScroller("likes_info")});var c=function(){var t;return e.reservationData&&e.reservationData.guest&&e.reservationData.guest.id?t=e.reservationData.guest.id:e.guestCardData&&e.guestCardData.contactInfo&&e.guestCardData.contactInfo.user_id&&(t=e.guestCardData.contactInfo.user_id),t};e.saveLikes=function(r){var n=function(t){e.$emit("hideLoader")},s=function(t){e.$emit("hideLoader"),e.errorMessage=t,e.$emit("likesInfoError",!0)};o=JSON.parse(JSON.stringify(i)),i.guest_id=e.guestCardData.contactInfo.guest_id,i.preference=[],angular.forEach(e.guestLikesData.newspapers,function(t,a){var r={};t.id===e.guestLikesData.user_newspaper&&(r.type="NEWSPAPER",r.value=t.name,i.preference.push(r))}),angular.forEach(e.guestLikesData.roomtype,function(t,a){var r={};t.id===e.guestLikesData.user_roomtype&&(r.type="ROOM TYPE",r.value=t.name,i.preference.push(r))}),angular.forEach(e.guestLikesData.room_features,function(e,t){angular.forEach(e.values,function(e,t){var a={};e.isSelected&&(a.type="ROOM FEATURE",a.value=e.details,i.preference.push(a))})}),angular.forEach(e.guestLikesData.preferences,function(e,t){angular.forEach(e.values,function(t,a){t.isChecked&&i.preference.push({type:e.name,value:t.details})})});var d=JSON.parse(JSON.stringify(i)),l=!!angular.equals(d,o),u=c(),m=!(!r||!r.isFromGuestCardSection)||a.isGuestFetchComplete(u),f={userId:u,data:i};u&&m&&!l&&e.invokeApi(t.saveLikes,f,n,s)};var d=e.$on("SAVELIKES",function(t,a){e.saveLikes(a)});e.$on("$destroy",d),e.changedCheckboxPreference=function(t,a){angular.forEach(e.guestLikesData.preferences[t].values,function(e,t){t!==a&&(e.isChecked=!1)})},e.changedRadioComboPreference=function(t){_.each(e.guestLikesData.preferences[t].values,function(a){a.id===e.guestLikesData.preferences[t].isChecked?(a.isChecked=!a.isChecked,a.isChecked||(e.guestCardData.likes.preferences[t].isChecked="")):a.isChecked=!1})},e.getHalfArray=function(e){var t=new Array(Math.ceil(e.length/2));return t},e.showLabel=function(e){var t=!0;return""!==e&&void 0!==e||(t=!1),t},e.getHalfArrayPref=function(e){var t=new Array(Math.ceil(e.length/2));return t},e.shouldShowRoomFeatures=function(e){var t=!1;return angular.forEach(e,function(e,a){e.values.length>0&&(t=!0)}),t};var l=e.$on("GUESTLIKETABACTIVE",function(){s||(s=!0,e.init())});e.$on("$destroy",l),e.hasRoomFeatures=function(){var t=!1;return _.each(e.guestLikesData.room_features,function(e,a){_.each(e.values,function(e,a){e.isSelected&&(t=!0)})}),t},e.init()}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){sntRover.controller("RVBillPayCtrl",["$scope","RVBillPaymentSrv","RVPaymentSrv","RVGuestCardSrv","RVReservationCardSrv","ngDialog","$rootScope","$timeout","$filter","rvPermissionSrv",function(e,t,a,r,n,o,i,s,c,d){BaseCtrl.call(this,e);var l=function(){e.renderData={},e.saveData={},e.errorMessage="",e.saveData.payment_type_id="",e.cardsList=[],e.newPaymentInfo={},e.newPaymentInfo.addToGuestCard=!1,e.renderData.billNumberSelected="",e.renderData.defaultPaymentAmount="",e.renderData.defaultPaymentCurrencyAmount="",e.copyOfdefaultPaymentAmount="",e.defaultRefundAmount=0,e.currentActiveBillNumber=parseInt(e.currentActiveBill)+parseInt(1),e.renderData.billNumberSelected=e.currentActiveBillNumber,e.billsArray=e.reservationBillData.bills,e.passData={},e.passData.details={},e.passData.details.firstName=e.guestCardData.contactInfo.first_name,e.passData.details.lastName=e.guestCardData.contactInfo.last_name,e.setScroller("cardsList",{click:!0,tap:!0}),e.showCancelCardSelection=!0,e.renderData.referanceText="",e.swipedCardDataToSave={},e.cardData={},e.newCardAdded=!1,e.shouldShowWaiting=!1,e.depositPaidSuccesFully=!1,e.saveData.paymentType="",e.defaultPaymentTypeOfBill="",e.shouldShowMakePaymentButton=!0,e.splitSelected=!1,e.disableMakePaymentButton=!1,e.splitBillEnabled=!1,e.showDBconfirmation=!1,e.billPaymentReceiptData={},e.billPaymentReceiptData.allBillReceiptsList={},e.shouldDisableSplit=!1},u=0,m=function(){s(function(){e.refreshScroller("cardsList")},2e3)};e.feeData={};var f=parseFloat("0.00");e.isShowFees=function(){var t=!1,a=e.feeData;return"undefined"==typeof a||"undefined"==typeof a.feesInfo||null===a.feesInfo?t=!1:a.defaultAmount>=a.minFees&&e.isStandAlone&&a.feesInfo.amount&&e.renderData.defaultPaymentAmount>=0&&(t=!("sixpayments"===i.paymentGateway&&!e.isManual&&"CC"===e.saveData.paymentType||""===e.saveData.paymentType)),t},e.handleCloseDialog=function(){e.reservationBillData.isCheckout=!1,e.paymentModalOpened=!1,e.$emit("HANDLE_MODAL_OPENED"),e.closeDialog()},e.$on("CLOSE_DIALOG",e.handleCloseDialog),e.showGuestCreditCardList=function(){e.showCCPage=!0,e.swippedCard=!0,m()},e.changeOnsiteCallIn=function(){e.isManual?e.showGuestCreditCardList():"",m()},e.$on("changeOnsiteCallIn",function(t){e.isManual=!e.isManual,e.changeOnsiteCallIn()}),e.getPaymentListSuccess=function(t){e.$emit("hideLoader"),e.renderData.paymentTypes=t,e.renderData.billNumberSelected=e.currentActiveBillNumber,e.renderDefaultValues(),e.creditCardTypes=[],angular.forEach(e.renderData.paymentTypes,function(t,a){"CC"===t.name&&(e.creditCardTypes=t.values)}),e.shouldDisableSplit=e.renderData.defaultPaymentAmount<0},e.cardsListSuccess=function(t){e.$emit("hideLoader"),0===t.length?e.cardsList=[]:(e.cardsList=[],angular.forEach(t.existing_payments,function(t,a){t.is_credit_card&&e.cardsList.push(t)}),angular.forEach(e.cardsList,function(e,t){e.mli_token=e.ending_with,e.card_expiry=e.expiry_date,delete e.ending_with,delete e.expiry_date}),e.addmode=!(e.cardsList.length>0),angular.forEach(e.cardsList,function(t,a){t.isSelected=!1,isEmptyObject(e.billsArray[e.currentActiveBill].credit_card_details)||e.billsArray[e.currentActiveBill].credit_card_details.payment_type&&"CC"===e.billsArray[e.currentActiveBill].credit_card_details.payment_type.toUpperCase()&&e.billsArray[e.currentActiveBill].credit_card_details.card_number===t.mli_token&&e.billsArray[e.currentActiveBill].credit_card_details.card_code.toLowerCase()===t.card_code.toLowerCase()&&(t.isSelected=!0)}),m())},e.resetSplitPaymentDetailForGiftCard=function(){e.splitBillEnabled=!1,e.splitePaymentDetail={totalNoOfsplits:1,completedSplitPayments:0,totalAmount:0,splitAmount:0,carryAmount:0},e.messageOfSuccessSplitPayment="",e.paymentErrorMessage="",e.splitBillEnabled||(e.renderData.defaultPaymentAmount=angular.copy(u),e.splitSelected=!1)};var p=function(){var t=e.billsArray[e.currentActiveBill].total_fees,a=f;a=t.length<=0?f:"SR"===t[0].balance_amount?t[0].masked_balance_amount:t[0].balance_amount;var r=parseFloat(a).toFixed(2),n=t[0].default_payment_amount;e.renderData.defaultPaymentAmount=r,e.renderData.defaultPaymentCurrencyAmount=n,e.copyOfdefaultPaymentAmount=r,e.splitePaymentDetail.totalAmount=r,e.defaultRefundAmount=-1*parseFloat(e.renderData.defaultPaymentAmount)};e.resetSplitPaymentDetail=function(){e.splitBillEnabled="undefined"!=typeof e.splitBillEnabled&&!e.splitBillEnabled,e.splitePaymentDetail={totalNoOfsplits:1,completedSplitPayments:0,totalAmount:0,splitAmount:0,carryAmount:0},e.messageOfSuccessSplitPayment="",e.paymentErrorMessage="",e.splitBillEnabled||(e.billsArray&&p(),e.renderData.defaultPaymentAmount=angular.copy(e.copyOfdefaultPaymentAmount),e.splitSelected=!1)},e.hasPermissionToDirectBillPayment=function(){return d.getPermissionValue("DIRECT_BILL_PAYMENT")},e.getReceiptsListSuccess=function(t){e.billPaymentReceiptData.allBillReceiptsList=t.data,e.billPaymentReceiptData.receiptsList=_.find(e.billPaymentReceiptData.allBillReceiptsList.payment_receipts,{bill_number:e.billsArray[e.currentActiveBill].bill_number})},e.init=function(){e.resetSplitPaymentDetail(),"undefined"==typeof e.reservationData.reservationId&&(e.reservationData.reservationId=e.reservationData.reservation_id),l(),e.referenceTextAvailable=!1,e.showInitalPaymentScreen=!0;var t={reservation_id:e.reservationData.reservationId,is_checkout:e.reservationBillData.isCheckout},r=e.reservationBillData.isCheckout?t:{};if(e.billsArray[e.currentActiveBill].is_account_attached&&e.billsArray[e.currentActiveBill].allow_db_refund&&e.hasPermissionToDirectBillPayment()?r.direct_bill=!0:r.direct_bill=!1,r.bill_id=e.billsArray[e.currentActiveBill].bill_id,e.invokeApi(a.renderPaymentScreen,r,e.getPaymentListSuccess),e.invokeApi(a.getPaymentList,e.reservationData.reservationId,e.cardsListSuccess),"tax_payment_receipt"===i.selectedReceiptTypeValue){var n={bill_holder_id:e.reservationData.reservationId,bill_holder_type:"Reservation"};e.invokeApi(a.getReceiptsList,n,e.getReceiptsListSuccess)}e.disableRefund=e.billPaymentReceiptData.receiptsList&&e.billPaymentReceiptData.receiptsList.length>0&&!e.payment.receipt_id},e.init(),e.renderDefaultValues=function(){var t=!1;e.renderData.paymentTypes.length>0&&(isEmptyObject(e.billsArray[e.currentActiveBill].credit_card_details)||(e.defaultPaymentTypeOfBill=e.billsArray[e.currentActiveBill].credit_card_details.payment_type.toUpperCase(),e.saveData.payment_type_id=e.billsArray[e.currentActiveBill].credit_card_details.payment_id,angular.forEach(e.renderData.paymentTypes,function(e,a){"CC"===e.name&&(t=!0)}),e.saveData.paymentType=e.defaultPaymentTypeOfBill,"CC"===e.defaultPaymentTypeOfBill&&(t||(e.saveData.paymentType=""),e.isExistPaymentType=!0,e.showCreditCardInfo=!0,e.isfromBill=!0,e.defaultPaymentTypeCard=e.billsArray[e.currentActiveBill].credit_card_details.card_code.toLowerCase(),e.defaultPaymentTypeCardNumberEndingWith=e.billsArray[e.currentActiveBill].credit_card_details.card_number,e.defaultPaymentTypeCardExpiry=e.billsArray[e.currentActiveBill].credit_card_details.card_expiry,"sixpayments"===i.paymentGateway&&(e.isManual=!0)))),p(),e.renderData.defaultPaymentAmount<0&&(e.shouldShowMakePaymentButton=!1),e.isStandAlone&&(e.feeData.feesInfo=e.billsArray[e.currentActiveBill].credit_card_details.fees_information)},e.billNumberChanged=function(){e.currentActiveBill=parseInt(e.renderData.billNumberSelected)-parseInt(1),e.billPaymentReceiptData.receiptsList=_.find(e.billPaymentReceiptData.allBillReceiptsList.payment_receipts,{bill_number:e.billsArray[e.currentActiveBill].bill_number}),e.renderDefaultValues()},e.$on("AMOUNT_UPDATED",function(t,a){e.shouldDisableSplit=a<0}),e.spliteButtonClicked=function(t){e.splitePaymentDetail.totalNoOfsplits=t,e.splitSelected||(e.splitSelected=!0,u=angular.copy(e.renderData.defaultPaymentAmount)),v()};var v=function(){e.splitePaymentDetail.splitAmount=parseFloat(c("number")(u/e.splitePaymentDetail.totalNoOfsplits,2).replace(/,/g,"")),e.splitePaymentDetail.carryAmount=parseFloat(c("number")(u-e.splitePaymentDetail.splitAmount*e.splitePaymentDetail.totalNoOfsplits,2)),e.renderData.defaultPaymentAmount=(parseFloat(e.splitePaymentDetail.splitAmount)+parseFloat(e.splitePaymentDetail.carryAmount)).toFixed(2)},D=function(){e.splitePaymentDetail.completedSplitPayments+=1,e.splitePaymentDetail.completedSplitPayments===e.splitePaymentDetail.totalNoOfsplits&&(e.depositPaidSuccesFully=!0)};e.classForPaymentSplitButton=function(t){return 1===t&&0===e.splitePaymentDetail.completedSplitPayments?"checked":t<=e.splitePaymentDetail.completedSplitPayments?"paid":t<=e.splitePaymentDetail.totalNoOfsplits?"checked":"disabled"};var h=function(){e.messageOfSuccessSplitPayment=e.messageOfSuccessSplitPayment+"SPLIT # "+e.splitePaymentDetail.completedSplitPayments+" OF "+c("number")(e.renderData.defaultPaymentAmount.toString().replace(/,/g,""),2)+" PAID SUCCESSFULLY !<br/>",e.clearPaymentErrorMessage()},y=function(){e.renderData.defaultPaymentAmount=c("number")(e.splitePaymentDetail.splitAmount,2)},g={},C=function(){if(g.billNumber=e.renderData.billNumberSelected,e.$emit("BILL_PAYMENT_SUCCESS",g),D(),h(),y(),e.newPaymentInfo.addToGuestCard){var t=e.defaultPaymentTypeCard,a=e.defaultPaymentTypeCardNumberEndingWith,r={card_code:t,mli_token:a,card_expiry:e.defaultPaymentTypeCardExpiry,card_name:e.newPaymentInfo.cardDetails.userName,id:g.id,isSelected:!0,is_primary:!1,payment_type:"CC",payment_type_id:1};e.cardsList.push(r),i.$broadcast("ADDEDNEWPAYMENTTOGUEST",r)}},A=function(t,a){e.errorMessage="",e.authorizedCode=a.authorization_code,g=a,e.paymentDetails={paymentSuccess:!0,authorizationCode:a.authorizationCode||a.authorization_code,amount:a.amountPaid,feePaid:parseFloat(a.feePaid),showFee:a.showFee,selectedPaymentType:a.selectedPaymentType,amountWithoutFee:parseFloat(a.amountPaid)-parseFloat(a.feePaid)},C()},S=function(t,a){e.disableMakePaymentButton=!1,e.$emit("hideLoader"),e.splitBillEnabled?e.paymentErrorMessage="SPLIT # "+(e.splitePaymentDetail.completedSplitPayments+1)+" PAYMENT OF "+e.renderData.defaultPaymentAmount+" FAILED !<br/>":e.errorMessage=a};e.clearPaymentErrorMessage=function(){e.paymentErrorMessage=""},e.$on("SWIPED_DATA_TO_SAVE",function(t,r){e.swipedCardDataToSave=r;var n=r;n.reservation_id=e.reservationData.reservationId,n.payment_credit_type=r.cardType,n.credit_card=r.cardType,n.card_expiry="20"+r.cardExpiryYear+"-"+r.cardExpiryMonth+"-01",e.invokeApi(a.savePaymentDetails,n,successNewPayment)}),e.setCreditCardFromList=function(t){e.isExistPaymentType=!0,e.showCreditCardInfo=!0,e.defaultPaymentTypeCard=e.cardsList[t].card_code.toLowerCase(),e.defaultPaymentTypeCardNumberEndingWith=e.cardsList[t].mli_token,e.defaultPaymentTypeCardExpiry=e.cardsList[t].card_expiry,angular.forEach(e.cardsList,function(e,t){e.isSelected=!1}),e.cardsList[t].isSelected=!0,e.saveData.payment_type_id=e.cardsList[t].value,e.swippedCard=!1,e.showCCPage=!1,e.isStandAlone&&(e.feeData.feesInfo=e.cardsList[t].fees_information,e.setupFeeData()),e.newCardAdded=!1},e.$on("cardSelected",function(t,a){e.setCreditCardFromList(a.index)}),e.$on("TOKEN_CREATED",function(t,a){e.showGuestAddCard=!0,e.newPaymentInfo=a,e.showCCPage=!1,e.swippedCard=!1,setTimeout(function(){savePayment(a)},200)}),e.$on("MLI_ERROR",function(t,a){e.errorMessage=a}),e.$on("cancelCardSelection",function(t,a){e.showCCPage=!1,e.swippedCard=!1,e.isManual=!1,e.saveData.paymentType=""}),e.$on("SHOW_SWIPED_DATA_ON_PAY_SCREEN",function(t,a){e.showCCPage=!0,e.swippedCard=!0,e.addmode=!0,e.$broadcast("RENDER_SWIPED_DATA",a)});var I=e.$on("PAYMENT_SUCCESS",A),T=e.$on("PAYMENT_FAILED",S),E=function(){_.each(e.reservationBillData.bills,function(e){var t=e.credit_card_details;e.selectedCC={card_code:t.card_code,ending_with:t.card_number,expiry_date:t.card_expiry,fees_information:t.fees_information,holder_name:t.card_name,is_credit_card:"CC"===t.payment_type,value:t.payment_id,auth_code:t.auth_code}})},R=function(){e.splitBillEnabled=!1,e.splitePaymentDetail={totalNoOfsplits:1,completedSplitPayments:0,totalAmount:0,splitAmount:0,carryAmount:0},e.messageOfSuccessSplitPayment="",e.paymentErrorMessage="",e.renderData.defaultPaymentAmount=0,e.splitSelected=!1},b=function(){e.splitBillEnabled=!1,e.splitePaymentDetail={totalNoOfsplits:1,completedSplitPayments:0,totalAmount:0,splitAmount:0,carryAmount:0},e.messageOfSuccessSplitPayment="",e.paymentErrorMessage="",e.splitSelected=!1};e.$on("PAYMENT_TYPE_CHANGED",function(t,a){e.showCCPage="CC"===a,"GIFT_CARD"===a?R():"DB"===a&&b()}),e.$on("HIDE_BILL_PAYMENT_POPUP",function(){e.showDBconfirmation=!0}),e.$on("SHOW_BILL_PAYMENT_POPUP",function(){e.showDBconfirmation=!1}),e.$watch("reservationBillData.bills",E),e.$on("$destroy",T),e.$on("$destroy",I)}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){sntRover.controller("RVAccountReceivableMessagePopupCtrl",["$rootScope","$scope","$state","ngDialog","$timeout","RVCompanyCardSrv","rvPermissionSrv",function(e,t,a,r,n,o,i){BaseCtrl.call(this,t),t.isCreateNewARAccountMode=!1,t.data={},t.isCreateButtonDisabled=!1,t.createAccountAction=function(){if("undefined"!=typeof t.reservationBillData&&"true"===t.reservationBillData.is_auto_assign_ar_numbers||"undefined"!=typeof t.is_auto_assign_ar_numbers&&t.is_auto_assign_ar_numbers){var e=!0;t.createAccountReceivable(e)}else t.isCreateNewARAccountMode=!0},t.successCreate=function(a){"undefined"!=typeof t.reservationBillData&&(t.reservationBillData.ar_number=a.ar_number,t.reservationBillData.bills[t.currentActiveBill].ar_number=a.ar_number,t.reservationBillData.bills[t.currentActiveBill].has_ar_account=!0),
r.close(),n(function(){e.$emit("arAccountCreated")},500)},t.failureCreate=function(e){t.$emit("hideLoader"),t.errorMessage=e,t.isCreateButtonDisabled=!1,"Please complete required AR Account Information"===t.errorMessage[0]&&(t.isCreateButtonDisabled=!0)},t.createAccountReceivable=function(e){var a={id:t.reservationBillData.bills[t.currentActiveBill].account_id,ar_number:e?"":t.data.ar_number};t.invokeApi(o.saveARDetails,a,t.successCreate,t.failureCreate)},t.closeDialog=function(){r.close()},t.cancelButtonClick=function(){t.errorMessage="",t.isCreateNewARAccountMode=!1},t.hasPermissionToCreateArAccount=function(){return i.getPermissionValue("CREATE_AR_ACCOUNT")}}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){sntRover.controller("RVAddPaymentMethodCrtl",["$scope","$rootScope",function(e,t){}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){sntRover.controller("RVPaymentCompanyCardCtrl",["$rootScope","$scope","$state","RVPaymentSrv","RVCompanyCardSrv","ngDialog",function(e,t,a,r,n,o){BaseCtrl.call(this,t),t.$on("clearNotifications",function(){t.errorMessage="",t.successMessage=""});var i={data:[],paymentTypes:[]};t.paymentData=i,t.updateErrorMessage=function(e){t.errorMessage=e},t.openAddNewPaymentModel=function(){t.callAPI(r.renderPaymentScreen,{params:{direct_bill:!1},onSuccess:function(e){var a=_.find(e,function(e){return"CC"===e.name}),r={fromView:"companyTravelAgent",isFromWallet:!0,accountId:t.contactInformation.id,details:{}},n=t.paymentData;n.paymentTypes=[a],t.openPaymentDialogModal(r,n)}})},t.fetchAttachedPaymentTypes=function(){var e=function(e){t.paymentData=e,t.$parent.$emit("hideLoader")},a=function(e){t.$parent.$emit("hideLoader"),t.$emit("displayErrorMessage",e)};t.invokeApi(n.fetchCompanyPaymentData,t.contactInformation.id,e,a)},t.addListener("wallet",function(){t.fetchAttachedPaymentTypes()}),t.openDeleteSetAsPrimaryModal=function(e,a){t.paymentData.payment_id=e,t.paymentData.index=a,t.paymentData.accountId=t.contactInformation.id,t.paymentData.isFromWallet=!0,o.open({template:"/assets/partials/payment/rvDeleteSetAsPrimary.html",controller:"RVDeleteSetAsPrimaryCtrl",scope:t})},t.$on("ADDEDNEWPAYMENTTOCOTA",function(e,a){"undefined"==typeof t.paymentData.data&&(t.paymentData.data=[]),_.find(t.paymentData.data,{id:a.id})||t.paymentData.data.push(a),t.refreshScroller("paymentList")}),function(){var e={preventDefault:!1};t.setScroller("paymentList",e),t.$on("$viewContentLoaded",function(){t.refreshScroller("paymentList")}),t.$on("REFRESHLIKESSCROLL",function(){t.refreshScroller("paymentList")})}()}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){sntRover.controller("RVCreateAccountReceivableCtrl",["$rootScope","$scope","$state","RVCompanyCardSrv","ngDialog",function(e,t,a,r,n){BaseCtrl.call(this,t),t.ar_number="",t.createAccountReceivable=function(){var e={id:t.account_id,ar_number:t.ar_number};t.invokeApi(r.saveARDetails,e,t.successCreate,t.failureCreate)},t.closeDialog=function(){n.close()}}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){sntRover.controller("RVDeleteSetAsPrimaryCtrl",["$rootScope","$scope","$state","RVPaymentSrv","RVCompanyCardSrv","ngDialog",function(e,t,a,r,n,o){BaseCtrl.call(this,t),t.successSetAsPrimary=function(){angular.forEach(t.paymentData.data,function(e,t){e.is_primary=!1}),t.paymentData.data[t.paymentData.index].is_primary=!0,t.refreshScroller("paymentList"),t.$emit("hideLoader"),o.close()},t.successDelete=function(){t.paymentData.data.splice(t.paymentData.index,1),t.$emit("hideLoader"),o.close()},t.failureCallBack=function(e){t.$emit("hideLoader"),t.updateErrorMessage(e),t.refreshScroller("paymentList"),t.closeDialog()},t.setAsPrimary=function(){if(t.paymentData.isFromWallet){var e={associated_payment_method_id:t.paymentData.payment_id,account_id:t.paymentData.accountId};t.invokeApi(n.setAsPrimary,e,t.successSetAsPrimary,t.failureCallBack)}else{var e={id:t.paymentData.payment_id,user_id:t.paymentData.user_id};t.invokeApi(r.setAsPrimary,e,t.successSetAsPrimary,t.failureCallBack)}},t.deletePayment=function(){if(t.paymentData.isFromWallet){var e={associated_payment_method_id:t.paymentData.payment_id,account_id:t.paymentData.accountId};t.invokeApi(n.deletePayment,e,t.successDelete,t.failureCallBack)}else{var e={id:t.paymentData.payment_id};t.invokeApi(r.deletePayment,e,t.successDelete,t.failureCallBack)}}}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){sntRover.controller("RVPaymentGuestCtrl",["$rootScope","$scope","$state","RVPaymentSrv","ngDialog",function(e,t,a,r,n){BaseCtrl.call(this,t),t.$on("clearNotifications",function(){t.errorMessage="",t.successMessage=""}),t.updateErrorMessage=function(e){t.errorMessage=e},t.openAddNewPaymentModel=function(){t.callAPI(r.renderPaymentScreen,{params:{direct_bill:!1},onSuccess:function(e){var a=_.find(e,function(e){return"CC"===e.name}),r={guest_id:t.guestCardData.contactInfo.user_id,isFromGuestCard:!0,details:{firstName:t.guestCardData.contactInfo.first_name,lastName:t.guestCardData.contactInfo.last_name}},n=t.paymentData;n.paymentTypes=[a],t.openPaymentDialogModal(r,n)}})},t.openDeleteSetAsPrimaryModal=function(e,a){t.paymentData.payment_id=e,t.paymentData.index=a,n.open({template:"/assets/partials/payment/rvDeleteSetAsPrimary.html",controller:"RVDeleteSetAsPrimaryCtrl",scope:t})},t.$on("ADDEDNEWPAYMENTTOGUEST",function(e,a){"undefined"==typeof t.paymentData.data&&(t.paymentData.data=[]),_.find(t.paymentData.data,{id:a.id})||t.paymentData.data.push(a),t.refreshScroller("paymentList")}),function(){var e={preventDefault:!1};t.setScroller("paymentList",e),t.$on("$viewContentLoaded",function(){t.refreshScroller("paymentList")}),t.$on("REFRESHLIKESSCROLL",function(){t.refreshScroller("paymentList")})}()}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){sntRover.controller("RVShowPaymentListCtrl",["$rootScope","$scope","$state","RVPaymentSrv","ngDialog","rvPermissionSrv",function(e,t,a,r,n,o){BaseCtrl.call(this,t),t.showNoValues=!1;var i=o.getPermissionValue("REMOVE_CREDIT_CARD_FROM_STAYCARD");t.paymentListSuccess=function(e){t.$emit("hideLoader"),t.paymentListData=e,angular.forEach(t.paymentListData.existing_payments,function(e,a){if(!e.is_credit_card)return void t.paymentListData.existing_payments.splice(a,1)}),t.paymentListLength=t.paymentListData.existing_payments.length,0===t.paymentListLength&&(t.showNoValues=!0)};var s="",c=1;"billCard"===t.dataToPaymentList.currentView?(s=t.dataToPaymentList.reservation_id,c=t.dataToPaymentList.bills[t.dataToPaymentList.currentActiveBill].bill_number):s=t.dataToPaymentList.reservation_card.reservation_id;var d={reservation_id:s,bill_number:c};t.invokeApi(r.getExistingPaymentsForBill,d,t.paymentListSuccess),t.clickPaymentItem=function(a,o,i,c,d,l){var u={reservation_id:s,user_payment_type_id:a};"billCard"===t.dataToPaymentList.currentView&&(u.bill_number=t.dataToPaymentList.bills[t.dataToPaymentList.currentActiveBill].bill_number);var m=function(e){t.$emit("hideLoader"),t.errorMessage=e},f=function(a){var r;t.$emit("hideLoader"),e.$emit("UPDATECCATTACHEDBILLSTATUS",a.has_any_credit_card_attached_bill),n.close(),"billCard"===t.dataToPaymentList.currentView?(r=t.dataToPaymentList.currentActiveBill,t.dataToPaymentList.bills[r].credit_card_details.card_code=o.toLowerCase(),t.dataToPaymentList.bills[r].credit_card_details.card_number=i,t.dataToPaymentList.bills[r].credit_card_details.card_expiry=c,t.dataToPaymentList.bills[r].credit_card_details.is_swiped=d,t.dataToPaymentList.bills[r].credit_card_details.auth_color_code=l,t.dataToPaymentList.bills[r].credit_card_details.payment_id=a.id,t.dataToPaymentList.bills[r].credit_card_details.token=a.token,0===r&&e.$emit("UPDATEDPAYMENTLIST",t.dataToPaymentList.bills[r].credit_card_details)):(t.dataToPaymentList.reservation_card.payment_details.card_type_image="images/"+o.toLowerCase()+".png",t.dataToPaymentList.reservation_card.payment_details.card_number=i,t.dataToPaymentList.reservation_card.payment_details.card_expiry=c,t.dataToPaymentList.reservation_card.payment_method_used="CC",t.dataToPaymentList.reservation_card.payment_method_description="Credit Card",t.dataToPaymentList.reservation_card.payment_details.is_swiped=d,t.dataToPaymentList.reservation_card.payment_details.auth_color_code=l,t.dataToPaymentList.reservation_card.payment_details.id=a.id,t.dataToPaymentList.reservation_card.restrict_post=a.restrict_post)};t.invokeApi(r.mapPaymentToReservation,u,f,m)},t.$parent.myScrollOptions={paymentList:{scrollbars:!0,snap:!1,hideScrollbar:!1,preventDefault:!1}},t.$on("$viewContentLoaded",function(){setTimeout(function(){t.$parent.myScroll.paymentList.refresh()},3e3)}),t.openAddNewPaymentModel=function(){t.closeDialog(),e.$broadcast("OPENPAYMENTMODEL")},t.deleteCreditCard=function(e){var a=function(){t.closeDialog()},n=function(e){t.errorMessage=e};t.callAPI(r.deleteCreditCard,{onSuccess:a,onFailure:n,params:{reservation_id:s,payment_method_id:e}})},t.shouldShowCreditCardDeleteBtn=function(){return e.isStandAlone&&i&&"rover.reservation.staycard.reservationcard.reservationdetails"===a.current.name}}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){sntRover.controller("RVPleaseSwipeCtrl",["$rootScope","$scope","sntPaymentSrv",function(e,t,a){BaseCtrl.call(this,t),t.state={numAttempts:0},t.addCardOWS=function(){t.$emit("SHOW_SIX_PAY_LOADER"),t.callAPI(a.getSixPaymentToken,{params:{reservation_id:t.reservationBillData.reservation_id,workstation_id:t.workstation_id},successCallBack:function(){t.$emit("REFRESH_BILLCARD_VIEW"),t.$emit("HIDE_SIX_PAY_LOADER"),t.closeDialog()},failureCallBack:function(e){t.state.numAttempts++,t.errorMessage=e,t.$emit("HIDE_SIX_PAY_LOADER")}})}}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){sntRover.controller("reservationPaymentController",["$scope","$rootScope","RVReservationSummarySrv","rvPermissionSrv",function(e,t,a,r){e.getHasButtonClass=function(){var t=e.reservationData.reservation_card.has_any_credit_card_attached_bill,a="has-button";return t&&e.showCCAuthButton()&&(a="has-buttons"),a},e.displayButton=function(){var t=e.reservationData.reservation_card.reservation_status,a=!0;return"NOSHOW"!==t&&"CHECKEDOUT"!==t&&"CANCELED"!==t||(a=!1),a},e.showCCAuthButton=function(){return!(!e.reservationData.reservation_card.has_any_credit_card_attached_bill||!e.isStandAlone)};var n=function(){e.reservationData.reservation_card.restrict_post=!e.reservationData.reservation_card.restrict_post};e.setAllowPostWithNoCredit=function(){if(r.getPermissionValue("ALLOW_POST_WHEN_RESTRICTED")){var t={restrict_post:!e.reservationData.reservation_card.restrict_post,reservationId:e.reservationData.reservation_card.reservation_id},o={params:t,successCallBack:n};e.callAPI(a.updateRestrictPost,o)}},e.showPostWithNoCreditButton=function(){var a=!0;return t.isStandAlone&&""!==e.reservationData.reservation_card.payment_method_used&&null!==e.reservationData.reservation_card.payment_method_used||(a=!1),a},t.$on("UPDATEDPAYMENTLIST",function(t,a){e.reservationData.reservation_card.payment_details.card_type_image=a.card_code+".png",e.reservationData.reservation_card.payment_details.card_number=a.card_number,e.reservationData.reservation_card.payment_details.card_expiry=a.card_expiry,e.reservationData.reservation_card.payment_details.is_swiped=a.is_swiped}),t.$on("UPDATECCATTACHEDBILLSTATUS",function(t,a){e.reservationData.reservation_card.has_any_credit_card_attached_bill=a})}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){sntRover.controller("rvExternalReferencesCtrl",["$rootScope","$scope","RVExternalReferencesSrv","$filter",function(e,t,a,r){BaseCtrl.call(this,t);var n=function(e){t.$emit("CHILD_CONTENT_MOD",e||0)},o=function(e){var r=function(a){t.errorMessage="",e.id=a.id},n={params:{reference:e,reservationId:t.reservationParentData.reservationId},successCallBack:r};t.callAPI(a.save,n)},i=function(e){var r=function(){t.errorMessage=""},n={params:{reference:e,reservationId:t.reservationParentData.reservationId},successCallBack:r};t.callAPI(a.update,n)},s=function(e){var r=function(){t.errorMessage="",1===t.stateExternalRef.references.length&&t.stateExternalRef.references.push(a.getEmptyRow()),t.stateExternalRef.references=_.without(t.stateExternalRef.references,e),n()},o={params:{referenceId:e.id,reservationId:t.reservationParentData.reservationId},successCallBack:r};t.callAPI(a.remove,o)};t.stateExternalRef={viewDetails:!1,thirdParties:[],references:[]},t.toggleDetails=function(){var e=function(){t.stateExternalRef.viewDetails=!t.stateExternalRef.viewDetails,n(100)},o=function(a){t.stateExternalRef.thirdParties=a.systems,t.stateExternalRef.references=a.references,_.each(t.stateExternalRef.references,function(e){e.is_primary&&(e.external_confirm_no+=r("translate")("PRIMARY_EXTERNAL_REFERENCE"))}),e()},i={params:t.reservationParentData.reservationId,successCallBack:o};t.stateExternalRef.viewDetails?e():t.callAPI(a.getExternalData,i)},t.deleteReference=function(e){e.id&&s(e)},t.addNewRow=function(){t.stateExternalRef.references.push(a.getEmptyRow()),n(100)},t.onEditReference=function(e){!e.id&&e.external_interface_type_id&&e.external_confirm_no?o(e):e.id&&i(e)},t.getExtRefText=function(e,a){var r=_.find(t.stateExternalRef.thirdParties,{id:e});return r.name+(a&&a!==r.name?" ["+a+"]":"")}}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){sntRover.controller("rvGMSLoyalityController",["$scope","$rootScope","$filter","RVLoyaltyProgramSrv","ngDialog","$sce","$timeout","sntActivity",function(e,t,a,r,n,o,i,s){BaseCtrl.call(this,e);var c,d={},l={},u={},m=function(t){"gms-iframe"===t.target.id&&e.iframe.contentWindow.postMessage({messageType:"membership-lookup",credentials:d,content:l||{}},e.GMSiFrameSrc),s.stop("GMS_IFRAME_LOAD")},f=function(t){if(e.GMSiFrameSrc.includes(t.origin)){var a,r=t.data;switch(r.messageType){case"error":a=r.content,v(r.timestamp||Date.now(),a.code);break;case"details":a=r.content,y(a);break;case"cancel":e.closeGMSDialog()}}},p=function(){e.iframe.removeEventListener("load",m),e.iframe.removeEventListener("error",D)},v=function(t,a){e.errorMessage="GMS Error code:"+a},_=function(){p(),window.removeEventListener("message",f)},D=function(t){"gms-iframe"===t.target.id&&(v(Date.now(),"GMS-XXX",e.GMSiFrameSrc+" failed to load ",t),_())},h=function(){d={username:e.ngDialogData.GMSSettings.user_name,password:e.ngDialogData.GMSSettings.password,buildingCode:e.ngDialogData.GMSSettings.hotel_code,identifier:t.hotelDetails.current_user.email,lname:e.userInfo.last_name,fname:e.userInfo.first_name},l={email:e.ngDialogData.guestInfo.email,firstName:e.ngDialogData.guestInfo.firstName,lastName:e.ngDialogData.guestInfo.lastName}},y=function(a){var n={},o={},i=function(r){r.id&&(o.id=r.id,t.$broadcast("loyaltyProgramAdded",o,"fromReservationCard"),t.$broadcast("updateEmailFromGMS",a.details.email),e.closeGMSDialog()),"failure"===r.status&&(e.errorMessage=r.errors)};n.reservation_id=e.$parent.reservationData.reservation_card.reservation_id,n.user_id=e.$parent.$parent.guestCardData.userId,o.membership_type=a.progamCode,o.membership_card_number=a.memberNumber,o.membership_class=c,n.user_membership=o;var s={params:n,successCallBack:i};e.callAPI(r.addLoyaltyProgram,s)},g=function(){s.start("GMS_IFRAME_LOAD"),e.trustSrc=o.trustAsResourceUrl,u=e.ngDialogData.guestInfo,c="HLP",h(),e.iframe=null,i(function(){e.iframe=document.getElementById("gms-iframe"),e.GMSiFrameSrc=e.ngDialogData.GMSSettings.iframe_end_point,e.iframe&&(e.iframe.addEventListener("load",m,!1),e.iframe.addEventListener("error",D,!1),window.addEventListener("message",f,!1))},3e3)};e.closeGMSDialog=function(){_(),e.closeDialog()},g()}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){sntRover.controller("rvGuestIdScanCtrl",["$scope","$rootScope","$filter","ngDialog","RVGuestCardsSrv","dateFilter","$timeout","$controller","sntIDCollectionSrv","sntIDCollectionUtilsSrv","rvUtilSrv",function(e,t,a,r,n,o,i,s,c,d,l){BaseCtrl.call(this,e),s("sntIDCollectionBaseCtrl",{$scope:e}),e.screenData.showBackSideScan=!1;var u,m=function(e){var a=t.dateFormat?t.dateFormat.toUpperCase():"MM-DD-YYYY";return moment(e,"MM-DD-YYYY").format(a)};e.guestIdData.dob_for_display=e.guestIdData.date_of_birth?m(e.guestIdData.date_of_birth):"",e.guestIdData.expiry_date_for_display=e.guestIdData.expiration_date?m(e.guestIdData.expiration_date):"",e.guestIdData.errorMessage="";var f=!1;e.guestIdData.document_type&&e.guestIdData.document_type.length>0&&(e.guestIdData.document_type=e.guestIdData.document_type.toUpperCase());var p=_defineProperty({preventDefaultException:{tagName:/^(INPUT|SELECT|BUTTON)$/},tap:!0,preventDefault:!1,deceleration:1e-4},"preventDefault",!1);e.setScroller("id-details",p),e.refreshScroller("id-details"),e.callAPI(n.fetchNationsList,{params:{},successCallBack:function(t){e.countyList=t}}),e.closeGuestIdModal=function(){f&&e.$emit("ON_GUEST_ID_POPUP_CLOSE"),r.close()};var v,D,h;e.dateOfBirthdateOptions={changeYear:!0,changeMonth:!0,maxDate:tzIndependentDate(t.businessDate),yearRange:"-100:+0",onSelect:function(){e.guestIdData.dob_for_display=m(e.guestIdData.date_of_birth),v.close()}},e.openDobCalendar=function(){v=r.open({template:"/assets/partials/guestId/rvGuestIDDobCalendar.html",className:"single-date-picker",scope:e})},e.idExpiryDateOptions={changeYear:!0,changeMonth:!0,yearRange:"-10:+50",defaultDate:new Date,onSelect:function(){e.guestIdData.expiry_date_for_display=m(e.guestIdData.expiration_date),D.close()}},e.openExpiryCalendar=function(){e.guestIdData.expiration_date||(e.guestIdData.expiration_date=a("date")(new Date,"mm-dd-yy")),D=r.open({template:"/assets/partials/guestId/rvGuestIDExpiryCalendar.html",className:"single-date-picker",scope:e})},e.uploadFrontImage=function(){$("#front-image-upload").trigger("click")},e.uploadBackImage=function(){$("#back-image-upload").trigger("click")};var y=function(){f=!0},g=function(){h=r.open({template:"/assets/partials/guestId/rvGuestIDDetailsErrorPopup.html",className:"single-date-picker",scope:e})};e.closeErrorPopup=function(){e.guestIdData.errorMessage="",h.close()},e.clearDob=function(){e.guestIdData.dob_for_display="",e.guestIdData.date_of_birth=""},e.clearExpiryDate=function(){e.guestIdData.expiry_date_for_display="",e.guestIdData.expiration_date=""};var C=function(e){var t=e.split("-");return t[1]+"-"+t[0]+"-"+t[2]},A=function(e){var t=null;if("string"!=typeof e)return!1;var a=e.match(/data:([a-zA-Z0-9]+\/[a-zA-Z0-9-.+]+).*,.*/);a&&a.length&&(t=a[1]);var r=t&&("image/png"===t||"image/jpeg"===t||"image/gif"===t||"image/bmp"===t||"image/webp"===t||"image/x-icon"===t||"image/vnd.microsoft.icon"===t);return r};e.ImageChange=function(t){var a="front-image"===t?e.guestIdData.front_image_data:e.guestIdData.back_image_data;A(a)||(e.guestIdData.errorMessage="front-image"===t?"Front side Image...wrong file type!":"Back side Image...wrong file type!",e.guestIdData.front_image_data="front-image"===t?"":e.guestIdData.front_image_data,e.guestIdData.back_image_data="back-image"===t?"":e.guestIdData.back_image_data,g())};var S=function(){var t=u.split(",").length>1?u.split(",")[1]:"",a={avatar:t,guest_id:e.guestIdData.guest_id};e.callAPI(n.saveFaceImage,{params:a,loader:"NONE"}),e.closeGuestIdModal()};e.saveGuestIdDetails=function(t,r){var o=angular.copy(e.guestIdData);o.reservation_id=e.reservationData.reservation_card.reservation_id,o.document_type=e.guestIdData.document_type?e.guestIdData.document_type:"ID_CARD",o.date_of_birth=o.date_of_birth?C(o.date_of_birth):"",o.expiration_date=o.expiration_date&&o.expiry_date_for_display?C(o.expiration_date):"",delete o.expiry_date_for_display,delete o.dob_for_display,delete o.nationality,delete o.errorMessage,"DELETE"===t&&(o.front_image_data="front-image"===r?"":o.front_image_data,o.back_image_data="back-image"===r?"":o.back_image_data,o.action_type="front-image"===r?"Delete front image":"Delete back image");var i;i="DELETE"===t?function(){e.guestIdData.front_image_data="front-image"===r?"":e.guestIdData.front_image_data,e.guestIdData.back_image_data="back-image"===r?"":e.guestIdData.back_image_data,y()}:function(){y();var t=e.guestIdData.document_type&&"ID_CARD"===e.guestIdData.document_type?1:3,r=e.guestIdData.nationality_id?parseInt(e.guestIdData.nationality_id):"",n=e.hotelDetails.id_collection&&e.hotelDetails.id_collection.rover&&e.hotelDetails.id_collection.rover.save_id_face_image&&u;if(e.guestIdData.is_primary_guest){var o={id_type:t,nationality_id:r,id_number:e.guestIdData.document_number,birthday:a("date")(new Date(e.guestIdData.date_of_birth),"yyyy-MM-dd")};n&&(o.faceImage=u),e.$emit("PRIMARY_GUEST_ID_CHANGED",o)}n?S():e.closeGuestIdModal()},e.callAPI(n.saveGuestIdDetails,{params:o,successCallBack:i,failureCallBack:g})},e.scanFrontSide=function(){e.screenData.imageSide=0,e.captureFrontImage()},e.scanBackSide=function(){e.screenData.imageSide=1,e.captureBackImage()},e.$on("IMAGE_UPDATED",function(t,a){a.isFrontSide?(e.guestIdData.front_image_data=a.imageData,e.guestIdData.back_image_data="",e.screenData.extCamForFrontIDActivated=!1):(e.guestIdData.back_image_data=a.imageData,e.screenData.extCamForBackIDActivated=!1),e.refreshScroller("id-details"),"CONFIRM_ID_IMAGES"===e.screenData.scanMode?(e.confirmImages(),e.screenData.showBackSideScan=!1):(e.screenData.showBackSideScan=!0,e.$emit("hideLoader"))});var I=function(t){var a=angular.copy(e.guestIdData.front_image_data),r=angular.copy(e.guestIdData.back_image_data),n=moment(t.expiration_date,"DD-MM-YYYY"),o=moment(t.date_of_birth,"DD-MM-YYYY");e.guestIdData.expiration_date=n.isValid()?n.format("MM-DD-YYYY"):"",e.guestIdData.date_of_birth=o.isValid()?o.format("MM-DD-YYYY"):"",e.guestIdData.front_image_data=a,e.guestIdData.back_image_data=r,e.guestIdData.last_name=t.last_name,e.guestIdData.first_name=t.first_name,e.guestIdData.document_number=t.document_number,e.guestIdData.document_type=t.document_type&&"PASSPORT"===t.document_type.toUpperCase()?"PASSPORT":"ID_CARD",e.guestIdData.expiry_date_for_display=e.guestIdData.expiration_date?m(e.guestIdData.expiration_date):"",e.guestIdData.dob_for_display=e.guestIdData.date_of_birth?m(e.guestIdData.date_of_birth):"",e.guestIdData.id_scan_info=t.id_scan_info;var i="";t.nationality_name&&_.each(e.countyList,function(e){_.each(e.names,function(a){t.nationality_name===a&&(i=e.id.toString())})}),e.guestIdData.nationality_id=i},T=function(t){e.guestIdData.errorMessage=t,g(),e.guestIdData.front_image_data="",e.guestIdData.back_image_data="",e.screenData.extCamForFrontIDActivated=!1,e.screenData.extCamForBackIDActivated=!1};e.$on("FINAL_RESULTS",function(t,a){e.$emit("hideLoader"),"Expired"===a.expirationStatus?T("ID IS EXPIRED. PLEASE RETRY OR USE ANOTHER ID."):a.document_number?(I(a),e.refreshScroller("id-details")):T("FAILED TO ANALYZE THE DOCUMENT. PLEASE RETRY OR USE ANOTHER ID.")}),e.$on("IMAGE_ANALYSIS_STARTED",function(){e.$emit("showLoader")});var E=function(){e.showScanOption&&(e.screenData.extCamForFrontIDActivated&&e.startExtCameraCapture("front-image"),e.screenData.extCamForBackIDActivated&&e.startExtCameraCapture("back-image"))};e.$on("IMAGE_ANALYSIS_FAILED",function(){e.$emit("hideLoader"),e.guestIdData.errorMessage="Failed to Analyze the image",g(),E()}),!c.isInDevEnv&&e.hotelDetails.id_collection&&c.setAcuantCredentialsForProduction(e.hotelDetails.id_collection.acuant_credentials),e.showScanOption=e.hotelDetails.id_collection&&e.hotelDetails.id_collection.rover.enabled&&d.isInMobile(),e.connectedCameras=[];var R=0;if(e.selectedCamera=localStorage.getItem("ID_SCAN_CAMERA_ID"),e.cameraSourceChanged=function(){localStorage.setItem("ID_SCAN_CAMERA_ID",e.selectedCamera),E()},!d.isInMobile()&&navigator.mediaDevices&&navigator.mediaDevices.enumerateDevices)navigator.mediaDevices.enumerateDevices().then(function(t){angular.forEach(t,function(t){"videoinput"===t.kind&&(e.connectedCameras.push({id:t.deviceId,label:t.label||"camera "+(R+1)}),R++)});var a={useExtCamera:e.connectedCameras.length>0,useAutoDetection:!1};e.showScanOption=e.hotelDetails.id_collection&&e.hotelDetails.id_collection.rover.enabled&&e.connectedCameras.length>0,e.setConfigurations(a)});else{var b={useAutoDetection:!1},N=l.retrieveFeatureDetails(t.featuresSupportedInIosApp,"CAPTURE_ID");N&&(b.useAutoDetection=!0,b.idCapturePluginName=N.plugin_details?N.plugin_details.plugin_name:"",b.idCaptureActionName=N.plugin_details?N.plugin_details.action:""),e.setConfigurations(b)}e.$on("EXT_CAMERA_STARTING",function(){e.$emit("showLoader")}),e.$on("EXT_CAMERA_STARTED",function(){i(function(){e.$emit("hideLoader")},3e3)}),e.$on("EXT_CAMERA_FAILED",function(){e.$emit("hideLoader")}),e.$on("FACE_IMAGE_RETRIEVED",function(e,t){u=t})}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){sntRover.controller("reservationActionsController",["$rootScope","$scope","ngDialog","$state","RVReservationCardSrv","RVHkRoomDetailsSrv","RVSearchSrv","RVDepositBalanceSrv","$filter","rvPermissionSrv","$timeout","$window","RVReservationSummarySrv","RVPaymentSrv","RVContactInfoSrv","rvUtilSrv","RVBillCardSrv","RVGuestCardsSrv","RVGAHelperSrv","$stateParams",function(e,t,a,r,n,o,i,s,c,d,l,u,m,f,p,v,D,h,y,g){BaseCtrl.call(this,t);var C=this,A=tzIndependentDate,S=t.reservationParentData,I="rover.reservation.staycard.mainCard.room-rates",T=new Date(t.reservationData.reservation_card.departure_date)>=new Date(e.businessDate)||t.reservationData.reservation_card.departure_date===e.businessDate,E=t.reservationData.reservation_card;t.showReverseCheckout="CHECKEDOUT"===E.reservation_status&&T&&d.getPermissionValue("REVERSE_CHECK_OUT")&&e.isStandAlone&&!e.isHourlyRateOn&&E.is_reverse_checkout_allowed_for_hotel,t.shouldShowDemographicsInValidationPopup=!1,t.shouldShowGuestInfoInValidationPopup=!1,t.hasPermissionToCheckin=d.getPermissionValue("CHECK_IN_RESERVATION"),t.reverseCheckout=function(e,a){r.go("rover.reservation.staycard.billcard",{reservationId:e,clickedButton:a,userId:t.guestCardData.userId})},"boolean"!=typeof t.reservationData.reservation_card.is_rate_suppressed_present_in_stay_dates&&(t.reservationData.reservation_card.is_rate_suppressed_present_in_stay_dates="true"===t.reservationData.reservation_card.is_rate_suppressed_present_in_stay_dates),t.actionsCheck={firstDate:t.reservationParentData.arrivalDate===e.businessDate},t.displayTime=function(e){var t=!1;return"CHECKEDIN"!==e&&"CHECKING_OUT"!==e||(t=!0),t},t.displayBalance=function(e){var t=!1;return"CHECKING_IN"!==e&&"RESERVED"!==e&&"CHECKEDIN"!==e&&"CHECKING_OUT"!==e||(t="CHECKING_IN"!==e&&"RESERVED"!==e),t},t.getBalanceAmountColor=function(e){return e>0?"red":"green"},t.displayAddon=function(e){return"RESERVED"===e||"CHECKING_IN"===e||"CHECKEDIN"===e||"CHECKING_OUT"===e},t.displayAddCharge=function(e){return"RESERVED"===e||"CHECKING_IN"===e||"CHECKEDIN"===e||"CHECKING_OUT"===e||"NOSHOW_CURRENT"===e;
},t.displayArrivalTime=function(e){return"CHECKING_IN"===e||"NOSHOW_CURRENT"===e},t.getTimeColor=function(e){var t="";return null!==e&&(t="time"),t};var R=t.$on("postcharge.added",function(e,a){t.reservationData.reservation_card.balance_amount=parseFloat(a.total_balance_amount)});t.$on("$destroy",R),t.creditCardTypes=[],t.paymentTypes=[];var b=function(){if("RESERVED"===t.reservationData.reservation_card.reservation_status||"CHECKING_IN"===t.reservationData.reservation_card.reservation_status){var e=void 0===t.depositDetails.attached_card?{}:t.depositDetails.attached_card.fees_information,r={reservationId:t.reservationData.reservation_card.reservation_id,fees_information:e,details:{firstName:t.guestCardData.contactInfo.first_name,lastName:t.guestCardData.contactInfo.last_name,isDisplayReference:t.ifReferanceForCC,creditCardTypes:t.creditCardTypes,paymentTypes:t.paymentTypes}};t.passData=r,a.close(),a.open({template:"/assets/partials/reservationCard/rvReservationDepositPopup.html",className:"",controller:"rvReservationPendingDepositController",scope:t,closeByDocument:!1,closeByEscape:!1})}};t.ifReferanceForCC=!1,t.depositDetails={},t.depositDetails.isFromCheckin=!1;var N=angular.copy(t.reservationData.paymentTypes);t.paymentTypes=N,t.creditCardTypes=[],N.forEach(function(e){"CC"===e.name&&(t.creditCardTypes=e.values)}),t.depositDetails=angular.copy(t.reservationData.reseravationDepositData),t.depositDetails.deposit_policy&&parseInt(t.depositDetails.deposit_amount,10)>0&&e.isStandAlone&&(t.depositPopupData.isShown||(t.depositDetails.isFromCheckin=!1,t.reservationData.justCreatedRes||b(),t.depositPopupData.isShown=!0));var P=function(e,t){var a=new Date(e+" "+t);return a.getTime()},k=function(){var a=t.reservationData.reservation_card,r=P(a.arrival_date,a.arrival_time),n=P(a.departure_date,a.departure_time),o=!1;return a.ooo_array&&a.ooo_array.forEach(function(e){var t=P(e.ooo_start_date,e.ooo_start_time),i=P(e.ooo_end_date,e.ooo_end_time);if(r<=i&&n>=t&&3===a.room_reservation_hk_status)return void(o=!0)}),!("NOTREADY"!==a.room_status&&!o||!a.is_hourly_reservation&&"FULL"!==e.hotelDiaryConfig.mode)},O=function(){n.checkinDateForDiary=t.reservationData.reservation_card.arrival_date.replace(/-/g,"/"),r.go("rover.diary",{reservation_id:t.reservationData.reservation_card.reservation_id,checkin_date:t.reservationData.reservation_card.arrival_date,is_nightly_reservation:!t.reservationData.reservation_card.is_hourly_reservation})};t.checkGuestInFromQueue=function(){t.initCheckInFlow()};var w=function(){return(_.isEmpty(t.guestCardData.contactInfo.email)||_.isEmpty(t.guestCardData.contactInfo.phone)||_.isEmpty(t.guestCardData.contactInfo.mobile))&&"true"!==t.reservationData.reservation_card.is_disabled_email_phone_dialog},M=function(){return v.isEmpty(t.guestCardData.contactInfo.nationality_id)&&e.roverObj.forceNationalityAtCheckin||v.isEmpty(t.guestCardData.contactInfo.address.country_id)&&e.roverObj.forceCountryAtCheckin};t.reservationMissingGuestDataOrDemographics=function(){(w()||M())&&(t.shouldShowGuestInfoInValidationPopup=!0);var a=w()||M()||e.isStandAlone&&!V(t.reservationParentData.demographics);return a},t.reservationIsQueued=function(){return"true"===t.reservationData.reservation_card.is_reservation_queued},t.roomAssignmentNeeded=function(){return(""===t.reservationData.reservation_card.room_number||"NOTREADY"===t.reservationData.reservation_card.room_status&&!t.hasAnySharerCheckedin()||"OCCUPIED"===t.reservationData.reservation_card.fo_status&&!t.hasAnySharerCheckedin())&&(!(""!==t.reservationData.reservation_card.room_number||!t.putInQueueClicked)||(!(""!==t.reservationData.reservation_card.room_number||!t.reservationIsQueued())||("NOTREADY"!==t.reservationData.reservation_card.room_status||!t.reservationIsQueued()&&!t.putInQueueClicked)))},t.upsellNeeded=function(){return"true"===t.reservationData.reservation_card.is_force_upsell&&"true"===t.reservationData.reservation_card.is_upsell_available},t.goToRoomAssignment=function(){var e=t.reservationData.reservation_card.reservation_status,a="true"===t.reservationData.reservation_card.is_upsell_available&&("RESERVED"===e||"CHECKING_IN"===e),n=t.reservationData.reservation_card.cannot_move_room&&""!==t.reservationData.reservation_card.room_number;r.go("rover.reservation.staycard.roomassignment",{reservation_id:t.reservationData.reservation_card.reservation_id,room_type:t.reservationData.reservation_card.room_type_code,clickedButton:"checkinButton",upgrade_available:a,cannot_move_room:n,roomTypeId:t.reservationData.reservation_card.room_type_id})},t.goToBillCard=function(){r.go("rover.reservation.staycard.billcard",{reservationId:t.reservationData.reservation_card.reservation_id,clickedButton:"checkinButton",userId:t.guestCardData.userId})},t.goToRoomUpgrades=function(){var e=t.reservationData.reservation_card.cannot_move_room&&""!==t.reservationData.reservation_card.room_number;r.go("rover.reservation.staycard.upgrades",{reservation_id:t.reservationData.reservation_card.reservation_id,clickedButton:"checkinButton",cannot_move_room:e})},t.validateEmailPhone=function(){t.showJobTitle=!1,t.showNameOfFather=!1,t.showNameOfMother=!1,t.showPlaceOfBirth=!1,t.showGender=!1,t.showVehicleRegistrationNumber=!1,t.showIdPlaceOfIssue=!1,t.showPersonalIdNumber=!1,t.showHomeTown=!1,t.showPlaceOfResidence=!1,t.showVehicleCountryMark=!1,t.showIdCountryOfIssue=!1,t.showDateOfBirth=!1,t.showIdExpDate=!1,t.callAPI(h.fetchGuestDetailsInformation,{successCallBack:function(e){t.guestCardData.contactInfo=e,t.showJobTitle=t.guestCardData.contactInfo.guest_admin_settings.job_title.is_mandatory_on_guest_card_creation,t.showNameOfFather=t.guestCardData.contactInfo.guest_admin_settings.father_name.is_mandatory_on_guest_card_creation,t.showNameOfMother=t.guestCardData.contactInfo.guest_admin_settings.mother_name.is_mandatory_on_guest_card_creation,t.showPlaceOfBirth=t.guestCardData.contactInfo.guest_admin_settings.birth_place.is_mandatory_on_guest_card_creation,t.showGender=t.guestCardData.contactInfo.guest_admin_settings.gender.is_mandatory_on_guest_card_creation,t.showVehicleRegistrationNumber=t.guestCardData.contactInfo.guest_admin_settings.registration_number.is_mandatory_on_guest_card_creation,t.showIdPlaceOfIssue=t.guestCardData.contactInfo.guest_admin_settings.id_place_of_issue.is_mandatory_on_guest_card_creation,t.showPersonalIdNumber=t.guestCardData.contactInfo.guest_admin_settings.personal_id_no.is_mandatory_on_guest_card_creation,t.showHomeTown=t.guestCardData.contactInfo.guest_admin_settings.home_town.is_mandatory_on_guest_card_creation,t.showPlaceOfResidence=t.guestCardData.contactInfo.guest_admin_settings.place_of_residence.is_mandatory_on_guest_card_creation,t.showVehicleCountryMark=t.guestCardData.contactInfo.guest_admin_settings.vehicle_country_mark.is_mandatory_on_guest_card_creation&&(""===t.guestCardData.contactInfo.country_code||null===t.guestCardData.contactInfo.country_code),t.showIdCountryOfIssue=t.guestCardData.contactInfo.guest_admin_settings.id_country_of_issue.is_mandatory_on_guest_card_creation&&(""===t.guestCardData.contactInfo.id_country_of_issue||null===t.guestCardData.contactInfo.id_country_of_issue),t.showDateOfBirth=t.guestCardData.contactInfo.guest_admin_settings.date_of_birth.is_mandatory_on_guest_card_creation&&(""===t.guestCardData.contactInfo.birthday||null===t.guestCardData.contactInfo.birthday),t.showIdExpDate=t.guestCardData.contactInfo.guest_admin_settings.id_expiration_date.is_mandatory_on_guest_card_creation&&(""===t.guestCardData.contactInfo.id_expiration_date||null===t.guestCardData.contactInfo.id_expiration_date),a.open({template:"/assets/partials/validateCheckin/rvValidateEmailPhone.html",controller:"RVValidateEmailPhoneCtrl",scope:t})},failureCallBack:function(e){t.errorMessage=e,t.$emit("hideLoader")},params:t.guestCardData.userId})},t.promptCardAddition=function(){var e="/assets/partials/cards/alerts/cardAdditionPrompt.html";a.open({template:e,className:"ngdialog-theme-default stay-card-alerts",scope:t,closeByDocument:!1,closeByEscape:!1})},t.initCheckInFlow=function(){var a=!t.reservationData.check_in_via_queue&&t.reservationIsQueued();return t.hasAnySharerCheckedin()||a?t.roomAssignmentNeeded()?(t.goToRoomAssignment(),!1):(t.goToBillCard(),!1):void(k()?O():t.roomAssignmentNeeded()?t.goToRoomAssignment():!t.upsellNeeded()||e.isHourlyRateOn||t.reservationData.reservation_card.is_suite?t.goToBillCard():t.goToRoomUpgrades())},t.checkInFromQueued=function(){var a=e.advanced_queue_flow_enabled;return!!a&&!(t.reservationData.check_in_via_queue||!t.reservationIsQueued())};var L=function(){if(e.queuedCheckIn=t.reservationIsQueued(),t.checkInFromQueued())return void t.checkGuestInFromQueue();var a=function(){if(t.guestCardData.userId){var a=t.reservationMissingGuestDataOrDemographics();a?(e.isStandAlone&&!V(t.reservationParentData.demographics)?(t.shouldShowDemographicsInValidationPopup=!0,U()):t.shouldShowDemographicsInValidationPopup=!1,t.validateEmailPhone()):t.initCheckInFlow()}else t.promptCardAddition()},r="string"==typeof t.reservationData.reservation_card.room_id?t.reservationData.reservation_card.room_id.length:t.reservationData.reservation_card.room_id;return r||"FULL"!==e.hotelDiaryConfig.mode?!r&&t.putInQueueClicked?t.reservationMissingGuestDataOrDemographics()?(t.$emit("showLoader"),t.validateEmailPhone(),!1):(t.goToRoomAssignment(),!1):void(r?(t.$emit("showLoader"),o.fetch(t.reservationData.reservation_card.room_id).then(function(e){t.$emit("hideLoader"),t.reservationData.reservation_card.room_ready_status=e.current_hk_status,t.reservationData.reservation_card.room_status="true"===e.is_ready?"READY":"NOTREADY",t.reservationData.reservation_card.fo_status="true"===e.is_occupied?"OCCUPIED":"VACANT",t.reservationData.reservation_card.room_reservation_hk_status=e.room_reservation_hk_status,t.reservationData.reservation_card.ooo_array=e.ooo_timings,k()?O():a()},function(){t.$emit("hideLoader")})):a()):(O(),!1)};t.$on("PROCEED_CHECKIN",function(){L()});var x=function(){return t.otherData.marketsEnabled&&t.otherData.markets.length>0},F=function(){return t.otherData.segmentsEnabled&&t.otherData.segments.length>0},B=function(){return t.otherData.originsEnabled&&t.otherData.origins.length>0},G=function(){return t.otherData.sourcesEnabled&&t.otherData.sources.length>0},V=function(e){var a=!0;return x()&&t.otherData.marketIsForced&&(a=!!e.market),G()&&t.otherData.sourceIsForced&&a&&(a=!!e.source),B()&&t.otherData.originIsForced&&a&&(a=!!e.origin),F()&&t.otherData.segmentsIsForced&&a&&(a=!!e.segment),a},U=function(){t.shouldShowReservationType=!1,t.shouldShowMarket=x()&&t.otherData.marketIsForced,t.shouldShowSource=G()&&t.otherData.sourceIsForced,t.shouldShowOriginOfBooking=B()&&t.otherData.originIsForced,t.shouldShowSegments=F()&&t.otherData.segmentsIsForced};t.isDemographicsFormValid=function(){return V(t.reservationParentData.demographics)},t.updateDemograhics=function(){var e={reservationId:t.reservationParentData.reservationId,source_id:parseInt(t.reservationParentData.demographics.source),market_segment_id:parseInt(t.reservationParentData.demographics.market),booking_origin_id:parseInt(t.reservationParentData.demographics.origin),segment_id:parseInt(t.reservationParentData.demographics.segment)},r=function(){a.close(),L()},n=function(e){t.errorMessage=e,a.close()};t.callAPI(m.updateReservation,{successCallBack:r,failureCallBack:n,params:e})},t.goToCheckin=function(){return y.startEventTiming("CHECKIN",t.reservationData.reservation_card.reservation_id,t.reservationData.reservation_card.confirmation_num),e.isStandAlone&&!e.allowCheckInToNotReadyRooms&&t.reservationData.reservation_card.room_number&&"NOTREADY"===t.reservationData.reservation_card.room_status?void C.openRoomStatusChangePopup("",!0):t.isGuestIdRequiredForCheckin()?void t.toggleGuests(!0):void L()},t.unAvailablePopup=function(){a.open({template:"/assets/partials/staycard/unavailablePopup.html",scope:t})},t.showPutInQueue=function(){var e=t.reservationData.reservation_card.is_queue_rooms_on,a=t.reservationData.reservation_card.is_reservation_queued,r=t.reservationData.reservation_card.reservation_status,n=!1;return"CHECKING_IN"!==r&&"NOSHOW_CURRENT"!==r||"true"===e&&"false"===a&&(n=!0),n},t.showRemoveFromQueue=function(){var e=t.reservationData.reservation_card.is_queue_rooms_on,a=t.reservationData.reservation_card.is_reservation_queued,r=t.reservationData.reservation_card.reservation_status,n=!1;return"CHECKING_IN"!==r&&"NOSHOW_CURRENT"!==r||"true"===e&&"true"===a&&(n=!0),n},t.successPutInQueueCallBack=function(){t.$emit("hideLoader"),t.reservationData.reservation_card.is_reservation_queued="true",t.$emit("UPDATE_QUEUE_ROOMS_COUNT","add"),n.updateResrvationForConfirmationNumber(t.reservationData.reservation_card.reservation_id,t.reservationData);var a=e.advanced_queue_flow_enabled,r=t.reservationData.reservation_card.key_settings;a&&"no_key_delivery"!==r?(e.$emit("goToStayCardFromAddToQueue"),setTimeout(function(){e.$broadcast("clickedIconKeyFromQueue")},500)):e.$emit("goToStayCardFromAddToQueue")},t.successRemoveFromQueueCallBack=function(){t.$emit("hideLoader"),t.reservationData.reservation_card.is_reservation_queued="false",i.removeResultFromData(t.reservationData.reservation_card.reservation_id),t.$emit("UPDATE_QUEUE_ROOMS_COUNT","remove"),n.updateResrvationForConfirmationNumber(t.reservationData.reservation_card.reservation_id,t.reservationData)},t.reservationData.check_in_via_queue=!1,t.putInQueue=function(a){var r=e.advanced_queue_flow_enabled;if(r)t.reservationData.check_in_via_queue=!0,t.initAdvQueCheck(),t.goToCheckin();else{t.reservationData.check_in_via_queue=!1;var o={reservationId:a,status:"true"};t.invokeApi(n.modifyRoomQueueStatus,o,t.successPutInQueueCallBack)}},t.removeFromQueue=function(e){var a={reservationId:e,status:!1};t.invokeApi(n.modifyRoomQueueStatus,a,t.successRemoveFromQueueCallBack)};var q=function(r,n,o,i){t.DailogeState={},t.DailogeState.successMessage="",t.DailogeState.failureMessage="",t.DailogeState.sendConfirmatonMailTo="",t.DailogeState.bookerEmail=t.reservationData.reservation_card.booker_email,t.DailogeState.isGuestEmailSelected=!1,t.DailogeState.isBookerEmailSelected=!1,t.DailogeState.guestEmail=t.guestCardData.contactInfo.email;var s={reservationId:t.reservationData.reservation_card.reservation_id,details:{firstName:t.guestCardData.contactInfo.first_name,lastName:t.guestCardData.contactInfo.last_name,creditCardTypes:t.creditCardTypes,paymentTypes:t.paymentTypes}};t.passData=s;var d=function(o){t.languageData=o,a.open({template:"/assets/partials/reservationCard/rvCancelReservation.html",controller:"RVCancelReservation",scope:t,data:JSON.stringify({state:"CONFIRM",cards:!1,penalty:r,paymentCurrencyCancellationCharge:i,penaltyText:function(){return n?r+(r>1?" nights":" night"):e.currencySymbol+c("number")(r,2)}()})}),t.$emit("hideLoader")};J(d)},H=function(r,n,o,i){t.DailogeState={},t.DailogeState.successMessage="",t.DailogeState.failureMessage="",t.DailogeState.sendConfirmatonMailTo="",t.DailogeState.bookerEmail=t.reservationData.reservation_card.booker_email,t.DailogeState.isGuestEmailSelected=!1,t.DailogeState.isBookerEmailSelected=!1,t.DailogeState.guestEmail=t.guestCardData.contactInfo.email,t.DailogeState.paymentCurrencyPenalty=i;var s=function(i){t.languageData=i,a.open({template:"/assets/partials/reservationCard/rvCancelReservationDeposits.html",controller:"RVCancelReservationDepositController",scope:t,data:JSON.stringify({state:"CONFIRM",cards:!1,penalty:o,deposit:r,depositText:function(){return n?"Reservation outside of cancellation period. A cancellation fee of "+e.currencySymbol+c("number")(o,2)+" will be charged, deposit not refundable":"Within Cancellation Period. Deposit of "+e.currencySymbol+c("number")(r,2)+" is refundable."}()})}),t.$emit("hideLoader")};J(s)},Y=0,j=0,W=!1,K=0;t.toggleCancellation=function(){var e=function(){var e=function(e){t.$emit("hideLoader"),K=e.results.deposit_amount;var a=!e.results.is_inside_cancellation_period;a?(Y="day"===e.results.penalty_type?e.results.calculated_penalty_amount:parseFloat(e.results.calculated_penalty_amount),j=parseFloat(e.results.default_payment_currency_calculated_penalty_amount),parseInt(K,10)>0?H(K,a,Y,j):q(Y,W,"percent"===e.results.penalty_type,j)):parseInt(K,10)>0?H(K,a,"",""):q("",W,"percent"===e.results.penalty_type,j)},a=function(e){t.$emit("hideLoader"),t.errorMessage=e},r={id:t.reservationData.reservation_card.reservation_id};t.invokeApi(n.fetchCancellationPolicies,r,e,a)};e()},t.openSmartBands=function(){a.open({template:"/assets/partials/smartbands/rvSmartBandDialog.html",controller:"RVSmartBandsController",className:"ngdialog-theme-default1",closeByDocument:!1,closeByEscape:!1,scope:t})},t.showSmartBandsButton=function(e,t,a){var r=!1;return"true"===t&&("RESERVED"===e||"CHECKING_IN"===e||"CHECKEDIN"===e||"CHECKING_OUT"===e||"NOSHOW_CURRENT"===e||"CHECKEDOUT"===e&&a)&&(r=!0),r},t.goToCheckoutButton=function(e,n,o){if(y.startEventTiming("CHECKOUT",t.reservationData.reservation_card.reservation_id,t.reservationData.reservation_card.confirmation_num),t.reservationData.reservation_card.is_bulk_checkout_in_progress){var i={message:"BULK_CHECKOUT_PROCESS_IN_PROGRESS",isFailure:!0};return void a.open({template:"/assets/partials/popups/rvInfoPopup.html",closeByDocument:!0,scope:t,data:JSON.stringify(i)})}"true"===o?(t.clickedButton=n,a.open({template:"/assets/partials/smartbands/rvSmartbandListCheckoutscreen.html",controller:"RVSmartBandsCheckoutController",className:"ngdialog-theme-default1",scope:t})):r.go("rover.reservation.staycard.billcard",{reservationId:e,clickedButton:n,userId:t.guestCardData.userId})},t.showDepositBalanceModal=function(){e.fromStayCard=!0;var a=t.reservationData.reservation_card.reservation_id,r={reservationId:a};t.invokeApi(s.getDepositBalanceData,r,t.successCallBackFetchDepositBalance)},t.successCallBackFetchDepositBalance=function(e){t.$emit("hideLoader"),t.depositBalanceData=e,t.depositBalanceData.primary_bill_id=t.reservationData.reservation_card.default_bill_id,t.passData={origin:"STAYCARD",details:{firstName:t.data.guest_details.first_name,lastName:t.data.guest_details.last_name,paymentTypes:t.paymentTypes}},a.open({template:"/assets/partials/depositBalance/rvModifiedDepositBalanceModal.html",controller:"RVDepositBalanceCtrl",className:"ngdialog-theme-default1",closeByDocument:!1,scope:t})},t.showDepositBalance=function(a){var r=!1;return"CC"!==t.reservationData.reservation_card.payment_method_used&&(r=!0),e.initFromCashDeposit=r,a=a.toUpperCase(),"RESERVED"===a||"CHECKING_IN"===a},t.showDepositBalanceWithSr=function(e,t){var a=!1;return"RESERVED"!==e&&"CHECKING_IN"!==e||"true"===t&&(a=!0),a},t.hasEmails=function(){return!!t.guestCardData.contactInfo.email||!!t.reservationData.reservation_card.booker_email},t.isEmailAttached=function(){var e=!1;return t.guestCardData.contactInfo.email&&null!==t.guestCardData.contactInfo.email&&""!==t.guestCardData.contactInfo.email&&(e=!0),e},t.ngData={},t.ngData.failureMessage="",t.ngData.successMessage="";var J=function(e){var a={reservation_id:t.reservationData.reservation_card.reservation_id};t.invokeApi(p.fetchGuestLanguages,a,e)};t.popupForConfirmation=function(){t.ngData.sendConfirmatonMailTo="",t.ngData.enable_confirmation_custom_text=!1,t.ngData.enable_confirmation_custom_text="",t.ngData.confirmation_custom_title="",t.ngData.languageData={},t.ngData.bookerEmail=t.reservationData.reservation_card.booker_email,t.ngData.isGuestEmailSelected=!1,t.ngData.isBookerEmailSelected=!1,t.ngData.successMessage="",t.ngData.failureMessage="",t.ngData.guestEmail=t.guestCardData.contactInfo.email,t.ngData.isCustomTextPerReservation=t.reservationData.reservation_card.is_custom_text_per_reservation;var e=function(e){t.ngData.languageData=e,a.open({template:"/assets/partials/reservationCard/rvReservationConfirmationPrintPopup.html",className:"",scope:t,closeByDocument:!1}),t.$emit("hideLoader")};J(e)},t.showConfirmation=function(t){var a=!1;return e.isStandAlone&&e.sendConfirmationLetter&&("RESERVED"!==t&&"CHECKING_IN"!==t&&"CHECKEDIN"!==t&&"CHECKING_OUT"!==t||(a=!0)),a},t.shouldShowResendCancellation=function(t){var a="CANCELED"===t,r=e.isStandAlone,n=e.sendCancellationLetter;return r&&a&&n};var z=function(e){t.$emit("hideLoader"),t.ngData.successMessage=e.message,t.ngData.failureMessage=""},Q=function(e){t.$emit("hideLoader"),t.ngData.failureMessage=e[0],t.ngData.successMessage=""},X=function(){var e="";return t.ngData.isGuestEmailSelected&&(e=t.ngData.guestEmail),t.ngData.isBookerEmailSelected&&(e=t.ngData.bookerEmail),!t.hasEmails()&&t.ngData.sendConfirmatonMailTo&&(e=t.ngData.sendConfirmatonMailTo),!v.isEmailValid(e)};t.sendConfirmationEmail=function(){if(X())return void Q(["PLEASE ENTER A VALID EMAIL ID"]);if(!t.shouldDisableSendConfirmationEmailBtn()){var e={type:"confirmation",enable_confirmation_custom_text:t.ngData.enable_confirmation_custom_text,confirmation_custom_title:t.ngData.confirmation_custom_title,confirmation_custom_text:t.ngData.confirmation_custom_text,locale:t.ngData.languageData.selected_language_code};t.ngData.isGuestEmailSelected&&(e.primary_email=t.ngData.guestEmail),t.ngData.isBookerEmailSelected&&(e.booker_email=t.ngData.bookerEmail),!t.hasEmails()&&t.ngData.sendConfirmatonMailTo&&(e.primary_email=t.ngData.sendConfirmatonMailTo);var a=t.reservationData.reservation_card.reservation_id,r={postData:e,reservationId:a};t.invokeApi(n.sendConfirmationEmail,r,z,Q)}},t.printReservation=function(){var e=function(e){t.printData=e.data,te()},a=function(e){t.ngData.failureMessage=e[0]};t.callAPI(m.fetchResservationConfirmationPrintData,{successCallBack:e,failureCallBack:a,params:{reservation_id:t.reservationData.reservation_card.reservation_id,locale:t.ngData.languageData.selected_language_code}})};var Z=function(){var e="portrait";$("head").append("<style id='print-orientation'>@page { size: "+e+"; }</style>")},ee=function(){$("#print-orientation").remove()},te=function(){Z(),$("header .logo").hide(),$("header .h2").hide();var e=function(){l(function(){$("header .logo").show(),$("header .h2").show(),ee()},100)};l(function(){sntapp.cordovaLoaded?cordova.exec(e,function(){e()},"RVCardPlugin","printWebView",[]):(u.print(),e())},400),l(ee,100)},ae=function(){var e=d.getPermissionValue("OVERBOOK_HOUSE"),a=d.getPermissionValue("OVERBOOK_ROOM_TYPE");t.allowOverbook=e&&a},re=function(e,r,n){ae(),a.open({template:"/assets/partials/reservation/alerts/rvReinstate.html",closeByDocument:!1,scope:t,data:JSON.stringify({isAvailable:e,isSuite:r,isRoomTypeInRate:n})})};t.reinstateNavigateRoomAndRates=function(){t.viewState.identifier="REINSTATE",new A(S.arrivalDate)<new A(e.businessDate)&&(S.arrivalDate=e.businessDate),r.go(I,{from_date:S.arrivalDate,to_date:S.departureDate,fromState:r.current.name,company_id:S.company.id,travel_agent_id:S.travelAgent.id}),t.closeDialog()},t.reinstateReservation=function(e){t.invokeApi(n.reinstateReservation,{reservationId:t.reservationData.reservation_card.reservation_id,is_overbook:e},function(){g.isrefresh=!0,r.reload(r.$current.name),t.closeDialog()},function(e){t.$emit("hideLoader"),t.errorMessage=e})},t.checkReinstationAvailbility=function(){t.invokeApi(n.checkReinstationAvailbility,t.reservationData.reservation_card.reservation_id,function(e){t.$emit("hideLoader"),re(e.is_available,e.is_suite_room,e.is_room_type_in_rate)},function(e){t.$emit("hideLoader"),t.errorMessage=e})},t.isReinstateVisible=function(){var a=t.reservationData.reservation_card;return"FULL"!==e.hotelDiaryConfig.mode&&!a.is_hourly_reservation&&"Cancel"!==a.group_status&&"Cancel"!==a.allotment_status&&(("CANCELED"===a.reservation_status||"NOSHOW"===a.reservation_status)&&new A(a.departure_date)>=new A(e.businessDate)&&d.getPermissionValue("REINSTATE_RESERVATION"))};var ne=function(e){t.$emit("hideLoader"),t.DailogeState.successMessage=e.message,t.DailogeState.failureMessage=""},oe=function(e){t.$emit("hideLoader"),t.DailogeState.failureMessage=e[0],t.DailogeState.successMessage=""};t.sendReservationCancellation=function(e){if(!t.shouldDisableSendCancellationEmailBtn()){var a={type:"cancellation",locale:e};t.DailogeState.isGuestEmailSelected&&(a.primary_email=t.DailogeState.guestEmail),t.DailogeState.isBookerEmailSelected&&(a.booker_email=t.DailogeState.bookerEmail),!t.hasEmails()&&t.DailogeState.sendConfirmatonMailTo&&(a.primary_email=t.DailogeState.sendConfirmatonMailTo);var r={postData:a,reservationId:t.reservationData.reservation_card.reservation_id};t.invokeApi(n.sendConfirmationEmail,r,ne,oe)}},t.onResendCancellationClicked=function(){t.DailogeState={},t.DailogeState.isCancelled=!0,t.DailogeState.failureMessage="",t.DailogeState.successMessage="",t.DailogeState.sendConfirmatonMailTo="",t.DailogeState.bookerEmail=t.reservationData.reservation_card.booker_email,t.DailogeState.isGuestEmailSelected=!1,t.DailogeState.isBookerEmailSelected=!1,t.DailogeState.guestEmail=t.guestCardData.contactInfo.email;var e={reservationId:t.reservationData.reservation_card.reservation_id,details:{firstName:t.guestCardData.contactInfo.first_name,lastName:t.guestCardData.contactInfo.last_name,creditCardTypes:t.creditCardTypes,paymentTypes:t.paymentTypes},isCancelled:!0};t.passData=e;var r=function(e){t.languageData=e,a.open({template:"/assets/partials/reservationCard/rvCancelReservation.html",controller:"RVCancelReservation",scope:t,data:JSON.stringify({state:"CANCELED"})}),t.$emit("hideLoader")};J(r)},t.printReservationCancellation=function(e){var a=function(e){t.printData=e.data,te()},r=function(e){t.ngData.failureMessage=e[0]};t.callAPI(m.fetchResservationCancellationPrintData,{successCallBack:a,failureCallBack:r,params:{reservation_id:t.reservationData.reservation_card.reservation_id,locale:e}})},t.putInQueueClicked=!1,t.initAdvQueCheck=function(){var a=e.advanced_queue_flow_enabled,r=t.reservationData.check_in_via_queue;a&&r?t.putInQueueClicked=!0:t.putInQueueClicked=!1},t.initAdvQueCheck(),t.enableConfirmationCustomText=function(){t.ngData.enable_confirmation_custom_text=!t.ngData.enable_confirmation_custom_text},t.navigateToBillAndCharges=function(){r.go("rover.reservation.staycard.billcard",{reservationId:t.reservationData.reservation_card.reservation_id,clickedButton:"viewBillButton",userId:t.guestCardData.userId})};var ie=function(){r.reload(r.$current.name)};t.updateRoomStatus=function(){var e=3;t.roomStatus.isReady&&(e="true"===t.reservationData.reservation_card.checkin_inspected_only?2:1);var r={room_no:t.reservationData.reservation_card.room_number,hkstatus_id:e,reservation_id:t.reservationData.reservation_card.reservation_id},n=function(){ie(),a.close()},o=function(e){t.errorMessage=e,a.close()};t.callAPI(D.changeHousekeepingStatus,{successCallBack:n,failureCallBack:o,params:r})},C.openRoomStatusChangePopup=function(e,r){t.roomStatus={isReady:!1},a.open({template:"/assets/partials/reservationCard/rvRoomStatusChangePopup.html",className:"",scope:t,closeByDocument:!1,closeByEscape:!1,data:{displayText:e,shouldShowCloseBtn:r}})},t.performReverseCheckIn=function(){var e=function(){C.openRoomStatusChangePopup("CHECK_IN_REVERSED",!1)},a=function(e){t.errorMessage=e};t.callAPI(n.reverseCheckIn,{successCallBack:e,failureCallBack:a,params:{reservationId:t.reservationData.reservation_card.reservation_id}})},t.closeErrorDialog=function(){a.close()},t.shouldDisableSendConfirmationEmailBtn=function(){return!t.ngData.languageData.selected_language_code||!t.ngData.isGuestEmailSelected&&!t.ngData.isBookerEmailSelected&&!t.ngData.sendConfirmatonMailTo},t.shouldDisableSendCancellationEmailBtn=function(){return!t.DailogeState.isGuestEmailSelected&&!t.DailogeState.isBookerEmailSelected&&!t.DailogeState.sendConfirmatonMailTo}}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){sntRover.controller("rvReservationAdditionalController",["$rootScope","$scope","RVReservationSummarySrv","rvPermissionSrv",function(e,t,a,r){BaseCtrl.call(this,t),t.additionalDetails={segmentAvailable:!!t.reservationParentData.demographics.segment,hideDetails:!0,isTaxExemptEnabled:t.reservationData.reservation_card.tax_exempt,isDayUse:t.reservationData.reservation_card.is_day_use,taxExemptType:t.reservationData.reservation_card.tax_exempt_type.id,taxExemptRefText:t.reservationData.reservation_card.tax_exempt_ref_text},t.isEmptyObject=isEmptyObject;var n=angular.copy(t.reservationData.reservation_card).booker_email;t.hasPermissionToEditCommission=r.getPermissionValue("UPDATE_COMMISSION")&&"CHECKEDOUT"!==t.reservationData.reservation_card.reservation_status&&!t.reservationData.reservation_card.allotment_id&&!t.reservationData.reservation_card.group_id,t.isSegmentAutoComputed=function(){var e=t.reservationParentData.demographics.segment,a="";return!!e&&(angular.forEach(t.otherData.segments,function(e){t.reservationData.reservation_card.total_nights<e.los&&(a||(a=e.value))}),!!a&&a===e)};var o="";t.clickedAdditionalDetails=function(e){e.preventDefault(),e.stopImmediatePropagation(),e.stopPropagation();var a=function(){t.additionalDetails.hideDetails=!t.additionalDetails.hideDetails,t.refreshReservationDetailsScroller(300),o=e.timeStamp};if(parseInt(o)){if(e.timeStamp-o<500)return;a()}else a()},t.updateAdditionalDetails=function(){var e=function(e){var a=_.where(t.otherData.reservationTypes,{value:parseInt(t.reservationParentData.demographics.reservationType)});a.length>0?t.reservationData.reservation_card.guarentee_type=a[0].name:t.reservationData.reservation_card.guarentee_type="",t.$emit("hideLoader")},r=function(e){t.$emit("hideLoader"),t.errorMessage=e};t.errorMessage=[],t.invokeApi(a.updateReservation,{reservationId:t.reservationParentData.reservationId,reservation_type_id:parseInt(t.reservationParentData.demographics.reservationType),source_id:parseInt(t.reservationParentData.demographics.source),market_segment_id:parseInt(t.reservationParentData.demographics.market),booking_origin_id:parseInt(t.reservationParentData.demographics.origin),segment_id:parseInt(t.reservationParentData.demographics.segment)},e,r)},t.updateTaxExemptData=function(){t.additionalDetails.taxExemptRefText=t.additionalDetails.isTaxExemptEnabled?t.additionalDetails.taxExemptRefText:"";var e={id:t.reservationParentData.reservationId,tax_exempt:t.additionalDetails.isTaxExemptEnabled,tax_exempt_ref_text:t.additionalDetails.taxExemptRefText},r=function(e){t.isUpdateDone=!1,e.errors&&e.errors.length>0&&(t.errorMessage=e.errors),t.additionalDetails.isTaxExemptEnabled||(t.additionalDetails.taxExemptType=""),t.reservationData.reservation_card.balance_amount=e.data.current_balance},n=function(e){t.isUpdateDone=!1,t.errorMessage=e.errors};t.additionalDetails.isTaxExemptEnabled&&(t.additionalDetails.taxExemptType?e.tax_exempt_type_id=parseInt(t.additionalDetails.taxExemptType):(e.tax_exempt_type_id=parseInt(t.defaultTaxExemptTypeId),t.additionalDetails.taxExemptType=parseInt(t.defaultTaxExemptTypeId)));var o={params:e,successCallBack:r,failureCallBack:n};t.additionalDetails.isTaxExemptEnabled?t.additionalDetails.taxExemptType&&t.callAPI(a.saveTaxExempt,o):t.callAPI(a.saveTaxExempt,o)},t.doUpdateTaxExemptData=_.debounce(function(){t.updateTaxExemptData()},5e3),t.toggleTaxExempt=function(){t.additionalDetails.isTaxExemptEnabled=!t.additionalDetails.isTaxExemptEnabled,(t.additionalDetails.isTaxExemptEnabled&&""!==t.defaultTaxExemptTypeId||!t.additionalDetails.isTaxExemptEnabled)&&t.updateTaxExemptData()},t.toggleCommission=function(){t.reservationData.reservation_card.commission_details.is_on=!t.reservationData.reservation_card.commission_details.is_on,
t.updateCommissionFromStaycard()},t.updateCommissionFromStaycard=function(){var e=t.reservationData.reservation_card.commission_details;e.reservationId=t.reservationParentData.reservationId;var r={params:e,successCallBack:function(e){t.reservationData.reservation_card.commission_details=e.commission_details},failureCallBack:function(e){t.errorMessage=e}};t.callAPI(a.updateCommission,r)},e.$on("UPDATERESERVATIONTYPE",function(e,a,r){t.reservationParentData.demographics.reservationType=a,r&&(t.reservationData.reservation_card.payment_details.id=r);var n=_.where(t.otherData.reservationTypes,{value:parseInt(t.reservationParentData.demographics.reservationType)});n.length>0?t.reservationData.reservation_card.guarentee_type=n[0].name:t.reservationData.reservation_card.guarentee_type=""}),t.$on("travelagentcardreplaced",function(e,a){t.reservationData.reservation_card.commission_details=a.commission_details}),t.$on("travelagentcardremoved",function(){t.reservationData.reservation_card.commission_details={}}),t.updateBookerEmail=function(){t.reservationData.reservation_card.booker_email!==n&&t.callAPI(a.updateBookerEmail,{onSuccess:function(){n=t.reservationData.reservation_card.booker_email},onFailure:function(e){t.errorMessage=e},params:{reservationId:t.reservationData.reservation_card.reservation_id,booker_email:t.reservationData.reservation_card.booker_email||""}})}}])},{}]},{},[1]);var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};!function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){angular.module("sntRover").controller("rvReservationCardActionsController",["$scope","$filter","$rootScope","ngDialog","rvActionTasksSrv","RVReservationCardSrv","rvUtilSrv","dateFilter","$timeout","sntActivity","rvPermissionSrv",function(e,t,a,r,n,o,i,s,c,d,l){BaseCtrl.call(this,e),e.reservationNotes="",e.errorMessage="",e.actionsCount="none",e.actions={},e.newAction={},e.actions.totalCount=0,e.actions.arrivalDateString="",e.actions.departureDateString="",e.selectedAction={},e.selectedAction.created_by_null=!1,e.openingPopup=!1,e.refreshing=!1,e.refreshToEmpty=!1,e.newAction.department={value:""},e.hotel_time="4:00 A.M",e.departmentSelect={},e.timeSelectorList=i.getListForTimeSelector(15,12),e.timeFieldValues=n.getTimeFieldValues(),e.selectedActionMessage="",e.selectedDepartment="",e.actionsSyncing=!1,e.reservationId="",e.isStandAlone=!0,e.starting=!1,e.actionsSyncd=!1,e.editingDescriptionInline=!1,e.lastSelectedItemId="",e.actionSelected="none",e.isRefreshing=!1;var u=function(){e.actions.totalCount=e.reservationListData.action_count,e.actions.pendingCount=e.reservationListData.pending_action_count,e.actionsCount=n.getActionsClassName(e.actions.totalCount,e.actions.pendingCount)};e.lastSavedDescription="",e.updateActionDescription=function(t,a){var r={reservation_id:e.$parent.reservationData.reservation_card.reservation_id,action_task:{id:e.selectedAction.id}};r.action_task.description=a;var o=function(t){e.lastSavedDescription=t.data.description,e.savingDescription=!1,e.$emit("hideLoader")},i=function(t){e.savingDescription=!1,e.$emit("hideLoader")};e.savingDescription&&e.lastSavedDescription!==a&&(a&&""!==a?e.callAPI(n.updateNewAction,r,{params:r,successCallBack:o,failureCallBack:i}):(e.selectedAction.description=e.lastSavedDescription,e.editingDescriptionValue=e.lastSavedDescription))},e.savingDescription=!1,e.stopEditClick=function(t){!e.starting||t?setTimeout(function(){e.editingDescriptionInline=!1,e.isStandAlone||e.lastSavedDescription!==e.selectedAction.description&&(e.savingDescription||(e.savingDescription=!0,e.updateActionDescription(e.editingDescriptionValue,e.selectedAction.description)))},250):e.startEditDescription()},e.startEditDescription=function(){e.starting=!0,e.isStandAlone?(e.starting=!1,e.editingDescriptionInline=!1):(e.isTrace(e.selectedAction.action_task_type)&&(e.editingDescriptionInline=!0),e.starting=!1,e.editingDescriptionValue=e.selectedAction.description)},e.syncActions=function(t){var a=function(t){e.actions.totalCount=t.total_count,e.actions.pendingCount=t.pending_count,e.actionsCount=n.getActionsClassName(e.actions.totalCount,e.actions.pendingCount),e.actionsSyncd=!0,u()},r=function(){e.actionsSyncd=!0};e.callAPI(n.syncActionCount,{params:t,successCallBack:a,failureCallBack:r})};var m=function(){e.refreshScroller("rvActionListScroller")},f=function(e,r){var o=n.getDateFromDate(e),i=" ";if(e=e||" ",r=r||" ",o&&(o=o.toLowerCase(),i=o.substring(0,1).toUpperCase()+o.substring(1,3)+" ")," "!==r){var s=r.split(":"),c=s[0],d=parseInt(c);c<10&&(r="0"+d+":"+s[1])}return e?i+t("date")(new tzIndependentDate(e),a.dateFormat)+"  "+r:r},p=function(){var t=e.reservationData.reservation_card.arrival_date,a=e.reservationData.reservation_card.arrival_time,r=f(t,a),n=e.reservationData.reservation_card.departure_date,o=e.reservationData.reservation_card.departure_time,i=f(n,o);e.hasArrivalDate=!!r,e.hasDepartureDate=!!i,e.actions.arrivalDateString=r,e.actions.departureDateString=i},v=function(t){e.callAPI(n.fetchDepartments,{successCallBack:function(a){e.departments=a.data.departments,e.departmentsCount=e.departments.length,"function"==typeof t&&t()},failureCallBack:function(){e.departmentsCount=0}})};e.selectAction=function(t){var a=t;a&&(e.selectedAction=a,a.description&&(e.lastSavedDescription=a.description),e.selectedAction.originalStatus&&(e.selectedAction.action_status=e.selectedAction.originalStatus)),e.setRightPane("selected"),e.refreshScroller("actionSummaryScroller"),e.clearAssignSection()},e.onActionSelected=function(){e.showLeftSideViewForMobile=!1},e.onBackButtonClicked=function(){e.showLeftSideViewForMobile=!0},e.setRightPane=function(t){e.actionSelected=t},e.clearNewAction=function(){e.closeSelectedCalendar(),e.closeNewCalendar(),e.newAction.notes="",e.newAction.department={value:""},e.newAction.time_due="",e.actionsSelectedDate=a.businessDate,e.newAction.hasDate=!1,e.setFreshDate()},e.$watch("newAction.department",function(t){e.departmentSelected=!!t}),e.clearErrorMessage=function(){e.errorMessage=""},e.postAction=function(){e.selectedAction="selected";var r=function(t){"failure"===t.status&&t.errors&&t.errors[0]&&(e.errorMessage=t.errors[0]),e.fetchActionsList(),e.refreshScroller("rvActionListScroller")},o=function(t){e.errorMessage=t,e.$parent.$emit("hideLoader")},i={reservation_id:e.$parent.reservationData.reservation_card.reservation_id,action_task:{description:e.newAction.notes}};if(e.newAction.department&&e.newAction.department.value&&(i.assigned_to=e.newAction.department.value),e.newAction.date_due){var s=e.newAction.dueDateObj;i.due_at=t("date")(s,a.dateFormatForAPI)+(e.newAction.time_due?"T"+e.newAction.time_due+":00":"")}e.callAPI(n.postNewAction,{params:i,successCallBack:r,failureCallBack:o})},e.reformatDateOption=function(e,t,a){var t=e.split(t),r=t[0],n=t[1],o=t[2];return r+a+n+a+o},e.setUpData=function(){var t=tzIndependentDate(a.businessDate),r=new Date(t),n=("0"+r.getDate()).slice(-2),o=("0"+(r.getMonth()+1)).slice(-2),i=r.getFullYear()+"-"+o+"-"+n;e.fromDate=i},e.setFreshDate=function(){e.newAction.hasDate=!0;var r=new tzIndependentDate(a.businessDate),n=new tzIndependentDate(e.reservationParentData.arrivalDate);e.newAction.dueDateObj=r>n?r:n,e.newAction.date_due=t("date")(e.newAction.dueDateObj,a.dateFormat),e.newAction.time_due||(e.newAction.time_due=i.roundToNextQuarter(parseInt(t("date")(e.hotel_time,"HH"),10),parseInt(t("date")(e.hotel_time,"mm"),10)))},e.actionsDateOptions={firstDay:1,changeYear:!0,changeMonth:!0,dateFormat:a.jqDateFormat,minDate:tzIndependentDate(a.businessDate),yearRange:"0:+10",onSelect:function(r,n){var o=new tzIndependentDate(i.get_date_from_date_picker(n));null!==e.dateSelection&&("select"===e.dateSelection?(e.selectedAction.due_at_date=t("date")(o,a.dateFormat),e.selectedAction.dueDateObj=o,e.selectedAction.hasDate=!0,e.usingCalendar&&e.updateAction(),e.closeSelectedCalendar()):(e.newAction.hasDate=!0,e.newAction.date_due=t("date")(o,a.dateFormat),e.newAction.dueDateObj=o,e.newAction.time_due||(e.newAction.time_due=e.timeFieldValue[0]),e.closeNewCalendar()))}},e.onTimeChange=function(){e.updateAction()},e.updateAction=function(){var r=function(){e.refreshActionList(),e.refreshScroller("rvActionListScroller")},o=function(t){t[0]&&(e.errorMessage="Internal Error Occured")},i={reservation_id:e.$parent.reservationData.reservation_card.reservation_id,action_task:{id:e.selectedAction.id}};if(e.lastSelectedItemId=e.selectedAction.id,_typeof(e.selectedAction.due_at_date)===_typeof("string")||_typeof(e.selectedAction.due_at_date)===_typeof(12345)){var s=e.selectedAction.dueDateObj||new tzIndependentDate(e.selectedAction.due_at_str);i.due_at=t("date")(s,a.dateFormatForAPI)+(e.selectedAction.due_at_time?"T"+e.selectedAction.due_at_time+":00":""),e.callAPI(n.updateNewAction,{params:i,successCallBack:r,failureCallBack:o})}},e.showCalendar=function(){r.open({template:"/assets/partials/reservationCard/Actions/rvReservationCardActionsCalendar.html"})},e.usingCalendar=!1,e.getDateObj=function(e,t){var a,r,n,o=e.split(t);return n=o[1],r=o[0],a=o[2],{day:n,month:r,year:a}},e.showSelectCalendar=function(){var a=tzIndependentDate(e.selectedAction.due_at_str);e.actionsSelectedDate=t("date")(a,"yyyy-MM-dd"),e.usingCalendar=!0,e.dateSelection="select",e.selectCalendarShow=!0},e.closeSelectedCalendar=function(){e.usingCalendar=!1,e.dateSelection=null,e.selectCalendarShow=!1},e.showNewCalendar=function(){e.dateSelection="new",e.newCalendarShow=!0,e.usingCalendar=!0},e.closeNewCalendar=function(){e.dateSelection=null,e.newCalendarShow=!1,e.usingCalendar=!1},e.initNewAction=function(){e.clearNewAction(),e.setRightPane("new"),e.showLeftSideViewForMobile=!1},e.getDefaultDueDate=function(){return new Date},e.cancelNewAction=function(){e.actions.totalCount>0?(e.lastSelectedItemId&&e.selectAction(e.actions[e.lastSelectedItemId]),e.setRightPane("selected")):e.setRightPane("none"),e.clearNewAction(),e.showLeftSideViewForMobile=!0},e.refreshingList=function(){return e.refreshing||e.refreshToEmpty},e.refreshingToNonEmpty=function(){return e.refreshing&&!e.refreshToEmpty},e.showActionsList=function(){return(e.actions.totalCount>0||e.refreshing)&&!e.refreshToEmpty},e.showErrMsg=function(){return""!==e.errorMessage},e.isOverlayRequest=function(t){return!e.isStandAlone&&e.isRequest(t.action_task_type)},e.isStandAloneAction=function(t){return!e.isTrace(t.action_task_type)&&!e.isRequest(t.action_task_type)&&!e.isAlert(t.action_task_type)},e.showActionSummary=function(){return"selected"===e.actionSelected||"selected"===e.actionSelected&&e.refreshing},e.showNewAction=function(){return"new"===e.actionSelected||e.refreshing},e.showNewActionOnly=function(){return 0===e.actions.totalCount&&"new"===e.actionSelected&&!e.refreshToEmpty},e.showEmptyActions=function(){return 0===e.actions.totalCount&&"none"===e.actionSelected||e.refreshToEmpty},e.postActionEnabled=function(){return!e.newAction.hasDate||!e.newAction.notes||!e.departmentSelected&&!e.isStandAlone},e.showAssignScreen=function(){return"assign"===e.actionSelected||"assign"===e.actionSelected&&e.refreshing},e.refreshActionList=function(t,a){v();var r=function(r){var o=r.business_date_time.split("T");e.hotel_time=o[0]+"T"+o[1].split(/[+-]/)[0];var i=r.data;e.actions.totalCount=r.action_count,e.actions.pendingCount=r.pending_action_count,e.actionsCount=n.getActionsClassName(e.actions.totalCount,e.actions.pendingCount);var s,c,d=!1;if(i.length>=e.actions.length)for(var l in i){s=i[l],d=!1;for(var u in e.actions)c=e.actions[u],c.id===s.id&&(e.isStandAlone?(e.actions[u]=s,d=!0):e.isStandAlone||("delete"===t&&a?a.id===s.id&&(d=!0):(e.actions[u]=s,d=!0)));d||e.actions.push(s)}for(var f in e.actions)a&&e.actions[f].id===a.id&&(e.actions[f].is_deleted=!0,m());p(),e.showLeftSideViewForMobile=!0;var v=e.isStandAlone;if(e.lastSelectedItemId){for(var _ in e.actions)if(v)e.lastSelectedItemId===e.actions[_].id&&e.selectAction(e.actions[_]);else if(!e.isStandAlone)if(e.lastSelectedItemId!==e.actions[_].id||t)if(e.actions[0].is_deleted)if(e.actions[_].is_deleted){for(var u in e.actions)if(!e.actions[u].is_deleted){e.selectAction(e.actions[u]),e.$parent.$emit("hideLoader");break}}else e.selectAction(e.actions[_]);else e.selectAction(e.actions[0]);else e.selectAction(e.actions[_])}else e.setDefaultActionSelected(0);e.refreshToEmpty&&(e.refreshToEmpty=!1),e.refreshing&&(e.refreshing=!1)},o=function(t){e.$parent.$emit("hideLoader"),e.refreshToEmpty=!1,e.refreshing=!1,e.showLeftSideViewForMobile=!0};e.callAPI(n.getActionsTasksList,{params:{id:e.$parent.reservationData.reservation_card.reservation_id},successCallBack:r,failureCallBack:o})},e.hasActionStatus=function(){return!!e.actions&&("none"===e.actionSelected||"new"===e.actionSelected||!!((e.actions.totalCount>0||e.refreshing)&&!e.refreshToEmpty||0===e.actions.totalCount&&"none"===e.actionSelected||e.refreshToEmpty))},e.isDeletePending=function(e,t){for(var a in t)if(t[a]===e)return!0;return!1};var D=function(e,t){return e=e||"",t=t||"",e.toUpperCase()===t.toUpperCase()};e.isAlert=function(e){return D("ALERT",e)},e.isRequest=function(e){return D("REQUEST",e)},e.isTrace=function(e){return D("TRACE",e)},e.isMessage=function(e){return D("MESSAGE",e)},e.fetchActionsList=function(){d.start("FETCH_ACTIONS_LIST");var t=function(t){var a=t.business_date_time.split("T");e.hotel_time=a[0]+"T"+a[1].split(/[+-]/)[0],e.actions=t.data,e.actions.totalCount=t.action_count,e.actions.pendingCount=t.pending_action_count,e.actionsCount=n.getActionsClassName(e.actions.totalCount,e.actions.pendingCount),0===e.actions.totalCount&&(e.actionSelected="none"),p(),e.actions[0]&&e.selectAction(e.actions[0]),m(),e.openingPopup?(h(),d.stop("FETCH_ACTIONS_LIST")):d.stop("FETCH_ACTIONS_LIST"),e.openingPopup=!1,e.showLeftSideViewForMobile=!0},a=function(){p(),d.stop("FETCH_ACTIONS_LIST"),e.showLeftSideViewForMobile=!0};v(function(){e.callAPI(n.getActionsTasksList,{params:{id:e.$parent.reservationData.reservation_card.reservation_id},successCallBack:t,failureCallBack:a})})},e.setDefaultActionSelected=function(t){t=t||0,e.actions[t]&&e.selectAction(e.actions[t])},e.populateTimeFieldValue=function(){var t=function(e){var t=parseInt(e.substring(0,2)),a=(t+11)%12+1,r=t>11?" PM":" AM",n=e.substring(2);return parseInt(a)<10&&(a="0"+a),a+":"+n+r};e.timeFieldValue=[];for(var a in e.timeFieldValues)e.timeFieldValue.push({value:t(e.timeFieldValues[a]),core_time:e.timeFieldValues[a]})},e.timeFieldValue=[];var h=function(){var t="/assets/partials/reservationCard/actions/rvReservationCardActionsPopup.html";a.isStandAlone||(t="/assets/partials/reservationCard/actions/overlay/rvReservationCardActionsPopupOverlay.html"),r.open({template:t,className:"ngdialog-theme-default",scope:e,closeByDocument:!1,closeByEscape:!1})};e.openActionsPopup=function(){e.openingPopup=!0,e.fetchActionsList()},e.clearAssignSection=function(){e.departmentSelect.selected={},e.closeSelectedCalendar(),e.closeNewCalendar()};var y=function(t){var a=function(){e.showLeftSideViewForMobile=!0,e.actionSelected="selected",e.lastSelectedItemId=t.action_task.id,e.refreshActionList(),e.clearAssignSection()},r=function(t){t[0]&&(e.errorMessage="Internal Error Occured"),e.$parent.$emit("hideLoader")};e.callAPI(n.updateNewAction,{params:t,successCallBack:a,failureCallBack:r})};e.departmentSelect={};var g=function(t){var a="delete"===t;e.isRefreshing=!0;var r=e.actions.totalCount-1<=0;a&&r?(e.refreshToEmpty=!0,e.actionSelected="none",e.actions.totalCount=0,e.recountAfterDelete=!0):(e.refreshing=!0,e.refreshToEmpty=!1,e.actionSelected="selected")};e.completeAction=function(t,a){var r=e.getBaseParams();r.action_task.id=e.selectedAction.id,r.is_complete=!0,g(t);var o=function(){e.actions.totalCount--,e.lastSelectedItemId=r.action_task.id,e.refreshActionList(t,a),e.actions.totalCount-1<=1&&"delete"!==t&&(e.actionSelected="selected"),e.isRefreshing=!1,e.refreshScroller("actionSummaryScroller")},i=function(t){e.errorMessage=t,e.$parent.$emit("hideLoader"),e.isRefreshing=!1};e.callAPI(n.completeAction,{params:r,successCallBack:o,failureCallBack:i})},e.getBaseParams=function(){return{reservation_id:e.$parent.reservationData.reservation_card.reservation_id,action_task:{}}},e.getActionStatusInfo=function(e){var t=e.action_status;return"delete"===t?t="Delete Action?":e.over_due&&"COMPLETED"!==t&&(t="OVERDUE"),t},e.shouldShowEditAndCompleteBtns=function(e){return["UNASSIGNED","ASSIGNED"].indexOf(e.action_status)>-1},e.shouldShowDeleteBtn=function(e){return["UNASSIGNED","ASSIGNED","COMPLETED"].indexOf(e.action_status)>-1},e.prepareEditAction=function(t){e.actionSelected="edit";var a=t.assigned_to,r="";a&&a.id&&(r=_.findWhere(e.departments,{value:a.id+""})),e.newAction={department:r,time_due:t.due_at_time,date_due:t.due_at_date,dueDateObj:new tzIndependentDate(t.time_due_str.split("T")[0]),hasDate:!0,notes:t.description,actionId:t.id}};var C=function(){var r=e.getBaseParams();if(r.action_task.id=e.newAction.actionId,e.newAction.department?r.assigned_to=e.newAction.department.value:r.assigned_to="",e.newAction.dueDateObj){var n=e.newAction.dueDateObj;r.due_at=t("date")(n,a.dateFormatForAPI)+(e.newAction.time_due?"T"+e.newAction.time_due+":00":"")}return e.newAction.notes&&(r.action_task.description=e.newAction.notes),r};e.handleActionUpdate=function(){var e=C();y(e)},e.cancel=function(){e.showLeftSideViewForMobile=!0,e.actionSelected=e.actions.totalCount?"selected":"none"},e.hasPermissionToEditAction=function(){return l.getPermissionValue("EDIT_ACTION")},e.prepareDeletAction=function(){e.selectedAction.originalStatus=e.selectedAction.action_status,e.selectedAction.action_status="delete"},e.deleteAction=function(){var t=function(){e.fetchActionsList(),e.refreshScroller("rvActionListScroller")},a=function(t){t[0]&&(e.errorMessage="Internal Error Occured")},r={params:e.selectedAction.id,onSuccess:t,onFailure:a};e.callAPI(n.deleteActionTask,r)},e.hasPermissionToDeleteAction=function(){return l.getPermissionValue("DELETE_ACTION")},e.cancelDelete=function(){e.selectedAction.action_status=e.selectedAction.originalStatus,e.showLeftSideViewForMobile=!0},e.getActionStatusClass=function(e){return"delete"===e.action_status?e.originalStatus:e.action_status},e.addListener("UPDATE_COMPANY_NAME_IN_STAYCARD",function(t,a){e.reservationData.reservation_card.company_card_name=a.name}),e.addListener("UPDATE_TA_NAME_IN_STAYCARD",function(t,a){e.reservationData.reservation_card.travel_agent_card_name=a.name}),function(){var t={scrollbars:!0,preventDefault:!1,fadeScrollbars:!0,click:!0};e.isStandAlone=a.isStandAlone,e.showLeftSideViewForMobile=!0,e.$parent.reservationData.reservation_card.reservation_id&&(e.reservationId=e.$parent.reservationData.reservation_card.reservation_id),e.populateTimeFieldValue(),e.setScroller("rvActionListScroller",t),e.setScroller("actionSummaryScroller",t),e.setScroller("reservation-card-actions-scroller",t),e.setUpData(),e.isStandAlone||e.syncActions(e.reservationId),u(),c(function(){e.refreshScroller("reservation-card-actions-scroller")},500)}()}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){sntRover.controller("rvReservationCardActivityLogCtrl",["$scope","$filter","$stateParams","$rootScope","$state","$timeout",function(e,t,a,r,n,o){e.activityLog="";var i=function(){var t=!0;e.activityLog={hideDetails:t}};e.toggleActivityLogDetails=function(){e.activityLog.hideDetails=!e.activityLog.hideDetails,e.refreshScroller("resultDetails"),o(function(){e.$parent.myScroll.resultDetails.scrollTo(e.$parent.myScroll.resultDetails.maxScrollX,e.$parent.myScroll.resultDetails.maxScrollY,500)},500)},e.showDetails=function(){n.go("rover.reservation.staycard.activitylog",{id:e.reservationData.reservation_card.reservation_id})},i()}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){sntRover.controller("reservationCardController",["$rootScope","$scope","RVReservationCardSrv","RVGuestCardSrv","rvPermissionSrv","$filter","$state","$stateParams",function(e,t,a,r,n,o,i,s){BaseCtrl.call(this,t),t.timeline="",t.reservationList=[],t.currentReservationId="",t.reservationCount=0,t.viewState.identifier="STAY_CARD",t.heading="Staycard",t.setHeadingTitle(t.heading);var c="Staycard";t.setTitle(c),t.prevTimeLineEmpty=!1,t.reservationCardClick=function(){t.$emit("reservationCardClicked")},t.isIpad=null!==navigator.userAgent.match(/iPad/i),t.$on("SHOW_GUEST_ID_LIST",function(e,a){t.shouldShowGuestDetails=a.shouldShowGuestDetails}),t.hasPermissionToSkipIdScan=n.getPermissionValue("ID_SCAN_BYPASS"),t.$on("passReservationParams",function(e,r){t.$emit("staycardGuestData",r),t.data=r,t.timeline=r.reservation_details.timeline,t.countCurrent=r.reservation_list.current_reservations_arr.length,t.countUpcoming=r.reservation_list.upcoming_reservations_arr.length,t.countHistory=r.reservation_list.history_reservations_arr.length,t.currentReservationId=r.confirmationNumber,a.setGuestData(t.data.guest_details);if("undefined"!=typeof t.data.guest_details.reservation_id&&null!==t.data.guest_details.reservation_id){var n=({fakeDataToAvoidCache:new Date,id:t.data.guest_details.reservation_id},{user_id:t.data.guest_details.user_id,guest_id:t.data.guest_details.guest_id});t.$emit("SETGUESTDATA",n),t.showGuestPaymentList(n)}"current"===t.timeline&&(t.reservationList=r.reservation_list.current_reservations_arr,t.reservationDisplayStatus=t.countCurrent>0),"upcoming"===t.timeline&&(t.reservationList=r.reservation_list.upcoming_reservations_arr,t.reservationDisplayStatus=t.countUpcoming>0),"history"===t.timeline&&(t.reservationList=r.reservation_list.history_reservations_arr,t.reservationDisplayStatus=t.countHistory>0),a.setGuestData(t.data.guest_details)}),t.showTimeLineReservation=function(e){t.timeline=e;var a=0;"current"===e?(t.reservationList=t.data.reservation_list.current_reservations_arr,a=t.countCurrent):"upcoming"===e?(t.reservationList=t.data.reservation_list.upcoming_reservations_arr,a=t.countUpcoming):"history"===e&&(t.reservationList=t.data.reservation_list.history_reservations_arr,a=t.countHistory),a>0&&!t.prevTimeLineEmpty?t.reservationDisplayStatus=!0:t.reservationDisplayStatus=!1,a>0?(t.prevTimeLineEmpty=!1,t.currentReservationId=t.reservationList[0].confirmation_num,t.getReservationDetails(t.reservationList[0].confirmation_num,t.reservationList[0].id)):(t.prevTimeLineEmpty=!0,t.currentReservationId="",t.$broadcast("RESERVATIONDETAILS",t.currentReservationId)),t.$broadcast("RESERVATIONLISTUPDATED")},t.$on("REFRESH_LIST_SCROLL",function(){t.$broadcast("RESERVATIONLISTUPDATED")}),t.getReservationDetails=function(e,a){t.clearArrivalAndDepartureTime(),t.$parent.refreshingReservation=!0,a!==t.reservationData.reservationId?i.go("rover.reservation.staycard.reservationcard.reservationdetails",{id:a,confirmationId:e,isrefresh:!0,isOnlineRoomMove:""}):i.reload(i.$current.name)},t.showGuestPaymentList=function(e){var a=e.user_id,n=e.guest_id,o=function(e){t.$emit("hideLoader");var e={data:e,user_id:a,guest_id:n};t.$emit("GUESTPAYMENTDATA",e),t.$emit("SHOWGUESTLIKES")};"true"===s.isrefresh&&t.invokeApi(r.fetchGuestPaymentData,a,o,"","NONE")}}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){sntRover.controller("rvReservationCardHKController",["$scope","$filter","$stateParams","$rootScope","$state","$timeout","rvReservationHouseKeepingSrv",function(e,t,a,r,n,o,i){BaseCtrl.call(this,e),e.toggleService=function(){e.houseKeeping.serviceEnabled=!e.houseKeeping.serviceEnabled,e.save({is_room_service_opted:e.houseKeeping.serviceEnabled})},e.selectDefaultTask=function(t){var a;(t.default_task||t.old_default_task!=t.default_task)&&(a={old_task_id:t.old_default_task,new_task_id:t.default_task},t.old_default_task=t.default_task,e.save(a))};var s=function(){e.houseKeeping.hideDetails=!e.houseKeeping.hideDetails,e.refreshScroller("resultDetails"),o(function(){e.$parent.myScroll.resultDetails.scrollTo(e.$parent.myScroll.resultDetails.maxScrollX,e.$parent.myScroll.resultDetails.maxScrollY,500)},500)},c=function(e){},d=function(t){e.errorMessage=t};e.save=function(t){var a=_.extend(t,{reservation_id:e.reservationData.reservation_card.reservation_id}),r={params:a,successCallBack:c,failureCallBack:d};e.callAPI(i.save,r)};var l=function(t){e.houseKeeping.workTypes=t.work_types,e.houseKeeping.serviceEnabled=t.is_room_service_opted,e.houseKeeping.reservationTasks=t.reservation_tasks,e.houseKeeping.defaultWorkTyoe=t.default_work_type,e.houseKeeping.workTypes.forEach(function(t){t.default_task="",t.old_default_task="";var a=_.findWhere(e.houseKeeping.reservationTasks,{work_type_id:t.id});a&&(t.default_task=a.task_id,t.old_default_task=a.task_id)}),m=!0,s()},u=function(t){e.errorMessage=t},m=!1,f=function(){var t={params:{reservation_id:e.reservationData.reservation_card.reservation_id},successCallBack:l,failureCallBack:u};e.callAPI(i.fetch,t)};(function(){e.houseKeeping={},e.houseKeeping.serviceEnabled=!0,e.houseKeeping.hideDetails=!0,e.roomAttendance=!1})();e.toggleHKDetails=function(){e.roomAttendance=!e.roomAttendance,m?s():f()}}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){sntRover.controller("rvReservationCardLoyaltyController",["$rootScope","$scope","ngDialog","RVLoyaltyProgramSrv",function(e,t,a,r){BaseCtrl.call(this,t);var n={};t.isLoyaltySelected=function(){t.showSelectedLoyalty=!0;var e=t.$parent.reservationData.reservation_card.loyalty_level.selected_loyalty;null!==e&&"undefined"!=typeof e&&""!==e&&e!=={}||(t.showSelectedLoyalty=!1)},t.showLoyaltyProgramDialog=function(){var e={template:"/assets/partials/reservationCard/rvGMSLoyality.html",controller:"rvGMSLoyalityController",className:"ngdialog-theme-default",scope:t,data:n,preCloseCallback:t.loadLoyaltyPrograms},r={template:"/assets/partials/reservationCard/rvAddLoyaltyProgramDialog.html",controller:"rvAddLoyaltyProgramController",className:"ngdialog-theme-default",scope:t};t.$parent.isNewsPaperPreferenceAvailable()&&(n.GMSSettings&&n.GMSSettings.membership_feature&&n.GMSSettings.enabled?a.open(e):a.open(r))},t.$on("loyaltyProgramAdded",function(e,a,r){"HLP"===a.membership_class?t.$parent.reservationData.reservation_card.loyalty_level.hotelLoyaltyProgram.push(a):t.$parent.reservationData.reservation_card.loyalty_level.frequentFlyerProgram.push(a),"fromReservationCard"===r&&(t.$parent.reservationData.reservation_card.loyalty_level.selected_loyalty=a.id,t.selectedLoyaltyID=a.id,t.selectedLoyalty=a,_.isString(t.selectedLoyalty.membership_card_number)&&(t.selectedLoyalty.membership_card_number=t.selectedLoyalty.membership_card_number.substr(t.selectedLoyalty.membership_card_number.length-4))),t.$parent.reservationCardSrv.updateResrvationForConfirmationNumber(t.$parent.reservationData.reservation_card.confirmation_num,t.$parent.reservationData),t.isLoyaltySelected()}),t.$on("loyaltyProgramDeleted",function(e,a,r,n){"FFP"===n?t.$parent.reservationData.reservation_card.loyalty_level.frequentFlyerProgram.splice(r,1):t.$parent.reservationData.reservation_card.loyalty_level.hotelLoyaltyProgram.splice(r,1);var o=t.selectedLoyalty;o&&a===o.id&&(t.$parent.reservationData.reservation_card.loyalty_level.selected_loyalty=null,t.selectedLoyaltyID=""),t.$parent.reservationCardSrv.updateResrvationForConfirmationNumber(t.$parent.reservationData.reservation_card.confirmation_num,t.$parent.reservationData),t.isLoyaltySelected()}),t.setSelectedLoyaltyForID=function(a){var r=t.$parent.reservationData.reservation_card.loyalty_level.hotelLoyaltyProgram,n=t.$parent.reservationData.reservation_card.loyalty_level.frequentFlyerProgram,o=(t.$parent.reservationData.use_ffp,t.$parent.reservationData.use_hlp,!1);if(null!==r&&e.isHLPActive)for(var i=0;i<r.length;i++)if(parseInt(a,10)===parseInt(r[i].id,10)){o=!0,t.selectedLoyalty=r[i],t.selectedLoyaltyID=r[i].id,t.$parent.reservationData.reservation_card.loyalty_level.selected_loyalty=r[i].id;break}if(o)return!0;if(null!==n&&e.isFFPActive)for(var i=0;i<n.length;i++)if(parseInt(a,10)===parseInt(n[i].id,10)){o=!0,t.selectedLoyalty=n[i],t.selectedLoyaltyID=n[i].id,t.$parent.reservationData.reservation_card.loyalty_level.selected_loyalty=n[i].id;break}return o},t.setSelectedLoyalty=function(e){var a=t.setSelectedLoyaltyForID(e);a||(t.selectedLoyalty="",t.selectedLoyaltyID="",t.$parent.reservationData.reservation_card.loyalty_level.selected_loyalty=""),t.isLoyaltySelected()},t.loadLoyaltyPrograms=function(){(t.$parent.$parent.refreshingReservation||t.reservationData.justCreatedRes)&&(e.goToReservationCalled=!0,e.$broadcast("reload-loyalty-section-data",{reload:!0}))},t.callSelectLoyaltyAPI=function(e){t.selectedLoyaltyID=e;var a=function(){t.setSelectedLoyalty(t.selectedLoyaltyID),t.$parent.reservationCardSrv.updateResrvationForConfirmationNumber(t.$parent.reservationData.reservation_card.confirmation_num,t.$parent.reservationData),t.isLoyaltySelected(),t.$parent.$emit("hideLoader")},n=function(e){t.setSelectedLoyalty(t.$parent.reservationData.reservation_card.loyalty_level.selected_loyalty),t.isLoyaltySelected(),t.$parent.$emit("hideLoader"),t.$parent.errorMessage=e},o={};o.reservation_id=t.$parent.reservationData.reservation_card.reservation_id,o.membership_id=t.selectedLoyaltyID,t.invokeApi(r.selectLoyalty,o,a,n)},t.$on("detect-hlps-ffp-active-status",function(e,a){a.userMemberships.use_hlp?(t.loyaltyProgramsActive(!0),t.$parent.reservationData.use_hlp=!0):(t.loyaltyProgramsActive(!1),t.$parent.reservationData.use_hlp=!1),a.userMemberships.use_ffp?(t.ffpProgramsActive(!0),t.$parent.reservationData.use_ffp=!0):(t.ffpProgramsActive(!1),t.$parent.reservationData.use_ffp=!1)}),t.loyaltyProgramsActive=function(e){t.hotelLoyaltyProgramEnabled=e,t.$parent.reservationData.use_hlp=e},t.ffpProgramsActive=function(e){t.hotelFrequentFlyerProgramEnabled=e,t.$parent.reservationData.use_ffp=e;
},t.shouldShowLoyalty=function(){var e=t.reservationData.use_hlp||t.reservationData.use_ffp||t.$parent.reservationData.use_hlp||t.$parent.reservationData.use_ffp||t.reservationData.reservation_card.loyalty_level&&t.reservationData.reservation_card.loyalty_level.use_ffp||t.reservationData.reservation_card.loyalty_level&&t.reservationData.reservation_card.loyalty_level.use_hlp;return e};var o=function(){var e={},a=function(e){n.GMSSettings=e},o={params:e,successCallBack:a};t.callAPI(r.getGMSSettings,o)},i=function(){t.selectedLoyaltyID="",t.selectedLoyalty={},n.guestInfo=t.reservationParentData.guest,t.hotelLoyaltyProgramEnabled=!0,t.setSelectedLoyaltyForID(t.$parent.reservationData.reservation_card.loyalty_level.selected_loyalty),t.isLoyaltySelected(),o()};i()}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){sntRover.controller("reservationCardNewspaperController",["$scope",function(e){e.message="Newspaper Test"}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){sntRover.controller("rvReservationCardNotesController",["$scope","$filter","$rootScope","ngDialog","$state","RVReservationNotesService","sntActivity",function(e,t,a,r,n,o,i){BaseCtrl.call(this,e),e.reservationNotes="",e.isCountUpdated=a.isStandAlone;var s=function(){e.setScroller("reservationNotes"),e.notesCount=e.reservationListData.note_count,a.isStandAlone||e.callAPI(o.sync,{loader:"NONE",params:e.reservationData.reservation_card.reservation_id,successCallBack:function(t){e.notesCount=t,e.isCountUpdated=!0},failureCallBack:function(t){e.errorMessage=t,e.isCountUpdated=!0}})};e.openNotesPopup=function(){e.isCloudStorageEnabledForCardType("stay_card")?r.open({template:"/assets/directives/fileCloudStorage/partials/rvReservationCardNotesAndFiles.html",className:"ngdialog-theme-default",scope:e,closeByDocument:!1,closeByEscape:!1}):(i.start("FETCH_NOTES"),e.callAPI(o.fetch,{params:e.reservationData.reservation_card.reservation_id,successCallBack:function(t){e.reservationData.reservation_card.notes=e.reservationData.reservation_card.notes||{},e.reservationData.reservation_card.notes.reservation_notes=t,r.open({template:"/assets/partials/reservationCard/rvReservationCardNotesPopup.html",className:"ngdialog-theme-default",scope:e,closeByDocument:!1,closeByEscape:!1}),i.stop("FETCH_NOTES")},failureCallBack:function(t){e.errorMessage=t,i.stop("FETCH_NOTES")}}))},e.navigateToGroup=function(t){a.isStandAlone&&e.reservationData.reservation_card.group_id?n.go("rover.groups.config",{id:e.reservationData.reservation_card.group_id,activeTab:"SUMMARY"}):t.preventDefault()},e.isGroupCardAttachedToReservation=function(){return e.reservationDetails&&e.reservationDetails.group&&""!==e.reservationDetails.group.id.trim()},e.isCompanyCardAttachedToReservation=function(){return e.reservationDetails&&e.reservationDetails.companyCard&&""!==e.reservationDetails.companyCard.id.toString().trim()},e.isTravelAgentAttachedToReservation=function(){return e.reservationDetails&&e.reservationDetails.travelAgent&&""!==e.reservationDetails.travelAgent.id.toString().trim()},e.isAllotmentCardAttachedToReservation=function(){return e.reservationDetails&&e.reservationDetails.allotment&&""!==e.reservationDetails.allotment.id.toString().trim()},e.noCardAttachedToReservation=function(){return!(e.isGroupCardAttachedToReservation()||e.isCompanyCardAttachedToReservation()||e.isTravelAgentAttachedToReservation()||e.isAllotmentCardAttachedToReservation())},e.closeDialog=function(){e.reservationData.reservation_card.notes&&_.isArray(e.reservationData.reservation_card.notes.reservation_notes)&&(e.notesCount=e.reservationData.reservation_card.notes.reservation_notes.length),r.close()},e.$on("NOTES_COUNT_UPDATED",function(t,a){a&&(e.notesCount=a.length)}),s()}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){sntRover.controller("reservationDetailsController",["$scope","$rootScope","rvPermissionSrv","RVReservationCardSrv","RVCCAuthorizationSrv","$stateParams","reservationListData","reservationDetails","ngDialog","RVSaveWakeupTimeSrv","$filter","RVNewsPaperPreferenceSrv","RVLoyaltyProgramSrv","$state","RVSearchSrv","$vault","RVReservationSummarySrv","baseData","$timeout","paymentTypes","reseravationDepositData","dateFilter","RVReservationStateService","RVReservationBaseSearchSrv","RVReservationPackageSrv","transitions","taxExempts","sntActivity","$ocLazyLoad",function(e,t,a,r,n,o,i,s,c,d,l,u,m,f,p,v,D,h,y,g,C,A,S,I,T,E,R,b,N){var P,k,O={DUEIN:"DASHBOARD_SEARCH_CHECKINGIN",DUEOUT:"DASHBOARD_SEARCH_CHECKINGOUT",INHOUSE:"DASHBOARD_SEARCH_INHOUSE",LATE_CHECKOUT:"DASHBOARD_SEARCH_LATECHECKOUT",VIP:"DASHBOARD_SEARCH_VIP",NORMAL_SEARCH:"SEARCH_NORMAL"},w="rover.reservation.staycard.mainCard.room-rates",M=t.maxStayLength,L=function(){t.stayCardStateBookMark={previousState:e.previousState.name,previousStateParams:e.previousStateParams}},x=470;e.hasOverBookRoomTypePermission=a.getPermissionValue("OVERBOOK_ROOM_TYPE"),e.hasOverBookHousePermission=a.getPermissionValue("OVERBOOK_HOUSE"),e.hasBorrowFromHousePermission=a.getPermissionValue("GROUP_HOUSE_BORROW"),e.showRightContentForMobile=!1,e.shouldShowTaxExempt=function(){return a.getPermissionValue("TAX_EXEMPT")&&e.taxExemptTypes.length},e.taxExemptTypes=R.results;var F=_.findWhere(e.taxExemptTypes,{is_default:!0});if(e.defaultTaxExemptTypeId="","undefined"!=typeof F&&(e.defaultTaxExemptTypeId=F.id),e.hasSRViewPermission=a.getPermissionValue("VIEW_SUPPRESSED_RATE"),S.setReservationFlag("isSRViewRateBtnClicked",!1),e.guestIdAdminEnabled=t.hotelDetails.guest_id_scan.view_scanned_guest_id,e.hasGuestIDPermission=a.getPermissionValue("ACCESS_GUEST_ID_DETAILS"),t.stayCardStateBookMark||L(),"rover.financials.ccTransactions"===e.previousState.name||"rover.financials.ccTransactions"===t.stayCardStateBookMark.previousState)L(),t.setPrevState={title:"CC TRANSACTIONS",name:"rover.financials.ccTransactions",param:{isRefresh:!1}};else if("rover.actionsManager"===e.previousState.name)L(),t.setPrevState={title:"ACTIONS MANAGER",name:"rover.actionsManager",param:{restore:!0}};else if("rover.groups.config"===e.previousState.name||"rover.groups.config"===t.stayCardStateBookMark.previousState)"rover.groups.config"===e.previousState.name&&L(),t.setPrevState={title:"GROUP DETAILS",name:"rover.groups.config",param:{id:t.stayCardStateBookMark.previousStateParams.id,activeTab:"ROOMING"}};else if("rover.financials.autoCharge"===e.previousState.name)t.setPrevState={title:"AUTO CHARGE",name:"rover.financials.autoCharge",param:{isFromStayCard:!0}};else if("rover.financials.invoiceSearch"===e.previousState.name)t.setPrevState={title:"INVOICE SEARCH",name:"rover.financials.invoiceSearch",param:{isFromStayCard:!0}};else if("rover.allotments.config"===e.previousState.name||"rover.allotments.config"===t.stayCardStateBookMark.previousState)"rover.allotments.config"===e.previousState.name&&L(),t.setPrevState={title:"ALLOTMENT DETAILS",name:"rover.allotments.config",param:{id:t.stayCardStateBookMark.previousStateParams.id,activeTab:"RESERVATIONS"}};else if(o.isFromCards){var B=o.isFromArTab;L(),t.setPrevState={title:"AR Transactions",name:"rover.companycarddetails",param:{id:v.get("cardId"),type:v.get("type"),query:v.get("query"),isBackFromStaycard:!0,isBackFromStaycardToARTab:B}}}else if("rover.nightlyDiary"===e.previousState.name||"rover.nightlyDiary"===t.stayCardStateBookMark.previousState)"rover.nightlyDiary"===e.previousState.name&&L(),t.setPrevState={title:"ROOM DIARY",name:"rover.nightlyDiary",param:{id:t.stayCardStateBookMark.previousStateParams.id,activeTab:"DIARY",origin:"STAYCARD"}};else if("rover.diary"===e.previousState.name)L(),t.setPrevState={title:"ROOM DIARY",name:"rover.diary",param:{id:t.stayCardStateBookMark.previousStateParams.id,activeTab:"DIARY",origin:"STAYCARD"}};else if(o.isFromDiary&&!t.isReturning())L(),t.setPrevState={title:"Room Diary"};else if(E.get().from().name.match(/rover\.reports/))t.setPrevState={title:"REPORTS",name:E.get().from().name,param:angular.extend(angular.copy(E.get().params("from")),{action:"report.show.last"})};else if(o.isFromCardStatistics)L(),t.setPrevState={title:"Card Statistics",name:"rover.companycarddetails",param:{id:v.get("cardId"),type:v.get("type"),isBackToStatistics:!0,isBackFromStaycard:!0,selectedStatisticsYear:v.get("selectedYear")}};else if("rover.companycarddetails"===e.previousState.name||e.$parent.reservationData.wasFromCard){L();var G=o.isFromTACommission||e.$parent.reservationData.isFromTACommission;t.setPrevState={title:"TRAVEL Agent",name:"rover.companycarddetails",param:{id:v.get("travelAgentId"),type:v.get("travelAgentType"),query:v.get("travelAgentQuery"),isBackToTACommission:G,isBackFromStaycard:!0,origin:G?"COMMISION_SUMMARY":""}},e.$parent.reservationData.wasFromCard=!0,e.$parent.reservationData.isFromTACommission=angular.copy(o.isFromTACommission)}else o.isFromGuestStatistics?t.setPrevState={title:"Guest Statistics",name:"rover.guest.details",param:{guestId:v.get("guestId"),selectedStatisticsYear:v.get("selectedYear"),isBackToStatistics:!0}}:(L(),o.justCreatedRes||e.otherData.reservationCreated?(P=O.NORMAL_SEARCH,k={type:"RESET"}):(P=O[v.get("searchType")]?O[v.get("searchType")]:O.NORMAL_SEARCH,k={type:v.get("searchType")},"BY_SWIPE"===v.get("searchType")&&(k={type:"BY_SWIPE"})),t.setPrevState={title:l("translate")(P),scope:e,callback:"goBackSearch"},e.goBackSearch=function(){e.$emit("showLoader"),e.updateSearchCache(),k=k||{},k.useCache=!0,k.isBulkCheckoutSelected=o.isBulkCheckoutSelected,k.isAllowOpenBalanceCheckoutSelected=o.isAllowOpenBalanceCheckoutSelected,k.isBulkCheckinSelected="true"===v.get("isBulkCheckinSelected"),f.go("rover.search",k)});var V,U={dateFormat:t.jqDateFormat,minDate:l("date")(t.businessDate,t.dateFormat),numberOfMonths:1,changeYear:!0,changeMonth:!0,beforeShow:function(e,t){$("#ui-datepicker-div").addClass("reservation hide-arrow"),$('<div id="ui-datepicker-overlay">').insertAfter("#ui-datepicker-div"),setTimeout(function(){$("body").find("#ui-datepicker-overlay").on("click",function(){$("#room-out-from").blur(),$("#room-out-to").blur()})},100)},onClose:function(e){$("#ui-datepicker-div").removeClass("reservation hide-arrow"),$("#ui-datepicker-overlay").off("click").remove()}},q=function(){var t=function(e){V=e,b.stop("GUEST_ID_FETCH")},a=function(){b.stop("GUEST_ID_FETCH")},n={reservation_id:e.reservationData.reservation_card.reservation_id};b.start("GUEST_ID_FETCH"),e.invokeApi(r.fetchGuestIdentity,n,t,a)},H=function(){var t=e.reservationData.reservation_card.reservation_id,a=function(t){e.$emit("hideLoader"),e.packageData=t,angular.forEach(e.packageData.existing_packages,function(e,t){e.totalAmount=e.addon_count*e.amount})};e.invokeApi(T.getReservationPackages,t,a)};e.activeWakeUp=!1,e.reservationData.isSameCard=!1,e.guestCardData.cardHeaderImage=i.guest_details.avatar,e.guestCardData.nationality_id=i.guest_details.nationality_id,e.guestCardData.contactInfo.address||(e.guestCardData.contactInfo.address={},e.guestCardData.contactInfo.address.country_id=i.guest_details.country_id);var Y=e.$parent.$parent.$parent.$parent;Y.callFromChildCtrl(h),BaseCtrl.call(this,e),e.reservationCardSrv=r;var j=e.$parent.reservationData;e.reservationParentData=e.$parent.reservationData,e.reservationData=s,e.getReservationMaxDepartureDate=function(e){var t=tzIndependentDate(e),a=l("date")(t,"yyyy-MM-dd"),r=a.match(/(\d+)/g);return new Date(r[0],parseInt(r[1])-1,parseInt(r[2],10)+M)},e.editStore={arrival:e.reservationData.reservation_card.arrival_date,departure:e.reservationData.reservation_card.departure_date};var W=function(){var a=tzIndependentDate(t.businessDate),r=tzIndependentDate(e.reservationData.reservation_card.group_shoulder_block_from),n=a>r?a:r;return"CHECKEDIN"===e.reservationData.reservation_card.reservation_status&&(n=e.editStore.arrival),l("date")(n,t.dateFormat)},K=function(){var a=tzIndependentDate(t.businessDate),r=tzIndependentDate(e.reservationData.reservation_card.allotment_block_from),n=a>r?a:r;return"CHECKEDIN"===e.reservationData.reservation_card.reservation_status&&(n=e.editStore.arrival),l("date")(n,t.dateFormat)},J=function(){var a;return a=e.reservationData.reservation_card.group_id?l("date")(e.reservationData.reservation_card.group_shoulder_block_to,t.dateFormat):e.reservationData.reservation_card.allotment_id?l("date")(e.reservationData.reservation_card.allotment_block_to,t.dateFormat):e.getReservationMaxDepartureDate(e.editStore.arrival)};e.reservationData.reservation_card.group_id&&(U=angular.extend(U,{minDate:W(),maxDate:l("date")(e.reservationData.reservation_card.group_shoulder_block_to,t.dateFormat)})),e.reservationData.reservation_card.allotment_id&&(U=angular.extend(U,{minDate:K(),maxDate:l("date")(e.reservationData.reservation_card.allotment_block_to,t.dateFormat)})),e.arrivalDateOptions=angular.copy(U),e.departureDateOptions=angular.copy(U),e.departureDateOptions.maxDate=J(),e.arrivalDateChanged=function(){e.departureDateOptions.maxDate=e.reservationData.reservation_card.group_id?l("date")(e.reservationData.reservation_card.group_shoulder_block_to,t.dateFormat):e.getReservationMaxDepartureDate(e.editStore.arrival),e.editStore.departure=tzIndependentDate(e.editStore.departure)<=e.getReservationMaxDepartureDate(e.editStore.arrival)?e.editStore.departure:e.getReservationMaxDepartureDate(e.editStore.arrival)},e.reservationData.paymentTypes=g,e.reservationData.paymentMethods=g,e.reservationData.reseravationDepositData=C,e.reservationData.justCreatedRes="undefined"!=typeof o.justCreatedRes&&""!==o.justCreatedRes&&null!==o.justCreatedRes&&"true"===o.justCreatedRes,e.updateSearchCache=function(){var t={room:e.reservationData.reservation_card.room_number,reservation_status:e.reservationData.reservation_card.reservation_status,roomstatus:e.reservationData.reservation_card.room_status,fostatus:e.reservationData.reservation_card.fo_status,room_ready_status:e.reservationData.reservation_card.room_ready_status,is_reservation_queued:e.reservationData.reservation_card.is_reservation_queued,is_queue_rooms_on:e.reservationData.reservation_card.is_queue_rooms_on,late_checkout_time:e.reservationData.reservation_card.late_checkout_time,is_opted_late_checkout:e.reservationData.reservation_card.is_opted_late_checkout,departure_date:e.reservationData.reservation_card.departure_date};p.updateRoomDetails(e.reservationData.reservation_card.confirmation_num,t)},e.updateSearchCache(),e.$parent.$parent.reservation=s,e.reservationnote="",e.selectedLoyalty={},e.$emit("HeaderChanged",l("translate")("STAY_CARD_TITLE")),e.$watch(function(){return"undefined"!=typeof e.reservationData.reservation_card.wake_up_time.wake_up_time?e.reservationData.reservation_card.wake_up_time.wake_up_time:l("translate")("NOT_SET")},function(t){e.wake_up_time=t}),H(),e.toggleGuests=function(t){e.isFromCheckin=t,e.shouldShowGuestDetails=!e.shouldShowGuestDetails,e.shouldShowGuestDetails&&(e.shouldShowTimeDetails=!1,q()),e.$broadcast("UPDATE_ACCOMPANY_SCROLL"),!e.shouldShowGuestDetails&&e.isStandAlone&&e.$broadcast("UPDATEGUESTDEATAILS",{isBackToStayCard:!0}),e.$emit("SHOW_GUEST_ID_LIST",{shouldShowGuestDetails:t})},e.saveAccGuestDetails=function(t){setTimeout(function(){"text"==document.activeElement.getAttribute("type")||"rover.reservation.staycard.reservationcard.reservationdetails"!==f.$current.name||document.activeElement.className.search(/prevent-api-call/)||e.$broadcast("UPDATEGUESTDEATAILS",{isBackToStayCard:!1})},800)},e.$on("OPENGUESTTAB",function(t){e.toggleGuests()}),e.shouldShowTimeDetails=!1,e.toggleTime=function(){e.showEditDates=!1,e.shouldShowTimeDetails=!e.shouldShowTimeDetails},e.showEditDates=!1,e.toggleReservationDates=function(){e.shouldShowTimeDetails=!1,e.showEditDates=!e.showEditDates},angular.forEach(e.reservationData.reservation_card.loyalty_level.frequentFlyerProgram,function(t,a){e.reservationData.reservation_card.loyalty_level.selected_loyalty===t.id&&(e.selectedLoyalty=t,_.isString(e.selectedLoyalty.membership_card_number)&&(e.selectedLoyalty.membership_card_number=e.selectedLoyalty.membership_card_number.substr(e.selectedLoyalty.membership_card_number.length-4)))}),angular.forEach(e.reservationData.reservation_card.loyalty_level.hotelLoyaltyProgram,function(t,a){e.reservationData.reservation_card.loyalty_level.selected_loyalty===t.id&&(e.selectedLoyalty=t,_.isString(e.selectedLoyalty.membership_card_number)&&(e.selectedLoyalty.membership_card_number=e.selectedLoyalty.membership_card_number.substr(e.selectedLoyalty.membership_card_number.length-4)))}),e.$on("UPDATE_DEPOSIT_BALANCE",function(t,a){e.reservationData.reservation_card.balance_amount=a.reservation_balance}),e.$on("updateWakeUpTime",function(t,a){e.reservationData.reservation_card.wake_up_time=a,r.updateResrvationForConfirmationNumber(e.reservationData.reservation_card.confirmation_num,e.reservationData),e.wake_up_time="undefined"!=typeof e.reservationData.reservation_card.wake_up_time.wake_up_time?e.reservationData.reservation_card.wake_up_time.wake_up_time:l("translate")("NOT_SET")}),e.setScroller("resultDetails",{click:!0});var z={guest:e.reservationDetails.guestCard.id,company:e.reservationDetails.companyCard.id,agent:e.reservationDetails.travelAgent.id,group:e.reservationDetails.group.id,allotment:e.reservationDetails.allotment.id};t.$broadcast("reload-loyalty-section-data",{}),e.reservationDetails.guestCard.id=null===i.guest_details.user_id?"":i.guest_details.user_id,e.reservationDetails.companyCard.id=null===i.company_id?"":i.company_id,e.reservationDetails.travelAgent.id=null===i.travel_agent_id?"":i.travel_agent_id,e.reservationDetails.group.id=s.reservation_card.group_id||"",e.reservationDetails.allotment.id=s.reservation_card.allotment_id||"",angular.copy(i,e.reservationListData),e.externalReferencesExist=e.reservationListData.external_references.length>0,e.viewState.currentTab=0,e.populateDataModel(s),e.$emit("cardIdsFetched",{guest:e.reservationDetails.guestCard.id===z.guest,company:e.reservationDetails.companyCard.id===z.company,agent:e.reservationDetails.travelAgent.id===z.agent,group:e.reservationDetails.group.id===z.group,allotment:e.reservationDetails.allotment.id===z.allotment}),e.refreshReservationDetailsScroller=function(t){setTimeout(function(){e.refreshScroller("resultDetails"),e.$emit("REFRESH_LIST_SCROLL")},t)},e.$on("$viewContentLoaded",function(){e.refreshReservationDetailsScroller(500)}),e.$on("refreshScrollerReservationDetails",function(){e.refreshReservationDetailsScroller(500)}),e.reservationDetailsFetchSuccessCallback=function(t){e.$emit("hideLoader"),e.$parent.$parent.reservation=t,e.reservationData=t,e.$parent.myScroll.resultDetails.scrollTo(0,0),e.updateSearchCache()},e.$on("RESERVATIONDETAILS",function(t,a){if(a){var n={confirmationNumber:a,isRefresh:!1};e.invokeApi(r.fetchReservationDetails,n,e.reservationDetailsFetchSuccessCallback)}else e.reservationData={},e.reservationData.reservation_card={}});var Q=i;Q.avatar=i.guest_details.avatar,Q.vip=i.guest_details.vip,Q.confirmationNumber=s.reservation_card.confirmation_num,e.$emit("passReservationParams",Q),t.$on("clearErroMessages",function(){e.errorMessage=""}),e.openPaymentList=function(){e.isNewsPaperPreferenceAvailable()&&(e.reservationData.currentView="stayCard",e.$emit("SHOWPAYMENTLIST",e.reservationData))},e.$on("UPDATE_DEPOSIT_BALANCE_FLAG",function(t,a){e.isDepositBalanceScreenOpened=a}),e.$on("SWIPE_ACTION",function(t,a){e.isDepositBalanceScreenOpened?a.swipeFrom="depositBalance":e.isCancelReservationPenaltyOpened?a.swipeFrom="cancelReservationPenalty":e.isStayCardDepositScreenOpened?a.swipeFrom="stayCardDeposit":e.isGuestCardVisible?a.swipeFrom="guestCard":a.swipeFrom="stayCard","guestCard"!==a.swipeFrom&&e.$emit("isFromGuestCardFalse");var n=new SwipeOperation,o=n.createDataToTokenize(a),i=function(t){e.$emit("hideLoader"),a.token=t,e.showAddNewPaymentModel(a),e.swippedCard=!0,"guestCard"!==a.swipeFrom&&e.$emit("isFromGuestCardFalse")};e.invokeApi(r.tokenize,o,i)}),e.failureNewspaperSave=function(t){e.errorMessage=t,e.$emit("hideLoader")},e.successCallback=function(){r.updateResrvationForConfirmationNumber(e.reservationData.reservation_card.confirmation_num,e.reservationData),e.updateSearchCache(),e.$emit("hideLoader")},e.isWakeupCallAvailable=function(){var t=e.reservationData.reservation_card.reservation_status;return"CHECKEDIN"===t||"CHECKING_OUT"===t||"CHECKING_IN"===t},e.isNewsPaperPreferenceAvailable=function(){var t=e.reservationData.reservation_card.reservation_status;return"CHECKEDIN"===t||"CHECKING_OUT"===t||"CHECKING_IN"===t||"RESERVED"===t},e.saveNewsPaperPreference=function(){var t={};t.reservation_id=e.reservationData.reservation_card.reservation_id,t.selected_newspaper=e.reservationData.reservation_card.news_paper_pref.selected_newspaper,e.invokeApi(u.saveNewspaperPreference,t,e.successCallback,e.failureNewspaperSave)},e.showFeatureNotAvailableMessage=function(){c.open({template:"/assets/partials/reservationCard/rvFeatureNotAvailableDialog.html",className:"ngdialog-theme-default",scope:e})},e.deleteModal=function(){c.close()},e.showWakeupCallDialog=function(){return e.isWakeupCallAvailable()?(e.wakeupData=e.reservationData.reservation_card.wake_up_time,void c.open({template:"/assets/partials/reservationCard/rvSetWakeupTimeDialog.html",controller:"rvSetWakeupcallController",className:"ngdialog-theme-default",scope:e})):void e.showFeatureNotAvailableMessage()},e.shouldDisableGuestsButton=function(){var t=e.reservation.reservation_card.reservation_status;return"CANCELED"===t||"NOSHOW"===t},e.shouldShowChangeStayDatesButton=function(){return e.isNightsEnabled()&&!e.reservationData.reservation_card.is_hourly_reservation},e.isNightsEnabled=function(){var a=e.reservationData.reservation_card.reservation_status;return"RESERVED"===a||"CHECKING_IN"===a||!(!t.isStandAlone||"CHECKEDIN"!==a&&"CHECKING_OUT"!==a)};var X=function(){return a.getPermissionValue("EDIT_RESERVATION")};e.isStayDatesChangeAllowed=function(){var a=e.reservationData.reservation_card.is_hourly_reservation,r=e.reservationData.reservation_card.reservation_status,n=e.reservationData.reservation_card.group_id,o=!1,i="FULL"===t.hotelDiaryConfig.mode,s={CHECKING_IN:!0,RESERVED:!0}[r],c={CHECKEDIN:!0,CHECKING_OUT:!0}[r]&&!!n;return o=!1,t.isStandAlone&&!i&&!a&&X()&&(s||c)&&(o=!0),o},e.shouldDisableExtendNightsButton=function(){var t=e.reservationData.allotment_id||e.reservationData.reservation_card.allotment_id;return t};var Z=function(){var t={start_date:e.reservationData.reservation_card.arrival_date,reservation_id:e.reservationData.reservation_card.reservation_id,confirm_id:e.reservationData.reservation_card.confirmation_num,room_id:e.reservationData.reservation_card.room_id,origin:"STAYCARD_NIGHTS"};""===t.room_id?t.action="SELECT_UNASSIGNED_RESERVATION":t.action="SELECT_RESERVATION",f.go("rover.nightlyDiary",t)};e.extendNights=function(){return!e.shouldDisableExtendNightsButton()&&void("FULL"===t.hotelDiaryConfig.mode&&e.reservationData.reservation_card.is_hourly_reservation?e.showDiaryScreen():"FULL"!==t.hotelDiaryConfig.mode||e.reservationData.reservation_card.is_hourly_reservation?f.go("rover.reservation.staycard.changestaydates",{reservationId:j.reservationId,confirmNumber:j.confirmNum}):Z())};var ee;e.showEditReservationPrompt=function(){t.isStandAlone?e.reservationData.reservation_card.is_hourly_reservation?e.applyCustomRate():ee=c.open({template:"/assets/partials/reservation/rvStayCardEditRate.html",className:"ngdialog-theme-default",scope:e,closeByDocument:!1,closeByEscape:!1}):f.go("rover.reservation.staycard.billcard",{reservationId:e.reservationData.reservation_card.reservation_id,clickedButton:"viewBillButton",userId:e.guestCardData.userId})},e.applyCustomRate=function(){e.closeDialog(ee),y(function(){e.editReservationRates(e.reservationParentData.rooms[0],0)},1e3)};var te=function(t,a){var r=e.$parent.reservationData.tabs[e.viewState.currentTab].roomTypeId;"CHECKEDIN"===e.reservationData.reservation_card.reservation_status&&(r=e.reservationData.reservation_card.room_type_id),angular.forEach(e.reservationData.reservation_card.stay_dates,function(t){e.$parent.reservationData.rooms[0].stayDates[t.date].contractId=t.contract_id}),f.go(w,{from_date:t||j.arrivalDate,to_date:a||j.departureDate,view:"DEFAULT",fromState:f.current.name,company_id:e.$parent.reservationData.company.id,travel_agent_id:e.$parent.reservationData.travelAgent.id,group_id:e.borrowForGroups?"":e.$parent.reservationData.group.id,borrow_for_groups:e.borrowForGroups,room_type_id:r,adults:e.$parent.reservationData.tabs[e.viewState.currentTab].numAdults,children:e.$parent.reservationData.tabs[e.viewState.currentTab].numChildren,is_member:e.guestData.primary_guest_details.is_member,selectedCurrencyId:e.reservationData.reservation_card.rate_currency_id})};e.alertOverbooking=function(t){var a=0;t&&(e.closeDialog(),a=1e3),y(te,a)},e.updateRoomRate=function(){e.invokeApi(T.getReservationPackages,e.reservationData.reservation_card.reservation_id,function(t){e.$emit("hideLoader");var a=e.$parent.reservationData.rooms[0];a.addons=[],angular.forEach(t.existing_packages,function(e){a.addons.push({quantity:e.addon_count,id:e.id,price:parseFloat(e.amount),amountType:e.amount_type,postType:e.post_type,title:e.name,totalAmount:e.addon_count*parseFloat(e.amount),is_inclusive:e.is_inclusive,taxes:e.taxes,is_rate_addon:e.is_rate_addon,allow_rate_exclusion:e.allow_rate_exclusion,excluded_rate_ids:e.excluded_rate_ids})}),e.goToRoomAndRates("ROOM_RATE")})},e.goToRoomAndRates=function(a){return!e.reservationData.group_id&&!e.reservationData.reservation_card.group_id&&(e.closeDialog(ee),!e.reservationData.reservation_card.is_hourly_reservation&&void(t.isStandAlone?te():f.go("rover.reservation.staycard.billcard",{reservationId:e.reservationData.reservation_card.reservation_id,clickedButton:"viewBillButton",userId:e.guestCardData.userId})))},e.modifyCheckinCheckoutTime=function(){var t=function(t){e.$emit("hideLoader"),""!==e.reservationParentData.checkinTime.hh&&""!==e.reservationParentData.checkinTime.mm?e.reservationData.reservation_card.arrival_time=e.reservationParentData.checkinTime.hh+":"+(""!==e.reservationParentData.checkinTime.mm?e.reservationParentData.checkinTime.mm:"00")+" "+e.reservationParentData.checkinTime.ampm:e.reservationData.reservation_card.arrival_time=null,""!==e.reservationParentData.checkoutTime.hh&&""!==e.reservationParentData.checkoutTime.mm?e.reservationData.reservation_card.departure_time=e.reservationParentData.checkoutTime.hh+":"+(""!==e.reservationParentData.checkoutTime.mm?e.reservationParentData.checkoutTime.mm:"00")+" "+e.reservationParentData.checkoutTime.ampm:e.reservationData.reservation_card.departure_time=null},a=function(t){e.errorMessage=t,e.$emit("hideLoader")};if(""!==e.reservationParentData.checkinTime.hh&&""!==e.reservationParentData.checkinTime.mm||""!==e.reservationParentData.checkoutTime.hh&&""!==e.reservationParentData.checkoutTime.mm||""===e.reservationParentData.checkinTime.hh&&""===e.reservationParentData.checkinTime.mm||""===e.reservationParentData.checkoutTime.hh&&""===e.reservationParentData.checkoutTime.mm){var r=e.computeReservationDataforUpdate(!0);r.reservationId=e.reservationParentData.reservationId,e.invokeApi(D.updateReservation,r,t,a)}},t.$on("ngDialog.opened",function(e,a){t.modalOpened=!1,y(function(){t.modalOpened=!0},300)}),t.$on("ngDialog.closing",function(e,a){t.modalOpened=!1}),e.closeAddOnPopup=function(){t.modalOpened=!1,y(function(){c.close()},300)},e.showAddNewPaymentModel=function(a){var r={reservationId:e.reservationData.reservation_card.reservation_id,guest_id:e.data.guest_details.user_id,details:{firstName:e.data.guest_details.first_name,lastName:e.data.guest_details.last_name,hideDirectBill:!0}},n=e.reservationData;if(void 0!==a){var o=new SwipeOperation,i=o.createSWipedDataToRender(a);r.details.swipedDataToRenderInScreen=i,"depositBalance"!==i.swipeFrom&&"cancelReservationPenalty"!==i.swipeFrom&&"stayCardDeposit"!==i.swipeFrom?(console.info("doing open pmt window with pass data"),"guestCard"===i.swipeFrom&&(r.isFromGuestCard=!0),c.close(t.LastngDialogId,""),e.openPaymentDialogModal(r,n)):"stayCardDeposit"===i.swipeFrom?e.$broadcast("SHOW_SWIPED_DATA_ON_STAY_CARD_DEPOSIT_SCREEN",i):"depositBalance"===i.swipeFrom?e.$broadcast("SHOW_SWIPED_DATA_ON_DEPOSIT_BALANCE_SCREEN",i):e.$broadcast("SHOW_SWIPED_DATA_ON_CANCEL_RESERVATION_PENALTY_SCREEN",i)}else r.details.swipedDataToRenderInScreen={},e.openPaymentDialogModal(r,n)},e.showDiaryScreen=function(){r.checkinDateForDiary=e.reservationData.reservation_card.arrival_date.replace(/-/g,"/"),f.go("rover.diary",{reservation_id:e.reservationData.reservation_card.reservation_id,checkin_date:e.reservationData.reservation_card.arrival_date,is_nightly_reservation:!e.reservationData.reservation_card.is_hourly_reservation})},e.handleAddonsOnReservation=function(t){e.addonPopUpData={addonPostingMode:"staycard",cancelLabel:"Cancel",saveLabel:"Save",shouldShowAddMoreButton:!0,number_of_adults:e.reservationData.reservation_card.number_of_adults,number_of_children:e.reservationData.reservation_card.number_of_children,duration_of_stay:e.packageData.duration_of_stay},t?c.open({template:"/assets/partials/packages/showPackages.html",controller:"RVReservationPackageController",scope:e}):f.go("rover.reservation.staycard.mainCard.addons",{from_date:e.reservation.reservation_card.arrival_date,to_date:e.reservation.reservation_card.departure_date,is_active:!0,is_not_rate_only:!0,from_screen:"staycard"})},e.hasAnySharerCheckedin=function(){var t=!1;return angular.forEach(e.reservationData.reservation_card.sharer_information,function(e,a){if("CHECKEDIN"===e.reservation_status||"CHECKING_OUT"===e.reservation_status)return t=!0,!1}),t},e.responseValidation={},e.editStayDates=function(){e.errorMessage="";var n=function(r){if(e.responseValidation={},0===r.errors.length)if(e.responseValidation=r.data,e.stayDatesExtendedForOutsideGroup=!!(r.data.is_group_reservation&&r.data.outside_group_stay_dates&&t.isStandAlone),e.borrowForGroups=!(!r.data.is_group_reservation||r.data.is_room_type_available),e.shouldAllowDateExtend=!(!r.data.is_room_type_available&&!a.getPermissionValue("OVERBOOK_ROOM_TYPE")),e.showNotAvailableMessage=!r.data.is_room_type_available&&!a.getPermissionValue("OVERBOOK_ROOM_TYPE"),e.showOverBookingAlert=!r.data.is_room_type_available&&r.data.is_house_available&&a.getPermissionValue("OVERBOOK_ROOM_TYPE"),e.showChangeDatesPopup=!a.getPermissionValue("OVERBOOK_ROOM_TYPE")||r.data.is_room_type_available||!r.data.is_house_available,e.restrictSuiteOverbooking=!r.data.is_room_type_available&&r.data.is_suite_reservation,e.isSuiteReservation=r.data.is_suite_reservation,e.routingInfo=r.data.routing_info,
r.results.status===x&&r.results.is_borrowed_from_house){var n=r.results;e.borrowData={},n.room_overbooked||n.house_overbooked||(e.borrowData.isBorrowFromHouse=!0),n.room_overbooked&&!n.house_overbooked?(e.borrowData.shouldShowOverBookBtn=e.hasOverBookRoomTypePermission,e.borrowData.isRoomTypeOverbooked=!0):!n.room_overbooked&&n.house_overbooked?(e.borrowData.shouldShowOverBookBtn=e.hasOverBookHousePermission,e.borrowData.isHouseOverbooked=!0):n.room_overbooked&&n.house_overbooked&&(e.borrowData.shouldShowOverBookBtn=e.hasOverBookRoomTypePermission&&e.hasOverBookHousePermission,e.borrowData.isHouseAndRoomTypeOverbooked=!0),c.open({template:"/assets/partials/common/group/rvGroupBorrowPopup.html",className:"",closeByDocument:!1,closeByEscape:!0,scope:e})}else c.open({template:"/assets/partials/reservation/alerts/editDatesInStayCard.html",className:"",scope:e,data:JSON.stringify({is_stay_cost_changed:r.data.is_stay_cost_changed,is_assigned_room_available:r.data.is_room_available,is_rate_available:r.data.is_room_type_available,is_group_reservation:r.data.is_group_reservation,is_outside_group_stay_dates:r.data.outside_group_stay_dates,group_name:r.data.group_name,is_invalid_move:r.data.is_invalid_move,is_house_available:!!r.data.is_house_available})});else e.responseValidation={},e.errorMessage=r.errors;e.$emit("hideLoader")},o=function(t){e.$emit("hideLoader")};e.invokeApi(r.validateStayDateChange,{arrival_date:l("date")(tzIndependentDate(e.editStore.arrival),"yyyy-MM-dd"),dep_date:l("date")(tzIndependentDate(e.editStore.departure),"yyyy-MM-dd"),reservation_id:e.reservationData.reservation_card.reservation_id},n,o)},e.closeBorrowPopup=function(t){t&&(e.borrowData={}),c.close()},e.performBorrowFromHouse=function(){e.borrowData.isBorrowFromHouse?(S.setForceOverbookFlagForGroup(!0),e.clickedOnStayDateChangeConfirmButton(),e.closeBorrowPopup(!0)):(e.closeBorrowPopup(),c.open({template:"/assets/partials/common/group/rvGroupOverbookPopup.html",className:"",closeByDocument:!1,closeByEscape:!0,scope:e}))},e.closeOverbookPopup=function(){e.borrowData={},c.close()},e.performOverBook=function(){S.setForceOverbookFlagForGroup(!0),e.clickedOnStayDateChangeConfirmButton(),e.closeOverbookPopup()},e.moveToRoomRates=function(){var t=function(t){0===t&&(e.reservationParentData.stayDays=[]);for(var a=1*new tzIndependentDate(e.reservationParentData.arrivalDate),r=1*new tzIndependentDate(e.reservationParentData.departureDate);a<=r;a+=864e5)0===t&&e.reservationParentData.stayDays.push({date:A(new tzIndependentDate(a),"yyyy-MM-dd"),dayOfWeek:A(new tzIndependentDate(a),"EEE"),day:A(new tzIndependentDate(a),"dd")}),e.reservationParentData.rooms[t].stayDates[A(new tzIndependentDate(a),"yyyy-MM-dd")]={guests:{adults:parseInt(e.reservationParentData.rooms[t].numAdults),children:parseInt(e.reservationParentData.rooms[t].numChildren),infants:parseInt(e.reservationParentData.rooms[t].numInfants)},rate:{id:"",name:""}}},a=tzIndependentDate(e.editStore.arrival),r=tzIndependentDate(e.editStore.departure);e.reservationParentData.arrivalDate=l("date")(a,"yyyy-MM-dd"),e.reservationParentData.departureDate=l("date")(r,"yyyy-MM-dd"),e.reservationParentData.numNights=Math.floor((Date.parse(r)-Date.parse(a))/864e5),t(0),te(l("date")(tzIndependentDate(e.editStore.arrival),"yyyy-MM-dd"),l("date")(tzIndependentDate(e.editStore.departure),"yyyy-MM-dd")),e.closeDialog()};var ae=function(t){var r=0,n=0;t&&(e.closeDialog(),n=1500),y(function(){for(;r<e.responseValidation.addons_to_overbook.length;r++){var t=e.responseValidation.addons_to_overbook[r];if(!t.isAlerted){t.isAlerted=!0,c.open({template:"/assets/partials/reservationCard/rvInsufficientInventory.html",className:"ngdialog-theme-default",closeByDocument:!0,scope:e,data:JSON.stringify({name:t.name,count:t.inventory,canOverbookInventory:a.getPermissionValue("OVERRIDE_ITEM_INVENTORY")})});break}}r===e.responseValidation.addons_to_overbook.length&&e.changeStayDates({skipAddonCheck:!0})},n)};e.selectAddon=function(){ae(!0)},e.showBillingInformationPrompt=function(){c.close(),c.open({template:"/assets/partials/reservation/alerts/rvShowBillingInformationPopup.html",className:"",closeByDocument:!1,scope:e})},e.updateBillingInformation=function(){var t={from_date:l("date")(tzIndependentDate(e.editStore.arrival),"yyyy-MM-dd"),to_date:l("date")(tzIndependentDate(e.editStore.departure),"yyyy-MM-dd"),reservation_id:e.reservationData.reservation_card.reservation_id};e.callAPI(D.updateBillingInformation,{params:t,successCallBack:e.closeBillingInfoPopup})},e.clickedOnStayDateChangeConfirmButton=function(){var t=e.routingInfo;t.incoming_from_room||t.out_going_to_room||t.out_going_to_comp_tra?e.showBillingInformationPrompt():e.closeBillingInfoPopup()},e.closeBillingInfoPopup=function(){c.close(),e.changeStayDates()},e.changeStayDates=function(t){if((!t||!t.skipAddonCheck)&&e.responseValidation.new_stay_dates&&e.responseValidation.new_stay_dates.length>0&&e.responseValidation.addons_to_overbook&&e.responseValidation.addons_to_overbook.length>0)return ae(!0),!1;for(var a=l("date")(tzIndependentDate(e.editStore.arrival),"yyyy-MM-dd"),r=l("date")(tzIndependentDate(e.editStore.departure),"yyyy-MM-dd"),n=e.reservationParentData.rooms[0].stayDates,i=e.responseValidation.new_stay_dates||[],s={},c=1*new tzIndependentDate(a),d=1*new tzIndependentDate(r);c<=d;c+=864e5){var u=l("date")(tzIndependentDate(c),"yyyy-MM-dd"),m=_.filter(i,function(e){return e.reservation_date===u});if(n[u]&&0===m.length)s[u]=n[u];else{var p=_.where(i,{reservation_date:u})[0];s[u]={guests:{adults:p.adults,children:p.children,infants:p.infants||0},rate:{id:p.rate_id},rateDetails:{actual_amount:p.rate_amount,modified_amount:p.rate_amount},roomTypeId:p.room_type_id}}}if(e.reservationParentData.numNights=Math.floor((Date.parse(r)-Date.parse(a))/864e5),e.reservationParentData.arrivalDate=a,e.reservationParentData.departureDate=r,e.reservationParentData.rooms[0].stayDates=s,e.stayDatesExtendedForOutsideGroup){var v={from_date:e.reservationParentData.arrivalDate,to_date:e.reservationParentData.departureDate,fromState:f.current.name,company_id:e.$parent.reservationData.company.id,travel_agent_id:e.$parent.reservationData.travelAgent.id};S.setReservationFlag("outsideStaydatesForGroup",!0),e.saveReservation(w,v)}else e.saveReservation("rover.reservation.staycard.reservationcard.reservationdetails",{id:o.id,confirmationId:o.confirmationId,isrefresh:!1});e.closeDialog()};var re=function(){c.open({template:"/assets/partials/reservation/alerts/rvReverseNotPossible.html",className:"",scope:e,data:JSON.stringify(e.reverseCheckoutDetails.data)})};e.reverseCheckoutDetails.data.is_reverse_checkout_failed&&(re(),e.initreverseCheckoutDetails()),t.$on("SETPREV_RESERVATION",function(e,a){L(),t.setPrevState={title:a}}),e.authData={authAmount:"0.00",manualCCAuthPermission:!0,billData:[],isManual:!1,manualAuthCode:"",selectedCardDetails:{name:"",number:"",payment_id:"",last_auth_date:"",bill_no:"",bill_balance:""}};var ne=function(){return a.getPermissionValue("MANUAL_CC_AUTH")};e.showAuthAmountPopUp=function(){var a=function(a){if(b.stop("FETCH_AUTH_DETAILS"),e.$emit("hideLoader"),e.authData.manualCCAuthPermission=ne(),e.authData.billData=_.sortBy(a.bill_data,function(e){return"N/A"===e.number?100:parseInt(e.number)}),e.authData.billData.length>0){c.open({template:"/assets/partials/authorization/rvManualAuthorizationPopup.html",className:"",closeByEscape:!1,closeByDocument:!1,scope:e}),e.selectCCforAuth(0),"SHIJI"===t.hotelDetails.payment_gateway&&t.hotelDetails.shiji_token_enable_offline&&(e.authData.manualAuthCode=e.authData.billData[0].last_authorization.code);var r={preventDefault:!1};e.setScroller("cardsList",r),e.refreshScroller("cardsList")}else console.warn("There should be atleast one credit card needed"),e.closeDialog();e.showRightContentForMobile=!1},r=function(t){b.stop("FETCH_AUTH_DETAILS"),e.$emit("hideLoader"),e.errorMessage=t};e.hasShownReleaseConfirm=!1;var o={reservation_id:e.reservationData.reservation_card.reservation_id};b.start("FETCH_AUTH_DETAILS"),e.invokeApi(n.fetchCreditCardAuthInfo,o,a,r)},e.selectCCforAuth=function(t){var a=e.authData.billData[t],r={name:a.card_name,number:a.card_number,payment_id:a.payment_method_id,last_auth_date:a.last_authorization.date?a.last_authorization.date:"",bill_no:a.number,bill_balance:a.balance?parseFloat(a.balance).toFixed(2):0};e.authData.selectedCardDetails=r,_.each(e.authData.billData,function(e){e.active=!1}),e.authData.billData[t].active=!0},e.onSelectCCforAuth=function(){e.showRightContentForMobile=!0},e.setLeftSideContent=function(){e.showRightContentForMobile=!1};var oe=function(){e.isInProgressScreen=!0,e.isSuccessScreen=!1,e.isFailureScreen=!1,e.isCCAuthPermission=!0},ie=function(t){e.isInProgressScreen=!1,e.isSuccessScreen=!0,e.isFailureScreen=!1,e.cc_auth_amount=e.authData.authAmount,e.cc_auth_code=t.auth_code,e.reservationData.reservation_card.payment_details.auth_color_code="green"},se=function(){e.isInProgressScreen=!1,e.isSuccessScreen=!1,e.isFailureScreen=!0,e.cc_auth_amount=e.authData.authAmount,e.reservationData.reservation_card.payment_details.auth_color_code="red"},ce=function(){var a=function(a){e.$emit("hideLoader"),ie(a),(e.authData.isManual||"SHIJI"===t.hotelDetails.payment_gateway&&t.hotelDetails.shiji_token_enable_offline)&&(e.authData.isManual=!1,e.authData.authAmount="","SHIJI"===t.hotelDetails.payment_gateway&&t.hotelDetails.shiji_token_enable_offline?e.authData.manualAuthCode=a.auth_code:e.authData.manualAuthCode="",c.close(),e.showAuthAmountPopUp())},r=function(t){e.$emit("hideLoader"),e.authData.isManual&&(c.close(),e.isCCAuthPermission=!0,c.open({template:"/assets/partials/authorization/rvManualAuthorizationProcess.html",className:"",closeByDocument:!1,scope:e})),se()},o={payment_method_id:e.authData.selectedCardDetails.payment_id,amount:e.authData.authAmount,auth_code:e.authData.manualAuthCode,isShift4Request:"SHIFT4"===t.hotelDetails.payment_gateway};e.authData.isManual?e.invokeApi(n.manualVoiceAuth,o,a,r):e.invokeApi(n.manualAuthorization,o,a,r)};e.cancelButtonClick=function(){e.showAuthAmountPopUp()},e.disableAuthorizeButton=function(){return e.isShijiOfflineAuthCodeEmpty()||!e.authData.manualCCAuthPermission||parseFloat(e.authData.authAmount)<=0||"N/A"===e.authData.selectedCardDetails.bill_no||isNaN(parseInt(e.authData.authAmount))},e.authorize=function(){e.authData.isManual||"SHIJI"===t.hotelDetails.payment_gateway&&t.hotelDetails.shiji_token_enable_offline?ce():(c.close(),oe(),setTimeout(function(){c.open({template:"/assets/partials/authorization/rvManualAuthorizationProcess.html",className:"",closeByDocument:!1,scope:e}),ce()},100))},e.isShijiOfflineAuthCodeEmpty=function(){return!("SHIJI"!==t.hotelDetails.payment_gateway||!t.hotelDetails.shiji_token_enable_offline||e.authData.manualAuthCode)},e.tryAgain=function(){oe(),ce()},e.$on("wakeup_call_ON",function(t,a){a&&(e.activeWakeUp=a.active)}),e.updateGiftCardNumber=function(e){t.$broadcast("GIFTCARD_DETAILS",e)},e.giftCardAmountAvailable=!1,e.giftCardAvailableBalance=0,e.$on("giftCardAvailableBalance",function(t,a){e.giftCardAvailableBalance=a.amount}),e.timer=null,e.cardNumberInput=function(t,a){var r=t.length;e.num=t,r>=8&&r<=22?$("[name=card-number]").keydown(function(){clearTimeout(e.timer),e.updateGiftCardNumber(t),e.timer=setTimeout(e.fetchGiftCardBalance,1500)}):e.giftCardAmountAvailable=!1},e.num,e.fetchGiftCardBalance=function(){e.giftCardAmountAvailable=!1;var t=function(t){e.giftCardAvailableBalance=t.amount,e.giftCardAmountAvailable=!0,e.$emit("giftCardAvailableBalance",t),e.$emit("hideLoader")};e.invokeApi(r.checkGiftCardBalance,{card_number:e.num},t)};var de=e.$on("CHILD_CONTENT_MOD",function(t,a){t.stopPropagation(),e.refreshReservationDetailsScroller(a||0)});e.$on("$destroy",de),e.onReleaseBtnClick=function(t){e.selectedCardData=t,e.hasShownReleaseConfirm=!0},e.onCancelClick=function(){e.showRightContentForMobile=!1,e.hasShownReleaseConfirm=!1},e.releaseAuthorization=function(t){var a=function(t){e.$emit("hideLoader"),e.hasShownReleaseConfirm=!1,e.showAuthAmountPopUp()},r=function(t){e.$emit("hideLoader"),e.errorMessage=t,e.hasShownReleaseConfirm=!1};e.errorMessage="";var o={payment_method_id:t};e.invokeApi(n.releaseAuthorization,o,a,r)},e.onSRViewRateBtnClick=function(){S.setReservationFlag("isSRViewRateBtnClicked",!0)},e.isBalanceAmountShown=function(){return!e.reservationData.reservation_card.is_rate_suppressed_present_in_stay_dates||S.getReservationFlag("isSRViewRateBtnClicked")},e.isSRViewRateBtnShown=function(){return e.isStandAlone&&e.hasSRViewPermission&&e.reservationData.reservation_card.is_rate_suppressed_present_in_stay_dates&&!S.getReservationFlag("isSRViewRateBtnClicked")},e.isRateAmountShown=function(){return"false"==e.reservationData.reservation_card.is_rates_suppressed||S.getReservationFlag("isSRViewRateBtnClicked")},e.toggleOverBookingAlert=function(){e.showOverBookingAlert=!e.showOverBookingAlert};var le=function(e){var t=_.find(V,function(t){return t.guest_id===e});return t};e.isIdRequiredForGuest=function(t,a){return a?e.hotelDetails.id_collection.rover.enabled&&!e.isGuestIdUploaded(t,!0):e.hotelDetails.id_collection.rover.enabled&&e.hotelDetails.id_collection.rover.scan_all_guests&&!e.isGuestIdUploaded(t,!1)},e.isGuestIdUploaded=function(t,a){var r=a?e.reservationParentData.guest.id:t.id,n=le(r),o=n&&n.front_image_data&&!n.id_proof_expired;return o},e.isGuestIdRequiredForCheckin=function(){if(!e.hotelDetails.id_collection.rover.enabled)return!1;if(e.guestData&&!e.isGuestIdUploaded(e.guestData.primary_guest_details,!0))return!0;if(!e.hotelDetails.id_collection.rover.scan_all_guests)return!1;var t=!1;return e.guestData&&_.each(e.guestData.accompanying_guests_details,function(a){e.isGuestIdUploaded(a,!1)||(t=!0)}),t},e.continueToCheckinAfterIdScan=function(){e.$broadcast("PROCEED_CHECKIN")},e.continueToCheckinAfterSkipIdScan=function(){var t={id:e.reservationData.reservation_card.reservation_id,action_type:"ID_DETAILS",details:[{key:"Skipped ID Scan",new_value:!0}]};e.invokeApi(r.createActivityLog,t,function(t){e.$broadcast("PROCEED_CHECKIN")})},e.showScannedGuestID=function(t,a){e.$emit("hideLoader"),a=a?a:{};var r=t?e.reservationParentData.guest.id:a.id,n=le(r);if(e.hasGuestIDPermission){n?(n.guest_id=r,n.is_primary_guest=t,e.guestIdData=angular.copy(n)):e.guestIdData={last_name:"",first_name:"",date_of_birth:"",nationality_id:"",document_number:"",expiration_date:"",guest_id:r,back_image_data:"",front_image_data:"",signature:"",is_manual_upload:!0,is_primary_guest:t};try{angular.module("sntIDCollection")}catch(e){N.inject("sntIDCollection")}c.open({template:"/assets/partials/guestId/rvGuestId.html",className:"guest-id-dialog",controller:"rvGuestIdScanCtrl",scope:e})}},e.$on("ON_GUEST_ID_POPUP_CLOSE",function(){q()});var ue=function(e){var t=_.isEmpty(e.first_name)?"":e.first_name,a=_.isEmpty(e.last_name)?"":e.last_name,r=_.isEmpty(e.expiration_date)?"":e.expiration_date,n=l("translate")("GUEST_FIRST_NAME")+": "+t+"\r\n"+l("translate")("GUEST_LAST_NAME")+": "+a+"\r\n"+l("translate")("DOB")+": "+e.date_of_birth+"\r\n"+l("translate")("NATIONALITY")+": "+e.nationality+"\r\n"+l("translate")("ID_NUMBER")+": "+e.document_number+"\r\n";return e.id_scan_info&&e.id_scan_info.personal_id_no&&(n=n+l("translate")("PERSONAL_NUMBER")+": "+e.id_scan_info.personal_id_no+"\r\n"),n=n+l("translate")("ID_EXPIRY")+": "+r};e.dowloadDocumnetDetails=function(t,a){var r=a?e.reservationParentData.guest.id:t.id,n=le(r);n.first_name=n.first_name?n.first_name:t.first_name,n.last_name=n.last_name?n.last_name:t.last_name;var o,i=new JSZip,s=function(e,t){e&&e.length>0&&i.file(t,e.split(",")[1],{base64:!0})};o=_.isEmpty(n.last_name)?n.first_name:_.isEmpty(n.first_name)?n.last_name:_.isEmpty(n.first_name)&&_.isEmpty(n.last_name)?"document":n.first_name+"-"+n.last_name,i.file(o+"-info.txt",ue(n)),s(n.front_image_data,o+"-ID.png"),s(n.back_image_data,o+"-ID-back-side.png"),s(n.signature,o+"-signature.png"),i.generateAsync({type:"blob"}).then(function(e){saveAs(e,o+".zip")})},e.navigateToAddons=function(){c.close(),f.go("rover.reservation.staycard.mainCard.addons",{from_date:e.reservation.reservation_card.arrival_date,to_date:e.reservation.reservation_card.departure_date,is_active:!0,is_not_rate_only:!0,from_screen:"staycard"})};var me=function(a){var r=function(t){e.$emit("hideLoader"),H()},n={addon_id:a.id,reservation_id:e.reservationData.reservation_card.reservation_id,post_instances:a.post_instances,start_date:l("date")(tzIndependentDate(a.start_date),t.dateFormatForAPI),end_date:l("date")(tzIndependentDate(a.end_date),t.dateFormatForAPI),selected_post_days:a.selected_post_days};e.invokeApi(T.updateAddonPosting,n,r)},fe=function(t,a){var r=e.reservationData.reservation_card.reservation_id,n=function(){e.$emit("hideLoader"),e.packageData.existing_packages.splice(t,1),e.addonsData.existingAddons.splice(t,1),e.reservationData.reservation_card.package_count=parseInt(e.reservationData.reservation_card.package_count)-parseInt(1),0===e.reservationData.reservation_card.package_count&&(e.reservationData.reservation_card.is_package_exist=!1),shouldReloadState=!0},o=function(t){e.errorMessage=t},i=[];i.push(a);var s={postData:{addons:i},reservationId:r};e.invokeApi(T.deleteAddonsFromReservation,s,n,o)};e.$on("PRIMARY_GUEST_ID_CHANGED",function(t,a){a&&a.faceImage&&(e.guestData.primary_guest_details.image=a.faceImage)});var pe=t.$on("NAVIGATE_TO_ADDONS",function(t,a){"staycard"===a.addonPostingMode&&e.navigateToAddons()}),ve=t.$on("REMOVE_ADDON",function(e,t){"staycard"===t.addonPostingMode&&fe(t.index,t.addon.id)}),_e=e.$on("PROCEED_BOOKING",function(e,t){"staycard"===t.addonPostingMode&&me(t.selectedPurchesedAddon)});e.shouldDisableArrivalDate=function(){var a=!1;return"CHECKEDIN"===e.reservationData.reservation_card.reservation_status&&tzIndependentDate(e.editStore.arrival)<=tzIndependentDate(t.businessDate)&&(a=!0),a},e.$on("$destroy",_e),e.$on("$destroy",ve),e.$on("$destroy",pe),o.isGroupDetachmentRequested&&(e.searchData.groupCard.name="")}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){sntRover.controller("rvReservationGuestController",["$scope","$rootScope","RVReservationGuestSrv","$stateParams","$state","$timeout","ngDialog","dateFilter","RVGuestCardsSrv","RVReservationCardSrv",function(e,t,a,r,n,o,i,s,c,d){function l(){var t=e.reservationData.reservation_card.max_occupancy;if(t){var a=parseInt(e.guestData.adult_count||0)+parseInt(e.guestData.children_count||0);return a>parseInt(t)}return!1}function u(){if(e.reservationData.reservation_card.is_hourly_reservation){var t=_.findWhere(e.reservationData.reservation_card.stay_dates,{date:e.reservationData.reservation_card.arrival_date});return!!(t&&t.rate_config&&t.rate_config.single)}var a=!0;return angular.forEach(e.reservationData.reservation_card.stay_dates,function(t,r){a&&(e.guestData.adult_count&&1===parseInt(e.guestData.adult_count)?a=!!t.rate_config.single:e.guestData.adult_count&&2===parseInt(e.guestData.adult_count)?a=!!t.rate_config.double:e.guestData.adult_count&&parseInt(e.guestData.adult_count)>2&&(a=!(!t.rate_config.double||!t.rate_config.extra_adult)),a&&e.guestData.children_count&&parseInt(e.guestData.children_count)&&(a=!!t.rate_config.child))}),a}function m(r,n,o){e.$emit("showLoader"),angular.forEach(e.reservationData.reservation_card.stay_dates,function(a,o){if(new tzIndependentDate(a.date)>=new tzIndependentDate(t.businessDate)){var i=parseInt(e.guestData.adult_count||0),c=parseInt(e.guestData.children_count||0),d=angular.copy(a.rate_config);if(d.single=d.single||0,d.double=d.double||0,d.extra_adult=d.extra_adult||0,d.child=d.child||0,e.reservationParentData.rooms[0].stayDates[s(new tzIndependentDate(a.date),"yyyy-MM-dd")].guests={adults:i,children:c,infants:parseInt(e.guestData.infants_count||0)},!e.reservationData.reservation_card.is_hourly_reservation)if(r){var l=e.reservationParentData.rooms[0].stayDates[s(new tzIndependentDate(a.date),"yyyy-MM-dd")].rateDetails,u=parseFloat(l.actual_amount),m=parseFloat(l.modified_amount);u>0&&!(m>0)&&(rateDetails.modified_amount=u),e.reservationParentData.rooms[0].stayDates[s(new tzIndependentDate(a.date),"yyyy-MM-dd")].rateDetails.actual_amount=0}else if(n){var f=i>=2?d.double:d.single,p=i>=2?i-2:0,v=parseFloat(f)+p*parseFloat(d.extra_adult)+c*parseFloat(d.child);e.reservationParentData.rooms[0].stayDates[s(new tzIndependentDate(a.date),"yyyy-MM-dd")].rateDetails.actual_amount=v}else{var f=i>=2?d.double:d.single,p=i>=2?i-2:0,v=parseFloat(f)+p*parseFloat(d.extra_adult)+c*parseFloat(d.child);e.rateForCurrentGuest=v,e.reservationParentData.rooms[0].stayDates[s(new tzIndependentDate(a.date),"yyyy-MM-dd")].rateDetails.actual_amount=v,e.reservationParentData.rooms[0].stayDates[s(new tzIndependentDate(a.date),"yyyy-MM-dd")].rateDetails.modified_amount=v}}}),p=JSON.parse(JSON.stringify(e.guestData)),v=JSON.parse(JSON.stringify(e.guestData));var i=function(t){e.errorMessage="",o.isBackToStayCard?g():e.$emit("hideLoader")},c=function(t){e.$emit("hideLoader"),e.errorMessage=t,o.isBackToStayCard&&e.$emit("OPENGUESTTAB")},d=dclone(e.guestData,["primary_guest_details","accompanying_guests_details"]);d.accompanying_guests_details=[],d.reservation_id=e.reservationData.reservation_card.reservation_id,_.each(e.accompanyingGuests,function(t,a){_.each(e.accompanyingGuests[a],function(e){d.accompanying_guests_details.push({first_name:e.first_name,last_name:e.last_name,guest_type:e.guest_type,guest_type_id:e.guest_type_id})})}),e.invokeApi(a.updateGuestTabDetails,d,i,c)}function f(){i.close()}BaseCtrl.call(this,e),e.guestData={};var p={},v={},D={};e.isSRRate="true"===e.reservationData.reservation_card.is_rate_suppressed_present_in_stay_dates,e.errorMessage="",e.setScroller("accompanyGuestList");var h="guestSearchResultsScroller",y=function(){o(function(){e.refreshScroller("accompanyGuestList")},500)};e.$on("UPDATE_ACCOMPANY_SCROLL",function(){y()}),e.customRate="",e.rateForCurrentGuest="";var g=function(){e.saveReservation("rover.reservation.staycard.reservationcard.reservationdetails",{id:e.reservationData.reservation_card.reservation_id,confirmationId:e.reservationData.reservation_card.confirmation_num,isrefresh:!0})},C=function(){var a;a=new tzIndependentDate(e.reservationData.reservation_card.arrival_date)>=new tzIndependentDate(t.businessDate)?_.filter(e.reservationData.reservation_card.stay_dates,function(t){return new tzIndependentDate(t.date).getTime()===new tzIndependentDate(e.reservationData.reservation_card.arrival_date).getTime()}):_.filter(e.reservationData.reservation_card.stay_dates,function(e){return new tzIndependentDate(e.date).getTime()===new tzIndependentDate(t.businessDate).getTime()});var r=parseInt(e.guestData.adult_count||0),n=parseInt(e.guestData.children_count||0),o=a[0].rate_config,i=0;if(!e.reservationData.reservation_card.is_hourly_reservation){var s=r>=2?o.double:o.single;i=parseFloat(s);var c=r>=2?r-2:0;c>0&&(i+=c*parseFloat(o.extra_adult)),n>0&&(i+=n*parseFloat(o.child)),e.rateForCurrentGuest=parseFloat(i).toFixed(2)}},A=function(){i.open({template:"/assets/partials/reservation/rvCustomRateSelectPopup.html",className:"",scope:e,closeByDocument:!1,closeByEscape:!1})};e.keepCurrentRate=function(){m(!1,!0,{isBackToStayCard:!0}),f()},e.ChangeToNewRate=function(){m(void 0,void 0,{isBackToStayCard:!0}),f()};var S=function a(){var r,a=!1;return r=new tzIndependentDate(e.reservationParentData.arrivalDate)>=new tzIndependentDate(t.businessDate)?_.filter(e.reservationParentData.rooms[0].stayDates,function(t,a){return new tzIndependentDate(a).getTime()===new tzIndependentDate(e.reservationParentData.arrivalDate).getTime()}):_.filter(e.reservationParentData.rooms[0].stayDates,function(e,a){return new tzIndependentDate(a).getTime()===new tzIndependentDate(t.businessDate).getTime()}),r[0].rateDetails.actual_amount!==r[0].rateDetails.modified_amount&&(a=!0,e.customRate=r[0].rateDetails.modified_amount),a};e.applyCurrentRate=function(){m(!0,void 0,{isBackToStayCard:!0}),f()},e.cancelOccupancyChange=function(){e.guestData=JSON.parse(JSON.stringify(v)),p=JSON.parse(JSON.stringify(v)),angular.copy(D,e.accompanyingGuests),f()};var I=function(t){var r={};r.reservation_id=e.reservationData.reservation_card.reservation_id,r.adults=e.guestData.adult_count,r.children=e.guestData.children_count;var o=function(a){e.$emit("hideLoader"),"rover.reservation.staycard.reservationcard.reservationdetails"===n.current.name&&(a.is_rate_changed?(C(),e.customRate=a.rate_amount,e.rateForCurrentGuest=a.calculated_rate_amount,e.isSRRate=a.is_sr,A()):m("","",t))};e.invokeApi(a.verifyRateChange,r,o)};e.saveGuestDetails=function(t){var a=JSON.parse(JSON.stringify(e.guestData));if(!angular.equals(a,v)||!angular.equals(D,e.accompanyingGuests))if(e.$emit("showLoader"),u()){var r=S();r&&!e.reservationData.reservation_card.is_hourly_reservation?(C(),A()):r||e.reservationData.reservation_card.is_hourly_reservation?m("","",t):I(t),e.$emit("hideLoader")}else e.$emit("hideLoader"),i.open({template:"/assets/partials/reservation/alerts/notConfiguredOccupancyInStayCard.html",className:"",scope:e,closeByDocument:!1,closeByEscape:!1})};var T=function(e){var a=_.find(t.guestTypes,{value:e});return a.id},E=function(t,a,r,n){var o=e.guestData.accompanying_guests_details.length,i=t+a+r;if(i-1>o){var s=t-1-n.ADULT.length,c=a-n.CHILDREN.length,d=r-n.INFANTS.length;b("ADULT",s,n.ADULT),b("CHILDREN",c,n.CHILDREN),b("INFANTS",d,n.INFANTS),e.$emit("UPDATE_ACCOMPANY_SCROLL")}};e.onStayCardOccupancyChange=function(){l()&&i.open({template:"/assets/partials/reservation/alerts/occupancy.html",className:"",scope:e,closeByDocument:!1,closeByEscape:!1,data:JSON.stringify({roomType:e.reservationData.reservation_card.room_type_description,roomMax:e.reservationData.reservation_card.max_occupancy})}),p.adult_count=e.guestData.adult_count,p.children_count=e.guestData.children_count,p.infants_count=e.guestData.infants_count,E(p.adult_count,p.children_count,p.infants_count,e.accompanyingGuests)};var R=function(e){var t=_.groupBy(e,"guest_type");return t.ADULT||(t.ADULT=[]),t.CHILDREN||(t.CHILDREN=[]),t.INFANTS||(t.INFANTS=[]),t},b=function(e,t,a){if(t>0)for(var r=0;r<t;r++)a.push({first_name:"",last_name:"",guest_type:e,guest_type_id:T(e)})};e.init=function(){e.accompanyingGuests={ADULT:[],CHILDREN:[],INFANTS:[]};var r=function(a){e.maxAdultsForReservation=e.otherData.maxAdults,e.$emit("hideLoader"),e.$parent.guestData=a,e.guestData=a,e.guestCardData.contactInfo.is_flagged=a.primary_guest_details.is_flagged,e.guestCardData&&e.guestCardData.contactInfo&&(e.guestCardData.contactInfo.stayCount=a.primary_guest_details&&a.primary_guest_details.stay_count,t.$broadcast("UPDATE_STAY_COUNT",{stayCount:e.guestCardData.contactInfo.stayCount})),e.accompanyingGuests=e.guestData.accompanying_guests_details?R(e.guestData.accompanying_guests_details):e.accompanyingGuests,E(e.guestData.adult_count,e.guestData.children_count,e.guestData.infants_count,e.accompanyingGuests),p=JSON.parse(JSON.stringify(e.guestData)),v=JSON.parse(JSON.stringify(e.guestData)),angular.copy(e.accompanyingGuests,D),e.reservationParentData.rooms[0].accompanying_guest_details=a.accompanying_guests_details,e.errorMessage="",(e.reservationParentData.group.id||e.reservationParentData.allotment.id)&&(e.otherData.maxAdults>4?e.maxAdultsForReservation=4:e.maxAdultsForReservation=e.otherData.maxAdults)},n=function(t){e.$emit("hideLoader"),e.errorMessage=t},o={reservation_id:e.reservationData.reservation_card.reservation_id};e.invokeApi(a.fetchGuestTabDetails,o,r,n);var i=function(t){if(t.data)for(var a in t.data)"wakeup_call"===t.data[a].name&&(e.activeWakeUp=t.data[a].active,e.$emit("wakeup_call_ON",{active:t.data[a].active}))};e.invokeApi(a.fetchGuestPrefList,o,i,n)},e.activeWakeUp=!1,e.activeNewsPapaer=!1,e.init(),e.$on("UPDATEGUESTDEATAILS",function(t,a){e.saveGuestDetails(a)}),e.$on("FAILURE_UPDATE_RESERVATION",function(t,a){e.$emit("OPENGUESTTAB"),e.errorMessage=a}),e.showAccompanyingGuestLabel=function(){return e.guestData.accompanying_guests_details=e.guestData.accompanying_guests_details||[],e.guestData.adult_count+e.guestData.children_count+e.guestData.infants_count+e.guestData.accompanying_guests_details.length>1},e.navigateToGuestCard=function(t){n.go("rover.guest.details",{guestId:t,reservationId:e.reservationData.reservation_card.reservation_id,confirmationNo:e.reservationData.reservation_card.confirmation_num,fromStaycard:!0,isFromMenuGuest:!0})};var N=function(e,t){return e=_.filter(e,function(e){return e.guest_type===t})};e.searchGuest=function(t){t=t||!1;var a=function(t){i.open({template:"/assets/partials/reservationCard/reservationGuestSearchPopup.html",className:"",scope:e,closeByDocument:!0,closeByEscape:!1,data:{isPrimary:t}}),e.setScroller(h)},r=function(r){e.guestList=[],r.results.length>0&&(angular.forEach(N(r.results,e.searchData.guestType),function(t){var a={};a.id=t.id,a.firstName=t.first_name,a.lastName=t.last_name,a.image=t.image_url,a.vip=t.vip,null!==t.address&&(a.address={},a.address.city=t.address.city,a.address.state=t.address.state,a.address.postalCode=t.address.postal_code),a.stayCount=t.stay_count,a.lastStay={},a.phone=t.home_phone,a.email=t.email,a.lastStay.date=t.last_stay.date,a.lastStay.room=t.last_stay.room,a.lastStay.roomType=t.last_stay.room_type,a.lastStay.confirmationNo=t.last_stay.confirm_no,e.guestList.push(a)}),o(function(){e.refreshScroller(h)},500)),a(t)},n=function(){e.guestList=[]};e.callAPI(c.fetchGuests,{onSuccess:r,onFailure:n,params:{first_name:e.searchData.firstName,last_name:e.searchData.lastName,guest_type:e.searchData.guestType}})},e.findGuests=function(t,a,r,n){e.searchData={firstName:t,lastName:a,guestType:n},e.searchGuest(r)},e.closePopup=function(){f()},e.attachGuestToReservation=function(t,a){var r=function(){f(),n.reload(n.current.name)},o=function(){f()};e.callAPI(d.attachGuestToReservation,{onSuccess:r,onFailure:o,params:{reservation_id:e.reservationData.reservation_card.reservation_id,guest_detail_id:t,is_primary:a,guest_type:e.searchData.guestType}})},e.navigateToCreateGuest=function(t){f(),n.go("rover.guest.details",{reservationId:e.reservationData.reservation_card.reservation_id,fromStaycard:!0,isPrimary:t,firstName:e.searchData.firstName,lastName:e.searchData.lastName,confirmationNo:e.reservationData.reservation_card.confirmation_num,guestType:e.searchData.guestType,isFromMenuGuest:!0})},e.shouldShowCreateGuestBtn=function(e,a,r){return!e&&t.isStandAlone&&(a||r)}}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){sntRover.controller("reservationListController",["$scope",function(e){BaseCtrl.call(this,e);var t={click:!0,preventDefault:!1};e.setScroller("resultListing",t),e.$emit("updateRoverLeftMenu",""),e.$on("RESERVATIONLISTUPDATED",function(t){setTimeout(function(){e.refreshScroller("resultListing")},500)})}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}
};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){sntRover.controller("RVReservationNotesPopupCtrl",["$scope","$rootScope",function(e,t){BaseCtrl.call(this,e),e.reservationnote="",e.editingNote=null,e.saveReservationNote=function(){if(!e.$parent.isNewsPaperPreferenceAvailable()&&!t.isStandAlone)return e.reservationnote="",void e.$parent.showFeatureNotAvailableMessage();var r=function(t){t.is_already_existing||(e.reservationnote="",t.topic="GENERAL",e.$parent.reservationData.reservation_card.notes.reservation_notes.splice(0,0,t),e.$parent.reservationCardSrv.updateResrvationForConfirmationNumber(e.$parent.reservationData.reservation_card.confirmation_num,e.$parent.reservationData),a()),e.$parent.$emit("hideLoader")},n={};n.reservation_id=e.$parent.reservationData.reservation_card.reservation_id,n.text=e.reservationnote,n.note_topic=1,e.invokeApi(e.$parent.reservationCardSrv.saveReservationNote,n,r)},e.deleteReservationNote=function(t,r){e.deletedNoteIndex=r,null!==t&&t.stopPropagation();var n=function(t){e.$parent.reservationData.reservation_card.notes.reservation_notes.splice(e.deletedNoteIndex,1),e.$parent.reservationCardSrv.updateResrvationForConfirmationNumber(e.$parent.reservationData.reservation_card.confirmation_num,e.$parent.reservationData),e.cancelEditModeReservationNote(),e.$parent.$emit("hideLoader"),a()},o=e.$parent.reservationData.reservation_card.notes.reservation_notes[r].note_id;e.invokeApi(e.$parent.reservationCardSrv.deleteReservationNote,o,n)},e.updateActiveReservationNote=function(){if(null===e.reservationnote)return void(e.errorMessage=["Something went wrong, please try again!"]);if(!e.$parent.isNewsPaperPreferenceAvailable()&&!t.isStandAlone)return e.reservationnote="",void e.$parent.showFeatureNotAvailableMessage();if(e.errorMessage="",e.reservationnote){var r=function(t){e.editingNote.text=e.reservationnote;var r=_.findIndex(e.$parent.reservationData.reservation_card.notes.reservation_notes,{note_id:t.note_id});e.$parent.reservationData.reservation_card.notes.reservation_notes[r]=e.editingNote,e.$parent.reservationCardSrv.updateResrvationForConfirmationNumber(e.$parent.reservationData.reservation_card.confirmation_num,e.$parent.reservationData),a(),e.cancelEditModeReservationNote(),e.$parent.$emit("hideLoader")},n=function(t){e.errorMessage=t},o={};o.id=e.editingNote.note_id,o.text=e.reservationnote,o.associated_id=e.$parent.reservationData.reservation_card.reservation_id,o.associated_type="Reservation",e.invokeApi(e.$parent.reservationCardSrv.updateReservationNote,o,r,n)}},e.clickedOnNote=function(t){e.editingNote=t,e.reservationnote=t.text},e.cancelEditModeReservationNote=function(){e.editingNote=null,e.reservationnote=""};var a=function(){e.refreshScroller("reservationNotes")}}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){sntRover.controller("rvSetWakeupcallController",["$scope","$filter","RVSaveWakeupTimeSrv","ngDialog",function(e,t,a,r){BaseCtrl.call(this,e),e.hourValues=["01","02","03","04","05","06","07","08","09","10","11","12"],e.minValues=["00","15","30","45"],e.getHours=function(){return"undefined"!=typeof e.wakeupData.wake_up_time?e.wakeupData.wake_up_time.substr(0,2):""},e.getMins=function(){return"undefined"!=typeof e.wakeupData.wake_up_time?e.wakeupData.wake_up_time.substr(3,2):""},e.getAM_PM=function(){return"undefined"!=typeof e.wakeupData.wake_up_time?e.wakeupData.wake_up_time.substr(6,2):"AM"},e.$watch(function(){return"TOMORROW"===e.wakeupData.day||"undefined"==typeof e.wakeupData.day},function(t){e.todaySelected=!t}),e.hrs=e.getHours(),e.min=e.getMins(),e.am_pm=e.getAM_PM(),e.dimissLoaderAndDialog=function(){e.$emit("hideLoader"),e.closeDialog()},e.saveWakeupCall=function(){var t={};t.wake_up_time=e.getTimeString(),t.day=e.todaySelected?"Today":"Tomorrow",t.reservation_id=e.reservationData.reservation_card.reservation_id;var r=function(){e.wakeupData.wake_up_time=e.getTimeString(),e.wakeupData.day=e.todaySelected?"TODAY":"TOMORROW",e.$emit("updateWakeUpTime",e.wakeupData),e.dimissLoaderAndDialog()},n=function(t){e.$emit("hideLoader"),e.errorMessage=t};e.invokeApi(a.saveWakeupTime,t,r,n)},e.getTimeString=function(){return e.hrs+":"+e.min+" "+e.am_pm},e.deleteWakeupCall=function(){var t={};t.reservation_id=e.reservationData.reservation_card.reservation_id;var r=function(){delete e.wakeupData.wake_up_time,delete e.wakeupData.day,e.$emit("updateWakeUpTime",e.wakeupData),e.dimissLoaderAndDialog()},n=function(t){e.$emit("hideLoader"),e.errorMessage=t};e.invokeApi(a.saveWakeupTime,t,r,n)},e.validate=function(){return""!==e.hrs&&""!==e.min&&""!==e.am_pm},e.isDeletable=function(){return"undefined"==typeof e.wakeupData.wake_up_time}}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){sntRover.controller("staycardController",["$scope","$rootScope","RVGuestCardsSrv","ngDialog","$timeout","RVContactInfoSrv",function(e,t,a,r,n,o){function i(){r.open({template:"/assets/partials/payment/rvShowPaymentList.html",controller:"RVShowPaymentListCtrl",className:"",scope:e})}var s=700;e.staycardReady=!1,n(function(){e.staycardReady=!0},s),e.depositPopupData={},e.depositPopupData.hasShown=!1,e.countriesListForGuest=[],e.paymentData={},e.reservationData.justCreatedRes&&t.$broadcast("reload-loyalty-section-data",{}),e.$on("GUESTPAYMENT",function(t,a){a.user_id&&(e.paymentData=a)}),e.$on("guestCardUpdateData",function(t,a){e.guestCardData.contactInfo.avatar=a.avatar,e.guestCardData.contactInfo.vip=a.vip,e.countriesListForGuest=a.countries,e.guestCardData.userId=a.userId,e.guestCardData.guestId=a.guestId}),e.$on("staycardGuestData",function(t,a){e.guestCardData.contactInfo.first_name=a.guest_details.first_name,e.guestCardData.contactInfo.last_name=a.guest_details.last_name,e.guestCardData.contactInfo.confirmation_num=a.guest_details.confirmation_num,e.guestCardData.contactInfo.avatar=a.guest_details.avatar,e.sharedReservationData={},e.sharedReservationData.room_number="";for(var r in a.sharers)a.sharers[r].guest_details.first_last=a.sharers[r].guest_details.last_name+", "+a.sharers[r].guest_details.first_name;e.sharedReservationData.sharers=a.sharers}),e.goToSharedReservation=function(a){if(!a.active){var r=e.guestCardData.contactInfo.first_name+" "+e.guestCardData.contactInfo.last_name,n=a.guest_details.reservation_id,o=a.confirm_no;e.isLoading=!0,t.$broadcast("showLoading"),e.$broadcast("showLoading"),setTimeout(function(){var e={confirmation_no:o,reservation_no:n,fullname:r};t.viaSharerName=r,t.$broadcast("LOAD_SHARED_RESERVATION",e)},200)}},e.getTimes=function(e){return new Array(e)},e.$on("MOUSEMOVEDOVERME",function(){e.$broadcast("refreshScrollerReservationDetails")}),e.$on("reservationCardClicked",function(){e.$broadcast("reservationCardisClicked")}),e.$on("CHANGEAVATAR",function(t,a){var r=e.guestCardData.contactInfo.avatar.split("/")[e.guestCardData.contactInfo.avatar.split("/").length-1];for(var n in avatharImgs)avatharImgs[n]===r&&(e.guestCardData.contactInfo.avatar=a)}),e.menuImage="back-arrow",e.$on("HeaderChanged",function(t,a){e.$parent.heading=a,"Guest Bill"===a?e.$parent.addNoPrintClass=!0:"Stay Card"===a?e.$parent.isLogoPrint=!0:e.$parent.addNoPrintClass=!1}),e.$on("SHOWPAYMENTLIST",function(t,a){e.openPaymentList(a)}),e.openPaymentList=function(r){e.dataToPaymentList=r,t.isStandAlone||a.isGuestFetchComplete(e.reservationData.guest.id)?i():e.callAPI(o.getGuestDetailsById,{params:e.reservationData.guest.id,successCallBack:function(t){e.$emit("UPDATE_GUEST_CARD_DETAILS",t),i()},failureCallBack:function(t){e.errorMessage=t,e.$emit("hideLoader")}})},e.showRoomSharerPopup=function(){r.open({template:"/assets/partials/reservationCard/sharedRoom.html",scope:e})},e.getGuestStatusIcon=function(e,t){var a="";return"CHECKING_OUT"===e?a="check-out":"CHECKEDOUT"===e||"DEPARTED"===e?a="departed":"CHECKEDIN"!==e&&"CHECKING_IN"!==e||t!==!0?"CHECKING_IN"===e?a="check-in":"CHECKEDIN"===e?a="inhouse":"RESERVED"===e?a="arrival":"NOSHOW"===e||"NOSHOW_CURRENT"===e?a="no-show":"CANCELED"===e?a="cancel":"DEPARTED"===e&&(a="check-out"):a="late-check-out",a},e.$on("PRIMARY_GUEST_ID_CHANGED",function(t,a){e.guestCardData.contactInfo.id_type=a.id_type,e.guestCardData.contactInfo.gender_id=a.gender_id,e.guestCardData.contactInfo.nationality_id=a.nationality_id,e.guestCardData.contactInfo.id_number=a.id_number,e.guestCardData.contactInfo.birthday=a.birthday,a.faceImage&&(e.guestCardData.contactInfo.avatar=a.faceImage)})}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){sntRover.controller("RVReservationPackageController",["$scope","$rootScope","$state","$timeout","$filter","ngDialog","RVReservationStateService",function(e,t,a,r,n,o,i){e.showRightContentForMobile=!1;var s=!1;e.setScroller("resultDetails",{click:!0}),setTimeout(function(){e.refreshScroller("resultDetails")},2e3),e.closeAddOnPopup=function(){t.modalOpened=!1,e.$emit("CLOSE_ADDON_POPUP",{addonPostingMode:e.addonPopUpData.addonPostingMode}),r(function(){s&&a.reload(a.current.name),o.close(),e.showRightContentForMobile=!1},300)},e.shouldHideCount=function(t){var a=t.post_type.value.toUpperCase();return!("WEEKDAY"!==a&&"WEEKEND"!==a&&"CUSTOM"!==a||"undefined"!=typeof t.post_instances||!e.showCustomPosting()||"reservation"!==e.addonPopUpData.addonPostingMode)};var c=function(e,t,a,r){return"PERSON"===e?(t+a)*r:"ADULT"===e?t*r:"CHILD"===e?a*r:"FLAT"===e||"ROOM"===e?r:void 0},d=function(e,t,a){for(var r=moment(e,"DD-MM-YYYY"),n=moment(t,"DD-MM-YYYY"),o=n.diff(r,a),i=[],s=0;s<o;s++){var c,d=moment(e,"DD-MM-YYYY").add(s,a),l=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];c=l[d.day()],i.push(c)}return i};e.getAddonCount=function(t){var a=t.post_type.frequency,r=t.post_type.value.toUpperCase(),n=t.amount_type.value.toUpperCase(),o=e.addonPopUpData.number_of_adults,s=e.addonPopUpData.number_of_children,l=e.addonPopUpData.duration_of_stay,u=0,m=t.charge_full_weeks_only,f=e.addonPopUpData.addonPostingMode,p=e.selectedPurchesedAddon.startDateObj?e.selectedPurchesedAddon.startDateObj:tzIndependentDate(t.start_date),v=e.selectedPurchesedAddon.endDateObj?e.selectedPurchesedAddon.endDateObj:tzIndependentDate(t.end_date);if(e.showCustomPosting()&&"undefined"!=typeof t.post_instances)l=_.filter(t.post_instances,{active:!0}).length,u=c(n,o,s,l);else{if(e.showCustomPosting()&&"undefined"!=typeof t.custom_nightly_selected_post_days&&("reservation"===f||"staycard"===f)){var D=d(p,v,"days"),h=0;angular.forEach(D,function(e){t.custom_nightly_selected_post_days.includes(e)&&h++}),l=h}a||("WEEK"===r||"EVERY WEEK"===r||"WEEKLY"===r||"WEEKDAY"===r||"WEEKEND"===r?a=7:"STAY"===r||"NIGHTLY"===r?a=1:"NIGHT"!==r&&"First Night"!==r&&"LAST_NIGHT"!==r&&"CUSTOM"!==r&&"POST ON LAST NIGHT"!==r||(a=0)),u=i.getApplicableAddonsCount(n,r,a,o,s,l,m,f)}return u*t.addon_count},e.getAddonTotal=function(t){return e.shouldHideCount(t)?t.amount:e.getAddonCount(t)*t.amount},e.selectedPurchesedAddon="",e.selectedDaysFromAdmin=[],e.selectPurchasedAddon=function(a){if(e.errorMessage=[],e.previousPostDays={},e.daysOfWeek=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],t.featureToggles.addons_custom_posting)if(a.is_rate_addon||a.is_allowance)e.errorMessage=["Custom posting cannot be configured for "+(a.is_allowance?"allowance":"rate")+" addons"],e.selectedPurchesedAddon="";else if("STAY"===a.post_type.value){var o=e.addonPopUpData.addonPostingMode;e.selectedPurchesedAddon=a,"staycard"===o?e.addonPostingDate={startDate:tzIndependentDate(e.reservationData.reservation_card.arrival_date),endDate:tzIndependentDate(e.reservationData.reservation_card.departure_date)}:"reservation"===o?e.addonPostingDate={startDate:tzIndependentDate(e.reservationData.arrivalDate),endDate:tzIndependentDate(e.reservationData.departureDate)}:"allotments"===o||"create_allotment"===o?e.addonPostingDate={startDate:tzIndependentDate(e.allotmentConfigData.summary.block_from),endDate:tzIndependentDate(e.allotmentConfigData.summary.block_to)}:e.addonPostingDate={startDate:tzIndependentDate(e.groupConfigData.summary.block_from),endDate:tzIndependentDate(e.groupConfigData.summary.block_to)},e.selectedPurchesedAddon.start_date=e.addonPostingDate.startDate,e.selectedPurchesedAddon.end_date=e.addonPostingDate.endDate,e.selectedDaysFromAdmin=e.selectedPurchesedAddon.custom_nightly_selected_post_days,"undefined"==typeof e.selectedPurchesedAddon.adminConfiguredDays&&(e.selectedPurchesedAddon.adminConfiguredDays={},e.toggleAdminConfigDaysSelectionForAddon(!0)),"undefined"==typeof e.selectedPurchesedAddon.selected_post_days&&(e.selectedPurchesedAddon.selected_post_days={},e.togglePostDaysSelectionForAddon(!0)),e.selectedPurchesedAddon.startDateObj=tzIndependentDate(e.selectedPurchesedAddon.start_date),e.selectedPurchesedAddon.endDateObj=tzIndependentDate(e.selectedPurchesedAddon.end_date),f();var i=n("date")(e.selectedPurchesedAddon.start_date,t.dateFormat),s=n("date")(e.selectedPurchesedAddon.end_date,t.dateFormat);e.selectedPurchesedAddon.start_date=i,e.selectedPurchesedAddon.end_date=s,e.selectedPurchesedAddon.nameCharLimit=e.selectedPurchesedAddon.name.length>23?20:23,angular.forEach(e.selectedPurchesedAddon.post_instances,function(t){var a,r=moment(t.post_date),n=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];a=n[r.day()],e.selectedDaysFromAdmin.includes(a)?(e.selectedPurchesedAddon.selected_post_days[a]=t.active,e.selectedPurchesedAddon.adminConfiguredDays[a]=!0):(e.selectedPurchesedAddon.selected_post_days[a]=!1,e.selectedPurchesedAddon.adminConfiguredDays[a]=!1)}),angular.copy(e.selectedPurchesedAddon.selected_post_days,e.previousPostDays),r(function(){e.showRightContentForMobile=!0},10)}else e.selectedPurchesedAddon=a,r(function(){e.showRightContentForMobile=!0},10)};var l=function(e){var t=e%10,a=e%100;return 1===t&&11!==a?e+"st":2===t&&12!==a?e+"nd":3===t&&13!==a?e+"rd":e+"th"};e.getCustomPostingInfo=function(){var t="";return t="undefined"==typeof e.selectedPurchesedAddon.frequency_type||"undefined"==typeof e.selectedPurchesedAddon.frequency?"Posts daily":"days"===e.selectedPurchesedAddon.frequency_type?1===e.selectedPurchesedAddon.frequency?"Posts daily":"Posts on every "+e.selectedPurchesedAddon.frequency+" days.":"weeks"===e.selectedPurchesedAddon.frequency_type?1===e.selectedPurchesedAddon.frequency?"Posts weekly, on "+e.selectedPurchesedAddon.post_day_of_the_week:"Posts every "+e.selectedPurchesedAddon.frequency+" weeks, on "+e.selectedPurchesedAddon.post_day_of_the_week:"months"===e.selectedPurchesedAddon.frequency_type?1===e.selectedPurchesedAddon.frequency?"Posts every month, on "+l(e.selectedPurchesedAddon.post_day_of_the_month):"Posts every "+e.selectedPurchesedAddon.frequency+" months, on "+l(e.selectedPurchesedAddon.post_day_of_the_month):"Posts daily"},e.showCustomPosting=function(){return t.featureToggles.addons_custom_posting},e.shouldShowSelectAllDaysOfWeek=function(){var t=!1;return e.selectedPurchesedAddon&&angular.forEach(e.daysOfWeek,function(a){e.selectedDaysFromAdmin.includes(a)&&e.selectedPurchesedAddon.selected_post_days&&(e.selectedPurchesedAddon.selected_post_days[a]||(t=!0))}),t},e.shouldShowSelectNoDaysOfWeek=function(){var t=!0;return e.selectedPurchesedAddon&&angular.forEach(e.daysOfWeek,function(a){e.selectedDaysFromAdmin.includes(a)&&e.selectedPurchesedAddon.selected_post_days&&(e.selectedPurchesedAddon.selected_post_days[a]||(t=!1))}),t},e.togglePostDaysSelectionForAddon=function(t){angular.forEach(e.daysOfWeek,function(a){e.selectedDaysFromAdmin.includes(a)&&(e.selectedPurchesedAddon.selected_post_days[a]=t)})},e.toggleAdminConfigDaysSelectionForAddon=function(t){angular.forEach(e.daysOfWeek,function(a){e.selectedDaysFromAdmin.includes(a)&&(e.selectedPurchesedAddon.adminConfiguredDays[a]=t)})};var u;e.clickedOnDatePicker=function(t){e.datePickerFor=t,u=o.open({template:"/assets/partials/common/rvDatePicker.html",controller:"RVAddonDatePickerController",className:"",scope:e,closeByDocument:!0})},e.dateSelected=function(a){"start_date"===e.datePickerFor?e.selectedPurchesedAddon.start_date=n("date")(a,t.dateFormat):e.selectedPurchesedAddon.end_date=n("date")(a,t.dateFormat),f()},e.closePopup=function(){o.close(),e.showRightContentForMobile=!1},e.goBackToAddonsList=function(){e.showRightContentForMobile=!1},e.closeCalendar=function(){u.close()},e.goToAddons=function(){e.closePopup(),t.$broadcast("NAVIGATE_TO_ADDONS",{addonPostingMode:e.addonPopUpData.addonPostingMode})},e.removeChosenAddons=function(a,r,n){a.stopPropagation(),e.selectedPurchesedAddon="",n.is_allowance&&n.is_consumed_allowance?e.errorMessage=["Cannot remove consumed allowance from staycard"]:(1===e.packageData.existing_packages.length&&e.closePopup(),t.$broadcast("REMOVE_ADDON",{addonPostingMode:e.addonPopUpData.addonPostingMode,index:r,addon:n}))},e.proceedBooking=function(){for(var t=e.selectedPurchesedAddon.custom_nightly_selected_post_days,a=t.length,r=0,n=0,o=d(e.selectedPurchesedAddon.startDateObj,e.selectedPurchesedAddon.endDateObj,"days"),i=0;i<a;i++){var s=t[i];o.includes(s)&&(n++,e.selectedPurchesedAddon.selected_post_days[s]===!1&&r++)}r===n?e.errorMessage=["Please remove the addon if deselecting all the available days"]:(m(),e.$emit("PROCEED_BOOKING",{addonPostingMode:e.addonPopUpData.addonPostingMode,selectedPurchesedAddon:e.selectedPurchesedAddon}),e.closePopup())},e.setDeafultDisplay=function(){angular.copy(e.previousPostDays,e.selectedPurchesedAddon.selected_post_days),e.selectedPurchesedAddon=""},e.shouldShowAddMoreButton=function(){var t=e.addonPopUpData.addonPostingMode;return"staycard"===t||"group"===t||"allotments"===t};var m=function(){angular.forEach(e.packageData.existing_packages,function(a){a.startDateObj?a.start_date=n("date")(tzIndependentDate(a.startDateObj),t.dateFormatForAPI):a.start_date=n("date")(tzIndependentDate(a.start_date),t.dateFormatForAPI),a.endDateObj?a.end_date=n("date")(tzIndependentDate(a.endDateObj),t.dateFormatForAPI):a.end_date=n("date")(tzIndependentDate(a.end_date),t.dateFormatForAPI),angular.forEach(a.post_instances,function(t){var a=new Date(t.post_date),r=e.daysOfWeek[a.getDay()];t.active=e.selectedPurchesedAddon.selected_post_days[r]})})},f=function(){e.daysOfWeek=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];var t,a,r=e.selectedPurchesedAddon.startDateObj,n=e.selectedPurchesedAddon.endDateObj;if(t=(moment(n)-moment(r))/864e5,t--,t<=6){e.daysOfWeekCopy=[],a=r.getDay(),e.selectedPurchesedAddon.is_allowance&&e.selectedPurchesedAddon.is_consume_next_day&&a++;for(var o=0;o<=t;o++)a<7?(e.daysOfWeekCopy.push(e.daysOfWeek[a]),a++):(e.daysOfWeekCopy.push(e.daysOfWeek[a-7]),a++);angular.copy(e.daysOfWeekCopy,e.daysOfWeek)}}}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){sntRover.controller("RVPaymentAddPaymentCtrl",["$rootScope","$scope",function(e,t){BaseCtrl.call(this,t),t.savePayment={},t.isFromGuestCard=!("undefined"==typeof t.passData.isFromGuestCard||!t.passData.isFromGuestCard),t.initCardSwipeRenderData=function(){t.isNewCardAdded=!1,t.shouldShowIframe=!1,t.addmode=!0,t.isGiftCard=!1,t.useDepositGiftCard=!1,t.hideCancelCard=!1,t.depositWithGiftCard=!1,setTimeout(function(){t.$broadcast("addNewCardClicked"),t.$broadcast("hidePayCardToggles",{isFromSwipe:!0})},100)},t.$on("CLOSE_DIALOG",function(){t.closeDialog()}),t.getAddActionType=function(){return t.isFromGuestCard?"ADD_PAYMENT_GUEST_CARD":t.paymentData.isFromBillCard||"billcard"===t.passData.fromView?"ADD_PAYMENT_BILL":"companyTravelAgent"===t.passData.fromView?"ADD_PAYMENT_CO_TA":"ADD_PAYMENT_STAY_CARD"};var a=function(a,r,n){var o=t.billNumber-1;"CC"===r?(_.extend(t.paymentData.bills[o].credit_card_details,{card_code:n.card_code,card_number:n.ending_with,card_expiry:n.expiry_date,payment_id:a.id,is_swiped:n.is_swiped,auth_color_code:n.auth_color_code,token:n.token}),t.paymentData.bills[o].credit_card_details.payment_type=r,1===t.billNumber&&e.$emit("UPDATEDPAYMENTLIST",t.paymentData.bills[o].credit_card_details),e.$broadcast("BALANCECHANGED",{balance:a.reservation_balance,confirm_no:t.paymentData.confirm_no}),e.$broadcast("paymentChangedToCC"),t.$emit("UPDATECCATTACHEDBILLSTATUS",a.has_any_credit_card_attached_bill),a.addToGuestCard&&e.$broadcast("ADDEDNEWPAYMENTTOGUEST",{card_code:n.card_code,mli_token:n.ending_with,card_expiry:n.expiry_date,card_name:n.card_name,id:a.guest_payment_method_id,isSelected:!0,is_primary:!1,payment_type:r||"CC",payment_type_id:1})):(t.paymentData.bills[o].credit_card_details.payment_type=r,t.paymentData.bills[o].credit_card_details.payment_type_description=a.payment_type),t.closeDialog(t.ngDialogId)},r=function(a,r,n){e.$broadcast("ADDEDNEWPAYMENTTOGUEST",{card_code:n.card_code,mli_token:n.ending_with,card_expiry:n.expiry_date,card_name:n.card_name,id:a.id,isSelected:!0,is_primary:!1,payment_type:r||"CC",payment_type_id:1}),t.closeDialog()},n=function(a,r,n){"CC"===r?(t.paymentData.reservation_card.payment_method_used=r,_.extend(t.paymentData.reservation_card.payment_details,{card_type_image:"images/"+n.card_code+".png",card_number:n.ending_with,card_expiry:n.expiry_date,is_swiped:n.is_swiped,auth_color_code:n.auth_color_code})):(t.paymentData.reservation_card.payment_method_description=a.payment_type,t.paymentData.reservation_card.payment_method_used=r),t.paymentData.reservation_card.restrict_post=a.restrict_post,e.$broadcast("UPDATERESERVATIONTYPE",a.reservation_type_id,a.id),t.$emit("UPDATECCATTACHEDBILLSTATUS",a.has_any_credit_card_attached_bill||a.usedEMV&&"CC"===r),a.addToGuestCard&&e.$broadcast("ADDEDNEWPAYMENTTOGUEST",{card_code:n.card_code,mli_token:n.ending_with,card_expiry:n.expiry_date,card_name:n.card_name,id:a.guest_payment_method_id,isSelected:!0,is_primary:!1,payment_type:r||"CC",payment_type_id:1}),t.closeDialog()},o=function(a,r,n){e.$broadcast("ADDEDNEWPAYMENTTOCOTA",{card_code:n.card_code,mli_token:n.ending_with,card_expiry:n.expiry_date,card_name:n.card_name,id:a.id,isSelected:!0,is_primary:!1,payment_type:r||"CC",payment_type_id:1}),t.closeDialog()};t.$on("SUCCESS_LINK_PAYMENT",function(e,i){switch(t.getAddActionType()){case"ADD_PAYMENT_BILL":a(i.response,i.selectedPaymentType,i.cardDetails);break;case"ADD_PAYMENT_GUEST_CARD":r(i.response,i.selectedPaymentType,i.cardDetails);break;case"ADD_PAYMENT_CO_TA":o(i.response,i.selectedPaymentType,i.cardDetails);break;default:n(i.response,i.selectedPaymentType,i.cardDetails)}}),t.$on("ERROR_OCCURED",function(e,a){t.errorMessage=a}),t.$on("PAYMENT_FAILED",function(e,a){t.errorMessage=a}),function(){isEmptyObject(t.passData.details.swipedDataToRenderInScreen)||(t.selectedPaymentType="CC",t.swipedCardData=t.passData.details.swipedDataToRenderInScreen),t.billNumber=t.passData.fromBill||1}()}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){sntRover.controller("RVCardOptionsCtrl",["$rootScope","$scope","$state","ngDialog","$location","$document","RVPaymentSrv","RVReservationCardSrv",function(e,t,a,r,n,o,i,s){BaseCtrl.call(this,t),t.showAddtoGuestCard=!1,t.renderDataFromSwipe=function(a){t.cardData.cardNumber=a.cardNumber,t.cardData.userName=a.nameOnCard,t.cardData.expiryMonth=a.cardExpiryMonth,t.cardData.expiryYear=a.cardExpiryYear,t.cardData.cardType=a.cardType,"guestCard"===a.swipeFrom&&e.$broadcast("swipeAtGuestCard"),"guestCard"===a.swipeFrom?t.showAddtoGuestCard=!1:t.showAddtoGuestCard=!0,"guestCard"!==a.swipeFrom&&"stayCard"!==a.swipeFrom||setTimeout(function(){t.clickedAddNewCard()},100)},t.refreshIframe=function(){if($("#sixIframe").length){var e=document.getElementById("sixIframe");e.src=e.src}},t.$on("REFRESH_IFRAME",function(e){t.refreshIframe()}),e.$on("depositModalAllowGiftCard",function(){t.allowPmtWithGiftCard=!0}),t.checkForGiftCard=function(){t.isGiftCard=!1,e.isStandAlone||t.invokeApi(i.fetchAvailPayments,{},t.cardsListSuccess)},t.hideCardToggles=function(){return!!(t.isFromGuestCard||t.hasAccompanyguest||t.cardsList&&0===t.cardsList.length)},t.$on("isFromGuestCardFalse",function(){t.showAddtoGuestCard=!0,t.isFromGuestCard=!0}),t.$on("hidePayCardToggles",function(e,a){t.isFromGuestCard=!0,a&&a.isFromSwipe&&"guestCard"!==a.swipeFrom&&(t.isFromGuestCard=!1)}),t.$on("giftCardSelectedFromGroups",function(){t.clickedGiftCardToggle()}),t.$on("CLICK_ADD_NEW_CARD",function(){t.clickedAddNewCard()}),t.$on("SHOW_SWIPED_DATA_ON_PAY_SCREEN",function(){t.clickedAddNewCard(),t.$$phase?"":t.$apply()}),t.$on("SHOW_SWIPED_DATA_ON_BILLING_SCREEN",function(){t.clickedAddNewCard(),t.$$phase?"":t.$apply()}),t.$on("SHOW_SWIPED_DATA_ON_DEPOSIT_BALANCE_SCREEN",function(){t.clickedAddNewCard(),t.$$phase?"":t.$apply()}),t.clickedAddNewCard=function(){t.shouldShowIframe=!1,t.addmode=!0,t.isGiftCard=!1,t.useDepositGiftCard=!1,t.hideCancelCard=!1,t.depositWithGiftCard=!1},t.clickedExistingCard=function(){t.shouldShowIframe=!0,t.addmode=!1,t.isGiftCard=!1,t.useDepositGiftCard=!1,t.hideCancelCard=!1,t.depositWithGiftCard=!1},t.clickedGiftCardToggle=function(){t.shouldShowIframe=!0,t.useDepositGiftCard=!0,t.addmode=!1,t.isGiftCard=!0,t.depositWithGiftCard=!0},t.showExistingCards=function(){return!t.addmode&&!t.useDepositGiftCard},t.showGiftCardToggle=function(){return!(t.isStandAlone||!t.allowPmtWithGiftCard)},t.existingSelected=function(){return!t.addmode&&!t.isGiftCard},t.addNewSelected=function(){return!(!t.addmode||t.isGiftCard)},t.hideMLINewCard=function(){return!!("sixpayments"===t.paymentGateway&&t.addmode||t.isManual||t.isGiftCard||t.depositWithGiftCard||t.shouldShowIframe)},t.showAddToGuestCardBox=function(){return t.existingSelected()||t.isGiftCard?t.showAddtoGuestCard=!1:t.addNewSelected()&&(t.showAddtoGuestCard=!0),!!t.showAddtoGuestCard},t.showMLIAddNewCC=function(){return!!t.addNewSelected()||!(!t.isGiftCard||t.showingDepositModal||t.depositWithGiftCard||t.useDepositGiftCard)},e.$on("giftCardSelected",function(){t.shouldShowIframe=!1,e.isStandAlone&&$("#cc-new-card").addClass("ng-hide")}),e.$on("creditCardSelected",function(){e.isStandAlone||(t.shouldShowIframe=!0,$("#cc-new-card").removeClass("ng-hide")),e.isStandAlone&&($("#cc-new-card").removeClass("ng-hide"),t.clickedAddNewCard())}),t.hideIfFromStayCardDirect=function(){e.isStandAlone||(t.swippedCard?t.shouldShowIframe=!1:t.shouldShowIframe=!0)},e.$on("validatedGiftCardPmt",function(e,a){a?t.validPayment=!0:t.validPayment=!1}),t.showMakePaymentButtonStatus=function(){var e="";return e=t.depositBalanceMakePaymentData&&"undefined"!=typeof t.depositBalanceMakePaymentData.payment_type?t.depositBalanceMakePaymentData.payment_type.length>0&&t.validPayment?"green":"grey":t.validPayment?"grey":"grey overlay"},t.useDepositGiftCard=!1,t.cardsListSuccess=function(a){t.allowPmtWithGiftCard=!1,e.allowPmtWithGiftCard=!1,t.$emit("hideLoader");for(var r in a)"GIFT_CARD"===a[r].name&&(t.allowPmtWithGiftCard=!0,t.$parent.allowPmtWithGiftCard=!0,t.$parent.$parent.allowPmtWithGiftCard=!0,t.$parent.$parent.$parent.allowPmtWithGiftCard=!0,e.allowPmtWithGiftCard=!0,e.$broadcast("depositModalAllowGiftCard",!0));e.initFromCashDeposit?t.initFromCashDeposit=!0:t.initFromCashDeposit=!1},t.isGiftCard=!1,t.allowPmtWithGiftCard=!1,e.$on("depositUsingGiftCardChange",function(a,r){e.depositUsingGiftCard?(t.isGiftCard=!0,t.hideCancelCard=!0):(t.isGiftCard=!1,t.hideCancelCard=!1)}),t.refreshIframeWithGuestData=function(e){var t=(new Date).getTime(),a=e.fname,r=e.lname;iFrameUrl=domainUrl+"/api/ipage/index.html?card_holder_first_name="+a+"&card_holder_last_name="+r+"&service_action=createtoken&time="+t;var n=document.getElementById("sixIframe");try{n.src=iFrameUrl}catch(e){console.warn(e.name,e.message)}},t.$on("refreshIframe",function(e,a){t.refreshIframeWithGuestData(a)});var c=n.$$absUrl;domainUrl=c.split("/staff#/")[0],t.cardData={},t.cardData.addToGuestCard=!1,t.cardData.cardNumber="",t.cardData.CCV="",t.cardData.expiryMonth="",t.cardData.expiryYear="",t.cardData.userName="";var d=(new Date).getTime();if(t.shouldShowAddNewCard=!0,"undefined"!=typeof t.passData)var l="undefined"==typeof t.passData.details.firstName?"":t.passData.details.firstName,u="undefined"==typeof t.passData.details.lastName?"":t.passData.details.lastName;if(t.iFrameUrl=domainUrl+"/api/ipage/index.html?card_holder_first_name="+l+"&card_holder_last_name="+u+"&service_action=createtoken&time="+d,"sixpayments"===e.paymentGateway){t.shouldShowAddNewCard=!1;var m=o.find("sixIframe");m.attr("src",t.iFrameUrl),t.showAddtoGuestCard=!1}else t.isFromGuestCard||(t.showAddtoGuestCard=!0);"undefined"==typeof t.passData||isEmptyObject(t.passData.details.swipedDataToRenderInScreen)||t.renderDataFromSwipe(t.passData.details.swipedDataToRenderInScreen),t.shouldShowIframe=!1,t.changeOnsiteCallIn=function(){t.shouldShowIframe=!t.shouldShowIframe,t.isFromGuestCard||(t.shouldShowIframe?(t.showAddtoGuestCard=!0,t.refreshIframe()):t.showAddtoGuestCard=!1)};var f=function(){t.cardData.cardNumber="",t.cardData.CCV="",t.cardData.expiryMonth="",t.cardData.expiryYear=""};t.$on("clearCardDetails",function(){f()});var p=function(e){var a={};a.cardDetails=angular.copy(t.cardData),a.tokenDetails=e,t.$emit("TOKEN_CREATED",a),t.$digest(),t.refreshIframe()},v=function(e){t.$emit("MLI_ERROR",e)},_=function(){var e={};return e.cardNumber=t.cardData.cardNumber,e.cardSecurityCode=t.cardData.CCV,e.cardExpiryMonth=t.cardData.expiryMonth,e.cardExpiryYear=t.cardData.expiryYear,e};t.getToken=function(e){if(e.preventDefault(),isEmptyObject(t.passData.details.swipedDataToRenderInScreen)){var a=_(),r=function(e){e.isSixPayment=!1,p(e)},n=function(e){v(e)};t.fetchMLI(a,r,n)}else{var o=new SwipeOperation,i=o.createSWipedDataToSave(t.passData.details.swipedDataToRenderInScreen);i.addToGuestCard=t.cardData.addToGuestCard,i.card_name&&""!==i.card_name||(i.card_name=t.cardData.userName),t.$emit("SWIPED_DATA_TO_SAVE",i);
}},t.$on("six_token_recived",function(e,a){a.six_payment_data.isSixPayment=!0,t.shouldShowAddNewCard=!1,p(a.six_payment_data)}),t.setCreditCardFromList=function(e){t.$emit("cardSelected",{index:e}),t.cardselectedIndex=e},t.setToShowCancelCard=function(){t.hideCancelCard=!1,t.depositWithGiftCard=!1},t.setToHideCancelCard=function(){t.hideCancelCard=!0},t.showCancelCardSelection=function(){return!t.hideCancelCard&&!t.depositWithGiftCard},t.isSixPayPayment=function(){return!!("sixpayments"===t.paymentGateway&&t.addmode||t.isManual)},t.cancelCardSelection=function(){e.isStandAlone?(t.$emit("cancelCardSelection"),t.cardselectedIndex=-1,t.refreshIframe()):r.close()},t.$on("cancelCardSelection",function(){t.depositWithGiftCard=!1,t.isGiftCard=!1,t.hideCancelCard=!1}),t.$on("showCancelCreditCardButton",function(){t.setToShowCancelCard()}),t.giftCardAmountAvailable=!1,t.giftCardAvailableBalance=0,t.$on("giftCardAvailableBalance",function(e,a){t.giftCardAvailableBalance=a.amount}),t.timer=null,t.cardNumberInput=function(a,r,n){if(n?(t.isGiftCard=!0,t.useDepositGiftCard=!0,e.useDepositGiftCard=!0):e.useDepositGiftCard=!1,t.isGiftCard||n){var o=a.length;t.num=a,o>=8&&o<=22?$("[name=card-number]").keydown(function(){clearTimeout(t.timer),t.timer=setTimeout(t.fetchGiftCardBalance,1500)}):t.giftCardAmountAvailable=!1}},t.num,t.fetchGiftCardBalance=function(){if(t.isGiftCard){var e=function(e){t.giftCardAvailableBalance=e.amount,t.giftCardAmountAvailable=!0,t.$emit("giftCardAvailableBalance",e),t.$emit("hideLoader")};t.invokeApi(s.checkGiftCardBalance,{card_number:t.num},e)}else t.giftCardAmountAvailable=!1},t.$on("addNewCardClicked",function(){t.clickedAddNewCard()}),t.$on("existingCardClicked",function(){t.clickedExistingCard()}),t.$on("RENDER_SWIPED_DATA",function(e,a){t.swippedCard=!0,t.renderDataFromSwipe(a),t.passData.details.swipedDataToRenderInScreen=a,setTimeout(function(){t.clickedAddNewCard()},100)})}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){sntRover.controller("RVSmartBandsCheckoutController",["$scope","$state","$stateParams","RVSmartBandSrv",function(e,t,a,r){BaseCtrl.call(this,e),e.getBalanceSmartBandSuccess=function(t){e.$emit("hideLoader"),e.remainingSmartBands=t.results},e.showBalanceSmartBands=function(){var t={reservationId:e.reservation.reservation_card.reservation_id};e.invokeApi(r.getBalanceSmartBands,t,e.getBalanceSmartBandSuccess)},e.showBalanceSmartBands(),e.cashOutSmartBandSuccess=function(){var a=e.reservation.reservation_card.reservation_id;e.$emit("hideLoader"),e.closeDialog(),t.go("rover.reservation.staycard.billcard",{reservationId:a,clickedButton:e.clickedButton})},e.clickCreditToRoom=function(){var t=e.reservation.reservation_card.reservation_id;e.invokeApi(r.cashOutSmartBalance,t,e.cashOutSmartBandSuccess)}}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){sntRover.controller("RVSmartBandsController",["$scope","$state","$stateParams","RVSmartBandSrv",function(e,t,a,r){BaseCtrl.call(this,e),e.smartBandData={},e.bandData={},e.selectedReservationStatus=e.reservationData.reservation_card.reservation_status,e.smartBandData.firstName=JSON.parse(JSON.stringify(e.data.guest_details.first_name)),e.smartBandData.lastName=JSON.parse(JSON.stringify(e.data.guest_details.last_name)),e.smartBandLength=0,e.showAddNewSmartBandScreen=!1,e.isFixedAmount=!1,e.showWriteToBand=!1,e.showSuccess=!1,e.showSmartBandListView=!1,e.firstTimeClick=!0,e.showBandEditScreen=!1;var n=this;n.lastSuccessfulIDReaded="",e.addNewSmartband=function(){"CHECKEDOUT"!==e.selectedReservationStatus&&(e.errorMessage="",e.showSmartBandListView=!1,e.showAddNewSmartBandScreen=!0,e.showSuccess=!1,e.showWriteToBand=!1,e.smartBandLength>0&&(e.smartBandData.firstName="",e.smartBandData.lastName=""),e.smartBandData.fixedAmount="")},e.setPaymentType=function(){e.isFixedAmount=!e.isFixedAmount},e.createSmartBandFailure=function(t){e.$emit("hideLoader"),e.errorMessage=t,e.showSmartBandListView=!1},e.createSmartBandSuccess=function(t){e.$emit("hideLoader"),n.newBandInfo={id:t.id,first_name:e.smartBandData.firstName,last_name:e.smartBandData.lastName,is_fixed:e.isFixedAmount,amount:e.smartBandData.fixedAmount,account_number:t.account_number},e.smartBands.push(n.newBandInfo),e.smartBandLength=e.smartBands.length,e.reservationData.reservation_card.balance_amount=t.balance_amount,e.$apply(),e.writeBandType()},e.fetchSuccessKeyRead=function(t){e.$emit("hideLoader"),n.lastSuccessfulIDReaded=t;var a={first_name:e.smartBandData.firstName,last_name:e.smartBandData.lastName,account_number:t,is_fixed:e.isFixedAmount};e.isFixedAmount&&(a.amount=e.smartBandData.fixedAmount);var o={postData:a,reservationId:e.reservation.reservation_card.reservation_id};e.invokeApi(r.createSmartBand,o,e.createSmartBandSuccess,e.createSmartBandFailure)},e.fetchFailedKeyRead=function(t){e.$emit("hideLoader"),e.errorMessage=[t.RVErrorDesc],e.$apply()},e.clickContinueButton=function(){document.activeElement.blur(),setTimeout(function(){window.scrollTo(0,0)},700);var t="";if(n.lastSuccessfulIDReaded="",e.isFixedAmount)if(""===e.smartBandData.fixedAmount||null===e.smartBandData.fixedAmount)t=""===t?"Amount":t+", Amount";else{var a=/^(0|[1-9][0-9]{0,2}(?:(,[0-9]{3})*|[0-9]*))(\.[0-9]+){0,1}$/;a.test(e.smartBandData.fixedAmount)||(t=""===t?"Amount is not valid":t+", Amount is not valid")}if(""!==t)e.errorMessage=["Please enter "+t];else{var r={successCallBack:e.fetchSuccessKeyRead,failureCallBack:e.fetchFailedKeyRead};e.$emit("showLoader"),e.showWriteToBand=!0,sntapp.cardSwipeDebug?sntapp.cardReader.retrieveUserIDDebug(r):sntapp.cardReader.retrieveUserID(r)}},e.listSmartBandSuccess=function(t){e.showAddNewSmartBandScreen=!1,e.isFixedAmount=!1,e.showWriteToBand=!1,e.showSuccess=!1,e.showSmartBandListView=!0,e.showBandEditScreen=!1,e.$emit("hideLoader"),e.firstTimeClick?(e.firstTimeClick=!1,e.smartBands=t.results):e.smartBands=t,e.smartBandLength=e.smartBands.length},e.seeAllBands=function(){if(e.errorMessage="",e.firstTimeClick){var t={reservationId:e.reservation.reservation_card.reservation_id};e.invokeApi(r.listSmartBands,t,e.listSmartBandSuccess)}else e.listSmartBandSuccess(e.smartBands)},e.seeAllBands(),e.getSmartBandSuccess=function(t){e.bandData=t,e.$emit("hideLoader"),e.showBandEditScreen=!0,e.showAddNewSmartBandScreen=!1,e.isFixedAmount=!1,e.showWriteToBand=!1,e.showSuccess=!1,e.showSmartBandListView=!1},e.editBandDetails=function(t){"CHECKEDOUT"!==e.selectedReservationStatus&&(e.bandEditId=t,e.invokeApi(r.getSmartBandDetails,t,e.getSmartBandSuccess))},e.updateSmartBandSuccess=function(t){e.$emit("hideLoader"),angular.forEach(e.smartBands,function(t,a){t.id===e.bandEditId&&(void 0!==e.bandData.additionalCredit&&(t.amount=parseInt(t.amount)+parseInt(e.bandData.additionalCredit)),t.first_name=e.bandData.first_name,t.last_name=e.bandData.last_name)}),e.reservationData.reservation_card.balance_amount=t.balance_amount,e.$apply(),e.seeAllBands()},e.clickContinueEdit=function(t){if(document.activeElement.blur(),setTimeout(function(){window.scrollTo(0,0)},700),t){var a={postData:{credit:parseInt(e.bandData.additionalCredit),first_name:e.bandData.first_name,last_name:e.bandData.last_name},bandId:e.bandEditId};e.invokeApi(r.updateSmartBandDetails,a,e.updateSmartBandSuccess)}else e.seeAllBands()},e.writeBandType=function(){var t=[],a="00000002";n.newBandInfo.is_fixed&&(a="00000001"),t.push(a),t.push(n.lastSuccessfulIDReaded),t.push("19");var r={successCallBack:function(){e.$emit("hideLoader"),e.showSuccess=!0,e.$apply(),n.lastSuccessfulIDReaded=""},failureCallBack:function(t){var a=[t.RVErrorDesc];n.lastSuccessfulIDReaded="",e.createSmartBandFailure(a),e.$apply()},arguments:t};sntapp.cardSwipeDebug?sntapp.cardReader.setBandTypeDebug(r):sntapp.cardReader.setBandType(r)}}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){sntRover.controller("RVValidateEmailCtrl",["$scope","$state","ngDialog","RVContactInfoSrv",function(e,t,a,r){BaseCtrl.call(this,e),e.saveData={},e.saveData.email="",e.ignoreAndGoToCheckout=function(){e.callBackMethodCheckout&&e.callBackMethodCheckout(),a.close()},e.submitAndGoToCheckout=function(){if(""===e.saveData.email)return!1;e.saveData.guest_id=e.guestCardData.guestId,e.saveData.user_id=e.guestCardData.userId;var t={data:e.saveData,userId:e.guestCardData.userId};e.invokeApi(r.saveContactInfo,t,e.submitAndGoToCheckoutSuccessCallback)},e.submitAndGoToCheckoutSuccessCallback=function(){e.guestCardData.contactInfo.email=e.saveData.email,e.saveData.isEmailPopupFlag=!0,e.$emit("hideLoader"),a.close(),e.callBackMethodCheckout&&e.callBackMethodCheckout()},e.saveUserInfoFailureCallback=function(t){e.$emit("hideLoader"),e.errorMessage=t}}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){sntRover.controller("RVShowValidationErrorCtrl",["$rootScope","$scope","ngDialog","RVBillCardSrv","$state",function(e,t,a,r,n){BaseCtrl.call(this,t);var o=function(){t.flag={},t.flag.roomStatusReady=!1},i=function(e){"bill"===e?t.$emit("STAY_ON_BILL"):n.go("rover.dashboard.manager"),a.close()};t.okButtonClicked=function(e){if(t.flag.roomStatusReady){if("true"===t.reservationBillData.checkin_inspected_only)var a={hkstatus_id:2,room_no:t.reservationBillData.room_number};else var a={hkstatus_id:1,room_no:t.reservationBillData.room_number};var n=function(a){t.$emit("hideLoader"),i(e)};t.invokeApi(r.changeHousekeepingStatus,a,n)}else i(e)},o()}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){sntRover.controller("RVTermsAndConditionsDialogCtrl",["$rootScope","$scope","$state","ngDialog","RVValidateCheckinSrv",function(e,t,a,r,n){BaseCtrl.call(this,t);var o={preventDefault:!1};t.setScroller("termsandconditions",o),setTimeout(function(){t.refreshScroller("termsandconditions")},500),t.clickCancel=function(){r.close()},t.agreeButtonClicked=function(){t.saveData.termsAndConditions=!0,r.close()},t.disagreeButtonClicked=function(){t.saveData.termsAndConditions=!1,r.close()}}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){sntRover.controller("RVValidateEmailPhoneCtrl",["$rootScope","$scope","$state","$timeout","ngDialog","RVValidateCheckinSrv","RVGuestCardsSrv",function(e,t,a,r,n,o,i){BaseCtrl.call(this,t),t.showEmail=void 0===t.guestCardData.contactInfo.email||""===t.guestCardData.contactInfo.email||null===t.guestCardData.contactInfo.email,t.showPhone=void 0===t.guestCardData.contactInfo.phone||""===t.guestCardData.contactInfo.phone||null===t.guestCardData.contactInfo.phone,t.showMobile=void 0===t.guestCardData.contactInfo.mobile||""===t.guestCardData.contactInfo.mobile||null===t.guestCardData.contactInfo.mobile,t.showNationality=(t.guestCardData.contactInfo.guest_admin_settings.nationality.is_mandatory_on_guest_card_creation||t.roverObj.forceNationalityAtCheckin)&&(void 0===t.guestCardData.contactInfo.nationality_id||""===t.guestCardData.contactInfo.nationality_id||null===t.guestCardData.contactInfo.nationality_id),t.showCountry=!t.guestCardData.contactInfo.address||void 0===t.guestCardData.contactInfo.address.country_id||""===t.guestCardData.contactInfo.address.country_id||null===t.guestCardData.contactInfo.address.country_id;var s=t.showNationality,c=t.showCountry;t.saveData={},t.saveData.email="",t.saveData.phone="",t.saveData.guest_id="",t.saveData.user_id="",t.saveData.gender_id=t.guestCardData.contactInfo.gender_id,t.guestCardData.contactInfo.genderTypeList=t.guestCardData.contactInfo.gender_list,t.putInQueue=!1,t.setScroller("guestCardFields");var d=function(){r(function(){t.refreshScroller("guestCardFields")},1500)};t.popupCalendar=function(e){t.calenderFor=e,t.datePicker=n.open({template:"/assets/partials/guestCard/contactInfoCalendarPopup.html",controller:"RVAllContactInfoDatePickerController",className:"single-date-picker",scope:t})},t.hasAnySharerCheckedin=function(){var e=!1;return angular.forEach(t.reservationData.reservation_card.sharer_information,function(t,a){if("CHECKEDIN"===t.reservation_status||"CHECKING_OUT"===t.reservation_status)return e=!0,!1}),e},t.clickCancel=function(){n.close()},t.checkGuestInFromQueue=!1,t.putGuestInQueue=!1,e.reservationQueueWatch||(e.reservationQueueWatch=1,e.$on("putGuestInQueue",function(){t.putGuestInQueue=!0,e.putGuestInQueue=!0,t.checkGuestInFromQueue=!1,e.checkGuestInFromQueue=!1}),e.$on("checkGuestInFromQueue",function(){t.checkGuestInFromQueue=!0,e.checkGuestInFromQueue=!0,t.putGuestInQueue=!1,e.putGuestInQueue=!1}),e.$on("normalCheckInNotQueued",function(){t.checkGuestInFromQueue=!1,e.checkGuestInFromQueue=!1,t.putGuestInQueue=!1,e.putGuestInQueue=!1})),t.validateEmailPhoneSuccessCallback=function(e){if(""!==e.response.mandatory_field_missing_message&&null!==e.response.mandatory_field_missing_message&&(t.errorMessage=e.response.mandatory_field_missing_message,t.$emit("parentShowError",t.errorMessage)),t.showPhone&&(t.guestCardData.contactInfo.phone=t.saveData.phone),t.showEmail&&(t.guestCardData.contactInfo.email=t.saveData.email),t.showMobile&&(t.guestCardData.contactInfo.mobile=t.saveData.mobile),t.showNationality&&(t.guestCardData.contactInfo.nationality_id=t.saveData.nationality_id),t.showCountry)try{t.guestCardData.contactInfo.address.country_id=t.saveData.address.country_id}catch(e){t.guestCardData.contactInfo.address={},t.guestCardData.contactInfo.address.country_id=t.saveData.address.country_id}t.showJobTitle&&(t.guestCardData.contactInfo.job_title=t.saveData.job_title),t.showNameOfFather&&(t.guestCardData.contactInfo.father_name=t.saveData.father_name),t.showNameOfMother&&(t.guestCardData.contactInfo.mother_name=t.saveData.mother_name),t.showPlaceOfBirth&&(t.guestCardData.contactInfo.birth_place=t.saveData.birth_place),t.showGender&&(t.guestCardData.contactInfo.gender_id=t.saveData.gender_id),t.showPersonalIdNumber&&(t.guestCardData.contactInfo.personal_id_no=t.saveData.personal_id_no),t.showVehicleRegistrationNumber&&(t.guestCardData.contactInfo.vehicle_registration_number=t.saveData.vehicle_registration_number),t.showIdPlaceOfIssue&&(t.guestCardData.contactInfo.id_place_of_issue=t.saveData.id_place_of_issue),t.showIdCountryOfIssue&&(t.guestCardData.contactInfo.id_country_id=t.saveData.id_country_id),t.showHomeTown&&(t.guestCardData.contactInfo.home_town=t.saveData.home_town),t.showPlaceOfResidence&&(t.guestCardData.contactInfo.place_of_residence=t.saveData.place_of_residence),t.showVehicleCountryMark&&(t.guestCardData.contactInfo.country_code=t.saveData.country_code),t.showDateOfBirth&&(t.guestCardData.contactInfo.birth_day=t.saveData.birth_day),t.showIdExpDate&&(t.guestCardData.contactInfo.id_expiration_date=t.saveData.id_expiration_date),t.$emit("hideLoader"),n.close(),t.goToNextView()},t.reservationIsQueued=function(){return"true"===t.reservationData.reservation_card.is_reservation_queued},t.roomAssignmentNeeded=function(){return(""===t.reservationData.reservation_card.room_number||"DIRTY"===t.reservationData.reservation_card.room_ready_status||"READY"!==t.reservationData.reservation_card.room_status||"VACANT"!==t.reservationData.reservation_card.fo_status)&&(!(""!==t.reservationData.reservation_card.room_number||!t.reservationIsQueued()&&!t.putInQueue)||("NOTREADY"!==t.reservationData.reservation_card.room_status||!t.reservationIsQueued()&&!t.putInQueue))},t.upsellNeeded=function(){return"true"===t.reservationData.reservation_card.is_force_upsell&&"true"===t.reservationData.reservation_card.is_upsell_available&&(!!t.putInQueue||!t.reservationIsQueued())},t.readyToPutInQueue=function(){return!(!t.putGuestInQueue&&!e.putGuestInQueue||t.roomAssignmentNeeded()||t.upsellNeeded()||t.checkGuestInFromQueue)},t.goToRoomAssignment=function(){var e=t.reservationData.reservation_card.reservation_status,r="true"===t.reservationData.reservation_card.is_upsell_available&&("RESERVED"===e||"CHECKING_IN"===e),n=t.reservationData.reservation_card.cannot_move_room&&""!==t.reservationData.reservation_card.room_number;a.go("rover.reservation.staycard.roomassignment",{reservation_id:t.reservationData.reservation_card.reservation_id,room_type:t.reservationData.reservation_card.room_type_code,clickedButton:"checkinButton",upgrade_available:r,cannot_move_room:n,roomTypeId:t.reservationData.reservation_card.room_type_id})},t.goToUpgrades=function(){a.go("rover.reservation.staycard.upgrades",{reservation_id:t.reservationData.reservation_card.reservation_id,clickedButton:"checkinButton"})},t.goToBillCard=function(){a.go("rover.reservation.staycard.billcard",{reservationId:t.reservationData.reservation_card.reservation_id,clickedButton:"checkinButton"})},t.emitPutGuestInQueue=function(){t.putGuestInQueue&&setTimeout(function(){e.$emit("putGuestInQueue")},1e3)},t.goToNextView=function(){t.hasAnySharerCheckedin()||t.checkGuestInFromQueue?t.goToBillCard():t.roomAssignmentNeeded()?(t.goToRoomAssignment(),t.emitPutGuestInQueue()):!t.upsellNeeded()||t.checkGuestInFromQueue||t.reservationData.reservation_card.is_suite?t.goToBillCard():(t.goToUpgrades(),t.emitPutGuestInQueue())},t.submitAndGoToCheckin=function(){if(t.shouldEnableSubmitButton()&&t.isDemographicsFormValid()){t.saveData.guest_id=t.guestCardData.guestId,t.saveData.user_id=t.guestCardData.userId;var e=!1;if(t.showEmail&&t.showPhone&&t.showMobile)t.saveData=t.saveData,""===t.saveData.email&&""===t.saveData.phone&&""===t.saveData.mobile||(e=!0);else if(t.showPhone&&t.showMobile){var a=["email"];t.saveData=dclone(t.saveData,a),""===t.saveData.phone&&""===t.saveData.mobile||(e=!0)}else if(t.showEmail&&t.showMobile){var a=["phone"];t.saveData=dclone(t.saveData,a),""===t.saveData.phone&&""===t.saveData.mobile||(e=!0)}else if(t.showEmail&&t.showPhone){var a=["mobile"];t.saveData=dclone(t.saveData,a),""===t.saveData.phone&&""===t.saveData.mobile||(e=!0)}else if(t.showEmail){var a=["mobile","phone"];t.saveData=dclone(t.saveData,a),""===t.saveData.phone&&""===t.saveData.mobile||(e=!0)}else if(t.showPhone){var a=["mobile","email"];t.saveData=dclone(t.saveData,a),""===t.saveData.phone&&""===t.saveData.mobile||(e=!0)}else{var a=["phone","email"];t.saveData=dclone(t.saveData,a),""!==t.saveData.email&&(e=!0)}t.showNationality&&(t.saveData.nationality_id=t.guestCardData.contactInfo.nationality_id,e=!0),t.showCountry&&(t.saveData.address={},t.saveData.address.country_id=t.guestCardData.contactInfo.address?t.guestCardData.contactInfo.address.country_id:"",e=!0),t.saveData.reservationId=t.reservationParentData.reservationId,t.reservationParentData.demographics.reservationType&&(t.saveData.reservation_type_id=t.reservationParentData.demographics.reservationType),t.reservationParentData.demographics.source&&(t.saveData.source_id=t.reservationParentData.demographics.source),t.reservationParentData.demographics.market&&(t.saveData.market_segment_id=t.reservationParentData.demographics.market),t.reservationParentData.demographics.origin&&(t.saveData.booking_origin_id=t.reservationParentData.demographics.origin),t.reservationParentData.demographics.segment&&(t.saveData.segment_id=t.reservationParentData.demographics.segment),e?t.invokeApi(i.fetchGuestAdminSettings,"",function(e){var a=angular.copy(t.saveData);a.guest_admin_settings=e,t.invokeApi(o.saveGuestDataAndReservationDemographics,a,t.validateEmailPhoneSuccessCallback)}):t.errorMessage=["Please fill the fields"]}},t.submitAndCheckinSuccessCallback=function(e){""!==e.response.mandatory_field_missing_message&&null!==e.response.mandatory_field_missing_message&&(t.errorMessage=e.response.mandatory_field_missing_message,t.$emit("parentShowError",t.errorMessage)),t.guestCardData.contactInfo.email=t.saveData.email,t.$emit("hideLoader"),n.close()},t.submitAndCheckin=function(){t.saveData.guest_id=t.guestCardData.guestId,t.saveData.user_id=t.guestCardData.userId;var e=["phone"];t.saveData=dclone(t.saveData,e),t.saveData.ignoreDemographicsUpdate=!0,t.invokeApi(i.fetchGuestAdminSettings,"",function(e){var a=angular.copy(t.saveData);a.guest_admin_settings=e,t.invokeApi(o.saveGuestDataAndReservationDemographics,a,t.submitAndCheckinSuccessCallback)})},t.closeDialog=function(){if(s&&(t.saveData.nationality_id="",t.guestCardData.contactInfo.nationality_id=""),c){t.saveData.country_id="";try{t.guestCardData.contactInfo.address.country_id=""}catch(e){t.guestCardData.contactInfo.address={},t.guestCardData.contactInfo.address.country_id=""}}n.close()},t.ignoreAndGoToCheckin=function(){t.closeDialog(),t.goToNextView()},t.shouldEnableSubmitButton=function(){return e.roverObj.forceCountryAtCheckin&&e.roverObj.forceNationalityAtCheckin?_.isFinite(t.guestCardData.contactInfo.nationality_id)&&_.isFinite(t.guestCardData.contactInfo.address.country_id):e.roverObj.forceCountryAtCheckin?_.isFinite(t.guestCardData.contactInfo.address.country_id):!e.roverObj.forceNationalityAtCheckin||_.isFinite(t.guestCardData.contactInfo.nationality_id)},t.initAdvQueCheck=function(){var a=e.advanced_queue_flow_enabled,r=t.reservationData.check_in_via_queue;a&&r?t.putInQueue=!0:t.putInQueue=!1},t.initAdvQueCheck(),t.$emit("hideLoader"),d()}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){window.GuestCardBaseCtrl=function(e,t,a,r,n){e.manageCardState={isOpen:!1},e.getContactInfo=function(e){var t=["first_name","last_name","mobile","phone","email","vip"],a=_.pick(e,t);return a.address={state:e.address&&e.address.state?e.address.state:"",city:e.address&&e.address.city?e.address.city:""},a},e.updateSearchCache=function(a){var r=e.guestCardData.contactInfo,n={firstname:r.first_name,lastname:r.last_name,vip:r.vip,is_flagged:r.is_flagged};a&&(n.avatar=a),r.address&&(""!==e.escapeNull(r.address.city).toString().trim()||""!==e.escapeNull(r.address.state).toString().trim()?n.location=r.address.city+", "+r.address.state:n.location=!1),t.updateGuestDetails(e.guestCardData.contactInfo.user_id,n)},e.removeGuestDetails=function(t){var r=e.guestCardData.contactInfo.can_guest_card_delete,o=e.guestCardData.contactInfo.can_guest_details_anonymized,i=function(){r?e.navigateBack():o&&(e.$broadcast("REFRESH_CONTACT_INFO",{guestId:t}),n.$broadcast("UPDATE_GUEST_CARD_ACTIONS_BUTTON_STATUS",{status:!1}))},s=function(t){e.errorMessage=t},c={params:t,successCallBack:i,failureCallBack:s};r?e.callAPI(a.deleteGuest,c):o&&e.callAPI(a.removeGuestDetails,c)};var o=function(t){var r=function(e){n.$broadcast("SET_GUEST_CARD_DATA",{contactInfo:e,guestId:t}),n.$broadcast("CONTACTINFOLOADED"),n.$broadcast("RESETCONTACTINFO",e)},o=function(t){e.errorMessage=t},i={params:t,successCallBack:r,failureCallBack:o};e.callAPI(a.getGuestDetailsById,i)},i=e.$on("REFRESH_CONTACT_INFO",function(e,t){o(t.guestId)});e.$on("$destroy",i),e.hasRemoveGuestDetailsPermission=function(){return r.getPermissionValue("REMOVE_GUEST_DETAILS")},e.toggleCardActions=function(){e.manageCardState.isOpen=!e.manageCardState.isOpen},e.shouldDisableRemoveGuestBtn=function(){return!e.guestCardData.contactInfo.can_guest_details_anonymized&&!e.guestCardData.contactInfo.can_guest_card_delete||!e.hasRemoveGuestDetailsPermission()},e.getUpdatedContactInfo=function(e,t){var a=e;return a.avatar=t?"/ui/pms-ui/images/avatar-trans.png":"",a.vip=t?e.vip:"",a.birthday=t?e.birthday:null,a.user_id=t?t:"",a.guest_id=t?t:"",a}}},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){sntRover.controller("RVGuestCardActivityLogController",["$scope","$rootScope","$stateParams","$timeout","RVGuestCardActivityLogSrv",function(e,t,a,r,n){BaseCtrl.call(this,e);var o=this,i=1e3,s=function(){r(function(){e.refreshScroller("rvGuestCardActivityLogScroll")},500)},c=function(){e.activityLogObj={response:{},perPage:50,page:1,sortField:"DATE",sortOrder:"asc",accountId:""},e.activityLogFilter={user:"",date:"asc",action:""},e.activityLogPagination={id:"GUEST_ACTIVITY_LOG",api:o.loadAPIData,perPage:e.activityLogObj.perPage},e.setScroller("rvGuestCardActivityLogScroll",{}),s()};e.showPagination=function(){var t=!1,a=e.activityLogObj.response;return"undefined"!=typeof a&&"undefined"!=typeof a.results&&a.results.length<a.total_count&&a.results.length>0&&(t=!0),t},o.loadAPIData=function(t){if(e.guestCardData&&e.guestCardData.guestId||a.guestId){e.activityLogObj.page=t?t:1,e.activityLogObj.accountId="undefined"==typeof e.guestCardData?a.guestId:e.guestCardData.guestId;var o={params:{page:e.activityLogObj.page,per_page:e.activityLogObj.perPage,sort_field:e.activityLogObj.sortField,sort_order:e.activityLogObj.sortOrder,id:e.activityLogObj.accountId},successCallBack:function(t){e.activityLogObj.response=t,e.errorMessage="",s(),r(function(){e.$broadcast("updatePagination","GUEST_ACTIVITY_LOG")},i)},failureCallBack:function(t){e.errorMessage=t}};e.callAPI(n.fetchActivityLog,o)}};var d=function(t){e.activityLogObj.sortField=t;var a=e.activityLogFilter;switch(t){case"USERNAME":""===a.user||"asc"===a.user?a.user="desc":a.user="asc",e.activityLogObj.sortOrder=a.user;break;case"DATE":""===a.date||"asc"===a.date?a.date="desc":a.date="asc",e.activityLogObj.sortOrder=a.date;break;case"ACTION":""===a.action||"asc"===a.action?a.action="desc":a.action="asc",e.activityLogObj.sortOrder=a.action}o.loadAPIData()};e.sortByAction=function(e){d(e)};var l=e.$on("GUEST_ACTIVITY_LOADED",function(){r(function(){o.loadAPIData()},i)});e.isOldValue=function(e){var t=!0;return""!==e&&"undefined"!=typeof e&&null!==e||(t=!1),t},c(),e.$on("$destroy",l)}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){window.StatisticsBaseCtrl=function(e,t){e.getStatusIconClass=function(e){var t="neutral";return e<0?t="icons time check-out rotate-right":e>0&&(t="icons time check-in rotate-right"),t},e.getStatusClass=function(e){var t="";return e>0?t="green":e<0&&(t="red"),t},e.absVal=function(e){return e?Math.abs(e):""},e.getCurrentYear=function(){var e=tzIndependentDate(t.businessDate),a=e.getFullYear();return a},e.populateYearDropDown=function(t){var a,r="";e.yearOptions=[],"summary"===e.activeView?(t=t===e.getCurrentYear()?t-1:t,a=e.getCurrentYear()-1):a=e.getCurrentYear();for(var n=a;n>=t;n--)r=n===a?"summary"===e.activeView?"LAST YEAR ("+n+")":"YEAR TO DATE ("+n+")":n,e.yearOptions.push({name:r,value:n})},e.getReservationClass=function(e){var t={RESERVED:"arrival",CHECKING_IN:"check-in",CHECKEDIN:"inhouse",CHECKING_OUT:"check-out",CHECKEDOUT:"departed",CANCELED:"cancel",NOSHOW:"no-show",NOSHOW_CURRENT:"no-show"};return t[e.reservation_status.toUpperCase()]||""}}},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){angular.module("sntRover").controller("RVGuestCardStatisticsController",["$scope","$rootScope","RVGuestCardsSrv","$timeout","$vault","$state","$stateParams",function(e,t,a,r,n,o,i){var s={},c="guest-sidebar-scroller",d="guest-monthly-data-scroller",l="guest-statistics-summary-sidebar-scroller",u="guest-statistics-summary-data-scroller";BaseCtrl.call(this,e),StatisticsBaseCtrl.call(this,e,t);var m=function(){var t=function(t){e.statistics.summary=t,e.activeView="summary",r(function(){g(!0)},200),I()},n=function(){e.statistics.summary={}},o={params:{year:e.filterData.selectedYear,guestId:e.guestID},onSuccess:t,onFailure:n};e.callAPI(a.fetchGuestCardStatisticsSummary,o)},f=function(){var t=function(t){e.statistics.details=t,e.statistics.details.monthly_data=e.statistics.details.monthly_data.reverse(),r(function(){g(!0)},500),S()},n=function(){e.statistics.details=[]},o={params:{year:e.filterData.selectedYear,guestId:e.guestID},onSuccess:t,onFailure:n};e.callAPI(a.fetchGuestCardStatisticsDetails,o)},p=function(){s.LOAD_GUEST_STATISTICS=e.$on("LOAD_GUEST_STATISTICS",function(){m()}),s.UPDATE_CONTACT_INFO=e.$on("UPDATE_CONTACT_INFO",function(){h()})},v=function(){angular.forEach(function(t){e.$on("$destroy",t)})};e.setActiveView=function(t,a){e.activeView=t,"details"===t?(e.filterData.selectedYear=a||e.getCurrentYear(),y(),S(),D(),f()):(e.filterData.selectedYear=e.getCurrentYear()-1,y(),I(),D(),
m())},e.showMonthlyReservations=function(e){return!_.isEmpty(e.reservations.reservations)&&(e.isOpen=!e.isOpen,void r(function(){g()},200))},e.onChangeYear=function(){"summary"===e.activeView?m():f()},e.navigateToStayCard=function(t){return"rover.guest.details"===o.current.name&&(n.set("guestId",e.guestCardData.userId),n.set("selectedYear",e.filterData.selectedYear),void o.go("rover.reservation.staycard.reservationcard.reservationdetails",{id:t.reservation_id,confirmationId:t.confirmation_no,isrefresh:!0,isFromGuestStatistics:!0}))},e.shouldShowNavigation=function(){var e=!0;return"rover.guest.details"===o.current.name&&(e=!1),e},e.getStyleForExpandedView=function(t){var a={},r=t.reservations_count||t.reservations.reservations&&t.reservations.reservations.length;if(t.isOpen){var n=70*r+30;e.totalResultCount>e.perPage&&(n+=60),a["margin-bottom"]=n+"px"}return a};var D=function(){e.populateYearDropDown(e.guestCardData.contactInfo.first_stay_year)},h=function(){e.statistics={summary:{},details:[]},e.guestID=e.guestCardData.userId,e.filterData={selectedYear:e.getCurrentYear()-1},e.currentYear=e.getCurrentYear(),D()},y=function(){e.setScroller(c,{preventDefault:!1,probeType:3}),e.setScroller(d,{preventDefault:!1,probeType:3,scrollX:!0}),e.setScroller(l,{preventDefault:!1,probeType:3}),e.setScroller(u,{preventDefault:!1,probeType:3,scrollX:!0})},g=function(t){r(function(){e.myScroll.hasOwnProperty(c)&&(e.refreshScroller(c),t&&e.myScroll[c].scrollTo(0,0,100)),e.myScroll.hasOwnProperty(d)&&(e.refreshScroller(d),t&&e.myScroll[d].scrollTo(0,0,100)),e.myScroll.hasOwnProperty(l)&&(e.refreshScroller(l),t&&e.myScroll[l].scrollTo(0,0,100)),e.myScroll.hasOwnProperty(u)&&(e.refreshScroller(u),t&&e.myScroll[u].scrollTo(0,0,100))},200)},C=function(){e.myScroll.hasOwnProperty(c)&&e.myScroll.hasOwnProperty(d)&&(e.myScroll[c].on("scroll",function(){e.myScroll[d].scrollTo(0,this.y)}),e.myScroll[d].on("scroll",function(){e.myScroll[c].scrollTo(0,this.y)}))},A=function(){e.myScroll.hasOwnProperty(l)&&e.myScroll.hasOwnProperty(u)&&(e.myScroll[l].on("scroll",function(){e.myScroll[u].scrollTo(0,this.y)}),e.myScroll[u].on("scroll",function(){e.myScroll[l].scrollTo(0,this.y)}))},S=function t(){e.myScroll.hasOwnProperty(c)&&e.myScroll.hasOwnProperty(d)?C():r(t,1e3)},I=function t(){e.myScroll.hasOwnProperty(l)&&e.myScroll.hasOwnProperty(u)?A():r(t,1e3)},T=function(){e.activeView="summary",h(),y(),S(),I(),p(),v(),i.isBackToStatistics?(e.filterData.selectedYear=i.selectedStatisticsYear?i.selectedStatisticsYear:e.filterData.selectedYear,e.setActiveView("details",e.filterData.selectedYear)):e.setActiveView("summary")};T()}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){sntRover.controller("companyCardCommissionsCtrl",["$scope","$state","$rootScope","$stateParams","RVCompanyCardSrv","ngDialog","$timeout","rvPermissionSrv","rvUtilSrv","$window","$vault","sntActivity",function(e,t,a,r,n,o,i,s,c,d,l,u){BaseCtrl.call(this,e);var m=function(){var t={};return e.filterData.fromDate&&(t.from_date=e.filterData.fromDate),e.filterData.toDate&&(t.to_date=e.filterData.toDate),t.paid_status=e.filterData.paidStatus,t.commission_status=e.filterData.commissionStatus,t.per_page=e.filterData.perPage,t.page=e.filterData.page,t.hotel_id=parseInt(e.filterData.selectedHotel),t};e.setScroller("commission-list");var f=function(){i(function(){e.refreshScroller("commission-list")},3e3)};f(),e.$on("commissionsTabActive",function(){v(!0)});var p=function(t){e.filterData.page=t||1,v(!0)},v=function(t){var a=function(){e.filterData.commissionsLoaded||"COMMISION_SUMMARY"!==r.origin||u.stop("NAVIGATING_TO_TA_COMMISSIONS")},o=function(t){_.each(t.commission_details,function(e,t){_.extend(e,{is_checked:!1})}),e.currencySymbol=t.currency.symbol,e.commissionDetails=t.commission_details,e.commissionSummary.totalCommissionableRevenue=t.total_commissionable_revenue,e.commissionSummary.totalReservationsRevenue=t.total_reservations_revenue,e.commissionSummary.totalCommission=t.total_commission-t.total_commission_unpaid,e.commissionSummary.totalUnpaidCommission=t.total_commission_unpaid,e.commissionSummary.taxOnCommissions=t.tax_on_commissions,e.pagination.totalResultCount=t.total_count,i(function(){e.$broadcast("updatePagination",e.paginationData.id)},1e3),e.$emit("hideLoader"),f(),a(),e.filterData.commissionsLoaded=!0,g()},s=function(t){e.$emit("hideLoader"),e.commissionDetails=[],e.commissionSummary={},a()},c={};c.params=m(),c.accountId=e.accountId,"add"!==e.accountId&&e.invokeApi(n.fetchTACommissionDetails,c,o,s)};e.hasPermissionToEditPaid=function(){return s.getPermissionValue("EDIT_COMMISSIONS_TAB")},e.goToStayCard=function(r,n){a.hotelDetails.userHotelsData.current_hotel_id===parseInt(e.filterData.selectedHotel)&&t.go("rover.reservation.staycard.reservationcard.reservationdetails",{id:r,confirmationId:n,isrefresh:!0,isFromTACommission:!0},{reload:!0})},e.clearToDateField=function(){e.filterData.toDate="",e.onFilterChange()},e.clearFromDateField=function(){e.filterData.fromDate="",e.onFilterChange()},e.shouldShowPagination=function(){return e.commissionDetails.length>0&&e.pagination.totalResultCount>e.filterData.perPage},e.$on("fromDateChanged",function(){e.onFilterChange()}),e.$on("toDateChanged",function(){e.onFilterChange()}),e.onFilterChange=function(){e.selectedCommissions=[],e.prePaidCommissions=[],v(!0)},e.clickedFromDate=function(){e.popupCalendar("FROM")},e.clickedToDate=function(){e.popupCalendar("TO")},e.popupCalendar=function(t){e.clickedOn=t,o.open({template:"/assets/partials/companyCard/contracts/rvCompanyCardContractsCalendar.html",controller:"RVCommissionsDatePickerController",className:"",scope:e})};var D=function(t){var a=0,r=0,n=0;t.forEach(function(e){isEmptyObject(e.commission_data)||("Unpaid"===e.commission_data.paid_status||"On Hold"===e.commission_data.paid_status?a+=e.commission_data.amount:n+=e.commission_data.amount),r+=e.commissionable_revenue}),e.commissionSummary.totalUnpaidCommission=a,e.commissionSummary.totalRevenue=r,e.commissionSummary.totalCommission=n};e.onCheckBoxSelection=function(t){if(e.filterData.commssionRecalculationValue="",t.is_checked?"Prepaid"==t.commission_data.paid_status?e.prePaidCommissions.push(t):e.selectedCommissions.push(t):(e.selectedCommissions=_.filter(e.selectedCommissions,function(e){return e.reservation_id!=t.reservation_id}),e.prePaidCommissions=_.filter(e.prePaidCommissions,function(e){return e.reservation_id!=t.reservation_id}),e.filterData.selectAll=!1),0==e.selectedCommissions.length&&0==e.prePaidCommissions.length)v(!1),e.status.groupPaidStatus="";else{e.status.groupPaidStatus="";var a=e.selectedCommissions.concat(e.prePaidCommissions);D(a)}var r=_.every(e.commissionDetails,function(e){return e.is_checked});0===e.selectedCommissions.length&&0===e.prePaidCommissions.length?(e.filterData.selectAll=!1,e.toggleSelection()):r&&(e.filterData.selectAll=!0,e.toggleSelection())};var h=function(t){for(var a in e.commissionDetails)e.commissionDetails[a].is_checked=t};e.toggleSelection=function(){e.filterData.commssionRecalculationValue="",e.filterData.selectAll?(h(!0),e.selectedCommissions=Object.assign([],e.commissionDetails),e.prePaidCommissions=[],D(e.commissionDetails),e.status.groupPaidStatus=""):(h(!1),e.selectedCommissions=[],e.prePaidCommissions=[],v(!1),e.status.groupPaidStatus=""),e.isCommissionFilterTabOpened=!0};var y=function(t){var a=function(e){g(),v(!1)},r=function(e){g(),v(!1)};e.invokeApi(n.saveTACommissionDetails,t,a,r)},g=function(){e.selectedCommissions=[],e.prePaidCommissions=[],e.filterData.selectAll=!1};e.isTogglePaidStatusEnabled=function(){var t=!0;return e.contactInformation.is_global_enabled&&(t=!1,s.getPermissionValue("GLOBAL_CARD_UPDATE")&&(t=!0)),t},e.togglePaidStatus=function(t){var a={};a.reservation_id=t.reservation_id,a.status="Paid"==t.commission_data.paid_status?"Unpaid":"Paid";var r={};r.accountId=e.accountId,r.commissionDetails=[a],y(r)},e.toggleHoldStatus=function(t,a){if("Paid"==a.commission_data.paid_status||"Prepaid"==a.commission_data.paid_status)return e.errorMessage=["Only transactions on 'UNPAID' status can be set to On Hold"],void t.stopPropagation();var r={};r.reservation_id=a.reservation_id,r.status="On Hold"==a.commission_data.paid_status?"Unpaid":"On Hold";var n={};n.accountId=e.accountId,n.commissionDetails=[r],y(n)},e.onGroupPaidStatusChange=function(t){var a=[],r=!1;e.filterData.selectAll?e.commissionDetails.forEach(function(n){t&&"Unpaid"!=n.commission_data.paid_status&&"On Hold"!=n.commission_data.paid_status&&(r=!0),"Prepaid"!=n.commission_data.paid_status&&a.push({reservation_id:n.reservation_id,status:e.status.groupPaidStatus})}):e.selectedCommissions.forEach(function(n){t&&"Unpaid"!=n.commission_data.paid_status&&"On Hold"!=n.commission_data.paid_status&&(r=!0),"Prepaid"!=n.commission_data.paid_status&&a.push({reservation_id:n.reservation_id,status:e.status.groupPaidStatus})});var n={};n.accountId=e.accountId,n.commissionDetails=a,r?i(function(){e.errorMessage=["The hold status can be updated only for unpaid or on hold commissions"]},500):y(n)},e.showToggleButton=function(e){var t="Paid"==e.commission_data.paid_status||"Unpaid"==e.commission_data.paid_status;return t?{visibility:"visible"}:{visibility:"hidden"}};var C=function(){$("head").append("<style id='print-orientation'>@page { size: landscape; }</style>")},A=function(){$("#print-orientation").remove()};e.$on("CLEAR_ERROR_MESSAGE",function(){e.errorMessage=""}),e.clickedPrintButton=function(){C(),$("header .logo").addClass("logo-hide"),$("header .h2").addClass("text-hide");var e=function(){i(function(){$("header .logo").removeClass("logo-hide"),$("header .h2").addClass("text-hide"),A()},100)};i(function(){sntapp.cordovaLoaded?cordova.exec(e,function(t){e()},"RVCardPlugin","printWebView",["","0","","L"]):(d.print(),e())},100)},e.toggleCommission=function(){e.filterData.toggleCommission=!e.filterData.toggleCommission};var S=function(){var t=[];return e.filterData.selectAll?e.commissionDetails.forEach(function(e){"Prepaid"!=e.commission_data.paid_status&&t.push(e.reservation_id)}):e.selectedCommissions.forEach(function(e){"Prepaid"!=e.commission_data.paid_status&&t.push(e.reservation_id)}),t},I=function(){var t="percent";return e.filterData.toggleCommission&&(t="amount"),t};e.recalculationValueChanged=function(){isNaN(e.filterData.commssionRecalculationValue)&&(e.filterData.commssionRecalculationValue="")},e.clickedRecalculate=function(){var t=function(e){g(),i(function(){v(!1)},2e3)},a=function(t){e.errorMessage=t,e.$emit("hideLoader")},r={type:I(),value:e.filterData.commssionRecalculationValue,reservation_ids:S()};e.invokeApi(n.recalculateCommission,r,t,a)};var T=function(){var t=function(t){e.multiProperies=t.multi_properties,e.$emit("hideLoader")},a={};a.accountId="add"===e.accountId?e.contactInformation.id:e.accountId,e.invokeApi(n.fetchMultiProperties,a,t)};e.toggleFilter=function(){e.isCommissionFilterTabOpened=!e.isCommissionFilterTabOpened},e.$on("LOAD_SUBSCRIBED_MPS",function(){e.contactInformation.is_global_enabled&&a.isAnMPHotel&&s.getPermissionValue("GLOBAL_CARD_UPDATE")&&a.hotelDetails.userHotelsData.hotel_list.length>0&&s.getPermissionValue("MULTI_PROPERTY_SWITCH")?(e.shouldShowPropertyDropDown=!0,T()):(e.shouldShowPropertyDropDown=!1,E())}),e.onPropertyFilterChange=function(){a.hotelDetails.userHotelsData.current_hotel_id!==parseInt(e.filterData.selectedHotel)&&(e.filterData.commissionStatus="Commissionable"),e.onFilterChange()};var E=function(){e.commissionDetails=[],e.commissionSummary={},e.isCommissionFilterTabOpened=!0,e.shouldShowPropertyDropDown=!1,e.filterData={fromDate:r.fromDate,toDate:r.toDate,paidStatus:"Unpaid",commissionStatus:"Commissionable",perPage:25,page:1,start:1,selectAll:!1,toggleCommission:!1,commssionRecalculationValue:"",selectedHotel:parseInt(a.hotelDetails.userHotelsData.current_hotel_id),commissionsLoaded:!1},e.accountId="rover.reservation.staycard.reservationcard.reservationdetails"===t.current.name?e.travelAgentInformation.id:r.id,e.isEmpty=c.isEmpty,e.isEmptyObject=isEmptyObject,e.pagination={start:1,end:n.DEFAULT_PER_PAGE,totalResultCount:0},e.selectedCommissions=[],e.prePaidCommissions=[],e.status={groupPaidStatus:""},e.businessDate=a.businessDate,"cc-commissions"===e.currentSelectedTab&&v(!0),"rover.companycarddetails"===t.current.name&&(l.set("travelAgentId",r.id),l.set("travelAgentType",r.type),l.set("travelAgentQuery",r.query)),e.paginationData={id:"RESERVATION_LIST_"+e.accountId,api:p,perPage:e.filterData.perPage}};E()}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){angular.module("sntRover").controller("companyCardDetailsController",["$scope","RVCompanyCardSrv","rvCompanyCardContractsSrv","$state","$stateParams","ngDialog","$filter","$timeout","$rootScope","rvPermissionSrv","$interval","$log",function(e,t,a,r,n,o,i,s,c,d,l,u){e.isAddNewCard="add"===n.id,e.disableGlobalToggle=!e.isAddNewCard;var m=[];e.hasPermissionToViewCommissionTab=function(){return d.getPermissionValue("VIEW_COMMISSIONS_TAB")},e.hasPermissionToCreateArAccount=function(){return d.getPermissionValue("CREATE_AR_ACCOUNT")},e.isCommissionTabAvailable=e.hasPermissionToViewCommissionTab(),e.isDiscard=!1,e.isPromptOpened=!1,e.isLogoPrint=!0,e.isPrintArStatement=!1,e.contactInformation={},e.isGlobalToggleReadOnly=!d.getPermissionValue("GLOBAL_CARD_UPDATE");var f=!1;"COMPANY"===n.type?(e.isAddNewCard?e.heading=i("translate")("NEW_COMPANY_CARD"):e.heading=i("translate")("COMPANY_CARD"),e.cardTypeText=i("translate")("COMPANY"),e.dataIdHeader="company-card-header"):"TRAVELAGENT"===n.type&&(e.isAddNewCard?e.heading=i("translate")("NEW_TA_CARD"):e.heading=i("translate")("TA_CARD"),e.cardTypeText=i("translate")("TRAVELAGENT"),e.dataIdHeader="travel-agent-card-header"),e.setTitle(e.heading),e.$on("ARTransactionSearchFilter",function(t,a){e.isWithFilters=a});var p=function(){"rvAllotmentConfigurationCtrl"===c.previousState.controller?e.searchBackButtonCaption=i("translate")("ALLOTMENTS"):"rvGroupConfigurationCtrl"===c.previousState.controller?e.searchBackButtonCaption=i("translate")("GROUPS"):"rvAccountsConfigurationCtrl"===c.previousState.controller?e.searchBackButtonCaption=i("translate")("ACCOUNTS"):"AR_OVERVIEW"===n.origin?e.searchBackButtonCaption=i("translate")("MENU_ACCOUNTS_RECEIVABLES"):"COMMISION_SUMMARY"===n.origin?e.searchBackButtonCaption=i("translate")("MENU_COMMISIONS"):n.isMergeViewSelected?e.searchBackButtonCaption=i("translate")("MERGE_CARDS"):e.searchBackButtonCaption=i("translate")("FIND_CARDS")};c.$broadcast("viewFromCardsOutside"),p(),e.headerBackButtonClicked=function(){return"cc-contact-info"===e.currentSelectedTab?void T(e.contactInformation,!1,!0):("cc-contracts"===e.currentSelectedTab?e.$broadcast("saveContract"):"cc-ar-accounts"===e.currentSelectedTab&&e.$broadcast("saveArAccount"),void("COMMISION_SUMMARY"===n.origin?r.go("rover.financials.commisions"):r.go(c.previousState,c.previousStateParams)))},e.isContactInformationSaved=!1,BaseCtrl.call(this,e),e.currentSelectedTab="cc-contact-info","undefined"!=typeof n.type&&""!==n.type&&(e.account_type=n.type),e.companyCardClicked=function(t){t.stopPropagation(),getParentWithSelector(t,document.getElementById("cc-contact-info"))&&"cc-contact-info"===e.currentSelectedTab||getParentWithSelector(t,document.getElementById("cc-contracts"))&&"cc-contracts"===e.currentSelectedTab||(getParentWithSelector(t,document.getElementById("company-card-nested-first"))&&e.$emit("saveContactInformation"),getParentWithSelector(t,document.getElementById("cc-ar-accounts"))||e.$broadcast("saveArAccount"),e.$broadcast("CLEAR_ERROR_MESSAGE"))},e.$on("ERRORONARTAB",function(t){e.isArTabAvailable=!0,e.switchTabTo("","cc-ar-accounts")}),e.showArAccountButtonClick=function(t){e.switchTabTo(t,"cc-ar-accounts")},e.switchTabTo=function(t,a){void 0!==t&&""!==t&&(t.stopPropagation(),t.stopImmediatePropagation());var r=!!e.contactInformation&&!!e.contactInformation.account_details&&!!e.contactInformation.account_details.accounts_receivable_number;if("cc-contact-info"===e.currentSelectedTab&&"cc-contact-info"!==a){if(e.isAddNewCard&&!e.isContactInformationSaved)return e.errorMessage=["Please save "+e.cardTypeText+" card first"],void("COMPANY"===n.type?e.$broadcast("setCardContactErrorMessage",[i("translate")("COMPANY_SAVE_PROMPT")]):e.$broadcast("setCardContactErrorMessage",[i("translate")("TA_SAVE_PROMPT")]));"cc-ar-accounts"===a?e.showARTab():(T(e.contactInformation),e.$broadcast("ContactTabActivated"))}"cc-contracts"===e.currentSelectedTab&&"cc-contracts"!==a?e.$broadcast("saveContract"):"cc-ar-accounts"===e.currentSelectedTab&&"cc-ar-accounts"!==a&&e.$broadcast("saveArAccount"),"cc-ar-accounts"===a&&(e.$broadcast("arAccountTabActive"),e.$broadcast("refreshAccountsScroll")),"cc-contracts"===a&&e.$broadcast("refreshContractsScroll"),"cc-ar-transactions"===a&&r&&(c.$broadcast("arTransactionTabActive"),e.isWithFilters=!1),"cc-notes"===a&&e.$broadcast("fetchNotes"),"cc-contact-info"===a&&e.$broadcast("contactTabActive"),"cc-commissions"===a&&e.$broadcast("commissionsTabActive"),"cc-activity-log"===a&&e.$broadcast("activityLogTabActive"),"statistics"===a&&e.$broadcast("LOAD_STATISTICS"),"wallet"===a&&e.$broadcast("wallet"),"cc-ar-transactions"!==a||r?e.currentSelectedTab=a:console.warn("Save AR Account and Navigate to AR Transactions")},e.openCompanyTravelAgentCardMandatoryFieldsPopup=function(){e.shouldSaveArDataFromPopup=!1,o.open({template:"/assets/partials/companyCard/rvCompanyTravelAgentCardMandatoryFieldsPopup.html",className:"ngdialog-theme-default1 calendar-single1",controller:"companyTravelAgentMandatoryFieldsController",closeByDocument:!1,scope:e})},e.clickedCreateArAccountButton=function(){e.shouldShowARMandatoryPopup()?(f=!0,e.showARTab()):(e.isMandatoryPopupOpen=!0,e.openCompanyTravelAgentCardMandatoryFieldsPopup())},e.$on("UPDATE_MANDATORY_POPUP_OPEN_FLAG",function(){e.isMandatoryPopupOpen=!1}),e.showARTab=function(){T(e.contactInformation)},e.$on("saveArAccountFromMandatoryPopup",function(t,a){e.arAccountDetails=a,e.isArTabAvailable=!0,e.shouldSaveArDataFromPopup=!0,e.contactInformation.account_details.accounts_receivable_number=a.ar_number}),e.$on("UPDATE_AR_ACCOUNT_DETAILS_AFTER_DELETE",function(t,a){e.arAccountDetails=a}),n.isBackFromStaycard||(n.isMergeViewSelected?c.prevStateBookmarkDataFromAR={title:e.searchBackButtonCaption,name:c.previousState.name}:c.prevStateBookmarkDataFromAR={title:e.searchBackButtonCaption,name:c.previousState.name}),n.isBackFromStaycard&&(e.isArTabAvailable=!n.isBackToTACommission&&!n.isBackToStatistics,c.prevStateBookmarkDataFromAR.title!==i("translate")("FIND_CARDS")&&c.prevStateBookmarkDataFromAR.title!==i("translate")("MENU_ACCOUNTS_RECEIVABLES")||(c.setPrevState={title:c.prevStateBookmarkDataFromAR.title,name:c.prevStateBookmarkDataFromAR.name}),"undefined"==typeof e.contactInformation&&(e.contactInformation=angular.copy(c.prevStateBookmarkDataFromAR.contactInformation)),n.isBackToStatistics?(e.currentSelectedTab="statistics",e.$broadcast("LOAD_STATISTICS")):e.isArTabAvailable&&(s(function(){e.currentSelectedTab="cc-ar-transactions",e.$broadcast("setgenerateNewAutoAr",!0),e.switchTabTo("","cc-ar-transactions")},500),s(function(){e.$broadcast("BACK_FROM_STAY_CARD")},1e3))),n.isBackToTACommission&&(e.currentSelectedTab="cc-commissions"),e.$on("ARNumberChanged",function(t,a){e.contactInformation.account_details.accounts_receivable_number=a.newArNumber,e.isMandatoryPopupOpen&&(e.arAccountDetails.payment_due_days=null,e.arAccountDetails.ar_number=a.newArNumber,e.openCompanyTravelAgentCardMandatoryFieldsPopup())}),e.deleteArAccount=function(){e.errorMessage="",o.open({template:"/assets/partials/companyCard/rvCompanyCardDeleteARaccountPopup.html",className:"ngdialog-theme-default1 calendar-single1",closeByDocument:!1,scope:e})},e.deleteARAccountConfirmed=function(){var a=function(){e.$emit("hideLoader"),e.isArTabAvailable=!1,e.$broadcast("setgenerateNewAutoAr",!1),e.$broadcast("ArAccountDeleted"),e.contactInformation.account_details.accounts_receivable_number="",o.close()},r={id:e.contactInformation.id};e.invokeApi(t.deleteArAccount,r,a)},e.clikedDiscardDeleteAr=function(){o.close()},e.toggleGlobalButton=function(){d.getPermissionValue("GLOBAL_CARD_UPDATE")&&(e.contactInformation.is_global_enabled=!e.contactInformation.is_global_enabled,e.contactInformation.account_type=e.account_type),s(function(){e.$broadcast("LOAD_SUBSCRIBED_MPS"),e.activateSelectedTab()},1e3)},e.activateSelectedTab=function(){"cc-contact-info"===e.currentSelectedTab&&(e.$broadcast("ContactTabActivated"),e.$broadcast("contactTabActive")),"cc-contracts"===e.currentSelectedTab&&e.$broadcast("refreshContractsScroll"),"cc-ar-accounts"===e.currentSelectedTab&&(e.$broadcast("arAccountTabActive"),e.$broadcast("refreshAccountsScroll")),"cc-ar-transactions"===e.currentSelectedTab&&(c.$broadcast("arTransactionTabActive"),e.isWithFilters=!1),"cc-notes"===e.currentSelectedTab&&e.$broadcast("fetchNotes"),"cc-commissions"===e.currentSelectedTab&&e.$broadcast("commissionsTabActive")},e.shouldShowCommissionsTab=function(){return"TRAVELAGENT"===e.account_type},e.isUpdateEnabled=function(t){if(void 0!==e.contactInformation.is_global_enabled){var a=!1;return e.contactInformation.is_global_enabled?d.getPermissionValue("GLOBAL_CARD_UPDATE")||(a=!0):d.getPermissionValue("EDIT_COMPANY_CARD")||(a=!0),t?a||!e.isUpdateEnabledForName():a}},e.isUpdateEnabledForTravelAgent=function(t){if(void 0!==e.contactInformation.is_global_enabled){var a=!1;return e.contactInformation.is_global_enabled?d.getPermissionValue("GLOBAL_CARD_UPDATE")||(a=!0):d.getPermissionValue("EDIT_TRAVEL_AGENT_CARD")||(a=!0),t?a||!e.isUpdateEnabledForName():a}},e.isUpdateEnabledForName=function(){var e=a.getContractedRates(),t=!0;return(e.current_contracts&&e.current_contracts.length>0||e.future_contracts&&e.future_contracts.length>0||e.history_contracts&&e.history_contracts.length>0)&&(t=!1),t};var v=function(){var a={id:e.contactInformation.id},r=function(t){e.$emit("hideLoader"),e.arAccountNotes=t,e.$broadcast("ARDetailsRecieved")},n=function(){e.invokeApi(t.fetchArAccountNotes,a,r)},o=function(t){e.$emit("hideLoader"),e.arAccountDetails=t,e.arAccountDetails.is_use_main_contact!==!1&&(e.arAccountDetails.is_use_main_contact=!0),e.arAccountDetails.is_use_main_address!==!1&&(e.arAccountDetails.is_use_main_address=!0),n()};e.invokeApi(t.fetchArAccountDetails,a,o)};e.addListener("MANDATORY_CHECK_FAILED",function(t,a){e.isArTabAvailable=!1,e.switchTabTo("","cc-contact-info"),e.mandatoryErrorMessage=a,e.openCompanyTravelAgentCardMandatoryFieldsPopup()});var D={},h=function(t){e.$emit("hideLoader"),e.contactInformation=t,e.contactInformation.emailStyleClass=c.roverObj.eInvoiceVisible?"margin":"full-width",e.$broadcast("LOAD_SUBSCRIBED_MPS"),e.$broadcast("UPDATE_CONTACT_INFO"),""!==e.contactInformation.alert_message&&(e.errorMessage=[e.contactInformation.alert_message]),"undefined"!=typeof n.id&&""!==n.id&&(e.contactInformation.id=n.id,v()),D=JSON.parse(JSON.stringify(e.contactInformation)),c.prevStateBookmarkDataFromAR.contactInformation=angular.copy(e.contactInformation),"AR_OVERVIEW"===n.origin?e.switchTabTo("","cc-ar-transactions"):"COMMISION_SUMMARY"===n.origin&&e.switchTabTo("","cc-commissions"),e.displayShowPropertiesButton=!e.contactInformation.commission_details.is_global_commission},y=function(t){e.$emit("hideLoader"),angular.isDefined(e.contactInformation.address_details)||(e.contactInformation.address_details={street1:"",street2:"",street3:"",city:"",state:"",postal_code:"",country_id:"",email_address:"",phone:"",fax:"",location:""}),angular.isDefined(e.contactInformation.primary_contact_details)||(e.contactInformation.primary_contact_details={contact_first_name:"",contact_last_name:"",contact_job_title:"",contact_phone:"",contact_email:""}),e.contactInformation.mandatoryFields=t.mandatoryFields,e.contactInformation.emailStyleClass=e.contactInformation.mandatoryFields.e_invoice_mandatory.is_visible?"margin":"full-width",e.contactInformation.commission_details=t.commission_details,e.displayShowPropertiesButton=!e.contactInformation.commission_details.is_global_commission},g=function(t){e.countries=t};e.invokeApi(t.fetchCountryList,A,g);var C=n.id;if(e.shouldShowStatisticsTab="add"!==n.id,"undefined"!=typeof C&&"add"===C)e.contactInformation={},"undefined"!=typeof n.query&&""!==n.query&&(e.contactInformation.account_details={organization_id:null,reg_tax_office:null,tax_number:null},e.contactInformation.account_details.account_name=n.query),e.arAccountNotes={},e.arAccountDetails={},D={},e.invokeApi(t.fetchCommissionDetailsAndMandatoryFields,A,y);else if("undefined"!=typeof C&&""!==C){var A={id:C};e.invokeApi(t.fetchContactInformationAndMandatoryFields,A,h)}var S=function(t,a,s){if(a&&o.close(),e.contactInformation.commission_details.is_global_commission&&angular.forEach(e.contactInformation.commission_details.other_hotels_info,function(t){t.commission_type=e.contactInformation.commission_details.commission_type,t.type=e.contactInformation.commission_details.type,t.value=e.contactInformation.commission_details.value,t.is_prepaid=e.contactInformation.commission_details.is_prepaid}),e.shouldSaveArDataFromPopup&&(e.shouldSaveArDataFromPopup=!1,e.$broadcast("UPDATE_AR_ACCOUNT_DETAILS",e.arAccountDetails),e.$broadcast("saveArAccount")),f)return f=!1,e.$broadcast("setgenerateNewAutoAr",!0),e.$broadcast("saveArAccount"),void(e.isArTabAvailable=!0);if("undefined"!=typeof t.id&&""!==t.id){var d=!!e.contactInformation.id;e.contactInformation.id=t.id,d||v()}else"undefined"!=typeof n.id&&""!==n.id&&(e.contactInformation.id=n.id);D=JSON.parse(JSON.stringify(e.contactInformation)),e.isAddNewCard&&(e.disableGlobalToggle=!1,"COMPANY"===n.type?e.heading=i("translate")("COMPANY_CARD"):"TRAVELAGENT"===n.type&&(e.heading=i("translate")("TA_CARD"))),e.isAddNewCard=!1,e.disableGlobalToggle=!0,e.errorMessage="",e.$broadcast("clearCardContactErrorMessage"),e.$broadcast("IDGENERATED",{id:t.id}),s&&r.go(c.previousState,c.previousStateParams)},I=function(t){return e.$broadcast("setCardContactErrorMessage",t),e.errorMessage=t,e.currentSelectedTab="cc-contact-info",!1},T=function(a,i,s){var d=!1;if(m=[],angular.equals(a,D)||(d=!0,angular.forEach(a.commission_details.other_hotels_info,function(e){angular.forEach(D.commission_details.other_hotels_info,function(t){e.id!==t.id||_.isMatch(e,t)||m.push(e)})})),d){var l=JSON.parse(JSON.stringify(a));l.commission_details.other_hotels_info=angular.copy(m),"undefined"!=typeof l.countries&&delete l.countries,""===l.account_details.account_number&&(l.account_details.account_number=null),"undefined"==typeof l.primary_contact_details?(l.primary_contact_details={},l.primary_contact_details.contact_email=null):""===l.primary_contact_details.contact_email&&(l.primary_contact_details.contact_email=null),"undefined"==typeof l.address_details&&(l.address_details={}),l.account_type=n.type;var u={params:l,successCallBack:function(e){S(e,i,s)},failureCallBack:I};e.callAPI(t.saveContactInformation,u)}else e.shouldSaveArDataFromPopup&&(e.shouldSaveArDataFromPopup=!1,e.$broadcast("UPDATE_AR_ACCOUNT_DETAILS",e.arAccountDetails),e.$broadcast("saveArAccount")),f&&(e.$broadcast("setgenerateNewAutoAr",!0),e.$broadcast("saveArAccount"),e.isArTabAvailable=!0),f=!1,i&&o.close(),s&&r.go(c.previousState,c.previousStateParams)};e.$on("saveContactInformation",function(t,a){t.preventDefault(),t.stopPropagation(),e.isAddNewCard||e.isDiscard||(a&&a.other_hotels_info?(e.contactInformation.commission_details.other_hotels_info=a.other_hotels_info,T(e.contactInformation,a.hotel_info_changed_from_popup)):T(e.contactInformation))}),e.$on("OUTSIDECLICKED",function(t){t.preventDefault(),e.isMandatoryPopupOpen||(e.isAddNewCard&&!e.isContactInformationSaved?e.isPromptOpened||e.saveNewCardPrompt():e.isDiscard||n.isBackFromStaycard||e.isContactInformationSaved||("cc-contact-info"===e.currentSelectedTab?T(e.contactInformation):"cc-contracts"===e.currentSelectedTab?e.$broadcast("saveContract"):"cc-ar-accounts"===e.currentSelectedTab&&e.$broadcast("saveArAccount")))}),e.clikedSaveNewCard=function(){T(e.contactInformation),e.isContactInformationSaved=!0},e.clikedSaveNewCardViaPopup=function(){T(e.contactInformation),e.isContactInformationSaved=!0,o.close()},e.clikedDiscardCard=function(){e.isDiscard=!0,r.go("rover.companycardsearch",{textInQueryBox:n.query}),e.isAddNewCard=!1,e.disableGlobalToggle=!0,o.close()},e.saveNewCardPrompt=function(){e.isPromptOpened=!0,o.open({template:"/assets/partials/companyCard/rvSaveNewCardPrompt.html",controller:"saveNewCardPromptCtrl",className:"ngdialog-theme-default1 calendar-single1",closeByDocument:!1,scope:e})},e.clickedLogo=function(){"TRAVELAGENT"===n.type?e.isUpdateEnabledForTravelAgent()||s(function(){angular.element("#uplaodCompanyLogo").trigger("click")},0,!1):"COMPANY"===n.type&&(e.isUpdateEnabled()||s(function(){angular.element("#uplaodCompanyLogo").trigger("click")},0,!1))},e.shouldShowARMandatoryPopup=function(){var t=(!e.contactInformation.mandatoryFields.address_line1_mandatory.is_mandatory_on_ar_account_creation&&!e.contactInformation.mandatoryFields.address_line1_mandatory.is_mandatory||!isEmpty(e.contactInformation.address_details.street1))&&(!e.contactInformation.mandatoryFields.city_mandatory.is_mandatory_on_ar_account_creation&&!e.contactInformation.mandatoryFields.city_mandatory.is_mandatory||!isEmpty(e.contactInformation.address_details.city))&&(!e.contactInformation.mandatoryFields.postal_code_mandatory.is_mandatory_on_ar_account_creation&&!e.contactInformation.mandatoryFields.postal_code_mandatory.is_mandatory||!isEmpty(e.contactInformation.address_details.postal_code))&&(!e.contactInformation.mandatoryFields.country_mandatory.is_mandatory_on_ar_account_creation&&!e.contactInformation.mandatoryFields.country_mandatory.is_mandatory||""!==e.contactInformation.address_details.country_id&&null!==e.contactInformation.address_details.country_id)&&(!e.contactInformation.mandatoryFields.contact_phone_mandatory.is_mandatory_on_ar_account_creation&&!e.contactInformation.mandatoryFields.contact_phone_mandatory.is_mandatory||!isEmpty(e.contactInformation.address_details.phone))&&(!e.contactInformation.mandatoryFields.contact_email_address_mandatory.is_mandatory_on_ar_account_creation&&!e.contactInformation.mandatoryFields.contact_email_address_mandatory.is_mandatory||!isEmpty(e.contactInformation.address_details.email_address)&&isValidEmail(e.contactInformation.address_details.email_address))&&(!e.contactInformation.mandatoryFields.e_invoice_mandatory.is_mandatory_on_ar_account_creation&&!e.contactInformation.mandatoryFields.e_invoice_mandatory.is_mandatory||!isEmpty(e.contactInformation.e_invoice_address))&&(!e.contactInformation.mandatoryFields.organization_id_mandatory.is_mandatory_on_ar_account_creation&&!e.contactInformation.mandatoryFields.organization_id_mandatory.is_mandatory||!isEmpty(e.contactInformation.account_details.organization_id))&&(!e.contactInformation.mandatoryFields.tax_id_mandatory.is_mandatory_on_ar_account_creation&&!e.contactInformation.mandatoryFields.tax_id_mandatory.is_mandatory||!isEmpty(e.contactInformation.account_details.tax_number))&&(!e.contactInformation.mandatoryFields.regd_tax_office_mandatory.is_mandatory_on_ar_account_creation&&!e.contactInformation.mandatoryFields.regd_tax_office_mandatory.is_mandatory||!isEmpty(e.contactInformation.account_details.reg_tax_office))&&(!e.contactInformation.mandatoryFields.contact_name_mandatory.is_mandatory_on_ar_account_creation&&!e.contactInformation.mandatoryFields.contact_name_mandatory.is_mandatory||!isEmpty(e.contactInformation.primary_contact_details.contact_first_name)&&!isEmpty(e.contactInformation.primary_contact_details.contact_last_name))&&(!!e.arAccountDetails.is_auto_assign_ar_numbers||""!==e.arAccountDetails.ar_number&&null!==e.arAccountDetails.ar_number)&&(!e.contactInformation.mandatoryFields.payment_due_days_mandatory.is_mandatory_on_ar_account_creation&&!e.contactInformation.mandatoryFields.payment_due_days_mandatory.is_mandatory||""!==e.arAccountDetails.payment_due_days&&null!==e.arAccountDetails.payment_due_days);
return t},e.isEmptyObject=isEmptyObject,e.$on("PRINT_AR_STATEMENT",function(t,a){e.isPrintArStatement=a}),c.disableObserveForSwipe||(CardReaderCtrl.call(this,e,c,s,l,u),e.observeForSwipe())}])},{}]},{},[1]);var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};!function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){angular.module("sntRover").controller("companyCardNotesController",["$scope","rvCompanyCardNotesSrv","$timeout","$filter","$rootScope",function(e,t,a,r,n){BaseCtrl.call(this,e);var o=null,i=function(){var t=e.getScroller("companycard_notes_scroller");a(function(){t.scrollTo(0,0,300)},0)},s=function(t){e.notes=t,e.refreshScroller("companycard_notes_scroller"),e.contactInformation.account_notes_count=e.notes.length},c=function(){o=e.contactInformation.id;var a={accountID:o},r={params:a,successCallBack:s};e.callAPI(t.fetchNotes,r)},d=function(t,a){var r=a.index;e.notes.splice(r,1),e.refreshScroller("companycard_notes_scroller"),e.contactInformation.account_notes_count=e.notes.length},l=function(t){e.errorMessage=t,c()};e.deleteNote=function(a,r,n){a.stopPropagation(),e.cancelEditMode(),e.errorMessage="";var i={noteID:r,accountID:o},s={params:i,successCallBack:d,failureCallBack:l,successCallBackParameters:{index:n}};e.callAPI(t.deleteNote,s)};var u=function(t){var a={user_name:t.user_name,avatar:t.avatar,note:t.note,time:t.time,date:t.date,id:t.id,hotel_name:t.hotel_name,is_editable:t.is_editable};e.notes.unshift(0),e.notes[0]=a,e.noteText="",e.refreshScroller("companycard_notes_scroller"),i(),e.contactInformation.account_notes_count=e.notes.length};e.createNote=function(){o=e.contactInformation.id;var a={accountID:o,text:e.noteText};e.errorMessage="";var r={params:a,successCallBack:u};e.callAPI(t.createNote,r)};var m=function(t){var r=_.findIndex(e.notes,{id:e.editingNote.id})+1;e.cancelEditMode(),c();var n=e.getScroller("companycard_notes_scroller");a(function(){n.scrollToElement(".notes.wrapper li:nth-child("+r+")",300)},0)};e.updateActiveNote=function(){if(null===e.editingNote)return void(e.errorMessage=["Something went wrong, please switch tab and comeback"]);e.errorMessage="";var a={noteID:e.editingNote.id,accountID:o,text:e.noteText},r={params:a,successCallBack:m};e.callAPI(t.updateNote,r)},e.clickedOnNote=function(t){t.is_editable&&(e.editingNote=t,e.noteText=t.note)},e.cancelEditMode=function(){e.editingNote=null,e.noteText=""},e.formatDateForUI=function(e){var t="undefined"==typeof e?"undefined":_typeof(e),a="";switch(t){case"string":a=r("date")(new tzIndependentDate(e),n.dateFormat);break;case"object":a=r("date")(e,n.dateFormat)}return a};(function(){e.editingNote=null,e.notes=[],e.noteText="",e.setScroller("companycard_notes_scroller",{})})();e.$on("fetchNotes",function(){o=e.contactInformation&&e.contactInformation.id||!1,o&&c()})}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){sntRover.controller("companyCardArAccountCtrl",["$scope","RVCompanyCardSrv","$timeout","rvPermissionSrv",function(e,t,a,r){BaseCtrl.call(this,e),e.setScroller("cardAccountsScroller");var n=function(){a(function(){e.myScroll&&e.myScroll.cardAccountsScroller&&e.myScroll.cardAccountsScroller.refresh(),e.refreshScroller("cardAccountsScroller")},500)};e.$on("refreshAccountsScroll",n);var o=function(){e.ARData={},e.ARData.note="",e.shouldValidate=!0};o();var i={};e.$on("setgenerateNewAutoAr",function(t,a){e.$parent.generateNewAutoAr=a,!e.arAccountDetails.is_auto_assign_ar_numbers&&a&&s(!0)});var s=function(a){var r=function(t){e.$emit("hideLoader"),e.errorMessage="",e.arAccountDetails.is_auto_assign_ar_numbers&&!e.arAccountDetails.ar_number&&(e.arAccountDetails.ar_number=t.ar_number,e.$parent.generateNewAutoAr=!1),e.$emit("ARNumberChanged",{newArNumber:e.arAccountDetails.ar_number})},n=function(t){e.$emit("hideLoader"),e.errorMessage=""},o=function(t){e.$emit("hideLoader"),e.errorMessage=t,"Please complete required AR Account Information"!==t[0]&&"Please provide payment due days since it is mandatory"!==t[0]||e.$emit("MANDATORY_CHECK_FAILED",e.errorMessage)},s=e.arAccountDetails;_.isEmpty(i)&&(i=angular.fromJson(angular.toJson(e.arAccountDetails))),e.contactInformation.id&&(s.id=e.contactInformation.id,i.id=e.contactInformation.id);var c=JSON.parse(JSON.stringify(e.arAccountDetails)),d=!1,l=["workstation_id"];angular.equals(_.omit(c,l),_.omit(i,l))||(d=!0,i=c),e.$parent.generateNewAutoAr&&e.arAccountDetails.is_auto_assign_ar_numbers||d?e.invokeApi(t.saveARDetails,s,r,o):(!e.arAccountDetails.is_auto_assign_ar_numbers&&d||a)&&e.invokeApi(t.saveARDetails,s,n,o)};e.$on("arAccountTabActive",function(){setTimeout(function(){n()},500),e.arAccountDetails&&e.arAccountDetails.is_auto_assign_ar_numbers&&!e.arAccountDetails.ar_number&&s()}),e.$on("ARDetailsRecieved",function(){i=JSON.parse(JSON.stringify(e.arAccountDetails))}),e.checkboxModelChanged=function(){n()},e.saveNote=function(){var a=function(t){e.$emit("hideLoader"),e.arAccountNotes.ar_notes.push(t),e.ARData.note="",n()},r={id:e.contactInformation.id,note:e.ARData.note,ar_number:e.arAccountDetails.ar_number};e.invokeApi(t.saveARNote,r,a)},e.deletePost=function(a,r){var o=function(){e.$emit("hideLoader"),e.arAccountNotes.ar_notes.splice(r,1),n()},i={id:e.contactInformation.id,note_id:a};e.invokeApi(t.deleteARNote,i,o)},e.$on("UPDATE_AR_ACCOUNT_DETAILS",function(t,a){e.arAccountDetails=a,e.arAccountDetails.payment_due_days=null===a.payment_due_days?"":a.payment_due_days}),e.$on("saveArAccount",function(e){e.preventDefault(),s()}),e.$on("ArAccountDeleted",function(t){var a=e.arAccountDetails.is_auto_assign_ar_numbers;e.arAccountDetails={},e.arAccountDetails.is_use_main_contact=!0,e.arAccountDetails.is_use_main_address=!0,e.arAccountDetails.is_auto_assign_ar_numbers=a,e.arAccountDetails.ar_number="",e.arAccountDetails.payment_due_days="",e.arAccountNotes.ar_notes=[],e.$emit("UPDATE_AR_ACCOUNT_DETAILS_AFTER_DELETE",e.arAccountDetails)}),e.clearErrorMessage=function(){e.errorMessage=""},e.hasPermissionToEditDirectBillRestriction=function(){return r.getPermissionValue("EDIT_DIRECT_BILL_RESTRICTION")},e.hasPermissionToCreateArAccount=function(){return r.getPermissionValue("CREATE_AR_ACCOUNT")}}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){angular.module("sntRover").controller("companyCardDetailsContactCtrl",["$scope","$q","jsMappings","RVCompanyCardSrv","rvPermissionSrv","$state","$stateParams","ngDialog","$rootScope",function(e,t,a,r,n,o,i,s,c){BaseCtrl.call(this,e),e.setScroller("companyCardDetailsContactCtrl"),e.$on("contactTabActive",function(){d()}),e.isEmpty=function(e){return _.isEmpty(e)},e.toggleCommission=function(){e.contactInformation.commission_details.is_on=!e.contactInformation.commission_details.is_on},e.openBillingInformation=function(t){if(null===e.contactInformation.id||void 0===e.contactInformation.id)return e.$emit("OUTSIDECLICKED"),!1;if("TRAVELAGENT"===t)e.attachedEntities={},e.attachedEntities.travel_agent={},e.attachedEntities.travel_agent.id=e.contactInformation.id,e.attachedEntities.travel_agent.name=e.contactInformation.account_details.account_name,e.attachedEntities.travel_agent.logo=e.contactInformation.account_details.company_logo,e.billingEntity="TRAVEL_AGENT_DEFAULT_BILLING";else{if("COMPANY"!==t)return!1;e.attachedEntities={},e.attachedEntities.company_card={},e.attachedEntities.company_card.id=e.contactInformation.id,e.attachedEntities.company_card.name=e.contactInformation.account_details.account_name,e.attachedEntities.company_card.logo=e.contactInformation.account_details.company_logo,e.billingEntity="COMPANY_CARD_DEFAULT_BILLING"}e.$emit("showLoader"),a.fetchAssets(["addBillingInfo","directives"]).then(function(){e.$emit("hideLoader"),c.UPDATED_BI_ENABLED_ON.CARDS?(console.log("##Billing-info updated version"),s.open({template:"/assets/partials/billingInformation/cards/rvBillingInfoCardsMain.html",controller:"rvBillingInfoCardsMainCtrl",className:"",scope:e})):(console.log("##Billing-info old version"),s.open({template:"/assets/partials/bill/rvBillingInformationPopup.html",controller:"rvBillingInformationPopupCtrl",className:"",scope:e}))})},e.$on("setCardContactErrorMessage",function(t,a){e.errorMessage=a}),e.$on("clearCardContactErrorMessage",function(){e.errorMessage=""});var d=function(){e.refreshScroller("companyCardDetailsContactCtrl")};e.$on("BILLINGINFODELETED",function(){e.contactInformation.account_details.routes_count=0}),e.$on("BILLINGINFOADDED",function(){e.contactInformation.account_details.routes_count=1}),e.openPropertiesPopup=function(){s.open({template:"/assets/partials/companyCard/rvTACardPropertiesCommissionsPopup.html",controller:"rvTACardPropertiesCommissionsPopupCtrl",className:"",scope:e})},e.toggleGlobalCommission=function(){e.displayShowPropertiesButton=!e.contactInformation.commission_details.is_global_commission},e.displayShowPropertiesButtonFn=function(){return e.displayShowPropertiesButton&&"TRAVELAGENT"===e.account_type&&!e.isEmpty(e.contactInformation.commission_details)&&e.contactInformation.is_global_enabled&&c.isAnMPHotel&&c.hotelDetails.userHotelsData.hotel_list.length>0&&n.getPermissionValue("MULTI_PROPERTY_SWITCH")&&n.getPermissionValue("GLOBAL_CARD_UPDATE")&&!e.isUpdateEnabledForTravelAgent()},e.showGlobalCommissionCheckbox=function(){return e.contactInformation.is_global_enabled&&c.hotelDetails.userHotelsData.hotel_list.length>0&&n.getPermissionValue("MULTI_PROPERTY_SWITCH")}}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){sntRover.controller("companyTravelAgentMandatoryFieldsController",["$scope","$timeout","ngDialog",function(e,t,a){BaseCtrl.call(this,e),e.setScroller("companyTravelAgentMandatory"),e.closeDialog=function(){e.$emit("UPDATE_MANDATORY_POPUP_OPEN_FLAG"),a.close()},e.saveCoTaMandatoryData=function(){e.$emit("saveContactInformation"),e.$emit("saveArAccountFromMandatoryPopup",e.arAccountDetails),e.closeDialog()},e.shouldEnableSubmitButton=function(){return e.shouldShowARMandatoryPopup()};var r=function(){e.errorMessage=angular.isUndefined(e.mandatoryErrorMessage)?"":e.mandatoryErrorMessage,t(function(){e.refreshScroller("companyTravelAgentMandatory")},200),angular.isUndefined(e.contactInformation.e_invoice_address)&&(e.contactInformation.e_invoice_address=null),null!==e.contactInformation.address_details.street1&&""!==e.contactInformation.address_details.street1||!e.contactInformation.mandatoryFields.address_line1_mandatory.is_mandatory_on_ar_account_creation&&!e.contactInformation.mandatoryFields.address_line1_mandatory.is_mandatory||(e.shouldShowAddress=!0),null!==e.contactInformation.address_details.city&&""!==e.contactInformation.address_details.city||!e.contactInformation.mandatoryFields.city_mandatory.is_mandatory_on_ar_account_creation&&!e.contactInformation.mandatoryFields.city_mandatory.is_mandatory||(e.shouldShowCity=!0),null!==e.contactInformation.address_details.postal_code&&""!==e.contactInformation.address_details.postal_code||!e.contactInformation.mandatoryFields.postal_code_mandatory.is_mandatory_on_ar_account_creation&&!e.contactInformation.mandatoryFields.postal_code_mandatory.is_mandatory||(e.shouldShowPostalCode=!0),null!==e.contactInformation.address_details.country_id&&""!==e.contactInformation.address_details.country_id||!e.contactInformation.mandatoryFields.country_mandatory.is_mandatory_on_ar_account_creation&&!e.contactInformation.mandatoryFields.country_mandatory.is_mandatory||(e.shouldShowCountry=!0),null!==e.contactInformation.address_details.phone&&""!==e.contactInformation.address_details.phone||!e.contactInformation.mandatoryFields.contact_phone_mandatory.is_mandatory_on_ar_account_creation&&!e.contactInformation.mandatoryFields.contact_phone_mandatory.is_mandatory||(e.shouldShowPhone=!0),null!==e.contactInformation.address_details.email_address&&""!==e.contactInformation.address_details.email_address||!e.contactInformation.mandatoryFields.contact_email_address_mandatory.is_mandatory_on_ar_account_creation&&!e.contactInformation.mandatoryFields.contact_email_address_mandatory.is_mandatory||(e.shouldShowEmail=!0),null!==e.contactInformation.e_invoice_address&&""!==e.contactInformation.e_invoice_address||!e.contactInformation.mandatoryFields.e_invoice_mandatory.is_mandatory_on_ar_account_creation&&!e.contactInformation.mandatoryFields.e_invoice_mandatory.is_mandatory||(e.shouldShowEInvoice=!0),null!==e.contactInformation.account_details.organization_id&&""!==e.contactInformation.account_details.organization_id||!e.contactInformation.mandatoryFields.organization_id_mandatory.is_mandatory_on_ar_account_creation&&!e.contactInformation.mandatoryFields.organization_id_mandatory.is_mandatory||(e.shouldShowOrganization=!0),null!==e.contactInformation.account_details.tax_number&&""!==e.contactInformation.account_details.tax_number||!e.contactInformation.mandatoryFields.tax_id_mandatory.is_mandatory_on_ar_account_creation&&!e.contactInformation.mandatoryFields.tax_id_mandatory.is_mandatory||(e.shouldShowTaxNumber=!0),null!==e.contactInformation.account_details.reg_tax_office&&""!==e.contactInformation.account_details.reg_tax_office||!e.contactInformation.mandatoryFields.regd_tax_office_mandatory.is_mandatory_on_ar_account_creation&&!e.contactInformation.mandatoryFields.regd_tax_office_mandatory.is_mandatory||(e.shouldShowRegisteredTaxOffice=!0),null!==e.contactInformation.primary_contact_details.contact_first_name&&""!==e.contactInformation.primary_contact_details.contact_first_name||!e.contactInformation.mandatoryFields.contact_name_mandatory.is_mandatory_on_ar_account_creation&&!e.contactInformation.mandatoryFields.contact_name_mandatory.is_mandatory||(e.shouldShowPrimaryContactFirstName=!0),null!==e.contactInformation.primary_contact_details.contact_last_name&&""!==e.contactInformation.primary_contact_details.contact_last_name||!e.contactInformation.mandatoryFields.contact_name_mandatory.is_mandatory_on_ar_account_creation&&!e.contactInformation.mandatoryFields.contact_name_mandatory.is_mandatory||(e.shouldShowPrimaryContactLastName=!0),null!==e.arAccountDetails.payment_due_days&&""!==e.arAccountDetails.payment_due_days||!e.contactInformation.mandatoryFields.payment_due_days_mandatory.is_mandatory_on_ar_account_creation&&!e.contactInformation.mandatoryFields.payment_due_days_mandatory.is_mandatory||(e.shouldShowPayDays=!0),e.arAccountDetails.is_auto_assign_ar_numbers||(e.shouldShowArNumber=!0)};r()}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){sntRover.controller("rvTACardPropertiesCommissionsPopupCtrl",["$scope","$rootScope","$filter","$timeout","rvUtilSrv","ngDialog",function(e,t,a,r,n,o){BaseCtrl.call(this,e);var i={tap:!0,preventDefault:!1,showScrollbar:!0};e.clickedCancel=function(){o.close()},e.saveChanges=function(){e.$emit("saveContactInformation",{hotel_info_changed_from_popup:!0,other_hotels_info:e.hotelCommissionDetails})};var s=function(){e.hotelCommissionDetails=angular.copy(e.contactInformation.commission_details.other_hotels_info),e.setScroller("rvTACardPropertiesCommissionsScroll",i),r(function(){e.refreshScroller("rvTACardPropertiesCommissionsScroll")},2e3)};s()}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){angular.module("sntRover").service("RVValidateCheckinSrv",["$http","$q","RVBaseWebSrv","rvBaseWebSrvV2","$filter",function(e,t,a,r,n){var o=this;this.updateGuestDetailsDuringCheckin=function(e){var a=t.defer(),o="/api/guest_details/"+e.user_id,i={guest_admin_settings:e.guest_admin_settings,email:e.email,guest_id:e.guest_id,phone:e.phone,mobile:e.mobile,nationality_id:e.nationality_id,reservation_type_id:e.reservation_type_id,source_id:e.source_id,market_segment_id:e.market_segment_id,booking_origin_id:e.booking_origin_id,segment_id:e.segment_id,job_title:e.job_title,father_name:e.father_name,mother_name:e.mother_name,birth_place:e.birth_place,id_expiration_date:e.id_expiration_date,gender_id:e.gender_id,vehicle_registration_number:e.vehicle_registration_number,personal_id_no:e.personal_id_no,home_town:e.home_town,place_of_residence:e.place_of_residence,country_code:e.country_code,id_country_id:e.id_country_id,id_place_of_issue:e.id_place_of_issue,birthday:n("date")(tzIndependentDate(e.birth_day),"MM-dd-yyyy"),current_page:"at_checkin"};return i.address={},e.address&&(i.address.country_id=e.address.country_id),r.putJSON(o,i).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.updateDemographicsDuringCheckin=function(e){var a=t.defer(),n="/api/reservations/"+e.reservationId,o={reservationId:e.reservationId,reservation_type_id:e.reservation_type_id,source_id:e.source_id,market_segment_id:e.market_segment_id,booking_origin_id:e.booking_origin_id,segment_id:e.segment_id};return r.putJSON(n,o).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.saveGuestDataAndReservationDemographics=function(e){var a,r=t.defer();return t.when().then(function(){return o.updateGuestDetailsDuringCheckin(e)}).then(function(t){if(a=t,!e.ignoreDemographicsUpdate)return o.updateDemographicsDuringCheckin(e)}).then(function(){r.resolve({response:a,data:e})},function(e){r.reject(e)}),r.promise},this.getKeyEmailModalData=function(e){var r=t.defer(),n="staff/reservations/"+e.reservation_id+"/get_key_setup_popup.json";return a.getJSON(n).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise}}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){angular.module("sntRover").service("RVHkRoomDetailsSrv",["$http","$q","rvBaseWebSrvV2","RVBaseWebSrv","$window","$filter","$vault",function(e,t,a,r,n,o,i){var s=this,c=200,d=function(e){var t=function(e){return 2===e?"OUT_OF_SERVICE":3===e?"OUT_OF_ORDER":"IN_SERVICE"};i.setOnce("LAST_ROOM_SERVICE",JSON.stringify({rooms:[].concat(e.room_id),status:{to_date:e.to_date,end_time:e.end_time,id:e.room_service_status_id,value:t(e.room_service_status_id)}}))};s.roomDetails={},s.fetch=function(a,r){var o=t.defer(),i="/house/room/"+a+".json";return e.get(i).then(function(e){var t=e.data;"success"===t.status?(s.roomDetails=t.data.room_details,o.resolve(s.roomDetails)):o.reject(t)},function(e){var t=e.data,a=e.status;401===a?n.location.href="/house/logout":o.reject(t)}),o.promise},s.updateHKStatus=function(a){var r=t.defer(),o="/house/change_house_keeping_status.json";return e({url:o,method:"POST",data:a}).then(function(e){var t=e.data;"success"===t.status||e.status===c?r.resolve(t.data):r.reject(t)},function(e){var t=e.data,a=e.status;401===a?n.location.href="/house/logout":r.reject(t)}),r.promise};var l=[];s.fetchAllServiceStatus=function(){var e=t.defer(),r="api/room_services/status_list";return l.length?e.resolve(l):a.getJSON(r).then(function(t){l=t.results,e.resolve(l)},function(t){e.reject(t)}),e.promise};var u=[];s.fetchMaintenanceReasons=function(){var e=t.defer(),r="api/maintenance_reasons";return u.length?e.resolve(u):a.getJSON(r).then(function(t){u=t.maintenance_reasons,e.resolve(u)},function(t){e.reject(t)}),e.promise},s.getRoomLog=function(e){var r=t.defer(),n="/api/room_actions/"+e.id+"/?page="+e.page+"&per_page="+e.per_page;return a.getJSON(n).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},s.getRoomServiceStatus=function(e){var r=t.defer(),n="/api/room_services/service_info.json?",i=tzIndependentDate(e.from_date),s=i.getFullYear(),c=i.getMonth(),d=tzIndependentDate(new Date(s,c+2,1));return e.to_date=o("date")(d,"yyyy-MM-dd"),a.getJSON(n,e).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},s.postRoomServiceStatus=function(e){var r=t.defer(),n="api/room_services";return a.postJSON(n,e).then(function(t){d(e),r.resolve(t)},function(e){r.reject(e)}),r.promise},s.checkWhetherRoomStatusChangePossible=function(e){var r=t.defer(),n="/api/room_services/check_room_locked_or_assigned";return a.postJSON(n,e).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},s.postCheckOutReservation=function(e){var r=t.defer(),n="api/reservations/"+e.id+"/checkout_from_house_keeping";return a.postJSON(n,e).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},s.putRoomServiceStatus=function(e){var r=t.defer(),n="api/room_services/"+e.room_id;return a.putJSON(n,e).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},s.putRoomInService=function(e){var r=t.defer(),n="api/room_services/"+e.room_id,o={room_service_status_id:e.inServiceID,from_date:e.from_date,to_date:e.to_date};return a.putJSON(n,o).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise};var m=[];s.getWorkTypes=function(){var e=t.defer(),r="api/work_types";return m.length?e.resolve(m):a.getJSON(r).then(function(t){m=t.results,e.resolve(m)},function(t){e.reject(t)}),e.promise},s.postRecordTime=function(e){var r=t.defer(),n="/api/work_assignments/record_time";return a.postJSON(n,e).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},s.fetchRoomStatus=function(e){var r={from_date:o("date")(tzIndependentDate(new Date(e.year,e.month-1,1)),"yyyy-MM-dd"),to_date:o("date")(tzIndependentDate(new Date(e.year,e.month+1,1)),"yyyy-MM-dd"),room_id:e.room_id},n=t.defer(),i="/api/room_services/service_info.json?";return a.getJSON(i,r).then(function(e){n.resolve({service_status:e.service_status})},function(e){n.reject(e)}),n.promise},s.changeHouseKeepingStatus=function(e){var r=t.defer(),n="house/change_fo_status.json";return a.postJSON(n,e).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise}}])},{}]},{},[1]);var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};!function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){angular.module("sntRover").service("rvActionTasksSrv",["$q","BaseWebSrvV2","rvUtilSrv","$rootScope","dateFilter","$filter",function(e,t,a,r,n,o){var i=this,s=null,c=[o("translate")("SUNDAY"),o("translate")("MONDAY"),o("translate")("TUESDAY"),o("translate")("WEDNESDAY"),o("translate")("THURSDAY"),o("translate")("FRIDAY"),o("translate")("SATURDAY")];i.searchPerPage=50,i.page=1,i.to_date="",this.getTasksCount=function(a){var r=e.defer(),n="/api/reservations/"+a.id+".json";return t.getJSON(n).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.getActionsTasksList=function(a){var s=e.defer(),c="/api/action_tasks?associated_id="+a.id+"&associated_type=Reservation";return t.getJSON(c).then(function(e){e.data.forEach(function(e){var t,a,i;e.assigned=null!==e.assigned_to,_typeof(e.due_at)===_typeof("string")?(a=e.due_at_str.split("T"),e.due_at_time_str=n(a[0]+"T"+a[1].split(/[+-]/)[0],"hh:mm a"),e.due_at_time=n(a[0]+"T"+a[1].split(/[+-]/)[0],"HH:mm"),e.due_at_date=n(a[0],r.dateFormat),e.hasDate=!0):e.hasDate=!1,"COMPLETED"===e.action_status&&(e.isCompleted=!0,t=moment(e.completed_at),i=e.completed_at.split("T"),e.date_completed=t.format(r.dateFormat.toUpperCase()),e.time_completed=t.format("HH:MM:A"),e.completed_date=n(i[0],r.dateFormat)),e.created_at&&(e.created_at_time=o("date")(e.created_at,"hh:mm a"),e.created_at_date=o("date")(e.created_at,r.dateFormat))}),e.action_count=e.data.length,e.pending_action_count=_.countBy(e.data,"completed_at").null,e.pending_action_count=e.pending_action_count||0,e.className=i.getActionsClassName(e.action_count,e.pending_action_count),s.resolve(e)},function(e){s.reject(e)}),s.promise},this.fetchReportDetails=function(a){var r=e.defer(),n="/api/reports/action_manager_report";return t.postJSON(n,a).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.getActionsClassName=function(e,t){var a="";return 0===e?"none":a=0===t?"all-completed":e===t?"only-pending":"pending"},this.syncActionCount=function(a){var r=e.defer(),n="/api/action_tasks/sync_with_external_pms?reservation_id="+a;return t.getJSON(n).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.postNewAction=function(a){var r=e.defer(),n="/api/action_tasks.json";return t.postJSON(n,a).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.updateNewAction=function(a){var r=e.defer(),n="/api/action_tasks/"+a.action_task.id+".json";return t.putJSON(n,a).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.completeAction=function(a){var r=e.defer(),n="/api/action_tasks/"+a.action_task.id;return t.putJSON(n,a).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.fetchDepartments=function(){var a=e.defer(),r="admin/departments.json";return null===i.cache.responses.departments||Date.now()>i.cache.responses.departments.expiryDate?t.getJSON(r).then(function(e){i.cache.responses.departments={data:e,expiryDate:Date.now()+1e3*i.cache.config.lifeSpan},a.resolve(e)},function(e){a.reject(e)}):a.resolve(i.cache.responses.departments.data),a.promise},this.fetchGuestInfo=function(a){var r=e.defer();a&&(a.fakeDataToAvoidCache=new Date),i.toDate=void 0===i.toDate?"":i.toDate;var n="search.json?per_page="+i.searchPerPage+"&page="+i.page;return t.getJSON(n,a).then(function(e){e.data.results;if(a.query){var t,n,o,i=a.query.toLowerCase(),s=0;for(var c in e.data.results)e.data.results[c].is_row_visible=!1,e.data.results[c].firstname&&(t=e.data.results[c].firstname.toLowerCase(),t.indexOf(i)!==-1&&(e.data.results[c].is_row_visible=!0,s++)),e.data.results[c].lastname&&(n=e.data.results[c].lastname.toLowerCase(),n.indexOf(i)!==-1&&(e.data.results[c].is_row_visible=!0,s++)),e.data.results[c].room&&(o=e.data.results[c].room.toLowerCase(),o.indexOf(i)!==-1&&(e.data.results[c].is_row_visible=!0,s++))}e.queryTime=a.queryTime,e.visibleRowCount=s,e.querySent=a.query,r.resolve(e)},function(e){r.reject(e)}),r.promise},this.fetchActions=function(a){var r=e.defer(),n="api/action_tasks/hotel_actions";return t.getJSON(n,a).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.getActionDetails=function(a){var r=e.defer(),n="api/action_tasks/"+a;return t.getJSON(n).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.fetchCurrentTime=function(){var r=e.defer(),n="/api/hotel_current_time";return t.getJSON(n).then(function(e){r.resolve(a.roundToNextQuarter(parseInt(e.hotel_time.hh,10),parseInt(e.hotel_time.mm,10)))},function(e){r.reject(e)}),r.promise},this.fetchGroupActions=function(a){var r=e.defer(),n="api/action_tasks/hotel_group_actions";return t.getJSON(n,a).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.deleteActionTask=function(a){var r=e.defer(),n="/api/action_tasks/"+a;return t.deleteJSON(n).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.cache={config:{lifeSpan:900},responses:{departments:null}},i.setFilterState=function(e){s=angular.copy(e)},i.getFilterState=function(){return s},i.clearFilterState=function(){s=null},i.getDateFromDate=function(e){var t=new tzIndependentDate(e),a=t.getDay();return c[t.getDay()]||a},i.getTimeFieldValues=function(){return["0000","0015","0030","0045","0100","0115","0130","0145","0200","0215","0230","0245","0300","0315","0330","0345","0400","0415","0430","0445","0500","0515","0530","0545","0600","0615","0630","0645","0700","0715","0730","0745","0800","0815","0830","0845","0900","0915","0930","0945","1000","1015","1030","1045","1100","1115","1130","1145","1200","1215","1230","1245","1300","1315","1330","1345","1400","1415","1430","1445","1500","1515","1530","1545","1600","1615","1630","1645","1700","1715","1730","1745","1800","1815","1830","1845","1900","1915","1930","1945","2000","2015","2030","2045","2100","2115","2130","2145","2200","2215","2230","2245","2300","2315","2330","2345"]}}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){angular.module("sntRover").service("RVDepositBalanceSrv",["$q","BaseWebSrvV2","rvBaseWebSrvV2","$rootScope",function(e,t,a,r){this.getDepositBalanceData=function(a){var r=e.defer(),n="staff/reservations/"+a.reservationId+"/deposit_and_balance.json";return t.getJSON(n).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.getRevenueDetails=function(a){var r=e.defer(),n="api/posting_accounts/"+a.posting_account_id+"/deposit_and_balance";
return t.getJSON(n).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.submitPaymentOnBill=function(t){var n=0,o=function(){n++},i=setInterval(o,1e3),s=e.defer(),c="/api/bills/"+t.bill_id+"/submit_payment",d=function e(t){if(n>=r.emvTimeout){var o=["Request timed out. Unable to process the transaction"];s.reject(o)}else a.getJSONWithSpecialStatusHandling(t).then(function(a){a.status&&"processing_not_completed"===a.status||"null"===a?setTimeout(function(){console.info("POLLING::-> for emv terminal response"),e(t)},5e3):(clearInterval(i),s.resolve(a))},function(a){"undefined"==typeof a?e(t):(clearInterval(i),s.reject(a))})};return a.postJSONWithSpecialStatusHandling(c,t.postData).then(function(e){t.is_emv_request&&e.status&&"processing_not_completed"===e.status?d(e.location_header):(clearInterval(i),s.resolve(e))},function(e){clearInterval(i),s.reject(e)}),s.promise}}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){angular.module("sntRover").service("RVExternalReferencesSrv",["$q","rvBaseWebSrvV2",function(e,t){var a=this,r=function(){var a=e.defer(),r="/api/reference_values/manual_external_reference_interfaces";return t.getJSON(r).then(function(e){a.resolve(e.external_interface_types)},function(e){a.reject(e)}),a.promise},n=function(r){var n=e.defer(),o="/api/reservations/"+r+"/external_references";return t.getJSON(o).then(function(e){var t=e.external_references;0===t.length&&t.push(a.getEmptyRow()),n.resolve(t)},function(e){n.reject(e)}),n.promise};a.save=function(a){var r=e.defer(),n="/api/reservations/"+a.reservationId+"/external_references";return t.postJSON(n,{external_confirm_no:a.reference.external_confirm_no,external_interface_type_id:a.reference.external_interface_type_id}).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},a.update=function(a){var r=e.defer(),n="/api/reservations/"+a.reservationId+"/external_references/"+a.reference.id;return t.putJSON(n,{external_confirm_no:a.reference.external_confirm_no,external_interface_type_id:a.reference.external_interface_type_id}).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},a.remove=function(a){var r=e.defer(),n="/api/reservations/"+a.reservationId+"/external_references/"+a.referenceId;return t.deleteJSON(n).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},a.getEmptyRow=function(){return{external_interface_type_id:"",external_confirm_no:"",id:"",is_from_rover:!0}},a.getExternalData=function(t){var o=e.defer(),i=[];return a.extRef={},i.push(r().then(function(e){a.extRef.systems=e})),i.push(n(t).then(function(e){a.extRef.references=e})),e.all(i).then(function(){o.resolve(a.extRef)},function(e){o.reject(e)}),o.promise}}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){angular.module("sntRover").service("RVReservationAddonsSrv",["$q","rvBaseWebSrvV2",function(e,t){var a=this;this.addonData={},this.fetchAddonData=function(r){var n=e.defer(),o="/api/charge_groups/for_addons";return t.getJSON(o,r).then(function(e){a.addonData.addonCategories=e.results,n.resolve(a.addonData)},function(e){n.reject(e)}),n.promise},this.fetchAddons=function(a){var r=e.defer(),n="api/addons";return t.getJSON(n,a).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.checkInventory=function(a){var r=e.defer(),n="/api/addons/"+a.addon_id+"/inventory_details";return t.getJSON(n,a).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise}}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){angular.module("sntRover").service("RVReservationAllCardsSrv",["$q","rvBaseWebSrvV2",function(e,t){this.fetchGuests=function(a){var r=e.defer(),n="/api/guest_details";return t.getJSON(n,a,!0).then(function(e){var t={data:e.data,params:e.config&&e.config.params};r.resolve(t)},function(e){r.reject(e)}),r.promise},this.fetchCompaniesOrTravelAgents=function(a){var r=e.defer(),n="/api/accounts";return t.getJSON(n,a).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise}}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){angular.module("sntRover").service("RVReservationDataService",["$rootScope","dateFilter","RVReservationStateService",function(e,t,a){var r=this;r.getDatesModel=function(e,a){for(var r={},n=1*new tzIndependentDate(e),o=1*new tzIndependentDate(a);n<=o;n+=864e5){var i=new tzIndependentDate(n),s=t(i,"yyyy-MM-dd");(a===e||n<o)&&(r[s]={obj:i})}return r},r.getTabDataModel=function(e,t){var a,r=[],n=e||1;for(a=0;a<n;a++)r.push({roomTypeId:t&&t[a]||"",roomCount:"1",numAdults:"1",numChildren:"0",numInfants:"0"});return r},r.getRoomDataModel=function(e){var t,a=[],r=e||1;for(t=0;t<r;t++)a.push({numAdults:"1",numChildren:"0",numInfants:"0",roomTypeId:"",roomTypeName:"",rateId:"",room_id:"",rateName:"",rateAvg:0,rateTotal:0,associatedAddonTotal:0,addons:[],varyingOccupancy:!1,stayDates:{},isOccupancyCheckAlerted:!1,demographics:{market:"",source:"",reservationType:"",origin:"",segment:""}});return a},r.getReservationDataModel=function(){return{isHourly:!1,isValidDeposit:!1,tabs:r.getTabDataModel(),arrivalDate:"",departureDate:"",midStay:!1,stayDays:[],resHours:1,checkinTime:{hh:"",mm:"00",ampm:"AM"},checkoutTime:{hh:"",mm:"00",ampm:"AM"},taxDetails:{},numNights:1,roomCount:1,rooms:r.getRoomDataModel(),totalTaxAmount:0,totalStayCost:0,totalTax:0,guest:{id:null,firstName:"",lastName:"",email:"",city:"",loyaltyNumber:"",sendConfirmMailTo:""},company:{id:null,name:"",corporateid:""},travelAgent:{id:null,name:"",iataNumber:""},paymentType:{type:{},ccDetails:{number:"",expMonth:"",expYear:"",nameOnCard:""}},demographics:{market:"",source:"",reservationType:"",origin:""},code:{id:"",type:"",discount:{}},status:"",reservationId:"",confirmNum:"",isSameCard:!1,rateDetails:[],isRoomRateSuppressed:!1,reservation_card:{},number_of_infants:0,number_of_adults:0,number_of_children:0,member:{isSelected:!1,value:""},guestMemberships:{hlp:[],ffp:[]},group:{id:"",name:"",code:"",company:"",travelAgent:""},allotment:{id:"",name:"",code:"",company:"",travelAgent:""},currentSelectedRateCurrencyId:""}},r.getSearchDataModel=function(){return{guestCard:{guestFirstName:"",guestLastName:"",guestCity:"",guestLoyaltyNumber:"",email:""},companyCard:{companyName:"",companyCity:"",companyCorpId:""},travelAgentCard:{travelAgentName:"",travelAgentCity:"",travelAgentIATA:""},groupCard:{name:"",code:""}}},r.getReservationDetailsModel=function(){return{guestCard:{id:"",futureReservations:0},companyCard:{id:"",futureReservations:0},travelAgent:{id:"",futureReservations:0},group:{id:"",futureReservations:0},allotment:{id:"",futureReservations:0}}},r.getEmptyAccountData=function(){return{address_details:{street1:null,street2:null,street3:null,city:null,state:null,postal_code:null,country_id:null,email_address:null,phone:null},account_details:{account_name:null,company_logo:"",account_number:null,accounts_receivable_number:null,billing_information:null},primary_contact_details:{contact_first_name:null,contact_last_name:null,contact_job_title:null,contact_phone:null,contact_email:null},future_reservation_count:0}},r.getTimeModel=function(){return{hh:"",mm:"00",ampm:"AM"}},r.parseTime=function(e){var t=e.trim().split(" "),a=t[0].split(":");return a[1]=(15*Math.round(a[1]/15)%60).toString(),{hh:1===a[0].length?"0"+a[0]:a[0],mm:1===a[1].length?"0"+a[1]:a[1],ampm:t[1]}},r.sortRateAlphabet=function(e,t){return e.isCorporate!=t.isCorporate?e.isCorporate?-1:1:e.isMember!=t.isMember?e.isMember?-1:1:e.isPromotion!=t.isPromotion?e.isPromotion?-1:1:e.name.toLowerCase()<t.name.toLowerCase()?-1:e.name.toLowerCase()>t.name.toLowerCase()?1:0},r.sortRatesAsc=function(e,t){var a=parseFloat(e.adr),r=parseFloat(t.adr);return a<r?-1:a>r?1:0},r.sortRatesInRoomsDESC=function(e,t){return e.isCorporate!=t.isCorporate?e.isCorporate?-1:1:e.isMember!=t.isMember?e.isMember?-1:1:e.isPromotion!=t.isPromotion?e.isPromotion?-1:1:e.adr!=t.adr?t.adr-e.adr:e.adr-t.adr},r.sortRatesInRoomsASC=function(e,t){return e.isCorporate!=t.isCorporate?e.isCorporate?-1:1:e.isMember!=t.isMember?e.isMember?-1:1:e.isPromotion!=t.isPromotion?e.isPromotion?-1:1:e.adr!=t.adr?e.adr-t.adr:t.adr-e.adr},r.sortRoomTypesAscADR=function(e,t){return e.defaultRate.adr<t.defaultRate.adr?-1:e.defaultRate.adr>t.defaultRate.adr?1:0},r.sortRoomTypesAscLevels=function(e,t){return e.level<t.level?-1:e.level>t.level?1:0},r.isVaryingOccupancy=function(e,t,a,r){if(r<2)return!1;var n=e[t].guests.adults,o=e[t].guests.children,i=e[t].guests.infants,s=_.filter(e,function(e,t){return t!==a&&e.guests.adults===n&&e.guests.children===o&&e.guests.infants===i});return s.length<r},r.isVaryingRates=function(e,t,a,r){if(r<2)return!1;var n=e[t].rate.id,o=_.filter(e,function(e,t){return t!==a&&e.rate.id===n});return o.length<r},r.parseReservationData=function(n,o){var i=r.getReservationDataModel(),s={},c=!1,d=!1,l=!1;i.status=n.reservation_status,i.inHouse="CHECKEDIN"===n.reservation_status,i.group={id:n.group_id,name:n.group_name,company:o.company_id||"",travelAgent:o.travel_agent_id||""},i.allotment={id:n.allotment_id,name:n.allotment_name,company:o.company_id||"",travelAgent:o.travel_agent_id||""},i.confirmNum=n.confirmation_num,i.reservationId=n.reservation_id,i.arrivalDate=n.arrival_date,i.departureDate=n.departure_date,i.numNights=n.total_nights,i.isHourly=n.is_hourly_reservation,i.number_of_adults=n.number_of_adults,i.number_of_children=n.number_of_children,i.number_of_infants=n.number_of_infants,n.arrival_time&&(i.checkinTime=r.parseTime(n.arrival_time)),n.is_opted_late_checkout&&n.late_checkout_time?i.checkoutTime=r.parseTime(n.late_checkout_time):n.departure_time&&(i.checkoutTime=r.parseTime(n.departure_time)),i.company.id=o.company_id,i.travelAgent.id=o.travel_agent_id,i.guest.id=o.guest_details.user_id,i.guest.firstName=o.guest_details.first_name,i.guest.lastName=o.guest_details.last_name,i.guest.email=o.guest_details.email,i.guest.is_vip=o.guest_details.vip,i.guest.image=o.guest_details.avatar,i.guest.phone=o.guest_details.phone,i.guest.mobile=o.guest_details.mobile,i.guest.notes_count=o.guest_details.notes_count,i.guest.membership_type=o.guest_details.membership_type,i.guest.address={city:o.guest_details.city,state:o.guest_details.state,phone:o.guest_details.phone},i.demographics={reservationType:n.reservation_type_id||"",market:n.market_segment_id||"",source:n.source_id||"",origin:n.booking_origin_id||"",segment:n.segment_id||""},i.totalStayCost=n.total_rate;var u=i.rooms[0];if(u.rateId=[],u.demographics=angular.copy(i.demographics),u.roomNumber=n.room_number,u.roomTypeDescription=n.room_type_description,u.rateAvg=n.avg_daily_rate,u.rateTotal=n.total_rate,u.rateName=n.is_multiple_rates?"Multiple Rates":n.rate_name,u.is_package_exist=n.is_package_exist,u.package_count=n.package_count,i.is_modified=!1,angular.forEach(n.stay_dates,function(r,o){i.is_modified=r.rate.actual_amount!==r.rate.modified_amount,i.stayDays.push({date:t(new tzIndependentDate(r.date),"yyyy-MM-dd"),dayOfWeek:t(new tzIndependentDate(r.date),"EEE"),day:t(new tzIndependentDate(r.date),"dd"),shouldDisable:tzIndependentDate(r.date)<tzIndependentDate(e.businessDate)}),u.stayDates[t(new tzIndependentDate(r.date),"yyyy-MM-dd")]={guests:{adults:r.adults,children:r.children,infants:r.infants},rate:{id:r.rate_id},rateDetails:r.rate,roomTypeId:r.room_type_id,roomId:r.room_id},u.rateId.push(r.rate_id),0===o&&(u.roomTypeId="CHECKEDIN"===n.reservation_status?n.room_type_id:r.room_type_id,u.room_id=n.room_id,u.roomTypeName=n.room_type_description,a.bookMark.lastPostedRate=r.rate_id)}),parseInt(i.numNights)>0&&(i.stayDays.push({date:i.departureDate,dayOfWeek:t(new tzIndependentDate(i.departureDate),"EEE"),day:t(new tzIndependentDate(i.departureDate),"dd")}),u.stayDates[i.departureDate]=angular.copy(u.stayDates[i.departureDate])),""!==n.payment_method_used&&null!==n.payment_method_used&&(i.paymentType.type.description=n.payment_method_description,i.paymentType.type.value=n.payment_method_used,"CC"===i.paymentType.type.value)){var m=n.payment_details;s.creditCardType=m.card_type_image.replace(".png","").toLowerCase(),s.endingWith=m.card_number,s.cardExpiry=m.card_expiry,s.isSwiped=m.is_swiped,i.selectedPaymentId=m.id,"sixpayments"===e.paymentGateway&&(m.is_swiped?c=!0:d=!0),l=!0}var f=_.findWhere(n.stay_dates,{date:i.arrivalDate});if(u.numAdults=f.adults,u.numChildren=f.children,u.numInfants=f.infants,new tzIndependentDate(i.arrivalDate)<new tzIndependentDate(e.businessDate)){i.midStay=!0;var p=_.last(n.stay_dates),v=_.findWhere(n.stay_dates,{date:t(new tzIndependentDate(e.businessDate),"yyyy-MM-dd")});v?(u.numAdults=v.adults,u.numChildren=v.children,u.numInfants=v.infants):(u.numAdults=p.adults,u.numChildren=p.children,u.numInfants=p.infants)}u.varyingOccupancy=r.isVaryingOccupancy(u.stayDates,i.arrivalDate,i.departureDate,i.numNights),u.rateName=r.isVaryingRates(u.stayDates,i.arrivalDate,i.departureDate,i.numNights)?"Multiple Rates Selected":n.package_description;var D=i.tabs[0];return _.extend(D,{roomTypeId:u.roomTypeId,numAdults:u.numAdults,numChildren:u.numChildren,numInfants:u.numInfants}),i.groupCompanyCardId=n.group_cc_id,i.groupTravelAgentId=n.group_ta_id,{reservationData:i,reservationEditMode:c,isManual:d,showSelectedCreditCard:l,renderData:s}}}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){angular.module("sntRover").service("RVReservationNotesService",["$q","rvBaseWebSrvV2",function(e,t){var a=this;a.sync=function(a){var r=e.defer(),n="/api/reservations/"+a+"/sync_notes_with_ext_pms.json";return t.getJSON(n).then(function(e){r.resolve(e.notes_count)},function(e){r.reject(e)}),r.promise},a.fetch=function(a){var r=e.defer(),n="/api/reservations/"+a+"/notes.json";return t.getJSON(n).then(function(e){r.resolve(e.notes.reservation_notes)},function(e){r.reject(e)}),r.promise}}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){angular.module("sntRover").service("RVReservationStateService",[function(){var e=this;e.metaData={rateAddons:[],taxDetails:[]},e.reservationFlags={outsideStaydatesForGroup:!1,borrowForGroups:!1,RATE_CHANGED:!1,RATE_CHANGE_FAILED:!1},e.bookMark={lastPostedRate:null},e.fetchAssociatedAddons=function(t){_.isArray(t)&&(t=t[0]);var a=_.findWhere(e.metaData.rateAddons,{rate_id:t});return a&&a.associated_addons?a.associated_addons:null},e.updateRateAddonsMeta=function(t){if(0===t.length)return!1;var a=_.findWhere(e.metaData.rateAddons,{rate_id:t[0].rateId});a?a[0]=t[0]:e.metaData.rateAddons.push(t[0])},e.getCustomRateModel=function(e,t,a){var r=a&&"ALLOTMENT"===a,n="_CUSTOM_"+e,o=r?"Custom Rate for Allotment "+t:"Custom Rate for Group "+t,i=r?"Custom Allotment Rate":"Custom Group Rate";return{id:n,name:o,description:i,is_suppress_rate_on:!1,is_discount_allowed_on:!0,rate_type:{id:null,name:r?"Allotment Rate":"Group Rate"},deposit_policy:{id:null,name:"",description:""},cancellation_policy:{id:null,name:"",description:""},market_segment:{id:null,name:""},source:{id:null,name:""},is_member:!1,linked_promotion_ids:[]}},e.getAddonAmount=function(e,t,a,r){return"PERSON"===e?t*parseInt(parseInt(a,10)+parseInt(r,10),10):"CHILD"===e?t*parseInt(r,10):"ADULT"===e?t*parseInt(a,10):t},e.calculateRate=function(e,t,a){var r=t>=2?e.double:e.single,n=t>=2?t-2:0;return r+n*e.extra_adult+a*e.child},e.calculateMultiplier=function(e,t,a){var r=1;return"ADULT"===e?r=t:"CHILD"===e?r=a:"PERSON"===e&&(r=parseInt(a,10)+parseInt(t,10)),r},e.getApplicableAddonsCount=function(e,t,a,r,n,o,i,s){var c=function(e,t){return 0===a?t:1===a?t*o:"undefined"!=typeof i&&i?t*parseInt(o/a,10):t*(parseInt(o/a,10)+1)},d=function(e,t){return"create_group"===t||"create_allotment"===t||"group"===t||"allotments"===t?0:e};return"PERSON"===e?c(t,r+d(n,s)):"ADULT"===e?c(t,r):"CHILD"===e?c(t,n):"FLAT"===e||"ROOM"===e?c(t,1):void 0},e.computeBaseAmount=function(t,a,r,n){var o=0,i=0;return _.each(a,function(t){var a=t.is_inclusive,s=_.findWhere(e.metaData.taxDetails,{id:parseInt(t.charge_code_id,10)}),c=s.amount_type,d=e.calculateMultiplier(c,r,n);a&&("%"===s.amount_symbol?o+=d*parseFloat(s.amount):i+=d*parseFloat(s.amount))}),100*t/(100+o)-i},e.setReservationFlag=function(t,a){e.reservationFlags[t]=a},e.getReservationFlag=function(t){return e.reservationFlags[t]},e.shouldPostAddon=function(e,t,a,r,n){if(0===e&&t===a)return!0;var o=864e5,i=parseInt((new tzIndependentDate(t)-new tzIndependentDate(a))/o,10),s=parseInt((new tzIndependentDate(r)-new tzIndependentDate(t))/o,0);return i%e===0&&(!n||n&&s>=e)},e.isPostDaySelected=function(e,t){if(!t)return!0;var a,r=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],n=new tzIndependentDate(e);return a=n.getDay(),t[r[a]]},e.applyDiscount=function(e,t,a){return 0===a&&(a=1),parseFloat(e)<=0?0:"amount"===t.type?e-t.value/a:e-e*(t.value/100)};e.getAddonAmounts=function(t,a,r,n){var o={};return _.each(n,function(n,i){var s=n.guests.adults,c=n.guests.children,d=i;o[d]={},_.each(t,function(t){var n=t.rate_id;_.each(t.associated_addons,function(t){var i=parseFloat(e.getAddonAmount(t.amount_type.value,parseFloat(t.amount),s,c)),l=e.shouldPostAddon(t.post_type.frequency,d,a,r,t.charge_full_weeks_only);!t.is_inclusive&&l&&(void 0===o[d][n]?o[d][n]=i:o[d][n]=parseFloat(o[d][n])+i)})})}),o},this.setForceOverbookFlagForGroup=function(e){this.forceOverbookForGroups=e},this.getForceOverbookForGroup=function(){return this.forceOverbookForGroups}}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){angular.module("sntRover").service("RVReservationTabService",["$rootScope","dateFilter","RVReservationStateService","RVReservationDataService",function(e,t,a,r){var n=this;n.newTab=function(e){return r.getTabDataModel(e)},n.newRoom=function(e){return r.getRoomDataModel(e)}}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){angular.module("sntRover").service("RVRoomRatesSrv",["$q","rvBaseWebSrvV2","RVReservationBaseSearchSrv",function(e,t,a){var r=this,n=function(t){var n=e.defer();return r.fetchRoomTypeADRs(t,!0).then(function(e){if(e.results.length>0){var o=a.getRoomTypeLevel(e.results[0].id);if(o>0&&o<3){var i=e;r.fetchRoomTypeADRs(t,!1,o+1).then(function(e){e.results>0&&(i.results[2]=e.results[1]),n.resolve(i)},function(e){n.reject(e)})}else n.resolve(e)}else n.resolve(e)},function(e){n.reject(e)}),n.promise},o=function(e){var t=r.getRoomAndRateActiveTab();"RATE"!==t&&"ROOM_TYPE"!==t||(e.is_member="false",e.company_id&&delete e.company_id,e.travel_agent_id&&delete e.travel_agent_id,e.promotion_code&&delete e.promotion_code,e.promotion_id&&delete e.promotion_id)};r.fetchRoomTypeADRs=function(r,n,i){var s=e.defer(),c="/api/availability/room_type_adrs";return n&&(r.per_page=2,r.page=1,r.order="ROOM_LEVEL"),i&&(r.per_page=1,r.page=1,r.level=i),r.exclude_pseudo=!0,r.exclude_suite=!0,o(r),t.getJSON(c,r).then(function(e){var t={};t.rate_ids=_.uniq(_.pluck(e.results,"rate_id")),a.fetchRatesDetails(t).then(function(){r.group_id&&_.each(e.results,function(e){null===e.rate_id&&(e.rate_id="_CUSTOM_"+r.group_id)}),s.resolve(e)})},function(e){s.reject(e)}),s.promise},r.fetchRateADRs=function(r){var n=e.defer(),i="/api/availability/rate_adrs";return r.exclude_pseudo=!0,r.exclude_suite=!0,o(r),t.getJSON(i,r).then(function(e){var t={};t.rate_ids=_.pluck(e.results,"id"),r.arrivalDateRateId&&t.rate_ids.push(r.arrivalDateRateId),a.fetchRatesDetails(t).then(function(){r.group_id&&_.each(e.results,function(e){null===e.id&&(e.rate_id="_CUSTOM_"+r.group_id,e.id="_CUSTOM_"+r.group_id)}),n.resolve(e)})},function(e){n.reject(e)}),n.promise},r.fetchRatesInitial=function(t){var a=r.getRoomAndRateActiveTab(),o=[],i=e.defer(),s=[];return"RATE"===a||"RECOMMENDED"===a&&(t.company_id||t.travel_agent_id||t.group_id||t.promotion_code||t.promotion_id||t.is_member)?(t.order="RATE",o.push(r.fetchRateADRs(t,!0).then(function(e){s=e}))):"ROOM_TYPE"===a&&o.push(n(t,!0).then(function(e){s=e})),e.all(o).then(function(){i.resolve(s)},function(e){i.reject(e)}),i.promise},r.setRoomAndRateActiveTab=function(e){r.roomAndRateActiveTab=e},r.getRoomAndRateActiveTab=function(){return r.roomAndRateActiveTab}}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){angular.module("sntRover").service("RVReservationBaseSearchSrv",["$q","rvBaseWebSrvV2","sntBaseWebSrv","dateFilter",function(e,t,a,r){var n=this;this.reservation={settings:{},roomTypes:{},businessDate:{}},this.rateDetailsList={},this.cache={config:{lifeSpan:3600},responses:{restrictionTypes:null,rateDetails:null,sortOrder:null,taxMeta:null,customMeta:null}},this.getRoomRatesDefaultView=function(){var e="ROOM_TYPE";return n.reservation.settings&&n.reservation.settings.default_rate_display_name&&("Recommended"===n.reservation.settings.default_rate_display_name?e="RECOMMENDED":"By Rate"===n.reservation.settings.default_rate_display_name&&(e="RATE")),e},this.getRoomTypeLevel=function(e){var t=-1;if(n.reservation.roomTypes){var a=_.find(n.reservation.roomTypes,{id:e});t=a.level}return t},this.timeSlots=[{value:"12:00 AM",label:"12:00 AM",fullDayValue:0},{value:"12:15 AM",label:"12:15 AM",fullDayValue:15},{value:"12:30 AM",label:"12:30 AM",fullDayValue:30},{value:"12:45 AM",label:"12:45 AM",fullDayValue:45},{value:"01:00 AM",label:"01:00 AM",fullDayValue:100},{value:"01:15 AM",label:"01:15 AM",fullDayValue:115},{value:"01:30 AM",label:"01:30 AM",fullDayValue:130},{value:"01:45 AM",label:"01:45 AM",fullDayValue:145},{value:"02:00 AM",label:"02:00 AM",fullDayValue:200},{value:"02:15 AM",label:"02:15 AM",fullDayValue:215},{value:"02:30 AM",label:"02:30 AM",fullDayValue:230},{value:"02:45 AM",label:"02:45 AM",fullDayValue:245},{value:"03:00 AM",label:"03:00 AM",fullDayValue:300},{value:"03:15 AM",label:"03:15 AM",fullDayValue:315},{value:"03:30 AM",label:"03:30 AM",fullDayValue:330},{value:"03:45 AM",label:"03:45 AM",fullDayValue:345},{value:"04:00 AM",label:"04:00 AM",fullDayValue:400},{value:"04:15 AM",label:"04:15 AM",fullDayValue:415},{value:"04:30 AM",label:"04:30 AM",fullDayValue:430},{value:"04:45 AM",label:"04:45 AM",fullDayValue:445},{value:"05:00 AM",label:"05:00 AM",fullDayValue:500},{value:"05:15 AM",label:"05:15 AM",fullDayValue:515},{value:"05:30 AM",label:"05:30 AM",fullDayValue:530},{value:"05:45 AM",label:"05:45 AM",fullDayValue:545},{value:"06:00 AM",label:"06:00 AM",fullDayValue:600},{value:"06:15 AM",label:"06:15 AM",fullDayValue:615},{value:"06:30 AM",label:"06:30 AM",fullDayValue:630},{value:"06:45 AM",label:"06:45 AM",fullDayValue:645},{value:"07:00 AM",label:"07:00 AM",fullDayValue:700},{value:"07:15 AM",label:"07:15 AM",fullDayValue:715},{value:"07:30 AM",label:"07:30 AM",fullDayValue:730},{value:"07:45 AM",label:"07:45 AM",fullDayValue:745},{value:"08:00 AM",label:"08:00 AM",fullDayValue:800},{value:"08:15 AM",label:"08:15 AM",fullDayValue:815},{value:"08:30 AM",label:"08:30 AM",fullDayValue:830},{value:"08:45 AM",label:"08:45 AM",fullDayValue:845},{value:"09:00 AM",label:"09:00 AM",fullDayValue:900},{value:"09:15 AM",label:"09:15 AM",fullDayValue:915},{value:"09:30 AM",label:"09:30 AM",fullDayValue:930},{value:"09:45 AM",label:"09:45 AM",fullDayValue:945},{value:"10:00 AM",label:"10:00 AM",fullDayValue:1e3},{value:"10:15 AM",label:"10:15 AM",fullDayValue:1015},{value:"10:30 AM",label:"10:30 AM",fullDayValue:1030},{value:"10:45 AM",label:"10:45 AM",fullDayValue:1045},{value:"11:00 AM",label:"11:00 AM",fullDayValue:1100},{value:"11:15 AM",label:"11:15 AM",fullDayValue:1115},{value:"11:30 AM",label:"11:30 AM",fullDayValue:1130},{value:"11:45 AM",label:"11:45 AM",fullDayValue:1145},{value:"12:00 PM",label:"12:00 PM",fullDayValue:1200},{value:"12:15 PM",label:"12:15 PM",fullDayValue:1215},{value:"12:30 PM",label:"12:30 PM",fullDayValue:1230},{value:"12:45 PM",label:"12:45 PM",fullDayValue:1245},{value:"01:00 PM",label:"01:00 PM",fullDayValue:1300},{value:"01:15 PM",label:"01:15 PM",fullDayValue:1315},{value:"01:30 PM",label:"01:30 PM",fullDayValue:1330},{value:"01:45 PM",label:"01:45 PM",fullDayValue:1345},{value:"02:00 PM",label:"02:00 PM",fullDayValue:1400},{value:"02:15 PM",label:"02:15 PM",fullDayValue:1415},{value:"02:30 PM",label:"02:30 PM",fullDayValue:1430},{value:"02:45 PM",label:"02:45 PM",fullDayValue:1445},{value:"03:00 PM",label:"03:00 PM",fullDayValue:1500},{value:"03:15 PM",label:"03:15 PM",fullDayValue:1515},{value:"03:30 PM",label:"03:30 PM",fullDayValue:1530},{value:"03:45 PM",label:"03:45 PM",fullDayValue:1545},{value:"04:00 PM",label:"04:00 PM",fullDayValue:1600},{value:"04:15 PM",label:"04:15 PM",fullDayValue:1615},{value:"04:30 PM",label:"04:30 PM",fullDayValue:1630},{value:"04:45 AM",label:"04:45 PM",fullDayValue:1645},{value:"05:00 PM",label:"05:00 PM",fullDayValue:1700},{value:"05:15 PM",label:"05:15 PM",fullDayValue:1715},{value:"05:30 PM",label:"05:30 PM",fullDayValue:1730},{value:"05:45 PM",label:"05:45 PM",fullDayValue:1745},{value:"06:00 PM",label:"06:00 PM",fullDayValue:1800},{value:"06:15 PM",label:"06:15 PM",fullDayValue:1815},{value:"06:30 PM",label:"06:30 PM",fullDayValue:1830},{value:"06:45 PM",label:"06:45 PM",fullDayValue:1845},{value:"07:00 PM",label:"07:00 PM",fullDayValue:1900},{value:"07:15 PM",label:"07:15 PM",fullDayValue:1915},{value:"07:30 PM",label:"07:30 PM",fullDayValue:1930},{value:"07:45 PM",label:"07:45 PM",fullDayValue:1945},{value:"08:00 PM",label:"08:00 PM",fullDayValue:2e3},{value:"08:15 PM",label:"08:15 PM",fullDayValue:2015},{value:"08:30 PM",label:"08:30 PM",fullDayValue:2030},{value:"08:45 PM",label:"08:45 PM",fullDayValue:2045},{value:"09:00 PM",label:"09:00 PM",fullDayValue:2100},{value:"09:15 PM",label:"09:15 PM",fullDayValue:2115},{value:"09:30 PM",label:"09:30 PM",fullDayValue:2130},{value:"09:45 PM",label:"09:45 PM",fullDayValue:2145},{value:"10:00 PM",label:"10:00 PM",fullDayValue:2200},{value:"10:15 PM",label:"10:15 PM",fullDayValue:2215},{value:"10:30 PM",label:"10:30 PM",fullDayValue:2230},{value:"10:45 PM",label:"10:45 PM",fullDayValue:2245},{value:"11:00 PM",label:"11:00 PM",fullDayValue:2300},{value:"11:15 PM",label:"11:15 PM",fullDayValue:2315},{value:"11:30 PM",label:"11:30 PM",fullDayValue:2330},{value:"11:45 PM",label:"11:45 PM",fullDayValue:2345}],this.fetchBaseSearchData=function(){var a=e.defer();if(n.fetchBussinessDate=function(){var e="/api/business_dates/active";return t.getJSON(e).then(function(e){n.reservation.businessDate=e.business_date,a.resolve(n.reservation)},function(e){a.reject(e)}),a.promise},n.fetchRoomTypes=function(){var e="api/room_types.json?exclude_pseudo=true&per_page=100";return t.getJSON(e).then(function(e){n.reservation.roomTypes=e.results,n.fetchBussinessDate()},function(e){a.reject(e)}),a.promise},isEmpty(n.reservation.settings)&&isEmpty(n.reservation.roomTypes)&&isEmpty(n.reservation.businessDate)){var r="/api/hotel_settings/show_hotel_reservation_settings";t.getJSON(r).then(function(e){n.reservation.settings=e,n.fetchRoomTypes()},function(e){a.reject(e)})}else a.resolve(n.reservation);return a.promise},this.fetchCompanyCard=function(a){var r=e.defer(),n="/api/accounts";return t.getJSON(n,a).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.autoCompleteCodes=function(a){var r=e.defer(),n="/api/code_search";return t.getJSON(n,a).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.fetchCurrentTime=function(a){var r=e.defer(),n="/api/hotel_current_time";return t.getJSON(n).then(function(e){a&&"string"==typeof a&&(e.hotel_time.date=a),r.resolve(e)},function(e){r.reject(e)}),r.promise},this.fetchAvailability=function(a){var r=e.defer(),n="/api/availability?from_date="+a.from_date+"&to_date="+a.to_date+"&override_restrictions=true";return a.company_id&&(n+="&company_id="+a.company_id),a.travel_agent_id&&(n+="&travel_agent_id="+a.travel_agent_id),a.group_id&&(n+="&group_id="+a.group_id),a.promotion_code&&(n+="&promotion_code="+encodeURI(a.promotion_code)),a.allotment_id&&(n+="&allotment_id="+encodeURI(a.allotment_id)),t.getJSON(n).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.fetchMinTime=function(){var a=e.defer(),r="/api/hourly_rate_min_hours";return t.getJSON(r).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.fetchSortPreferences=function(){var a=e.defer(),r="/api/sort_preferences/list_selections";
return null===n.cache.responses.sortOrder||Date.now()>n.cache.responses.sortOrder.expiryDate?t.getJSON(r).then(function(e){n.cache.responses.sortOrder={data:e.room_rates,expiryDate:Date.now()+1e3*n.cache.config.lifeSpan},a.resolve(e.room_rates)},function(e){a.reject(e)}):a.resolve(n.cache.responses.sortOrder.data),a.promise},this.fetchAddonsForRates=function(a){var r=e.defer(),n="/api/addons/rate_addons";return t.getJSON(n,a).then(function(e){r.resolve(e.rate_addons)},function(e){r.reject(e)}),r.promise},this.hasAnyConfiguredAddons=function(a){var r=e.defer(),n="/api/addons/configured";return t.getJSON(n,a).then(function(e){r.resolve(e.addons_configured)},function(e){r.reject(e)}),r.promise},this.getActivePromotions=function(){var a=e.defer(),r="/api/promotions?is_active=true";return t.getJSON(r).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.fetchUserMemberships=function(a){var r=e.defer(),n="/staff/user_memberships.json?user_id="+a;return t.getJSON(n).then(function(e){r.resolve(e.data)},function(e){r.reject(e)}),r.promise},this.checkOverbooking=function(a){var r=e.defer(),n="/api/availability/overbooking_check";return t.getJSON(n,a).then(function(e){r.resolve(e.results)},function(e){r.reject(e)}),r.promise},this.checkDiaryAvailability=function(a){var r=e.defer(),n="/api/nightly_diary/availability";return t.postJSON(n,a).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.fetchOrdinaryRates=function(a){var r=e.defer(),n="/api/availability/rates";return t.getJSON(n,a).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.fetchContractRates=function(a){var r=e.defer(),n="/api/availability/contracts";return t.getJSON(n,a).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.fetchGroupRates=function(a){var r=e.defer(),n=a.group_id||a.allotment_id,o="/api/availability/groups/"+n;return t.getJSON(o,a).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.fetchRates=function(t){var a=e.defer(),r=[];return n.rates=[],t.group_id?r.push(n.fetchGroupRates(t).then(function(e){_.each(e.rates,function(e){null===e.id&&(e.id="_CUSTOM_"+t.group_id)}),n.rates=n.rates.concat(e.rates)})):(r.push(n.fetchOrdinaryRates(t).then(function(e){n.rates=n.rates.concat(e.rates)})),(t.company_id||t.travel_agent_id)&&r.push(n.fetchContractRates(t).then(function(e){_.each(e.rates,function(e){e.isCorporate=!0}),n.rates=n.rates.concat(e.rates)}))),e.all(r).then(function(){a.resolve(n.rates)},function(e){a.reject(e)}),a.promise},this.fetchRestricitonTypes=function(){var a=e.defer(),r="/api/restriction_types";return null===n.cache.responses.restrictionTypes||Date.now()>n.cache.responses.restrictionTypes.expiryDate?t.getJSON(r).then(function(e){e.results.push({id:98,value:"INVALID_PROMO",description:"PROMOTION INVALID",activated:!0}),e.results.push({id:99,activated:!0,value:"HOUSE_FULL",description:"NO HOUSE AVAILABILITY"});var t={};_.each(e.results,function(e){t[e.id]={key:e.value,value:["CLOSED","CLOSED_ARRIVAL","CLOSED_DEPARTURE","HOUSE_FULL","INVALID_PROMO"].indexOf(e.value)>-1?e.description:e.description+":"}}),n.cache.responses.restrictionTypes={data:t,expiryDate:Date.now()+1e3*n.cache.config.lifeSpan},a.resolve(t)},function(e){a.reject(e)}):a.resolve(n.cache.responses.restrictionTypes.data),a.promise};var o=function(e){var t=_.reject(e.rate_ids,function(e){return!!(n.rateDetailsList[e]&&Date.now()<n.rateDetailsList[e].expiryDate)});return t};this.fetchRatesDetails=function(a){var r=o(a),i=e.defer(),s="/api/rates/search.json",c={};return c.rate_ids=r,0===r.length?i.resolve({}):t.postJSON(s,c).then(function(e){_.each(e.results,function(e){n.rateDetailsList[e.id]={expiryDate:Date.now()+1e3*n.cache.config.lifeSpan,details:e}}),i.resolve(e.results)},function(e){i.reject(e)}),i.promise},this.fetchCustomRateConfig=function(){var a=e.defer(),r="api/rates/custom_group_rate_taxes";return null===n.cache.responses.customMeta||Date.now()>n.cache.responses.customMeta.expiryDate?t.getJSON(r).then(function(e){var t=e;n.cache.responses.customMeta={data:t,expiryDate:Date.now()+1e3*n.cache.config.lifeSpan},a.resolve(t)},function(e){a.reject(e)}):a.resolve(n.cache.responses.customMeta.data),a.promise},this.fetchRatesMeta=function(t){var a=e.defer(),r=[];return n["rates-restrictions"]={},r.push(n.fetchRestricitonTypes(t).then(function(e){n["rates-restrictions"].restrictions=e})),r.push(n.fetchCustomRateConfig().then(function(e){n["rates-restrictions"].customRates=e})),e.all(r).then(function(){a.resolve(n["rates-restrictions"])},function(e){a.reject(e)}),a.promise},this.fetchTaxInformation=function(){var a=e.defer(),r="api/rates/tax_information";return null===n.cache.responses.taxMeta||Date.now()>n.cache.responses.taxMeta.expiryDate?t.getJSON(r).then(function(e){var t=e.tax_codes;n.cache.responses.taxMeta={data:t,expiryDate:Date.now()+1e3*n.cache.config.lifeSpan},a.resolve(t)},function(e){a.reject(e)}):a.resolve(n.cache.responses.taxMeta.data),a.promise},this.fetchHouseAvailability=function(a){var r=e.defer(),n="api/availability/house";return t.getJSON(n,a).then(function(e){var t={};_.each(e.results,function(e){t[e.date]=e.availability}),r.resolve(t)},function(e){r.reject(e)}),r.promise},this.fetchHouseRestrictions=function(a){var r=e.defer(),n="/api/availability/house_restrictions";return t.getJSON(n,a).then(function(e){r.resolve(e.restrictions)},function(e){r.reject(e)}),r.promise},this.fetchTaxRateAddonMeta=function(t){var a=e.defer(),r=[];return n.meta={},r.push(n.fetchTaxInformation().then(function(e){n.meta.taxInfo=e})),r.push(n.fetchAddonsForRates(t).then(function(e){n.meta.rateAddons=e})),e.all(r).then(function(){a.resolve(n.meta)},function(e){a.reject(e)}),a.promise},this.fetchHotelReservationSettings=function(){var a=e.defer(),r="/api/hotel_settings/show_hotel_reservation_settings";return t.getJSON(r).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.searchForRates=function(a){var r=e.defer(),n={},o="/api/rates.json?&sort_dir=true&sort_field=rate";return n.query=a.query,n.per_page=25,n.page=1,t.getJSON(o,n).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.fetchRateDetailsForIds=function(a){var r=o(a),i=e.defer(),s="/api/rates/search.json",c={};return c.rate_ids=r,0===r.length?i.resolve({}):t.postJSON(s,c).then(function(e){_.each(e.results,function(e){n.rateDetailsList[e.id]={expiryDate:Date.now()+1e3*n.cache.config.lifeSpan,details:e}});var t=_.difference(a.rate_ids,r);_.each(t,function(t){e.results.push(n.rateDetailsList[t].details)}),i.resolve(e.results)},function(e){i.reject(e)}),i.promise},this.checkTimeBasedAvailabilityAPI=function(t){var r=e.defer(),n="api/availability/time_based_room_type_and_house_avl";return a.postJSON(n,t).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise}}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){angular.module("sntRover").service("RVReservationGuestSrv",["$q","rvBaseWebSrvV2",function(e,t){this.fetchGuestTabDetails=function(a){var r=e.defer(),n="/api/reservations/"+a.reservation_id+"/reservations_guest_details";return t.getJSON(n).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.updateGuestTabDetails=function(a){var r=e.defer(),n="/api/reservations/"+a.reservation_id+"/reservations_guest_details";return t.postJSON(n,a).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.fetchGuestPrefList=function(a){var r=e.defer(),n="api/hotels/guest_preferences.json";return t.getJSON(n,a).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.verifyRateChange=function(a){var r=e.defer(),n="/api/reservations/"+a.reservation_id+"/verify_rate_change";return delete a.reservation_id,t.getJSON(n,a).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise}}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){sntRover.service("rvReservationHouseKeepingSrv",["$q","rvBaseWebSrvV2",function(e,t){this.fetch=function(a){var r=e.defer(),n="/api/reservations/"+a.reservation_id+"/room_attendance";return t.getJSON(n).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.save=function(a){var r=e.defer(),n="/api/reservations/save_reservation_task";return t.postJSON(n,a).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise}}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){angular.module("sntRover").service("RVReservationSummarySrv",["$q","rvBaseWebSrvV2",function(e,t){var a=this;this.reservationData={},this.reservationData.demographics={};var r={},n={},o={},i={},s={};this.fetchPaymentMethods=function(){var a=e.defer(),r="/staff/payments/addNewPayment.json";return t.getJSON(r).then(function(e){a.resolve(e.data)},function(e){a.reject(e)}),a.promise},this.fetchLengthSegments=function(){var a=e.defer();if(isEmpty(s)){var r="/api/segments?is_active=true";t.getJSON(r).then(function(e){s=e,a.resolve(e)},function(e){a.reject(e)})}else a.resolve(s);return a.promise},this.fetchDemographicMarketSegments=function(){var a=e.defer();if(isEmpty(r)){var n="/api/market_segments?is_active=true";t.getJSON(n).then(function(e){r=e,a.resolve(r)},function(e){a.reject(e)})}else a.resolve(r);return a.promise},this.fetchDemographicSources=function(){var a=e.defer();if(isEmpty(n)){var r="/api/sources?is_active=true";t.getJSON(r).then(function(e){n=e,a.resolve(n)},function(e){a.reject(e)})}else a.resolve(n);return a.promise},this.fetchDemographicOrigins=function(){var a=function(e){o.is_use_origins=e.is_use_origins,o.origins=[];for(var t in e.booking_origins)e.booking_origins[t].is_active&&o.origins.push(e.booking_origins[t]);r.resolve(o)},r=e.defer();if(isEmpty(o)){var n="/api/booking_origins";t.getJSON(n).then(function(e){a(e)},function(e){r.reject(e)})}else r.resolve(o);return r.promise},this.fetchDemographicReservationTypes=function(){var r=function(e){i=[],a.reservationData.demographics.reservationTypes=[];for(var t in e.reservation_types)e.reservation_types[t].is_active&&i.push(e.reservation_types[t]);n.resolve(i)},n=e.defer();if(isEmpty(i)){var o="/api/reservation_types.json?is_active=true";t.getJSON(o).then(function(e){r(e)},function(e){n.reject(e)})}else n.resolve(i);return n.promise},this.fetchInitialData=function(){var t=e.defer(),r={};return r.marketsData=a.fetchDemographicMarketSegments(),r.originsData=a.fetchDemographicOrigins(),r.sourcesData=a.fetchDemographicSources(),r.reservationTypesData=a.fetchDemographicReservationTypes(),r.segmentsData=a.fetchLengthSegments(),e.all(r).then(function(e){a.reservationData.demographics.is_use_markets=e.marketsData.is_use_markets,a.reservationData.demographics.markets=e.marketsData.markets,a.reservationData.demographics.is_use_origins=e.originsData.is_use_origins,a.reservationData.demographics.origins=e.originsData.origins,a.reservationData.demographics.is_use_sources=e.sourcesData.is_use_sources,a.reservationData.demographics.sources=e.sourcesData.sources,a.reservationData.demographics.is_use_segments=e.segmentsData.is_use_segments,a.reservationData.demographics.segments=e.segmentsData.segments,a.reservationData.demographics.reservationTypes=e.reservationTypesData,t.resolve(a.reservationData)},function(e){t.reject(e)}),t.promise},this.saveReservation=function(a){var r=e.defer(),n="/api/reservations";return t.postJSON(n,a).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.updateBillingInformation=function(a){var r=e.defer(),n="api/bill_routings/update_dates";return t.postJSON(n,a).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.sendConfirmationEmail=function(a){var r=e.defer(),n="/api/reservations/"+a.reservationId+"/email_confirmation";return delete a.reservationId,t.postJSON(n,a).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.sendHourlyConfirmationEmail=function(a){var r=e.defer(),n="/api/reservations/hourly_confirmation_emails?";return _.each(a.reservation_ids,function(e){n+="reservation_ids[]="+e+"&"}),_.each(a.emails,function(e){n+="emails[]="+encodeURIComponent(e)+"&"}),delete a.reservation_ids,delete a.emails,t.postJSON(n,a).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.updateReservation=function(a){var r=e.defer(),n="/api/reservations/"+a.reservationId;return t.putJSON(n,a).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.paymentAction=function(a){var r=e.defer(),n="/api/ipage/store_payments";return t.postJSON(n,a).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.startPayment=function(a){var r=e.defer(),n="/api/cc/get_token";return t.postJSON(n,a).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.fetchRooms=function(){var a=e.defer(),r="/api/rooms";return t.getJSON(r).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.getRateName=function(a){var r=e.defer(),n="/api/rates/"+a.id;return t.getJSON(n).then(function(e){r.resolve(e.name)},function(e){r.reject(e)}),r.promise},this.getRateDetails=function(a){var r=e.defer(),n="/api/rates/"+a.id;return t.getJSON(n).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.getTaxDetails=function(a){var r=e.defer(),n="/api/rates/tax_information/";return t.getJSON(n,a).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.fetchDefaultRoutingInfo=function(a){var r=e.defer(),n="/api/default_account_routings/routings_count/";return t.postJSON(n,a).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.applyDefaultRoutingToReservation=function(a){var r=e.defer(),n="/api/default_account_routings/attach_reservation";return t.postJSON(n,a).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.fetchResservationConfirmationPrintData=function(a){var r=e.defer(),n="/api/reservations/"+a.reservation_id+"/confirmation_email_data";return t.getJSON(n,a).then(function(e){e.data.addons_list=e.data.addons?e.data.addons.toString():"",r.resolve(e)},function(e){r.reject(e)}),r.promise},this.fetchResservationCancellationPrintData=function(a){var r=e.defer(),n="/api/reservations/"+a.reservation_id+"/cancellation_email_data";return t.getJSON(n,a).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.updateNoRoomMove=function(a){var r=e.defer(),n="/api/reservations/"+a.reservationId+"/update_no_room_move_flag";return t.postJSON(n,a).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.updateRestrictPost=function(a){var r=e.defer(),n="/api/reservations/"+a.reservationId+"/update_restrict_post_flag";return t.postJSON(n,a).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.saveTaxExempt=function(a){var r=e.defer(),n="/api/reservations/save_tax_exempt";return t.postJSON(n,a).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.checkUpsellAvailability=function(a){var r=e.defer(),n="/api/reservations/"+a+"/upsell_availability";return t.getJSON(n).then(function(e){r.resolve(e.is_upsell_available)},function(e){r.reject(e)}),r.promise},this.updateCommission=function(a){var r=e.defer(),n="/api/reservations/"+a.reservationId+"/update_commission";return t.putJSON(n,a).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.retrieveRoomPin=function(a){var r=e.defer(),n="/staff/reservation/get_room_pin";return t.getJSON(n,a).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.updateBookerEmail=function(a){var r=e.defer(),n="/api/reservations/"+a.reservationId+"/update_booker_email";return t.putJSON(n,a).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise}}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){sntRover.service("RVSelectRoomRateSrv",["$q","rvBaseWebSrvV2","dateFilter",function(e,t,a){var r=this;r.restrictionColorClass={CLOSED:"red",CLOSED_ARRIVAL:"red",CLOSED_DEPARTURE:"red",MIN_STAY_LENGTH:"blue",MAX_STAY_LENGTH:"grey",MIN_STAY_THROUGH:"purple",MIN_ADV_BOOKING:"grey",MAX_ADV_BOOKING:"green",DEPOSIT_REQUESTED:"grey",CANCEL_PENALTIES:"grey",LEVELS:"grey",RATE_NOT_CONFIGURED:"red"},r.houseAvailability,r.promotionValidity,r.isGroupReservation,r.getRateDetails=function(a){var r=e.defer(),n="/api/availability/rate_details";return t.getJSON(n,a).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise}}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){angular.module("sntRover").service("RVStayDatesCalendarSrv",["$q","rvBaseWebSrvV2","RVBaseWebSrv","$filter",function(e,t,a,r){var n=this;this.availabilityData={},this.lastFetchedDate="";var o={expiryLimit:60,reponses:[]};this.fetchCalendarData=function(a){var r=e.defer(),n="/api/calendar_availability",i=_.findWhere(o.reponses,{from:a.from_date,to:a.to_date});return i&&Math.floor(Date.now()/1e3)-i.timeStamp<o.expiryLimit?r.resolve(i.response):(i||o.reponses.push({from:a.from_date,to:a.to_date}),t.getJSON(n,a).then(function(e){r.resolve(e),i=_.findWhere(o.reponses,{from:a.from_date,to:a.to_date}),i.response=e,i.timeStamp=Math.floor(Date.now()/1e3)},function(e){r.reject(e)})),r.promise},this.fetchAvailability=function(a){var r=e.defer(),o="/api/availability";return t.getJSON(o,a).then(function(e){n.lastFetchedDate=tzIndependentDate(a.to_date),"FETCH_ADDITIONAL"!==a.status&&(n.availabilityData=dclone(e),n.availabilityData.results={}),n.manipulateAvailabilityForEasyLookup(e),r.resolve(n.availabilityData)},function(e){r.reject(e)}),r.promise},this.manipulateAvailabilityForEasyLookup=function(e){angular.forEach(e.results,function(e,t){var a={};a.date=e.date,a.house=e.house,a.BAR=n.getBestAvailableRateForTheDay(e.rates,e.room_types),angular.forEach(e.room_types,function(t,r){a[t.id]=n.getLowestRateForRoomType(t,e.rates)}),n.availabilityData.results[e.date]=a})},this.getBestAvailableRateForTheDay=function(e,t){var a=null,r={},n="";angular.forEach(e,function(e,t){angular.forEach(e.room_rates,function(t,o){null===a&&(a=t.single),parseFloat(t.single)<=parseFloat(a)&&(a=t.single,r=t,n=e.id)})});var o={};return o.rate_id=n,o.room_type_availability={},angular.forEach(t,function(e,t){if(e.id===r.room_type_id)return o.room_type_availability=e,!1}),o.room_rates=r,o},this.getLowestRateForRoomType=function(e,t){var a=null,r={},n="";angular.forEach(t,function(t,o){angular.forEach(t.room_rates,function(o,i){if(o.room_type_id===e.id)return null===a&&(a=o.single),parseFloat(o.single)<=parseFloat(a)&&(a=o.single,r=o,n=t.id),!1})});var o={};return o.rate_id=n,o.room_type_availability=e,o.room_rates=r,o}}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){angular.module("sntRover").service("RVSmartBandSrv",["$q","BaseWebSrvV2",function(e,t){this.createSmartBand=function(a){var r=e.defer(),n="/api/reservations/"+a.reservationId+"/smartbands";return t.postJSON(n,a.postData).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.listSmartBands=function(a){var r=e.defer(),n="/api/reservations/"+a.reservationId+"/smartbands.json";return t.getJSON(n).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.getSmartBandDetails=function(a){var r=e.defer(),n="/api/smartbands/"+a;return t.getJSON(n).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.updateSmartBandDetails=function(a){var r=e.defer(),n="/api/smartbands/"+a.bandId;return t.putJSON(n,a.postData).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.getBalanceSmartBands=function(a){var r=e.defer(),n="api/reservations/"+a.reservationId+"/smartbands/with_balance.json";return t.getJSON(n).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.cashOutSmartBalance=function(a){var r=e.defer(),n="/api/reservations/"+a+"/smartbands/cash_out",o={};return t.postJSON(n,o).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise}}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){angular.module("sntRover").service("RVKeyPopupSrv",["$q","RVBaseWebSrv","rvBaseWebSrvV2",function(e,t,a){this.fetchKeyEmailData=function(a){var r=e.defer(),n="staff/reservations/"+a.reservationId+"/get_key_setup_popup";return t.getJSON(n).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.fetchKeyQRCodeData=function(a){var r=e.defer(),n="staff/reservations/"+a.reservationId+"/get_key_on_tablet.json";return t.getJSON(n).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.fetchKeyFromServer=function(a){var r=e.defer(),n="/staff/reservation/print_key";return t.postJSON(n,a).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.sendEmailWithPincode=function(a){var r=e.defer(),n="/staff/reservation/email_pincode";return t.postJSON(n,a).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.generatePinCode=function(t){var r=e.defer(),n="/api/reservation/"+t.interface.toLowerCase()+"/"+t.confirmation_number+"/generate";return a.postJSON(n,t).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.addNewSmartBand=function(t){var r=e.defer(),n=t.reservationId,o=["reservationId","index"],i=(dclone(t,o),"/api/reservations/"+n+"/smartbands");return a.postJSON(i,t).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.fetchActiveEncoders=function(){var t=e.defer(),r="/api/key_encoders/active";return a.getJSON(r).then(function(e){t.resolve(e)},function(e){t.reject(e)}),t.promise}}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){angular.module("sntRover").service("RVBillPaymentSrv",["$http","$q","RVBaseWebSrv","rvBaseWebSrvV2",function(e,t,a,r){}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){angular.module("sntRover").service("RVGuestCardSrv",["$http","$q","RVBaseWebSrv",function(e,t,a){this.fetchGuestPaymentData=function(e){var r=t.defer(),n="/staff/payments/payment.json?user_id="+e;return a.getJSON(n).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise}}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){angular.module("sntRover").service("RVPaymentSrv",["$http","$q","RVBaseWebSrv","rvBaseWebSrvV2","$rootScope","sntBaseWebSrv",function(e,t,a,r,n,o){var i={PAYMENT_TYPES:{}};this.renderPaymentScreen=function(e){var r=t.defer(),n="/staff/payments/addNewPayment.json",o=angular.toJson(e||"default");return i.PAYMENT_TYPES[o]?r.resolve(i.PAYMENT_TYPES[o]):a.getJSON(n,e).then(function(e){i.PAYMENT_TYPES[o]=e,r.resolve(e)},function(e){r.reject(e)}),r.promise},this.fetchAvailPayments=function(e){var r=t.defer(),n="/staff/payments/addNewPayment.json";return a.getJSON(n,e).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.savePaymentDetails=function(e){var r=t.defer(),n="staff/reservation/save_payment";return a.postJSON(n,e).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.saveGuestPaymentDetails=function(e){var r=t.defer(),n="staff/payments/save_new_payment";return a.postJSON(n,e).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.setAsPrimary=function(e){var r=t.defer(),n="/staff/payments/setCreditAsPrimary";return a.postJSON(n,e).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.deletePayment=function(e){var r=t.defer(),n="/staff/payments/deleteCreditCard";return a.postJSON(n,e).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.getPaymentList=function(e){var r=t.defer(),n="/staff/staycards/get_credit_cards.json?reservation_id="+e;return a.getJSON(n).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.getReceiptsList=function(e){var a=t.defer(),n="/api/bills/payment_receipts";return r.getJSON(n,e).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.getExistingPaymentsForBill=function(e){var r=t.defer(),n="/staff/staycards/get_credit_cards.json";return a.getJSON(n,e).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.mapPaymentToReservation=function(e){var r=t.defer(),n="/staff/reservation/link_payment";return a.postJSON(n,e).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.submitPaymentOnBill=function(e){var a=0,o=function(){a++},i=setInterval(o,1e3),s=t.defer(),c="api/reservations/"+e.reservation_id+"/submit_payment",d=function e(t){if(a>=n.emvTimeout){var o=["Request timed out. Unable to process the transaction"];s.reject(o)}else r.getJSONWithSpecialStatusHandling(t).then(function(a){a.status&&"processing_not_completed"===a.status||"null"===a?setTimeout(function(){console.info("POLLING::-> for emv terminal response"),e(t)},5e3):(clearInterval(i),s.resolve(a))},function(a){"undefined"==typeof a?e(t):(clearInterval(i),s.reject(a))})};return r.postJSONWithSpecialStatusHandling(c,e.postData).then(function(t){e.postData.is_emv_request&&t.status&&"processing_not_completed"===t.status?d(t.location_header):(clearInterval(i),s.resolve(t))},function(e){clearInterval(i),s.reject(e)}),s.promise},this.makePaymentOnDepositBalance=function(e){var r=t.defer(),n="staff/reservation/post_payment";return a.postJSON(n,e).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.chipAndPinGetToken=function(e){var a=0,o=function(){a++},i=setInterval(o,1e3),s=t.defer(),c="/api/cc/get_token.json",d=function e(t){if(a>=n.emvTimeout){var o=["Request timed out. Unable to process the transaction"];s.reject(o)}else r.getJSONWithSpecialStatusHandling(t).then(function(a){a.status&&"processing_not_completed"===a.status||"null"===a?setTimeout(function(){console.info("POLLING::-> for emv terminal response"),e(t)},5e3):(clearInterval(i),s.resolve(a))},function(a){"undefined"==typeof a?e(t):(clearInterval(i),s.reject(a))})};return r.postJSONWithSpecialStatusHandling(c,e).then(function(e){e.status&&"processing_not_completed"===e.status?d(e.location_header):(clearInterval(i),s.resolve(e))},function(e){clearInterval(i),s.reject(e)}),s.promise},this.deleteCreditCard=function(e){var a=t.defer(),r="api/reservations/"+e.reservation_id+"/delete_credit_card";return delete e.reservation_id,o.postJSON(r,e).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise}}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){function r(e,t){function a(e){return t.getJSON("/staff/preferences/likes.json",{user_id:e.userId})}function r(e){return t.postJSON("/staff/guest_cards/"+e.userId+"/update_preferences",e.data)}return{fetchLikes:a,saveLikes:r}}a.__esModule=!0,a.LikesSrv=r},{}],2:[function(e,t,a){angular.module("sntRover").service("RVLikesSrv",["$q","RVBaseWebSrv","$http",e("../../modules/snt/services/likes/rvLikesSrv").LikesSrv])},{"../../modules/snt/services/likes/rvLikesSrv":1}]},{},[2]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){angular.module("sntRover").service("RVReservationPackageSrv",["$http","$q","rvBaseWebSrvV2",function(e,t,a){this.getReservationPackages=function(e){var r=t.defer(),n="/staff/staycards/reservation_addons?reservation_id="+e;
return a.getJSON(n).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.applyAddon=function(e){var r=t.defer(),n="/api/reservations/update_package";return a.postJSON(n,e).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.deleteAddonsFromReservation=function(e){var r=t.defer(),n="api/reservations/"+e.reservationId+"/delete_addons";return a.postJSON(n,e.postData).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.updateAddonPosting=function(e){var r=t.defer(),n="/staff/staycards/update_addon_posting";return a.postJSON(n,e).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.parseAddonItem=function(e,t){var a={};return a.id=e.id,a.isBestSeller=e.bestseller,a.category=e.charge_group?e.charge_group.name:"",a.title=e.name,a.description=e.description,a.price=e.amount,a.addon_value=e.addon_value,a.rateCurrency=e.rate_currency,a.taxes=e.taxes,a.stay="",""!==e.amount_type&&(a.stay=e.amount_type.description),""!==e.post_type&&(""!==a.stay?a.stay+=" / "+e.post_type.description:a.stay=e.post_type.description),a.amountType=e.amount_type,a.postType=e.post_type,a.amountTypeDesc=e.amount_type.description,a.postTypeDesc=e.post_type.description,t&&(a.quantity=1,a.is_inclusive=e.is_inclusive),a.chargefullweeksonly=e.charge_full_weeks_only,a.is_rate_addon=e.is_rate_addon,a.is_allowance=e.is_allowance,a.is_consume_next_day=e.is_consume_next_day,a.post_day_of_the_week=e.post_day_of_the_week,a.post_day_of_the_month=e.post_day_of_the_month,a.frequency_type=e.frequency_type,a.frequency=e.frequency,a.custom_nightly_selected_post_days=e.custom_nightly_selected_post_days,a},this.parseRateAddonItem=function(e){return{id:e.id,quantity:1,title:e.name,totalAmount:e.amount,price_per_piece:e.amount,amount_type:e.amount_type,post_type:e.post_type,is_inclusive:!!e.is_inclusive,is_rate_addon:!0,rate_currency:e.rate_currency}}}])},{}]},{},[1]);var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};!function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){angular.module("sntRover").service("RVReservationCardSrv",["$http","$q","RVBaseWebSrv","rvBaseWebSrvV2","RVGAHelperSrv","$rootScope",function(e,t,a,r,n,o){this.reservationData={};var i=this;this.fetch=function(e){var r=t.defer(),n=e.reservationId,o=e.isRefresh,s=!1;if(angular.forEach(i.reservationIdsArray,function(e,t){o&&null!==o&&""!==o||e===n&&(s=!0)}),s)r.resolve(i.reservationData[n]);else{i.storeReservationIds(n);var c="api/reservations/"+n+".json";a.getJSON(c).then(function(e){i.reservationData[n]=e,r.resolve(e)},function(e){r.reject(e)})}return r.promise},this.reservationDetails={},this.confirmationNumbersArray=[],this.reservationIdsArray=[];var i=this;this.emptyConfirmationNumbers=function(){i.confirmationNumbersArray=[],i.reservationDetails={}},this.storeConfirmationNumbers=function(e){i.confirmationNumbersArray.push(e)},this.storeReservationIds=function(e){i.reservationIdsArray.push(e)},this.fetchReservationDetails=function(e){var r=e.confirmationNumber,o=e.isRefresh,s=!1,c=!0;angular.forEach(i.confirmationNumbersArray,function(e,t){o&&null!==o||e===r&&(s=!0)});var d=t.defer();if(s)d.resolve(i.reservationDetails[r]);else{i.storeConfirmationNumbers(r);var l="/staff/staycards/reservation_details.json?reservation="+r+"&is_dep_date_allowed="+c;a.getJSON(l).then(function(e){i.reservationDetails[r]=e,n.sendEventToGA("LOAD_RESERVATION",r),d.resolve(e)},function(e){d.reject(e)})}return d.promise},this.updateResrvationForConfirmationNumber=function(e,t){i.reservationDetails[e]=t},this.getResrvationForConfirmationNumber=function(e){return i.reservationDetails[e]},this.guestData="",this.setGuestData=function(e){this.guestData=e},this.getGuestData=function(){return this.guestData},this.fetchGuestcardData=function(e){var r=t.defer(),n="/staff/guestcard/show.json";return a.getJSON(n,e).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.fetchCancellationPolicies=function(e){var a=t.defer(),n="/api/reservations/"+e.id+"/cancellation_policies";return r.getJSON(n,e).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.cancelReservation=function(e){var a=t.defer(),n="/api/reservations/"+e.id+"/cancel";return r.postJSON(n,e).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.tokenize=function(e){var r=t.defer(),n="/staff/payments/tokenize";return a.postJSON(n,e).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.getLastRateAdjustmentReason=function(e){var a=t.defer(),n="api/reservations/"+e.reservation_id+"/reason_for_last_adjusted_rate";return r.getJSON(n).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.saveReservationNote=function(e){var r=t.defer(),n="/reservation_notes";return a.postJSON(n,e).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.deleteReservationNote=function(e){var r=t.defer(),n="/reservation_notes/"+e;return a.deleteJSON(n,"").then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.updateReservationNote=function(e){var a=t.defer(),n="/reservation_notes/"+e.id;return r.putJSON(n,e).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.getGuestDetails=function(e){var a=t.defer(),n="/api/guest_details/"+e.id;return null===e.id?a.reject([""]):r.getJSON(n).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.modifyRoomQueueStatus=function(e){var a=t.defer(),n={status:e.status};e.viaAdvancedQueue&&(n.signature=e.signature,n.is_promotions_and_email_set=e.is_promotions_and_email_set);var o="/api/reservations/"+e.reservationId+"/queue";return r.postJSON(o,n).then(function(t){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.fetchDepositDetails=function(e){var a=t.defer(),n="api/reservations/"+e+"/deposit_policy";return r.getJSON(n).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.sendConfirmationEmail=function(e){var a=t.defer(),n="/api/reservations/"+e.reservationId+"/email_confirmation";return r.postJSON(n,e.postData).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.validateStayDateChange=function(e){var a=t.defer(),n="/staff/change_stay_dates/validate_stay_dates_change";return r.postJSON(n,e).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.detachGroupReservation=function(e){var a=t.defer(),n="/api/group_reservations/"+e.id+"/detach_group_reservation";return r.postJSON(n,e).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.reinstateReservation=function(e){var a=t.defer(),n="/api/reservations/"+e.reservationId+"/reinstate";return r.postJSON(n,e).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.checkReinstationAvailbility=function(e){var a=t.defer(),n="/api/reservations/"+e+"/check_reinstate_availability";return r.getJSON(n).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.checkGiftCardBalance=function(e){var a={card_number:e.card_number},n=t.defer(),o="/api/gift_cards/balance_inquiry";return r.postJSON(o,a).then(function(e){e&&_typeof(e.amount)===_typeof(123)&&(e.amount=parseFloat(e.amount).toFixed(2)),n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchGuestIdentity=function(e){var a=t.defer(),n="/api/guest_identity/"+e.reservation_id;return r.getJSON(n,e).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.reverseCheckIn=function(e){var a=t.defer(),n="/api/reservations/"+e.reservationId+"/reverse_check_in";return r.postJSON(n).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.attachGuestToReservation=function(e){var a=t.defer(),n="/api/reservations/"+e.reservation_id+"/reservations_guest_details/attach_guest_details";return delete e.reservation_id,r.postJSON(n,e).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.getConfirmationData=function(e){var a=t.defer(),n="/api/reservations/"+e.reservation_id+"/confirmation_data";return r.getJSON(n).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.createActivityLog=function(e){var a=t.defer();return r.postJSON("/api/reservation_actions",e).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise}}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){angular.module("sntRover").service("RVContactInfoSrv",["$q","RVBaseWebSrv","rvBaseWebSrvV2",function(e,t,a){var r=this;r.saveContactInfo=function(a){var r=e.defer(),n=a.data,o=a.userId,i="/staff/guest_cards/"+o;return t.putJSON(i,n).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},r.createGuest=function(t){var r=e.defer(),n=t.data,o="/api/guest_details";return a.postJSON(o,n).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},r.updateGuest=function(t){var r=e.defer(),n="/api/guest_details/"+t.userId;return t.check_validation_only&&(n+="?check_validation_only=true"),a.putJSON(n,t.data).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},r.fetchGuestLanguages=function(t){var r=e.defer(),n="/api/guest_languages";return a.getJSON(n,t).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},r.removeGuestDetails=function(t){var r=e.defer(),n="/api/guest_details/"+t+"/anonymize";return a.putJSON(n).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},r.getGuestDetailsById=function(t){var r=e.defer(),n="/api/guest_details/"+t;return null===t?r.reject([""]):a.getJSON(n).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},r.parseGuestData=function(e,t){var a={};return a.id=t,a.firstName=e.first_name,a.lastName=e.last_name,a.image=e.image_url,a.vip=e.vip,e.address&&(a.address={},a.address.city=e.address.city,a.address.state=e.address.state,a.address.postalCode=e.address.postal_code),a.stayCount=e.stay_count,a.lastStay={},a.phone=e.home_phone,a.email=e.email,e.last_stay&&(a.lastStay.date=e.last_stay.date,a.lastStay.room=e.last_stay.room,a.lastStay.roomType=e.last_stay.room_type),a},r.deleteGuest=function(t){var r=e.defer(),n="/api/guest_details/"+t;return a.deleteJSON(n).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},r.checkIfCommisionWasRecalculated=function(t){var r=e.defer(),n="/api/reservations/"+t.reservation_id+"/commission_transaction_info";return a.getJSON(n).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise}}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){angular.module("sntRover").service("RVGuestCardLoyaltySrv",["$q","RVBaseWebSrv","RVCompanyCardSrv",function(e,t,a){var r=this,n={};r.fetchUserMemberships=function(a){var r=e.defer(),n="/staff/user_memberships.json?user_id="+a;return t.getJSON(n).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},r.fetchLoyalties=function(t){var o=e.defer(),i=[];return i.push(a.fetchHotelLoyaltiesHlps().then(function(e){n.hotelLoyaltyData=e.data})),i.push(a.fetchHotelLoyaltiesFfp().then(function(e){n.freaquentLoyaltyData=e.data})),t.userID&&i.push(r.fetchUserMemberships(t.userID).then(function(e){n.userMemberships=e})),e.all(i).then(function(){o.resolve(n)},function(e){o.reject(e)}),o.promise},r.createLoyalties=function(a){var r=e.defer(),n="/staff/user_memberships";return t.postJSON(n,a).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},r.deleteLoyalty=function(a){var r=e.defer(),n="/staff/user_memberships/"+a+".json";return t.deleteJSON(n,"").then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise}}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){angular.module("sntRover").service("RVSaveWakeupTimeSrv",["$q","RVBaseWebSrv",function(e,t){this.saveWakeupTime=function(a){var r=e.defer(),n="/wakeup/set_wakeup_calls";return t.postJSON(n,a).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.getWakeupTimeDetails=function(a){var r=e.defer(),n="/wakeup/wakeup_calls";return t.postJSON(n,a).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise}}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){angular.module("sntRover").service("RVNewsPaperPreferenceSrv",["$q","RVBaseWebSrv",function(e,t){this.saveNewspaperPreference=function(a){var r=e.defer(),n="/reservation/add_newspaper_preference";return t.postJSON(n,a).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise}}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){angular.module("sntRover").service("RVLoyaltyProgramSrv",["$q","RVBaseWebSrv","BaseWebSrvV2",function(e,t,a){var r={ZDIRECT_SETTINGS:null};this.addLoyaltyProgram=function(a){var r=e.defer(),n="/staff/user_memberships";return t.postJSON(n,a).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.getGMSSettings=function(){var t=e.defer(),n="/api/integrations/gms_settings";return r.ZDIRECT_SETTINGS?t.resolve(r.ZDIRECT_SETTINGS):a.getJSON(n).then(function(e){r.ZDIRECT_SETTINGS=e,t.resolve(e)},function(e){t.reject(e)}),t.promise},this.getLoyaltyDetails=function(a){var r=e.defer(),n="/staff/user_memberships/new_loyalty";return t.getJSON(n,a).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.getAvailableFFPS=function(){var a=e.defer(),r=" /staff/user_memberships/get_available_ffps.json";return t.getJSON(r,"").then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.getAvailableHLPS=function(){var a=e.defer(),r="/staff/user_memberships/get_available_hlps.json";return t.getJSON(r,"").then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.selectLoyalty=function(a){var r=e.defer(),n="/staff/user_memberships/link_to_reservation";return t.postJSON(n,a).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise}}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){angular.module("sntRover").service("RVBillCardSrv",["$http","$q","BaseWebSrvV2","RVBaseWebSrv","rvBaseWebSrvV2","sntBaseWebSrv","RVGAHelperSrv",function(e,t,a,r,n,o,i){var s=this;this.fetchReservationBillData=function(e){var a=t.defer(),r="/api/reservations/"+e+"/bills_summary";return n.getJSON(r).then(function(e){a.resolve(e.data)},function(e){a.reject(e)}),a.promise},this.fetchAllowanceData=function(e,t,a){var r="/api/bills/"+t+"/allowance_transactions";return n.getJSON(r).then(function(t){t.allowance_data&&t.allowance_data.allowance_entries&&t.allowance_data.allowance_entries.length&&(_.each(t.allowance_data.allowance_entries,function(e,a){e.entriesForTheDate=_.filter(t.allowance_data.allowance_entries,function(t){return t.date===e.date}),e.amount=e.amount?parseFloat(e.amount):e.amount}),a.allowance_data=t.allowance_data),e.resolve(a)},function(t){e.reject(t)}),e.promise},this.fetchReservationAllowanceTransactions=function(e){var t="/api/reservations/"+e+"/allowance_transactions";return n.getJSON(t).then(function(e){var t={dataByAllowance:[],dataByDate:[]};return e.allowance_data&&e.allowance_data.allowance_entries&&e.allowance_data.allowance_entries.length&&(t.dataByAllowance=_.groupBy(e.allowance_data.allowance_entries,function(e){return e.addon_id}),t.dataByDate=_.groupBy(e.allowance_data.allowance_entries,function(e){return e.date})),t.amount=e.allowance_data.amount,t},function(){})},this.searchAllowanceShares=function(e){var a=t.defer(),r="/api/reservations/"+e.reservationId+"/search_reservations_for_allowance_share";return n.getJSON(r,{query:e.query}).then(function(e){a.resolve(e.data)},function(e){a.reject(e)}),a.promise},this.saveAllowanceShares=function(e){var r=t.defer(),n="/api/reservations/"+e.reservationId+"/route_allowance";return a.postJSON(n,e.data).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.fetchBillData=function(e){var a=t.defer(),r="/api/bills/"+e;return n.getJSON(r).then(function(e){a.resolve(e.data)},function(e){a.reject(e)}),a.promise},this.fetch=function(e){var a="",r=t.defer(),n="",o="";return t.when().then(function(){return s.fetchReservationBillData(e).then(function(e){a=e})}).then(function(){return n=a.bills[0].bill_id,o=parseInt(a.bills[0].bill_number)-1,s.fetchBillData(n).then(function(e){a.bills[o]=e})}).then(function(){a.groupedAllowances={},r.resolve(a)},function(e){r.reject(e)}),r.promise},this.fetchBillPrintData=function(e){var a=t.defer(),n="staff/bills/print_guest_bill";return r.postJSON(n,e).then(function(e){e.charge_details_list=[],angular.forEach(e.fee_details,function(t,a){angular.forEach(t.charge_details,function(a){a.date=t.date,a.isCredit=!1,e.charge_details_list.push(a)}),angular.forEach(t.credit_details,function(a){a.date=t.date,a.isCredit=!0,e.charge_details_list.push(a)})}),a.resolve(e)},function(e){a.reject(e)}),a.promise},this.fetchRegistrationCardPrintData=function(e){var a=t.defer(),r="/api/registration_cards/"+e.reservation_id;return n.getJSON(r,e).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.movetToAnotherBill=function(e){var r=t.defer(),n="/staff/bills/transfer_transaction";return a.postJSON(n,e).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.setBillAddressType=function(e){var r=t.defer(),n="/api/bills/"+e.bill_id+"/save_address_type";return a.postJSON(n,e.parmasToApi).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.completeCheckin=function(e){var a=t.defer(),n="/staff/checkin";return r.postJSON(n,e).then(function(t){i.sendEventToGA("CHECKIN",e.reservation_id),a.resolve(t)},function(e){a.reject(e)}),a.promise},this.completeCheckout=function(e){var a=t.defer(),n="/staff/checkout";return r.postJSON(n,e).then(function(t){i.sendEventToGA("CHECKOUT",e.reservation_id),a.resolve(t)},function(e){a.reject(e)}),a.promise},this.getAdvanceBill=function(e){var a=t.defer(),n="api/reservations/"+e.id+"/advance_bill";return r.postJSON(n).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.transactionEdit=function(e){var r=t.defer(),n="api/financial_transactions/"+e.id;return a.putJSON(n,e.updatedData).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.transactionEditChargeDescription=function(e){var r=t.defer(),n="api/financial_transactions/"+e.id+"/save_custom_description";return a.postJSON(n,e.postData).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.transactionDelete=function(e){var r=t.defer(),n=e.id,o="api/financial_transactions/"+n;return a.putJSON(o,e.data).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.transactionSplit=function(e){var r=t.defer(),n=e.id,o="api/financial_transactions/"+n;return a.putJSON(o,e.data).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.fetchChargeCodes=function(){var e=t.defer(),r="/api/charge_codes?exclude_payments=true&per_page=1000";return a.getJSON(r).then(function(t){e.resolve(t)},function(t){e.reject(t)}),e.promise},this.fetchAdjustmentReasons=function(){var e=t.defer(),r="/admin/force_adjustment_reasons";return a.getJSON(r).then(function(t){e.resolve(t)},function(t){e.reject(t)}),e.promise},this.sendEmail=function(e){var r=t.defer(),n="api/reservations/email_guest_bill.json";return a.postJSON(n,e).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.createAnotherBill=function(e){var r=t.defer(),n="/api/bills/create_bill";return a.postJSON(n,e).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.changeHousekeepingStatus=function(e){var r=t.defer(),n="/house/change_house_keeping_status.json";return a.postJSON(n,e).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.completeReverseCheckout=function(e){var r=t.defer(),n="/staff/reverse_checkout";return a.postJSON(n,e).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.toggleHideRate=function(e){var r=t.defer(),n="api/reservations/"+e.reservation_id+"/hide_rates";return a.postJSON(n,e).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.getBillSettingsInfo=function(e){var r=t.defer(),n="/api/bills/get_settings_info";return a.getJSON(n,e).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.groupChargeDetailsFetch=function(e){var r=t.defer(),n="/staff/reservation/transaction_details";return a.getJSON(n,e).then(function(e){r.resolve(e.data)},function(e){r.reject(e)}),r.promise},this.hideBill=function(e){var r=t.defer(),n="/api/bills/"+e.bill_id+"/hide_bill";return a.postJSON(n).then(function(e){r.resolve(e.data)},function(e){r.reject(e)}),r.promise},this.fetchGuestLanguages=function(e){var a=t.defer(),r="/api/guest_languages";return n.getJSON(r,e).then(function(e){e.languages&&(e.languages=_.filter(e.languages,{is_show_on_guest_card:!0})),a.resolve(e)},function(e){a.reject(e)}),a.promise},this.callBlackBoxApi=function(e){var r=t.defer(),n="/api/hotel_settings/infrasec/generate_control_code";return a.postJSON(n,e).then(function(e){r.resolve(e.data)},function(e){r.reject(e)}),r.promise},this.generateFolioNumber=function(e){var r=t.defer(),n="/api/bills/"+e.bill_id+"/generate_folio_number";return a.postJSON(n,e).then(function(e){r.resolve(e.data)},function(e){r.reject(e)}),r.promise},this.generateVoidBill=function(e){var r=t.defer(),n="/api/bills/"+e.bill_id+"/void_bill";return a.postJSON(n,e.data).then(function(e){r.resolve(e.data)},function(e){r.reject(e)}),r.promise},this.settleFinalInvoice=function(e){var r=t.defer(),n="/api/bills/"+e.bill_id+"/final_invoice_settlement";return a.postJSON(n,e).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.printReceiptData=function(e){var a=t.defer(),r="/api/bills/"+e.bill_id+"/print_payment_receipt";return o.postJSON(r,e).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.emailReceiptData=function(e){var a=t.defer(),r="/api/bills/"+e.bill_id+"/email_payment_receipt";return o.postJSON(r,e).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise}}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){angular.module("sntRover").service("rvGuestCardNotesSrv",["$q","rvBaseWebSrvV2",function(e,t){this.fetchNotesForGuest=function(a){var r="/api/guest_details/"+a.guestID+"/notes",n=e.defer();return t.getJSON(r).then(function(e){n.resolve(e.notes)},function(e){n.reject(e)}),n.promise},this.updateNoteFromGuestCard=function(a){var r="/api/guest_details/"+a.guestID+"/notes/"+a.noteID,n=e.defer(),o={text:a.text};return t.putJSON(r,o).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.deleteNoteFromGuestCard=function(a){var r="/api/guest_details/"+a.guestID+"/notes/"+a.noteID,n=e.defer();return t.deleteJSON(r).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.createNoteFromGuestCard=function(a){var r={text:a.text},n="/api/guest_details/"+a.guestID+"/notes",o=e.defer();return t.postJSON(n,r).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise}}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){angular.module("sntRover").service("RVGuestCardActivityLogSrv",["$q","rvBaseWebSrvV2",function(e,t){this.fetchActivityLog=function(a){var r=e.defer(),n="/api/guest_card_actions";return t.getJSON(n,a).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise}}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){angular.module("sntRover").service("RVGuestCardsSrv",["$q","rvBaseWebSrvV2","sntBaseWebSrv","$rootScope","$log","$http",function(e,t,a,r,n,o){var i,s={},c=this,d={id:null,isFetched:!1};c.setGuest=function(e){c.resetGuest(),d.id=parseInt(e,10)},c.isGuestFetchComplete=function(e){return e=parseInt(e,10),d.id===e&&d.isFetched},c.resetGuest=function(){d.id=null,d.isFetched=!1},this.PER_PAGE_COUNT=50,c.fetchGuestDetails=function(t){var o=e.defer(),i="/api/guest_details/"+t;return r.isStandAlone||(i+="?sync_with_external_pms=true"),d.id?a.getJSON(i).then(function(e){d.isFetched=!0,o.resolve(e)},function(e){o.reject(e)}):(n.debug("Guest not set!"),o.reject(["Guest not set"])),o.promise},c.fetchGuestAdminSettings=function(){var t=e.defer(),r="/admin/guest_card_settings/current_settings";return a.getJSON(r).then(function(e){t.resolve(e)},function(e){t.reject(e)}),t.promise},this.fetchGuestAdminSettingsAndGender=function(t){var a=e.defer(),r={},n=[];return n.push(e.when().then(function(){return c.fetchGuestAdminSettings(t).then(function(e){r.guest_admin_settings=e})})),n.push(e.when().then(function(){return c.fetchGenderTypes().then(function(e){r.genderTypeList=e})})),n.push(e.when().then(function(){return c.fetchIdTypes().then(function(e){r.idTypeList=e})})),e.all(n).then(function(){a.resolve(r)},function(e){a.reject(e)}),a.promise},this.fetchGuestDetailsInformation=function(t){var a=e.defer(),r={},n=[];return n.push(c.fetchGuestDetails(t)),n.push(c.fetchGuestAdminSettingsAndGender()),e.all(n).then(function(e){r=e[0],r.guest_admin_settings=e[1].guest_admin_settings,r.genderTypeList=e[1].genderTypes,a.resolve(r)},function(e){a.reject(e)}),a.promise},this.fetchGuests=function(t){var r=e.defer(),n="/api/guest_details";return a.getJSON(n,t).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.setGuestFields=function(){return s},this.setGuestFields=function(){return s},this.fetchGuestCardStatisticsSummary=function(a){var r=e.defer(),n="/api/guest_details/"+a.guestId+"/statistics?view=SUMMARY";return delete a.guestId,t.getJSON(n,a).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.fetchGuestCardStatisticsDetails=function(a){var r=e.defer(),n="/api/guest_details/"+a.guestId+"/statistics?view=DETAILED";return delete a.guestId,t.getJSON(n,a).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise};var l=[];this.fetchNationsList=function(){var a=e.defer(),r="/ui/country_list";return l.length?a.resolve(l):t.getJSON(r).then(function(e){l=e,a.resolve(e)},function(e){a.reject(e)}),a.promise},this.saveGuestIdDetails=function(e){var a="/api/guest_identity";return t.postJSON(a,e)},this.saveFaceImage=function(e){var a="/staff/guest_cards/"+e.guest_id+".json";return t.putJSON(a,e)},this.verifyGuestCardMerge=function(a){var r=e.defer(),n="/api/guest_details/validate_card_merge";return t.postJSON(n,a).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.mergeCards=function(a){var r=e.defer(),n="/api/guest_details/merge_cards";return t.postJSON(n,a).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.fetchGenderTypes=function(){var t=e.defer(),r="api/guest_details/gender_types";return a.getJSON(r).then(function(e){t.resolve(e.gender_list)},function(e){t.resolve(e)}),t.promise},this.fetchIdTypes=function(){var t=e.defer(),r="api/guest_details/government_id_types";return i?t.resolve(i):a.getJSON(r).then(function(e){i=e.id_type_list,t.resolve(i)},function(e){t.resolve(e)}),t.promise},this.fetchGuestList=function(a){var r="/api/guest_details",n=e.defer(),i={method:"GET",url:r,params:a};return o(i).then(function(e){var t={data:e.data,params:e.config&&e.config.params};n.resolve(t)},function(e){t.webserviceErrorActions(r,n,e.data,e.status)}),n.promise}}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){angular.module("sntRover").service("RVCCAuthorizationSrv",["$http","$q","RVBaseWebSrv","rvBaseWebSrvV2","$rootScope","$log","$timeout","$interval",function(e,t,a,r,n,o,i,s){
var c,d=this,l=0,u=3e3,m=!1,f=function(){l++},p=function t(a,r){if(l>=parseInt(n.emvTimeout,10)){var d=["Request timed out. Unable to process the transaction"];s.cancel(c),a.reject(d)}else e.get(r).then(function(e){var n=e.data,d=e.status;202===d||102===d||250===d?i(function(){o.info("POLLING::-> for emv terminal response"),t(a,r)},u):(s.cancel(c),a.resolve(n))},function(e){e.data?(s.cancel(c),a.reject(e.data)):i(function(){t(a,r)},2e3)})};this.fetchCreditCardAuthInfo=function(e){var a=t.defer(),n="/staff/reservation/"+e.reservation_id+"/credit_card_auth_info";return r.getJSON(n).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},d.manualAuthorization=function(e,a){var n,a=a||t.defer(),i="/api/cc/authorize";return m&&o.warn("Authorization attempted when previous call pending!"),m=!0,e.isShift4Request&&(n=!0,delete e.isShift4Request),r.postJSONWithSpecialStatusHandling(i,e).then(function(e){"processing_not_completed"===e.status&&e.location_header?(l=0,c=s(f,1e3),p(a,e.location_header)):(m=!1,a.resolve(e))},function(t){m=!1,n?(e.check_transaction=!0,d.manualAuthorization(e,a)):a.reject(t)}),a.promise},d.manualVoiceAuth=function(e){var a=t.defer(),n="/api/cc/voice_auth";return r.postJSON(n,e).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.releaseAuthorization=function(e){var a=t.defer(),n="/api/cc/reverse";return r.postJSON(n,e).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},d.fetchPendingAuthorizations=function(e){var a=t.defer(),n="/api/reservations/"+e+"/pre_auth";return r.getJSON(n).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise}}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){angular.module("sntRover").service("RVNightlyDiaryRightFilterBarSrv",["$q","sntBaseWebSrv",function(e,t){var a=this;a.fetchRoomType=function(a){var r=e.defer(),n="/api/room_types.json?exclude_pseudo=true&exclude_suite=true";return t.getJSON(n,a).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},a.fetchFloorList=function(a){var r=e.defer(),n="/api/floors.json";return t.getJSON(n,a).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},a.getPreferences=function(){var a=e.defer(),r="/staff/preferences/room_assignment.json";return t.getJSON(r).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},a.fetchFilterList=function(t){var r=e.defer(),n=[],o={};return n.push(a.fetchFloorList(t).then(function(e){o.floors=e.floors})),n.push(a.fetchRoomType(t).then(function(e){o.rooms=e.results})),n.push(a.getPreferences().then(function(e){o.roomFeatures=e.data.room_features})),e.all(n).then(function(){r.resolve(o)}),r.promise}}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){angular.module("sntRover").service("RVNightlyDiaryRoomNumberSearchSrv",["$q","BaseWebSrvV2",function(e,t){this.fetchRoomSearchResults=function(a){var r=e.defer(),n="/api/nightly_diary/search_room";return t.getJSON(n,a).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise}}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){angular.module("sntRover").service("RVNightlyDiarySearchSrv",["$q","BaseWebSrvV2",function(e,t){var a=this;a.searchPerPage=50,a.page=1,a.fetchSearchResults=function(r){var n=e.defer(),o="search.json?per_page="+a.searchPerPage+"&page="+a.page+"&is_from_nightly_diary=true";return r.fakeDataToAvoidCache=new Date,t.getJSON(o,r).then(function(e){n.resolve(e.data)},function(e){n.reject(e)}),n.promise}}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){angular.module("sntRover").service("RVNightlyDiarySrv",["$q","sntBaseWebSrv","$rootScope",function(e,t,a){var r=this;this.updateCache=function(e){r.searchParamsCached=e},this.getCache=function(){return r.searchParamsCached},this.fetchRoomsList=function(a){var r=e.defer(),n="/api/nightly_diary/room_list";return t.postJSON(n,a).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.fetchDatesList=function(a){var r=e.defer(),n=[],o="/api/nightly_diary/date_list",i={},s={};return i.start_date=a.start_date,i.no_of_days=a.no_of_days,t.getJSON(o,i).then(function(e){angular.forEach(e.dates,function(e){var t=tzIndependentDate(e),a=0===t.getDay()||6===t.getDay(),r={date:e,isWeekend:a};n.push(r)}),s={dates:n,hotelCheckinTime:e.hotel_checkin_time,hotelCheckoutTime:e.hotel_checkout_time},r.resolve(s)},function(e){r.reject(e)}),r.promise},this.fetchReservationsList=function(a){r.updateCache(a);var n=e.defer(),o="/api/nightly_diary/reservation_list",i={};return i.start_date=a.start_date,i.no_of_days=a.no_of_days,i.page=a.page,i.per_page=a.per_page,i.selected_room_type_ids=a.selected_room_type_ids,i.selected_floor_ids=a.selected_floor_ids,i.selected_room_feature_ids=a.selected_room_feature_ids,t.postJSON(o,i).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.checkUpdateAvaibale=function(a){var r="/staff/change_stay_dates/"+a.reservation_id+"/update.json",n={arrival_date:a.arrival_date,dep_date:a.dep_date},o=e.defer();return t.getJSON(r,n).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.validateStayChanges=function(a){var r="/api/nightly_diary/validate_stay_change",n=e.defer();return t.getJSON(r,a).then(function(e){n.resolve(e.result)},function(e){n.reject(e)}),n.promise},this.confirmUpdates=function(a){var r="/staff/change_stay_dates/"+a.reservation_id+"/confirm",n={arrival_date:a.arrival_date,dep_date:a.dep_date,room_number:a.room_number,authorize_credit_card:a.authorize_credit_card,is_from_diary:!0},o=e.defer();return t.postJSON(r,n).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.fetchRoomsListAndReservationList=function(t){var a=e.defer(),n={roomList:null,reservationList:null,dateList:null};return e.when().then(function(){return r.fetchRoomsList(t).then(function(e){n.roomList=e})}).then(function(){return t.page=n.roomList.page_number,r.fetchReservationsList(t).then(function(e){n.reservationList=e})}).then(function(){return r.fetchDatesList(t).then(function(e){n.dateList=e})}).then(function(){a.resolve(n)},function(e){a.reject(e)}),a.promise},this.fetchUnassignedReservationList=function(r){var n=e.defer(),o="/api/nightly_diary/unassigned_reservations",i=a.businessDate;return t.getJSON(o,r).then(function(e){angular.forEach(e.reservations,function(e){e.statusClass=e.arrival_date===i?"check-in":"no-status",e.fullName=e.last_name+" "+e.first_name}),n.resolve(e)},function(e){n.reject(e)}),n.promise},this.retrieveAvailableRooms=function(a){var r=e.defer(),n="/api/nightly_diary/retrieve_available_rooms";return t.postJSON(n,a).then(function(e){r.resolve(e.data)},function(e){r.reject(e)}),r.promise},this.retrieveAvailableFreeSlots=function(a){var r=e.defer(),n="/api/nightly_diary/availability";return t.postJSON(n,a).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.assignRoom=function(a){var r=e.defer(),n="/staff/reservation/modify_reservation";return t.postJSON(n,a).then(function(e){r.resolve(e.data)},function(e){r.reject(e)}),r.promise},this.fetchAvailableTimeSlots=function(a){var r=e.defer(),n="/api/nightly_diary/available_time_slots";return t.postJSON(n,a).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.unAssignRoom=function(a){var r=e.defer(),n="/api/reservations/"+a.id+"/unassign_room";return t.postJSON(n,a).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.getPreferences=function(a){var r=e.defer(),n="/staff/preferences/room_assignment.json";return t.getJSON(n,a).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.updateBillingInformation=function(a){var r=e.defer(),n="api/bill_routings/update_dates";return t.postJSON(n,a).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.initiateAutoAssignRooms=function(e){var a="api/auto_room_assign_processes/auto_room_assignment";return t.postJSON(a,e)},this.fetchAutoAssignStatus=function(){var e="api/auto_room_assign_processes/status";return t.getJSON(e)},this.unlockRoomDiary=function(){var e="api/auto_room_assign_processes/unlock_diary";return t.postJSON(e)}}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){angular.module("sntRover").service("RVRoomAssignmentSrv",["$q","RVBaseWebSrv","rvBaseWebSrvV2",function(e,t,a){var r=this;this.cachedRoomsResponse={},this.getRooms=function(a){var r=e.defer(),n="/staff/rooms/get_rooms";return t.postJSON(n,a).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.getPreferences=function(a){var r=e.defer(),n="/staff/preferences/room_assignment.json";return t.getJSON(n,a).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.assignRoom=function(a){var r=e.defer(),n="/staff/reservation/modify_reservation";return t.postJSON(n,a).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.UnAssignRoom=function(t){var r=e.defer(),n=t.reservationId,o="api/reservations/"+n+"/unassign_room";return a.postJSON(o).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.moveInHouseRooms=function(t){var r=e.defer(),n="/staff/reservation/room_inhouse_move";return a.getJSON(n,t).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.getPaginatedResult=function(e,t,a){var r=(t-1)*a,n=r+a,o=JSON.parse(JSON.stringify(e));return o.rooms=_.isEmpty(o.rooms)?o.rooms:o.rooms.slice(r,n),o},this.searchRooms=function(a){var n=e.defer(),o="api/rooms/search";return 1===a.page_no?t.postJSON(o,a).then(function(e){r.cachedRoomsResponse=JSON.parse(JSON.stringify(e)),n.resolve(r.getPaginatedResult(e,a.page_no,a.per_page))},function(e){r.cachedRoomsResponse={},n.reject(e)}):n.resolve(r.getPaginatedResult(r.cachedRoomsResponse,a.page_no,a.per_page)),n.promise},this.getRoomsByRoomType=function(a){var n=e.defer(),o="/api/rooms/retrieve_available_rooms";return 1===a.page_no?t.postJSON(o,a).then(function(e){r.cachedRoomsResponse=JSON.parse(JSON.stringify(e)),n.resolve(r.getPaginatedResult(e,a.page_no,a.per_page))},function(e){r.cachedRoomsResponse={},n.reject(e)}):n.resolve(r.getPaginatedResult(r.cachedRoomsResponse,a.page_no,a.per_page)),n.promise}}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){angular.module("sntRover").service("RVUpgradesSrv",["$q","RVBaseWebSrv",function(e,t){this.getAllUpgrades=function(a){var r=e.defer(),n="/staff/reservations/upgrade_room_type_upsell_options.json";return t.getJSON(n,a).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.selectUpgrade=function(a){var r=e.defer(),n="/staff/reservations/upgrade_room.json";return t.postJSON(n,a).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise}}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){angular.module("sntIDCollection",[]),angular.module("sntIDCollection").directive("ngUploadChange",function(){return{scope:{ngUploadChange:"&"},link:function(e,t){t.on("change",function(t){e.$apply(function(){e.ngUploadChange({$event:t})})}),e.$on("$destroy",function(){t.off()})}}})},{}]},{},[1]);var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};!function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){angular.module("sntIDCollection").service("sntIDCollectionSrv",["$q","$filter","acuantCredentials","sntIDCollectionUtilsSrv",function(e,t,a,r){function n(e,t){var a=new XMLHttpRequest;return"withCredentials"in a?a.open(e,t,!0):"undefined"!=typeof XDomainRequest?(a=new XDomainRequest,a.open(e,t)):a=null,a&&(a.timeout=6e4),a}var o=this,i=["Error: The subscription ID provided does not match any active subscription."],s=["Operation timed out !"],a=a;a.LicenseKey=btoa(a.LicenseKey);var c=window.location;this.isInDevEnv=!0,c.hostname&&_typeof(c.hostname)===_typeof("str")&&c.hostname.indexOf("pms.stayntouch.com")!==-1&&(o.isInDevEnv=!1),this.setAcuantCredentialsForProduction=function(e){a=e,a&&a.licenseKey&&(a.LicenseKey=btoa(a.licenseKey))};var d=function(e,t){var r=n(e,t);return r.setRequestHeader("Authorization","Basic "+btoa(a.username+":"+a.password)),r.setRequestHeader("Accept","application/json"),r};this.isValidSubsription=!1,this.instanceID,this.validateCredentials=function(){var r=e.defer();if(a.username&&a.password&&a.assureIDConnectEndpoint&&a.subscriptionID){var n=function(e){if(e.length>0){var n=!1,s=t("filter")(e,{Id:a.subscriptionID})[0];n=!!s&&s.IsActive,n?(o.isValidSubsription=!0,r.resolve({})):r.reject(i)}else r.reject(i)},c=a.assureIDConnectEndpoint+"/AssureIDService/Subscriptions",l=d("GET",c);l.send(),l.onload=function(){if(200===l.status){var e=JSON.parse(l.responseText);n(e)}else r.reject(i)},l.onerror=function(){r.reject(i)},l.ontimeout=function(){r.reject(s)}}else r.reject(i);return r.promise},this.getDocInstance=function(){var t=e.defer(),r=a.assureIDConnectEndpoint+"/AssureIDService/Document/Instance",i=n("POST",r);return i.setRequestHeader("Authorization","Basic "+btoa(a.username+":"+a.password)),i.setRequestHeader("Content-Type","application/json"),i.setRequestHeader("Accept","application/json"),i.send(JSON.stringify({AuthenticationSensitivity:0,ClassificationMode:0,Device:{HasContactlessChipReader:!1,HasMagneticStripeReader:!1,SerialNumber:"xxx",Type:{Manufacturer:"xxx",Model:"xxx",SensorType:3}},ImageCroppingExpectedSize:0,ImageCroppingMode:1,ManualDocumentType:null,ProcessMode:0,SubscriptionId:a.subscriptionID})),i.onload=function(){if(201===i.status){var e=JSON.parse(i.responseText);o.instanceID=e,t.resolve(e)}else t.reject(["Document instance failed"])},i.onerror=function(){t.reject(["Document instance failed"])},i.ontimeout=function(){t.reject(s)},t.promise},this.postFrontImage=function(t){var r=e.defer(),i=a.assureIDConnectEndpoint+"AssureIDService/Document/"+o.instanceID+"/Image?side=0&light=0&metrics=true",c=n("POST",i);return c.setRequestHeader("Authorization","Basic "+btoa(a.username+":"+a.password)),c.setRequestHeader("Content-Type","image/*"),c.setRequestHeader("Accept","application/json"),c.send(t),c.onload=function(e){201===c.status?r.resolve({}):r.reject(["Document front image posting failed (Response status: "+c.status+")"])},c.onerror=function(){r.reject(["Document front image posting failed"])},c.ontimeout=function(){r.reject(s)},r.promise},this.postBackImage=function(t){var r=e.defer(),i=a.assureIDConnectEndpoint+"/AssureIDService/Document/"+o.instanceID+"/Image?side=1&light=0",c=n("POST",i);return c.setRequestHeader("Authorization","Basic "+btoa(a.username+":"+a.password)),c.setRequestHeader("Content-Type","image/*"),c.setRequestHeader("Accept","application/json"),c.send(t),c.onload=function(){201===c.status?r.resolve({}):r.reject(["Document back side image posting failed (Response status: "+c.status+")"])},c.onerror=function(){r.reject(["Document back side image posting failed"])},c.ontimeout=function(){r.reject(s)},r.promise},this.getImage=function(t){var n=e.defer(),i=a.assureIDConnectEndpoint+"AssureIDService/Document/"+o.instanceID+"/Image?side="+t+"&light=0",c=d("GET",i);return c.responseType="arraybuffer",c.send(),c.onload=function(){if(200===c.status){r.base64ArrayBuffer(c.response);n.resolve(c.response)}else n.reject(["Document getImage failed"])},c.onerror=function(){n.reject(["Document getImage failed"])},c.ontimeout=function(){n.reject(s)},n.promise},this.getImageQualityMetric=function(t){var r=e.defer(),n=a.assureIDConnectEndpoint+"AssureIDService/Document/"+o.instanceID+"/Image/Metrics?side="+t+"&light=0",i=d("GET",n);return i.send(),i.onload=function(){if(200===i.status){var e=JSON.parse(i.responseText);r.resolve(e)}else r.reject(["Document getImageQualityMetric failed"])},i.onerror=function(){r.reject(["Document getImageQualityMetric failed"])},i.ontimeout=function(){r.reject(s)},r.promise},this.getClassification=function(){var t=e.defer(),r=a.assureIDConnectEndpoint+"AssureIDService/Document/"+o.instanceID+"/Classification",n=d("GET",r);return n.send(),n.onload=function(){if(200===n.status){var e=JSON.parse(n.responseText);t.resolve(e)}else t.reject(["Document getClassification failed"])},n.onerror=function(){t.reject(["Document getClassification failed"])},n.ontimeout=function(){t.reject(s)},t.promise},this.getImageDetails=function(t){var a=e.defer(),r={},n=[],i=function(e){r.image=e},s=function(e){r.quality_metrics=e},c=function(e){r.image_classification=e},d=function(e){a.reject(e)};return n.push(o.getImage(t).then(i,d)),n.push(o.getImageQualityMetric(t).then(s,d)),n.push(o.getClassification(t).then(c,d)),e.all(n).then(function(){a.resolve(r)}),a.promise},this.getResults=function(){var t=e.defer(),n=a.assureIDConnectEndpoint+"/AssureIDService/Document/"+o.instanceID,i=d("GET",n);return i.send(),i.onload=function(){if(200===i.status){var e=JSON.parse(i.responseText);e.Fields=e.Fields?r.formatData(e.Fields):{},e.DataFields=e.DataFields?r.formatData(e.DataFields,"DataFields"):{};var a=e.DataFields;e.Fields&&a&&a.surname&&(a.first_name||a.given_name)&&(e.Fields.first_name=a.first_name?a.first_name:a.given_name,e.Fields.last_name=a.surname?a.surname:""),t.resolve(e)}else t.reject(["Document getResults failed"])},i.onerror=function(){t.reject(["Document getResults failed"])},i.ontimeout=function(){t.reject(s)},t.promise},this.deleteDocInstance=function(){var t=e.defer(),r=a.assureIDConnectEndpoint+"/AssureIDService/Document/"+o.instanceID,i=n("DELETE",r);return i.setRequestHeader("Authorization","Basic "+btoa(a.username+":"+a.password)),i.setRequestHeader("Accept","application/json"),i.send(),i.onload=function(){t.resolve({})},i.onerror=function(){t.resolve({})},i.ontimeout=function(){t.reject(s)},t.promise},this.verifyFacialMatch=function(t,r){var o=e.defer(),i="https://cssnwebservices.com/CSSNService/CardProcessor/FacialMatch",c=n("POST",i),d=new FormData;return d.append("idFaceImage",t),d.append("selfieImage",r),c.setRequestHeader("Authorization","LicenseKey "+a.LicenseKey),c.setRequestHeader("Content-Type","image/*"),c.setRequestHeader("Accept","application/json"),c.send(d),c.onload=function(){if(200===c.status){var e=JSON.parse(c.responseText);o.resolve(e)}else o.reject(["Facial Recognition Failed"])},c.onerror=function(){o.reject(["Facial Recognition Failed"])},c.ontimeout=function(){o.reject(s)},o.promise},this.getFaceImage=function(){var t=e.defer(),n=a.assureIDConnectEndpoint+"AssureIDService/Document/"+o.instanceID+"/Field/Image?key=Photo",i=d("GET",n);return i.responseType="arraybuffer",i.send(),i.onload=function(){if(200===i.status){var e=r.base64ArrayBuffer(i.response);t.resolve(e)}else t.reject(["Document getFaceImage failed"])},i.onerror=function(){t.reject(["Document getFaceImage failed"])},i.ontimeout=function(){t.reject(s)},t.promise},this.WebSocketObj}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){angular.module("sntIDCollection").service("sntIDCollectionUtilsSrv",["$filter",function(e){var t=this;this.base64ArrayBuffer=function(e){for(var t,a=new Uint8Array(e),r="",n=5e3,o=0,i=a.length;o<i;o+=n)t=a.subarray(o,o+n),r+=String.fromCharCode.apply(null,t);return"data:image/jpeg;base64,"+btoa(r)},this.processDate=function(e){return e=e.replace("Date",""),e=e.replace(")",""),e=e.replace("(",""),e=e.split("/").join(""),e=e.split("+")[0],parseInt(e)},this.dataURLtoBlob=function(e){for(var t=atob(e.split(",")[1]),a=[],r=0;r<t.length;r++)a.push(t.charCodeAt(r));return new Blob([new Uint8Array(a)],{type:"image/jpg"})},this.formatData=function(e,a){var r={},n=function(e){return e?moment(t.processDate(e)).utc().format("DD-MM-YYYY"):""},o={"Birth Date":n,"Expiration Date":n,"Issue Date":n};return angular.forEach(e,function(e){var t="DataFields"===a?e.Name:e.Key,n=e.Value;r[t.toLowerCase().split(" ").join("_")]=o[t]?o[t](n):n}),r},this.resizeImage=function(e,a,r,n){var o=document.createElement("canvas"),i=o.getContext("2d");i.drawImage(e,0,0);var s=3032,c=2008;r=r?r:e.width,n=n?n:e.height,r>n?r>s&&(n*=s/r,r=s):n>c&&(r*=c/n,n=c),o.width=r,o.height=n,i=o.getContext("2d"),i.mozImageSmoothingEnabled=!1,i.webkitImageSmoothingEnabled=!1,i.msImageSmoothingEnabled=!1,i.imageSmoothingEnabled=!1,i.drawImage(e,0,0,r,n);var d=a&&a.files[0]?a.files[0].type:"image/jpeg",l=o.toDataURL(d,.9),u=l?t.dataURLtoBlob(l):"";return u},this.retrieveAuthenticationStatus=function(e){var e=null;switch(e){case 0:e="Unknown";break;case 1:e="Passed";break;case 2:e="Failed";break;case 3:e="Skipped";break;case 4:e="Caution";break;case 5:e="Attention";break;default:e="Unknown"}return e},this.isIDExpired=function(t){var a=e("filter")(t,{Key:"Document Expired"},!0)[0],r=!!a&&(4===a.Result||5===a.Result);return r},this.dclone=function(e,t){"undefined"==typeof t&&(t=[]);for(var a=JSON.parse(JSON.stringify(e)),r=0;r<t.length;r++)delete a[t[r]];return a},this.formatResults=function(e){var a={};a.document_type=e.document_class_name?e.document_class_name:"",a.document_number=e.document_number?e.document_number:"",a.first_name=e.first_name?e.first_name:e.given_name,a.last_name=e.last_name?e.last_name:e.surname,a.full_name=e.full_name?e.full_name:"",a.nationality=e.nationality_code?t.countryMappings[e.nationality_code]:"",a.nationality_name=e.nationality_name?e.nationality_name:"",a.expiration_date=e.expiration_date&&"Invalid date"!==e.expiration_date?e.expiration_date:"",a.date_of_birth=e.birth_date&&"Invalid date"!==e.birth_date?e.birth_date:"";var r=e.personal_number?angular.copy(e.personal_number):"";return a.first_name||a.last_name||!a.full_name||(a.first_name=a.full_name),e=this.dclone(e,["photo","signature","iDAuthenticationStatus","personal_number"]),a.id_scan_info=e,a.id_scan_info.personal_id_no=r?r:"",a},this.countryMappings={AFG:"AF",ALA:"AX",ALB:"AL",DZA:"DZ",ASM:"AS",AND:"AD",AGO:"AO",AIA:"AI",ATA:"AQ",ATG:"AG",ARG:"AR",ARM:"AM",ABW:"AW",AUS:"AU",AUT:"AT",AZE:"AZ",BHS:"BS",BHR:"BH",BGD:"BD",BRB:"BB",BLR:"BY",BEL:"BE",BLZ:"BZ",BEN:"BJ",BMU:"BM",BTN:"BT",BOL:"BO",BIH:"BA",BWA:"BW",BVT:"BV",BRA:"BR",VGB:"VG",IOT:"IO",BRN:"BN",BGR:"BG",BFA:"BF",BDI:"BI",KHM:"KH",CMR:"CM",CAN:"CA",CPV:"CV",CYM:"KY",CAF:"CF",TCD:"TD",CHL:"CL",CHN:"CN",HKG:"HK",MAC:"MO",CXR:"CX",CCK:"CC",COL:"CO",COM:"KM",COG:"CG",COD:"CD",COK:"CK",CRI:"CR",CIV:"CI",HRV:"HR",CUB:"CU",CYP:"CY",CZE:"CZ",DNK:"DK",DJI:"DJ",DMA:"DM",DOM:"DO",ECU:"EC",EGY:"EG",SLV:"SV",GNQ:"GQ",ERI:"ER",EST:"EE",ETH:"ET",FLK:"FK",FRO:"FO",FJI:"FJ",FIN:"FI",FRA:"FR",GUF:"GF",PYF:"PF",ATF:"TF",GAB:"GA",GMB:"GM",GEO:"GE",DEU:"DE",GHA:"GH",GIB:"GI",GRC:"GR",GRL:"GL",GRD:"GD",GLP:"GP",GUM:"GU",GTM:"GT",GGY:"GG",GIN:"GN",GNB:"GW",GUY:"GY",HTI:"HT",HMD:"HM",VAT:"VA",HND:"HN",HUN:"HU",ISL:"IS",IND:"IN",IDN:"ID",IRN:"IR",IRQ:"IQ",IRL:"IE",IMN:"IM",ISR:"IL",ITA:"IT",JAM:"JM",JPN:"JP",JEY:"JE",JOR:"JO",KAZ:"KZ",KEN:"KE",KIR:"KI",PRK:"KP",KOR:"KR",KWT:"KW",KGZ:"KG",LAO:"LA",LVA:"LV",LBN:"LB",LSO:"LS",LBR:"LR",LBY:"LY",LIE:"LI",LTU:"LT",LUX:"LU",MKD:"MK",MDG:"MG",MWI:"MW",MYS:"MY",MDV:"MV",MLI:"ML",MLT:"MT",MHL:"MH",MTQ:"MQ",MRT:"MR",MUS:"MU",MYT:"YT",MEX:"MX",FSM:"FM",MDA:"MD",MCO:"MC",MNG:"MN",MNE:"ME",MSR:"MS",MAR:"MA",MOZ:"MZ",MMR:"MM",NAM:"NA",NRU:"NR",NPL:"NP",NLD:"NL",ANT:"AN",NCL:"NC",NZL:"NZ",NIC:"NI",NER:"NE",NGA:"NG",NIU:"NU",NFK:"NF",MNP:"MP",NOR:"NO",OMN:"OM",PAK:"PK",PLW:"PW",PSE:"PS",PAN:"PA",PNG:"PG",PRY:"PY",PER:"PE",PHL:"PH",PCN:"PN",POL:"PL",PRT:"PT",PRI:"PR",QAT:"QA",REU:"RE",ROU:"RO",RUS:"RU",RWA:"RW",BLM:"BL",SHN:"SH",KNA:"KN",LCA:"LC",MAF:"MF",SPM:"PM",VCT:"VC",WSM:"WS",SMR:"SM",STP:"ST",SAU:"SA",SEN:"SN",SRB:"RS",SYC:"SC",SLE:"SL",SGP:"SG",SVK:"SK",SVN:"SI",SLB:"SB",SOM:"SO",ZAF:"ZA",SGS:"GS",SSD:"SS",ESP:"ES",LKA:"LK",SDN:"SD",SUR:"SR",SJM:"SJ",SWZ:"SZ",SWE:"SE",CHE:"CH",SYR:"SY",TWN:"TW",TJK:"TJ",TZA:"TZ",THA:"TH",TLS:"TL",TGO:"TG",TKL:"TK",TON:"TO",TTO:"TT",TUN:"TN",TUR:"TR",TKM:"TM",TCA:"TC",TUV:"TV",UGA:"UG",UKR:"UA",ARE:"AE",GBR:"GB",USA:"US",UMI:"UM",URY:"UY",UZB:"UZ",VUT:"VU",VEN:"VE",VNM:"VN",VIR:"VI",WLF:"WF",ESH:"EH",YEM:"YE",ZMB:"ZM",ZWE:"ZW"},this.isInMobile=function(){return navigator.userAgent.match(/Android/i)||navigator.userAgent.match(/webOS/i)||navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPad/i)||navigator.userAgent.match(/iPod/i)||navigator.userAgent.match(/BlackBerry/i)||navigator.userAgent.match(/Windows Phone/i)},this.formatResultsFromThirdParty=function(e){return e.first_name=e.first_name||e.given_name,e.last_name=e.last_name||e.surname,e.full_name=e.full_name||"",e.expiration_date=moment(e.expiration_date).isValid()?e.expiration_date:"",e.issue_date=moment(e.issue_date).isValid()?e.issue_date:"",e.date_of_birth=moment(e.birth_date).isValid()?e.birth_date:"",e.document_type=e.document_class_name||"ID",e},this.thirdPartyScannerTimeout=30}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){angular.module("sntIDCollection").constant("acuantCredentials",{username:"mubarak@stayntouch.com",password:"kuuj7rsk1dkbr3kn",assureIDConnectEndpoint:"https://services.assureid.net/",subscriptionID:"25c10b5f-45a2-43fa-9526-b2f6c39a494d",LicenseKey:"64C3503EC1C2"})},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){angular.module("sntIDCollection").constant("screenModes",{validate_subscription:"VALIDATE_SUBSCRIPTION",valid_id_credentials:"VALID_ID_CREDENTIALS",invalid_id_credentials:"INVALID_ID_CREDENTIALS",upload_front_image:"UPLOAD_FRONT_IMAGE",analysing_front_image:"ANALYSING_FRONT_IMAGE",upload_front_image_failed:"UPLOAD_FRONT_IMAGE_FAILED",confirm_front_image:"CONFIRM_FRONT_IMAGE",upload_back_image:"UPLOAD_BACK_IMAGE",analysing_back_image:"ANALYSING_BACK_IMAGE",upload_back_image_failed:"UPLOAD_BACK_IMAGE_FAILED",confirm_id_images:"CONFIRM_ID_IMAGES",analysing_id_data:"ANALYSING_ID_DATA",analysing_id_data_failed:"ANALYSING_ID_DATA_FAILED",facial_recognition_failed:"FACIAL_RECOGNTION_FAILED",facial_recognition_mode:"FACIAL_RECOGNITION_MODE",final_id_results:"FINAL_ID_RESULTS"})},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){angular.module("sntIDCollection").controller("sntIDCollectionBaseCtrl",["$scope","sntIDCollectionSrv","sntIDCollectionUtilsSrv","screenModes","$timeout","$log",function(e,t,a,r,n,o){var i,s=function(){e.screenData={frontSideImage:"",backSideImage:"",imageSide:0,scanMode:r.validate_subscription,idDetails:{},needBackSideScan:!1,extCamForFrontIDActivated:!1,extCamForBackIDActivated:!1}},c=function(){e.$$phase||e.$digest()};e.deviceConfig={useExtCamera:!1,useiOSAppCamera:!1,useExtCamForFR:!1,useAutoDetection:!1,idCapturePluginName:"",idCaptureActionName:"",useAilaDevice:!1,useThirdPartyScan:!1,thirdPatrtyConnectionUrl:""};var d=function(){window.localVideoStream&&window.localVideoStream.getVideoTracks()&&window.localVideoStream.getVideoTracks().length&&window.localVideoStream.getVideoTracks()[0].stop()};e.setIDsForImageElements=function(e){i={front_side_upload:e?e.front_side_upload:"front-image",back_side_upload:e?e.back_side_upload:"back-image",front_image_preview:e?e.front_image_preview:"front-side-image",
back_image_preview:e?e.back_image_preview:"back-side-image",face_img_upload:e?e.face_img_upload:"face-image-upload",face_image:e?e.face_image:"face-image"}};var l,u=function(t){n(function(){var n=a.formatResultsFromThirdParty(t.doc);e.screenData.scanMode=r.final_id_results,0===e.screenData.imageSide&&(n.back_side_image=""),e.$emit("FINAL_RESULTS",n),e.screenData.idDetails=n,$("#id-front-side").attr("src",n.front_side_image),n.back_side_image&&$("#id-back-side").attr("src",n.back_side_image)},2e3)},m=function(){if(t.WebSocketObj&&1===t.WebSocketObj.readyState){e.$emit("IMAGE_ANALYSIS_STARTED");var n={command:"cmd_scan_with_3rd_party_scanner",timeout:a.thirdPartyScannerTimeout,workstation_id:a.workstation_id};t.WebSocketObj.send(JSON.stringify(n))}else 0===e.screenData.imageSide?e.screenData.scanMode=r.upload_front_image_failed:e.screenData.scanMode=r.upload_back_image_failed,p()},f=function(t){var a=JSON.parse(t.data);return a.ResponseCode&&0!==a.ResponseCode.toLowerCase()?void n(function(){e.screenData.scanMode=0===e.screenData.imageSide?r.upload_front_image_failed:r.upload_back_image_failed},0):(a.should_scan_more&&0===e.screenData.imageSide?(e.screenData.scanMode="UPLOAD_BACK_IMAGE",l=a.doc,e.screenData.imageSide=1):1===e.screenData.imageSide&&(a.doc=Object.assign({},l,a.doc)),void u(a))},p=function(){t.WebSocketObj&&1===t.WebSocketObj.readyState&&t.WebSocketObj.close(),t.WebSocketObj=new WebSocket(e.deviceConfig.thirdPatrtyConnectionUrl+"?workstation_id="+a.workstation_id),t.WebSocketObj.onmessage=function(e){f(e)}};e.setConfigurations=function(t){e.deviceConfig=t,t.useThirdPartyScan&&p()};var v,_,D=function(){t.getImageDetails(e.screenData.imageSide).then(function(t){if(e.screenData.needBackSideScan=!(t.image_classification&&t.image_classification.Type&&3===t.image_classification.Type.Size),e.screenData.needBackSideScan&&1!==e.screenData.imageSide?(e.screenData.scanMode=r.confirm_front_image,e.$emit("ID_FRONT_IMAGE_CAPTURED")):(e.screenData.scanMode=r.confirm_id_images,e.$emit("ID_BACK_IMAGE_CAPTURED")),t.image){var n=a.base64ArrayBuffer(t.image);e.$emit("IMAGE_UPDATED",{isFrontSide:0===e.screenData.imageSide,imageData:n}),0===e.screenData.imageSide?$("#"+i.front_image_preview).attr("src",n):$("#"+i.back_image_preview).attr("src",n)}d()},function(t){o.error(t),d(),e.$emit("IMAGE_ANALYSIS_FAILED"),e.screenData.scanMode=0===e.screenData.imageSide?r.upload_front_image_failed:r.upload_back_image_failed})},h=function(){t.postBackImage(e.screenData.backSideImage).then(function(){D()},function(t){o.error(t),e.$emit("IMAGE_ANALYSIS_FAILED",t),e.screenData.scanMode=r.upload_back_image_failed,d()})},y=function(){t.postFrontImage(e.screenData.frontSideImage).then(function(){D()},function(t){o.error(t),e.$emit("IMAGE_ANALYSIS_FAILED",t),e.screenData.scanMode=r.upload_front_image_failed,d()})},g=function(){t.getDocInstance().then(function(t){t?y():e.screenData.scanMode=r.upload_front_image_failed},function(t){o.error(t),e.$emit("IMAGE_ANALYSIS_FAILED"),e.screenData.scanMode=r.upload_front_image_failed})},C=function(a,n){var o=function(t){e.$emit("FR_FAILED",t),e.screenData.scanMode=r.facial_recognition_failed,d()};t.verifyFacialMatch(a,n).then(function(t){t&&t.FacialMatch&&t.FacialMatchConfidenceRating>95?(e.$emit("FR_SUCCESS"),d()):o(t)},o)},A=function(t,i,s,c){var d=t.target,l=new FileReader;l.onload=function(t){if(window.File&&window.FileReader&&window.FileList&&window.Blob){var c=document.createElement("img");c.src=t.target.result,c.onload=function(){var t=a.resizeImage(c,d);s?(_=a.dataURLtoBlob(l.result),n(function(){e.screenData.scanMode=r.analysing_id_data},0),C(v,_),e.$emit("FR_ANALYSIS_STARTED")):i?(v=a.dataURLtoBlob(l.result),g(),e.screenData.frontSideImage=t):(e.screenData.backSideImage=t,h()),e.$emit("IMAGE_ANALYSIS_STARTED")}}else o.error("The File APIs are not fully supported in this browser.")},d.files.length>0?l.readAsDataURL(d.files[0]):n(function(){e.screenData.scanMode=c},0)},S=function(){t.getFaceImage().then(function(a){e.$emit("FACE_IMAGE_RETRIEVED",a),t.deleteDocInstance().then(function(){},function(){})},function(){t.deleteDocInstance().then(function(){},function(){})})};e.confirmImages=function(){e.screenData.scanMode=r.analysing_id_data,t.getResults().then(function(t){o.info(t),e.screenData.scanMode=r.final_id_results,e.screenData.idDetails=t.Fields,e.screenData.idDetails.iDAuthenticationStatus=a.retrieveAuthenticationStatus(t.Result),e.screenData.idDetails.expirationStatus=a.isIDExpired(t.Alerts)?"Expired":"Unexpired";var n=a.formatResults(t.Fields);n.iDAuthenticationStatus=a.retrieveAuthenticationStatus(t.Result),n.expirationStatus=a.isIDExpired(t.Alerts)?"Expired":"Unexpired",e.$emit("FINAL_RESULTS",n),S()},function(t){o.error(t),e.screenData.scanMode=r.analysing_id_data_failed})},e.confirmFrontImage=function(){e.screenData.imageSide=1,e.screenData.scanMode=e.screenData.needBackSideScan?r.upload_back_image:r.confirm_id_images,e.$emit("FRONT_IMAGE_CONFIRMED")},e.frontImageChanged=function(t){e.screenData.frontSideImage="",A(t,!0,!1,angular.copy(e.screenData.scanMode)),e.screenData.scanMode=r.analysing_front_image},e.backImageChanged=function(t){e.screenData.backSideImage="",A(t,!1,!1,angular.copy(e.screenData.scanMode)),e.screenData.scanMode=r.analysing_back_image},e.faceImageChanged=function(t){e.screenData.faceImage="",A(t,!1,!0,angular.copy(e.screenData.scanMode))};var I=function(t,r,n){var o=document.createElement("img"),i="data:image/jpeg;base64,"+n;o.src=i,o.onload=function(){t&&(i=a.dataURLtoBlob(i),C(v,i),e.screenData.scanMode="FACIAL_RECOGNITION_MODE",e.$emit("FR_ANALYSIS_STARTED"),e.$digest())},o.onerror=function(){e.$emit("FR_FAILED")}},T=function(){var t={CAPTURE_TIMER:3,PREVIEW_TIMER:e.deviceConfig.useAilaDevice?0:3,CAMERA_TYPE:"back_camera",CAMERA_MESSAGES:{DETECTING_FACE:"WAITING FOR AN ID TO SCAN, PLEASE SHOW YOUR ID TO THE IPAD BACK CAMERA",CANCEL:"CANCEL",TAKING_PHOTO:"CAPTURING ID",CAPTURE:"CAPTURE NOW",PROCEEDING_WITH_THE_IMAGE:"PROCEEDING WITH THIS ID IMAGE",RETAKE_PHOTO:"RECAPTURE",PROCEED:"CONTINUE"}},n=function(t){e.$emit("IMAGE_ANALYSIS_STARTED");var n=document.createElement("img");t=t?t.image_base64:"";var o="data:image/png;base64,"+t;n.src=o,o=a.dataURLtoBlob(o),n.onload=function(){if(0===e.screenData.imageSide){e.screenData.frontSideImage=o;var t=a.resizeImage(n,void 0,2560,1920);v=t,g()}else e.screenData.backSideImage=o,h();c()},n.onerror=function(){e.$emit("IMAGE_ANALYSIS_FAILED"),e.screenData.scanMode=0===e.screenData.imageSide?r.upload_front_image_failed:r.upload_back_image_failed}},o=JSON.stringify(t),i=e.deviceConfig.idCapturePluginName?e.deviceConfig.idCapturePluginName:"AilaCordovaPlugin",s=e.deviceConfig.idCaptureActionName?e.deviceConfig.idCaptureActionName:"captureID";cordova.exec(function(t){e.$emit("IMAGE_ANALYSIS_STARTED"),e.$emit("RUN_APPLY"),n(t)},function(){e.$emit("IMAGE_ANALYSIS_FAILED"),e.screenData.scanMode=0===e.screenData.imageSide?r.upload_front_image_failed:r.upload_back_image_failed,e.$emit("RUN_APPLY")},i,s,[o])};e.captureFrontImage=function(){e.deviceConfig.useThirdPartyScan?m():"undefined"!=typeof cordova&&e.deviceConfig.useAutoDetection?T():n(function(){angular.element(document.querySelector("#"+i.front_side_upload)).click()},0)},e.captureBackImage=function(){e.deviceConfig.useThirdPartyScan?m():"undefined"!=typeof cordova&&e.deviceConfig.useAutoDetection?T():n(function(){angular.element(document.querySelector("#"+i.back_side_upload)).click()},0)},e.startScanning=function(){s(),$("#"+i.front_image_preview).attr("src",""),$("#"+i.back_image_preview).attr("src",""),e.screenData.scanMode=r.upload_front_image,e.$emit("CLEAR_PREVIOUS_DATA"),e.deviceConfig.useExtCamera&&!e.deviceConfig.useThirdPartyScan&&e.$emit("FRONT_SIDE_SCANNING_STARTED")},e.validateSubsription=function(){t.validateCredentials().then(function(){e.screenData.scanMode=r.valid_id_credentials,e.$emit("CREDENTIALS_VALIDATED")},function(t){e.screenData.scanMode=r.invalid_id_credentials,o.error(t)})},e.startFacialRecognition=function(){var t={CAPTURE_TIMER:3,PREVIEW_TIMER:3,CAMERA_TYPE:"front_camera",CAMERA_MESSAGES:{DETECTING_FACE:"DETECTING FACE, PLEASE POSITION YOUR FACE STRAIGHT",CANCEL:"CANCEL",TAKING_PHOTO:"CAPTURING YOUR HEADSHOT",CAPTURE:"CAPTURE NOW",PROCEEDING_WITH_THE_IMAGE:"PROCEEDING WITH CAPTURED IMAGE",RETAKE_PHOTO:"RECAPTURE",PROCEED:"CONTINUE"}};e.deviceConfig.useiOSAppCamera?cordova.exec(function(e){I(!0,void 0,e.image_base64)},function(t){o.error(t),e.$emit("FR_FAILED")},"RVCardPlugin","captureFacePhoto",[JSON.stringify(t)]):n(function(){angular.element(document.querySelector("#"+i.face_img_upload)).click()},0)},e.startExtCameraCapture=function(t){e.$emit("EXT_CAMERA_STARTING");var a="front-image"===t?document.querySelector("#id-video"):document.querySelector("#id-back-video"),r=localStorage.getItem("ID_SCAN_CAMERA_ID");navigator.mediaDevices.getUserMedia({video:{deviceId:r?{exact:r}:void 0,width:2560,height:1920}}).then(function(r){window.localVideoStream=r,a.srcObject=r,"front-image"===t?e.screenData.extCamForFrontIDActivated=!0:e.screenData.extCamForBackIDActivated=!0,e.$emit("EXT_CAMERA_STARTED"),e.$digest()}).catch(function(){e.$emit("EXT_CAMERA_FAILED")})},e.startFacialRecognitionUsingExtCamera=function(){e.screenData.extCamForSelfieActivated=!1,e.screenData.scanMode="FACIAL_RECOGNITION_MODE";var t=document.querySelector("#fr-id-video"),a=localStorage.getItem("FR_CAMERA_ID");e.$emit("FR_CAMERA_STARTING"),navigator.mediaDevices.getUserMedia({video:{deviceId:a?{exact:a}:void 0,width:2560,height:1920}}).then(function(a){window.localVideoStream=a,t.srcObject=a,e.screenData.extCamForSelfieActivated=!0,e.$emit("EXT_CAMERA_STARTED"),e.$digest()}).catch(function(){e.$emit("EXT_CAMERA_FAILED")})},e.captureFaceImageUsingExtCamera=function(){var t=document.querySelector("#fr-id-video"),r=a.resizeImage(t,void 0,2560,1920);C(r,v),e.screenData.scanMode="FACIAL_RECOGNITION_MODE",e.$emit("FR_ANALYSIS_STARTED")},e.stopExtCamera=function(t){"front-image"===t?e.screenData.extCamForFrontIDActivated=!1:e.screenData.extCamForBackIDActivated=!1},e.captureFrontImageUsingExtCamera=function(){e.screenData.imageSide=0;var t=document.querySelector("#id-video"),r=a.resizeImage(t,void 0,2560,1920);v=r,e.screenData.frontSideImage=r,e.$emit("IMAGE_ANALYSIS_STARTED"),g()},e.retryFrontImageUsingExtCamera=function(){e.screenData.scanMode="UPLOAD_FRONT_IMAGE",e.startExtCameraCapture("front-image")},e.captureBackImageUsingExtCamera=function(){e.screenData.imageSide=1;var t=document.querySelector("#id-back-video"),r=a.resizeImage(t,void 0,2560,1920);e.screenData.backSideImage=r,e.$emit("IMAGE_ANALYSIS_STARTED"),h()},e.retryBackImageUsingExtCamera=function(){e.screenData.scanMode="UPLOAD_BACK_IMAGE",e.startExtCameraCapture("back-image")},e.$on("STOP_EXT_CAM",d),e.$on("$destroy",d),function(){s(),e.setIDsForImageElements()}()}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){angular.module("sntIDCollection").controller("sntIdSampleCtrl",["$scope","$controller","sntIDCollectionUtilsSrv",function(e,t,a){t("sntIDCollectionBaseCtrl",{$scope:e}),e.$on("FR_FAILED",function(){e.screenData.scanMode="FACIAL_RECOGNTION_FAILED"}),e.$on("FR_SUCCESS",function(){e.confirmImages()}),e.connectedCameras=[];var r=0;if(e.cameraSourceChanged=function(){localStorage.setItem("ID_SCAN_CAMERA_ID",e.selectedCamera),e.screenData.extCamForBackIDActivated?e.startExtCameraCapture("back-image"):e.startExtCameraCapture("front-image")},!a.isInMobile()&&navigator.mediaDevices&&navigator.mediaDevices.enumerateDevices)navigator.mediaDevices.enumerateDevices().then(function(t){angular.forEach(t,function(t){"videoinput"===t.kind&&(e.connectedCameras.push({id:t.deviceId,label:t.label||"camera "+(r+1)}),r++)});var a={useExtCamera:e.connectedCameras.length,useExtCamForFR:e.connectedCameras.length};e.setConfigurations(a),e.deviceConfig.useExtCamera?(e.screenData.scanMode="UPLOAD_FRONT_IMAGE",e.startExtCameraCapture("front-image"),e.selectedCamera=localStorage.getItem("ID_SCAN_CAMERA_ID")||""):e.screenData.scanMode="UPLOAD_FRONT_IMAGE"});else{e.screenData.scanMode="UPLOAD_FRONT_IMAGE";var n={useAutoDetection:!0,useThirdPartyScan:!1,thirdPatrtyConnectionUrl:"wss://localhost.stayntouch.com:4647/CCSwipeService"};e.setConfigurations(n)}e.$on("FRONT_SIDE_SCANNING_STARTED",function(){e.startExtCameraCapture("front-image")}),e.$on("FRONT_IMAGE_CONFIRMED",function(){"UPLOAD_BACK_IMAGE"===e.screenData.scanMode&&e.deviceConfig.useExtCamera&&e.startExtCameraCapture("back-image")})}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){angular.module("sntRover").service("RVCompanyCardActivityLogSrv",["$q","rvBaseWebSrvV2",function(e,t){this.fetchActivityLog=function(a){var r=e.defer(),n="/api/account_actions";return t.getJSON(n,a).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.fetchFilterData=function(a){var r=e.defer(),n="/api/account_actions/"+a.id+"/account_action_types";return t.getJSON(n).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise}}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){angular.module("sntRover").service("rvCompanyCardContractsSrv",["$q","sntBaseWebSrv",function(e,t){this.fetchRateContract=function(e){return t.getJSON("/api/rates/contract_rates",e)},this.deleteContract=function(e){var a="/api/accounts/"+e.account_id+"/contracts/"+e.contract_id;return t.deleteJSON(a)},this.fetchContractsDetails=function(e){var a="/api/accounts/"+e.account_id+"/contracts/"+e.contract_id;return t.getJSON(a)};var a=[];this.fetchContractsList=function(r){var n=e.defer(),o="/api/accounts/"+r.account_id+"/contracts";return t.getJSON(o).then(function(e){a=e,n.resolve(e)},function(e){n.reject(e)}),n.promise},this.getContractedRates=function(){return a},this.addNewContract=function(e){var a="/api/accounts/"+e.account_id+"/contracts";return t.postJSON(a,e.postData)},this.updateContract=function(e){var a="/api/accounts/"+e.account_id+"/contracts/"+e.contract_id;return t.putJSON(a,e.postData)},this.updateNight=function(e){var a="/api/accounts/"+e.account_id+"/contracts/"+e.contract_id+"/contract_nights";return t.postJSON(a,e.postData)},this.fetchContractsForLinking=function(e){return t.getJSON("/api/contracts/search_contracts",e)},this.linkContract=function(e){return t.postJSON("/api/contracts/link_contract",e)},this.unLinkContract=function(e){return t.postJSON("/api/contracts/unlink_contract",e)},this.linkRate=function(e){return t.postJSON("/api/contracts/link_rate",e)},this.unlinkRate=function(e){return t.postJSON("/api/contracts/unlink_rate",e)},this.fetchOwners=function(e){return e.id=e.contract_id,t.getJSON("/api/contracts/contract_owners",e)};var r=this;this.fetchDetailsWithOwnersList=function(t){var a=[],n={},o=e.defer();return a.push(r.fetchOwners(t).then(function(e){n.ownersList=e.data})),a.push(r.fetchContractsDetails(t).then(function(e){n.contractDetails=e})),e.all(a).then(function(){o.resolve(n)}),o.promise}}])},{}]},{},[1]),function(){function e(t,a,r){function n(i,s){if(!a[i]){if(!t[i]){var c="function"==typeof require&&require;if(!s&&c)return c(i,!0);if(o)return o(i,!0);var d=new Error("Cannot find module '"+i+"'");throw d.code="MODULE_NOT_FOUND",d}var l=a[i]={exports:{}};t[i][0].call(l.exports,function(e){var a=t[i][1][e];return n(a||e)},l,l.exports,e,t,a,r)}return a[i].exports}for(var o="function"==typeof require&&require,i=0;i<r.length;i++)n(r[i]);return n}return e}()({1:[function(e,t,a){angular.module("sntRover").service("rvCompanyCardNotesSrv",["$q","rvBaseWebSrvV2",function(e,t){this.fetchNotes=function(a){var r="/api/accounts/"+a.accountID+"/account_notes",n=e.defer();return t.getJSON(r).then(function(e){n.resolve(e.notes)},function(e){n.reject(e)}),n.promise},this.updateNote=function(a){var r="/api/accounts/"+a.accountID+"/update_account_note",n=e.defer(),o={description:a.text,note_id:a.noteID};return t.putJSON(r,o).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.deleteNote=function(a){var r="/api/accounts/"+a.accountID+"/delete_account_note/",n=e.defer(),o={note_id:a.noteID};return t.deleteJSON(r,o).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.createNote=function(a){var r={description:a.text},n="/api/accounts/"+a.accountID+"/save_account_note",o=e.defer();return t.postJSON(n,r).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise}}])},{}]},{},[1]);