"use strict";var payTemplateApp=angular.module("sntPayTemplates",[]);angular.module("sntPay",["pascalprecht.translate","oc.lazyLoad","ng-iscroll","ngDialog","sharedHttpInterceptor","sntActivityIndicator","snt.utils"]),angular.module("sntPay").controller("confirmDirectBillPopupCtrl",["$scope",function(e){e.payToDirectBill=function(){e.$emit("CONFIRMED_DB_PAYMENT",e.ngDialogData)},e.cancelButtonClick=function(){e.$emit("CANCELLED_CONFIRM_DB_PAYMENT")}}]);var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};angular.module("sntPay").controller("payAdyenCtrl",["$scope","sntAdyenGatewaySrv","sntPaymentSrv","paymentAppEventConstants","ngDialog","$timeout","sntActivity","paymentAppEventConstants","$window","$log",function(e,t,a,n,o,i,r,d,s,c){BaseCtrl.call(this,e);var m=void 0,_="https://checkoutshopper-test.adyen.com/checkoutshopper/sdk/5.0.0/adyen.js",l="sha384-kcKKvS6qZbXycrUw31OJ2/2Hz8A8FTsV9anjvpyQc/IWR1SmkFUw7w7F/t5S3qtA",p=function(){var e=document.createElement("script");e.type="text/javascript",e.onload=function(){y()},e.src=_,e.integrity=l,e.crossOrigin="anonymous",document.body.appendChild(e)},y=function(){var a=angular.element("#dropin-container");a&&a.length&&e.callAPI(t.createSession,{successCallBack:function(t){if(t.session&&t.session.errorCode)return void e.$emit(d.ERROR_OCCURED,["Adyen configuration issue.. Please verify"]);var a=window.location,n=_typeof(a.hostname)===_typeof("str")&&(a.hostname.indexOf("pms.stayntouch.com")!==-1||a.hostname.indexOf("pms.eu.stayntouch.com")!==-1),o={environment:n?"live":"test",clientKey:t.client_key,session:{id:t.session.id,sessionData:t.session.sessionData},beforeSubmit:function(e,t,a){a.resolve(e)},onPaymentCompleted:function(a,n){a&&"Authorised"===a.resultCode?(e.$emit(d.CLEAR_ERROR_MSG),u(t.session.id)):(e.$emit(d.ERROR_OCCURED,["Card error !... Please retry"]),e.$emit("RELOAD_IFRAME"))},onError:function(t,a){e.$emit(d.ERROR_OCCURED,["Failed to load Adyen component"+errorMessage])},paymentMethodsConfiguration:{card:{hasHolderName:!0,holderNameRequired:!1}}},i=new AdyenCheckout(o);i.then(function(e){m=e.create("dropin").mount("#dropin-container")})},failureCallBack:function(e){}})},u=function(t){var a={token:t,payment_type:"CC",card_expiry:(new Date).toJSON()},n={apiParams:a,cardDisplayData:{}};e.$emit(d.CC_TOKEN_GENERATED,{paymentData:n,forceSaveRoutine:!0})};e.selectedCC=e.selectedCC||{};var C=function(){$('script[src="'+_+'"]').length>0?y():p()};e.$on("RELOAD_IFRAME",function(){m&&m.unmount(),C()}),function(){var e="adyen-css",t="sha384-0IvbHDeulbhdg1tMDeFeGlmjiYoVT6YsbfAMKFU2lFd6YKUVk0Hgivcmva3j6mkK";if(!document.getElementById(e)){var a=document.getElementsByTagName("head")[0],n=document.createElement("link");n.id=e,n.rel="stylesheet",n.type="text/css",n.href="https://checkoutshopper-test.adyen.com/checkoutshopper/sdk/5.0.0/adyen.css",n.media="all",n.integrity=t,n.crossOrigin="anonymous",a.appendChild(n)}C()}()}]),angular.module("sntPay").controller("payCBACtrl",["$scope","sntPaymentSrv","paymentAppEventConstants","paymentUtilSrv","sntCBAGatewaySrv","$log","sntActivity","$interval","$filter",function(e,t,a,n,o,i,r,d,s){e.hotelConfig.emvTimeout=e.hotelConfig.emvTimeout||180;var c,m=0,_=parseInt(e.hotelConfig.emvTimeout),l=function(){m=0,d.cancel(c)},p=function(){c=d(function(){m>_?(e.$emit("CBA_PAYMENT_FAILED",[s("translate")("CBA_TIMED_OUT")]),r.stop("INIT_CBA_PAYMENT"),l()):m++},1e3)},y=0,u={id:null,status:null},C=function(t){var n=o.generateApiParams(t);e.$emit(a.CC_TOKEN_GENERATED,{paymentData:n,forceSaveRoutine:!0})},A=function(e){var t=[e.RVErrorCode+" "+e.RVErrorDesc];i.error(t)},f=function(t){l(),i.info("doPayment Success response",t),o.updateTransactionSuccess(u.id,t).then(function(t){o.finishTransaction(u.id),e.$emit("hideLoader"),r.stop("INIT_CBA_PAYMENT"),e.$emit("CBA_PAYMENT_SUCCESS",t.data)},function(t){i.error("update to server failed..."),r.stop("INIT_CBA_PAYMENT"),e.$emit("hideLoader"),e.$emit("CBA_PAYMENT_FAILED",t.data)})},T=function(t){l(),i.warn("doPayment Failure response",t),o.updateTransactionFailure(u.id,t).then(function(){r.stop("INIT_CBA_PAYMENT");var a=parseInt(t.RVErrorCode,10),n=[t.RVErrorCode+" "+t.RVErrorDesc];if(i.warn("doPayment Failure response",n),144!==a&&145!==a&&o.finishTransaction(u.id),e.$emit("CBA_PAYMENT_FAILED",n),145===a){var d=!0;o.checkLastTransactionStatus(d)}else e.$emit("hideLoader")},function(t){e.$emit("hideLoader"),e.$emit("CBA_PAYMENT_FAILED",t.data)})},E=function(){o.doPayment({transaction_id:u.id,amount:y},f,T)},D=function(){o.doRefund({transaction_id:u.id,amount:Math.abs(y)},f,T)},I=function(t,a){r.start("INIT_CBA_PAYMENT"),y=0,p(),e.payment&&e.payment.amount||(e.payment=e.payment||{}),y=a.postData.total_value_plus_fees?a.postData.total_value_plus_fees:a.postData.amount,o.initiateTransaction(y,a.bill_id).then(function(e){u.id=e.data.id,Number(y)>0?E():D()},function(t){e.$emit("hideLoader"),e.$emit("CBA_PAYMENT_FAILED",t.data),r.stop("INIT_CBA_PAYMENT"),l()})};!function(){i.info("CBA controller init");var t=e.$on("INITIATE_CBA_PAYMENT",I),a=e.$on("INITIATE_CBA_TOKENIZATION",function(){o.addCard(C,A)});e.$on("$destroy",t),e.$on("$destroy",a)}()}]),angular.module("sntPay").controller("payCreateARPopupCtrl",["$scope","sntPaymentSrv","$timeout",function(e,t,a){e.ar_number="",e.errorMessage="",e.showARNumberInput=!1,e.isCreateButtonDisabled=!1,e.onClickCreate=function(){e.ngDialogData.is_auto_assign_ar_numbers?e.createAccountReceivable(!0):e.showARNumberInput=!0},e.createAccountReceivable=function(n){t.saveARDetails({id:e.ngDialogData.account_id,ar_number:n?"":e.ar_number,workstation_id:e.hotelConfig.workstationId}).then(function(t){e.$emit("hideLoader"),e.$emit("NEW_AR_ACCOUNT_CREATED",{response:t,params:e.ngDialogData}),a(e.closeThisDialog,300)},function(t){e.$emit("hideLoader"),e.errorMessage=t,e.isCreateButtonDisabled=!1,"Please complete required AR Account Information"===e.errorMessage[0]&&(e.isCreateButtonDisabled=!0)})},e.cancelButtonClick=function(){e.errorMessage="",e.showARNumberInput=!1}}]);var _extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e};angular.module("sntPay").controller("payMLIOperationsController",["$scope","sntPaymentSrv","paymentAppEventConstants","paymentUtilSrv","paymentConstants","$timeout","$log","sntActivity",function(e,t,a,n,o,i,r,d){var s,c,m=function(){s=!1,c={},e.cardData={cardNumber:"",CCV:"",expiryMonth:"",expiryYear:"",nameOnCard:""}},_=e.$on(a.RESET_CARD_DETAILS,function(){return m}),l=function(t){var o=n.formCCTokenGeneratedParams(_extends({},e.cardData,t));e.$emit(a.CC_TOKEN_GENERATED,{paymentData:o,tokenDetails:t,cardData:e.cardData})},p=function(t){r.error(t),e.$emit(a.ERROR_OCCURED,t)},y=function(t){var o=(new SwipeOperation).createSWipedDataToSave(t),i=n.formCCTokenGeneratedParams(_extends({},e.cardData,t,o));e.$emit(a.CC_TOKEN_GENERATED,{paymentData:i,cardData:e.cardData,tokenDetails:t})},u=function(e){l(e),d.stop("FETCH_MLI_TOKEN")},C=function(e){p(e),d.stop("FETCH_MLI_TOKEN")},A=function(t,n){if("CBA_AND_MLI"===e.hotelConfig.paymentGateway&&!e.payment.isAddPaymentMode){var o=["Wrong Device ! Please use the CBA device to proceed with the payment action"];return void e.$emit(a.ERROR_OCCURED,o)}s=!0,e.hotelConfig.isEMVEnabled&&(e.payment.isManualEntryInsideIFrame=!0,e.toggleManualIframe()),c=n,e.cardData.cardNumber=n.cardNumber,e.cardData.nameOnCard=n.nameOnCard,e.cardData.expiryMonth=n.cardExpiryMonth,e.cardData.expiryYear=n.cardExpiryYear,e.cardData.cardType=n.cardType,e.payment.screenMode="CARD_ADD_MODE",e.payment.addCCMode="ADD_CARD",e.$$phase||e.$apply()},f=function(a){e.$emit("SHOW_SIX_PAY_LOADER"),t.getSixPaymentToken(a).then(function(t){var a=t.card_type||"";e.$emit("SUCCESS_LINK_PAYMENT",{response:{id:t.payment_method_id||t.guest_payment_method_id,guest_payment_method_id:t.guest_payment_method_id,payment_name:"CC",usedEMV:!0,addToGuestCard:e.payment.addToGuestCardSelected},selectedPaymentType:e.selectedPaymentType||"CC",cardDetails:{card_code:a.toLowerCase(),ending_with:t.ending_with,expiry_date:t.expiry_date,card_name:"",is_swiped:t.is_swiped}}),e.$emit("HIDE_SIX_PAY_LOADER")},function(t){r.info("Tokenization Failed"),e.$emit("PAYMENT_FAILED",t),e.$emit("HIDE_SIX_PAY_LOADER")})},T=function(a){e.$emit("SHOW_SIX_PAY_LOADER"),t.submitPaymentForChipAndPin(a).then(function(t){r.info("payment success"+e.payment.amount),t.amountPaid=e.payment.amount,t.authorizationCode=t.authorization_code;var a=t.payment_method&&t.payment_method.card_type||"";e.feeData&&(t.feePaid=e.feeData.calculatedFee),e.selectedCC=e.selectedCC||{},t.payment_method&&(e.selectedCC.value=t.payment_method.id,e.selectedCC.card_code=a.toLowerCase(),e.selectedCC.ending_with=t.payment_method.ending_with,e.selectedCC.expiry_date=t.payment_method.expiry_date),t.cc_details=angular.copy(e.selectedCC),e.payment.showAddToGuestCard&&(t.add_to_guest_card=e.payment.addToGuestCardSelected),e.$emit("HIDE_SIX_PAY_LOADER"),i(function(){e.onPaymentSuccess(t)},700)},function(t){r.info("payment failed"+t),e.$emit("PAYMENT_FAILED",t),e.$emit("HIDE_SIX_PAY_LOADER")})};e.getMLIToken=function(a){if(a.preventDefault(),s)return void y(c);var o=n.formParamsForFetchingTheToken(e.cardData);d.start("FETCH_MLI_TOKEN"),t.fetchMLIToken(o,u,C)},e.$on("RENDER_SWIPED_DATA",function(e,t){A(e,t)}),e.$on("INITIATE_CHIP_AND_PIN_PAYMENT",function(t,a){var n=a;n.postData.is_emv_request=!0,n.postData.workstation_id=e.hotelConfig.workstationId,n.emvTimeout=parseInt(e.hotelConfig.emvTimeout),T(a)}),e.$on("INITIATE_CHIP_AND_PIN_TOKENIZATION",function(t,a){var n=a;n.is_emv_request=!0,n.emvTimeout=parseInt(e.hotelConfig.emvTimeout),f(a)}),e.$on("destroy",_);var E=function(){e.selectedPaymentType="CC",A({},t.sampleMLISwipedCardResponse)};document.addEventListener("MOCK_MLI_SWIPE",function(){e.$emit("showLoader"),i(function(){e.$emit("hideLoader"),E()},1e3)}),function(){m(),e.modes=o.modes;try{HostedForm.setMerchant(e.hotelConfig.mliMerchantId)}catch(e){}}()}]);var _extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e};angular.module("sntPay").controller("payShift4Ctrl",["$scope","sntShift4GatewaySrv","sntPaymentSrv","paymentAppEventConstants","$timeout","sntActivity","$log",function(e,t,a,n,o,i,r){var d=void 0,s={JC:"JCB",NS:"DC",VS:"VA"},c="https://i4m.i4go.com/js/jquery.i4goTrueToken.js",m=function(){var e=document.createElement("script");e.type="application/javascript",e.onload=function(){_()},e.src=c,document.body.appendChild(e)},_=function(){var a=angular.element("#i4goFrame");a&&a.length&&t.getIframeConfig().then(function(t){$("#i4goFrame").i4goTrueToken({server:t.i4go_server,accessBlock:t.access_block,self:document.location,template:"bootstrap5",cssRules:["body{background-color: transparent}"],cardholderName:{visible:!0,required:!0},url:t.i4go_i4m_url,submitButton:{label:"Add",visible:!0},onSuccess:function(e,t){u(t)},onFailure:function(t,a){r.info("Tokenization Failed: response code =>"+a.respCode);var n=a.i4go_responsetext?[a.i4go_responsetext]:[""];e.$emit("PAYMENT_FAILED",n)},acceptedPayments:"AX,DC,JC,MC,NS,VS",debug:!1})}).catch(function(){})},l=function(t,n){n.postData=_extends({},n.postData,t,{etb:!0,isShift4Request:!0}),a.submitPayment(n).then(function(t){r.info("payment success"+e.payment.amount),t.amountPaid=e.payment.amount,t.authorizationCode=t.authorization_code;var a=t.payment_method&&t.payment_method.card_type||"";e.feeData&&(t.feePaid=e.feeData.calculatedFee),e.selectedCC=e.selectedCC||{},t.payment_method||(e.selectedCC.value=t.payment_method.id,e.selectedCC.card_code=a.toLowerCase(),e.selectedCC.ending_with=t.payment_method.ending_with,e.selectedCC.expiry_date=t.payment_method.expiry_date),t.cc_details=angular.copy(e.selectedCC),e.payment.showAddToGuestCard&&(t.add_to_guest_card=e.payment.addToGuestCardSelected),e.$emit("HIDE_SIX_PAY_LOADER"),o(function(){e.onPaymentSuccess(t)},700)},p)},p=function(t){r.info("Payment Failed");var a=["Failed to process the card. Please try again."];Array.isArray(t)?a=t:t&&t.data&&(a=t.data),e.$emit("PAYMENT_FAILED",a),e.$emit("HIDE_SIX_PAY_LOADER")},y=function(a,n){o(function(){e.$emit("SHOW_SIX_PAY_LOADER"),t.startPromptCard(d).then(function(t){if(t.result.length){var o=t.result[0],i="",r="",d="";if(o.card.expirationDate){var c=o.card.expirationDate.toString();c=3===c.length?"0"+c:c;var m=c.substring(2,4),_=c.substring(0,2);i="20"+m+"-"+_+"-01",r=_+"/"+m}o.customer&&(d=o.customer.firstName?o.customer.firstName.replace("/"," "):"",d=o.customer.lastName?d+" "+o.customer.lastName.replace("/"," "):d);var l={mli_token:o.card.token?o.card.token.value:"",payment_type:"CC",card_expiry:i,credit_card:s[o.card.type]||o.card.type,card_name:d,masked_card_number:o.card.number?o.card.number.slice(o.card.number.length-4):"XXXX",workstation_id:e.hotelConfig.workstationId,entry_mode:o.card.entryMode,card_expiry_for_display:r};a(l,n)}else p(["Proxy server - Failed to retrieve results"])},function(e){r.error(e),p(e||["Proxy server down"])})},120)},u=function(t){var a={mli_token:t.i4go_uniqueid.toString(),payment_type:"CC",card_expiry:t.i4go_expirationyear+"-"+t.i4go_expirationmonth+"-01",credit_card:s[t.i4go_cardtype]||t.i4go_cardtype,card_name:t.i4go_cardholdername,masked_card_number:t.otn.cardnumber.substr(-4)},o=t.i4go_expirationmonth+"/"+t.i4go_expirationyear.slice(-2);e.$emit(n.CC_TOKEN_GENERATED,{paymentData:{apiParams:a,cardDisplayData:{card_code:a.credit_card.toLowerCase(),ending_with:a.masked_card_number,expiry_date:o,name_on_card:a.card_name}}})},C=function(t,a){var o=t.card_expiry_for_display;delete t.card_expiry_for_display,e.$emit(n.CC_TOKEN_GENERATED,{paymentData:{apiParams:t,cardDisplayData:{card_code:t.credit_card.toLowerCase(),ending_with:t.masked_card_number,expiry_date:o,name_on_card:t.card_name}},forceSaveRoutine:!0}),e.$emit("HIDE_SIX_PAY_LOADER")};e.$on("INITIATE_CHIP_AND_PIN_PAYMENT",function(e,t){y(l,t)}),e.$on("INITIATE_CHIP_AND_PIN_TOKENIZATION",function(e,t){y(C,t)}),e.$on("RELOAD_IFRAME",function(){var e=document.getElementsByClassName("i4go-frame");e.length&&(e[0].src=e[0].src)}),function(){e.selectedCC=e.selectedCC||{},$('script[src="'+c+'"]').length>0?_():m(),i.start("FETCH_WORKSTATION_DATA"),a.fethWorkStationData(e.hotelConfig.workstationId).then(function(e){d=e,i.stop("FETCH_WORKSTATION_DATA")},function(e){i.stop("FETCH_WORKSTATION_DATA"),p(e)})}()}]);var _extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e};angular.module("sntPay").controller("payShijiCtrl",["$scope","sntShijiGatewaySrv","sntPaymentSrv","paymentAppEventConstants","ngDialog","$timeout","sntActivity","$window","$log",function(e,t,a,n,o,i,r,d,s){var c=this;c.loadShijiIframe=function(){var t=$("#iframe-token");if(t&&t.length){var n=a.resolvePaths(e.hotelConfig.paymentGateway,{card_holder_first_name:e.payment.guestFirstName,card_holder_last_name:e.payment.guestLastName});t[0].src=n.iFrameUrl,r.start("SHIJI_IFRAME_LOADING"),t.on("load",function(){r.stop("SHIJI_IFRAME_LOADING")}),t.on("error",function(){r.stop("SHIJI_IFRAME_LOADING")})}},e.$on("RELOAD_IFRAME",function(){}),e.$on("GET_SHIJI_TOKEN",function(){e.clearErrorMessage();var t=$("#iframe-token");t&&t.length&&(t[0].contentWindow.postMessage("0","*"),r.start("FETCH_SHIJI_TOKEN")),$("input").blur()});var m=function(t){var a=t.data;e.$emit("SUCCESS_LINK_PAYMENT",{response:_extends({},a,{addToGuestCard:e.payment.addToGuestCardSelected}),selectedPaymentType:e.selectedPaymentType,cardDetails:{card_code:a.credit_card_type?a.credit_card_type.toLowerCase():"credit-card",ending_with:a.ending_with,expiry_date:a.expiry_date,card_name:a.card_name,token:a.token}})},_=function(t){var n=function(t){e.$emit("PAYMENT_FAILED",t)};r.start("SAVE_CC_PAYMENT"),a.savePaymentDetails(t).then(function(e){"success"===e.status?m(e):n(e.errors),r.stop("SAVE_CC_PAYMENT")},function(e){n(e),r.stop("SAVE_CC_PAYMENT")})},l=function(t){var a={paymentData:{apiParams:t,cardDisplayData:{name_on_card:e.payment.guestFirstName+" "+e.payment.guestLastName}}};e.$emit(n.CC_TOKEN_GENERATED,a)};c.tokenizeBySavingtheCard=function(t){var a=/^ADD_PAYMENT_/.test(e.actionType),n={token:t,payment_type:"CC"};a&&(e.reservationId&&(n.reservation_id=e.reservationId),n.add_to_guest_card=e.payment.addToGuestCardSelected,n.bill_number=1,n.user_id=e.guestId),r.stop("FETCH_SHIJI_TOKEN"),a?_(n):l(n)},c.handleResponseFromIframe=function(t){var a=t.data||t.originalEvent.data;if("00"===a.respCode)c.tokenizeBySavingtheCard(a.tokenId);else if(a.respCode&&"00"!==a.respCode){r.stop("FETCH_SHIJI_TOKEN"),s.info("Tokenization Failed: response code =>"+a.respCode);var n=a.respText?[a.respText]:[""];e.$emit("PAYMENT_FAILED",n)}};var p=function(t){e.$emit("SHOW_SIX_PAY_LOADER"),a.getSixPaymentToken(t).then(function(t){var a=t.card_type||"";e.$emit("SUCCESS_LINK_PAYMENT",{response:{id:t.payment_method_id||t.guest_payment_method_id,guest_payment_method_id:t.guest_payment_method_id,payment_name:"CC",usedEMV:!0,addToGuestCard:e.payment.addToGuestCardSelected},selectedPaymentType:e.selectedPaymentType||"CC",cardDetails:{card_code:a.toLowerCase(),ending_with:t.ending_with,expiry_date:t.expiry_date,card_name:t.card_name,is_swiped:t.is_swiped}}),e.$emit("HIDE_SIX_PAY_LOADER")},function(t){s.info("Tokenization Failed"),e.$emit("PAYMENT_FAILED",t),e.$emit("HIDE_SIX_PAY_LOADER")})};e.$on("INITIATE_CHIP_AND_PIN_TOKENIZATION",function(t,a){var n=a;n.is_emv_request=!0,n.emvTimeout=parseInt(e.hotelConfig.emvTimeout),p(a)});var y=function(t){e.$emit("SHOW_SIX_PAY_LOADER"),a.submitPaymentForChipAndPin(t).then(function(t){t.amountPaid=e.payment.amount,t.authorizationCode=t.authorization_code;var a=t.payment_method&&t.payment_method.card_type||"";e.feeData&&(t.feePaid=e.feeData.calculatedFee),e.selectedCC=e.selectedCC||{},t.payment_method&&(e.selectedCC.value=t.payment_method.id,e.selectedCC.card_code=a.toLowerCase(),e.selectedCC.ending_with=t.payment_method.ending_with,e.selectedCC.expiry_date=t.payment_method.expiry_date),t.cc_details=angular.copy(e.selectedCC),e.payment.showAddToGuestCard&&(t.add_to_guest_card=e.payment.addToGuestCardSelected),e.$emit("HIDE_SIX_PAY_LOADER"),i(function(){e.onPaymentSuccess(t)},700)},function(t){e.$emit("PAYMENT_FAILED",t),e.$emit("HIDE_SIX_PAY_LOADER")})};e.$on("INITIATE_CHIP_AND_PIN_PAYMENT",function(t,a){var n=a;n.postData.is_emv_request=!0,n.postData.workstation_id=e.hotelConfig.workstationId,n.emvTimeout=parseInt(e.hotelConfig.emvTimeout),y(a)}),function(){c.loadShijiIframe();var t=angular.copy(e.showSelectedCard());e.payment.isManualEntryInsideIFrame=t&&"SHIJI"===e.hotelConfig.paymentGateway;var a=window.addEventListener?"addEventListener":"attachEvent",n="attachEvent"===a?"onmessage":"message";angular.element(d).on(n,function(e){c.handleResponseFromIframe(e)}),e.$on("$destroy",function(){angular.element(d).off(n)})}()}]),angular.module("sntPay").controller("paySixPayController",["$scope","paymentAppEventConstants","sntPaymentSrv","$timeout","$window",function(e,t,a,n,o){var i=function(t){var n={};return n.cardType=t.token_no.substr(t.token_no.length-4),n.expiryMonth=t.expiry.substring(2,4),n.expiryYear=t.expiry.substring(0,2),n.expiryDate=n.expiryMonth+" / "+n.expiryYear,n.cardExpiry=n.expiryMonth&&n.expiryYear?"20"+n.expiryYear+"-"+n.expiryMonth+"-01":"",n.cardCode=a.getSixPayCreditCardType(t.card_type).toLowerCase(),n.endingWith=t.token_no.substr(t.token_no.length-4),n.token=t.token_no,n.nameOnCard=e.payment.guestFirstName+" "+e.payment.guestLastName,n},r=function(a){var n=i(a),o={apiParams:{name_on_card:n.nameOnCard,payment_type:"CC",token:n.token,card_expiry:n.cardExpiry},cardDisplayData:{card_code:n.cardCode,ending_with:n.endingWith,expiry_date:n.expiryDate}};e.$emit(t.CC_TOKEN_GENERATED,{paymentData:o,tokenDetails:a,cardData:n})},d=function(t){e.$emit("SHOW_SIX_PAY_LOADER"),a.submitPaymentForChipAndPin(t).then(function(t){t.amountPaid=e.payment.amount,t.authorizationCode=t.authorization_code;var a=t.payment_method&&t.payment_method.card_type||"";e.feeData&&(t.feePaid=e.feeData.calculatedFee),e.selectedCC=e.selectedCC||{},t.payment_method&&(e.selectedCC.value=t.payment_method.id,e.selectedCC.card_code=a.toLowerCase(),e.selectedCC.ending_with=t.payment_method.ending_with,e.selectedCC.expiry_date=t.payment_method.expiry_date),t.cc_details=angular.copy(e.selectedCC),e.payment.showAddToGuestCard&&(t.add_to_guest_card=e.payment.addToGuestCardSelected),e.$emit("HIDE_SIX_PAY_LOADER"),n(function(){e.onPaymentSuccess(t)},700)},function(t){e.$emit("PAYMENT_FAILED",t),e.$emit("HIDE_SIX_PAY_LOADER")})},s=function(t){e.$emit("SHOW_SIX_PAY_LOADER"),a.getSixPaymentToken(t).then(function(t){var a=t.card_type||"";e.$emit("SUCCESS_LINK_PAYMENT",{response:{id:t.payment_method_id||t.guest_payment_method_id,guest_payment_method_id:t.guest_payment_method_id,payment_name:"CC",usedEMV:!0,addToGuestCard:e.payment.addToGuestCardSelected},selectedPaymentType:e.selectedPaymentType||"CC",cardDetails:{card_code:a.toLowerCase(),ending_with:t.ending_with,expiry_date:t.expiry_date,card_name:"",is_swiped:t.is_swiped}}),e.$emit("HIDE_SIX_PAY_LOADER")},function(t){e.$emit("PAYMENT_FAILED",t),e.$emit("HIDE_SIX_PAY_LOADER")})};e.$on("INITIATE_CHIP_AND_PIN_PAYMENT",function(t,a){var n=a;n.postData.is_emv_request=!0,n.postData.workstation_id=e.hotelConfig.workstationId,n.emvTimeout=parseInt(e.hotelConfig.emvTimeout),d(a)}),e.$on("INITIATE_CHIP_AND_PIN_TOKENIZATION",function(t,a){var n=a;n.is_emv_request=!0,n.emvTimeout=parseInt(e.hotelConfig.emvTimeout),s(a)}),function(){var t=angular.copy(e.showSelectedCard());e.payment.isManualEntryInsideIFrame=!(!t||"sixpayments"!==e.hotelConfig.paymentGateway);var a=window.addEventListener?"addEventListener":"attachEvent",n=(window[a],"attachEvent"===a?"onmessage":"message");angular.element(o).on(n,function(e){var t=e.data||e.originalEvent.data;"token_created"===t.response_message&&r(t)}),e.$on("$destroy",function(){angular.element(o).off(n)})}()}]);var _extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e};angular.module("sntPay").controller("sntPaymentController",["$scope","sntPaymentSrv","paymentAppEventConstants","$location","PAYMENT_CONFIG","$rootScope","$timeout","ngDialog","$filter","$state","sntActivity","rvPermissionSrv",function(e,t,a,n,o,i,r,d,s,c,m,l){function p(){G(),e.$emit("REMOVE_PAYMENT_TYPE",{paymentType:"DB"})}function y(t){var a=void 0;return t=t||{},a={postData:_extends({},t,{bill_number:e.billNumber,payment_type:e.selectedPaymentType,amount:e.payment.amount.toString().replace(/,/g,""),is_split_payment:e.splitBillEnabled&&e.numSplits>1,workstation_id:e.hotelConfig.workstationId,currency_id:e.payment.selectedPaymentCurrencyId}),reservation_id:e.reservationId,bill_id:e.billId},e.isRefund()&&"tax_payment_receipt"===e.hotelConfig.selectedReceiptTypeValue&&"DB"!==e.selectedPaymentType&&(a.postData.receipt_id=e.payment.receipt_id),"AR_REFUND_PAYMENT"===e.actionType&&(a.postData.parent_ar_id=e.arTransactionId),e.payment.showAddToGuestCard&&(a.postData.add_to_guest_card=e.payment.addToGuestCardSelected),e.feeData&&e.feeData.showFee&&(a.postData.fees_amount=e.feeData.calculatedFee,a.postData.fees_charge_code_id=e.feeData.feeChargeCode,a.postData.total_value_plus_fees=e.feeData.totalOfValueAndFee),e.isDisplayRef&&(a.postData.reference_text=e.payment.referenceText),e.reservationIds&&(a.postData.reservation_ids=e.reservationIds),e.selectedCC&&e.selectedCC.params&&(a.postData=_extends({},e.selectedCC.params,a.postData)),"SHIJI"===e.hotelConfig.paymentGateway&&(a.postData.auth_code=e.payment.auth_code),a}function u(t,a){var n=void 0,o=void 0;a=a||{},n=angular.copy(Y),angular.extend(n,a),a=n,o=isEmptyObject(e.myScrollOptions),o&&(e.myScrollOptions={}),k&&(a.click=!1,a.tap=!0,a.preventDefault=!1,a.deceleration=1e-4),e.myScrollOptions[t]=a}function C(t){setTimeout(function(){e.$parent&&e.$parent.myScroll&&t in e.$parent.myScroll&&e.$parent.myScroll[t].refresh(),e.hasOwnProperty("myScroll")&&t in e.myScroll&&e.myScroll[t].refresh()},F)}function A(){e.isEditable!==!1&&(e.payment.isEditable=!0)}function f(){var t="CBA_AND_MLI"===e.hotelConfig.paymentGateway;return!!o[e.hotelConfig.paymentGateway].disableCardSelection||t&&!e.payment.isAddCardAction}function T(t){r(function(){e.paymentAttempted=!0,e.isPaymentFailure=!0,e.paymentErrorMessage=t[0],e.$emit("PAYMENT_FAILED",t),m.stop("SUBMIT_PAYMENT"),e.$emit("hideLoader")},300)}function E(t){e.paymentErrorMessage="",r(function(){e.paymentErrorMessage=t,e.$emit("PAYMENT_FAILED",[t]),e.$emit("hideLoader")},300)}function D(){var a=e.$on("CBA_PAYMENT_FAILED",function(e,t){T(t)}),n=e.$on("CBA_PAYMENT_SUCCESS",function(a,n){var o=y();m.start("SUBMIT_PAYMENT"),o.postData.payment_type_id=n.payment_method_id,o.postData.credit_card_transaction_id=n.id,t.submitPayment(o).then(function(t){e.onPaymentSuccess(t),m.stop("SUBMIT_PAYMENT")},function(e){T(e)})}),o=i.$on("UPDATE_NOTIFICATION",function(e,t){E(t)});e.$on("$destroy",a),e.$on("$destroy",n),e.$on("$destroy",o)}function I(){var t=e.$on("SHIJI_PAYMENT_FAILED",function(e,t){T(t)}),a=e.$on("SHIJI_PAYMENT_SUCCESS",function(t,a){e.onPaymentSuccess(a)});e.$on("$destroy",t),e.$on("$destroy",a)}function P(){e.payment.showAddToGuestCard=!!e.reservationId}function h(){return e.payment.linkedCreditCards.length>0}function g(){e.payment.screenMode="CARD_ADD_MODE",e.payment.addCCMode=h()&&!e.swipedCardData?"EXISTING_CARDS":"ADD_CARD",e.$broadcast("RESET_CARD_DETAILS"),C("cardsList")}function v(){var t=void 0;"sixpayments"===e.hotelConfig.paymentGateway&&$("#sixIframe").length?(t=document.getElementById("sixIframe"),t.src=t.src):e.$broadcast("RELOAD_IFRAME")}function N(a){var n,o,i,r,d,s=O&&!e.payment.isManualEntryInsideIFrame;return e.hotelConfig.isStandAlone||"CBA"===e.selectedPaymentType?(n=_.find(e.paymentTypes,{name:e.selectedPaymentType}),d=n&&n.charge_code&&n.charge_code.fees_information||{},!s&&n&&"CC"===n.name&&e.selectedCC&&e.selectedCC.hasOwnProperty("card_code")&&(e.selectedCC.card_code&&(o=_.find(n.values,{cardcode:e.selectedCC.card_code.toUpperCase()})),d=o&&o.charge_code&&o.charge_code.fees_information||d),i=t.calculateFee(e.payment.amount,d),e.isDisplayRef=n&&n.is_display_reference,e.feeData={calculatedFee:i.calculatedFee,totalOfValueAndFee:i.totalOfValueAndFee,showFee:i.showFees,feeChargeCode:i.feeChargeCode},e.originalFee=angular.copy(e.feeData.calculatedFee),void(a&&e.payment.paymentCurrencyAmount&&(r=t.calculateFee(e.payment.paymentCurrencyAmount,d),e.paymentFeeData={calculatedPaymentFee:r.calculatedPaymentFee,totalOfValueAndPaymentFee:r.totalOfValueAndPaymentFee},e.originalPaymentFee=angular.copy(e.paymentFeeData.calculatedPaymentFee),e.feeData.calculatedFee=e.paymentFeeData.calculatedPaymentFee,e.feeData.totalOfValueAndFee=e.paymentFeeData.totalOfValueAndPaymentFee))):(e.feeData={calculatedFee:"",totalOfValueAndFee:"",showFee:!1,feeChargeCode:""},void(e.paymentFeeData={calculatedPaymentFee:"",totalOfValueAndPaymentFee:""}))}function S(){var t=_.find(e.paymentTypes,{name:"CC"});return t&&t.values||[]}function M(a){function n(t){e.selectedPaymentType||(e.selectedPaymentType="CC"),e.selectedCC=e.selectedCC||{},e.selectedCC.value=t.data.id,e.selectedCard=e.selectedCC.value,e.selectedCC.card_code=t.data.credit_card_type?t.data.credit_card_type.toLowerCase():"credit-card",e.selectedCC.ending_with=t.data.ending_with,e.selectedCC.expiry_date=t.data.expiry_date,e.selectedCC.holder_name=a.cardDisplayData.name_on_card,e.payment.screenMode="PAYMENT_MODE",e.$emit("PAYMENT_SAVE_CARD_SUCCESS"),t.params&&(e.selectedCC.params=i),N(),P()}function o(t){e.errorMessage=t}var i=void 0;return m.start("SAVE_CC_PAYMENT"),i=angular.copy(a.apiParams),e.accountId&&(i.account_id=e.accountId),e.groupId&&(i.group_id=e.groupId),e.allotmentId&&(i.allotment_id=e.allotmentId),"DEPOSIT_PAYMENT_RES_SUMMARY"===e.actionType&&(i.reservation_id=e.reservationId),i.mli_token&&"rover.reservation.staycard.mainCard.summaryAndConfirm"!==c.current.name&&"SHIFT4"!==e.hotelConfig.paymentGateway?(i.do_not_attach_cc_to_bill=!0,i.reservation_id=e.reservationId,m.stop("SAVE_CC_PAYMENT"),void n({params:i,data:{id:null,credit_card_type:e.selectedCC.card_code,ending_with:e.selectedCC.ending_with,expiry_date:e.selectedCC.expiry_date}})):void t.savePaymentDetails(i).then(function(e){"success"===e.status?n(e):o(e.errors),m.stop("SAVE_CC_PAYMENT")},function(e){o(e),m.stop("SAVE_CC_PAYMENT")})}function w(a){m.start("ADD_PAYMENT_METHOD_ON_BILL");var n=angular.copy(a.apiParams),o=function(t){e.selectedCC=e.selectedCC||{},e.selectedCC.value=t.id,e.selectedCard=e.selectedCC.value,e.selectedCC.card_code=t.credit_card_type?t.credit_card_type.toLowerCase():"credit-card",e.selectedCC.ending_with=t.ending_with,e.selectedCC.expiry_date=t.expiry_date,e.selectedCC.holder_name=a.cardDisplayData.name_on_card,e.payment.screenMode="PAYMENT_MODE",N()},i=function(t){e.errorMessage=t};t.addBillPaymentMethod({billId:e.billId,payLoad:_extends({},n,{workstation_id:e.hotelConfig.workstationId})}).then(function(e){o(e),m.stop("ADD_PAYMENT_METHOD_ON_BILL")},function(e){i(e),m.stop("ADD_PAYMENT_METHOD_ON_BILL")})}function R(){e.payment.amount=e.amount||0,L=angular.copy(e.payment.amount),N()}function b(){e.payment.paymentCurrencyAmount=e.paymentCurrencyAmount||0}var O,F=300,L=0,Y={snap:!1,scrollbars:"custom",hideScrollbar:!1,click:!1,scrollX:!1,scrollY:!0,preventDefault:!0,interactiveScrollbars:!0,preventDefaultException:{tagName:/^(INPUT|TEXTAREA|BUTTON|SELECT|A)$/}},k="rv_native"===sntapp.browser&&sntapp.cordovaLoaded;if(e.payment={referenceText:e.referenceText,amount:0,paymentCurrencyAmount:0,isPenalty:!1,isRateSuppressed:!1,isEditable:!1,addToGuestCard:!1,billNumber:1,linkedCreditCards:[],MLImerchantId:"",creditCardTypes:[],showAddToGuestCard:!1,addToGuestCardSelected:!1,allocatePaymentAfterPosting:!1,guestFirstName:"",guestLastName:"",isManualEntryInsideIFrame:!1,workstationId:"",emvTimeout:120,isConfirmedDBpayment:!1,selectedPaymentCurrencyId:i.hotelCurrencyId,selectedPaymentCurrencySymbol:"CC"===e.selectedPaymentType?i.currencySymbol:i.paymentCurrencySymbol},e.giftCard={number:"",amountAvailable:!1,availableBalance:null},e.errorMessage="",e.precisionTwo=2,e.currencyFormat=i.hotelDetails.currency_format&&i.hotelDetails.currency_format.value,e.$on("REMOVE_PAYMENT_TYPE",function(t,a){e.paymentTypes=_.without(e.paymentTypes,_.findWhere(e.paymentTypes,{name:a.paymentType}))}),void 0!==e.allowDirectBill&&!e.allowDirectBill)var G=e.$watch("paymentTypes",function(){void 0!==e.paymentTypes&&p()});e.isGCBalanceShort=function(){var t=void 0;return"GIFT_CARD"===e.selectedPaymentType&&(t=parseFloat(e.payment.amount),e.feeData&&(t=parseFloat(e.feeData.totalOfValueAndFee)),t<0||e.giftCard.availableBalance&&parseFloat(e.giftCard.availableBalance)<t)},e.checkWorkStationMandatoryFields=function(){t.checkWorkStationMandatoryFields(e.hotelConfig.workstationId).then(function(t){return e.workStationStatus=t.workstation_active,t.workstation_active||(e.errorMessage=["Workstation needs to be set up in order to proceed with payment"]),e.workStationStatus},function(t){return e.workStationStatus=!0,e.workStationStatus})};var x=function(){return e.isRefund()&&e.receiptsList&&!e.payment.receipt_id&&"DB"!==e.selectedPaymentType};e.shouldHidePaymentButton=function(){return!e.workStationStatus||!e.selectedPaymentType||!e.hasPermission||e.isGCBalanceShort()||!e.splitBillEnabled&&e.paymentAttempted&&!e.isPaymentFailure||x()},e.showSelectedCard=function(){var t=(e.hotelConfig,!("CC"!==e.selectedPaymentType||!e.selectedCC||!e.selectedCC.ending_with&&!e.selectedCC.card_number)),a=O&&e.payment.isManualEntryInsideIFrame,n="CBA_AND_MLI"===e.hotelConfig.paymentGateway&&!e.payment.isAddPaymentMode;
return!f()&&t&&"PAYMENT_MODE"===e.payment.screenMode&&(a||!O)&&!n},e.toggleManualIframe=function(){e.payment.isManualEntryInsideIFrame?g():(e.payment.showAddToGuestCard=!!e.reservationId&&!e.payment.isManualEntryInsideIFrame,e.selectedCC={}),N()},e.toggleCCMOde=function(t){"GIFT_CARD"===t?(e.selectedPaymentType="GIFT_CARD",e.onPaymentInfoChange()):(e.selectedPaymentType="CC",e.onPaymentInfoChange()),"ADD_CARD"===t&&v(),r(function(){e.payment.addCCMode=t},350)},e.cancelAction=function(t){e.$emit("PAYMENT_ACTION_CANCELLED",t)},e.closeThePopup=function(){e.$emit("CLOSE_DIALOG")},e.payLater=function(){e.$emit("PAY_LATER",{paymentType:e.selectedPaymentType,cardDetails:e.selectedCC,addToGuestCard:e.payment.addToGuestCardSelected})},e.continueAction=function(t){e.$emit("PAYMENT_ACTION_CONTINUE",t)},e.resetPaymentAttempt=function(){e.paymentAttempted=!1,e.isPaymentFailure=!1};var B=function(t){var a=void 0;return a="ADYEN"===e.hotelConfig.paymentGateway?{cardDisplayData:{card_code:t.card_type?t.card_type.toLowerCase():"",ending_with:t.ending_with,expiry_date:t.expiry_date,name_on_card:t.card_name},apiParams:{name_on_card:t.card_name}}:e.payment.tokenizedCardData};e.saveReservationPaymentMethod=function(){var a=void 0;if("CC"===e.selectedPaymentType&&"CBA"===e.hotelConfig.paymentGateway&&!e.payment.tokenizedCardData)return void e.$broadcast("INITIATE_CBA_TOKENIZATION");if("CC"===e.selectedPaymentType&&O&&!e.payment.isManualEntryInsideIFrame&&!e.payment.tokenizedCardData)return a={workstation_id:e.hotelConfig.workstationId,bill_number:e.billNumber},"ADD_PAYMENT_GUEST_CARD"===e.actionType?angular.extend(a,{guest_id:e.guestId,add_to_guest_card:!0}):("ADD_PAYMENT_STAY_CARD"===e.actionType&&(a.guest_id=e.guestId),e.reservationId&&(a.reservation_id=e.reservationId),e.accountId&&(a.account_id=e.accountId),e.groupId&&(a.group_id=e.groupId),e.allotmentId&&(a.allotment_id=e.allotmentId),a.add_to_guest_card=e.payment.addToGuestCardSelected),void e.$broadcast("INITIATE_CHIP_AND_PIN_TOKENIZATION",a);if("ADD_PAYMENT_GUEST_CARD"===e.actionType){var n=void 0;m.start("ADD_PAYMENT_GUEST_CARD"),t.addCardToGuest(_extends({},e.payment.tokenizedCardData.apiParams,{add_to_guest_card:!0,workstation_id:e.hotelConfig.workstationId,user_id:e.guestId})).then(function(t){n=B(t.data),e.$emit("SUCCESS_LINK_PAYMENT",{response:t.data,selectedPaymentType:e.selectedPaymentType,cardDetails:{card_code:n.cardDisplayData.card_code,ending_with:n.cardDisplayData.ending_with,expiry_date:n.cardDisplayData.expiry_date,card_name:n.cardDisplayData.name_on_card}}),m.stop("ADD_PAYMENT_GUEST_CARD")},function(t){e.$emit("ERROR_OCCURED",t),m.stop("ADD_PAYMENT_GUEST_CARD")})}else"CC"===e.selectedPaymentType&&"ADD_PAYMENT_CO_TA"===e.actionType&&e.payment.tokenizedCardData&&e.payment.tokenizedCardData.apiParams?(m.start("ADD_PAYMENT"),t.savePaymentDetails(_extends({},e.payment.tokenizedCardData.apiParams,{workstation_id:e.hotelConfig.workstationId,account_id:e.accountId,is_from_wallet:e.isFromWallet})).then(function(t){var a=B(t.data);e.$emit("SUCCESS_LINK_PAYMENT",{response:_extends({},t.data,{addToGuestCard:e.payment.addToGuestCardSelected}),selectedPaymentType:e.selectedPaymentType,cardDetails:{card_code:a.cardDisplayData.card_code,ending_with:a.cardDisplayData.ending_with,expiry_date:a.cardDisplayData.expiry_date,card_name:a.apiParams.name_on_card||a.apiParams.card_name}}),m.stop("ADD_PAYMENT")},function(t){e.$emit("ERROR_OCCURED",t),m.stop("ADD_PAYMENT")})):"CC"===e.selectedPaymentType&&/^ADD_PAYMENT_/.test(e.actionType)&&e.payment.tokenizedCardData&&e.payment.tokenizedCardData.apiParams?(m.start("ADD_PAYMENT"),t.savePaymentDetails(_extends({},e.payment.tokenizedCardData.apiParams,{workstation_id:e.hotelConfig.workstationId,reservation_id:e.reservationId,bill_number:e.billNumber,add_to_guest_card:e.payment.addToGuestCardSelected})).then(function(t){var a=B(t.data);e.$emit("SUCCESS_LINK_PAYMENT",{response:_extends({},t.data,{addToGuestCard:e.payment.addToGuestCardSelected}),selectedPaymentType:e.selectedPaymentType,cardDetails:{card_code:a.cardDisplayData.card_code,ending_with:a.cardDisplayData.ending_with,expiry_date:a.cardDisplayData.expiry_date,card_name:a.apiParams.name_on_card||a.apiParams.card_name}}),m.stop("ADD_PAYMENT")},function(t){e.$emit("ERROR_OCCURED",t),m.stop("ADD_PAYMENT")})):"CC"!==e.selectedPaymentType?(m.start("ADD_PAYMENT_CC"),t.savePaymentDetails({bill_number:e.billNumber,reservation_id:e.reservationId,payment_type:e.selectedPaymentType,workstation_id:e.hotelConfig.workstationId}).then(function(t){e.$emit("SUCCESS_LINK_PAYMENT",{response:t.data,selectedPaymentType:e.selectedPaymentType}),m.stop("ADD_PAYMENT_CC")},function(t){e.$emit("ERROR_OCCURED",t),m.stop("ADD_PAYMENT_CC")})):e.accountId||e.groupId||e.allotmentId?e.$emit("SUCCESS_LINK_PAYMENT",{selectedPaymentType:e.selectedPaymentType,cardDetails:e.selectedCC}):e.payment.tokenizedCardData&&e.payment.tokenizedCardData.apiParams.mli_token?(m.start("ADD_PAYMENT_SWIPE"),t.savePaymentDetails(_extends({},e.payment.tokenizedCardData.apiParams,{bill_number:e.billNumber,reservation_id:e.reservationId,payment_type:e.selectedPaymentType,workstation_id:e.hotelConfig.workstationId})).then(function(t){e.$emit("SUCCESS_LINK_PAYMENT",{response:t.data,selectedPaymentType:e.selectedPaymentType,cardDetails:e.selectedCC}),m.stop("ADD_PAYMENT_SWIPE")},function(t){e.$emit("ERROR_OCCURED",t),m.stop("ADD_PAYMENT_SWIPE")})):e.reservationId&&(m.start("ADD_EXISTING_PAYMENT_TYPE"),t.mapPaymentToReservation({bill_number:e.billNumber,reservation_id:e.reservationId,payment_type:e.selectedPaymentType,workstation_id:e.hotelConfig.workstationId,user_payment_type_id:e.selectedCC.value,add_to_guest_card:e.payment.addToGuestCardSelected}).then(function(t){e.$emit("SUCCESS_LINK_PAYMENT",{response:t.data,selectedPaymentType:e.selectedPaymentType,cardDetails:e.selectedCC}),m.stop("ADD_EXISTING_PAYMENT_TYPE")},function(t){e.$emit("ERROR_OCCURED",t),m.stop("ADD_EXISTING_PAYMENT_TYPE")}))};var H=function(t){r(function(){d.open({template:"/assets/partials/payCreateARPopup.html",controller:"payCreateARPopupCtrl",className:"",scope:e,data:JSON.stringify(t)})},0)};e.$on("NEW_AR_ACCOUNT_CREATED",function(){e.submitPayment({is_new_ar_account:!0})}),e.$on("CONTINUE_DIRECT_BILL_PAYMENT",function(t,a){var n=a.arDetails;"company"===a.ar_type?n.company_ar_attached?e.submitPayment({ar_type:"company"}):H({account_id:n.company_id,is_auto_assign_ar_numbers:n.is_auto_assign_ar_numbers}):"travel_agent"===a.ar_type&&(n.travel_agent_ar_attached?e.submitPayment({ar_type:"travel_agent"}):H({account_id:n.travel_agent_id,is_auto_assign_ar_numbers:n.is_auto_assign_ar_numbers}))}),e.$on(a.ERROR_OCCURED,function(t,a){r(function(){e.errorMessage=a},100)}),e.$on(a.CLEAR_ERROR_MSG,function(t){r(function(){e.errorMessage=""},100)}),e.submitAccountPayment=function(){"DB"===e.selectedPaymentType?t.checkARStatus(e.postingAccountId).then(function(t){t.company_present&&t.travel_agent_present?e.$emit("SHOW_AR_SELECTION",t):t.company_present?t.company_ar_attached?e.submitPayment({ar_type:"company"}):l.getPermissionValue("CREATE_AR_ACCOUNT")?H({account_id:t.company_id,is_auto_assign_ar_numbers:t.is_auto_assign_ar_numbers}):(e.account_id=t.company_id,d.open({template:"/assets/partials/payment/rvAccountReceivableMessagePopup.html",controller:"RVAccountReceivableMessagePopupCtrl",className:"",scope:e})):t.travel_agent_present?t.travel_agent_ar_attached?e.submitPayment({ar_type:"travel_agent"}):l.getPermissionValue("CREATE_AR_ACCOUNT")?H({account_id:t.travel_agent_id,is_auto_assign_ar_numbers:t.is_auto_assign_ar_numbers}):(e.account_id=t.travel_agent_id,d.open({template:"/assets/partials/payment/rvAccountReceivableMessagePopup.html",controller:"RVAccountReceivableMessagePopupCtrl",className:"",scope:e})):e.errorMessage=[s("translate")("ACCOUNT_ID_NIL_MESSAGE_PAYMENT")]},function(t){e.$emit("PAYMENT_FAILED",t),e.$emit("hideLoader")}):e.submitPayment()};var U=null,V=function(t){r(function(){d.open({template:"/assets/partials/rvConfirmDirectBillPaymentPopup.html",className:"",controller:"confirmDirectBillPopupCtrl",scope:e,closeByDocument:!1,data:JSON.stringify(t)})},0)};i.$on("ngDialog.opened",function(e,t){U=t.attr("id")}),e.$on("CONFIRMED_DB_PAYMENT",function(t,a){e.payment.isConfirmedDBpayment=!0,e.submitPayment(a)});var K=function(){e.$emit("SHOW_BILL_PAYMENT_POPUP"),d.close(U)};e.$on("CANCELLED_CONFIRM_DB_PAYMENT",function(){K()});var z=function(){return!e.hotelConfig.isStandAlone&&i.hotelDetails.enable_emv_for_overlay&&"DEPOSIT_BALANCE_PAYMENT"===e.actionType};e.submitPayment=function(a){var n,o,r=["Please enter a valid amount"];return t.isValidAmount(e.payment.amount)?(e.errorMessage="",o=y(a),o.isShift4Request="SHIFT4"===e.hotelConfig.paymentGateway&&"CC"===e.selectedPaymentType,"CC"!==e.selectedPaymentType||"sixpayments"!==e.hotelConfig.paymentGateway&&("SHIJI"!==e.hotelConfig.paymentGateway||i.hotelDetails.shiji_token_enable_offline)&&!z()||e.payment.isManualEntryInsideIFrame?"CC"===e.selectedPaymentType&&O&&!e.payment.isManualEntryInsideIFrame?void e.$broadcast("INITIATE_CHIP_AND_PIN_PAYMENT",o):"CC"===e.selectedPaymentType&&"CBA"===e.hotelConfig.paymentGateway?void e.$broadcast("INITIATE_CBA_PAYMENT",o):"CBA"===e.selectedPaymentType&&"CBA_AND_MLI"===e.hotelConfig.paymentGateway?void(k||t.mockCba?e.$broadcast("INITIATE_CBA_PAYMENT",o):e.errorMessage=e.errorMessage=[s("translate")("USE_IPAD_TO_USE_CBA")]):"SHIJI"!==e.hotelConfig.paymentGateway||"ALIPAY"!==e.selectedPaymentType&&"WECHAT"!==e.selectedPaymentType?"DB"!==e.selectedPaymentType||e.payment.isConfirmedDBpayment?(n="CC"===e.selectedPaymentType&&e.selectedCard!==-1?e.selectedCC.value:null,"GIFT_CARD"===o.postData.payment_type?o.postData.card_number=$.trim(e.giftCard.number):o.postData.payment_type_id=n,e.isPenalty&&(o.postData.is_cancellation_penalty=!0),m.start("SUBMIT_PAYMENT"),void t.submitPayment(o).then(function(t){e.onPaymentSuccess(t),m.stop("SUBMIT_PAYMENT"),e.payment.isConfirmedDBpayment&&d.close()},function(t){"DB"===e.selectedPaymentType&&e.payment.isConfirmedDBpayment&&(K(),e.payment.isConfirmedDBpayment=!1),T(t)})):(e.$emit("HIDE_BILL_PAYMENT_POPUP"),void V(o.postData)):void e.$broadcast("INITIATE_SHIJI_PAYMENT",o):void e.$broadcast("INITIATE_CHIP_AND_PIN_PAYMENT",o)):void(e.errorMessage=r)},e.onChangeGiftCard=function(){var a=e.giftCard.number.length;a>=8&&a<=22?(m.start("FETCH_GIFT_CARD_BALANCE"),t.fetchGiftCardBalance(e.giftCard.number).then(function(t){e.giftCard.availableBalance=t.amount,e.giftCard.amountAvailable=!0,m.stop("FETCH_GIFT_CARD_BALANCE")},function(t){e.giftCard.amountAvailable=!1,e.errorMessage=t,m.stop("FETCH_GIFT_CARD_BALANCE")})):(e.giftCard.amountAvailable=!1,e.giftCard.availableBalance=null)},e.onPaymentInfoChange=function(t,a){if("AR_REFUND_PAYMENT"===e.actionType)return!1;t&&(e.payment.selectedPaymentCurrencyId=i.hotelCurrencyId,e.payment.selectedPaymentCurrencySymbol=i.currencySymbol,e.payment.amount=L,e.feeData.calculatedFee=e.originalFee),_.find(e.paymentTypes,{name:e.selectedPaymentType})||(e.selectedPaymentType="");var n=void 0;a?N(!0):N(),n=_.find(e.paymentTypes,{name:e.selectedPaymentType}),""!==e.selectedPaymentType&&e.$emit("PAYMENT_TYPE_CHANGED",e.selectedPaymentType),"DB"===e.selectedPaymentType?(e.payment.isEditable=!1,e.splitBillEnabled=!1,e.payment.amount=L,N()):e.payment.isEditable=void 0===e.isEditable||Boolean(e.isEditable),a&&e.payment.paymentCurrencyAmount&&(e.payment.amount=parseFloat(e.payment.paymentCurrencyAmount).toFixed(2)),n&&"CC"===n.name?((t||a)&&(e.payment.amount=L),e.payment.showAddToGuestCard=!!e.reservationId&&!e.payment.isManualEntryInsideIFrame,t&&"CC"===e.selectedPaymentType&&("SHIJI"===e.hotelConfig.paymentGateway&&i.hotelDetails.shiji_token_enable_offline||"ADYEN"===e.hotelConfig.paymentGateway)?g():o[e.hotelConfig.paymentGateway].iFrameUrl?(e.selectedCC=e.selectedCC||{},"CARD_ADD_MODE"===e.payment.screenMode||e.selectedCC.value||(e.payment.isManualEntryInsideIFrame=!1,e.selectedCC={}),e.payment.showAddToGuestCard=!!e.reservationId&&!e.payment.isManualEntryInsideIFrame):e.hotelConfig.isEMVEnabled&&"SHIFT4"!==e.hotelConfig.paymentGateway?(e.selectedCC=e.selectedCC||{},"CARD_ADD_MODE"===e.payment.screenMode||e.selectedCC.value||(e.payment.isManualEntryInsideIFrame=!1,e.selectedCC={}),e.payment.showAddToGuestCard=!!e.reservationId&&!e.payment.isManualEntryInsideIFrame):f()||e.showSelectedCard()||z()||g()):e.payment.showAddToGuestCard=!1,e.$emit("AMOUNT_UPDATED",e.payment.amount)},e.onPaymentCurrencyChange=function(){e.payment.selectedPaymentCurrencySymbol=_.find(e.paymentCurrencyList,{id:e.payment.selectedPaymentCurrencyId}).symbol;var a={amount:parseFloat(L),fee:parseFloat(e.originalFee),currency_id:parseInt(e.payment.selectedPaymentCurrencyId),date:i.businessDate};t.getConvertedAmount(a).then(function(t){e.payment.amount=t.data.converted_amount,e.feeData.calculatedFee=t.data.converted_fee,e.feeData.totalOfValueAndFee=parseFloat(e.payment.amount)+parseFloat(e.feeData.calculatedFee)},function(e){})},e.onFeeOverride=function(){var t=(parseFloat(e.feeData.calculatedFee)||0)+parseFloat(e.payment.amount);e.feeData.totalOfValueAndFee=t.toFixed(2)},e.propagateAddToggle=function(){e.$emit("PAYMENT_TOGGLE_ATTACH_TO_GUEST_CARD",e.payment.addToGuestCardSelected)},e.onCardClick=function(){g(),v()},e.cancelCardSelection=function(){e.errorMessage="",e.payment.screenMode="PAYMENT_MODE",e.payment.showAddToGuestCard=!1,e.selectedPaymentType="",e.$emit("PAYMENT_TYPE_CHANGED",e.selectedPaymentType),e.selectedCC={},N(),v()},e.setCreditCardFromList=function(t){var a=_.find(e.payment.linkedCreditCards,{value:t});e.selectedCC=a,e.payment.showAddToGuestCard=!1,e.payment.screenMode="PAYMENT_MODE",e.payment.amount=L,e.payment.tokenizedCardData=null,N()},e.hideCardToggles=function(){return"ADD_PAYMENT_GUEST_CARD"===e.actionType||"ADD_ROUTE_PAYMENT"===e.actionType||!h()};var W=function(t){e.$emit("hideLoader"),e.payment.linkedCreditCards=_.where(t.existing_payments,{is_credit_card:!0}),e.payment.shiji_token_enable_offline=t.shiji_token_enable_offline,e.payment.linkedCreditCards.length>0&&C("cardsList")},X=function(){if(e.reservationId){var a={billNumber:e.billNumber,reservationId:e.reservationId};m.start("FETCH_ATTACHED_CARDS"),t.getLinkedCardList(a).then(function(e){W(e),m.stop("FETCH_ATTACHED_CARDS")},function(t){e.$emit("PAYMENT_FAILED",t),m.stop("FETCH_ATTACHED_CARDS")})}else e.accountId?(m.start("FETCH_ATTACHED_CARDS"),t.getCoTaLinkedCardList(e.accountId).then(function(e){W(e),m.stop("FETCH_ATTACHED_CARDS")},function(t){e.$emit("PAYMENT_FAILED",t),m.stop("FETCH_ATTACHED_CARDS")})):e.postingAccountId?(m.start("FETCH_ATTACHED_CARDS"),t.getAccountsLinkedCardList(e.postingAccountId).then(function(e){W(e),m.stop("FETCH_ATTACHED_CARDS")},function(t){e.$emit("PAYMENT_FAILED",t),m.stop("FETCH_ATTACHED_CARDS")})):e.payment.linkedCreditCards=[]};e.$on(a.CC_TOKEN_GENERATED,function(t,a){var n=a.paymentData;e.payment.amount=L,e.errorMessage="",/^ADD_PAYMENT_/.test(e.actionType)||n.apiParams.mli_token?(P(),e.payment.tokenizedCardData=n,e.selectedCC=e.selectedCC||{},e.selectedCC.card_code=n.cardDisplayData.card_code,e.selectedCC.ending_with=n.cardDisplayData.ending_with,e.selectedCC.expiry_date=n.cardDisplayData.expiry_date,e.selectedCC.holder_name=n.apiParams.name_on_card||n.apiParams.card_name,r(function(){e.selectedPaymentType="CC",e.payment.screenMode="PAYMENT_MODE",a.forceSaveRoutine&&e.saveReservationPaymentMethod()},600)):e.payment.tokenizedCardData=null,"AR_SUBMIT_PAYMENT"===e.actionType?w(n):/^ADD_PAYMENT_/.test(e.actionType)||M(n),"ADYEN"!==e.hotelConfig.paymentGateway&&r(function(){v()},600)}),e.isRefund=function(){return e.payment.amount<0},e.showGiftCardToggle=function(){var t=_.find(e.paymentTypes,{name:"GIFT_CARD"});return!e.hotelConfig.isStandAlone&&!!t&&!e.hideOverlayGiftcard},e.onPaymentSuccess=function(t){e.paymentAttempted=!(e.splitBillEnabled&&e.numSplits>e.completedSplitPayments),e.isPaymentFailure=!1,e.payment.authorizationCode=t.authorization_code,t.amountPaid=t.amount,t.authorizationCode=t.authorization_code,t.selectedPaymentType=e.selectedPaymentType,t.selectedPaymentTypeDescription=_.findWhere(e.paymentTypes,{name:e.selectedPaymentType}).description,e.feeData&&(t.feePaid=e.feeData.calculatedFee,t.showFee=e.feeData.showFee),"CC"===e.selectedPaymentType&&(t.cc_details=angular.copy(e.selectedCC)),e.payment.showAddToGuestCard&&(t.add_to_guest_card=e.payment.addToGuestCardSelected),"AR_SUBMIT_PAYMENT"===e.actionType&&(t.allocatePaymentAfterPosting=e.payment.allocatePaymentAfterPosting),e.$emit("PAYMENT_SUCCESS",t)},e.clearErrorMessage=function(){e.errorMessage=""},e.showEmvModeSelection=function(){var t="MLI"===e.hotelConfig.paymentGateway&&e.hotelConfig.isEMVEnabled||"CBA_AND_MLI"===e.hotelConfig.paymentGateway&&e.hotelConfig.isEMVEnabled&&e.payment.isAddCardAction,a=!e.paymentAttempted||e.isPaymentFailure||e.splitBillEnabled&&e.numSplits>e.completedSplitPayments;return(t||"sixpayments"===e.hotelConfig.paymentGateway||"SHIJI"===e.hotelConfig.paymentGateway&&!i.hotelDetails.shiji_token_enable_offline||"SHIFT4"===e.hotelConfig.paymentGateway||z())&&"CC"===e.selectedPaymentType&&"PAYMENT_MODE"===e.payment.screenMode&&a&&"AR_REFUND_PAYMENT"!==e.actionType},e.getShijiToken=function(){e.$broadcast("GET_SHIJI_TOKEN")},e.getShijiOfflineStatus=function(){return i.hotelDetails.shiji_token_enable_offline},function(){var a=void 0,n=void 0;if(e.actionType=e.actionType||"DEFAULT",e.fetchLinkedCards!==!1&&(e.fetchLinkedCards=!0),e.payment.isAddPaymentMode=!!e.actionType.match(/^ADD_PAYMENT/),e.$watch("amount",R),e.$watch("paymentCurrencyAmount",b),e.$watch("paymentTypes",function(){e.payment.creditCardTypes=S()}),e.$watch("isEditable",A),e.payment.amount=e.amount||0,e.payment.paymentCurrencyAmount=e.paymentCurrencyAmount||0,e.payment.isRateSuppressed=e.isRateSuppressed||!1,e.payment.isPenalty=e.isPenalty||!1,e.billNumber=e.billNumber||1,e.payment.linkedCreditCards=e.linkedCreditCards||[],e.payment.screenMode="PAYMENT_MODE",e.payment.addCCMode="ADD_CARD",e.payment.creditCardTypes=S(),e.payment.guestFirstName=e.firstName||"",e.payment.guestLastName=e.lastName||"",!e.hotelConfig)throw new Error("Need hotel config to proceed. Need the following params.\n isStandAlone, paymentGateway, workstationId, emvTimeout, mliMerchantId, and currencySymbol");e.hotelConfig.mliMerchantId=e.hotelConfig.mliMerchantId||"",e.hotelConfig.workstationId=e.workstationId||"",e.hotelConfig.emvTimeout=e.hotelConfig.emvTimeout||120,e.hotelConfig.paymentGateway=e.hotelConfig.paymentGateway||"","CBA"===e.hotelConfig.paymentGateway||"CBA_AND_MLI"===e.hotelConfig.paymentGateway?D():"SHIJI"===e.hotelConfig.paymentGateway&&I(),e.currencySymbol=e.hotelConfig.currencySymbol,e.fetchLinkedCards&&!f()&&X(),e.$emit("SET_SCROLL_FOR_EXISTING_CARDS"),"sixpayments"!==e.hotelConfig.paymentGateway&&"SHIJI"!==e.hotelConfig.paymentGateway||(e.payment.isManualEntryInsideIFrame=!0,e.payment.showAddToGuestCard=!e.payment.isManualEntryInsideIFrame),a=t.resolvePaths(e.hotelConfig.paymentGateway,{card_holder_first_name:e.payment.guestFirstName,card_holder_last_name:e.payment.guestLastName}),e.payment.iFrameUrl=a.iFrameUrl,e.paymentGatewayUIInterfaceUrl=a.paymentGatewayUIInterfaceUrl,e.payment.isAddCardAction=t.isAddCardAction(e.actionType),e.swipedCardData&&r(function(){O&&(e.payment.isManualEntryInsideIFrame=!0,e.toggleManualIframe()),e.$broadcast("RENDER_SWIPED_DATA",JSON.parse(e.swipedCardData))},300),e.hotelConfig.isStandAlone||f()||"CBA_AND_MLI"===e.hotelConfig.paymentGateway||z()||g(),r(function(){e.onPaymentInfoChange(!1,!0)},1e3),u("cardsList",{click:!0,tap:!0}),e.$watch("payment.screenMode",function(){e.$emit("PAYMENT_SCREEN_MODE_CHANGED",e.payment.screenMode)}),n=e.hotelConfig,O="sixpayments"===n.paymentGateway||"SHIFT4"===n.paymentGateway||"SHIJI"===n.paymentGateway&&!i.hotelDetails.shiji_token_enable_offline||("MLI"===n.paymentGateway||"CBA_AND_MLI"===n.paymentGateway)&&n.isEMVEnabled,e.paymentAttempted=!1,e.workStationStatus=!0,e.showSelectedCard(),i.isWorkStationMandatory&&e.checkWorkStationMandatoryFields(),"CC"===e.selectedPaymentType&&e.selectedCC&&"SHIJI"===e.hotelConfig.paymentGateway&&i.hotelDetails.shiji_token_enable_offline&&(e.payment.auth_code=e.selectedCC.auth_code)}()}]);