"use strict";angular.module("snt.utils",[]),angular.module("snt.utils").service("Toggles",["$q","sntBaseWebSrv",function(e,t){var a,n=this;n.initialize=function(){var n=e.defer();return t.getJSON("/api/features/list").then(function(e){a=e,n.resolve(e)}),n.promise},n.isEnabled=function(e){if(!a)throw new Error("Attempt to access feature toggles without initializing");return a[e]===!0||angular.isUndefined(a[e])}}]),angular.module("snt.utils").service("sntLoadScriptSrv",["$q","$timeout",function(e,t){var a=this,n={},r="https://apis.google.com/js/api.js";a.loadScript=function(a){var r=e.defer();return n[a]?t(function(){r.resolve()},100):$.getScript(a).done(function(){n[a]=!0,r.resolve()}).fail(function(e,t,a){r.reject(a)}),r.promise},a.getGAPIUrl=function(){return r}}]),angular.module("snt.utils").service("sntNotifySrv",[function(){var e=this;e.setConfiguration=function(e){switch(e){default:toastr.options.preventDuplicates=!0,toastr.options.showDuration=1e3,toastr.options.hideDuration=1e3,toastr.options.timeOut=8e3}},e.show=function(t,a){angular.isArray(t)&&(t=t.join(", ")),e.setConfiguration(a||null),toastr[a||"warning"](t)}}]),angular.module("snt.utils").component("sntNotify",{template:'<div ng-if="!$ctrl.showToasts" ng-show="$ctrl.message && $ctrl.message.length"           ng-class="$ctrl.style"           ng-click="$ctrl.clearErrorMessage()">               <section ng-if="$ctrl.type === \'success\'">                   <span>{{$ctrl.message}}</span>               </section>               <section ng-if="$ctrl.type !== \'success\'"                  ng-switch on="$ctrl.message.length">                  <span class="close-btn" ng-click="$ctrl.clearErrorMessage()"></span>                  <span ng-switch-when="1">{{$ctrl.message[0]}}</span>                  <span ng-switch-default>                     <span ng-repeat="item in $ctrl.message track by $index" >                        <span ng-if=!$last>{{item}},</span>                        <span ng-if=$last> {{item}}</span>                     </span>                  </span>               </section>       </div>',transclude:!0,bindings:{message:"<",type:"@"},controller:["sntNotifySrv","Toggles","$scope",function(e,t,a){var n=this;n.clearErrorMessage=function(){this.message="",a.$emit("CLEAR_ERROR_MSG")},n.$onInit=function(){n.style="notice",n.style+="success"===n.type?" success success-message":" error error-message",n.showToasts=t.isEnabled("show_toast_notifications"),n.$onChanges=function(t){t.message=t.message||{},n.showToasts&&t.message.currentValue&&t.message.currentValue.length&&e.show(t.message.currentValue,n.type)},n.$doCheck=function(){n.showToasts&&this.message&&0!==this.message.length&&(e.show(this.message,n.type),n.clearErrorMessage())}}}]}),angular.module("snt.utils").directive("sntPlaceholder",function(){return{restrict:"A",scope:{model:"=ngModel",text:"@sntPlaceholder"},link:function(e,t){e.model=e.model||null,e.text=e.text||"SELECT",e.$watch("model",function(){e.model=e.model||null}),t.append('<option value="" disabled translate>'+e.text+"</option>")}}}),angular.module("snt.utils").service("sessionTimeoutHandlerSrv",["$timeout",function(e){var t,a,n,r=this;r.initWorker=function(){t=new Worker("/ui/pms-ui/shared/sntUtils/workers/sessionTimeoutWorker.js"),e(function(){t.postMessage("init")},500)},r.getWorker=function(){return t},r.resetTimer=function(){t.postMessage({cmd:"START_TIMER",interval:a})},r.showSessionTimeoutPopup=function(e){t.postMessage({cmd:"SHOW_TIMEOUT_POPUP",isApiTokenExpired:e})},r.hideLoader=function(){t.postMessage({cmd:"HIDE_LOADER"})},r.stopTimer=function(){t.postMessage({cmd:"STOP_TIMER"})},r.setAutoLogoutDelay=function(e){a=e},r.getAutoLogoutDelay=function(){return a},r.setLoginEmail=function(e){n=e},r.getLoginEmail=function(){return n}}]),angular.module("snt.utils").service("sntSharedLoginSrv",["$q","sntBaseWebSrv",function(e,t){var a,n=this;n.login=function(a){var n=e.defer();return t.postJSON("/login/submit",a).then(function(e){"success"===e.status?n.resolve(e):n.reject(e)},function(e){n.reject(e)}),n.promise},n.logout=function(){return t.getJSON("/logout")},n.getSessionDetails=function(){var n=e.defer(),r="/api/users/login_details";return a?n.resolve(a):t.getJSON(r).then(function(e){a=e,n.resolve(e)}),n.promise},n.refreshToken=function(){var a=e.defer(),n="/login/validate";return t.getJSON(n).then(function(e){a.resolve(e)}),a.promise}}]),angular.module("snt.utils").factory("sharedSessionTimeoutInterceptor",["$q","$window","sessionTimeoutHandlerSrv","$injector",function(e,t,a,n){return{request:function(e){return e},response:function(e){return e.headers("Auth-Token")&&a.getWorker()&&a.getAutoLogoutDelay()&&a.resetTimer(),e},responseError:function(r){r.handledCodes=r.handledCodes||[];var o=n.get("$state");return 401===r.status&&"top"!==o.current.name&&""!==o.current.name&&"/logout"!==r.config.url&&(t.localStorage.removeItem("jwt"),a.showSessionTimeoutPopup(!0),r.handledCodes.push(401)),e.reject(r)}}}]),angular.module("snt.utils").directive("sntSessionTimeout",function(){var e=["$scope","sessionTimeoutHandlerSrv","ngDialog","sntSharedLoginSrv","$rootScope","sntActivity","$timeout","sntAuthorizationSrv","$window",function(e,t,a,n,r,o,i,s,d){var c;e.loginData={};var l="account has been locked",m=function(){r.$broadcast("resetLoader"),d.localStorage.removeItem("jwt"),c||(e.loginData.autoLogoutDelay=Math.floor(t.getAutoLogoutDelay()/1e3/60<<0),c=a.open({template:"/assets/partials/rvExtendSessionModal.html",className:"ngdialog-theme-default",scope:e,closeByEscape:!1,closeByDocument:!1}))};e.continueSession=function(){var r={email:t.getLoginEmail(),password:e.loginData.password};e.hasError=!1,e.errorMessage="",o.start("API_REQ"),n.login(r).then(function(t){"success"===t.status&&(a.close(c.id),c=null,e.loginData={}),o.stop("API_REQ")},function(t){e.hasError="failure"===t.status,e.errorMessage=_.isArray(t.errors)?t.errors[0]:"",e.loginData.password="",o.stop("API_REQ"),e.errorMessage&&e.errorMessage.indexOf(l)>-1&&i(function(){d.location.href="/logout"},500)})},e.logout=function(){o.start("API_REQ"),n.logout().finally(function(){i(function(){t.getWorker()&&t.stopTimer(),o.stop("API_REQ"),d.location.href="/logout"})})};var u=function(){var e=function(e){e.auto_logout_delay&&t.setAutoLogoutDelay(1e3*e.auto_logout_delay),t.setLoginEmail(e.login),f()};t.getAutoLogoutDelay()||n.getSessionDetails().then(e)};e.$on("CLOSE_SESSION_TIMEOUT_POPUP",function(){c&&c.close()}),e.$on("SET_HOTEL",function(){u()});var p=function(){n.refreshToken().then(function(){})},y=function(){var e=0;return $(document).idleTimer("isIdle")&&(e=Math.floor($(document).idleTimer("getElapsedTime")/1e3)),e},C=function(e){var a=Math.floor(t.getAutoLogoutDelay()/1e3);y()+30>a-15||e?m():p()},f=function(){$(document).idleTimer({timeout:3e4,timerSyncId:"sntIdleTimer"}),$(document).on("idle.idleTimer",function(){c||p()}),d.document.addEventListener("wheel",function(){$(document).idleTimer("reset")},!0)},A=function(){t.getWorker()||(t.initWorker(),i(function(){t.getWorker().addEventListener("message",function(e){var t=e.data;switch(t.cmd){case"SHOW_TIMEOUT_POPUP":C(t.isApiTokenExpired)}})},500))};A()}];return{restrict:"EA",require:"^ngModel",controller:e}});var iFrameParams={card_holder_first_name:"",card_holder_last_name:"",service_action:"createtoken",time:""};angular.module("sntPayConfig",[]).constant("PAYMENT_CONFIG",Object.freeze({CBA:{iFrameUrl:null,jsLibrary:null,partial:"/assets/partials/payCBAPartial.html",params:null,disableCardSelection:!0},SHIJI:{iFrameUrl:"/api/ipage/shiji",jsLibrary:null,partial:"/assets/partials/payShijiPartial.html",params:iFrameParams},MLI:{iFrameUrl:null,jsLibrary:"https://cnp.merchantlink.com/form/v2.1/hpf.js",partial:"/assets/partials/payMLIPartial.html",params:null},SAFERPAY:{iFrameUrl:null,jsLibrary:null,partial:"/assets/partials/payMLIPartial.html",params:null},sixpayments:{iFrameUrl:"/api/ipage/index.html",params:iFrameParams,jsLibrary:null,partial:"/assets/partials/paySixPaymentPartial.html"},SHIFT4:{iFrameUrl:"/api/ipage/shift4",partial:"/assets/partials/payShift4Partial.html",params:iFrameParams},ADYEN:{iFrameUrl:"/api/ipage/adyen",partial:"/assets/partials/payAdyenPartial.html",params:iFrameParams}}));var payTemplateApp=angular.module("sntPayTemplates",[]);angular.module("sntPay",["pascalprecht.translate","oc.lazyLoad","ng-iscroll","ngDialog","sharedHttpInterceptor","sntActivityIndicator","snt.utils"]),angular.module("sntPay").constant("paymentConstants",function(){var e={AMEX:"AX",DINERS_CLUB:"DC",DISCOVER:"DS",JCB:"JCB",MASTERCARD:"MC",VISA:"VA"},t={CARD_ADD_MODE:"PAYMENTAPP_CARD_ADD_MODE"};return{creditCardMappingTypes:e,modes:t}}()),angular.module("sntPay").constant("paymentAppEventConstants",{RESET_CARD_DETAILS:"PAYMENTAPP_RESET_CARD_DETAILS",CC_TOKEN_GENERATED:"PAYMENTAPP_CC_TOKEN_GENERATED",ERROR_OCCURED:"PAYMENTAPP_ERROR_OCCURED",CLEAR_ERROR_MSG:"PAYMENTAPP_CLEAR_ERROR_MSG"}),angular.module("sntPay").controller("confirmDirectBillPopupCtrl",["$scope",function(e){e.payToDirectBill=function(){e.$emit("CONFIRMED_DB_PAYMENT",e.ngDialogData)},e.cancelButtonClick=function(){e.$emit("CANCELLED_CONFIRM_DB_PAYMENT")}}]);var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};angular.module("sntPay").controller("payAdyenCtrl",["$scope","sntAdyenGatewaySrv","sntPaymentSrv","paymentAppEventConstants","ngDialog","$timeout","sntActivity","paymentAppEventConstants","$window","$log",function(e,t,a,n,r,o,i,s,d,c){BaseCtrl.call(this,e);var l=void 0,m="https://checkoutshopper-test.adyen.com/checkoutshopper/sdk/5.0.0/adyen.js",u="sha384-kcKKvS6qZbXycrUw31OJ2/2Hz8A8FTsV9anjvpyQc/IWR1SmkFUw7w7F/t5S3qtA",p=function(){var e=document.createElement("script");e.type="text/javascript",e.onload=function(){_()},e.src=m,e.integrity=u,e.crossOrigin="anonymous",document.body.appendChild(e)},_=function(){var a=angular.element("#dropin-container");a&&a.length&&e.callAPI(t.createSession,{successCallBack:function(t){if(t.session&&t.session.errorCode)return void e.$emit(s.ERROR_OCCURED,["Adyen configuration issue.. Please verify"]);var a=window.location,n=_typeof(a.hostname)===_typeof("str")&&(a.hostname.indexOf("pms.stayntouch.com")!==-1||a.hostname.indexOf("pms.eu.stayntouch.com")!==-1),r={environment:n?"live":"test",clientKey:t.client_key,session:{id:t.session.id,sessionData:t.session.sessionData},beforeSubmit:function(e,t,a){a.resolve(e)},onPaymentCompleted:function(a,n){a&&"Authorised"===a.resultCode?(e.$emit(s.CLEAR_ERROR_MSG),y(t.session.id)):(e.$emit(s.ERROR_OCCURED,["Card error !... Please retry"]),e.$emit("RELOAD_IFRAME"))},onError:function(t,a){e.$emit(s.ERROR_OCCURED,["Failed to load Adyen component"+errorMessage])},paymentMethodsConfiguration:{card:{hasHolderName:!0,holderNameRequired:!1}}},o=new AdyenCheckout(r);o.then(function(e){l=e.create("dropin").mount("#dropin-container")})},failureCallBack:function(e){}})},y=function(t){var a={token:t,payment_type:"CC",card_expiry:(new Date).toJSON()},n={apiParams:a,cardDisplayData:{}};e.$emit(s.CC_TOKEN_GENERATED,{paymentData:n,forceSaveRoutine:!0})};e.selectedCC=e.selectedCC||{};var C=function(){$('script[src="'+m+'"]').length>0?_():p()};e.$on("RELOAD_IFRAME",function(){l&&l.unmount(),C()}),function(){var e="adyen-css",t="sha384-0IvbHDeulbhdg1tMDeFeGlmjiYoVT6YsbfAMKFU2lFd6YKUVk0Hgivcmva3j6mkK";if(!document.getElementById(e)){var a=document.getElementsByTagName("head")[0],n=document.createElement("link");n.id=e,n.rel="stylesheet",n.type="text/css",n.href="https://checkoutshopper-test.adyen.com/checkoutshopper/sdk/5.0.0/adyen.css",n.media="all",n.integrity=t,n.crossOrigin="anonymous",a.appendChild(n)}C()}()}]),angular.module("sntPay").controller("payCBACtrl",["$scope","sntPaymentSrv","paymentAppEventConstants","paymentUtilSrv","sntCBAGatewaySrv","$log","sntActivity","$interval","$filter",function(e,t,a,n,r,o,i,s,d){e.hotelConfig.emvTimeout=e.hotelConfig.emvTimeout||180;var c,l=0,m=parseInt(e.hotelConfig.emvTimeout),u=function(){l=0,s.cancel(c)},p=function(){c=s(function(){l>m?(e.$emit("CBA_PAYMENT_FAILED",[d("translate")("CBA_TIMED_OUT")]),i.stop("INIT_CBA_PAYMENT"),u()):l++},1e3)},_=0,y={id:null,status:null},C=function(t){var n=r.generateApiParams(t);e.$emit(a.CC_TOKEN_GENERATED,{paymentData:n,forceSaveRoutine:!0})},f=function(e){var t=[e.RVErrorCode+" "+e.RVErrorDesc];o.error(t)},A=function(t){u(),o.info("doPayment Success response",t),r.updateTransactionSuccess(y.id,t).then(function(t){r.finishTransaction(y.id),e.$emit("hideLoader"),i.stop("INIT_CBA_PAYMENT"),e.$emit("CBA_PAYMENT_SUCCESS",t.data)},function(t){o.error("update to server failed..."),i.stop("INIT_CBA_PAYMENT"),e.$emit("hideLoader"),e.$emit("CBA_PAYMENT_FAILED",t.data)})},T=function(t){u(),o.warn("doPayment Failure response",t),r.updateTransactionFailure(y.id,t).then(function(){i.stop("INIT_CBA_PAYMENT");var a=parseInt(t.RVErrorCode,10),n=[t.RVErrorCode+" "+t.RVErrorDesc];if(o.warn("doPayment Failure response",n),144!==a&&145!==a&&r.finishTransaction(y.id),e.$emit("CBA_PAYMENT_FAILED",n),145===a){var s=!0;r.checkLastTransactionStatus(s)}else e.$emit("hideLoader")},function(t){e.$emit("hideLoader"),e.$emit("CBA_PAYMENT_FAILED",t.data)})},h=function(){r.doPayment({transaction_id:y.id,amount:_},A,T)},E=function(){r.doRefund({transaction_id:y.id,amount:Math.abs(_)},A,T)},g=function(t,a){i.start("INIT_CBA_PAYMENT"),_=0,p(),e.payment&&e.payment.amount||(e.payment=e.payment||{}),_=a.postData.total_value_plus_fees?a.postData.total_value_plus_fees:a.postData.amount,r.initiateTransaction(_,a.bill_id).then(function(e){y.id=e.data.id,Number(_)>0?h():E()},function(t){e.$emit("hideLoader"),e.$emit("CBA_PAYMENT_FAILED",t.data),i.stop("INIT_CBA_PAYMENT"),u()})};!function(){o.info("CBA controller init");var t=e.$on("INITIATE_CBA_PAYMENT",g),a=e.$on("INITIATE_CBA_TOKENIZATION",function(){r.addCard(C,f)});e.$on("$destroy",t),e.$on("$destroy",a)}()}]),angular.module("sntPay").controller("payCreateARPopupCtrl",["$scope","sntPaymentSrv","$timeout",function(e,t,a){e.ar_number="",e.errorMessage="",e.showARNumberInput=!1,e.isCreateButtonDisabled=!1,e.onClickCreate=function(){e.ngDialogData.is_auto_assign_ar_numbers?e.createAccountReceivable(!0):e.showARNumberInput=!0},e.createAccountReceivable=function(n){t.saveARDetails({id:e.ngDialogData.account_id,ar_number:n?"":e.ar_number,workstation_id:e.hotelConfig.workstationId}).then(function(t){e.$emit("hideLoader"),e.$emit("NEW_AR_ACCOUNT_CREATED",{response:t,params:e.ngDialogData}),a(e.closeThisDialog,300)},function(t){e.$emit("hideLoader"),e.errorMessage=t,e.isCreateButtonDisabled=!1,"Please complete required AR Account Information"===e.errorMessage[0]&&(e.isCreateButtonDisabled=!0)})},e.cancelButtonClick=function(){e.errorMessage="",e.showARNumberInput=!1}}]);var _extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e};angular.module("sntPay").controller("payMLIOperationsController",["$scope","sntPaymentSrv","paymentAppEventConstants","paymentUtilSrv","paymentConstants","$timeout","$log","sntActivity",function(e,t,a,n,r,o,i,s){var d,c,l=function(){d=!1,c={},e.cardData={cardNumber:"",CCV:"",expiryMonth:"",expiryYear:"",nameOnCard:""}},m=e.$on(a.RESET_CARD_DETAILS,function(){return l}),u=function(t){var r=n.formCCTokenGeneratedParams(_extends({},e.cardData,t));e.$emit(a.CC_TOKEN_GENERATED,{paymentData:r,tokenDetails:t,cardData:e.cardData})},p=function(t){i.error(t),e.$emit(a.ERROR_OCCURED,t)},_=function(t){var r=(new SwipeOperation).createSWipedDataToSave(t),o=n.formCCTokenGeneratedParams(_extends({},e.cardData,t,r));e.$emit(a.CC_TOKEN_GENERATED,{paymentData:o,cardData:e.cardData,tokenDetails:t})},y=function(e){u(e),s.stop("FETCH_MLI_TOKEN")},C=function(e){p(e),s.stop("FETCH_MLI_TOKEN")},f=function(t,n){if("CBA_AND_MLI"===e.hotelConfig.paymentGateway&&!e.payment.isAddPaymentMode){var r=["Wrong Device ! Please use the CBA device to proceed with the payment action"];return void e.$emit(a.ERROR_OCCURED,r)}d=!0,e.hotelConfig.isEMVEnabled&&(e.payment.isManualEntryInsideIFrame=!0,e.toggleManualIframe()),c=n,e.cardData.cardNumber=n.cardNumber,e.cardData.nameOnCard=n.nameOnCard,e.cardData.expiryMonth=n.cardExpiryMonth,e.cardData.expiryYear=n.cardExpiryYear,e.cardData.cardType=n.cardType,e.payment.screenMode="CARD_ADD_MODE",e.payment.addCCMode="ADD_CARD",e.$$phase||e.$apply()},A=function(a){e.$emit("SHOW_SIX_PAY_LOADER"),t.getSixPaymentToken(a).then(function(t){var a=t.card_type||"";e.$emit("SUCCESS_LINK_PAYMENT",{response:{id:t.payment_method_id||t.guest_payment_method_id,guest_payment_method_id:t.guest_payment_method_id,payment_name:"CC",usedEMV:!0,addToGuestCard:e.payment.addToGuestCardSelected},selectedPaymentType:e.selectedPaymentType||"CC",cardDetails:{card_code:a.toLowerCase(),ending_with:t.ending_with,expiry_date:t.expiry_date,card_name:"",is_swiped:t.is_swiped}}),e.$emit("HIDE_SIX_PAY_LOADER")},function(t){i.info("Tokenization Failed"),e.$emit("PAYMENT_FAILED",t),e.$emit("HIDE_SIX_PAY_LOADER")})},T=function(a){e.$emit("SHOW_SIX_PAY_LOADER"),t.submitPaymentForChipAndPin(a).then(function(t){i.info("payment success"+e.payment.amount),t.amountPaid=e.payment.amount,t.authorizationCode=t.authorization_code;var a=t.payment_method&&t.payment_method.card_type||"";e.feeData&&(t.feePaid=e.feeData.calculatedFee),e.selectedCC=e.selectedCC||{},t.payment_method&&(e.selectedCC.value=t.payment_method.id,e.selectedCC.card_code=a.toLowerCase(),e.selectedCC.ending_with=t.payment_method.ending_with,e.selectedCC.expiry_date=t.payment_method.expiry_date),t.cc_details=angular.copy(e.selectedCC),e.payment.showAddToGuestCard&&(t.add_to_guest_card=e.payment.addToGuestCardSelected),e.$emit("HIDE_SIX_PAY_LOADER"),o(function(){e.onPaymentSuccess(t)},700)},function(t){i.info("payment failed"+t),e.$emit("PAYMENT_FAILED",t),e.$emit("HIDE_SIX_PAY_LOADER")})};e.getMLIToken=function(a){if(a.preventDefault(),d)return void _(c);var r=n.formParamsForFetchingTheToken(e.cardData);s.start("FETCH_MLI_TOKEN"),t.fetchMLIToken(r,y,C)},e.$on("RENDER_SWIPED_DATA",function(e,t){f(e,t)}),e.$on("INITIATE_CHIP_AND_PIN_PAYMENT",function(t,a){var n=a;n.postData.is_emv_request=!0,n.postData.workstation_id=e.hotelConfig.workstationId,n.emvTimeout=parseInt(e.hotelConfig.emvTimeout),T(a)}),e.$on("INITIATE_CHIP_AND_PIN_TOKENIZATION",function(t,a){var n=a;n.is_emv_request=!0,n.emvTimeout=parseInt(e.hotelConfig.emvTimeout),A(a)}),e.$on("destroy",m);var h=function(){e.selectedPaymentType="CC",f({},t.sampleMLISwipedCardResponse)};document.addEventListener("MOCK_MLI_SWIPE",function(){e.$emit("showLoader"),o(function(){e.$emit("hideLoader"),h()},1e3)}),function(){l(),e.modes=r.modes;try{HostedForm.setMerchant(e.hotelConfig.mliMerchantId)}catch(e){}}()}]);var _extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e};angular.module("sntPay").controller("payShift4Ctrl",["$scope","sntShift4GatewaySrv","sntPaymentSrv","paymentAppEventConstants","$timeout","sntActivity","$log",function(e,t,a,n,r,o,i){var s=void 0,d={JC:"JCB",NS:"DC",VS:"VA"},c="https://i4m.i4go.com/js/jquery.i4goTrueToken.js",l=function(){var e=document.createElement("script");e.type="application/javascript",e.onload=function(){m()},e.src=c,document.body.appendChild(e)},m=function(){var a=angular.element("#i4goFrame");a&&a.length&&t.getIframeConfig().then(function(t){$("#i4goFrame").i4goTrueToken({server:t.i4go_server,accessBlock:t.access_block,self:document.location,template:"bootstrap5",cssRules:["body{background-color: transparent}"],cardholderName:{visible:!0,required:!0},url:t.i4go_i4m_url,submitButton:{label:"Add",visible:!0},onSuccess:function(e,t){y(t)},onFailure:function(t,a){i.info("Tokenization Failed: response code =>"+a.respCode);var n=a.i4go_responsetext?[a.i4go_responsetext]:[""];e.$emit("PAYMENT_FAILED",n)},acceptedPayments:"AX,DC,JC,MC,NS,VS",debug:!1})}).catch(function(){})},u=function(t,n){n.postData=_extends({},n.postData,t,{etb:!0,isShift4Request:!0}),a.submitPayment(n).then(function(t){i.info("payment success"+e.payment.amount),t.amountPaid=e.payment.amount,t.authorizationCode=t.authorization_code;var a=t.payment_method&&t.payment_method.card_type||"";e.feeData&&(t.feePaid=e.feeData.calculatedFee),e.selectedCC=e.selectedCC||{},t.payment_method||(e.selectedCC.value=t.payment_method.id,e.selectedCC.card_code=a.toLowerCase(),e.selectedCC.ending_with=t.payment_method.ending_with,e.selectedCC.expiry_date=t.payment_method.expiry_date),t.cc_details=angular.copy(e.selectedCC),e.payment.showAddToGuestCard&&(t.add_to_guest_card=e.payment.addToGuestCardSelected),e.$emit("HIDE_SIX_PAY_LOADER"),r(function(){e.onPaymentSuccess(t)},700)},p)},p=function(t){i.info("Payment Failed");var a=["Failed to process the card. Please try again."];Array.isArray(t)?a=t:t&&t.data&&(a=t.data),e.$emit("PAYMENT_FAILED",a),e.$emit("HIDE_SIX_PAY_LOADER")},_=function(a,n){r(function(){e.$emit("SHOW_SIX_PAY_LOADER"),t.startPromptCard(s).then(function(t){if(t.result.length){var r=t.result[0],o="",i="",s="";if(r.card.expirationDate){var c=r.card.expirationDate.toString();c=3===c.length?"0"+c:c;var l=c.substring(2,4),m=c.substring(0,2);o="20"+l+"-"+m+"-01",i=m+"/"+l}r.customer&&(s=r.customer.firstName?r.customer.firstName.replace("/"," "):"",s=r.customer.lastName?s+" "+r.customer.lastName.replace("/"," "):s);var u={mli_token:r.card.token?r.card.token.value:"",payment_type:"CC",card_expiry:o,credit_card:d[r.card.type]||r.card.type,card_name:s,masked_card_number:r.card.number?r.card.number.slice(r.card.number.length-4):"XXXX",workstation_id:e.hotelConfig.workstationId,entry_mode:r.card.entryMode,card_expiry_for_display:i};a(u,n)}else p(["Proxy server - Failed to retrieve results"])},function(e){i.error(e),p(e||["Proxy server down"])})},120)},y=function(t){var a={mli_token:t.i4go_uniqueid.toString(),payment_type:"CC",card_expiry:t.i4go_expirationyear+"-"+t.i4go_expirationmonth+"-01",credit_card:d[t.i4go_cardtype]||t.i4go_cardtype,card_name:t.i4go_cardholdername,masked_card_number:t.otn.cardnumber.substr(-4)},r=t.i4go_expirationmonth+"/"+t.i4go_expirationyear.slice(-2);e.$emit(n.CC_TOKEN_GENERATED,{paymentData:{apiParams:a,cardDisplayData:{card_code:a.credit_card.toLowerCase(),ending_with:a.masked_card_number,expiry_date:r,name_on_card:a.card_name}}})},C=function(t,a){var r=t.card_expiry_for_display;delete t.card_expiry_for_display,e.$emit(n.CC_TOKEN_GENERATED,{paymentData:{apiParams:t,cardDisplayData:{card_code:t.credit_card.toLowerCase(),ending_with:t.masked_card_number,expiry_date:r,name_on_card:t.card_name}},forceSaveRoutine:!0}),e.$emit("HIDE_SIX_PAY_LOADER")};e.$on("INITIATE_CHIP_AND_PIN_PAYMENT",function(e,t){_(u,t)}),e.$on("INITIATE_CHIP_AND_PIN_TOKENIZATION",function(e,t){_(C,t)}),e.$on("RELOAD_IFRAME",function(){var e=document.getElementsByClassName("i4go-frame");e.length&&(e[0].src=e[0].src)}),function(){e.selectedCC=e.selectedCC||{},$('script[src="'+c+'"]').length>0?m():l(),o.start("FETCH_WORKSTATION_DATA"),a.fethWorkStationData(e.hotelConfig.workstationId).then(function(e){s=e,o.stop("FETCH_WORKSTATION_DATA")},function(e){o.stop("FETCH_WORKSTATION_DATA"),p(e)})}()}]);var _extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e};angular.module("sntPay").controller("payShijiCtrl",["$scope","sntShijiGatewaySrv","sntPaymentSrv","paymentAppEventConstants","ngDialog","$timeout","sntActivity","$window","$log",function(e,t,a,n,r,o,i,s,d){var c=this;c.loadShijiIframe=function(){var t=$("#iframe-token");if(t&&t.length){var n=a.resolvePaths(e.hotelConfig.paymentGateway,{card_holder_first_name:e.payment.guestFirstName,card_holder_last_name:e.payment.guestLastName});t[0].src=n.iFrameUrl,i.start("SHIJI_IFRAME_LOADING"),t.on("load",function(){i.stop("SHIJI_IFRAME_LOADING")}),t.on("error",function(){i.stop("SHIJI_IFRAME_LOADING")})}},e.$on("RELOAD_IFRAME",function(){}),e.$on("GET_SHIJI_TOKEN",function(){e.clearErrorMessage();var t=$("#iframe-token");t&&t.length&&(t[0].contentWindow.postMessage("0","*"),i.start("FETCH_SHIJI_TOKEN")),$("input").blur()});var l=function(t){var a=t.data;e.$emit("SUCCESS_LINK_PAYMENT",{response:_extends({},a,{addToGuestCard:e.payment.addToGuestCardSelected}),selectedPaymentType:e.selectedPaymentType,cardDetails:{card_code:a.credit_card_type?a.credit_card_type.toLowerCase():"credit-card",ending_with:a.ending_with,expiry_date:a.expiry_date,card_name:a.card_name,token:a.token}})},m=function(t){var n=function(t){e.$emit("PAYMENT_FAILED",t)};i.start("SAVE_CC_PAYMENT"),a.savePaymentDetails(t).then(function(e){"success"===e.status?l(e):n(e.errors),i.stop("SAVE_CC_PAYMENT")},function(e){n(e),i.stop("SAVE_CC_PAYMENT")})},u=function(t){var a={paymentData:{apiParams:t,cardDisplayData:{name_on_card:e.payment.guestFirstName+" "+e.payment.guestLastName}}};e.$emit(n.CC_TOKEN_GENERATED,a)};c.tokenizeBySavingtheCard=function(t){var a=/^ADD_PAYMENT_/.test(e.actionType),n={token:t,payment_type:"CC"};a&&(e.reservationId&&(n.reservation_id=e.reservationId),n.add_to_guest_card=e.payment.addToGuestCardSelected,n.bill_number=1,n.user_id=e.guestId),i.stop("FETCH_SHIJI_TOKEN"),a?m(n):u(n)},c.handleResponseFromIframe=function(t){var a=t.data||t.originalEvent.data;if("00"===a.respCode)c.tokenizeBySavingtheCard(a.tokenId);else if(a.respCode&&"00"!==a.respCode){i.stop("FETCH_SHIJI_TOKEN"),d.info("Tokenization Failed: response code =>"+a.respCode);var n=a.respText?[a.respText]:[""];e.$emit("PAYMENT_FAILED",n)}};var p=function(t){e.$emit("SHOW_SIX_PAY_LOADER"),a.getSixPaymentToken(t).then(function(t){var a=t.card_type||"";e.$emit("SUCCESS_LINK_PAYMENT",{response:{id:t.payment_method_id||t.guest_payment_method_id,guest_payment_method_id:t.guest_payment_method_id,payment_name:"CC",usedEMV:!0,addToGuestCard:e.payment.addToGuestCardSelected},selectedPaymentType:e.selectedPaymentType||"CC",cardDetails:{card_code:a.toLowerCase(),ending_with:t.ending_with,expiry_date:t.expiry_date,card_name:t.card_name,is_swiped:t.is_swiped}}),e.$emit("HIDE_SIX_PAY_LOADER")},function(t){d.info("Tokenization Failed"),e.$emit("PAYMENT_FAILED",t),e.$emit("HIDE_SIX_PAY_LOADER")})};e.$on("INITIATE_CHIP_AND_PIN_TOKENIZATION",function(t,a){var n=a;n.is_emv_request=!0,n.emvTimeout=parseInt(e.hotelConfig.emvTimeout),p(a)});var _=function(t){e.$emit("SHOW_SIX_PAY_LOADER"),a.submitPaymentForChipAndPin(t).then(function(t){t.amountPaid=e.payment.amount,t.authorizationCode=t.authorization_code;var a=t.payment_method&&t.payment_method.card_type||"";e.feeData&&(t.feePaid=e.feeData.calculatedFee),e.selectedCC=e.selectedCC||{},t.payment_method&&(e.selectedCC.value=t.payment_method.id,e.selectedCC.card_code=a.toLowerCase(),e.selectedCC.ending_with=t.payment_method.ending_with,e.selectedCC.expiry_date=t.payment_method.expiry_date),t.cc_details=angular.copy(e.selectedCC),e.payment.showAddToGuestCard&&(t.add_to_guest_card=e.payment.addToGuestCardSelected),e.$emit("HIDE_SIX_PAY_LOADER"),o(function(){e.onPaymentSuccess(t)},700)},function(t){e.$emit("PAYMENT_FAILED",t),e.$emit("HIDE_SIX_PAY_LOADER")})};e.$on("INITIATE_CHIP_AND_PIN_PAYMENT",function(t,a){var n=a;n.postData.is_emv_request=!0,n.postData.workstation_id=e.hotelConfig.workstationId,n.emvTimeout=parseInt(e.hotelConfig.emvTimeout),_(a)}),function(){c.loadShijiIframe();var t=angular.copy(e.showSelectedCard());e.payment.isManualEntryInsideIFrame=t&&"SHIJI"===e.hotelConfig.paymentGateway;var a=window.addEventListener?"addEventListener":"attachEvent",n="attachEvent"===a?"onmessage":"message";angular.element(s).on(n,function(e){c.handleResponseFromIframe(e)}),e.$on("$destroy",function(){angular.element(s).off(n)})}()}]),angular.module("sntPay").controller("paySixPayController",["$scope","paymentAppEventConstants","sntPaymentSrv","$timeout","$window",function(e,t,a,n,r){var o=function(t){var n={};return n.cardType=t.token_no.substr(t.token_no.length-4),n.expiryMonth=t.expiry.substring(2,4),n.expiryYear=t.expiry.substring(0,2),n.expiryDate=n.expiryMonth+" / "+n.expiryYear,n.cardExpiry=n.expiryMonth&&n.expiryYear?"20"+n.expiryYear+"-"+n.expiryMonth+"-01":"",n.cardCode=a.getSixPayCreditCardType(t.card_type).toLowerCase(),n.endingWith=t.token_no.substr(t.token_no.length-4),n.token=t.token_no,n.nameOnCard=e.payment.guestFirstName+" "+e.payment.guestLastName,n},i=function(a){var n=o(a),r={apiParams:{name_on_card:n.nameOnCard,payment_type:"CC",token:n.token,card_expiry:n.cardExpiry},cardDisplayData:{card_code:n.cardCode,ending_with:n.endingWith,expiry_date:n.expiryDate}};e.$emit(t.CC_TOKEN_GENERATED,{paymentData:r,tokenDetails:a,cardData:n})},s=function(t){e.$emit("SHOW_SIX_PAY_LOADER"),a.submitPaymentForChipAndPin(t).then(function(t){t.amountPaid=e.payment.amount,t.authorizationCode=t.authorization_code;var a=t.payment_method&&t.payment_method.card_type||"";e.feeData&&(t.feePaid=e.feeData.calculatedFee),e.selectedCC=e.selectedCC||{},t.payment_method&&(e.selectedCC.value=t.payment_method.id,e.selectedCC.card_code=a.toLowerCase(),e.selectedCC.ending_with=t.payment_method.ending_with,e.selectedCC.expiry_date=t.payment_method.expiry_date),t.cc_details=angular.copy(e.selectedCC),e.payment.showAddToGuestCard&&(t.add_to_guest_card=e.payment.addToGuestCardSelected),e.$emit("HIDE_SIX_PAY_LOADER"),n(function(){e.onPaymentSuccess(t)},700)},function(t){e.$emit("PAYMENT_FAILED",t),e.$emit("HIDE_SIX_PAY_LOADER")})},d=function(t){e.$emit("SHOW_SIX_PAY_LOADER"),a.getSixPaymentToken(t).then(function(t){var a=t.card_type||"";e.$emit("SUCCESS_LINK_PAYMENT",{response:{id:t.payment_method_id||t.guest_payment_method_id,guest_payment_method_id:t.guest_payment_method_id,payment_name:"CC",usedEMV:!0,addToGuestCard:e.payment.addToGuestCardSelected},selectedPaymentType:e.selectedPaymentType||"CC",cardDetails:{card_code:a.toLowerCase(),ending_with:t.ending_with,expiry_date:t.expiry_date,card_name:"",is_swiped:t.is_swiped}}),e.$emit("HIDE_SIX_PAY_LOADER")},function(t){e.$emit("PAYMENT_FAILED",t),e.$emit("HIDE_SIX_PAY_LOADER")})};e.$on("INITIATE_CHIP_AND_PIN_PAYMENT",function(t,a){var n=a;n.postData.is_emv_request=!0,n.postData.workstation_id=e.hotelConfig.workstationId,n.emvTimeout=parseInt(e.hotelConfig.emvTimeout),s(a)}),e.$on("INITIATE_CHIP_AND_PIN_TOKENIZATION",function(t,a){var n=a;n.is_emv_request=!0,n.emvTimeout=parseInt(e.hotelConfig.emvTimeout),d(a)}),function(){var t=angular.copy(e.showSelectedCard());e.payment.isManualEntryInsideIFrame=!(!t||"sixpayments"!==e.hotelConfig.paymentGateway);var a=window.addEventListener?"addEventListener":"attachEvent",n=(window[a],"attachEvent"===a?"onmessage":"message");angular.element(r).on(n,function(e){var t=e.data||e.originalEvent.data;"token_created"===t.response_message&&i(t)}),e.$on("$destroy",function(){angular.element(r).off(n)})}()}]);var _extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e};angular.module("sntPay").controller("sntPaymentController",["$scope","sntPaymentSrv","paymentAppEventConstants","$location","PAYMENT_CONFIG","$rootScope","$timeout","ngDialog","$filter","$state","sntActivity","rvPermissionSrv",function(e,t,a,n,r,o,i,s,d,c,l,m){function u(){x(),e.$emit("REMOVE_PAYMENT_TYPE",{paymentType:"DB"})}function p(t){var a=void 0;return t=t||{},a={postData:_extends({},t,{bill_number:e.billNumber,payment_type:e.selectedPaymentType,amount:e.payment.amount.toString().replace(/,/g,""),is_split_payment:e.splitBillEnabled&&e.numSplits>1,workstation_id:e.hotelConfig.workstationId,currency_id:e.payment.selectedPaymentCurrencyId}),reservation_id:e.reservationId,bill_id:e.billId},e.isRefund()&&"tax_payment_receipt"===e.hotelConfig.selectedReceiptTypeValue&&"DB"!==e.selectedPaymentType&&(a.postData.receipt_id=e.payment.receipt_id),
"AR_REFUND_PAYMENT"===e.actionType&&(a.postData.parent_ar_id=e.arTransactionId),e.payment.showAddToGuestCard&&(a.postData.add_to_guest_card=e.payment.addToGuestCardSelected),e.feeData&&e.feeData.showFee&&(a.postData.fees_amount=e.feeData.calculatedFee,a.postData.fees_charge_code_id=e.feeData.feeChargeCode,a.postData.total_value_plus_fees=e.feeData.totalOfValueAndFee),e.isDisplayRef&&(a.postData.reference_text=e.payment.referenceText),e.reservationIds&&(a.postData.reservation_ids=e.reservationIds),e.selectedCC&&e.selectedCC.params&&(a.postData=_extends({},e.selectedCC.params,a.postData)),"SHIJI"===e.hotelConfig.paymentGateway&&(a.postData.auth_code=e.payment.auth_code),a}function y(t,a){var n=void 0,r=void 0;a=a||{},n=angular.copy(L),angular.extend(n,a),a=n,r=isEmptyObject(e.myScrollOptions),r&&(e.myScrollOptions={}),Y&&(a.click=!1,a.tap=!0,a.preventDefault=!1,a.deceleration=1e-4),e.myScrollOptions[t]=a}function C(t){setTimeout(function(){e.$parent&&e.$parent.myScroll&&t in e.$parent.myScroll&&e.$parent.myScroll[t].refresh(),e.hasOwnProperty("myScroll")&&t in e.myScroll&&e.myScroll[t].refresh()},k)}function f(){e.isEditable!==!1&&(e.payment.isEditable=!0)}function A(){var t="CBA_AND_MLI"===e.hotelConfig.paymentGateway;return!!r[e.hotelConfig.paymentGateway].disableCardSelection||t&&!e.payment.isAddCardAction}function T(t){i(function(){e.paymentAttempted=!0,e.isPaymentFailure=!0,e.paymentErrorMessage=t[0],e.$emit("PAYMENT_FAILED",t),l.stop("SUBMIT_PAYMENT"),e.$emit("hideLoader")},300)}function h(t){e.paymentErrorMessage="",i(function(){e.paymentErrorMessage=t,e.$emit("PAYMENT_FAILED",[t]),e.$emit("hideLoader")},300)}function E(){var a=e.$on("CBA_PAYMENT_FAILED",function(e,t){T(t)}),n=e.$on("CBA_PAYMENT_SUCCESS",function(a,n){var r=p();l.start("SUBMIT_PAYMENT"),r.postData.payment_type_id=n.payment_method_id,r.postData.credit_card_transaction_id=n.id,t.submitPayment(r).then(function(t){e.onPaymentSuccess(t),l.stop("SUBMIT_PAYMENT")},function(e){T(e)})}),r=o.$on("UPDATE_NOTIFICATION",function(e,t){h(t)});e.$on("$destroy",a),e.$on("$destroy",n),e.$on("$destroy",r)}function g(){var t=e.$on("SHIJI_PAYMENT_FAILED",function(e,t){T(t)}),a=e.$on("SHIJI_PAYMENT_SUCCESS",function(t,a){e.onPaymentSuccess(a)});e.$on("$destroy",t),e.$on("$destroy",a)}function D(){e.payment.showAddToGuestCard=!!e.reservationId}function v(){return e.payment.linkedCreditCards.length>0}function P(){e.payment.screenMode="CARD_ADD_MODE",e.payment.addCCMode=v()&&!e.swipedCardData?"EXISTING_CARDS":"ADD_CARD",e.$broadcast("RESET_CARD_DETAILS"),C("cardsList")}function I(){var t=void 0;"sixpayments"===e.hotelConfig.paymentGateway&&$("#sixIframe").length?(t=document.getElementById("sixIframe"),t.src=t.src):e.$broadcast("RELOAD_IFRAME")}function S(a){var n,r,o,i,s,d=F&&!e.payment.isManualEntryInsideIFrame;return e.hotelConfig.isStandAlone||"CBA"===e.selectedPaymentType?(n=_.find(e.paymentTypes,{name:e.selectedPaymentType}),s=n&&n.charge_code&&n.charge_code.fees_information||{},!d&&n&&"CC"===n.name&&e.selectedCC&&e.selectedCC.hasOwnProperty("card_code")&&(e.selectedCC.card_code&&(r=_.find(n.values,{cardcode:e.selectedCC.card_code.toUpperCase()})),s=r&&r.charge_code&&r.charge_code.fees_information||s),o=t.calculateFee(e.payment.amount,s),e.isDisplayRef=n&&n.is_display_reference,e.feeData={calculatedFee:o.calculatedFee,totalOfValueAndFee:o.totalOfValueAndFee,showFee:o.showFees,feeChargeCode:o.feeChargeCode},e.originalFee=angular.copy(e.feeData.calculatedFee),void(a&&e.payment.paymentCurrencyAmount&&(i=t.calculateFee(e.payment.paymentCurrencyAmount,s),e.paymentFeeData={calculatedPaymentFee:i.calculatedPaymentFee,totalOfValueAndPaymentFee:i.totalOfValueAndPaymentFee},e.originalPaymentFee=angular.copy(e.paymentFeeData.calculatedPaymentFee),e.feeData.calculatedFee=e.paymentFeeData.calculatedPaymentFee,e.feeData.totalOfValueAndFee=e.paymentFeeData.totalOfValueAndPaymentFee))):(e.feeData={calculatedFee:"",totalOfValueAndFee:"",showFee:!1,feeChargeCode:""},void(e.paymentFeeData={calculatedPaymentFee:"",totalOfValueAndPaymentFee:""}))}function N(){var t=_.find(e.paymentTypes,{name:"CC"});return t&&t.values||[]}function M(a){function n(t){e.selectedPaymentType||(e.selectedPaymentType="CC"),e.selectedCC=e.selectedCC||{},e.selectedCC.value=t.data.id,e.selectedCard=e.selectedCC.value,e.selectedCC.card_code=t.data.credit_card_type?t.data.credit_card_type.toLowerCase():"credit-card",e.selectedCC.ending_with=t.data.ending_with,e.selectedCC.expiry_date=t.data.expiry_date,e.selectedCC.holder_name=a.cardDisplayData.name_on_card,e.payment.screenMode="PAYMENT_MODE",e.$emit("PAYMENT_SAVE_CARD_SUCCESS"),t.params&&(e.selectedCC.params=o),S(),D()}function r(t){e.errorMessage=t}var o=void 0;return l.start("SAVE_CC_PAYMENT"),o=angular.copy(a.apiParams),e.accountId&&(o.account_id=e.accountId),e.groupId&&(o.group_id=e.groupId),e.allotmentId&&(o.allotment_id=e.allotmentId),"DEPOSIT_PAYMENT_RES_SUMMARY"===e.actionType&&(o.reservation_id=e.reservationId),o.mli_token&&"rover.reservation.staycard.mainCard.summaryAndConfirm"!==c.current.name&&"SHIFT4"!==e.hotelConfig.paymentGateway?(o.do_not_attach_cc_to_bill=!0,o.reservation_id=e.reservationId,l.stop("SAVE_CC_PAYMENT"),void n({params:o,data:{id:null,credit_card_type:e.selectedCC.card_code,ending_with:e.selectedCC.ending_with,expiry_date:e.selectedCC.expiry_date}})):void t.savePaymentDetails(o).then(function(e){"success"===e.status?n(e):r(e.errors),l.stop("SAVE_CC_PAYMENT")},function(e){r(e),l.stop("SAVE_CC_PAYMENT")})}function R(a){l.start("ADD_PAYMENT_METHOD_ON_BILL");var n=angular.copy(a.apiParams),r=function(t){e.selectedCC=e.selectedCC||{},e.selectedCC.value=t.id,e.selectedCard=e.selectedCC.value,e.selectedCC.card_code=t.credit_card_type?t.credit_card_type.toLowerCase():"credit-card",e.selectedCC.ending_with=t.ending_with,e.selectedCC.expiry_date=t.expiry_date,e.selectedCC.holder_name=a.cardDisplayData.name_on_card,e.payment.screenMode="PAYMENT_MODE",S()},o=function(t){e.errorMessage=t};t.addBillPaymentMethod({billId:e.billId,payLoad:_extends({},n,{workstation_id:e.hotelConfig.workstationId})}).then(function(e){r(e),l.stop("ADD_PAYMENT_METHOD_ON_BILL")},function(e){o(e),l.stop("ADD_PAYMENT_METHOD_ON_BILL")})}function w(){e.payment.amount=e.amount||0,O=angular.copy(e.payment.amount),S()}function b(){e.payment.paymentCurrencyAmount=e.paymentCurrencyAmount||0}var F,k=300,O=0,L={snap:!1,scrollbars:"custom",hideScrollbar:!1,click:!1,scrollX:!1,scrollY:!0,preventDefault:!0,interactiveScrollbars:!0,preventDefaultException:{tagName:/^(INPUT|TEXTAREA|BUTTON|SELECT|A)$/}},Y="rv_native"===sntapp.browser&&sntapp.cordovaLoaded;if(e.payment={referenceText:e.referenceText,amount:0,paymentCurrencyAmount:0,isPenalty:!1,isRateSuppressed:!1,isEditable:!1,addToGuestCard:!1,billNumber:1,linkedCreditCards:[],MLImerchantId:"",creditCardTypes:[],showAddToGuestCard:!1,addToGuestCardSelected:!1,allocatePaymentAfterPosting:!1,guestFirstName:"",guestLastName:"",isManualEntryInsideIFrame:!1,workstationId:"",emvTimeout:120,isConfirmedDBpayment:!1,selectedPaymentCurrencyId:o.hotelCurrencyId,selectedPaymentCurrencySymbol:"CC"===e.selectedPaymentType?o.currencySymbol:o.paymentCurrencySymbol},e.giftCard={number:"",amountAvailable:!1,availableBalance:null},e.errorMessage="",e.precisionTwo=2,e.currencyFormat=o.hotelDetails.currency_format&&o.hotelDetails.currency_format.value,e.$on("REMOVE_PAYMENT_TYPE",function(t,a){e.paymentTypes=_.without(e.paymentTypes,_.findWhere(e.paymentTypes,{name:a.paymentType}))}),void 0!==e.allowDirectBill&&!e.allowDirectBill)var x=e.$watch("paymentTypes",function(){void 0!==e.paymentTypes&&u()});e.isGCBalanceShort=function(){var t=void 0;return"GIFT_CARD"===e.selectedPaymentType&&(t=parseFloat(e.payment.amount),e.feeData&&(t=parseFloat(e.feeData.totalOfValueAndFee)),t<0||e.giftCard.availableBalance&&parseFloat(e.giftCard.availableBalance)<t)},e.checkWorkStationMandatoryFields=function(){t.checkWorkStationMandatoryFields(e.hotelConfig.workstationId).then(function(t){return e.workStationStatus=t.workstation_active,t.workstation_active||(e.errorMessage=["Workstation needs to be set up in order to proceed with payment"]),e.workStationStatus},function(t){return e.workStationStatus=!0,e.workStationStatus})};var B=function(){return e.isRefund()&&e.receiptsList&&!e.payment.receipt_id&&"DB"!==e.selectedPaymentType};e.shouldHidePaymentButton=function(){return!e.workStationStatus||!e.selectedPaymentType||!e.hasPermission||e.isGCBalanceShort()||!e.splitBillEnabled&&e.paymentAttempted&&!e.isPaymentFailure||B()},e.showSelectedCard=function(){var t=(e.hotelConfig,!("CC"!==e.selectedPaymentType||!e.selectedCC||!e.selectedCC.ending_with&&!e.selectedCC.card_number)),a=F&&e.payment.isManualEntryInsideIFrame,n="CBA_AND_MLI"===e.hotelConfig.paymentGateway&&!e.payment.isAddPaymentMode;return!A()&&t&&"PAYMENT_MODE"===e.payment.screenMode&&(a||!F)&&!n},e.toggleManualIframe=function(){e.payment.isManualEntryInsideIFrame?P():(e.payment.showAddToGuestCard=!!e.reservationId&&!e.payment.isManualEntryInsideIFrame,e.selectedCC={}),S()},e.toggleCCMOde=function(t){"GIFT_CARD"===t?(e.selectedPaymentType="GIFT_CARD",e.onPaymentInfoChange()):(e.selectedPaymentType="CC",e.onPaymentInfoChange()),"ADD_CARD"===t&&I(),i(function(){e.payment.addCCMode=t},350)},e.cancelAction=function(t){e.$emit("PAYMENT_ACTION_CANCELLED",t)},e.closeThePopup=function(){e.$emit("CLOSE_DIALOG")},e.payLater=function(){e.$emit("PAY_LATER",{paymentType:e.selectedPaymentType,cardDetails:e.selectedCC,addToGuestCard:e.payment.addToGuestCardSelected})},e.continueAction=function(t){e.$emit("PAYMENT_ACTION_CONTINUE",t)},e.resetPaymentAttempt=function(){e.paymentAttempted=!1,e.isPaymentFailure=!1};var G=function(t){var a=void 0;return a="ADYEN"===e.hotelConfig.paymentGateway?{cardDisplayData:{card_code:t.card_type?t.card_type.toLowerCase():"",ending_with:t.ending_with,expiry_date:t.expiry_date,name_on_card:t.card_name},apiParams:{name_on_card:t.card_name}}:e.payment.tokenizedCardData};e.saveReservationPaymentMethod=function(){var a=void 0;if("CC"===e.selectedPaymentType&&"CBA"===e.hotelConfig.paymentGateway&&!e.payment.tokenizedCardData)return void e.$broadcast("INITIATE_CBA_TOKENIZATION");if("CC"===e.selectedPaymentType&&F&&!e.payment.isManualEntryInsideIFrame&&!e.payment.tokenizedCardData)return a={workstation_id:e.hotelConfig.workstationId,bill_number:e.billNumber},"ADD_PAYMENT_GUEST_CARD"===e.actionType?angular.extend(a,{guest_id:e.guestId,add_to_guest_card:!0}):("ADD_PAYMENT_STAY_CARD"===e.actionType&&(a.guest_id=e.guestId),e.reservationId&&(a.reservation_id=e.reservationId),e.accountId&&(a.account_id=e.accountId),e.groupId&&(a.group_id=e.groupId),e.allotmentId&&(a.allotment_id=e.allotmentId),a.add_to_guest_card=e.payment.addToGuestCardSelected),void e.$broadcast("INITIATE_CHIP_AND_PIN_TOKENIZATION",a);if("ADD_PAYMENT_GUEST_CARD"===e.actionType){var n=void 0;l.start("ADD_PAYMENT_GUEST_CARD"),t.addCardToGuest(_extends({},e.payment.tokenizedCardData.apiParams,{add_to_guest_card:!0,workstation_id:e.hotelConfig.workstationId,user_id:e.guestId})).then(function(t){n=G(t.data),e.$emit("SUCCESS_LINK_PAYMENT",{response:t.data,selectedPaymentType:e.selectedPaymentType,cardDetails:{card_code:n.cardDisplayData.card_code,ending_with:n.cardDisplayData.ending_with,expiry_date:n.cardDisplayData.expiry_date,card_name:n.cardDisplayData.name_on_card}}),l.stop("ADD_PAYMENT_GUEST_CARD")},function(t){e.$emit("ERROR_OCCURED",t),l.stop("ADD_PAYMENT_GUEST_CARD")})}else"CC"===e.selectedPaymentType&&"ADD_PAYMENT_CO_TA"===e.actionType&&e.payment.tokenizedCardData&&e.payment.tokenizedCardData.apiParams?(l.start("ADD_PAYMENT"),t.savePaymentDetails(_extends({},e.payment.tokenizedCardData.apiParams,{workstation_id:e.hotelConfig.workstationId,account_id:e.accountId,is_from_wallet:e.isFromWallet})).then(function(t){var a=G(t.data);e.$emit("SUCCESS_LINK_PAYMENT",{response:_extends({},t.data,{addToGuestCard:e.payment.addToGuestCardSelected}),selectedPaymentType:e.selectedPaymentType,cardDetails:{card_code:a.cardDisplayData.card_code,ending_with:a.cardDisplayData.ending_with,expiry_date:a.cardDisplayData.expiry_date,card_name:a.apiParams.name_on_card||a.apiParams.card_name}}),l.stop("ADD_PAYMENT")},function(t){e.$emit("ERROR_OCCURED",t),l.stop("ADD_PAYMENT")})):"CC"===e.selectedPaymentType&&/^ADD_PAYMENT_/.test(e.actionType)&&e.payment.tokenizedCardData&&e.payment.tokenizedCardData.apiParams?(l.start("ADD_PAYMENT"),t.savePaymentDetails(_extends({},e.payment.tokenizedCardData.apiParams,{workstation_id:e.hotelConfig.workstationId,reservation_id:e.reservationId,bill_number:e.billNumber,add_to_guest_card:e.payment.addToGuestCardSelected})).then(function(t){var a=G(t.data);e.$emit("SUCCESS_LINK_PAYMENT",{response:_extends({},t.data,{addToGuestCard:e.payment.addToGuestCardSelected}),selectedPaymentType:e.selectedPaymentType,cardDetails:{card_code:a.cardDisplayData.card_code,ending_with:a.cardDisplayData.ending_with,expiry_date:a.cardDisplayData.expiry_date,card_name:a.apiParams.name_on_card||a.apiParams.card_name}}),l.stop("ADD_PAYMENT")},function(t){e.$emit("ERROR_OCCURED",t),l.stop("ADD_PAYMENT")})):"CC"!==e.selectedPaymentType?(l.start("ADD_PAYMENT_CC"),t.savePaymentDetails({bill_number:e.billNumber,reservation_id:e.reservationId,payment_type:e.selectedPaymentType,workstation_id:e.hotelConfig.workstationId}).then(function(t){e.$emit("SUCCESS_LINK_PAYMENT",{response:t.data,selectedPaymentType:e.selectedPaymentType}),l.stop("ADD_PAYMENT_CC")},function(t){e.$emit("ERROR_OCCURED",t),l.stop("ADD_PAYMENT_CC")})):e.accountId||e.groupId||e.allotmentId?e.$emit("SUCCESS_LINK_PAYMENT",{selectedPaymentType:e.selectedPaymentType,cardDetails:e.selectedCC}):e.payment.tokenizedCardData&&e.payment.tokenizedCardData.apiParams.mli_token?(l.start("ADD_PAYMENT_SWIPE"),t.savePaymentDetails(_extends({},e.payment.tokenizedCardData.apiParams,{bill_number:e.billNumber,reservation_id:e.reservationId,payment_type:e.selectedPaymentType,workstation_id:e.hotelConfig.workstationId})).then(function(t){e.$emit("SUCCESS_LINK_PAYMENT",{response:t.data,selectedPaymentType:e.selectedPaymentType,cardDetails:e.selectedCC}),l.stop("ADD_PAYMENT_SWIPE")},function(t){e.$emit("ERROR_OCCURED",t),l.stop("ADD_PAYMENT_SWIPE")})):e.reservationId&&(l.start("ADD_EXISTING_PAYMENT_TYPE"),t.mapPaymentToReservation({bill_number:e.billNumber,reservation_id:e.reservationId,payment_type:e.selectedPaymentType,workstation_id:e.hotelConfig.workstationId,user_payment_type_id:e.selectedCC.value,add_to_guest_card:e.payment.addToGuestCardSelected}).then(function(t){e.$emit("SUCCESS_LINK_PAYMENT",{response:t.data,selectedPaymentType:e.selectedPaymentType,cardDetails:e.selectedCC}),l.stop("ADD_EXISTING_PAYMENT_TYPE")},function(t){e.$emit("ERROR_OCCURED",t),l.stop("ADD_EXISTING_PAYMENT_TYPE")}))};var H=function(t){i(function(){s.open({template:"/assets/partials/payCreateARPopup.html",controller:"payCreateARPopupCtrl",className:"",scope:e,data:JSON.stringify(t)})},0)};e.$on("NEW_AR_ACCOUNT_CREATED",function(){e.submitPayment({is_new_ar_account:!0})}),e.$on("CONTINUE_DIRECT_BILL_PAYMENT",function(t,a){var n=a.arDetails;"company"===a.ar_type?n.company_ar_attached?e.submitPayment({ar_type:"company"}):H({account_id:n.company_id,is_auto_assign_ar_numbers:n.is_auto_assign_ar_numbers}):"travel_agent"===a.ar_type&&(n.travel_agent_ar_attached?e.submitPayment({ar_type:"travel_agent"}):H({account_id:n.travel_agent_id,is_auto_assign_ar_numbers:n.is_auto_assign_ar_numbers}))}),e.$on(a.ERROR_OCCURED,function(t,a){i(function(){e.errorMessage=a},100)}),e.$on(a.CLEAR_ERROR_MSG,function(t){i(function(){e.errorMessage=""},100)}),e.submitAccountPayment=function(){"DB"===e.selectedPaymentType?t.checkARStatus(e.postingAccountId).then(function(t){t.company_present&&t.travel_agent_present?e.$emit("SHOW_AR_SELECTION",t):t.company_present?t.company_ar_attached?e.submitPayment({ar_type:"company"}):m.getPermissionValue("CREATE_AR_ACCOUNT")?H({account_id:t.company_id,is_auto_assign_ar_numbers:t.is_auto_assign_ar_numbers}):(e.account_id=t.company_id,s.open({template:"/assets/partials/payment/rvAccountReceivableMessagePopup.html",controller:"RVAccountReceivableMessagePopupCtrl",className:"",scope:e})):t.travel_agent_present?t.travel_agent_ar_attached?e.submitPayment({ar_type:"travel_agent"}):m.getPermissionValue("CREATE_AR_ACCOUNT")?H({account_id:t.travel_agent_id,is_auto_assign_ar_numbers:t.is_auto_assign_ar_numbers}):(e.account_id=t.travel_agent_id,s.open({template:"/assets/partials/payment/rvAccountReceivableMessagePopup.html",controller:"RVAccountReceivableMessagePopupCtrl",className:"",scope:e})):e.errorMessage=[d("translate")("ACCOUNT_ID_NIL_MESSAGE_PAYMENT")]},function(t){e.$emit("PAYMENT_FAILED",t),e.$emit("hideLoader")}):e.submitPayment()};var U=null,V=function(t){i(function(){s.open({template:"/assets/partials/rvConfirmDirectBillPaymentPopup.html",className:"",controller:"confirmDirectBillPopupCtrl",scope:e,closeByDocument:!1,data:JSON.stringify(t)})},0)};o.$on("ngDialog.opened",function(e,t){U=t.attr("id")}),e.$on("CONFIRMED_DB_PAYMENT",function(t,a){e.payment.isConfirmedDBpayment=!0,e.submitPayment(a)});var j=function(){e.$emit("SHOW_BILL_PAYMENT_POPUP"),s.close(U)};e.$on("CANCELLED_CONFIRM_DB_PAYMENT",function(){j()});var K=function(){return!e.hotelConfig.isStandAlone&&o.hotelDetails.enable_emv_for_overlay&&"DEPOSIT_BALANCE_PAYMENT"===e.actionType};e.submitPayment=function(a){var n,r,i=["Please enter a valid amount"];return t.isValidAmount(e.payment.amount)?(e.errorMessage="",r=p(a),r.isShift4Request="SHIFT4"===e.hotelConfig.paymentGateway&&"CC"===e.selectedPaymentType,"CC"!==e.selectedPaymentType||"sixpayments"!==e.hotelConfig.paymentGateway&&("SHIJI"!==e.hotelConfig.paymentGateway||o.hotelDetails.shiji_token_enable_offline)&&!K()||e.payment.isManualEntryInsideIFrame?"CC"===e.selectedPaymentType&&F&&!e.payment.isManualEntryInsideIFrame?void e.$broadcast("INITIATE_CHIP_AND_PIN_PAYMENT",r):"CC"===e.selectedPaymentType&&"CBA"===e.hotelConfig.paymentGateway?void e.$broadcast("INITIATE_CBA_PAYMENT",r):"CBA"===e.selectedPaymentType&&"CBA_AND_MLI"===e.hotelConfig.paymentGateway?void(Y||t.mockCba?e.$broadcast("INITIATE_CBA_PAYMENT",r):e.errorMessage=e.errorMessage=[d("translate")("USE_IPAD_TO_USE_CBA")]):"SHIJI"!==e.hotelConfig.paymentGateway||"ALIPAY"!==e.selectedPaymentType&&"WECHAT"!==e.selectedPaymentType?"DB"!==e.selectedPaymentType||e.payment.isConfirmedDBpayment?(n="CC"===e.selectedPaymentType&&e.selectedCard!==-1?e.selectedCC.value:null,"GIFT_CARD"===r.postData.payment_type?r.postData.card_number=$.trim(e.giftCard.number):r.postData.payment_type_id=n,e.isPenalty&&(r.postData.is_cancellation_penalty=!0),l.start("SUBMIT_PAYMENT"),void t.submitPayment(r).then(function(t){e.onPaymentSuccess(t),l.stop("SUBMIT_PAYMENT"),e.payment.isConfirmedDBpayment&&s.close()},function(t){"DB"===e.selectedPaymentType&&e.payment.isConfirmedDBpayment&&(j(),e.payment.isConfirmedDBpayment=!1),T(t)})):(e.$emit("HIDE_BILL_PAYMENT_POPUP"),void V(r.postData)):void e.$broadcast("INITIATE_SHIJI_PAYMENT",r):void e.$broadcast("INITIATE_CHIP_AND_PIN_PAYMENT",r)):void(e.errorMessage=i)},e.onChangeGiftCard=function(){var a=e.giftCard.number.length;a>=8&&a<=22?(l.start("FETCH_GIFT_CARD_BALANCE"),t.fetchGiftCardBalance(e.giftCard.number).then(function(t){e.giftCard.availableBalance=t.amount,e.giftCard.amountAvailable=!0,l.stop("FETCH_GIFT_CARD_BALANCE")},function(t){e.giftCard.amountAvailable=!1,e.errorMessage=t,l.stop("FETCH_GIFT_CARD_BALANCE")})):(e.giftCard.amountAvailable=!1,e.giftCard.availableBalance=null)},e.onPaymentInfoChange=function(t,a){if("AR_REFUND_PAYMENT"===e.actionType)return!1;t&&(e.payment.selectedPaymentCurrencyId=o.hotelCurrencyId,e.payment.selectedPaymentCurrencySymbol=o.currencySymbol,e.payment.amount=O,e.feeData.calculatedFee=e.originalFee),_.find(e.paymentTypes,{name:e.selectedPaymentType})||(e.selectedPaymentType="");var n=void 0;a?S(!0):S(),n=_.find(e.paymentTypes,{name:e.selectedPaymentType}),""!==e.selectedPaymentType&&e.$emit("PAYMENT_TYPE_CHANGED",e.selectedPaymentType),"DB"===e.selectedPaymentType?(e.payment.isEditable=!1,e.splitBillEnabled=!1,e.payment.amount=O,S()):e.payment.isEditable=void 0===e.isEditable||Boolean(e.isEditable),a&&e.payment.paymentCurrencyAmount&&(e.payment.amount=parseFloat(e.payment.paymentCurrencyAmount).toFixed(2)),n&&"CC"===n.name?((t||a)&&(e.payment.amount=O),e.payment.showAddToGuestCard=!!e.reservationId&&!e.payment.isManualEntryInsideIFrame,t&&"CC"===e.selectedPaymentType&&("SHIJI"===e.hotelConfig.paymentGateway&&o.hotelDetails.shiji_token_enable_offline||"ADYEN"===e.hotelConfig.paymentGateway)?P():r[e.hotelConfig.paymentGateway].iFrameUrl?(e.selectedCC=e.selectedCC||{},"CARD_ADD_MODE"===e.payment.screenMode||e.selectedCC.value||(e.payment.isManualEntryInsideIFrame=!1,e.selectedCC={}),e.payment.showAddToGuestCard=!!e.reservationId&&!e.payment.isManualEntryInsideIFrame):e.hotelConfig.isEMVEnabled&&"SHIFT4"!==e.hotelConfig.paymentGateway?(e.selectedCC=e.selectedCC||{},"CARD_ADD_MODE"===e.payment.screenMode||e.selectedCC.value||(e.payment.isManualEntryInsideIFrame=!1,e.selectedCC={}),e.payment.showAddToGuestCard=!!e.reservationId&&!e.payment.isManualEntryInsideIFrame):A()||e.showSelectedCard()||K()||P()):e.payment.showAddToGuestCard=!1,e.$emit("AMOUNT_UPDATED",e.payment.amount)},e.onPaymentCurrencyChange=function(){e.payment.selectedPaymentCurrencySymbol=_.find(e.paymentCurrencyList,{id:e.payment.selectedPaymentCurrencyId}).symbol;var a={amount:parseFloat(O),fee:parseFloat(e.originalFee),currency_id:parseInt(e.payment.selectedPaymentCurrencyId),date:o.businessDate};t.getConvertedAmount(a).then(function(t){e.payment.amount=t.data.converted_amount,e.feeData.calculatedFee=t.data.converted_fee,e.feeData.totalOfValueAndFee=parseFloat(e.payment.amount)+parseFloat(e.feeData.calculatedFee)},function(e){})},e.onFeeOverride=function(){var t=(parseFloat(e.feeData.calculatedFee)||0)+parseFloat(e.payment.amount);e.feeData.totalOfValueAndFee=t.toFixed(2)},e.propagateAddToggle=function(){e.$emit("PAYMENT_TOGGLE_ATTACH_TO_GUEST_CARD",e.payment.addToGuestCardSelected)},e.onCardClick=function(){P(),I()},e.cancelCardSelection=function(){e.errorMessage="",e.payment.screenMode="PAYMENT_MODE",e.payment.showAddToGuestCard=!1,e.selectedPaymentType="",e.$emit("PAYMENT_TYPE_CHANGED",e.selectedPaymentType),e.selectedCC={},S(),I()},e.setCreditCardFromList=function(t){var a=_.find(e.payment.linkedCreditCards,{value:t});e.selectedCC=a,e.payment.showAddToGuestCard=!1,e.payment.screenMode="PAYMENT_MODE",e.payment.amount=O,e.payment.tokenizedCardData=null,S()},e.hideCardToggles=function(){return"ADD_PAYMENT_GUEST_CARD"===e.actionType||"ADD_ROUTE_PAYMENT"===e.actionType||!v()};var W=function(t){e.$emit("hideLoader"),e.payment.linkedCreditCards=_.where(t.existing_payments,{is_credit_card:!0}),e.payment.shiji_token_enable_offline=t.shiji_token_enable_offline,e.payment.linkedCreditCards.length>0&&C("cardsList")},J=function(){if(e.reservationId){var a={billNumber:e.billNumber,reservationId:e.reservationId};l.start("FETCH_ATTACHED_CARDS"),t.getLinkedCardList(a).then(function(e){W(e),l.stop("FETCH_ATTACHED_CARDS")},function(t){e.$emit("PAYMENT_FAILED",t),l.stop("FETCH_ATTACHED_CARDS")})}else e.accountId?(l.start("FETCH_ATTACHED_CARDS"),t.getCoTaLinkedCardList(e.accountId).then(function(e){W(e),l.stop("FETCH_ATTACHED_CARDS")},function(t){e.$emit("PAYMENT_FAILED",t),l.stop("FETCH_ATTACHED_CARDS")})):e.postingAccountId?(l.start("FETCH_ATTACHED_CARDS"),t.getAccountsLinkedCardList(e.postingAccountId).then(function(e){W(e),l.stop("FETCH_ATTACHED_CARDS")},function(t){e.$emit("PAYMENT_FAILED",t),l.stop("FETCH_ATTACHED_CARDS")})):e.payment.linkedCreditCards=[]};e.$on(a.CC_TOKEN_GENERATED,function(t,a){var n=a.paymentData;e.payment.amount=O,e.errorMessage="",/^ADD_PAYMENT_/.test(e.actionType)||n.apiParams.mli_token?(D(),e.payment.tokenizedCardData=n,e.selectedCC=e.selectedCC||{},e.selectedCC.card_code=n.cardDisplayData.card_code,e.selectedCC.ending_with=n.cardDisplayData.ending_with,e.selectedCC.expiry_date=n.cardDisplayData.expiry_date,e.selectedCC.holder_name=n.apiParams.name_on_card||n.apiParams.card_name,i(function(){e.selectedPaymentType="CC",e.payment.screenMode="PAYMENT_MODE",a.forceSaveRoutine&&e.saveReservationPaymentMethod()},600)):e.payment.tokenizedCardData=null,"AR_SUBMIT_PAYMENT"===e.actionType?R(n):/^ADD_PAYMENT_/.test(e.actionType)||M(n),"ADYEN"!==e.hotelConfig.paymentGateway&&i(function(){I()},600)}),e.isRefund=function(){return e.payment.amount<0},e.showGiftCardToggle=function(){var t=_.find(e.paymentTypes,{name:"GIFT_CARD"});return!e.hotelConfig.isStandAlone&&!!t&&!e.hideOverlayGiftcard},e.onPaymentSuccess=function(t){e.paymentAttempted=!(e.splitBillEnabled&&e.numSplits>e.completedSplitPayments),e.isPaymentFailure=!1,e.payment.authorizationCode=t.authorization_code,t.amountPaid=t.amount,t.authorizationCode=t.authorization_code,t.selectedPaymentType=e.selectedPaymentType,t.selectedPaymentTypeDescription=_.findWhere(e.paymentTypes,{name:e.selectedPaymentType}).description,e.feeData&&(t.feePaid=e.feeData.calculatedFee,t.showFee=e.feeData.showFee),"CC"===e.selectedPaymentType&&(t.cc_details=angular.copy(e.selectedCC)),e.payment.showAddToGuestCard&&(t.add_to_guest_card=e.payment.addToGuestCardSelected),"AR_SUBMIT_PAYMENT"===e.actionType&&(t.allocatePaymentAfterPosting=e.payment.allocatePaymentAfterPosting),e.$emit("PAYMENT_SUCCESS",t)},e.clearErrorMessage=function(){e.errorMessage=""},e.showEmvModeSelection=function(){var t="MLI"===e.hotelConfig.paymentGateway&&e.hotelConfig.isEMVEnabled||"CBA_AND_MLI"===e.hotelConfig.paymentGateway&&e.hotelConfig.isEMVEnabled&&e.payment.isAddCardAction,a=!e.paymentAttempted||e.isPaymentFailure||e.splitBillEnabled&&e.numSplits>e.completedSplitPayments;return(t||"sixpayments"===e.hotelConfig.paymentGateway||"SHIJI"===e.hotelConfig.paymentGateway&&!o.hotelDetails.shiji_token_enable_offline||"SHIFT4"===e.hotelConfig.paymentGateway||K())&&"CC"===e.selectedPaymentType&&"PAYMENT_MODE"===e.payment.screenMode&&a&&"AR_REFUND_PAYMENT"!==e.actionType},e.getShijiToken=function(){e.$broadcast("GET_SHIJI_TOKEN")},e.getShijiOfflineStatus=function(){return o.hotelDetails.shiji_token_enable_offline},function(){var a=void 0,n=void 0;if(e.actionType=e.actionType||"DEFAULT",e.fetchLinkedCards!==!1&&(e.fetchLinkedCards=!0),e.payment.isAddPaymentMode=!!e.actionType.match(/^ADD_PAYMENT/),e.$watch("amount",w),e.$watch("paymentCurrencyAmount",b),e.$watch("paymentTypes",function(){e.payment.creditCardTypes=N()}),e.$watch("isEditable",f),e.payment.amount=e.amount||0,e.payment.paymentCurrencyAmount=e.paymentCurrencyAmount||0,e.payment.isRateSuppressed=e.isRateSuppressed||!1,e.payment.isPenalty=e.isPenalty||!1,e.billNumber=e.billNumber||1,e.payment.linkedCreditCards=e.linkedCreditCards||[],e.payment.screenMode="PAYMENT_MODE",e.payment.addCCMode="ADD_CARD",e.payment.creditCardTypes=N(),e.payment.guestFirstName=e.firstName||"",e.payment.guestLastName=e.lastName||"",!e.hotelConfig)throw new Error("Need hotel config to proceed. Need the following params.\n isStandAlone, paymentGateway, workstationId, emvTimeout, mliMerchantId, and currencySymbol");e.hotelConfig.mliMerchantId=e.hotelConfig.mliMerchantId||"",e.hotelConfig.workstationId=e.workstationId||"",e.hotelConfig.emvTimeout=e.hotelConfig.emvTimeout||120,e.hotelConfig.paymentGateway=e.hotelConfig.paymentGateway||"","CBA"===e.hotelConfig.paymentGateway||"CBA_AND_MLI"===e.hotelConfig.paymentGateway?E():"SHIJI"===e.hotelConfig.paymentGateway&&g(),e.currencySymbol=e.hotelConfig.currencySymbol,e.fetchLinkedCards&&!A()&&J(),e.$emit("SET_SCROLL_FOR_EXISTING_CARDS"),"sixpayments"!==e.hotelConfig.paymentGateway&&"SHIJI"!==e.hotelConfig.paymentGateway||(e.payment.isManualEntryInsideIFrame=!0,e.payment.showAddToGuestCard=!e.payment.isManualEntryInsideIFrame),a=t.resolvePaths(e.hotelConfig.paymentGateway,{card_holder_first_name:e.payment.guestFirstName,card_holder_last_name:e.payment.guestLastName}),e.payment.iFrameUrl=a.iFrameUrl,e.paymentGatewayUIInterfaceUrl=a.paymentGatewayUIInterfaceUrl,e.payment.isAddCardAction=t.isAddCardAction(e.actionType),e.swipedCardData&&i(function(){F&&(e.payment.isManualEntryInsideIFrame=!0,e.toggleManualIframe()),e.$broadcast("RENDER_SWIPED_DATA",JSON.parse(e.swipedCardData))},300),e.hotelConfig.isStandAlone||A()||"CBA_AND_MLI"===e.hotelConfig.paymentGateway||K()||P(),i(function(){e.onPaymentInfoChange(!1,!0)},1e3),y("cardsList",{click:!0,tap:!0}),e.$watch("payment.screenMode",function(){e.$emit("PAYMENT_SCREEN_MODE_CHANGED",e.payment.screenMode)}),n=e.hotelConfig,F="sixpayments"===n.paymentGateway||"SHIFT4"===n.paymentGateway||"SHIJI"===n.paymentGateway&&!o.hotelDetails.shiji_token_enable_offline||("MLI"===n.paymentGateway||"CBA_AND_MLI"===n.paymentGateway)&&n.isEMVEnabled,e.paymentAttempted=!1,e.workStationStatus=!0,e.showSelectedCard(),o.isWorkStationMandatory&&e.checkWorkStationMandatoryFields(),"CC"===e.selectedPaymentType&&e.selectedCC&&"SHIJI"===e.hotelConfig.paymentGateway&&o.hotelDetails.shiji_token_enable_offline&&(e.payment.auth_code=e.selectedCC.auth_code)}()}]),angular.module("sntPay").directive("payCtrlLoaderDir",["$compile",function(e){return{transclude:"element",scope:{payCtrlLoaderDir:"="},link:function(t,a,n,r,o){var i=null;t.$watch("payCtrlLoaderDir",function(){i&&(i.remove(),i=null),o(function(n){"CBA"===t.payCtrlLoaderDir?n.attr("ng-controller","payCBACtrl"):"MLI"===t.payCtrlLoaderDir&&n.attr("ng-controller","payMLIOperationsController"),n.removeAttr("pay-ctrl-loader-dir"),i=e(n[0])(t),a.after(i)})})}}}]),angular.module("sntPay").directive("sntPayment",function(){return{restrict:"E",transclude:!0,scope:{hotelConfig:"=",paymentTypes:"=",selectedPaymentType:"=?",paymentCurrencyList:"=",receiptsList:"=",reservationId:"@",isFromWallet:"@",rateCurrency:"@",postingAccountId:"=?",billId:"=?",arTransactionId:"=?",accountId:"@",groupId:"@",allotmentId:"@",guestId:"@",billNumber:"=",amount:"=",isPenalty:"=?",paymentCurrencyAmount:"=?",selectedCC:"=?",referenceText:"=?",actionType:"@",depositPolicyName:"@",isEditable:"=?",isRateSuppressed:"=?",workstationId:"@",hasPermission:"=?",formTemplateUrl:"@",firstName:"@?",lastName:"@?",swipedCardData:"@",splitBillEnabled:"=?",numSplits:"=?",completedSplitPayments:"=?",fetchLinkedCards:"=?",hideOverlayGiftcard:"=?",reservationIds:"=?",onlyPaymentSelection:"=?",hasPaymentRounding:"=?",allowDirectBill:"<?"},link:function(e,t,a){},templateUrl:"/assets/partials/sntPaymentHome.html",controller:"sntPaymentController"}});var CBAMockOperation=function(){var e=this,t={account_type:2,amount:1,auth_code:"",binary_format:"A",card_name:"VISA ISMP",card_sequence:"01",card_type:"VA",currency_code:"",custom_data:"",cvv:"",data_field:"",date_settlement:"200416",expiry_date:"0425",pan:"494052******5694",processed_offline:"0",rrn:"",tid:"13600822",track1:"",track2:"494052******5694=1804????????????????",transaction_date:"131016",transaction_time:"001850",txn_id:"1"},a=[{RVErrorCode:143,RVErrorDesc:"Device Not Connected."},{RVErrorCode:144,RVErrorDesc:"Transaction was not processed by PIN pad."},{RVErrorCode:145,RVErrorDesc:"A transaction is pending with the terminal."},{RVErrorCode:114,RVErrorDesc:"The Argument 'transaction_id' not valid."}],n={RVCardReadCardIIN:"494052",RVCardReadCardName:"VISA ISMP",RVCardReadCardType:"VI",RVCardReadETB:"",RVCardReadETBKSN:"",RVCardReadExpDate:"1804",RVCardReadIsEncrypted:"0",RVCardReadMaskedPAN:"494052******5694",RVCardReadTrack1:"B494052******5694^??????????????????????????^1804???????????????????????????",RVCardReadTrack1KSN:"",RVCardReadTrack2:"494052******5694=1804????????????????",RVCardReadTrack2KSN:"",RVCardReadTrack3:"",RVCardReadTrack3KSN:""},r={txn_id:"1",last_txn_success:function(){return Math.random()>.5?0:1}(),amount:"1.00",tid:"12356",transaction_date:"",transaction_time:"",date_settlement:"",card_name:"",card_type:"",card_sequence:"",track1:"",track2:"",pan:"",expiry_date:"",cvv:"",currency_code:"",binary_format:"",data_field:"",custom_data:"",state_vars:""};e.callCordovaService=function(e){
switch(e.action){case"doPayment":e.successCallBack(t);break;case"doRefund":window.setTimeout(function(){},2e3);break;case"addCard":window.setTimeout(function(){e.successCallBack(n)},2e3);break;case"getLastTransaction":window.setTimeout(function(){e.successCallBack(r)},2e3);break;default:e.failureCallBack(a)}}};angular.module("sntPay").service("sntAdyenGatewaySrv",["$q","rvBaseWebSrvV2","$http","$timeout","$interval","$log",function(e,t,a,n,r,o){var i=this,s=!0;i.createSession=function(){var a=e.defer();return t.getJSON("/api/ipage/adyen").then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},i.initiatePayment=function(e,t){return a.post("api/reservations/"+e+"/submit_payment/",t)},i.stopPolling=function(){s=!1},i.pollPaymentStatus=function(t,i){var d=e.defer(),c=1e3,l=120,m="/api/async_callbacks/",u=0,p=2e3,_=r(function(){u++},c),y=function e(){u>=i?(clearInterval(_),o.warn("timeout: [shift4] transaction timed out after "+i+". from hotel_settings.json emv_timeout"),d.reject(["Request timed out. Unable to process the transaction"])):s?a.get(m+t).then(function(t){var a=t.data,r=t.status;202===r||102===r||250===r?n(function(){o.info("polling: [shift4] waiting for response"),e()},p):(clearInterval(_),d.resolve(a))},function(t){t.data?(clearInterval(_),d.reject(t.data)):e()}):(clearInterval(_),d.reject(["Payment action cancelled"]))};return s=!0,i=i||l,y(),d.promise}}]),angular.module("sntPay").service("sntCBAGatewaySrv",["$q","$http","$log","$timeout","$rootScope","sntPaymentSrv",function(e,t,a,n,r,o){var i=this,s=!1,d=new CardOperation,c={AX:"AX",DC:"DC",DS:"DS",JCB:"JCB",ADC:"DC",MC:"MC",VA:"VA",MS:"MA",JC:"JCB",VI:"VA",CA:"MC",TO:"MA"};document.addEventListener("MOCK_CBA",function(){d=new CBAMockOperation,o.mockCba=!0}),i.initiateTransaction=function(e,a){return t.post("/api/cc/",{amount:e,bill_id:a,credit_card_transaction_type:Number(e)>0?"PAYMENT":"REFUND"})},i.updateTransactionSuccess=function(e,a){var n=a.expiry_date,r="20";if(4!==n.length)throw new Error("The UI expects MMYY format date as the cordovaResponse!");var o=n.match(/.{1,2}/g);return r+=[o[1],o[0],"01"].join("-"),t.put("/api/cc/"+e,{status:!0,req_reference_no:a.rrn,external_transaction_ref:a.tid,authorization_code:a.auth_code,external_print_data:a.custom_data,external_message:null,payment_method:{payment_type:"CBA",do_not_attach_cc_to_bill:!0,card_name:a.card_name,card_expiry:r,mli_token:a.pan,credit_card_type:a.card_type,card_number:a.pan}})},i.updateTransactionFailure=function(e,a){return t.put("/api/cc/"+e,{status:!1,external_failure_reason:a.RVErrorCode,external_message:a.RVErrorDesc})},i.doPayment=function(e,t,a){d.callCordovaService({arguments:[JSON.stringify(e)],service:"RVCardPlugin",action:"doPayment",successCallBack:t,failureCallBack:a})},i.doRefund=function(e,t,a){d.callCordovaService({arguments:[JSON.stringify(e)],service:"RVCardPlugin",action:"doRefund",successCallBack:t,failureCallBack:a})},i.addCard=function(e,t){d.callCordovaService({service:"RVCardPlugin",action:"addCard",successCallBack:e,failureCallBack:t})},i.finishTransaction=function(e){a.info("finishTransaction for :",e),d.callCordovaService({service:"RVCardPlugin",action:"finishTransaction",arguments:[e.toString()],successCallBack:function(e){a.info("finishTransaction",e)},failureCallBack:function(e){a.error("finishTransaction",e)}})},i.checkLastTransactionStatus=function(e){a.info("checkLastTransactionStatus"),s||(s=!0,d.callCordovaService({service:"RVCardPlugin",action:"getLastTransaction",successCallBack:function(t){s=!1,a.info("checkLastTransactionStatus",t),e&&r.$emit("UPDATE_NOTIFICATION","PLEASE TRY AGAIN!"),parseInt("data.last_txn_success",10)>0?i.updateTransactionSuccess(t.txn_id,t).then(function(e){i.finishTransaction(t.txn_id),a.info("updateTransactionSuccess",e)},function(e){a.error("updateTransactionSuccess",e)}):i.updateTransactionFailure(t.txn_id,t).then(function(e){i.finishTransaction(t.txn_id),a.info("updateTransactionSuccess",e)},function(e){a.error("updateTransactionSuccess",e)})},failureCallBack:function(t){s=!1,e&&r.$emit("UPDATE_NOTIFICATION",t.RVErrorCode+" "+t.RVErrorDesc),a.info("checkLastTransactionStatus",t),146===parseInt(t.RVErrorCode,10)&&(a.info("Failed to get transaction details... repeat cordova API call to check for pending transactions"),n(i.checkLastTransactionStatus,1e3)),a.warn(t)}}))},i.generateApiParams=function(e){var t="20",a=e.RVCardReadExpDate.match(/.{1,2}/g);return t+=[a[0],a[1],"01"].join("-"),{apiParams:{credit_card:e.RVCardReadCardType,card_expiry:t,card_name:e.RVCardReadCardName,payment_type:"CC",card_number:e.RVCardReadMaskedPAN},cardDisplayData:{card_code:(c[e.RVCardReadCardType]||e.RVCardReadCardType).toLowerCase(),ending_with:e.RVCardReadMaskedPAN.match(/[0-9]{4}$/)[0],expiry_date:a[1]+" / "+a[0],name_on_card:e.RVCardReadCardName}}}}]),angular.module("sntPay").service("sntEMVSharedSrv",["$q","$http","$location","PAYMENT_CONFIG","$log","$timeout","sntAuthorizationSrv","$rootScope","sntPaymentSrv","sntActivity",function(e,t,a,n,r,o,i,s,d,c){var l=this,m=function(e,t){return{response:{id:e.payment_method_id||e.guest_payment_method_id,guest_payment_method_id:e.guest_payment_method_id,payment_name:"CC",usedEMV:!0},selectedPaymentType:"CC",cardDetails:{card_code:t.toLowerCase(),ending_with:e.ending_with,expiry_date:e.expiry_date,card_name:"",is_swiped:e.is_swiped}}},u=function(e,t){c.toggleEMVIndicator(),d.getSixPaymentToken(e).then(function(e){var a=e.card_type||"";t.resolve(m(e,a)),c.toggleEMVIndicator()},function(e){r.info("Tokenization Failed"),t.reject(e),c.toggleEMVIndicator()})};l.addCardInTerminal=function(t){var a=e.defer();return t.is_emv_request=!0,r.info("addCardInTerminal",t),u(t,a),a.promise}}]),angular.module("sntPay").service("sntPaymentSrv",["$q","$http","$location","PAYMENT_CONFIG","$log","$timeout","sntAuthorizationSrv",function(e,t,a,n,r,o,i){var s=this,d={},c=3e3;s.set=function(e,t){d[e]=t},s.get=function(e){return d[e]};var l=function(e,t,a,n){e.split("?")[0];406===n?t.reject(a):422===n?t.reject(a):500===n?t.reject(["Internal server error occured"]):501===n||502===n||503===n||504===n?$window.location.href="/500":n>=470&&n<=490?(a.httpStatus=n,a.errorMessage=a,t.reject(a)):404===n||t.reject(a)};s.submitPayment=function(a,n){var n=n||e.defer(),r="";return a.reservation_id?r="api/reservations/"+a.reservation_id+"/submit_payment":(r="api/bills/"+a.bill_id+"/submit_payment",a.postData.payment_method_id=a.postData.payment_type_id),t.post(r,a.postData).then(function(e){n.resolve(e.data)},function(e){a.isShift4Request?(delete a.isShift4Request,a.postData.check_transaction=!0,s.submitPayment(a,n)):n.reject(e.data)}),n.promise},s.getLinkedCardList=function(a){var n=e.defer(),r="/staff/staycards/get_credit_cards.json?reservation_id="+a.reservationId+"&bill_number="+a.billNumber;return t.get(r).then(function(e){n.resolve(e.data.data)},function(e){n.reject(e)}),n.promise},s.getAccountsLinkedCardList=function(a){var n=e.defer(),r="staff/payments/fetch_attached_credit_cards?posting_account_id="+a;return t.get(r).then(function(e){n.resolve(e.data.data)},function(e){n.reject(e)}),n.promise},s.getCoTaLinkedCardList=function(a){var n=e.defer(),r="staff/payments/fetch_attached_credit_cards?account_id="+a;return t.get(r).then(function(e){n.resolve(e.data.data)},function(e){n.reject(e)}),n.promise},s.getConvertedAmount=function(a){var n=e.defer(),r="/api/hotel_currency_conversions/converted_payment_amount?amount="+a.amount+"&currency_id="+a.currency_id+"&date="+a.date+"&fee="+a.fee;return t.get(r).then(function(e){n.resolve(e.data)},function(e){n.reject(e)}),n.promise},s.checkWorkStationMandatoryFields=function(a){var n=e.defer(),r="/api/workstations/workstation_status?workstation_id="+a;return t.get(r).then(function(e){n.resolve(e.data)},function(e){n.reject(e)}),n.promise},s.calculateFee=function(e,t){var a="",n=0,r=0,o=0,i="",s="",d="",c="";t&&(a=t.amount_symbol,n=t.amount?parseFloat(t.amount):0,r=t.default_payment_currency_fee?parseFloat(t.default_payment_currency_fee):0,o=t.minimum_amount_for_fees?parseFloat(t.minimum_amount_for_fees):0);var l=e?parseFloat(e):0;if("percent"===a){var m=parseFloat(l*(n/100));i=parseFloat(m).toFixed(2),s=i,d=parseFloat(m+l).toFixed(2),c=d}else i=parseFloat(n).toFixed(2),s=parseFloat(r).toFixed(2),d=parseFloat(l+n).toFixed(2),c=parseFloat(l+r).toFixed(2);return{calculatedFee:i,calculatedPaymentFee:s,feeChargeCode:t.charge_code_id,minFees:o,defaultAmount:l,totalOfValueAndFee:d,totalOfValueAndPaymentFee:c,showFees:l>=o&&!!l&&!!n}},s.getSixPayCreditCardType=function(e){var t={AX:"AX",DI:"DS",DN:"DC",JC:"JCB",MC:"MC",VS:"VA",VX:"VA",MX:"DS",MV:"MC",CU:"CU",DK:"DK"};return t[e.toUpperCase()]||"credit-card"},s.submitPaymentForChipAndPin=function(a){var n=e.defer(),i="";a.reservation_id?i="api/reservations/"+a.reservation_id+"/submit_payment":(i="api/bills/"+a.bill_id+"/submit_payment",a.postData.payment_method_id=a.postData.payment_type_id);var s=0,d=function(){s++},m=setInterval(d,1e3),u=function e(i){if(s>=a.emvTimeout){var d=["Request timed out. Unable to process the transaction"];n.reject(d)}else t.get(i).then(function(t){var a=t.data,s=t.status;202===s||102===s||250===s?o(function(){r.info("POLLING::-> for emv terminal response"),e(i)},c):(clearInterval(m),n.resolve(a))},function(t){"undefined"==typeof t.data?e(i):(clearInterval(m),n.reject(t.data))})};return t.post(i,a.postData).then(function(e){var t=e.data,a=e.status,r=e.headers;if(202===a||102===a||250===a){var o=r("Location");u(o)}else n.resolve(t)},function(e){var t=e.data,a=e.staus;l(i,n,t,a)}),n.promise},s.getSixPaymentToken=function(a){var n=e.defer(),i="/api/cc/get_token.json",s=0,d=function(){s++},m=setInterval(d,1e3),u=function e(i){if(s>=a.emvTimeout){var d=["Request timed out. Unable to process the transaction"];n.reject(d)}else t.get(i).then(function(t){var a=t.data,s=t.status;202===s||102===s||250===s?o(function(){r.info("POLLING::-> for emv terminal response"),e(i)},c):(clearInterval(m),n.resolve(a))},function(t){var a=t.data;"undefined"==typeof a?e(i):(clearInterval(m),n.reject(a))})};return t.post(i,a).then(function(e){var t=e.data,a=e.status,r=e.headers;if(202===a||102===a||250===a){var o=r("Location");u(o)}else n.resolve(t)},function(e){var t=e.data,a=e.staus;l(i,n,t,a)}),n.promise},s.fetchMLISessionDetails=function(e,t,a){var n=function(e){"ok"===e.status?t(e):a(e)};HostedForm.updateSession(e,n)},s.fetchMLIToken=function(e,t,a){var n=function(e){t(e)},r=function(e){var t=["There is a problem with your credit card"];a(t)};if(e.cardNumber.length>0)try{s.fetchMLISessionDetails(e,n,r)}catch(e){var o=["There was a problem connecting to the payment gateway."];a(o)}else{var o=["There is a problem with your credit card"];a(o)}},s.resolvePaths=function(e,t){var a="",r=n[e].partial,o=function(){var r=(new Date).getTime(),o=n[e].params.service_action,s=localStorage.getItem("jwt")||"";return a=n[e].iFrameUrl+"?card_holder_first_name="+t.card_holder_first_name+"&card_holder_last_name="+t.card_holder_last_name+"&service_action="+o+"&time="+r+"&auth_token="+s+"&hotel_uuid="+i.getProperty()};switch(e){case"MLI":case"CBA":case"CBA_AND_MLI":break;case"SHIJI":case"sixpayments":case"ADYEN":a=o();break;case"SHIFT4":a=o();break;default:throw new Error("Payment Gateway not configured")}return{iFrameUrl:a,paymentGatewayUIInterfaceUrl:r}},s.fetchGiftCardBalance=function(a){var n=e.defer(),r="/api/gift_cards/balance_inquiry";return t.post(r,{card_number:a}).then(function(e){n.resolve(e.data)},function(e){n.reject(e.data)}),n.promise},s.savePaymentDetails=function(a){var n=e.defer(),r="/staff/reservation/save_payment";return t.post(r,a).then(function(e){var t=e.data;"failure"===t.status?n.reject(t.errors):n.resolve(t)},function(e){n.reject(e.data)}),n.promise},s.addBillPaymentMethod=function(a){var n=e.defer(),r="/api/bills/"+a.billId+"/add_payment_method";return t.post(r,a.payLoad).then(function(e){n.resolve(e.data)},function(e){n.reject(e.data)}),n.promise},s.mapPaymentToReservation=function(a){var n=e.defer(),r="/staff/reservation/link_payment";return t.post(r,a).then(function(e){"success"===e.data.status?n.resolve(e.data):n.reject(e.data.errors)},function(e){n.reject(e.data)}),n.promise},s.addCardToGuest=function(a){var n=e.defer(),r="staff/payments/save_new_payment";return t.post(r,a).then(function(e){var t=e.data;t.errors&&t.errors.length>0?n.reject(t.errors):n.resolve(t)},function(e){n.reject(e.data)}),n.promise},s.checkARStatus=function(a){var n=e.defer(),r="api/posting_accounts/"+a+"/check_ar_account_attached";return t.get(r).then(function(e){n.resolve(e.data)},function(e){n.reject(e.data)}),n.promise},s.saveARDetails=function(a){var n=e.defer(),r="api/accounts/save_ar_details";return t.post(r,a).then(function(e){n.resolve(e.data)},function(e){n.reject(e.data)}),n.promise},s.isValidAmount=function(e){return!!e&&!isNaN(Number(e))&&0!==Number(e)},s.isAddCardAction=function(e){var t=["ADD_PAYMENT_GUEST_CARD","ADD_PAYMENT_BILL","ADD_PAYMENT_STAY_CARD"];return _.contains(t,e)},s.sampleMLISwipedCardResponse={cardType:"VA",cardNumber:"xxxx-xxxx-xxxx-0135",nameOnCard:"UAT USA/TEST CARD 19",cardExpiry:"9912",cardExpiryMonth:"12",cardExpiryYear:"99",et2:"",ksn:"FFFF987654165420000E",pan:"476173000000**35",etb:"DA9693715C1DC7B6183F830BF0713E9FE849D0275D30FFF2677F44FB34383B4BE8A2CE89D62D2CC138668CFB914C2D998602969CC58326B5BDD1585174A846FD90096C75903BA1907C4B820B3AE9441F317F21DBDB2CCE8327E24C56CE6866A39085467D0C4D15528B1240C8777B83634DEA58EFD3D90AA3",token:"8045832471460135",isEncrypted:!0},s.mockCba=!1,s.getShijiPayCreditCardType=function(e){var t={"American Express":"AX","Discover Card":"DS",JCB:"JCB",MasterCard:"MC",Visa:"VA"};return t[e]||""},s.fethWorkStationData=function(a){var n=e.defer(),r="api/workstations/"+a;return s.workstationData?n.resolve(s.workstationData):t.get(r).then(function(e){s.workstationData=e.data,n.resolve(e.data)},function(e){n.reject(e.data)}),n.promise}}]);var _extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e};angular.module("sntPay").service("paymentUtilSrv",["paymentConstants",function(e){var t=this,a="session",n="mli_token",r="session";this.formParamsForFetchingTheToken=function(e){return{cardNumber:e.cardNumber,cardSecurityCode:e.CCV,cardExpiryMonth:e.expiryMonth,cardExpiryYear:e.expiryYear}},this.getCreditCardTypeForMLI=function(e){e=e||"credit-card";var t=e.toUpperCase(),a=creditCardTypes[t]||e;return a.toLowerCase()},this.formCCTokenGeneratedParams=function(e){return{apiParams:t.formApiParamsForCreditCardSaving(e),cardDisplayData:t.formCardDisplayData(e)}},this.formCardDisplayData=function(e){var a=e.cardType;return n in e?a=t.getCreditCardTypeForMLI(e.cardType):r in e&&(a=t.getCreditCardTypeForMLI(e.cardBrand)),{card_code:a,name_on_card:e.nameOnCard,ending_with:e.cardNumber.slice(-4),expiry_date:e.expiryMonth+" / "+e.expiryYear}},this.formApiParamsForCreditCardSaving=function(e){var t={};a in e?(t.token=e.session,t.card_code=e.cardType):n in e&&(t={credit_card:e.cardType},["et2","ksn","pan","mli_token","etb","is_encrypted"].map(function(a){t[a]=e[a]}));var r=e.expiryMonth&&e.expiryYear;return _extends({},t,{card_name:e.nameOnCard,payment_type:"CC",card_expiry:r?"20"+e.expiryYear+"-"+e.expiryMonth+"-01":""})}}]),angular.module("sntPay").service("sntShift4GatewaySrv",["$q","$http","$timeout","$interval",function(e,t,a,n){var r=this;r.getIframeConfig=function(){var a=e.defer(),n="/api/ipage/shift4";return t.get(n).then(function(e){a.resolve(e.data)},function(e){a.reject(e.data)}),a.promise},r.promptCardRead=function(e,a,n){return a.emv_terminal_id?t.post(n.utg_url+"/api/rest/v1/tokens/add",{dateTime:moment().format("YYYY-MM-DDTHH:mm:ss.SSSZ"),device:{terminalId:a.emv_terminal.terminal_identifier},apiOptions:["RETURNEXPDATE"]},{headers:{"Content-Type":"application/json",AccessToken:n.access_token}}).then(function(t){e.resolve(t.data)},function(t){e.reject()}):e.reject(["Payment terminal not configured for the workstation - "+a.name]),e.promise},r.startPromptCard=function(t){var a=e.defer();return r.getIframeConfig().then(function(e){r.promptCardRead(a,t,e)},function(e){a.reject(e)}),a.promise}}]),angular.module("sntPay").service("sntShijiGatewaySrv",["$q","$http","$timeout","$interval","$log",function(e,t,a,n,r){var o=this,i=!0;o.initiatePayment=function(e,a){return t.post("api/reservations/"+e+"/submit_payment/",a)},o.stopPolling=function(){i=!1},o.pollPaymentStatus=function(o,s){var d=e.defer(),c=1e3,l=120,m="/api/async_callbacks/",u=0,p=2e3,_=n(function(){u++},c),y=function e(){u>=s?(clearInterval(_),r.warn("timeout: [shiji] transaction timed out after "+s+". from hotel_settings.json emv_timeout"),d.reject(["Request timed out. Unable to process the transaction"])):i?t.get(m+o).then(function(t){var n=t.data,o=t.status;202===o||102===o||250===o?a(function(){r.info("polling: [shiji] waiting for response"),e()},p):(clearInterval(_),d.resolve(n))},function(t){t.data?(clearInterval(_),d.reject(t.data)):e()}):(clearInterval(_),d.reject(["Payment action cancelled"]))};return i=!0,s=s||l,y(),d.promise}}]),angular.module("sntPay").run(["$rootScope","sntCBAGatewaySrv",function(e,t){var a=e.$on("CBA_PAYMENT_POWER_FAILURE_CHECK",function(){sntapp.cordovaLoaded&&t.checkLastTransactionStatus()});e.$on("$destroy",a)}]),angular.module("sntPay").config(["$httpProvider",function(e){e.interceptors.push("sharedHttpInterceptor")}]);