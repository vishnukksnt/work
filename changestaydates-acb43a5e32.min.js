sntRover.controller("RVchangeStayDatesController",["$state","$stateParams","$rootScope","$scope","stayDateDetails","RVChangeStayDatesSrv","$filter","ngDialog","rvPermissionSrv","RVReservationBaseSearchSrv","$timeout","RVNightlyDiarySrv","RVReservationStateService",function(e,t,a,i,r,o,n,s,l,c,u,d,h){BaseCtrl.call(this,i);var f=a.maxStayLength,v=470;i.hasOverBookRoomTypePermission=l.getPermissionValue("OVERBOOK_ROOM_TYPE"),i.hasOverBookHousePermission=l.getPermissionValue("OVERBOOK_HOUSE"),i.hasBorrowFromHousePermission=l.getPermissionValue("GROUP_HOUSE_BORROW"),a.setPrevState={title:n("translate")("STAY_CARD"),callback:"goBack",scope:i};var m="rover.reservation.staycard.mainCard.room-rates";a.setNextState={data:{isFromChangeStayDates:!0}};var p=this,g=n("translate")("CHANGE_STAY_DATES_TITLE");i.$emit("HeaderChanged",g),i.setTitle(g),i.isChanging=!1,i.requireAuthorization=!1;var y=!0,D={preventDefault:!1};i.setScroller("edit_staydate_updatedDetails",D),i.setScroller("edit_staydate_calendar",D),i.hasCCAuthPermission=function(){return l.getPermissionValue("OVERRIDE_CC_AUTHORIZATION")},this.dataAssign=function(){i.stayDetails=r,i.stayDetails.isOverlay=!1,i.stayDetails.validDays=[],i.checkinDateInCalender=i.confirmedCheckinDate=tzIndependentDate(i.stayDetails.details.arrival_date),i.checkoutDateInCalender=i.confirmedCheckoutDate=tzIndependentDate(i.stayDetails.details.departure_date),i.rightSideReservationUpdates="",i.roomSelected=i.stayDetails.details.room_number,i.calendarNightDiff="",i.avgRate="",i.availableRooms=[]},this.renderFullCalendar=function(){i.events=i.getEventSourceObject(i.checkinDateInCalender,i.checkoutDateInCalender),i.eventSources=[i.events],i.fullCalendarOptions={height:450,header:{left:"prev",center:"title",right:"next"},year:i.confirmedCheckinDate.getFullYear(),month:i.confirmedCheckinDate.getMonth(),day:i.confirmedCheckinDate.getDate(),editable:!0,disableResizing:!1,contentHeight:320,weekMode:"fixed",ignoreTimezone:!1,eventDrop:i.changedDateOnCalendar,eventAfterRender:function(e,t){"startEditable"in e&&"ontouchstart"in document.documentElement&&t.draggable()},viewRender:function(e,t){y||(i.$apply(function(){i.isChanging=!0,i.$emit("showLoader")}),setTimeout(function(){i.$apply(function(){i.isChanging=!1,i.$emit("hideLoader")})},0)),y=!1}},setTimeout(function(){i.refreshScroller("edit_staydate_calendar")},0)},this.initialise=function(){p.dataAssign(),a.isStandAlone&&(p.checkIfStaydatesCanBeExtended()||(i.rightSideReservationUpdates="NO_HOUSE_AVAILABLE",i.refreshMyScroller())),p.renderFullCalendar()},this.hasMultipleRates=function(){var e=i.stayDetails.calendarDetails,t=i.checkinDateInCalender,a=i.checkoutDateInCalender,r="";if("true"===e.has_multiple_rates){for(var o=e.available_dates.length-1;o>=0;o--)r=tzIndependentDate(e.available_dates[o].date),(r<t||r>a)&&i.stayDetails.calendarDetails.available_dates.splice(o,1);return!0}return!1},this.checkIfStaydatesCanBeExtended=function(){var e=i.stayDetails.calendarDetails,t=e.reservation_status,a=i.checkinDateInCalender,r=i.checkoutDateInCalender,o="",n=!1;return $(e.available_dates).each(function(e){return o=tzIndependentDate(this.date),"CHECKEDIN"!==t&&"CHECKING_OUT"!==t&&o<a?(n=!0,!1):o>r?(n=!0,!1):void 0}),n},i.errorCallbackCheckUpdateAvaibale=function(e){i.$emit("hideLoader"),i.errorMessage=e},i.successCallbackCheckUpdateAvaibale=function(e){if(i.stayDetails.isOverlay=!0,i.$emit("hideLoader"),i.availabilityDetails=e,i.requireAuthorization=e.require_cc_auth,i.checkAvailabilityStatus(),a.isStandAlone&&e.restrictions.length>0&&("room_available"===i.availabilityDetails.availability_status||"room_type_available"===i.availabilityDetails.availability_status))return i.rightSideReservationUpdates="RESTRICTION_EXISTS",i.stayDetails.restrictions=e.restrictions,i.refreshMyScroller(),!1};var S=function(){return l.getPermissionValue("OVERBOOK_ROOM_TYPE")};i.checkAvailabilityStatus=function(){"room_available"===i.availabilityDetails.availability_status?i.showRoomAvailable():"room_type_available"===i.availabilityDetails.availability_status?p.showRoomTypeAvailable(i.availabilityDetails):"not_available"===i.availabilityDetails.availability_status?S()?i.showOverBookingAlertForStayExtension():p.showRoomNotAvailable():"to_be_unassigned"===i.availabilityDetails.availability_status?(i.rightSideReservationUpdates="PREASSIGNED",i.stayDetails.preassignedGuest=i.availabilityDetails.preassigned_guest):"maintenance"===i.availabilityDetails.availability_status?i.rightSideReservationUpdates="MAINTENANCE":"do_not_move"===i.availabilityDetails.availability_status?i.rightSideReservationUpdates="ROOM_CANNOT_UNASSIGN":"room_ooo"===i.availabilityDetails.availability_status?i.rightSideReservationUpdates="ROOM_OOO":"room_is_inhouse"===i.availabilityDetails.availability_status?i.rightSideReservationUpdates="ROOM_IN_HOUSE":"no_room_move"===i.availabilityDetails.availability_status&&(i.rightSideReservationUpdates="NO_ROOM_MOVE"),i.refreshMyScroller()},this.showRestrictedStayRange=function(){i.rightSideReservationUpdates="STAY_RANGE_RESTRICTED",i.refreshMyScroller()},this.showRoomNotAvailable=function(){i.rightSideReservationUpdates="ROOM_NOT_AVAILABLE",i.refreshMyScroller()},this.showRestrictedStayRange=function(){i.rightSideReservationUpdates="STAY_RANGE_RESTRICTED",i.refreshMyScroller()},this.showRoomNotAvailable=function(){i.rightSideReservationUpdates="ROOM_NOT_AVAILABLE",i.refreshMyScroller()},p.showRoomTypeAvailable=function(e){i.availableRooms=e.rooms,i.rightSideReservationUpdates="ROOM_TYPE_AVAILABLE",i.refreshMyScroller()},i.showRoomAvailable=function(){var e=i.checkoutDateInCalender.getTime()-i.checkinDateInCalender.getTime();i.calendarNightDiff=Math.ceil(e/864e5),i.totRate=0,i.isStayRatesSuppressed=!1;var t="";$(i.stayDetails.calendarDetails.available_dates).each(function(e){return"true"===this.is_sr?(i.isStayRatesSuppressed=!0,!1):(tzIndependentDate(this.date).getTime()>=i.checkinDateInCalender.getTime()&&tzIndependentDate(this.date).getTime()<i.checkoutDateInCalender.getTime()&&(i.totRate+=""===escapeNull(this.rate)?0:parseInt(this.rate),i.totCurrencySymbol=this.rate_currency),void(this.date===i.stayDetails.details.arrival_date&&(t=""===i.escapeNull(this.rate)?0:parseInt(this.rate))))});var a=i.stayDetails.calendarDetails.available_dates[0].date,r=_.findIndex(i.stayDetails.calendarDetails.stay_dates,{date:a}),o=_.first(i.stayDetails.calendarDetails.stay_dates,parseInt(r));$(o).each(function(e){i.totRate+=""===escapeNull(this.rate)?0:parseInt(this.rate),i.totCurrencySymbol=this.rate_currency}),i.isStayRatesSuppressed||(i.calendarNightDiff>0?i.avgRate=Math.round(100*(i.totRate/i.calendarNightDiff+1e-5)/100):(i.totRate=t,i.avgRate=Math.round(i.totRate+1e-5))),i.rightSideReservationUpdates="ROOM_AVAILABLE",i.refreshMyScroller()},i.roomSelectedFromList=function(e){i.roomSelected=e,i.showRoomAvailable()},i.continueWithoutCC=function(){i.requireAuthorization=!1,i.confirmUpdates(),i.closeDialog()},i.continueAfterSuccessAuth=function(){i.goBack(),i.closeDialog()},this.successCallbackConfirmUpdates=function(e){i.$emit("hideLoader"),i.closeDialog(),i.goBack()},this.failureCallbackConfirmUpdates=function(e){if(i.$emit("hideLoader"),e.httpStatus===v&&e.results&&e.results.is_borrowed_from_house){var t=e.results;i.borrowData={},t.room_overbooked||t.house_overbooked||(i.borrowData.isBorrowFromHouse=!0),t.room_overbooked&&!t.house_overbooked?(i.borrowData.shouldShowOverBookBtn=i.hasOverBookRoomTypePermission,i.borrowData.isRoomTypeOverbooked=!0):!t.room_overbooked&&t.house_overbooked?(i.borrowData.shouldShowOverBookBtn=i.hasOverBookHousePermission,i.borrowData.isHouseOverbooked=!0):t.room_overbooked&&t.house_overbooked&&(i.borrowData.shouldShowOverBookBtn=i.hasOverBookRoomTypePermission&&i.hasOverBookHousePermission,i.borrowData.isHouseAndRoomTypeOverbooked=!0),s.open({template:"/assets/partials/common/group/rvGroupBorrowPopup.html",className:"",closeByDocument:!1,closeByEscape:!0,scope:i})}else i.errorMessage=e,i.closeDialog()},i.closeBorrowPopup=function(e){e&&(i.borrowData={}),s.close()},i.performBorrowFromHouse=function(){i.borrowData.isBorrowFromHouse?(h.setForceOverbookFlagForGroup(!0),i.clickedStayRangeChangeConfirmButton(),i.closeBorrowPopup(!0)):(i.closeBorrowPopup(),s.open({template:"/assets/partials/common/group/rvGroupOverbookPopup.html",className:"",closeByDocument:!1,closeByEscape:!0,scope:i}))},i.closeOverbookPopup=function(){i.borrowData={},s.close()},i.performOverBook=function(){h.setForceOverbookFlagForGroup(!0),i.clickedStayRangeChangeConfirmButton(),i.closeOverbookPopup()},i.resetDates=function(){i.stayDetails.isOverlay=!1,p.dataAssign(),a.isStandAlone&&(p.checkIfStaydatesCanBeExtended()||(i.rightSideReservationUpdates="NO_HOUSE_AVAILABLE",i.refreshMyScroller())),i.events=i.getEventSourceObject(i.checkinDateInCalender,i.checkoutDateInCalender),i.eventSources.length=0,i.eventSources.push(i.events)},i.goBack=function(){e.go("rover.reservation.staycard.reservationcard.reservationdetails",{id:t.reservationId,confirmationId:t.confirmNumber,isrefresh:!0})},i.getColorCode=function(){var e=i.stayDetails.details.reservation_status,t=i.stayDetails.details.room_ready_status,a=i.stayDetails.details.fo_status,r=i.stayDetails.details.checkin_inspected_only;return getMappedRoomStatusColor(e,t,a,r)},this.successCallbackCCAuthConfirmUpdates=function(e){i.$emit("hideLoader"),e.auth_status?(i.isInProgressScreen=!1,i.isSuccessScreen=!0,i.isFailureScreen=!1,i.cc_auth_amount=e.cc_auth_amount,i.cc_auth_code=e.cc_auth_code):(i.isInProgressScreen=!1,i.isSuccessScreen=!1,i.isFailureScreen=!0,i.cc_auth_amount=e.cc_auth_amount),i.goBack(),i.closeDialog()};var b=function(e){var t=d.getCache();if(t){var r=t.currentSelectedReservation,n=864e5,l=0;if(r.isDepartureFlagVisible){var c=tzIndependentDate(r.dept_date).getTime()-tzIndependentDate(e.dep_date).getTime(),u=Math.abs(c/n);l=840/t.no_of_days*u,c>0?r.departurePositionInt=r.departurePositionInt-l:c<0&&(r.departurePositionInt=r.departurePositionInt+l)}if(r.isArrivalFlagVisible){var _=tzIndependentDate(r.arrival_date).getTime()-tzIndependentDate(e.arrival_date).getTime(),f=Math.abs(_/n);l=840/t.no_of_days*f,_>0?r.arrivalPositionInt=r.arrivalPositionInt-l:_<0&&(r.arrivalPositionInt=r.arrivalPositionInt+l)}setTimeout(function(){r.departurePosition=r.departurePositionInt+"px",r.departureStyle.transform="translateX("+r.departurePositionInt+"px)",r.dept_date=e.dep_date,r.deptDate=moment(e.dep_date,"YYYY-MM-DD").format(a.dateFormat.toUpperCase()),r.arrivalPosition=r.arrivalPositionInt+"px",r.arrivalStyle.transform="translateX("+r.arrivalPositionInt+"px)",r.arrival_date=e.arrival_date,r.arrivalDate=moment(e.arrival_date,"YYYY-MM-DD").format(a.dateFormat.toUpperCase()),t.currentSelectedReservation=r,d.updateCache(t)},1e3)}h.getForceOverbookForGroup()&&(e.forcefully_overbook=h.getForceOverbookForGroup(),h.setForceOverbookFlagForGroup(!1)),i.requireAuthorization&&i.isStandAlone?(i.isInProgressScreen=!0,i.isSuccessScreen=!1,i.isFailureScreen=!1,i.isCCAuthPermission=i.hasCCAuthPermission(),s.open({template:"/assets/partials/bill/ccAuthorization.html",className:"",closeByDocument:!1,scope:i}),e.authorize_credit_card=!0,i.invokeApi(o.confirmUpdates,e,p.successCallbackCCAuthConfirmUpdates,p.failureCallbackConfirmUpdates)):(e.authorize_credit_card=!1,i.invokeApi(o.confirmUpdates,e,p.successCallbackConfirmUpdates,p.failureCallbackConfirmUpdates))},C=function(){i.message_incoming_from_room=!1,i.message_out_going_to_room=!1,i.message_out_going_to_comp_tra=!1,i.enableIncedentalOnlyOption=!1,void 0!==i.availabilityDetails.routing_info&&(i.availabilityDetails.routing_info.incoming_from_room?i.message_incoming_from_room=!0:i.availabilityDetails.routing_info.out_going_to_room?i.message_out_going_to_room=!0:i.availabilityDetails.routing_info.out_going_to_comp_tra&&(i.message_out_going_to_comp_tra=!0)),i.availabilityDetails.is_cc_authorize_for_incidentals_active&&(i.message_out_going_to_room||i.message_out_going_to_comp_tra)&&(i.enableIncedentalOnlyOption=!0)},R=function(e){i.clickedIncidentalsOnly=function(){e.is_cc_authorize_for_incidentals=!0,i.requireAuthorization=!0,b(e),s.close()},i.clickedFullAuth=function(){i.requireAuthorization=!0,b(e),s.close()},i.clickedManualAuth=function(){i.requireAuthorization=!1,b(e),s.close()},C(),s.open({template:"/assets/partials/bill/ccAuthAndBillingInfoConfirm.html",className:"",closeByDocument:!1,scope:i})};i.clickedStayRangeChangeConfirmButton=function(){C(),i.message_incoming_from_room||i.message_out_going_to_room||i.message_out_going_to_comp_tra?i.showBillingInformationPrompt():i.confirmUpdates()},i.updateBillingInformation=function(){var e={from_date:getDateString(i.checkinDateInCalender),to_date:getDateString(i.checkoutDateInCalender),reservation_id:i.stayDetails.calendarDetails.reservation_id};i.callAPI(o.updateBillingInformation,{params:e,successCallBack:i.closeBillingInfoPopup})},i.closeBillingInfoPopup=function(){s.close(),i.confirmUpdates()},i.confirmUpdates=function(){var e={room_selected:i.roomSelected,arrival_date:getDateString(i.checkinDateInCalender),dep_date:getDateString(i.checkoutDateInCalender),reservation_id:i.stayDetails.calendarDetails.reservation_id};(i.message_incoming_from_room||i.message_out_going_to_room||i.message_out_going_to_comp_tra)&&i.requireAuthorization?R(e):b(e)},i.changedDateOnCalendar=function(e,t,r,n,s,l,c,u){i.stayDetails.isOverlay=!1;var d=e.start,h=tzIndependentDate(i.stayDetails.validDays[0].date),_=tzIndependentDate(i.stayDetails.validDays[i.stayDetails.validDays.length-1].date),v=tzIndependentDate(i.stayDetails.calendarDetails.current_business_date),m="",g="",y=e.source.events.find(function(t){return e.start.getDate().toString()===t.day}),D=angular.copy(y);if((d<h||d>_)&&(!D||!D.onlyCheckOut))return s(),!1;if("check-in"===e.id&&"CHECKEDIN"===i.stayDetails.details.reservation_status)return s(),!1;if("check-in"!==e.id&&"check-out"!==e.id)return s(),!1;if("check-in"===e.id){if(d>i.checkoutDateInCalender)return s(),!1;m=d.clone(),g=i.checkoutDateInCalender.clone()}else if("check-out"===e.id){if(d<i.checkinDateInCalender)return s(),!1;if(d.getTime()<v.getTime())return s(),!1;m=i.checkinDateInCalender.clone(),g=d.clone()}if(i.checkinDateInCalender=m,i.checkoutDateInCalender=g,i.events=i.getEventSourceObject(i.checkinDateInCalender,i.checkoutDateInCalender,D.onlyCheckOut),i.eventSources.length=0,i.eventSources.push(i.events),a.isStandAlone){if(f<moment(i.checkoutDateInCalender).diff(moment(i.checkinDateInCalender),"days"))return i.rightSideReservationUpdates="MAX_LENGTH_EXCEEDED",i.refreshMyScroller(),!1}else if(p.isStayRangeRestricted(i.checkinDateInCalender,i.checkoutDateInCalender))return p.showRestrictedStayRange(),!1;var S={arrival_date:getDateString(i.checkinDateInCalender),dep_date:getDateString(i.checkoutDateInCalender),reservation_id:i.stayDetails.calendarDetails.reservation_id};i.invokeApi(o.checkUpdateAvaibale,S,i.successCallbackCheckUpdateAvaibale,i.errorCallbackCheckUpdateAvaibale)},this.isStayRangeRestricted=function(e,t){var a=e.clone().setHours(0,0,0),r=t.clone().setHours(0,0,0),o="",n=0,s="";return $(i.stayDetails.calendarDetails.available_dates).each(function(t){return o=tzIndependentDate(this.date).setHours(0,0,0),this.date===getDateString(e)&&$(this.restriction_list).each(function(e){"MINIMUM_LENGTH_OF_STAY"===this.restriction_type&&(s=this.number_of_days)}),o<a||o>=r||void n++}),n<s};var k=function(e,t){return e===t};i.getEventSourceObject=function(e,t,r){var o,s,c=[],u={},d=i.stayDetails.calendarDetails.reservation_status,h=l.getPermissionValue("OVERBOOK_HOUSE"),f=l.getPermissionValue("OVERBOOK_ROOM_TYPE"),v=l.getPermissionValue("BOOK_RESTRICTED_ROOM_RATE"),m=!0,p=!0;return i.stayDetails.validDays=[],_.each(i.stayDetails.calendarDetails.available_dates,function(e){_.each(i.stayDetails.calendarDetails.stay_dates,function(t){e.date===t.date&&(e.rate=t.rate)})}),$(i.stayDetails.calendarDetails.available_dates).each(function(l){var _=!this.is_house_available&&!h&&a.isStandAlone,g=!this.is_room_type_available&&!f,y=this.is_restricted&&!v,D=i.reservation.reservation_card.is_suite&&!i.reservation.reservation_card.group_id&&!this.is_room_type_available,S=i.reservation.reservation_card.is_suite&&!!i.reservation.reservation_card.group_id&&!this.is_room_type_available&&!this.is_house_available&&!k(this.date,i.reservation.reservation_card.group_block_to);u={},o=tzIndependentDate(this.date),"true"===this.is_sr?u.title=n("translate")("SUPPRESSED_RATES_TEXT"):null!==this.rate_currency?u.title=this.rate_currency+Math.round(this.rate):u.title=a.currencySymbol+Math.round(this.rate),u.start=o,u.end=o,u.day=o.getDate().toString(),o.getTime()===e.getTime()?(u.id="check-in",u.className="check-in","CHECKEDIN"!==d&&"CHECKING_OUT"!==d&&(u.startEditable="true"),u.durationEditable="false",e.getTime()===t.getTime()&&(u.className="check-in split-view",c.push(u),u={},"true"===this.is_sr?u.title=n("translate")("SUPPRESSED_RATES_TEXT"):null!==this.rate_currency?u.title=this.rate_currency+Math.round(this.rate):u.title=a.currencySymbol+Math.round(this.rate),u.start=o,u.end=o,u.day=o.getDate().toString(),u.id="check-out",u.className="check-out split-view",u.startEditable="true",u.durationEditable="false")):o.getTime()>e.getTime()&&o.getTime()<t.getTime()?(u.id="mid-stay"+l,u.className="mid-stay"):o.getTime()===t.getTime()?(u.id="check-out",u.className="check-out",u.startEditable="true",u.durationEditable="false",p=!(S||D||_||y||g)):(u.id="availability"+l,u.className="type-available"),(S||D||_||y||g)&&(m=!1),m||o.getTime()>=e.getTime()&&o.getTime()<=t.getTime()?(c.push(u),i.stayDetails.validDays.push(this)):!r&&!s&&o.getTime()>t.getTime()&&(s=u)}),s&&p&&(s.onlyCheckOut=!0,c.push(s)),c},i.refreshMyScroller=function(){setTimeout(function(){i.refreshScroller("edit_staydate_updatedDetails"),i.refreshScroller("edit_staydate_calendar")},300)};var O=function(){e.go(m,{from_date:i.confirmedCheckinDate,to_date:i.confirmedCheckoutDate,fromState:"STAY_CARD",company_id:i.reservationData.company.id,travel_agent_id:i.reservationData.travelAgent.id,group_id:"",borrow_for_groups:i.reservationData.group.id?"true":"false",room_type_id:i.reservationData.tabs[i.viewState.currentTab].roomTypeId,adults:i.reservationData.tabs[i.viewState.currentTab].numAdults,children:i.reservationData.tabs[i.viewState.currentTab].numChildren})};i.goToRoomAndRates=function(){O()},i.alertOverbooking=function(e){var t=0;e&&(i.closeDialog(),t=1e3),u(O,t)},i.$on("$viewContentLoaded",function(){i.refreshMyScroller()}),i.showOverBookingAlertForStayExtension=function(){s.open({template:"/assets/partials/reservation/alerts/overBookingAlertStayExtension.html",className:"",closeByDocument:!1,scope:i})},i.showBillingInformationPrompt=function(){s.open({template:"/assets/partials/reservation/alerts/rvShowBillingInformationPopup.html",className:"",closeByDocument:!1,scope:i})},i.proceedToOverBooking=function(){i.showRoomAvailable(),i.closeDialog()},this.initialise()}]),angular.module("sntRover").service("RVChangeStayDatesSrv",["$q","rvBaseWebSrvV2","RVBaseWebSrv",function(e,t,a){var i=this;this.changeStayDetails={},this.fetchStayBasicDetails=function(e,t){var r="/staff/change_stay_dates/"+e+".json";a.getJSON(r).then(function(a){i.changeStayDetails.details=a,i.fetchCalenderDetails(e,t)},function(e){t.reject(e)})},this.fetchCalenderDetails=function(e,t){var r="/staff/change_stay_dates/"+e+"/calendar.json";a.getJSON(r).then(function(e){i.changeStayDetails.calendarDetails=e,t.resolve(i.changeStayDetails)},function(e){t.reject(e)})},this.fetchInitialData=function(t){var a=e.defer();return i.fetchStayBasicDetails(t,a),a.promise},this.checkUpdateAvaibale=function(t){var i="/staff/change_stay_dates/"+t.reservation_id+"/update.json",t={arrival_date:t.arrival_date,dep_date:t.dep_date},r=e.defer();return a.getJSON(i,t).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.confirmUpdates=function(t){var i="/staff/change_stay_dates/"+t.reservation_id+"/confirm",r={arrival_date:t.arrival_date,dep_date:t.dep_date,room_number:t.room_selected,authorize_credit_card:t.authorize_credit_card,is_cc_authorize_for_incidentals:t.is_cc_authorize_for_incidentals};t.forcefully_overbook&&(r.forcefully_overbook=t.forcefully_overbook);var o=e.defer();return a.postJSON(i,r).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.updateBillingInformation=function(a){var i=e.defer(),r="api/bill_routings/update_dates";return t.postJSON(r,a).then(function(e){i.resolve(e)},function(e){i.reject(e)}),i.promise}}]),angular.module("sntRover").service("RVNightlyDiaryRightFilterBarSrv",["$q","sntBaseWebSrv",function(e,t){var a=this;a.fetchRoomType=function(a){var i=e.defer(),r="/api/room_types.json?exclude_pseudo=true&exclude_suite=true";return t.getJSON(r,a).then(function(e){i.resolve(e)},function(e){i.reject(e)}),i.promise},a.fetchFloorList=function(a){var i=e.defer(),r="/api/floors.json";return t.getJSON(r,a).then(function(e){i.resolve(e)},function(e){i.reject(e)}),i.promise},a.getPreferences=function(){var a=e.defer(),i="/staff/preferences/room_assignment.json";return t.getJSON(i).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},a.fetchFilterList=function(t){var i=e.defer(),r=[],o={};return r.push(a.fetchFloorList(t).then(function(e){o.floors=e.floors})),r.push(a.fetchRoomType(t).then(function(e){o.rooms=e.results})),r.push(a.getPreferences().then(function(e){o.roomFeatures=e.data.room_features})),e.all(r).then(function(){i.resolve(o)}),i.promise}}]),angular.module("sntRover").service("RVNightlyDiaryRoomNumberSearchSrv",["$q","BaseWebSrvV2",function(e,t){this.fetchRoomSearchResults=function(a){var i=e.defer(),r="/api/nightly_diary/search_room";return t.getJSON(r,a).then(function(e){i.resolve(e)},function(e){i.reject(e)}),i.promise}}]),angular.module("sntRover").service("RVNightlyDiarySearchSrv",["$q","BaseWebSrvV2",function(e,t){var a=this;a.searchPerPage=50,a.page=1,a.fetchSearchResults=function(i){var r=e.defer(),o="search.json?per_page="+a.searchPerPage+"&page="+a.page+"&is_from_nightly_diary=true";return i.fakeDataToAvoidCache=new Date,t.getJSON(o,i).then(function(e){r.resolve(e.data)},function(e){r.reject(e)}),r.promise}}]),angular.module("sntRover").service("RVNightlyDiarySrv",["$q","sntBaseWebSrv","$rootScope",function(e,t,a){var i=this;this.updateCache=function(e){i.searchParamsCached=e},this.getCache=function(){return i.searchParamsCached},this.fetchRoomsList=function(a){var i=e.defer(),r="/api/nightly_diary/room_list";return t.postJSON(r,a).then(function(e){i.resolve(e)},function(e){i.reject(e)}),i.promise},this.fetchDatesList=function(a){var i=e.defer(),r=[],o="/api/nightly_diary/date_list",n={},s={};return n.start_date=a.start_date,n.no_of_days=a.no_of_days,t.getJSON(o,n).then(function(e){angular.forEach(e.dates,function(e){var t=tzIndependentDate(e),a=0===t.getDay()||6===t.getDay(),i={date:e,isWeekend:a};r.push(i)}),s={dates:r,hotelCheckinTime:e.hotel_checkin_time,hotelCheckoutTime:e.hotel_checkout_time},i.resolve(s)},function(e){i.reject(e)}),i.promise},this.fetchReservationsList=function(a){i.updateCache(a);var r=e.defer(),o="/api/nightly_diary/reservation_list",n={};return n.start_date=a.start_date,n.no_of_days=a.no_of_days,n.page=a.page,n.per_page=a.per_page,n.selected_room_type_ids=a.selected_room_type_ids,n.selected_floor_ids=a.selected_floor_ids,n.selected_room_feature_ids=a.selected_room_feature_ids,t.postJSON(o,n).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.checkUpdateAvaibale=function(a){var i="/staff/change_stay_dates/"+a.reservation_id+"/update.json",r={arrival_date:a.arrival_date,dep_date:a.dep_date},o=e.defer();return t.getJSON(i,r).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.validateStayChanges=function(a){var i="/api/nightly_diary/validate_stay_change",r=e.defer();return t.getJSON(i,a).then(function(e){r.resolve(e.result)},function(e){r.reject(e)}),r.promise},this.confirmUpdates=function(a){var i="/staff/change_stay_dates/"+a.reservation_id+"/confirm",r={arrival_date:a.arrival_date,dep_date:a.dep_date,room_number:a.room_number,authorize_credit_card:a.authorize_credit_card,is_from_diary:!0},o=e.defer();return t.postJSON(i,r).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},this.fetchRoomsListAndReservationList=function(t){var a=e.defer(),r={roomList:null,reservationList:null,dateList:null};return e.when().then(function(){return i.fetchRoomsList(t).then(function(e){r.roomList=e})}).then(function(){return t.page=r.roomList.page_number,i.fetchReservationsList(t).then(function(e){r.reservationList=e})}).then(function(){return i.fetchDatesList(t).then(function(e){r.dateList=e})}).then(function(){a.resolve(r)},function(e){a.reject(e)}),a.promise},this.fetchUnassignedReservationList=function(i){var r=e.defer(),o="/api/nightly_diary/unassigned_reservations",n=a.businessDate;return t.getJSON(o,i).then(function(e){angular.forEach(e.reservations,function(e){e.statusClass=e.arrival_date===n?"check-in":"no-status",e.fullName=e.last_name+" "+e.first_name}),r.resolve(e)},function(e){r.reject(e)}),r.promise},this.retrieveAvailableRooms=function(a){var i=e.defer(),r="/api/nightly_diary/retrieve_available_rooms";return t.postJSON(r,a).then(function(e){i.resolve(e.data)},function(e){i.reject(e)}),i.promise},this.retrieveAvailableFreeSlots=function(a){var i=e.defer(),r="/api/nightly_diary/availability";return t.postJSON(r,a).then(function(e){i.resolve(e)},function(e){i.reject(e)}),i.promise},this.assignRoom=function(a){var i=e.defer(),r="/staff/reservation/modify_reservation";return t.postJSON(r,a).then(function(e){i.resolve(e.data)},function(e){i.reject(e)}),i.promise},this.fetchAvailableTimeSlots=function(a){var i=e.defer(),r="/api/nightly_diary/available_time_slots";return t.postJSON(r,a).then(function(e){i.resolve(e)},function(e){i.reject(e)}),i.promise},this.unAssignRoom=function(a){var i=e.defer(),r="/api/reservations/"+a.id+"/unassign_room";return t.postJSON(r,a).then(function(e){i.resolve(e)},function(e){i.reject(e)}),i.promise},this.getPreferences=function(a){var i=e.defer(),r="/staff/preferences/room_assignment.json";return t.getJSON(r,a).then(function(e){i.resolve(e)},function(e){i.reject(e)}),i.promise},this.updateBillingInformation=function(a){var i=e.defer(),r="api/bill_routings/update_dates";return t.postJSON(r,a).then(function(e){i.resolve(e)},function(e){i.reject(e)}),i.promise},this.initiateAutoAssignRooms=function(e){var a="api/auto_room_assign_processes/auto_room_assignment";return t.postJSON(a,e)},this.fetchAutoAssignStatus=function(){var e="api/auto_room_assign_processes/status";return t.getJSON(e)},this.unlockRoomDiary=function(){var e="api/auto_room_assign_processes/unlock_diary";return t.postJSON(e)}}]);