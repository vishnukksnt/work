window.StatisticsBaseCtrl=function(e,t){e.getStatusIconClass=function(e){var t="neutral";return e<0?t="icons time check-out rotate-right":e>0&&(t="icons time check-in rotate-right"),t},e.getStatusClass=function(e){var t="";return e>0?t="green":e<0&&(t="red"),t},e.absVal=function(e){return e?Math.abs(e):""},e.getCurrentYear=function(){var e=tzIndependentDate(t.businessDate),r=e.getFullYear();return r},e.populateYearDropDown=function(t){var r,a="";e.yearOptions=[],"summary"===e.activeView?(t=t===e.getCurrentYear()?t-1:t,r=e.getCurrentYear()-1):r=e.getCurrentYear();for(var s=r;s>=t;s--)a=s===r?"summary"===e.activeView?"LAST YEAR ("+s+")":"YEAR TO DATE ("+s+")":s,e.yearOptions.push({name:a,value:s})},e.getReservationClass=function(e){var t={RESERVED:"arrival",CHECKING_IN:"check-in",CHECKEDIN:"inhouse",CHECKING_OUT:"check-out",CHECKEDOUT:"departed",CANCELED:"cancel",NOSHOW:"no-show",NOSHOW_CURRENT:"no-show"};return t[e.reservation_status.toUpperCase()]||""}},sntRover.controller("RVGuestCardActivityLogController",["$scope","$rootScope","$stateParams","$timeout","RVGuestCardActivityLogSrv",function(e,t,r,a,s){BaseCtrl.call(this,e);var i=this,n=1e3,o=function(){a(function(){e.refreshScroller("rvGuestCardActivityLogScroll")},500)},c=function(){e.activityLogObj={response:{},perPage:50,page:1,sortField:"DATE",sortOrder:"asc",accountId:""},e.activityLogFilter={user:"",date:"asc",action:""},e.activityLogPagination={id:"GUEST_ACTIVITY_LOG",api:i.loadAPIData,perPage:e.activityLogObj.perPage},e.setScroller("rvGuestCardActivityLogScroll",{}),o()};e.showPagination=function(){var t=!1,r=e.activityLogObj.response;return"undefined"!=typeof r&&"undefined"!=typeof r.results&&r.results.length<r.total_count&&r.results.length>0&&(t=!0),t},i.loadAPIData=function(t){if(e.guestCardData&&e.guestCardData.guestId||r.guestId){e.activityLogObj.page=t?t:1,e.activityLogObj.accountId="undefined"==typeof e.guestCardData?r.guestId:e.guestCardData.guestId;var i={params:{page:e.activityLogObj.page,per_page:e.activityLogObj.perPage,sort_field:e.activityLogObj.sortField,sort_order:e.activityLogObj.sortOrder,id:e.activityLogObj.accountId},successCallBack:function(t){e.activityLogObj.response=t,e.errorMessage="",o(),a(function(){e.$broadcast("updatePagination","GUEST_ACTIVITY_LOG")},n)},failureCallBack:function(t){e.errorMessage=t}};e.callAPI(s.fetchActivityLog,i)}};var u=function(t){e.activityLogObj.sortField=t;var r=e.activityLogFilter;switch(t){case"USERNAME":""===r.user||"asc"===r.user?r.user="desc":r.user="asc",e.activityLogObj.sortOrder=r.user;break;case"DATE":""===r.date||"asc"===r.date?r.date="desc":r.date="asc",e.activityLogObj.sortOrder=r.date;break;case"ACTION":""===r.action||"asc"===r.action?r.action="desc":r.action="asc",e.activityLogObj.sortOrder=r.action}i.loadAPIData()};e.sortByAction=function(e){u(e)};var d=e.$on("GUEST_ACTIVITY_LOADED",function(){a(function(){i.loadAPIData()},n)});e.isOldValue=function(e){var t=!0;return""!==e&&"undefined"!=typeof e&&null!==e||(t=!1),t},c(),e.$on("$destroy",d)}]),angular.module("sntRover").controller("rvGuestDetailsController",["$scope","contactInfo","countries","$stateParams","$state","$filter","$rootScope","RVGuestCardSrv","RVContactInfoSrv","RVSearchSrv","rvPermissionSrv","RVGuestCardsSrv","$timeout","$window",function(e,t,r,a,s,i,n,o,c,u,d,l,g,f){BaseCtrl.call(this,e),GuestCardBaseCtrl.call(this,e,u,c,d,n);var v=e.$on("detect-hlps-ffp-active-status",function(t,r){r.userMemberships.use_hlp||r.userMemberships.use_ffp?e.loyaltyTabEnabled=!0:e.loyaltyTabEnabled=!1});e.isFromMenuGuest=a.isFromMenuGuest,e.$on("$destroy",v);var S=e.$on("loyaltyLevelAvailable",function(t,r){e.guestCardData.selectedLoyaltyLevel=r});e.$on("$destroy",S);var m=function(){var t=["birthday","country","is_opted_promotion_email","job_title","passport_expiry","passport_number","postal_code","reservation_id","title","user_id","works_at","birthday"],r=dclone(e.guestCardData.contactInfo,t);return r},y=function(e,t){var r={};return r.contactInfo=e,r.contactInfo.vip=t?e.vip:"",r.userId=t,r.guestId=t,r.contactInfo.birthday=t?e.birthday:null,r.contactInfo.user_id=t?t:"",r.contactInfo.guest_id=t?t:"",r.contactInfo.genderTypeList=e.gender_list,r.contactInfo.guest_admin_settings=e.guest_admin_settings,r};e.guestCardTabSwitch=function(t){"guest-contact"===e.current&&"guest-contact"!==t&&(e.viewState.isAddNewCard?e.$broadcast("showSaveMessage"):e.$broadcast("saveContactInfo")),"guest-like"===e.current&&"guest-like"!==t&&e.$broadcast("SAVELIKES",{isFromGuestCardSection:!0}),"guest-wallet"===t?e.$broadcast("PAYMENTSCROLL"):"guest-like"===t?(e.$broadcast("GUESTLIKETABACTIVE"),e.$broadcast("REFRESHLIKESSCROLL")):"guest-contact"===t?e.$broadcast("CONTACTINFOLOADED"):"activity-log"===t?e.$broadcast("GUEST_ACTIVITY_LOADED"):"guest-statistics"===t&&e.$broadcast("LOAD_GUEST_STATISTICS"),e.viewState.isAddNewCard||(e.current=t)},e.$on("contactInfoError",function(t,r){r&&(e.current="guest-contact")});var p=function(){var t=i("translate")("FIND GUESTS");a.isMergeViewSelected&&(t=i("translate")("MERGE_CARDS")),a.fromStaycard&&(t=i("translate")("STAY_CARD")),n.setPrevState={title:t,callback:"navigateBack",scope:e}},C=function(){var t=i("translate")("GUEST_CARD");e.viewState.isAddNewCard&&(t=i("translate")("NEW_GUEST")),e.heading=t,e.setTitle(t)};e.navigateBack=function(){a.fromStaycard?s.go("rover.reservation.staycard.reservationcard.reservationdetails",{id:a.reservationId,confirmationId:a.confirmationNo}):g(function(){s.go("rover.guest.search",{textInQueryBox:a.query,selectedIds:a.selectedIds,isMergeViewSelected:a.isMergeViewSelected})},100)};var h=function(t){var r=t.user_id,a=t.guest_id,s=function(t){e.$emit("hideLoader");var s={data:t,user_id:r,guest_id:a};e.paymentData=s},i={params:r,successCallBack:s};e.callAPI(o.fetchGuestPaymentData,i)},_=function(t){t.id&&(e.guestCardData.userId=t.id,e.guestCardData.guestId=t.id,l.setGuest(t.id))};e.newGuestAdded=function(t){e.viewState.isAddNewCard=!1,_({id:t})},e.clickedSaveGuestCard=function(){e.$broadcast("saveContactInfo")},e.clickedDiscardGuestCard=function(){e.viewState.isAddNewCard=!1,e.navigateBack()},e.updateContactInfo=function(){var t=this;t.newUpdatedData=m();var r=function(){e.updateSearchCache(),e.isGuestCardSaveInProgress=!1,e.$broadcast("RESETCONTACTINFO",t.newUpdatedData)};if(JSON.stringify(e.getContactInfo(e.currentGuestCardHeaderData))!==JSON.stringify(e.getContactInfo(t.newUpdatedData))){e.currentGuestCardHeaderData=t.newUpdatedData;var a={data:e.currentGuestCardHeaderData,userId:e.guestCardData.contactInfo.user_id};if("undefined"!=typeof a.userId&&""!==a.userId){var s={successCallBack:r,params:a};e.isGuestCardSaveInProgress=!0,e.callAPI(c.updateGuest,s)}}};var I=e.$on("RESETHEADERDATA",function(t,r){e.currentGuestCardHeaderData.address=r.address,e.currentGuestCardHeaderData.phone=r.phone,e.currentGuestCardHeaderData.email=r.email,e.currentGuestCardHeaderData.first_name=r.first_name,e.currentGuestCardHeaderData.last_name=r.last_name});e.$on("$destroy",I);var E=function(){e.callAPI(l.fetchGuestAdminSettingsAndGender,{successCallBack:function(t){e.guestCardData.contactInfo.guest_admin_settings=t.guest_admin_settings,e.idTypeList=t.idTypeList,e.guestCardData.contactInfo.genderTypeList=t.genderTypeList},failureCallBack:function(t){e.errorMessage=t,e.$emit("hideLoader")}})},w=function(){e.viewState={isAddNewCard:!a.guestId},e.isGuestCardFromMenu=!0,e.shouldShowStatisticsTab=!!a.guestId,e.guestImage=a.guestId?t.image_url:"",a.guestId?e.guestCardData=y(t,a.guestId):(e.guestCardData={},e.guestCardData.contactInfo={},e.guestCardData.contactInfo.user_id="",e.guestCardData.contactInfo.first_name=a.firstName,e.guestCardData.contactInfo.last_name=a.lastName,E()),e.idTypeList=t.id_type_list,e.countries=r;var s={user_id:e.guestCardData.contactInfo.user_id,guest_id:null};e.declonedData=m(),e.currentGuestCardHeaderData=e.declonedData,s.user_id&&h(s),e.guestCardData.selectedLoyaltyLevel="",e.loyaltyTabEnabled=!1,e.loyaltiesStatus={ffp:!1,hlps:!1},a.isBackToStatistics?e.current="guest-statistics":e.current="guest-contact",e.paymentData={},C(),p(),e.printState={clicked:!1},e.$on("$destroy",e.guestCardTabSwitch)},T=e.$on("SET_GUEST_CARD_DATA",function(t,r){e.guestCardData.contactInfo=e.getUpdatedContactInfo(r.contactInfo,r.guestId)});e.$on("$destroy",T);var G=e.$on("UPDATE_GUEST_CARD_ACTIONS_BUTTON_STATUS",function(t,r){e.manageCardState.isOpen=r.status});e.$on("$destroy",G),e.createReservationFromGuestCard=function(){s.go("rover.reservation.search",{guestId:e.guestCardData.contactInfo.user_id})};var D=function(){$("head").append("<style id='print-orientation'>@page { size: portrait; }</style>")},O=function(){$("#print-orientation").remove()};e.printGuestCard=function(){e.printState.clicked=!0,e.manageCardState.isOpen=!1,$("header .logo").addClass("logo-hide"),$("header .h2").addClass("text-hide"),D();var t=function(){g(function(){e.printState.clicked=!1,$("header .logo").removeClass("logo-hide"),$("header .h2").addClass("text-hide"),O()},200)};g(function(){sntapp.cordovaLoaded?cordova.exec(t,function(){t()},"RVCardPlugin","printWebView",[]):(f.print(),t())},200)},e.uploadGuestImage=function(){g(function(){angular.element("#uploadImage").trigger("click")},0,!1)},e.onImageUpload=function(){e.guestImage=e.guestCardData.contactInfo.guestImageBase64},w()}]),angular.module("sntRover").controller("guestCardSearchController",["$scope","RVGuestCardsSrv","$stateParams","ngDialog","$timeout","$state","$filter","rvPermissionSrv",function(e,t,r,a,s,i,n,o){BaseCtrl.call(this,e);var c=null,u="guest_card_scroll",d=600,l="guest_card_search",g=3,f=function(){e.myScroll&&e.myScroll.hasOwnProperty(u)&&e.myScroll[u].scrollTo(0,0,100),s(function(){e.refreshScroller(u)},300)},v=function(t){e.searchWords=[],t.indexOf(",")!==-1?e.searchWords=t.split(","):t.indexOf(" ")!==-1?e.searchWords=t.split(" "):e.searchWords.push(t)};e.queryEntered=_.debounce(function(){""===e.textInQueryBox?(e.results=[],e.$apply()):e.textInQueryBox.length<g||p();var t=e.textInQueryBox;e.textInQueryBox=t.charAt(0).toUpperCase()+t.slice(1),v(e.textInQueryBox)},d),e.clearResults=function(){e.textInQueryBox="",e.results=[]};var S=function(t){t.params&&t.params.query.toUpperCase()===e.textInQueryBox.trim().toUpperCase()&&(e.results=t.data.results,e.totalResultCount=t.data.total_count,h(),setTimeout(function(){e.$broadcast("updatePagination",l),f()},500))},m=function(){e.results=[]},y=function(r){var a={query:e.textInQueryBox.trim(),per_page:t.PER_PAGE_COUNT,page:r||1};return a};e.search=function(r){var a={params:y(r),successCallBack:S,failureCallBack:m};e.callAPI(t.fetchGuestList,a)};var p=function(){e.textInQueryBox.length?e.search():(e.results=[],f())};e.addNewCard=function(){i.go("rover.guest.details",{isFromMenuGuest:!0})},e.getGuestName=function(e,t){return t+", "+e};var C=function(){var t=n("translate")("FIND_GUESTS");e.heading=t,e.setTitle(t)};e.onViewChange=function(){e.viewState.isViewSelected||e.$broadcast("RESET_SELECTIONS_FOR_MERGE"),e.viewState.canMerge=null,e.queryEntered()},e.onCardSelection=function(t){if(0===e.viewState.selectedCardsForMerge.length&&t.selected&&(t.isPrimary=!0,e.viewState.selectedPrimaryCard=t),t.selected)e.viewState.selectedCardsForMerge.push(t);else{var r=t.isPrimary;e.viewState.selectedCardsForMerge=_.reject(e.viewState.selectedCardsForMerge,function(a){return a.id===t.id&&(t.isPrimary=!1,r&&(e.viewState.selectedPrimaryCard={})),a.id===t.id}),r&&e.viewState.selectedCardsForMerge.length>0&&(e.viewState.selectedCardsForMerge[0].isPrimary=!0,e.viewState.selectedPrimaryCard=e.viewState.selectedCardsForMerge[0])}e.$broadcast("REFRESH_SELECTED_CARDS_FOR_MERGE_SCROLLER")};var h=function(){e.viewState.selectedCardsForMerge.length>0&&e.results.forEach(function(t){var r=_.find(e.viewState.selectedCardsForMerge,{id:t.id});r&&(t.selected=!0,t.isPrimary=r.isPrimary,t.isPrimary&&(e.viewState.selectedPrimaryCard=t))})},I=function(){C(),e.textInQueryBox="",e.$emit("updateRoverLeftMenu","guests"),e.results=[],e.totalResultCount=0,e.isGuestCard=!0,e.viewState={isViewSelected:!0,selectedCardsForMerge:[],selectedPrimaryCard:{},mergeStatusText:"",hasInitiatedMergeVerification:!1,mergeStatusErrors:{}};var t={tap:!0,preventDefault:!1,deceleration:1e-4,shrinkScrollbars:"clip"};e.setScroller(u,t),e.guestCardPagination={id:l,perPage:50,api:e.search},c=i.transition&&i.transition.params("from"),c&&c.isMergeViewSelected?(e.viewState.isViewSelected=!c.isMergeViewSelected,e.textInQueryBox=c.query,e.viewState.selectedCardsForMerge=c.selectedIds,e.queryEntered()):r.textInQueryBox&&(e.textInQueryBox=r.textInQueryBox,e.queryEntered()),e.hasMergeViewPermission=o.getPermissionValue("MERGE")};e.shouldHideSearchResults=function(){return 0===e.results.length||""===e.textInQueryBox},e.shouldHidePagination=function(){return e.totalResultCount<e.guestCardPagination.perPage&&e.results.length>0},e.navigateToDetails=function(t){return!e.viewState.hasInitiatedMergeVerification&&void i.go("rover.guest.details",{guestId:t,query:e.textInQueryBox,selectedIds:e.viewState.selectedCardsForMerge||[],isMergeViewSelected:!e.viewState.isViewSelected,isFromMenuGuest:!0})},I()}]),angular.module("sntRover").controller("RVGuestCardStatisticsController",["$scope","$rootScope","RVGuestCardsSrv","$timeout","$vault","$state","$stateParams",function(e,t,r,a,s,i,n){var o={},c="guest-sidebar-scroller",u="guest-monthly-data-scroller",d="guest-statistics-summary-sidebar-scroller",l="guest-statistics-summary-data-scroller";BaseCtrl.call(this,e),StatisticsBaseCtrl.call(this,e,t);var g=function(){var t=function(t){e.statistics.summary=t,e.activeView="summary",a(function(){C(!0)},200),w()},s=function(){e.statistics.summary={}},i={params:{year:e.filterData.selectedYear,guestId:e.guestID},onSuccess:t,onFailure:s};e.callAPI(r.fetchGuestCardStatisticsSummary,i)},f=function(){var t=function(t){e.statistics.details=t,e.statistics.details.monthly_data=e.statistics.details.monthly_data.reverse(),a(function(){C(!0)},500),E()},s=function(){e.statistics.details=[]},i={params:{year:e.filterData.selectedYear,guestId:e.guestID},onSuccess:t,onFailure:s};e.callAPI(r.fetchGuestCardStatisticsDetails,i)},v=function(){o.LOAD_GUEST_STATISTICS=e.$on("LOAD_GUEST_STATISTICS",function(){g()}),o.UPDATE_CONTACT_INFO=e.$on("UPDATE_CONTACT_INFO",function(){y()})},S=function(){angular.forEach(function(t){e.$on("$destroy",t)})};e.setActiveView=function(t,r){e.activeView=t,"details"===t?(e.filterData.selectedYear=r||e.getCurrentYear(),p(),E(),m(),f()):(e.filterData.selectedYear=e.getCurrentYear()-1,p(),w(),m(),g())},e.showMonthlyReservations=function(e){return!_.isEmpty(e.reservations.reservations)&&(e.isOpen=!e.isOpen,void a(function(){C()},200))},e.onChangeYear=function(){"summary"===e.activeView?g():f()},e.navigateToStayCard=function(t){return"rover.guest.details"===i.current.name&&(s.set("guestId",e.guestCardData.userId),s.set("selectedYear",e.filterData.selectedYear),void i.go("rover.reservation.staycard.reservationcard.reservationdetails",{id:t.reservation_id,confirmationId:t.confirmation_no,isrefresh:!0,isFromGuestStatistics:!0}))},e.shouldShowNavigation=function(){var e=!0;return"rover.guest.details"===i.current.name&&(e=!1),e},e.getStyleForExpandedView=function(t){var r={},a=t.reservations_count||t.reservations.reservations&&t.reservations.reservations.length;if(t.isOpen){var s=70*a+30;e.totalResultCount>e.perPage&&(s+=60),r["margin-bottom"]=s+"px"}return r};var m=function(){e.populateYearDropDown(e.guestCardData.contactInfo.first_stay_year)},y=function(){e.statistics={summary:{},details:[]},e.guestID=e.guestCardData.userId,e.filterData={selectedYear:e.getCurrentYear()-1},e.currentYear=e.getCurrentYear(),m()},p=function(){e.setScroller(c,{preventDefault:!1,probeType:3}),e.setScroller(u,{preventDefault:!1,probeType:3,scrollX:!0}),e.setScroller(d,{preventDefault:!1,probeType:3}),e.setScroller(l,{preventDefault:!1,probeType:3,scrollX:!0})},C=function(t){a(function(){e.myScroll.hasOwnProperty(c)&&(e.refreshScroller(c),t&&e.myScroll[c].scrollTo(0,0,100)),e.myScroll.hasOwnProperty(u)&&(e.refreshScroller(u),t&&e.myScroll[u].scrollTo(0,0,100)),e.myScroll.hasOwnProperty(d)&&(e.refreshScroller(d),t&&e.myScroll[d].scrollTo(0,0,100)),e.myScroll.hasOwnProperty(l)&&(e.refreshScroller(l),t&&e.myScroll[l].scrollTo(0,0,100))},200)},h=function(){e.myScroll.hasOwnProperty(c)&&e.myScroll.hasOwnProperty(u)&&(e.myScroll[c].on("scroll",function(){e.myScroll[u].scrollTo(0,this.y)}),e.myScroll[u].on("scroll",function(){e.myScroll[c].scrollTo(0,this.y)}))},I=function(){e.myScroll.hasOwnProperty(d)&&e.myScroll.hasOwnProperty(l)&&(e.myScroll[d].on("scroll",function(){e.myScroll[l].scrollTo(0,this.y)}),e.myScroll[l].on("scroll",function(){e.myScroll[d].scrollTo(0,this.y)}))},E=function(){e.myScroll.hasOwnProperty(c)&&e.myScroll.hasOwnProperty(u)?h():a(E,1e3)},w=function(){e.myScroll.hasOwnProperty(d)&&e.myScroll.hasOwnProperty(l)?I():a(w,1e3)},T=function(){e.activeView="summary",y(),p(),E(),w(),v(),S(),n.isBackToStatistics?(e.filterData.selectedYear=n.selectedStatisticsYear?n.selectedStatisticsYear:e.filterData.selectedYear,e.setActiveView("details",e.filterData.selectedYear)):e.setActiveView("summary")};T()}]),angular.module("sntRover").service("RVGuestCardsSrv",["$q","rvBaseWebSrvV2","sntBaseWebSrv","$rootScope","$log","$http",function(e,t,r,a,s,i){var n,o={},c=this,u={id:null,isFetched:!1};c.setGuest=function(e){c.resetGuest(),u.id=parseInt(e,10)},c.isGuestFetchComplete=function(e){return e=parseInt(e,10),u.id===e&&u.isFetched},c.resetGuest=function(){u.id=null,u.isFetched=!1},this.PER_PAGE_COUNT=50,c.fetchGuestDetails=function(t){var i=e.defer(),n="/api/guest_details/"+t;return a.isStandAlone||(n+="?sync_with_external_pms=true"),u.id?r.getJSON(n).then(function(e){u.isFetched=!0,i.resolve(e)},function(e){i.reject(e)}):(s.debug("Guest not set!"),i.reject(["Guest not set"])),i.promise},c.fetchGuestAdminSettings=function(){var t=e.defer(),a="/admin/guest_card_settings/current_settings";return r.getJSON(a).then(function(e){t.resolve(e)},function(e){t.reject(e)}),t.promise},this.fetchGuestAdminSettingsAndGender=function(t){var r=e.defer(),a={},s=[];return s.push(e.when().then(function(){return c.fetchGuestAdminSettings(t).then(function(e){a.guest_admin_settings=e})})),s.push(e.when().then(function(){return c.fetchGenderTypes().then(function(e){a.genderTypeList=e})})),s.push(e.when().then(function(){return c.fetchIdTypes().then(function(e){a.idTypeList=e})})),e.all(s).then(function(){r.resolve(a)},function(e){r.reject(e)}),r.promise},this.fetchGuestDetailsInformation=function(t){var r=e.defer(),a={},s=[];return s.push(c.fetchGuestDetails(t)),s.push(c.fetchGuestAdminSettingsAndGender()),e.all(s).then(function(e){a=e[0],a.guest_admin_settings=e[1].guest_admin_settings,a.genderTypeList=e[1].genderTypes,r.resolve(a)},function(e){r.reject(e)}),r.promise},this.fetchGuests=function(t){var a=e.defer(),s="/api/guest_details";return r.getJSON(s,t).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.setGuestFields=function(){return o},this.setGuestFields=function(){return o},this.fetchGuestCardStatisticsSummary=function(r){var a=e.defer(),s="/api/guest_details/"+r.guestId+"/statistics?view=SUMMARY";return delete r.guestId,t.getJSON(s,r).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.fetchGuestCardStatisticsDetails=function(r){var a=e.defer(),s="/api/guest_details/"+r.guestId+"/statistics?view=DETAILED";return delete r.guestId,t.getJSON(s,r).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise};var d=[];this.fetchNationsList=function(){var r=e.defer(),a="/ui/country_list";return d.length?r.resolve(d):t.getJSON(a).then(function(e){d=e,r.resolve(e)},function(e){r.reject(e)}),r.promise},this.saveGuestIdDetails=function(e){var r="/api/guest_identity";return t.postJSON(r,e)},this.saveFaceImage=function(e){var r="/staff/guest_cards/"+e.guest_id+".json";return t.putJSON(r,e)},this.verifyGuestCardMerge=function(r){var a=e.defer(),s="/api/guest_details/validate_card_merge";return t.postJSON(s,r).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.mergeCards=function(r){var a=e.defer(),s="/api/guest_details/merge_cards";return t.postJSON(s,r).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.fetchGenderTypes=function(){var t=e.defer(),a="api/guest_details/gender_types";return r.getJSON(a).then(function(e){t.resolve(e.gender_list)},function(e){t.resolve(e)}),t.promise},this.fetchIdTypes=function(){var t=e.defer(),a="api/guest_details/government_id_types";return n?t.resolve(n):r.getJSON(a).then(function(e){n=e.id_type_list,t.resolve(n)},function(e){t.resolve(e)}),t.promise},this.fetchGuestList=function(r){var a="/api/guest_details",s=e.defer(),n={method:"GET",url:a,params:r};return i(n).then(function(e){var t={data:e.data,params:e.config&&e.config.params};s.resolve(t)},function(e){t.webserviceErrorActions(a,s,e.data,e.status)}),s.promise}}]),angular.module("sntRover").service("RVGuestCardActivityLogSrv",["$q","rvBaseWebSrvV2",function(e,t){this.fetchActivityLog=function(r){var a=e.defer(),s="/api/guest_card_actions";return t.getJSON(s,r).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise}}]),angular.module("sntRover").controller("mergeCardsController",["$scope","RVMergeCardsSrv","$timeout",function(e,t,r){var a=this,s={ALL:"ALL",AR_ONLY:"AR_ONLY"},i={VERIFYING_MERGE:"Verifying Merge",OK_TO_MERGE:"Ok to Merge",MERGE_NOT_POSSIBLE:"Merge not possible"},n="selected_cards_for_merge_scroll";e.setScroller(n,{tap:!0,preventDefault:!1,deceleration:1e-4,shrinkScrollbars:"clip"}),a.refreshSelectedCardsScroller=function(){r(function(){e.refreshScroller(n)},300)},e.onPrimaryGuestSelectionChange=function(t){e.viewState.selectedCardsForMerge.forEach(function(r){r.id===t?(r.isPrimary=!0,e.viewState.selectedPrimaryCard=r):r.isPrimary=!1})},e.getMergeActionClassName=function(){var t="";return 1===e.viewState.selectedCardsForMerge.length||e.showVerifyMergeProcessActivityIndicator||!e.isEmpty(e.viewState.mergeStatusErrors)?t="grey":e.viewState.selectedCardsForMerge.length>1&&(t="purple"),t},e.verifyMerge=function(){var r=function(t){t.can_merge?(e.viewState.canMerge=t.can_merge,e.viewState.mergeStatusText=i.OK_TO_MERGE):(e.viewState.mergeStatusErrors=t.errors,e.viewState.mergeStatusText=i.MERGE_NOT_POSSIBLE),e.showVerifyMergeProcessActivityIndicator=!1,a.refreshSelectedCardsScroller()},s=function(){};e.showVerifyMergeProcessActivityIndicator=!0;var n={card_ids:a.getNonPrimaryCardIds(),isGuestCard:e.isGuestCard};e.viewState.mergeStatusText=i.VERIFYING_MERGE,e.viewState.hasInitiatedMergeVerification=!0,e.callAPI(t.verifyCardMerge,{params:n,onSuccess:r,onFailure:s})},e.hasMergeVerificationErrors=function(t){if(_.isEmpty(e.viewState.mergeStatusErrors))return!1;var r=e.viewState.mergeStatusErrors[t.id];return r&&r.length>0},e.getErrorMsg=function(t){if(_.isEmpty(e.viewState.mergeStatusErrors))return"";var r=e.viewState.mergeStatusErrors[t.id];return r=r?r.join(","):""},e.cancelSelections=function(){var t=_.pluck(e.viewState.selectedCardsForMerge,"id");e.results.forEach(function(e){t.indexOf(e.id)!==-1&&(e.selected=!1,e.isPrimary=!1)}),a.resetSelectionsForMerge(),e.viewState.isViewSelected=!0,e.cardFilter=s.ALL,e.queryEntered()},e.mergeCards=function(){var r={card_ids:a.getNonPrimaryCardIds(),primary_card_id:e.viewState.selectedPrimaryCard.id,card_type:e.viewState.isCompanyCardSelected?"COMPANY":"TRAVELAGENT",isGuestCard:e.isGuestCard},s=function(){a.resetSelectionsForMerge(),e.queryEntered()},i=function(t){e.viewState.mergeStatusText=t,e.viewState.canMerge=!1};e.callAPI(t.mergeCards,{params:r,onSuccess:s,onFailure:i})},e.removeSelectedCard=function(t){e.viewState.selectedCardsForMerge=_.reject(e.viewState.selectedCardsForMerge,function(e){return e.id===t.id});var r=!!t.isPrimary;t.isPrimary&&(t.isPrimary=!1,e.viewState.selectedPrimaryCard={});var a=_.find(e.results,{id:t.id});a&&(a.selected=!1),r&&e.viewState.selectedCardsForMerge.length>0&&(e.viewState.selectedCardsForMerge[0].isPrimary=!0,e.viewState.selectedPrimaryCard=e.viewState.selectedCardsForMerge[0]),e.viewState.mergeStatusErrors&&e.viewState.mergeStatusErrors[t.id]&&delete e.viewState.mergeStatusErrors[t.id],e.isEmpty(e.viewState.mergeStatusErrors)&&e.viewState.selectedCardsForMerge.length>1&&(e.viewState.canMerge=!0,e.viewState.mergeStatusText=i.OK_TO_MERGE),1===e.viewState.selectedCardsForMerge.length&&(e.viewState.hasInitiatedMergeVerification=!1)},a.resetSelectionsForMerge=function(){e.viewState.selectedPrimaryCard={},e.viewState.selectedCardsForMerge=[],e.viewState.mergeStatusText=[],e.viewState.mergeStatusErrors={},e.viewState.hasInitiatedMergeVerification=!1},a.getNonPrimaryCardIds=function(){var t=_.reject(e.viewState.selectedCardsForMerge,function(e){return e.isPrimary}),r=[];return t.length>0&&(r=_.pluck(t,"id")),r},e.addListener("RESET_SELECTIONS_FOR_MERGE",function(){a.resetSelectionsForMerge()}),e.addListener("REFRESH_SELECTED_CARDS_FOR_MERGE_SCROLLER",function(){a.refreshSelectedCardsScroller()})}]),angular.module("sntRover").service("RVMergeCardsSrv",["$q","rvBaseWebSrvV2",function(e,t){this.verifyCardMerge=function(r){var a=e.defer(),s="/api/accounts/validate_card_merge";return r.isGuestCard&&(s="/api/guest_details/validate_card_merge",delete r.isGuestCard),t.postJSON(s,r).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.mergeCards=function(r){var a=e.defer(),s="/api/accounts/merge_cards";return r.isGuestCard&&(s="/api/guest_details/merge_cards",delete r.isGuestCard,delete r.card_type),t.postJSON(s,r).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise}}]);