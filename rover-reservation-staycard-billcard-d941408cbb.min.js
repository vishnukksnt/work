window.ActiveXObject&&!window.CanvasRenderingContext2D&&function(h,j){function D(a){this.code=a;this.message=T[a]}function U(a){this.width=a}function E(a){this.id=a.C++}function t(a){this.G=a;this.id=a.C++}function u(a,b){this.canvas=a;this.B=b;this.d=a.uniqueID;this.D();this.C=0;this.t="";var c=this;setInterval(function(){n[c.d]===0&&c.e()},30)}function A(){if(j.readyState==="complete"){j.detachEvent(F,A);for(var a=j.getElementsByTagName(r),b=0,c=a.length;b<c;++b)B.initElement(a[b])}}function G(){var a=event.srcElement,b=a.parentNode;a.blur();b.focus()}function H(){var a=event.propertyName;if(a==="width"||a==="height"){var b=event.srcElement,c=b[a],d=parseInt(c,10);if(isNaN(d)||d<0)d=a==="width"?300:150;if(c===d){b.style[a]=d+"px";b.getContext("2d").I(b.width,b.height)}else b[a]=d}}function I(){h.detachEvent(J,I);for(var a in s){var b=s[a],c=b.firstChild,d;for(d in c)if(typeof c[d]==="function")c[d]=k;for(d in b)if(typeof b[d]==="function")b[d]=k;c.detachEvent(K,G);b.detachEvent(L,H)}h[M]=k;h[N]=k;h[O]=k;h[C]=k;h[P]=k}function V(){var a=j.getElementsByTagName("script");a=a[a.length-1];return j.documentMode>=8?a.src:a.getAttribute("src",4)}function v(a){return(""+a).replace(/&/g,"&amp;").replace(/</g,"&lt;")}function W(a){return a.toLowerCase()}function i(a){throw new D(a)}function Q(a){var b=parseInt(a.width,10),c=parseInt(a.height,10);if(isNaN(b)||b<0)b=300;if(isNaN(c)||c<0)c=150;a.width=b;a.height=c}var k=null,r="canvas",M="CanvasRenderingContext2D",N="CanvasGradient",O="CanvasPattern",C="FlashCanvas",P="G_vmlCanvasManager",K="onfocus",L="onpropertychange",F="onreadystatechange",J="onunload",w=((h[C+"Options"]||{}).swfPath||V().replace(/[^\/]+$/,""))+"flashcanvas.swf",e=new function(a){for(var b=0,c=a.length;b<c;b++)this[a[b]]=b}(["toDataURL","save","restore","scale","rotate","translate","transform","setTransform","globalAlpha","globalCompositeOperation","strokeStyle","fillStyle","createLinearGradient","createRadialGradient","createPattern","lineWidth","lineCap","lineJoin","miterLimit","shadowOffsetX","shadowOffsetY","shadowBlur","shadowColor","clearRect","fillRect","strokeRect","beginPath","closePath","moveTo","lineTo","quadraticCurveTo","bezierCurveTo","arcTo","rect","arc","fill","stroke","clip","isPointInPath","font","textAlign","textBaseline","fillText","strokeText","measureText","drawImage","createImageData","getImageData","putImageData","addColorStop","direction","resize"]),x={},n={},s={},y={};u.prototype={save:function(){this.b();this.c();this.m();this.l();this.z();this.w();this.F.push([this.f,this.g,this.A,this.u,this.j,this.h,this.i,this.k,this.p,this.q,this.n,this.o,this.v,this.r,this.s]);this.a.push(e.save)},restore:function(){var a=this.F;if(a.length){a=a.pop();this.globalAlpha=a[0];this.globalCompositeOperation=a[1];this.strokeStyle=a[2];this.fillStyle=a[3];this.lineWidth=a[4];this.lineCap=a[5];this.lineJoin=a[6];this.miterLimit=a[7];this.shadowOffsetX=a[8];this.shadowOffsetY=a[9];this.shadowBlur=a[10];this.shadowColor=a[11];this.font=a[12];this.textAlign=a[13];this.textBaseline=a[14]}this.a.push(e.restore)},scale:function(a,b){this.a.push(e.scale,a,b)},rotate:function(a){this.a.push(e.rotate,a)},translate:function(a,b){this.a.push(e.translate,a,b)},transform:function(a,b,c,d,f,g){this.a.push(e.transform,a,b,c,d,f,g)},setTransform:function(a,b,c,d,f,g){this.a.push(e.setTransform,a,b,c,d,f,g)},b:function(){var a=this.a;if(this.f!==this.globalAlpha){this.f=this.globalAlpha;a.push(e.globalAlpha,this.f)}if(this.g!==this.globalCompositeOperation){this.g=this.globalCompositeOperation;a.push(e.globalCompositeOperation,this.g)}},m:function(){if(this.A!==this.strokeStyle){var a=this.A=this.strokeStyle;this.a.push(e.strokeStyle,typeof a==="object"?a.id:a)}},l:function(){if(this.u!==this.fillStyle){var a=this.u=this.fillStyle;this.a.push(e.fillStyle,typeof a==="object"?a.id:a)}},createLinearGradient:function(a,b,c,d){isFinite(a)&&isFinite(b)&&isFinite(c)&&isFinite(d)||i(9);this.a.push(e.createLinearGradient,a,b,c,d);return new t(this)},createRadialGradient:function(a,b,c,d,f,g){isFinite(a)&&isFinite(b)&&isFinite(c)&&isFinite(d)&&isFinite(f)&&isFinite(g)||i(9);if(c<0||g<0)i(1);this.a.push(e.createRadialGradient,a,b,c,d,f,g);return new t(this)},createPattern:function(a,b){a||i(17);var c=a.tagName,d,f=this.d;if(c){c=c.toLowerCase();if(c==="img")d=a.getAttribute("src",2);else if(c===r||c==="video")return;else i(17)}else if(a.src)d=a.src;else i(17);b==="repeat"||b==="no-repeat"||b==="repeat-x"||b==="repeat-y"||b===""||b===k||i(12);this.a.push(e.createPattern,v(d),b);if(x[f]){this.e();++n[f]}return new E(this)},z:function(){var a=this.a;if(this.j!==this.lineWidth){this.j=this.lineWidth;a.push(e.lineWidth,this.j)}if(this.h!==this.lineCap){this.h=this.lineCap;a.push(e.lineCap,this.h)}if(this.i!==this.lineJoin){this.i=this.lineJoin;a.push(e.lineJoin,this.i)}if(this.k!==this.miterLimit){this.k=this.miterLimit;a.push(e.miterLimit,this.k)}},c:function(){var a=this.a;if(this.p!==this.shadowOffsetX){this.p=this.shadowOffsetX;a.push(e.shadowOffsetX,this.p)}if(this.q!==this.shadowOffsetY){this.q=this.shadowOffsetY;a.push(e.shadowOffsetY,this.q)}if(this.n!==this.shadowBlur){this.n=this.shadowBlur;a.push(e.shadowBlur,this.n)}if(this.o!==this.shadowColor){this.o=this.shadowColor;a.push(e.shadowColor,this.o)}},clearRect:function(a,b,c,d){this.a.push(e.clearRect,a,b,c,d)},fillRect:function(a,b,c,d){this.b();this.c();this.l();this.a.push(e.fillRect,a,b,c,d)},strokeRect:function(a,b,c,d){this.b();this.c();this.m();this.z();this.a.push(e.strokeRect,a,b,c,d)},beginPath:function(){this.a.push(e.beginPath)},closePath:function(){this.a.push(e.closePath)},moveTo:function(a,b){this.a.push(e.moveTo,a,b)},lineTo:function(a,b){this.a.push(e.lineTo,a,b)},quadraticCurveTo:function(a,b,c,d){this.a.push(e.quadraticCurveTo,a,b,c,d)},bezierCurveTo:function(a,b,c,d,f,g){this.a.push(e.bezierCurveTo,a,b,c,d,f,g)},arcTo:function(a,b,c,d,f){f<0&&isFinite(f)&&i(1);this.a.push(e.arcTo,a,b,c,d,f)},rect:function(a,b,c,d){this.a.push(e.rect,a,b,c,d)},arc:function(a,b,c,d,f,g){c<0&&isFinite(c)&&i(1);this.a.push(e.arc,a,b,c,d,f,g?1:0)},fill:function(){this.b();this.c();this.l();this.a.push(e.fill)},stroke:function(){this.b();this.c();this.m();this.z();this.a.push(e.stroke)},clip:function(){this.a.push(e.clip)},w:function(){var a=this.a;if(this.v!==this.font)try{var b=y[this.d];b.style.font=this.v=this.font;var c=b.currentStyle;a.push(e.font,[c.fontStyle,c.fontWeight,b.offsetHeight,c.fontFamily].join(" "))}catch(d){}if(this.r!==this.textAlign){this.r=this.textAlign;a.push(e.textAlign,this.r)}if(this.s!==this.textBaseline){this.s=this.textBaseline;a.push(e.textBaseline,this.s)}if(this.t!==this.canvas.currentStyle.direction){this.t=this.canvas.currentStyle.direction;a.push(e.direction,this.t)}},fillText:function(a,b,c,d){this.b();this.l();this.c();this.w();this.a.push(e.fillText,v(a),b,c,d===void 0?Infinity:d)},strokeText:function(a,b,c,d){this.b();this.m();this.c();this.w();this.a.push(e.strokeText,v(a),b,c,d===void 0?Infinity:d)},measureText:function(a){var b=y[this.d];try{b.style.font=this.font}catch(c){}b.innerText=a.replace(/[ \n\f\r]/g,"\t");return new U(b.offsetWidth)},drawImage:function(a,b,c,d,f,g,o,l,z){a||i(17);var p=a.tagName,m,q=arguments.length,R=this.d;if(p){p=p.toLowerCase();if(p==="img")m=a.getAttribute("src",2);else if(p===r||p==="video")return;else i(17)}else if(a.src)m=a.src;else i(17);this.b();this.c();m=v(m);if(q===3)this.a.push(e.drawImage,q,m,b,c);else if(q===5)this.a.push(e.drawImage,q,m,b,c,d,f);else if(q===9){if(d===0||f===0)i(1);this.a.push(e.drawImage,q,m,b,c,d,f,g,o,l,z)}else return;if(x[R]){this.e();++n[R]}},D:function(){this.globalAlpha=this.f=1;this.globalCompositeOperation=this.g="source-over";this.fillStyle=this.u=this.strokeStyle=this.A="#000000";this.lineWidth=this.j=1;this.lineCap=this.h="butt";this.lineJoin=this.i="miter";this.miterLimit=this.k=10;this.shadowBlur=this.n=this.shadowOffsetY=this.q=this.shadowOffsetX=this.p=0;this.shadowColor=this.o="rgba(0, 0, 0, 0.0)";this.font=this.v="10px sans-serif";this.textAlign=this.r="start";this.textBaseline=this.s="alphabetic";this.a=[];this.F=[]},H:function(){var a=this.a;this.a=[];return a},e:function(){var a=this.H();if(a.length>0)return eval(this.B.CallFunction('<invoke name="executeCommand" returntype="javascript"><arguments><string>'+a.join("&#0;")+"</string></arguments></invoke>"))},I:function(a,b){this.e();this.D();if(a>0)this.B.width=a;if(b>0)this.B.height=b;this.a.push(e.resize,a,b)}};t.prototype={addColorStop:function(a,b){if(isNaN(a)||a<0||a>1)i(1);this.G.a.push(e.addColorStop,this.id,a,b)}};D.prototype=Error();var T={1:"INDEX_SIZE_ERR",9:"NOT_SUPPORTED_ERR",11:"INVALID_STATE_ERR",12:"SYNTAX_ERR",17:"TYPE_MISMATCH_ERR",18:"SECURITY_ERR"},B={initElement:function(a){if(a.getContext)return a;var b=a.uniqueID,c="external"+b;x[b]=false;n[b]=1;Q(a);a.innerHTML='<object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" codebase="'+location.protocol+'//fpdownload.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=9,0,0,0" width="100%" height="100%" id="'+c+'"><param name="allowScriptAccess" value="always"><param name="flashvars" value="id='+c+'"><param name="wmode" value="transparent"></object><span style="margin:0;padding:0;border:0;display:inline-block;position:static;height:1em;overflow:visible;white-space:nowrap"></span>';s[b]=a;var d=a.firstChild;y[b]=a.lastChild;var f=j.body.contains;if(f(a))d.movie=w;else var g=setInterval(function(){if(f(a)){clearInterval(g);d.movie=w}},0);if(j.compatMode==="BackCompat"||!h.XMLHttpRequest)y[b].style.overflow="hidden";var o=new u(a,d);a.getContext=function(l){return l==="2d"?o:k};a.toDataURL=function(l,z){(""+l).replace(/[A-Z]+/g,W)==="image/jpeg"?o.a.push(e.toDataURL,l,typeof z==="number"?z:""):o.a.push(e.toDataURL,l);return o.e()};d.attachEvent(K,G);return a},saveImage:function(a){a.firstChild.saveImage()},setOptions:function(){},trigger:function(a,b){s[a].fireEvent("on"+b)},unlock:function(a,b){n[a]&&--n[a];if(b){var c=s[a],d=c.firstChild,f,g;Q(c);f=c.width;g=c.height;c.style.width=f+"px";c.style.height=g+"px";if(f>0)d.width=f;if(g>0)d.height=g;d.resize(f,g);c.attachEvent(L,H);x[a]=true}}};j.createElement(r);j.createStyleSheet().cssText=r+"{display:inline-block;overflow:hidden;width:300px;height:150px}";j.readyState==="complete"?A():j.attachEvent(F,A);h.attachEvent(J,I);if(w.indexOf(location.protocol+"//"+location.host+"/")===0){var S=new ActiveXObject("Microsoft.XMLHTTP");S.open("GET",w,false);S.send(k)}h[M]=u;h[N]=t;h[O]=E;h[C]=B;h[P]={init:function(){},init_:function(){},initElement:B.initElement};keep=u.measureText}(window,document);
(function(){function q(b){for(var j,s=b.css("color"),g,b=b[0],c=!1;b&&!g&&!c;){try{j=$(b).css("background-color")}catch(d){j="transparent"}"transparent"!==j&&"rgba(0, 0, 0, 0)"!==j&&(g=j);c=b.body;b=b.parentNode}var b=/rgb[a]*\((\d+),\s*(\d+),\s*(\d+)/,c=/#([AaBbCcDdEeFf\d]{2})([AaBbCcDdEeFf\d]{2})([AaBbCcDdEeFf\d]{2})/,a;j=void 0;(j=s.match(b))?a={r:parseInt(j[1],10),g:parseInt(j[2],10),b:parseInt(j[3],10)}:(j=s.match(c))&&(a={r:parseInt(j[1],16),g:parseInt(j[2],16),b:parseInt(j[3],16)});var f;g?(j=void 0,(j=g.match(b))?f={r:parseInt(j[1],10),g:parseInt(j[2],10),b:parseInt(j[3],10)}:(j=g.match(c))&&(f={r:parseInt(j[1],16),g:parseInt(j[2],16),b:parseInt(j[3],16)})):f=a?127<Math.max.apply(null,[a.r,a.g,a.b])?{r:0,g:0,b:0}:{r:255,g:255,b:255}:{r:255,g:255,b:255};j=function(b){return"rgb("+[b.r,b.g,b.b].join(", ")+")"};a&&f?(b=Math.max.apply(null,[a.r,a.g,a.b]),a=Math.max.apply(null,[f.r,f.g,f.b]),a=Math.round(a+-.75*(a-b)),a={r:a,g:a,b:a}):a?(a=Math.max.apply(null,[a.r,a.g,a.b]),b=1,127<a&&(b=-1),a=Math.round(a+96*b),a={r:a,g:a,b:a}):a={r:191,g:191,b:191};return{color:s,"background-color":f?j(f):g,"decor-color":j(a)}}function m(b,j){this.x=b;this.y=j;this.reverse=function(){return new this.constructor(-1*this.x,-1*this.y)};this._length=null;this.getLength=function(){this._length||(this._length=Math.sqrt(Math.pow(this.x,2)+Math.pow(this.y,2)));return this._length};var s=function(b){return Math.round(b/Math.abs(b))};this.resizeTo=function(b){if(0===this.x&&0===this.y)this._length=0;else if(0===this.x)this._length=b,this.y=b*s(this.y);else if(0===this.y)this._length=b,this.x=b*s(this.x);else{var j=Math.abs(this.y/this.x),a=Math.sqrt(Math.pow(b,2)/(1+Math.pow(j,2))),j=j*a;this._length=b;this.x=a*s(this.x);this.y=j*s(this.y)}return this};this.angleTo=function(b){var j=this.getLength()*b.getLength();return 0===j?0:Math.acos(Math.min(Math.max((this.x*b.x+this.y*b.y)/j,-1),1))/Math.PI}}function k(b,j){this.x=b;this.y=j;this.getVectorToCoordinates=function(b,j){return new m(b-this.x,j-this.y)};this.getVectorFromCoordinates=function(b,j){return this.getVectorToCoordinates(b,j).reverse()};this.getVectorToPoint=function(b){return new m(b.x-this.x,b.y-this.y)};this.getVectorFromPoint=function(b){return this.getVectorToPoint(b).reverse()}}function t(b,j,a,g,c){this.data=b;this.context=j;if(b.length)for(var d=b.length,f,l,i=0;i<d;i++){f=b[i];l=f.x.length;a.call(j,f);for(var e=1;e<l;e++)g.call(j,f,e);c.call(j,f)}this.changed=function(){};this.startStrokeFn=a;this.addToStrokeFn=g;this.endStrokeFn=c;this.inStroke=!1;this._stroke=this._lastPoint=null;this.startStroke=function(b){if(b&&"number"==typeof b.x&&"number"==typeof b.y){this._stroke={x:[b.x],y:[b.y]};this.data.push(this._stroke);this._lastPoint=b;this.inStroke=!0;var j=this._stroke,a=this.startStrokeFn,g=this.context;setTimeout(function(){a.call(g,j)},3);return b}return null};this.addToStroke=function(b){if(this.inStroke&&"number"===typeof b.x&&"number"===typeof b.y&&4<Math.abs(b.x-this._lastPoint.x)+Math.abs(b.y-this._lastPoint.y)){var j=this._stroke.x.length;this._stroke.x.push(b.x);this._stroke.y.push(b.y);this._lastPoint=b;var a=this._stroke,g=this.addToStrokeFn,s=this.context;setTimeout(function(){g.call(s,a,j)},3);return b}return null};this.endStroke=function(){var b=this.inStroke;this.inStroke=!1;this._lastPoint=null;if(b){var j=this._stroke,a=this.endStrokeFn,g=this.context,s=this.changed;setTimeout(function(){a.call(g,j);s.call(g)},3);return!0}return null}}function r(b,j,a){var g=this.$parent=$(b),b=this.eventTokens={};this.events=new v(this);var c=$.fn[e]("globalEvents"),d={width:"ratio",height:"ratio",sizeRatio:4,color:"#000","background-color":"#fff","decor-color":"#eee",lineWidth:0,minFatFingerCompensation:-10,showUndoButton:!1,data:[]};$.extend(d,q(g));j&&$.extend(d,j);this.settings=d;for(var f in a)a.hasOwnProperty(f)&&a[f].call(this,f);this.events.publish(e+".initializing");this.$controlbarUpper=$('<div style="padding:0 !important;margin:0 !important;width: 100% !important; height: 0 !important;margin-top:-1em !important;margin-bottom:1em !important;"></div>').appendTo(g);this.isCanvasEmulator=!1;a=this.canvas=this.initializeCanvas(d);j=$(a);this.$controlbarLower=$('<div style="padding:0 !important;margin:0 !important;width: 100% !important; height: 0 !important;margin-top:-1.5em !important;margin-bottom:1.5em !important;"></div>').appendTo(g);this.canvasContext=a.getContext("2d");j.data(e+".this",this);g=(g=d.lineWidth)?g:Math.max(Math.round(a.width/400),2);d.lineWidth=g;this.lineCurveThreshold=3*d.lineWidth;d.cssclass&&""!=$.trim(d.cssclass)&&j.addClass(d.cssclass);this.fatFingerCompensation=0;var g=function(b){var j,a,g=function(g){g=g.changedTouches&&0<g.changedTouches.length?g.changedTouches[0]:g;return new k(Math.round(g.pageX+j),Math.round(g.pageY+a)+b.fatFingerCompensation)},d=new y(750,function(){b.dataEngine.endStroke()});this.drawEndHandler=function(j){try{j.preventDefault()}catch(a){}d.clear();b.dataEngine.endStroke()};this.drawStartHandler=function(c){c.preventDefault();var s=$(b.canvas).offset();j=-1*s.left;a=-1*s.top;b.dataEngine.startStroke(g(c));d.kick()};this.drawMoveHandler=function(j){j.preventDefault();b.dataEngine.inStroke&&(b.dataEngine.addToStroke(g(j)),d.kick())};return this}.call({},this),l=g.drawEndHandler,i=g.drawStartHandler,p=g.drawMoveHandler,h=this.canvas,j=$(h);this.isCanvasEmulator?(j.bind("mousemove."+e,p),j.bind("mouseup."+e,l),j.bind("mousedown."+e,i)):(h.ontouchstart=function(b){h.onmousedown=void 0;h.onmouseup=void 0;h.onmousemove=void 0;this.fatFingerCompensation=d.minFatFingerCompensation&&-3*d.lineWidth>d.minFatFingerCompensation?-3*d.lineWidth:d.minFatFingerCompensation;i(b);h.ontouchend=l;h.ontouchstart=i;h.ontouchmove=p},h.onmousedown=function(b){h.ontouchstart=void 0;h.ontouchend=void 0;h.ontouchmove=void 0;i(b);h.onmousedown=i;h.onmouseup=l;h.onmousemove=p});b[e+".windowmouseup"]=c.subscribe(e+".windowmouseup",g.drawEndHandler);this.events.publish(e+".attachingEventHandlers");var n=this,b=d.width.toString(10),w=e;if("ratio"===b||"%"===b.split("")[b.length-1])this.eventTokens[w+".parentresized"]=c.subscribe(w+".parentresized",function(b,j,a){return function(){var g=j.width();if(g!==a){for(var d in b)b.hasOwnProperty(d)&&(c.unsubscribe(b[d]),delete b[d]);var s=n.settings;n.$parent.children().remove();for(d in n)n.hasOwnProperty(d)&&delete n[d];d=s.data;var g=1*g/a,f=[],l,i,e,h,k,p;i=0;for(e=d.length;i<e;i++){p=d[i];l={x:[],y:[]};h=0;for(k=p.x.length;h<k;h++)l.x.push(p.x[h]*g),l.y.push(p.y[h]*g);f.push(l)}s.data=f;j[w](s)}}}(this.eventTokens,this.$parent,this.$parent.width(),1*this.canvas.width/this.canvas.height));this.resetCanvas(d.data);this.events.publish(e+".initialized");return this}var e="jSignature",y=function(b,j){var a;this.kick=function(){clearTimeout(a);a=setTimeout(j,b)};this.clear=function(){clearTimeout(a)};return this},v=function(b){this.topics={};this.context=b?b:this;this.publish=function(b,a,g,d){if(this.topics[b]){var c=this.topics[b],f=Array.prototype.slice.call(arguments,1),l=[],i,e,h,p;e=0;for(h=c.length;e<h;e++)p=c[e],i=p[0],p[1]&&(p[0]=function(){},l.push(e)),i.apply(this.context,f);e=0;for(h=l.length;e<h;e++)c.splice(l[e],1)}};this.subscribe=function(b,a,g){this.topics[b]?this.topics[b].push([a,g]):this.topics[b]=[[a,g]];return{topic:b,callback:a}};this.unsubscribe=function(b){if(this.topics[b.topic])for(var a=this.topics[b.topic],g=0,d=a.length;g<d;g++)a[g][0]===b.callback&&a.splice(g,1)}},z=function(b){var a=this.canvasContext,d=b.x[0],b=b.y[0],g=this.settings.lineWidth,c=a.fillStyle;a.fillStyle=a.strokeStyle;a.fillRect(d+g/-2,b+g/-2,g,g);a.fillStyle=c},u=function(b,a){var d=new k(b.x[a-1],b.y[a-1]),g=new k(b.x[a],b.y[a]),c=d.getVectorToPoint(g);if(1<a){var f=new k(b.x[a-2],b.y[a-2]),l=f.getVectorToPoint(d),i;if(l.getLength()>this.lineCurveThreshold){i=2<a?new k(b.x[a-3],b.y[a-3]).getVectorToPoint(f):new m(0,0);var e=.35*l.getLength(),h=l.angleTo(i.reverse()),p=c.angleTo(l.reverse());i=new m(i.x+l.x,i.y+l.y).resizeTo(Math.max(.05,h)*e);var n=new m(l.x+c.x,l.y+c.y).reverse().resizeTo(Math.max(.05,p)*e),l=this.canvasContext,e=f.x,p=f.y,h=d.x,w=d.y,A=f.x+i.x,f=f.y+i.y;i=d.x+n.x;n=d.y+n.y;l.beginPath();l.moveTo(e,p);l.bezierCurveTo(A,f,i,n,h,w);l.stroke()}}c.getLength()<=this.lineCurveThreshold&&(c=this.canvasContext,f=d.x,d=d.y,i=g.x,g=g.y,c.beginPath(),c.moveTo(f,d),c.lineTo(i,g),c.stroke())},x=function(b){var a=b.x.length-1;if(0<a){var d=new k(b.x[a],b.y[a]),g=new k(b.x[a-1],b.y[a-1]),c=g.getVectorToPoint(d);if(c.getLength()>this.lineCurveThreshold){if(1<a){var b=new k(b.x[a-2],b.y[a-2]).getVectorToPoint(g),f=new m(b.x+c.x,b.y+c.y).resizeTo(c.getLength()/2),c=this.canvasContext,b=g.x,a=g.y,l=d.x,i=d.y,e=g.x+f.x,g=g.y+f.y,f=d.x,d=d.y;c.beginPath();c.moveTo(b,a);c.bezierCurveTo(e,g,f,d,l,i)}else c=this.canvasContext,b=g.x,g=g.y,a=d.x,d=d.y,c.beginPath(),c.moveTo(b,g),c.lineTo(a,d);c.stroke()}}};r.prototype.resetCanvas=function(b){var a=this.canvas,d=this.settings,c=this.canvasContext,f=this.isCanvasEmulator,l=a.width,i=a.height;c.clearRect(0,0,l+30,i+30);c.shadowColor=c.fillStyle=d["background-color"];f&&c.fillRect(0,0,l+30,i+30);c.lineWidth=Math.ceil(parseInt(d.lineWidth,10));c.lineCap=c.lineJoin="round";c.strokeStyle=d["decor-color"];c.shadowOffsetX=0;c.shadowOffsetY=0;var h=Math.round(i/5),p=1.5*h,k=i-h,l=l-1.5*h,i=i-h;c.beginPath();c.moveTo(p,k);c.lineTo(l,i);c.stroke();c.strokeStyle=d.color;f||(c.shadowColor=c.strokeStyle,c.shadowOffsetX=.5*c.lineWidth,c.shadowOffsetY=-.6*c.lineWidth,c.shadowBlur=0);b||(b=[]);c=this.dataEngine=new t(b,this,z,u,x);d.data=b;$(a).data(e+".data",b).data(e+".settings",d);var n=this.$parent,w=this.events,A=e;c.changed=function(){w.publish(A+".change");n.trigger("change")};c.changed();return!0};r.prototype.initializeCanvas=function(b){var a=document.createElement("canvas"),c=$(a);b.width===b.height&&"ratio"===b.height&&(b.width="100%");c.css("margin",0).css("padding",0).css("border","none").css("height","ratio"===b.height||!b.height?1:b.height.toString(10)).css("width","ratio"===b.width||!b.width?1:b.width.toString(10));c.appendTo(this.$parent);"ratio"===b.height?c.css("height",Math.round(c.width()/b.sizeRatio)):"ratio"===b.width&&c.css("width",Math.round(c.height()*b.sizeRatio));c.addClass(e);a.width=c.width();a.height=c.height();b=a;if(b.getContext)b=!1;else{var c=b.ownerDocument.parentWindow,d=c.FlashCanvas?b.ownerDocument.parentWindow.FlashCanvas:"undefined"===typeof FlashCanvas?void 0:FlashCanvas;if(d){b=d.initElement(b);d=1;c&&(c.screen&&c.screen.deviceXDPI&&c.screen.logicalXDPI)&&(d=1*c.screen.deviceXDPI/c.screen.logicalXDPI);if(1!==d)try{$(b).children("object").get(0).resize(Math.ceil(b.width*d),Math.ceil(b.height*d)),b.getContext("2d").scale(d,d)}catch(f){}b=!0}else throw Error("Canvas element does not support 2d context. jSignature cannot proceed.")}this.isCanvasEmulator=b;a.onselectstart=function(b){b&&b.preventDefault&&b.preventDefault();b&&b.stopPropagation&&b.stopPropagation();return!1};return a};var p=window,h=function(b,a){var c=new Image,d=this;c.onload=function(){d.getContext("2d").drawImage(c,0,0,c.width<d.width?c.width:d.width,c.height<d.height?c.height:d.height)};c.src="data:"+a+","+b},a=function(b){this.find("canvas."+e).add(this.filter("canvas."+e)).data(e+".this").resetCanvas(b);return this},f=function(b,a){if(void 0===a&&("string"===typeof b&&"data:"===b.substr(0,5))&&(a=b.slice(5).split(",")[0],b=b.slice(6+a.length),a===b))return;var c=this.find("canvas."+e).add(this.filter("canvas."+e));if(n.hasOwnProperty(a))0!==c.length&&n[a].call(c[0],b,a,function(b){return function(){return b.resetCanvas.apply(b,arguments)}}(c.data(e+".this")));else throw Error(e+" is unable to find import plugin with for format '"+String(a)+"'");return this},d=new v,c=e,l,i=function(){d.publish(c+".parentresized")};$(p).bind("resize."+c,function(){l&&clearTimeout(l);l=setTimeout(i,500)}).bind("mouseup."+c,function(){d.publish(c+".windowmouseup")});var w={},A={default:function(){return this.toDataURL()},native:function(b){return b},image:function(){var b=this.toDataURL();if("string"===typeof b&&4<b.length&&"data:"===b.slice(0,5)&&-1!==b.indexOf(",")){var a=b.indexOf(",");return[b.slice(5,a),b.substr(a+1)]}return[]}},n={native:function(b,a,c){c(b)},image:h,"image/png;base64":h,"image/jpeg;base64":h,"image/jpg;base64":h},B={export:A,import:n,instance:w},C={init:function(b){return this.each(function(){var a,c=!1;for(a=this.parentNode;a&&!c;)c=a.body,a=a.parentNode;!c||new r(this,b,w)})},getSettings:function(){return this.find("canvas."+e).add(this.filter("canvas."+e)).data(e+".this").settings},clear:a,reset:a,addPlugin:function(b,a,c){B.hasOwnProperty(b)&&(B[b][a]=c);return this},listPlugins:function(b){var a=[];if(B.hasOwnProperty(b)){var b=B[b],c;for(c in b)b.hasOwnProperty(c)&&a.push(c)}return a},getData:function(b){var a=this.find("canvas."+e).add(this.filter("canvas."+e));void 0===b&&(b="default");if(0!==a.length&&A.hasOwnProperty(b))return A[b].call(a.get(0),a.data(e+".data"))},importData:f,setData:f,globalEvents:function(){return d},events:function(){return this.find("canvas."+e).add(this.filter("canvas."+e)).data(e+".this").events}};$.fn[e]=function(b){if(!b||"object"===typeof b)return C.init.apply(this,arguments);if("string"===typeof b&&C[b])return C[b].apply(this,Array.prototype.slice.call(arguments,1));$.error("Method "+String(b)+" does not exist on jQuery."+e)}})();(function(){$.fn.jSignature("addPlugin","instance","UndoButton",function(q){this.events.subscribe("jSignature.attachingEventHandlers",function(){if(this.settings[q]){var m=this.settings[q];"function"!==typeof m&&(m=function(){var e=$('<input type="button" value="Undo last stroke" style="position:absolute;display:none;margin:0 !important;top:auto" />').appendTo(this.$controlbarLower),k=e.width();e.css("left",Math.round((this.canvas.width-k)/2));k!==e.width()&&e.width(k);return e});var k=m.call(this),t=this;t.events.subscribe("jSignature.change",function(){t.dataEngine.data.length?k.show():k.hide()});var r=this,e=(this.events.topics.hasOwnProperty("jSignature.undo")?q:"jSignature")+".undo";k.bind("click",function(){r.events.publish(e)});r.events.subscribe(e,function(){var e=r.dataEngine.data;e.length&&(e.pop(),r.resetCanvas(e))})}})})})();(function(){for(var q={},m={},k="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWX".split(""),t=k.length/2,r=t-1;-1<r;r--)q[k[r]]=k[r+t],m[k[r+t]]=k[r];var e=function(e){for(var e=e.split(""),h=e.length,a=1;a<h;a++)e[a]=q[e[a]];return e.join("")},y=function(k){for(var h=[],a=0,f=1,d=k.length,c,l,i=0;i<d;i++)c=Math.round(k[i]),l=c-a,a=c,0>l&&0<f?(f=-1,h.push("Z")):0<l&&0>f&&(f=1,h.push("Y")),c=Math.abs(l),c>=t?h.push(e(c.toString(t))):h.push(c.toString(t));return h.join("")},v=function(e){for(var h=[],e=e.split(""),a=e.length,f,d=1,c=[],l=0,i=0;i<a;i++)f=e[i],f in q||"Z"===f||"Y"===f?(0!==c.length&&(c=parseInt(c.join(""),t)*d+l,h.push(c),l=c),"Z"===f?(d=-1,c=[]):"Y"===f?(d=1,c=[]):c=[f]):c.push(m[f]);h.push(parseInt(c.join(""),t)*d+l);return h},z=function(e){for(var h=[],a=e.length,f,d=0;d<a;d++)f=e[d],h.push(y(f.x)),h.push(y(f.y));return h.join("_")},u=function(e){for(var h=[],e=e.split("_"),a=e.length/2,f=0;f<a;f++)h.push({x:v(e[2*f]),y:v(e[2*f+1])});return h},k=function(e){return["image/jsignature;base30",z(e)]},r=function(e,h,a){"string"===typeof e&&("image/jsignature;base30"===e.substring(0,23).toLowerCase()&&(e=e.substring(24)),a(u(e)))};if(null==this.jQuery)throw Error("We need jQuery for some of the functionality. jQuery is not detected. Failing to initialize...");var x=this.jQuery.fn.jSignature;x("addPlugin","export","base30",k);x("addPlugin","export","image/jsignature;base30",k);x("addPlugin","import","base30",r);x("addPlugin","import","image/jsignature;base30",r);this.jSignatureDebug&&(this.jSignatureDebug.base30={remapTailChars:e,compressstrokeleg:y,uncompressstrokeleg:v,compressstrokes:z,uncompressstrokes:u,charmap:q})}).call("undefined"!==typeof window?window:this);(function(){function q(a,f){this.x=a;this.y=f;this.reverse=function(){return new this.constructor(-1*this.x,-1*this.y)};this._length=null;this.getLength=function(){this._length||(this._length=Math.sqrt(Math.pow(this.x,2)+Math.pow(this.y,2)));return this._length};var d=function(a){return Math.round(a/Math.abs(a))};this.resizeTo=function(a){if(0===this.x&&0===this.y)this._length=0;else if(0===this.x)this._length=a,this.y=a*d(this.y);else if(0===this.y)this._length=a,this.x=a*d(this.x);else{var f=Math.abs(this.y/this.x),e=Math.sqrt(Math.pow(a,2)/(1+Math.pow(f,2))),f=f*e;this._length=a;this.x=e*d(this.x);this.y=f*d(this.y)}return this};this.angleTo=function(a){var d=this.getLength()*a.getLength();return 0===d?0:Math.acos(Math.min(Math.max((this.x*a.x+this.y*a.y)/d,-1),1))/Math.PI}}function m(a,f){this.x=a;this.y=f;this.getVectorToCoordinates=function(a,c){return new q(a-this.x,c-this.y)};this.getVectorFromCoordinates=function(a,c){return this.getVectorToCoordinates(a,c).reverse()};this.getVectorToPoint=function(a){return new q(a.x-this.x,a.y-this.y)};this.getVectorFromPoint=function(a){return this.getVectorToPoint(a).reverse()}}function k(a,f){var d=Math.pow(10,f);return Math.round(a*d)/d}function t(a,f,d){var f=f+1,c=new m(a.x[f-1],a.y[f-1]),e=new m(a.x[f],a.y[f]),e=c.getVectorToPoint(e),i=new m(a.x[f-2],a.y[f-2]),c=i.getVectorToPoint(c);return c.getLength()>d?(d=2<f?new m(a.x[f-3],a.y[f-3]).getVectorToPoint(i):new q(0,0),a=.35*c.getLength(),i=c.angleTo(d.reverse()),f=e.angleTo(c.reverse()),d=new q(d.x+c.x,d.y+c.y).resizeTo(Math.max(.05,i)*a),e=new q(c.x+e.x,c.y+e.y).reverse().resizeTo(Math.max(.05,f)*a),e=new q(c.x+e.x,c.y+e.y),["c",k(d.x,2),k(d.y,2),k(e.x,2),k(e.y,2),k(c.x,2),k(c.y,2)]):["l",k(c.x,2),k(c.y,2)]}function r(a,f){var d=a.x.length-1,c=new m(a.x[d],a.y[d]),e=new m(a.x[d-1],a.y[d-1]),c=e.getVectorToPoint(c);if(1<d&&c.getLength()>f){var d=new m(a.x[d-2],a.y[d-2]).getVectorToPoint(e),e=c.angleTo(d.reverse()),i=.35*c.getLength(),d=new q(d.x+c.x,d.y+c.y).resizeTo(Math.max(.05,e)*i);return["c",k(d.x,2),k(d.y,2),k(c.x,2),k(c.y,2),k(c.x,2),k(c.y,2)]}return["l",k(c.x,2),k(c.y,2)]}function e(a,e,d){for(var e=["M",k(a.x[0]-e,2),k(a.y[0]-d,2)],d=1,c=a.x.length-1;d<c;d++)e.push.apply(e,t(a,d,1));0<c?e.push.apply(e,r(a,d,1)):0===c&&e.push.apply(e,["l",1,1]);return e.join(" ")}function y(a){var f=['<?xml version="1.0" encoding="UTF-8" standalone="no"?>','<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">'],d,c=a.length,l,i=[],h=[],k=l=d=0,n=0,p=[];if(0!==c){for(d=0;d<c;d++){k=a[d];n=[];l={x:[],y:[]};for(var m=void 0,b=void 0,m=0,b=k.x.length;m<b;m++)n.push({x:k.x[m],y:k.y[m]});n=simplify(n,.7,!0);m=0;for(b=n.length;m<b;m++)l.x.push(n[m].x),l.y.push(n[m].y);p.push(l);i=i.concat(l.x);h=h.concat(l.y)}a=Math.min.apply(null,i)-1;c=Math.max.apply(null,i)+1;i=Math.min.apply(null,h)-1;h=Math.max.apply(null,h)+1;k=0>a?0:a;n=0>i?0:i;d=c-a;l=h-i}f.push('<svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="'+d.toString()+'" height="'+l.toString()+'">');d=0;for(c=p.length;d<c;d++)l=p[d],f.push('<path fill="none" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="'+e(l,k,n)+'"/>');f.push("</svg>");return f.join("")}function v(a){return[p,y(a)]}function z(a){return[h,x(y(a))]}var u=window;"use strict";("undefined"!=typeof exports?exports:u).simplify=function(a,e,d){e=void 0!==e?e*e:1;if(!d){for(var c=a.length,l,i=a[0],h=[i],d=1;d<c;d++){l=a[d];var k=l.x-i.x,n=l.y-i.y;k*k+n*n>e&&(h.push(l),i=l)}a=(i!==l&&h.push(l),h)}l=a;var d=l.length,c=new("undefined"!=typeof Uint8Array?Uint8Array:Array)(d),i=0,h=d-1,m,p,b=[],j=[],s=[];for(c[i]=c[h]=1;h;){n=0;for(k=i+1;k<h;k++){m=l[k];var g=l[i],r=l[h],q=g.x,t=g.y,g=r.x-q,u=r.y-t,v=void 0;if(0!==g||0!==u)v=((m.x-q)*g+(m.y-t)*u)/(g*g+u*u),1<v?(q=r.x,t=r.y):0<v&&(q+=g*v,t+=u*v);m=(g=m.x-q,u=m.y-t,g*g+u*u);m>n&&(p=k,n=m)}n>e&&(c[p]=1,b.push(i),j.push(p),b.push(p),j.push(h));i=b.pop();h=j.pop()}for(k=0;k<d;k++)c[k]&&s.push(l[k]);return a=s,a};if("function"!==typeof x)var x=function(a){var e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".split(""),d,c,h,i,k=0,m=0,n="",n=[];do d=a.charCodeAt(k++),c=a.charCodeAt(k++),h=a.charCodeAt(k++),i=d<<16|c<<8|h,d=i>>18&63,c=i>>12&63,h=i>>6&63,i&=63,n[m++]=e[d]+e[c]+e[h]+e[i];while(k<a.length);n=n.join("");a=a.length%3;return(a?n.slice(0,a-3):n)+"===".slice(a||3)};var p="image/svg+xml",h="image/svg+xml;base64";if("undefined"===typeof $)throw Error("We need jQuery for some of the functionality. jQuery is not detected. Failing to initialize...");u=$.fn.jSignature;u("addPlugin","export","svg",v);u("addPlugin","export",p,v);u("addPlugin","export","svgbase64",z);u("addPlugin","export",h,z)})();
function getGuestStatusMapped(e,t){return t&&"CHECKING_OUT"===e?guestStatusMappings[e][1]:""!==e&&void 0!==e?guestStatusMappings[e][0]:void 0}sntRover.controller("rvAllRoutesCtrl",["$scope","$rootScope","$filter","RVBillinginfoSrv","ngDialog",function(e,t,a,i,n){BaseCtrl.call(this,e),e.isInitialPage=!0;var r={preventDefault:!1};e.setScroller("routes",r),setTimeout(function(){e.refreshScroller("routes")},500),e.getCharges=function(e){return e.attached_charge_codes.length>1||e.attached_billing_groups.length>1?"Multiple":e.attached_charge_codes.length>0?e.attached_charge_codes[0].charge_code+", "+e.attached_charge_codes[0].description:e.attached_billing_groups.length>0?e.attached_billing_groups[0].name:void 0},e.getRouteType=function(e){return e.attached_charge_codes.length>0&&e.attached_billing_groups.length>0||e.attached_charge_codes.length>0?"CHARGE CODE(S)":"BILLING GROUP(S)"},e.deleteRoute=function(t){var a=function(a){e.routes.splice(t,1),e.$parent.$emit("hideLoader"),e.$parent.$emit("BILLINGINFODELETED",e.routes),e.$parent.$emit("REFRESH_BILLCARD_VIEW"),a&&a.bill_number&&(e.reservationBillData.bills[a.bill_number-1].routed_entity_type=a.routed_entity_type,e.reservationBillData.bills[a.bill_number-1].guest_image=a.guest_image)},n=function(t){e.$parent.$emit("hideLoader"),e.$emit("displayErrorMessage",t)},r={};r.id=e.reservationData.reservation_id,r.from_bill=e.routes[t].from_bill,r.to_bill=e.routes[t].to_bill,e.invokeApi(i.deleteRoute,r,a,n)}}]),sntRover.controller("RVbillCardController",["$scope","$rootScope","$state","$stateParams","RVBillCardSrv","reservationBillData","RVReservationCardSrv","ngDialog","$filter","$window","$timeout","$sce","RVKeyPopupSrv","RVPaymentSrv","RVSearchSrv","rvPermissionSrv","jsMappings","$q","sntActivity","RVReservationStateService","$log","sntAuthorizationSrv","RVAutomaticEmailSrv","PAYMENT_CONFIG",function(e,t,a,i,n,r,s,o,l,c,d,u,p,g,m,h,y,v,f,E,C,D,A,I){BaseCtrl.call(this,e),SharedMethodsBaseCtrl.call(this,e,t,A,o);var b=this;t.setPrevState={title:l("translate")("STAY_CARD"),callback:"goBackToStayCard",scope:e},e.encoderTypes=[],e.isSRViewRateBtnClicked=E.getReservationFlag("isSRViewRateBtnClicked"),e.isFromBillCard=!0,e.hasCCAuthPermission=function(){return h.getPermissionValue("OVERRIDE_CC_AUTHORIZATION")};var S={scrollX:!0,click:!0,preventDefault:!0,mouseWheel:!1},T={scrollX:!0,scrollY:!1},R={preventDefaultException:{tagName:/^(INPUT|TEXTAREA|BUTTON|SELECT|A|DIV)$/},preventDefault:!1},P=r.is_infrasec_activated_for_hotel&&r.is_infrasec_activated_for_workstation;e.hasPrintFolioEnabled=r.is_print_folio_enabled,C.info("is_infrasec_activated_for_hotel",r.is_infrasec_activated_for_hotel),C.info("is_infrasec_activated_for_workstation",r.is_infrasec_activated_for_workstation),e.setScroller("registration-content",R),e.setScroller("bill-tab-scroller",S),e.clickedButton=i.clickedButton,e.saveData={},e.signatureData="",e.saveData.promotions=!!r.is_promotions_and_email_set,e.saveData.termsAndConditions=!!e.reservation.reservation_card.is_pre_checkin&&e.reservation.reservation_card.is_pre_checkin,e.reviewStatusArray=[],e.isAllBillsReviewed=!1,e.isLastBillSucceededWithBlackBoxAPI=!1,e.saveData.isEarlyDepartureFlag=!1,e.saveData.isEmailPopupFlag=!1,e.isRefreshOnBackToStaycard=!1,e.paymentModalOpened=!1,e.billingInfoModalOpened=!1,e.showPayButton=!1,e.paymentModalSwipeHappened=!1,e.isSwipeHappenedDuringCheckin=!1,e.do_not_cc_auth=!1;var B=!1,N=!1,L=!1;e.currentActiveBill=0,e.dayRates=-1,e.showAddonIndex=-1,e.showGroupItemIndex=-1,e.showRoomDetailsIndex=-1,e.showActiveBillFeesDetails=0,e.showFeesDetails=!0,e.moveToBill=0,e.showSignedSignature=!1,e.showBillingInfo=!1,e.showIncomingBillingInfo=!1,e.reservationBillData=r,e.performCompleteCheckoutAction=!1,e.isCheckoutWithoutSettlement=!1;var w=t.$on("arAccountCreated",function(){var t=!0;d(function(){e.showAdvancedBillDialog(t),e.$emit("hideLoader")},100)});e.$on("$destroy",w),e.hasMoveToOtherBillPermission=function(){return t.isStandAlone&&h.getPermissionValue("MOVE_CHARGES_RESERVATION_ACCOUNT")};var O=function(a){if(t.isStandAlone){var i=e.reservationBillData.bills,n=i[e.currentActiveBill].total_fees[0].fees_details,r=[];_.each(n,function(e){e.isSelected=a,r.push(e.id)}),e.reservationBillData.isAllChargeCodeSelected=a}};O(!1),e.isAllChargeCodesSelected=function(){var a=!0,i=e.reservationBillData.bills;if(t.isStandAlone){var n=i[e.currentActiveBill].total_fees[0].fees_details;n&&n.length>0?_.each(n,function(e){e.isSelected||(a=!1)}):a=!1}else a=!1;return a},e.isAnyOneChargeCodeIsExcluded=function(){var a=!1,i=!1,n=e.reservationBillData.bills;if(t.isStandAlone){var r=n[e.currentActiveBill].total_fees[0].fees_details;r.length>0?_.each(r,function(e,t){e.isSelected?i=!0:a=!0}):(a=!1,i=!1)}else a=!1,i=!1;return a&&i},e.selectAllChargeCodeToggle=function(){O(e.reservationBillData.isAllChargeCodeSelected?!0:!1)},e.moveChargesClicked=function(){var t=e.reservationBillData.bills,a=t[e.currentActiveBill].total_fees[0].fees_details;e.moveChargeData={},e.moveChargeData.selectedTransactionIds=[];var i="undefined"!=typeof e.guestCardData.contactInfo.first_name?e.guestCardData.contactInfo.first_name:"",n="undefined"!=typeof e.guestCardData.contactInfo.last_name?e.guestCardData.contactInfo.last_name:"";e.moveChargeData.displayName=e.reservationBillData.confirm_no+" "+n+" "+i,e.moveChargeData.currentActiveBillNumber=parseInt(e.currentActiveBill)+parseInt(1),e.moveChargeData.fromBillId=t[e.currentActiveBill].bill_id,a.length>0&&(_.each(a,function(t,a){if(t.isSelected)if(t.is_group_by_ref){var i=e.moveChargeData.selectedTransactionIds.concat(t.item_ids);e.moveChargeData.selectedTransactionIds=i}else e.moveChargeData.selectedTransactionIds.push(t.id)}),o.open({template:"/assets/partials/bill/rvMoveTransactionPopup.html",controller:"RVMoveChargeCtrl",className:"",scope:e}))},e.isPrintRegistrationCard=!1,e.isRegistrationCardEnabledFor={austria:e.reservationBillData.austrian_registration_card_enabled,arabia:e.reservationBillData.arabic_registration_card_enabled};var k={};e.reservationBillData.roomChargeEnabled="",e.billingData={},e.printData={},e.fromViewToPaymentPopup="billcard";var G=angular.element(c).width();e.signaturePluginOptions={width:G-60,"decor-color":"transparent",height:"320px"},"checkoutButton"===e.clickedButton?(e.$emit("HeaderChanged",l("translate")("GUEST_BILL_TITLE")),e.setTitle(l("translate")("GUEST_BILL_TITLE"))):"checkinButton"===e.clickedButton?(e.$emit("HeaderChanged",l("translate")("REGISTRATION")),e.setTitle(l("translate")("REGISTRATION"))):(e.$emit("HeaderChanged",l("translate")("GUEST_BILL_TITLE")),e.setTitle(l("translate")("GUEST_BILL_TITLE")));var M=function(){return"true"===e.reservationBillData.icare_enabled&&"true"===e.reservationBillData.combined_key_room_charge_create?"true":"false"},x=function(t){var a="PAYMENT"!==t,i=h.getPermissionValue("SPLIT_CHARGES"),n=e.hasPermissionToEditChargeCodeDescription(),r=h.getPermissionValue("EDIT_CHARGES"),s=h.getPermissionValue("DELETE_CHARGES");return a&&(r||s)||i||n};e.hasPermissionToEditChargeCodeDescription=function(){return h.getPermissionValue("EDIT_CHARGECODE_DESCRIPTION")},e.hasPermissionToSplitCharges=function(){return h.getPermissionValue("SPLIT_CHARGES")},e.hasPermissionToEditCharges=function(){return h.getPermissionValue("EDIT_CHARGES")},e.hasPermissionToDeleteCharges=function(){return h.getPermissionValue("DELETE_CHARGES")},e.hasPermissionToMakePayment=function(){return h.getPermissionValue("MAKE_PAYMENT")},e.hasPermissionToMoveCharges=function(){return h.getPermissionValue("MOVE_CHARGES")},e.hasPermissionToDetokenizeCC=function(){return h.getPermissionValue("DETOKENIZE")},e.showSignaturePad=function(){return"checkinButton"===e.clickedButton&&0===e.currentActiveBill&&"CHECKIN"===e.reservationBillData.required_signature_at&&"false"===e.reservationBillData.signature_details.is_signed&&!e.reservation.reservation_card.is_pre_checkin||"checkoutButton"===e.clickedButton&&("CHECKING_OUT"===e.reservationBillData.reservation_status||"CHECKEDIN"===e.reservationBillData.reservation_status)&&"CHECKOUT"===e.reservationBillData.required_signature_at&&e.currentActiveBill+1===e.reservationBillData.bills.length},e.hasPermissionToPostRoomCharge=function(){return h.getPermissionValue("ENABLE_DISABLE_POST_CHARGES")},e.showMoveChargeDropDown=function(){return t.isStandAlone&&e.hasPermissionToMoveCharges()},e.shouldShowEnableDisableChargeButton=function(){return!t.isStandAlone&&"checkinButton"===e.clickedButton&&!e.reservationBillData.is_res_posting_control_disabled},e.showEditChargeButton=function(e){return t.isStandAlone&&"TAX"!==e&&x(e)},e.calculateHeightAndRefreshScroll=function(){d(function(){e.refreshScroller("registration-content")},500)},e.showPayButton=e.hasPermissionToMakePayment()&&t.isStandAlone,e.getWidthForBillTabsScroll=function(){var t=0;return e.routingArrayCount>0&&(t+=200),e.incomingRoutingArrayCount>0&&(t+=275),"checkinButton"===e.clickedButton&&(t+=230),t=168*e.reservationBillData.bills.length+t+160},e.reviewStatusArray=[],e.caculateExpenseAmountForPackageAddon=function(e,t){var a=0;return angular.forEach(e,function(e){e.is_inclusive===!0&&a++}),a===e.length?"INCL":a>0&&a<e.length?"MULTI":t};var F=function(e){var t=r.bills[e];t.isOpenFeesDetails=0===e,t.hasFeesArray=!0,t.total_fees.length>0&&(t.hasFeesArray=!1,angular.forEach(t.total_fees[0].fees_details,function(e,a){e.billValue=t.bill_number,e.oldBillValue=t.bill_number}))};e.setNoPostStatus=function(){e.reservationBillData.roomChargeEnabled="",e.reservationBillData.restrict_post?e.reservationBillData.roomChargeEnabled=!1:e.reservationBillData.roomChargeEnabled=!0},e.getNoPostButtonTiltle=function(){return e.reservationBillData.roomChargeEnabled?l("translate")("NO_POST_ENABLED"):l("translate")("NO_POST_DISABLED")};var U=!1;e.noPostButtonClicked=function(){return e.hasPermissionToPostRoomCharge()?void(U||(U=!0,setTimeout(function(){U=!1},200),e.reservationBillData.roomChargeEnabled=!e.reservationBillData.roomChargeEnabled)):(e.errorMessage=["You have no permission to enable or disbable this button!"],!1)},e.$on("REFRESH_BILLCARD_VIEW",function(){setTimeout(function(){e.isRefreshOnBackToStaycard=!0,e.getBillData(e.currentActiveBill),e.$apply()},1e3)}),e.refreshBillView=function(){e.init(e.lastResBillData)},e.openPleaseSwipe=function(){o.open({template:"/assets/partials/payment/rvInitialPleaseSwipeModal.html",controller:"RVPleaseSwipeCtrl",className:"",scope:e,closeByDocument:!1})},e.setNightsString=function(){return r.number_of_nights>1?l("translate")("NIGHTS"):l("translate")("NIGHT")},e.showActiveBill=function(t){var a="",i=e.reservationBillData.bills[t],n=e.reservationBillData.bills.length,r=i.is_transactions_exist;return 0===t||t!==e.currentActiveBill||n!==t+1||r?t===e.currentActiveBill&&(a="ui-tabs-active ui-state-active"):a="ui-tabs-active ui-state-active with-button",a},e.showDayRates=function(t,a,i,n){a===i?0===n?e.dayRates=t:e.dayRates=e.dayRates:e.dayRates!==t?e.dayRates=t:e.dayRates=-1,e.showAddonIndex=-1,e.showGroupItemIndex=-1,e.calculateHeightAndRefreshScroll()},e.getBillData=function(t){var a=function(a){e.reservationBillData.bills[t]=a,F(t),e.setActiveBill(t),e.setupReviewStatusArray(),N&&e.moveToNextBillAfterSuccessPaymentDuringCheckout(),L&&b.callGenerateFolioNumberApi(),e.refreshScroller("bill-tab-scroller")},i={params:r.bills[t].bill_id,successCallBack:a};e.callAPI(n.fetchBillData,i)},e.setBillAddressType=function(){e.reservationBillData.bills[0].bill_address_type="COMPANY"===e.reservationBillData.bills[0].bill_address_type?"GUEST":"COMPANY",d(function(){var t={params:{parmasToApi:{bill_address_type:e.reservationBillData.bills[0].bill_address_type},bill_id:e.reservationBillData.bills[e.currentActiveBill].bill_id}};e.callAPI(n.setBillAddressType,t)},800)},e.setActiveBill=function(t){e.currentActiveBill=t,e.showActiveBillFeesDetails=t,e.calculateHeightAndRefreshScroll(),O(!1),e.selectedAllowanceReference=""},e.showAddons=function(t){e.showAddonIndex=e.showAddonIndex!==t?t:-1,e.dayRates=-1,e.showGroupItemIndex=-1,e.calculateHeightAndRefreshScroll(),e.selectedAllowanceReference=""},e.showGroupItems=function(t){e.dayRates=-1,e.showGroupItemIndex=e.showGroupItemIndex!==t?t:-1,e.showAddonIndex=-1,e.calculateHeightAndRefreshScroll(),e.selectedAllowanceReference=""},e.showRoomDetails=function(t){e.selectedAllowanceReference="",e.showRoomDetailsIndex===t?e.showRoomDetailsIndex=-1:e.showRoomDetailsIndex=t,e.calculateHeightAndRefreshScroll()},e.showAllowanceDetails=function(t){return e.dayRates=-1,e.showGroupItemIndex=-1,e.showRoomDetailsIndex=-1,e.showAddonIndex=-1,e.selectedAllowanceReference===t?void(e.selectedAllowanceReference=""):void(e.selectedAllowanceReference=t)},e.getBalanceClass=function(e){var t="";return t=0===e||"0.00"===e||"0.0"===e?"green":"red"},e.showNotDefined=function(e){var t=!0;"CC"!==e&&"CC"!==e&&"CC"!==e&&"CC"!==e||(t=!1)},e.toggleFeesDetails=function(t){var a=0;"undefined"!=typeof e.reservationBillData.bills[e.currentActiveBill].total_fees[0]&&(a=e.reservationBillData.bills[e.currentActiveBill].total_fees[0].fees_details.length,a>0&&(e.reservationBillData.bills[t].isOpenFeesDetails=!e.reservationBillData.bills[t].isOpenFeesDetails,e.calculateHeightAndRefreshScroll()))},b.callGenerateFolioNumberApi=function(t){L=!1;var a=t?t:e.currentActiveBill,i=e.reservationBillData.bills[a];b.generateFolioNumber(i.bill_id,i.total_fees[0].balance_amount,i.is_folio_number_exists,a),t&&(L=!0,e.getBillData(e.currentActiveBill))},e.fetchSuccessCallback=function(t){e.$emit("hideLoader"),r=t,e.init(t),e.calculateBillDaysWidth()},e.moveToBillActionfetchSuccessCallback=function(t){e.fetchSuccessCallback(t)},e.moveToBillAction=function(t,a){var i=parseInt(t)-1,r=e.reservationBillData.bills[i].total_fees[0].fees_details,s=r[a].billValue,o=r[a].transaction_id,l=r[a].id?r[a].id:null,c=r[a].item_ids?r[a].item_ids:[],d=(r[a].is_group_by_ref,{reservation_id:e.reservationBillData.reservation_id,to_bill:s,from_bill:t,transaction_id:o,id:l,item_ids:c}),u=function(t){e.$emit("hideLoader"),e.movedIndex=parseInt(s)-1,parseInt(t.data[0].to_bill_number)===parseInt(s)&&(e.reservationBillData.bills[parseInt(t.data[0].to_bill_number)-1]={bill_id:t.data[0].to_bill_id,bill_number:t.data[0].to_bill_number,total_amount:t.data[0].bill_amount,routed_entity_type:t.data[0].routed_entity_type,guest_image:t.data[0].guest_image});e.reservationBillData.reservation_status;e.getBillData(e.currentActiveBill)},_=function(t){e.$emit("hideLoader"),e.errorMessage=t};e.invokeApi(n.movetToAnotherBill,d,u,_)},t.allowPmtWithGiftCard=!1,e.cardsListSuccess=function(a){e.fetchPmtList=!0,e.allowPmtWithGiftCard=!1,t.allowPmtWithGiftCard=!1,e.$emit("hideLoader");for(var i in a)"GIFT_CARD"===a[i].name&&(e.allowPmtWithGiftCard=!0,t.allowPmtWithGiftCard=!0)},e.fetchPmtList=!1,e.showFeesDetailsOpenClose=function(a){t.isStandAlone||e.fetchPmtList||(e.fetchPmtList=!0,e.invokeApi(g.fetchAvailPayments,{},e.cardsListSuccess));var i=0,n=" ";return"undefined"!=typeof e.reservationBillData.bills[e.currentActiveBill].total_fees[0]&&(i=e.reservationBillData.bills[e.currentActiveBill].total_fees[0].fees_details.length),a&&0===i?n=" ":a&&i>0?n="has-arrow active":!a&&i>0&&(n="has-arrow"),n},e.showFeesDetailsClass=function(e){var t="hidden";return e&&(t=""),t},e.showGuestBalance=function(e){var t=!1;return"CHECKING_IN"!==e&&"NOSHOW_CURRENT"!==e||(t=!0),t},e.hasPermissionToDirectBillPayment=function(){return h.getPermissionValue("DIRECT_BILL_PAYMENT")},e.checkPaymentTypeIsDirectBill=function(){var t=!1,a=e.reservationBillData.bills[e.currentActiveBill];return a.is_account_attached&&"DB"===a.credit_card_details.payment_type&&e.hasPermissionToDirectBillPayment()&&(t=!0),t};var V=function(a,i){e.callAPI(g.renderPaymentScreen,{params:{direct_bill:e.checkPaymentTypeIsDirectBill()},onSuccess:function(n){i.paymentTypes=n,o.close(t.LastngDialogId,""),e.openPaymentDialogModal(a,i)}})};e.addNewPaymentModal=function(a){var i=parseInt(e.currentActiveBill)+parseInt(1),n={reservationId:e.reservationBillData.reservation_id,fromView:e.fromViewToPaymentPopup,fromBill:i,is_swiped:!1,details:{firstName:e.guestCardData.contactInfo.first_name,lastName:e.guestCardData.contactInfo.last_name}},r=e.reservationBillData;if("checkinButton"===e.clickedButton&&(e.paymentModalSwipeHappened||void 0===a||(e.isSwipeHappenedDuringCheckin=!0,k=a,e.putInQueue||(n.details.isClickedCheckin=!0))),void 0===a)n.showDoNotAuthorize="checkinButton"===e.clickedButton&&t.isStandAlone,e.setScroller("cardsList"),e.addmode=!1,n.details.hideDirectBill=!0,V(n,r);else{var s=new SwipeOperation,o=s.createSWipedDataToRender(a);n.details.swipedDataToRenderInScreen=o,"payButton"!==o.swipeFrom&&"billingInfo"!==o.swipeFrom?V(n,r):"payButton"===o.swipeFrom?e.$broadcast("SHOW_SWIPED_DATA_ON_PAY_SCREEN",o):"billingInfo"===o.swipeFrom&&e.$broadcast("SHOW_SWIPED_DATA_ON_BILLING_SCREEN",o)}},e.$on("$viewContentLoaded",function(){setTimeout(function(){e.refreshScroller("registration-content"),e.refreshScroller("billDays"),e.refreshScroller("bill-tab-scroller")},3e3)}),e.addListener("STAY_ON_BILL",function(){e.isMessagePopupDuringCheckout=!1,e.reservationBillData.reservation_status="CHECKEDOUT",e.getBillData(e.currentActiveBill)}),e.$on("SWIPE_ACTION",function(t,a){if(!e.isGuestCardVisible){e.paymentModalOpened?a.swipeFrom="payButton":e.billingInfoModalOpened?a.swipeFrom="billingInfo":a.swipeFrom="viewBill";var i=new SwipeOperation,n=i.createDataToTokenize(a),r=function(t){e.$emit("hideLoader"),a.token=t,e.addNewPaymentModal(a),e.swippedCard=!0};e.invokeApi(s.tokenize,n,r)}}),e.clickedPayButton=function(t){if(!e.isArAccountNeeded(e.currentActiveBill)){e.paymentModalOpened=!0,e.removeDirectPayment=!0,t?e.isViaReviewProcess=!0:e.isViaReviewProcess=!1;var a={reservation_id:e.reservationData.reservationId,is_checkout:e.reservationBillData.isCheckout},i=e.reservationBillData.isCheckout?a:{};i.direct_bill=e.checkPaymentTypeIsDirectBill(),i.bill_id=e.reservationBillData.bills[e.currentActiveBill].bill_id,e.invokeApi(g.renderPaymentScreen,i,function(t){e.paymentTypes=t,o.open({template:"/assets/partials/payment/rvReservationBillPaymentPopup.html",className:"",controller:"RVBillPayCtrl",closeByDocument:!1,scope:e})})}},e.clickedAddUpdateCCButton=function(){e.fromViewToPaymentPopup="billcard",e.isRefreshOnBackToStaycard=!0,e.addNewPaymentModal()},e.$on("OPENPAYMENTMODEL",function(){e.clickedAddUpdateCCButton()}),e.showSignature=function(){e.showSignedSignature=!e.showSignedSignature,e.calculateHeightAndRefreshScroll()};var H=function(t){e.dataToPaymentList=t,e.dataToPaymentList.isFromBillCard=!0,o.open({template:"/assets/partials/payment/rvShowPaymentList.html",controller:"RVShowPaymentListCtrl",className:"",scope:e})};e.openDetokenizationPopup=function(){var t=localStorage.getItem("jwt")||"";e.detokenizeUrl=I[e.hotelDetails.payment_gateway].iFrameUrl+"?reservation_id="+e.reservationBillData.reservation_id+"&token="+e.reservationBillData.bills[e.currentActiveBill].credit_card_details.token+"&auth_token="+t+"&hotel_uuid="+D.getProperty(),o.open({template:"/assets/partials/payment/rvDetokenizeCC.html",className:"",scope:e}),e.startActivity("iframe"),d(function(){e.stopActivity("iframe")},8e3)},e.showPaymentList=function(){e.reservationBillData.currentView="billCard",e.reservationBillData.currentActiveBill=e.currentActiveBill,H(e.reservationBillData)},e.$on("paymentChangedToCC",function(){e.reservationBillData.restrict_post=!1,e.reservationBillData.roomChargeEnabled=!0}),e.clickedAddCharge=function(t){e.reservationBillData.restrict_post?(e.selectedBillNumber=t,e.restrict_post=e.reservationBillData.restrict_post,o.open({template:"/assets/partials/postCharge/restrictPost.html",className:"",scope:e})):e.openPostCharge(t)},e.openPostCharge=function(t){e.callAPI(n.fetchAdjustmentReasons,{successCallBack:function(t){e.adjustmentReasonOptions=t.force_adjustment_reasons,e.showAdjustmentReason=t.force_adjustment_reason_enabled}}),e.$emit("showLoader"),y.fetchAssets(["postcharge","directives"]).then(function(){e.$emit("hideLoader"),e.reservation_id=e.reservationBillData.reservation_id,e.billNumber=t,e.fetchTotalBal=!1;for(var a=[],i=0;i<e.reservationBillData.bills.length;i++)a.push(i+1);e.fetchedData={},e.fetchedData.bill_numbers=a,e.isOutsidePostCharge=!1,e.shouldShowChargesForMobile=!1,o.open({template:"/assets/partials/postCharge/rvPostChargeV2.html",className:"",scope:e})})},e.$on("paymentTypeUpdated",function(){e.getBillData(e.currentActiveBill)}),e.$on("cc_auth_updated",function(t,a){e.do_not_cc_auth=a});var W=function(t){e.message=t.message,d(function(){o.open({template:"/assets/partials/bill/rvShowMessagePopup.html",className:"",closeByDocument:!1,scope:e})},1e3)},Y=e.$on("postcharge.added",function(t,a){e.refreshScroller("bill-tab-scroller"),e.isRefreshOnBackToStaycard=!0,a.message&&W(a);e.reservationBillData.reservation_status;e.getBillData(e.currentActiveBill)}),j=e.$on("SHOW_TAX_EXEMPT_ALERT_MESSAGE",function(e,t){t.tax_exempt_warning&&W()});e.$on("routingPopupDismissed",function(t){e.isRefreshOnBackToStaycard=!0,e.getBillData(e.currentActiveBill)}),e.goBackToStayCard=function(){var t=e.reservationBillData.reservation_id,i=e.reservationBillData.confirm_no;e.isRefreshOnBackToStaycard?a.go("rover.reservation.staycard.reservationcard.reservationdetails",{id:t,confirmationId:i,isrefresh:!0}):a.go("rover.reservation.staycard.reservationcard.reservationdetails",{id:t,confirmationId:i})},e.$on("$destroy",Y),e.$on("$destroy",j),e.closeDialog=function(){o.close()},e.getRoomClass=function(e,t,a,i,n){var r="";if("CHECKING_IN"===e&&""!==i)if("VACANT"===a)switch(i){case"INSPECTED":r=" room-green";break;case"CLEAN":if("true"===n){r=" room-orange";break}r=" room-green";break;case"PICKUP":r=" room-orange";break;case"DIRTY":r=" room-red"}else r="room-red";return r},e.showDays=function(e,t,a,i){var n=!1;return"checkout"===i?e===t&&0!==a&&(n=!0):e===t&&0===a?n=!0:e!==t&&(n=!0),n},e.getDaysClass=function(t,a,i,n,s){var o="";return 0!==t&&(o="hidden"),a===i&&(o="check-in active"),a!==n&&a<=s&&(o="active"),a===n&&a!==i&&r.bills[e.currentActiveBill]&&(o=void 0!==r.bills[e.currentActiveBill].addons&&r.bills[e.currentActiveBill].addons.length>0?"check-out last":"check-out"),o},e.caculateExpenseAmountForPackageAddon=function(e,t){var a=0;return angular.forEach(e,function(e){e.is_inclusive===!0&&a++}),a===e.length?"INCL":a>0&&a<e.length?"MULTI":t},e.showBillingInfoHandle=function(){e.showBillingInfo=!e.showBillingInfo,e.calculateHeightAndRefreshScroll()},e.showIncomingBillingInfoHandle=function(){e.showIncomingBillingInfo=!e.showIncomingBillingInfo,e.calculateHeightAndRefreshScroll()},e.enableScroll=function(){e.$parent.myScroll["registration-content"].enable()},e.disableScroll=function(){e.$parent.myScroll["registration-content"].disable(),angular.element($("#signature canvas")).hasClass("pad")||angular.element($("#signature canvas")).addClass("pad")},e.clickedClearSignature=function(){$("#signature").jSignature("clear")},e.continueWithoutCC=function(){e.reservationBillData.is_cc_authorize_at_checkin_enabled=!1,e.clickedCompleteCheckin(!0),e.closeDialog()},e.continueAfterSuccessAuth=function(){e.triggerKeyCreationProcess(),e.closeDialog()},e.completeCheckinSuccessCallback=function(t){e.$emit("hideLoader"),e.reservationBillData.room_pin=t.room_pin,e.triggerKeyCreationProcess()},e.completeCheckinAuthSuccessCallback=function(t){e.$emit("hideLoader"),"Success"===t.check_in_status?(e.isInProgressScreen=!1,e.isSuccessScreen=!0,e.isFailureScreen=!1,e.cc_auth_amount=t.cc_auth_amount,e.cc_auth_code=t.cc_auth_code,e.reservationBillData.bills[e.currentActiveBill].credit_card_details.auth_color_code="green"):(e.isInProgressScreen=!1,e.isSuccessScreen=!1,e.isFailureScreen=!0,e.cc_auth_amount=t.cc_auth_amount,e.reservationBillData.bills[e.currentActiveBill].credit_card_details.auth_color_code="red")},e.triggerKeyCreationProcess=function(){var a=e.reservationBillData.key_settings;if(e.viewFromBillScreen=!0,e.fromView="checkin","no_key_delivery"!==a&&"pin"!==a)if("email"===a)o.open({template:"/assets/partials/keys/rvKeyEmailPopup.html",controller:"RVKeyEmailPopupController",className:"",closeByDocument:!1,scope:e});else if("qr_code_tablet"===a){var i=e.reservationBillData.reservation_id,n=function(t){e.$emit("hideLoader"),e.data=t,o.open({template:"/assets/partials/keys/rvKeyQrcodePopup.html",controller:"RVKeyQRCodePopupController",className:"",scope:e})};e.invokeApi(p.fetchKeyQRCodeData,{reservationId:i},n)}else"encode"!==a&&"mobile_key_encode"!==a||(e.reservationData&&e.reservationData.status&&"CHECKING_IN"===e.reservationData.status&&(e.keyType="New",t.$broadcast("MAKE_KEY_TYPE",{type:"New"})),e.reservationBillData.is_remote_encoder_enabled&&void 0!==e.encoderTypes&&e.encoderTypes.length<=0?Q():K());else e.isRefreshOnBackToStaycard=!0,e.goBackToStayCard()};var K=function(){e.isSmartbandCreateWithKeyWrite=M(),o.open({template:"/assets/partials/keys/rvKeyEncodePopup.html",controller:"RVKeyEncodePopupCtrl",className:"",closeByDocument:!1,scope:e})},Q=function(){var t=function(t){e.$emit("hideLoader"),e.encoderTypes=t,K()};e.invokeApi(p.fetchActiveEncoders,{},t)};e.completeCheckinFailureCallback=function(t){e.$emit("hideLoader"),e.errorMessage=t,e.closeDialog()},e.goToStayCardFromAddToQueue=function(){e.isRefreshOnBackToStaycard=!0,e.goBackToStayCard()},e.checkGuestInFromQueue=!1,t.reservationBillWatch||(t.reservationBillWatch=1,t.$on("goToStayCardFromAddToQueue",function(){e.goToStayCardFromAddToQueue()}),t.$on("checkGuestInFromQueue",function(){e.checkGuestInFromQueue=!0;var t="isSigned";e.initCompleteCheckin(!1,t)})),e.hasAnySharerCheckedin=function(){var t=!1;return angular.forEach(e.reservationBillData.sharer_information,function(e,a){if("CHECKEDIN"===e.reservation_status||"CHECKING_OUT"===e.reservation_status)return t=!0,!1}),t},e.putInQueueAdvanced=function(t){var a=e.reservationBillData.reservation_id;e.reservationData.check_in_via_queue=!1;var i={reservationId:a,status:"true"};t&&"[]"!==t.signature&&(i.signature=t.signature),void 0!==t.is_promotions_and_email_set&&(i.is_promotions_and_email_set=t.is_promotions_and_email_set),i.viaAdvancedQueue=!0,e.invokeApi(s.modifyRoomQueueStatus,i,e.successPutInQueueCallBack,e.failPutInQueueCallBack)},e.successPutInQueueCallBack=function(){var a=t.advanced_queue_flow_enabled,i=e.reservationBillData.key_settings;e.$emit("hideLoader"),e.reservationData.reservation_card.is_reservation_queued="true",e.$emit("UPDATE_QUEUE_ROOMS_COUNT","add"),s.updateResrvationForConfirmationNumber(e.reservationData.reservation_card.reservation_id,e.reservationData),a&&"no_key_delivery"!==i?(setTimeout(function(){t.$broadcast("clickedIconKeyFromQueue")},1250),e.goToStayCardFromAddToQueue()):e.goToStayCardFromAddToQueue()},e.failPutInQueueCallBack=function(t){e.$emit("hideLoader"),e.errorMessage=t};var J=function(t,a,i){"false"===e.reservationBillData.is_disabled_terms_conditions_checkin&&(t.accepted_terms_and_conditions=e.saveData.termsAndConditions),a||e.putInQueue&&!e.checkGuestInFromQueue||i===!0?(t.authorize_credit_card=!1,e.putInQueue||i===!0?e.putInQueueAdvanced(t):e.invokeApi(n.completeCheckin,t,e.completeCheckinSuccessCallback,e.completeCheckinFailureCallback)):e.reservationBillData.is_cc_authorize_at_checkin_enabled&&"CC"===e.reservationBillData.bills[e.currentActiveBill].credit_card_details.payment_type?(e.isInProgressScreen=!0,e.isSuccessScreen=!1,e.isFailureScreen=!1,e.isCCAuthPermission=e.hasCCAuthPermission(),o.open({template:"/assets/partials/bill/ccAuthorization.html",className:"",closeByDocument:!1,scope:e}),t.authorize_credit_card=!0,e.invokeApi(n.completeCheckin,t,e.completeCheckinAuthSuccessCallback,e.completeCheckinFailureCallback)):(t.authorize_credit_card=!1,e.invokeApi(n.completeCheckin,t,e.completeCheckinSuccessCallback,e.completeCheckinFailureCallback))},z=function(){e.message_incoming_from_room=!1,e.message_out_going_to_room=!1,e.message_out_going_to_comp_tra=!1,e.enableIncedentalOnlyOption=!1,e.reservationBillData.routing_info.incoming_from_room?e.message_incoming_from_room=!0:e.reservationBillData.routing_info.out_going_to_room?e.message_out_going_to_room=!0:e.reservationBillData.routing_info.out_going_to_comp_tra&&(e.message_out_going_to_comp_tra=!0),e.reservationBillData.is_cc_authorize_for_incidentals_active&&(e.message_out_going_to_room||e.message_out_going_to_comp_tra)&&(e.enableIncedentalOnlyOption=!0)},q=function(t){e.clickedIncidentalsOnly=function(){t.is_cc_authorize_for_incidentals=!0,J(t,!1),o.close()},e.clickedFullAuth=function(){J(t,!1),o.close()},e.clickedManualAuth=function(){e.reservationBillData.is_cc_authorize_at_checkin_enabled=!1,J(t,!0),o.close()},z(),o.open({template:"/assets/partials/bill/ccAuthAndBillingInfoConfirm.html",className:"",closeByDocument:!1,scope:e})};e.getSignature=function(){var e=JSON.stringify($("#signature").jSignature("getData","native"));return e},e.getSignatureBase64Data=function(){var e=angular.element(document.querySelector("canvas.jSignature"))[0],t=e?e.toDataURL():"";return t},e.signatureNeeded=function(t){return"true"===e.reservationBillData.signature_details.is_signed?(t=e.reservationBillData.signature_details.signed_image,!1):"[]"===t&&"CHECKIN"===e.reservationBillData.required_signature_at},e.termsConditionsNeeded=function(){return!(e.saveData.termsAndConditions||"false"!==e.reservationBillData.is_disabled_terms_conditions_checkin&&""!==e.reservationBillData.is_disabled_terms_conditions_checkin&&null!==e.reservationBillData.is_disabled_terms_conditions_checkin)},e.validateEmailNeeded=function(){return!(!e.saveData.promotions||""!==e.guestCardData.contactInfo.email)},e.getCheckinSwipeData=function(t,a){var i="20"+k.RVCardReadExpDate.substring(0,2)+"-"+k.RVCardReadExpDate.slice(-2)+"-01",n={is_promotions_and_email_set:e.saveData.promotions,signature:t,reservation_id:e.reservationBillData.reservation_id,payment_type:"CC",mli_token:k.token,et2:k.RVCardReadTrack2,etb:k.RVCardReadETB,ksn:k.RVCardReadTrack2KSN,pan:k.RVCardReadMaskedPAN,card_name:k.RVCardReadCardName,name_on_card:k.RVCardReadCardName,card_expiry:i,credit_card:k.RVCardReadCardType,do_not_cc_auth:!0,restrict_post:""!==e.reservationBillData.roomChargeEnabled&&!e.reservationBillData.roomChargeEnabled,add_to_guest_card:a};return n.is_encrypted=!0,0!==k.RVCardReadIsEncrypted&&"0"!==k.RVCardReadIsEncrypted||(n.is_encrypted=!1,n.card_number=k.RVCardReadPAN),n.ksn=k.RVCardReadTrack2KSN,""!==k.RVCardReadETBKSN&&"undefined"!=typeof k.RVCardReadETBKSN&&(n.ksn=k.RVCardReadETBKSN),n},e.getCheckinNonSwipeData=function(t){var a={is_promotions_and_email_set:e.saveData.promotions,signature:t,reservation_id:e.reservationBillData.reservation_id,do_not_cc_auth:e.do_not_cc_auth,restrict_post:""!==e.reservationBillData.roomChargeEnabled&&!e.reservationBillData.roomChargeEnabled};return a},e.clickedCompleteCheckin=function(i,n){if(e.guestCardData&&e.guestCardData.contactInfo&&(e.guestCardData.contactInfo.is_opted_promotion_email=e.saveData.promotions),e.hasAnySharerCheckedin());else if(("NOTREADY"===e.reservationBillData.room_status||"OCCUPIED"===e.reservationBillData.fo_status)&&!t.queuedCheckIn){var r=e.reservationBillData.reservation_status,s=e.reservationBillData.is_upsell_available&&("RESERVED"===r||"CHECKING_IN"===r);return a.go("rover.reservation.staycard.roomassignment",{reservation_id:e.reservationBillData.reservation_id,room_type:e.reservationBillData.room_type,clickedButton:"checkinButton",upgrade_available:s,roomTypeId:e.reservation.reservation_card.room_type_id}),!1}var o="",l=e.getSignature();e.signatureNeeded(l)&&!e.reservation.reservation_card.is_pre_checkin?(o="Signature is missing",e.showErrorPopup(o)):e.termsConditionsNeeded()?(o="Please check agree to the Terms & Conditions",e.showErrorPopup(o)):("isSigned"!==l&&"[]"!==l&&(l=e.getSignatureBase64Data()),e.initCompleteCheckin(i,l))},e.clickedCompleteAddToQueue=function(t,a){e.hasAnySharerCheckedin();var i="",n=e.getSignature();if(e.signatureNeeded(n)&&!e.reservation.reservation_card.is_pre_checkin)i="Signature is missing",
e.showErrorPopup(i);else if(e.termsConditionsNeeded())i="Please check agree to the Terms & Conditions",e.showErrorPopup(i);else{var r=!0,s=e.getSignatureBase64Data();e.initCompleteCheckin(t,s,r)}},e.initCompleteCheckin=function(t,a,i){if(e.validateEmailNeeded())o.open({template:"/assets/partials/validateCheckin/rvAskEmailFromCheckin.html",controller:"RVValidateEmailPhoneCtrl",className:"",scope:e});else{var n=!1;void 0!==e.isAddToGuestCardEnabledDuringCheckin&&(n=e.isAddToGuestCardEnabledDuringCheckin);var r;r=e.isSwipeHappenedDuringCheckin?e.getCheckinSwipeData(a,n):e.checkGuestInFromQueue?e.getCheckinNonSwipeData(a):e.getCheckinNonSwipeData(a),e.putInQueue||z(),"isSigned"!==a&&"[]"!==a||delete r.signature,"undefined"!=typeof t&&t?J(r,!0,i):e.message_incoming_from_room||e.message_out_going_to_room||e.message_out_going_to_comp_tra?e.reservationBillData.is_cc_authorize_at_checkin_enabled&&"CC"===e.reservationBillData.bills[e.currentActiveBill].credit_card_details.payment_type?q(r):J(r,!0,i):J(r,!1,i)}},e.hasPermissionToShowCheckoutWithoutSettlement=function(){return h.getPermissionValue("ALLOW_CHECKOUT_WITHOUT_SETTLEMENT")},e.hasPermissionToAllowPostWithNoCredit=function(){return h.getPermissionValue("ALLOW_POST_WHEN_RESTRICTED")},e.toggleCheckoutWithoutSettlement=function(){e.isCheckoutWithoutSettlement=!e.isCheckoutWithoutSettlement},e.toggleOptedForEmail=function(){var t=e.emailOptedStatusList[e.currentActiveBill];t.isOptedForEmail=!t.isOptedForEmail},b.generateFolioNumber=function(t,a,i,r){if("0.00"===a&&!i){var s=function(t){e.reservationBillData.is_bill_lock_enabled&&(e.reservationBillData.bills[r].is_active=!1),e.reservationBillData.bills[r].is_folio_number_exists=!0},o={bill_id:t},l={params:o,successCallBack:s};e.callAPI(n.generateFolioNumber,l)}},e.completeCheckoutSuccessCallback=function(t){e.$emit("moveChargeSuccsess",{}),e.showSuccessPopup(t),d(function(){e.checkoutInProgress=!1},500)},e.completeCheckoutFailureCallback=function(t){f.stop("COMPLETE_CHECKOUT"),e.errorMessage=t,e.checkoutInProgress=!1},e.isArAccountNeeded=function(a){var i=!1;return e.reservationBillData.is_linked_to_group_account?i:("DB"===e.reservationBillData.bills[a].credit_card_details.payment_type&&null===e.reservationBillData.bills[a].ar_number&&t.isStandAlone&&(null===e.reservationBillData.bills[a].account_id||"undefined"==typeof e.reservationBillData.bills[a].account_id?e.showErrorPopup(l("translate")("ACCOUNT_ID_NIL_MESSAGE")):(e.account_id=e.reservationBillData.account_id,o.open({template:"/assets/partials/payment/rvAccountReceivableMessagePopup.html",controller:"RVAccountReceivableMessagePopupCtrl",className:"",scope:e})),i=!0),i)};var X=function(){var t=e.reservationBillData.bills[e.currentActiveBill],a=e.reservationBillData.bills.length,i=function(i){e.isViaReviewProcess&&a===e.currentActiveBill+1?(e.isLastBillSucceededWithBlackBoxAPI=!0,e.clickedCompleteCheckout()):e.isViaReviewProcess?(e.reviewStatusArray[e.currentActiveBill].reviewStatus=!0,e.reservationBillData.is_bill_lock_enabled&&(t.is_active=!1),e.findNextBillToReview()):e.reservationBillData.is_bill_lock_enabled&&(t.is_active=!1)},r=function(t){e.errorMessage=t},s={bill_id:t.bill_id},o={params:s,successCallBack:i,failureCallBack:r};e.callAPI(n.callBlackBoxApi,o)};e.checkoutInProgress=!1,e.isMessagePopupDuringCheckout=!1,e.clickedCompleteCheckout=function(){if(e.checkoutInProgress=!0,e.findNextBillToReview(),!e.isAllBillsReviewed)return void(e.checkoutInProgress=!1);var a=e.reservationBillData.bills[e.currentActiveBill].is_payment_exist,i=e.reservationBillData.bills[e.currentActiveBill].is_control_code_exist;if(P&&a&&!e.isLastBillSucceededWithBlackBoxAPI&&!e.isCheckoutWithoutSettlement&&!i)return e.isViaReviewProcess=!0,void X();var s=e.reservationBillData.bills.length-1,l=e.getSignatureBase64Data();if(e.isArAccountNeeded(s))return void(e.checkoutInProgress=!1);if(""===e.signatureData||"[]"===e.signatureData)var c=JSON.stringify($("#signature").jSignature("getData","native"));else var c=e.signatureData;for(var d="",u=0,_=[],p=0;p<r.bills.length;p++)u+=1*r.bills[p].total_amount,e.emailOptedStatusList[p].isOptedForEmail&&_.push(e.emailOptedStatusList[p].billId);var g="0.00",m=r.bills[e.currentActiveBill].credit_card_details.payment_type,h=r.bills[e.currentActiveBill].is_allow_direct_debit;"undefined"!=typeof e.reservationBillData.bills[e.currentActiveBill].total_fees[0]&&(g=e.reservationBillData.bills[e.currentActiveBill].total_fees[0].balance_amount);var y=t.isStandAlone&&"0.00"!==g&&"DB"===m&&!e.performCompleteCheckoutAction;if(e.isCheckoutWithoutSettlement){var v={reservation_id:e.reservationBillData.reservation_id,email:e.guestCardData.contactInfo.email,signature:l,allow_checkout_without_settlement:!0,opted_bills_for_email:_};f.start("COMPLETE_CHECKOUT"),e.invokeApi(n.completeCheckout,v,e.completeCheckoutSuccessCallback,e.completeCheckoutFailureCallback)}else if(y&&!h)e.checkoutInProgress=!1,Z();else if(y&&h&&P)e.checkoutInProgress=!1,e.reservationBillData.isCheckout=!0,e.clickedPayButton(!0);else if(t.isStandAlone&&"0.00"!==g&&"DB"!==m)e.reservationBillData.isCheckout=!0,e.clickedPayButton(!0),e.checkoutInProgress=!1;else if(e.guestCardData.contactInfo.email||e.saveData.isEmailPopupFlag)if("CHECKEDIN"!==e.reservationBillData.reservation_status||e.saveData.isEarlyDepartureFlag||e.reservationBillData.is_early_departure_penalty_disabled)if("[]"===c&&"CHECKOUT"===e.reservationBillData.required_signature_at)d="Signature is missing",e.showErrorPopup(d),e.checkoutInProgress=!1;else if(e.saveData.acceptCharges){e.isMessagePopupDuringCheckout=!0;var v={reservation_id:e.reservationBillData.reservation_id,email:e.guestCardData.contactInfo.email,signature:l,opted_bills_for_email:_};f.start("COMPLETE_CHECKOUT"),e.invokeApi(n.completeCheckout,v,e.completeCheckoutSuccessCallback,e.completeCheckoutFailureCallback)}else d="Please check the box to accept the charges",e.showErrorPopup(d),e.checkoutInProgress=!1;else e.callBackMethodCheckout=function(){e.clickedCompleteCheckout()},o.open({template:"/assets/partials/earlyCheckout/rvEarlyCheckout.html",controller:"RVEarlyCheckoutCtrl",className:"",closeByDocument:!1,scope:e});else e.callBackMethodCheckout=function(){e.saveData.isEmailPopupFlag=!0,e.clickedCompleteCheckout()},o.open({template:"/assets/partials/validateCheckout/rvValidateEmail.html",controller:"RVValidateEmailCtrl",className:"",closeByDocument:!1,scope:e})},e.hasPermissionToProceedCheckout=function(){return h.getPermissionValue("OVERWRITE_DEBIT_RESTRICTION")};var Z=function(){o.open({template:"/assets/partials/validateCheckout/rvDirectDebitDisabled.html",className:"",scope:e})};e.proceedWithCheckout=function(){e.closeDialog(),e.isAllBillsReviewed?(e.performCompleteCheckoutAction=!0,e.clickedCompleteCheckout()):(e.reviewStatusArray[e.currentActiveBill].reviewStatus=!0,e.findNextBillToReview())},e.clickedReviewButton=function(a){if(!e.isArAccountNeeded(a)){var i=e.reservationBillData.bills[e.currentActiveBill].total_fees[0].balance_amount,n=r.bills[e.currentActiveBill].credit_card_details.payment_type,s=e.reservationBillData.bills[e.currentActiveBill].is_payment_exist,o=e.reservationBillData.bills[e.currentActiveBill].is_control_code_exist;t.isStandAlone&&("0.00"===i||e.isCheckoutWithoutSettlement)?P&&s&&!e.isCheckoutWithoutSettlement&&!o?(e.isViaReviewProcess=!0,X()):(e.reviewStatusArray[a].reviewStatus=!0,e.getBillData(e.currentActiveBill+1),e.findNextBillToReview()):t.isStandAlone&&"0.00"!==i&&"DB"===n&&!r.bills[e.currentActiveBill].is_allow_direct_debit?Z():t.isStandAlone&&"0.00"!==i&&"DB"===n&&r.bills[e.currentActiveBill].is_allow_direct_debit?(e.reservationBillData.isCheckout=!0,e.clickedPayButton(!0)):"0.00"!==i&&"DB"!==n?(e.reservationBillData.isCheckout=!0,e.clickedPayButton(!0)):(e.reviewStatusArray[a].reviewStatus=!0,e.getBillData(e.currentActiveBill+1),e.findNextBillToReview())}},e.findNextBillToReview=function(){var t=0;d(function(){var t=e.reservationBillData.bills[e.currentActiveBill].bill_number,a=e.$parent.myScroll["bill-tab-scroller"];t>7&&a.scrollTo(-133*(t-6),a.maxScrollY)},100);for(var a=0;a<e.reviewStatusArray.length;a++){if("undefined"!=typeof e.reservationBillData.bills[a].total_fees[0]){var i=e.reservationBillData.bills[a].total_fees[0].balance_amount,n=e.reservationBillData.bills[a].credit_card_details.payment_type;"0.00"===i||"DB"===n||e.isCheckoutWithoutSettlement||(e.reviewStatusArray[a].reviewStatus=!1)}if(!e.reviewStatusArray[a].reviewStatus){e.reviewStatusArray.length===e.reservationBillData.bills.length&&(e.isAllBillsReviewed=!0),t=e.reviewStatusArray[a].billIndex;break}}},e.showErrorPopup=function(t){e.status="error",e.popupMessage=t,o.open({template:"/assets/partials/validateCheckin/rvShowValidation.html",controller:"RVShowValidationErrorCtrl",className:"",scope:e})},e.showSuccessPopup=function(t){e.status="success",e.popupMessage=t,e.checkoutStatus=e.status,e.callBackMethod=function(){if(e.saveData.isEarlyDepartureFlag===!0)var t={type:"INHOUSE",from_page:"DASHBOARD"};else var t={type:"DUEOUT",from_page:"DASHBOARD"};if(void 0===m.searchTypeStatus){var t={useCache:!0};e.reservationBillData.reservation_status="CHECKEDOUT",m.updateRoomDetails(e.reservationBillData.confirm_no,e.reservationBillData)}"1"===m.totalSearchResults?a.go("rover.dashboard"):a.go("rover.search",t)},f.stop("COMPLETE_CHECKOUT"),o.open({template:"/assets/partials/validateCheckin/rvShowValidation.html",controller:"RVShowValidationErrorCtrl",className:"",closeByDocument:!1,scope:e})},e.$on("BALANCECHANGED",function(t,a){var i={confirmationNumber:a.confirm_no,isRefresh:!1},n=function(t){e.$emit("hideLoader");var i,n,r=t;e.swippedCard&&(i=new SwipeOperation,n=i.createSWipedDataToRender(k),e.$broadcast("SWIPED_CARD_ADDED",i.createSWipedDataToSave(n))),r.reservation_card.balance_amount=a.balance,s.updateResrvationForConfirmationNumber(a.confirm_no,r)};e.invokeApi(s.fetchReservationDetails,i,n)}),e.HIDE_LOADER_FROM_POPUP=function(){e.$emit("hideLoader")},e.openAllowances=function(){e.$emit("showLoader"),y.fetchAssets(["rover.allowances","directives"]).then(function(){e.callAPI(n.fetchReservationAllowanceTransactions,{params:e.reservationBillData.reservation_id,successCallBack:function(t){e.reservationBillData.groupedAllowances=t,o.open({template:"/assets/partials/allowances/rvAllowances.html",controller:"rvAllowancesCtrl",controllerAs:"file",className:"",scope:e})},failureCallBack:function(){e.groupedAllowanceData=!1}})}).then(function(){e.$emit("hideLoader")})},e.openBillingInformation=function(){e.reservationData={},e.reservationData.confirm_no=e.reservationBillData.confirm_no,e.reservationData.reservation_id=e.reservationBillData.reservation_id,e.reservationData.reservation_status=e.reservationBillData.reservation_status,e.reservationData.user_id=i.userId,e.reservationData.is_opted_late_checkout=!1,e.billingInfoModalOpened=!0,e.$emit("showLoader"),y.fetchAssets(["addBillingInfo","directives"]).then(function(){e.$emit("hideLoader"),t.UPDATED_BI_ENABLED_ON.RESERVATION?o.open({template:"/assets/partials/billingInformation/reservation/rvBillingInfoReservationMain.html",controller:"rvBillingInfoReservationMainCtrl",className:"",scope:e}):o.open({template:"/assets/partials/bill/rvBillingInformationPopup.html",controller:"rvBillingInformationPopupCtrl",className:"",scope:e})})},e.showAdvancedBillDialog=function(t){e.clickedPayButton(t)},e.clickedAdvanceBill=function(){o.open({template:"/assets/partials/bill/rvAdvanceBillConfirmPopup.html",className:"",scope:e})},e.generateAdvanceBill=function(){f.start("GENERATE_ADVANCE_BILL");var t={};t.id=e.reservationBillData.reservation_id;var a=function(t){o.close(),f.stop("GENERATE_ADVANCE_BILL");var a=s.getResrvationForConfirmationNumber(e.reservationBillData.confirm_no);a.reservation_card.balance_amount=t.reservation_balance,s.updateResrvationForConfirmationNumber(e.reservationBillData.confirm_no,a),e.reservationBillData.is_advance_bill=!0,e.getBillData(e.currentActiveBill)},i=function(t){o.close(),f.stop("GENERATE_ADVANCE_BILL"),e.errorMessage=t};e.invokeApi(n.getAdvanceBill,t,a,i)},e.closeAdanceBillDialog=function(){o.close()},e.splitTypeisAmount=!0,e.chargeCodeActive=!1,e.selectedChargeCode={},e.availableChargeCodes=[],e.setchargeCodeActive=function(t){e.chargeCodeActive=t},e.openActionsPopup=function(t,a,i,n,r,s,l,c){e.errorMessage="",e.hideRemoveAndEdit="PAYMENT"===n,e.selectedTransaction={},e.selectedTransaction.id=t,e.selectedTransaction.desc=a,e.reference_text=s,e.show_ref_on_invoice=l,e.show_split_payment=c,i?e.selectedTransaction.amount=i:r&&(e.selectedTransaction.amount=r),o.open({template:"/assets/partials/bill/rvBillActionsPopup.html",className:"",scope:e})},e.openRemoveChargePopup=function(){o.open({template:"/assets/partials/bill/rvRemoveChargePopup.html",controller:"rvBillCardPopupCtrl",className:"",scope:e})},e.openSplitChargePopup=function(){o.open({template:"/assets/partials/bill/rvSplitChargePopup.html",controller:"rvBillCardPopupCtrl",className:"",scope:e})},e.openEditChargeDescPopup=function(){o.open({template:"/assets/partials/bill/rvEditChargePopup.html",controller:"rvBillCardPopupCtrl",className:"",scope:e})},e.openEditChargePopup=function(){e.selectedChargeCode={id:"",name:"",description:"",associcated_charge_groups:[]},o.open({template:"/assets/partials/bill/rvEditPostingPopup.html",className:"",controller:"rvBillCardPopupCtrl",scope:e}),e.setScroller("chargeCodesList")},e.callActionsPopupAction=function(t){o.close(),"custom_description"===t?e.openEditChargeDescPopup():"remove"===t?e.openRemoveChargePopup():"split"===t?e.openSplitChargePopup():"edit"===t&&(e.callAPI(n.fetchAdjustmentReasons,{successCallBack:function(t){e.adjustmentReasonOptions=t.force_adjustment_reasons,e.showAdjustmentReason=t.force_adjustment_reason_enabled}}),e.availableChargeCodes.length?e.openEditChargePopup():e.callAPI(n.fetchChargeCodes,{successCallBack:function(t){e.availableChargeCodes=t.results,e.openEditChargePopup()}}))};var ee=function(){o.open({template:"/assets/partials/popups/billFormat/rvInvoicePendingInfoPopup.html",className:"",scope:e})};e.clickedEmail=function(t){if(e.shouldGenerateFinalInvoice&&!e.billFormat.isInformationalInvoice)ae(t,!1);else{e.closeDialog();var a=function(t){e.$emit("hideLoader"),e.statusMsg=l("translate")("EMAIL_SENT_SUCCESSFULLY"),t.is_invoice_issued?(e.status="success",e.showEmailSentStatusPopup(),e.reloadCurrentActiveBill()):ee()},i=function(t){e.$emit("hideLoader"),e.statusMsg=l("translate")("EMAIL_SEND_FAILED"),e.status="alert",e.showEmailSentStatusPopup()};e.invokeApi(n.sendEmail,t,a,i)}},e.clickedPrint=function(t){e.closeDialog(),se(t),te()};var te=function(){e.$parent.myScroll["registration-content"].scrollTo(0,0,100)},ae=function(t,a){var i=function(){e.shouldGenerateFinalInvoice=!1,e.getBillData(e.currentActiveBill),a?se(t):e.clickedEmail(t)},r={params:{bill_id:e.reservationBillData.bills[e.currentActiveBill].bill_id},successCallBack:i};e.callAPI(n.settleFinalInvoice,r)},ie=function(){$("head").append("<style id='print-orientation'>@page { size: portrait; }</style>")},ne=function(){$("#print-orientation").remove()},re=function(){$("header .logo").removeClass("logo-hide"),$("header .h2").addClass("text-hide"),ne(),e.printBillCardActive=!1,$("body #loading").html('<div id="loading-spinner" ></div>')},se=function(t){if(e.shouldGenerateFinalInvoice&&!e.billFormat.isInformationalInvoice)ae(t,!0);else{var a=function(e){var t="";return e.is_copy_counter&&(t=parseInt(e.print_counter)-parseInt(e.no_of_original_invoices)),t},i=function(t){var i="",n="",r=moment(t.print_ar_invoice_number_activated_at,"YYYY-MM-DD"),s=moment(t.ar_transaction_date,"YYYY-MM-DD"),o=s.diff(r,"days");e.shouldShowArInvoiceNumber=!0,o<0&&(e.shouldShowArInvoiceNumber=!1),e.isPrintRegistrationCard=!1,e.printBillCardActive=!0,e.$emit("hideLoader"),t.is_deposit_invoice?t.invoiceLabel=t.translation.deposit_invoice:e.billFormat.isInformationalInvoice?t.invoiceLabel=t.translation.information_invoice:null!==t.no_of_original_invoices||e.reservationBillData.bills[e.currentActiveBill].is_void_bill?e.reservationBillData.bills[e.currentActiveBill].is_void_bill?null===t.no_of_original_invoices||parseInt(t.print_counter)<=parseInt(t.no_of_original_invoices)?t.invoiceLabel=t.translation.void_invoice:parseInt(t.print_counter)>parseInt(t.no_of_original_invoices)&&(i=a(t),t.invoiceLabel=t.translation.copy_of_void_invoice.replace("#count",i)):parseInt(t.print_counter)<=parseInt(t.no_of_original_invoices)?t.invoiceLabel=t.guest_bill_invoice_label||t.translation.invoice:parseInt(t.print_counter)>parseInt(t.no_of_original_invoices)&&(i=a(t),n=t.guest_bill_invoice_copy_label||t.translation.copy_of_invoice,t.invoiceLabel=n.replace("#count",i)):t.invoiceLabel=t.guest_bill_invoice_label||t.translation.invoice,t.is_invoice_issued?(e.printData=t,e.errorMessage="",$("header .logo").addClass("logo-hide"),$("header .h2").addClass("text-hide"),$("body #loading").html(""),ie(),d(function(){c.print(),sntapp.cordovaLoaded&&cordova.exec(function(e){},function(e){},"RVCardPlugin","printWebView",[]),d(function(){re()},3e3)},700)):ee()},r=function(t){e.$emit("hideLoader"),e.errorMessage=t};e.invokeApi(n.fetchBillPrintData,t,i,r)}};e.printRegistrationCard=function(){o.close(),te();var a=function(a){if(e.isPrintRegistrationCard=!0,e.printRegistrationCardActive=!0,e.$emit("hideLoader"),e.printRegCardData=a,e.errorMessage="",e.printRegCardData.rowspanAustrianRegCardChild=a.guest_details.accompanying_children&&a.guest_details.accompanying_children.length>4?3:2,e.isRegistrationCardEnabledFor.austria){var i="";""!==a.guest_details.id_type&&null!==a.guest_details.id_type&&(i+=a.guest_details.id_type),""!==a.guest_details.id_number&&null!==a.guest_details.id_number&&(i=i+";"+a.guest_details.id_number),""!==a.guest_details.id_issue_date&&null!==a.guest_details.id_issue_date&&(i=i+";"+l("date")(new tzIndependentDate(a.guest_details.id_issue_date),t.dateFormat)),""!==a.guest_details.id_place_of_issue&&null!==a.guest_details.id_place_of_issue&&(i=i+";"+a.guest_details.id_place_of_issue),""!==a.guest_details.id_country_of_issue&&null!==a.guest_details.id_country_of_issue&&(i=i+";"+a.guest_details.id_country_of_issue),e.printRegCardData.documentDetails=i}if("true"===e.reservationBillData.signature_details.is_signed)e.printRegCardData.signature_url=e.reservationBillData.signature_details.signed_image;else{var n=angular.element(document.querySelector("canvas.jSignature"))[0],r=n?n.toDataURL():"";e.printRegCardData.signature_url=r}$("header .logo").addClass("logo-hide"),$("header .h2").addClass("text-hide"),ie(),d(function(){$("#loading").addClass("ng-hide"),c.print(),sntapp.cordovaLoaded&&cordova.exec(function(e){},function(e){},"RVCardPlugin","printWebView",[]),d(function(){e.printRegistrationCardActive=!1,$("header .logo").removeClass("logo-hide"),$("header .h2").addClass("text-hide"),ne()},1e3)},300)},i=function(t){e.isPrintRegistrationCard=!1,e.$emit("hideLoader"),e.errorMessage=t},r={reservation_id:e.reservationBillData.reservation_id,locale:e.regCardData.selectedLocale};e.invokeApi(n.fetchRegistrationCardPrintData,r,a,i)},e.openRegCardPopup=function(){e.regCardData={};var t=function(t){e.isPrintRegistrationCard=!1,e.$emit("hideLoader"),e.errorMessage=t},a=function(t){e.$emit("hideLoader"),e.languageData=t,e.regCardData.selectedLocale=t.selected_language_code,o.open({template:"/assets/partials/popups/billFormat/rvRegCardPopup.html",className:"",scope:e})},i={params:{reservation_id:e.reservationBillData.reservation_id},successCallBack:a,failureCallBack:t};e.callAPI(n.fetchGuestLanguages,i)},e.moveToNextBillAfterSuccessPaymentDuringCheckout=function(){N=!1,e.reservationBillData=r,e.calculateBillDaysWidth();var t=e.reservationBillData.bills.length,a=e.reservationBillData.reservation_status;e.reservationBillData.is_bill_lock_enabled||b.callGenerateFolioNumberApi(),0!==e.reservationBillData.bills[e.currentActiveBill].total_fees[0].balance_amount&&"0.00"!==e.reservationBillData.bills[e.currentActiveBill].total_fees[0].balance_amount||!e.isViaReviewProcess?"CHECKEDOUT"!==a||0!==e.reservationBillData.bills[e.currentActiveBill].total_fees[0].balance_amount&&"0.00"!==e.reservationBillData.bills[e.currentActiveBill].total_fees[0].balance_amount||!P||(e.isViaReviewProcess=!1,X()):t===e.currentActiveBill+1?e.clickedCompleteCheckout():e.clickedReviewButton(parseInt(e.reservationBillData.bills[e.currentActiveBill].bill_number)-1)},e.$on("AUTO_TRIGGER_EMAIL_AFTER_PAYMENT",function(t,a){"DB"===e.reservationBillData.bills[e.currentActiveBill].credit_card_details.payment_type?"undefined"!=typeof e.contactInformation&&(e.contactInformation.address_details.email_address=a):e.guestCardData.contactInfo.email=a,e.sendAutomaticEmails(a)}),e.$on("BILL_PAYMENT_SUCCESS",function(a,i){e.signatureData=JSON.stringify($("#signature").jSignature("getData","native")),e.isRefreshOnBackToStaycard=!0,e.isViaReviewProcess&&(N=!0);e.reservationBillData.reservation_status;e.reservationBillData.is_bill_lock_enabled&&"DB"!==i.selectedPaymentType||(L=!0),e.getBillData(e.currentActiveBill),e.$broadcast("FETCH_REMAINING_AUTH"),e.currentPaymentBillId=i.bill_id,e.currentPaymentTransactionId=i.transaction_id,e.isDepositPayment=i.is_deposit_payment,(t.autoEmailPayReceipt||t.autoEmailDepositInvoice&&e.isDepositPayment)&&e.autoTriggerPaymentReceiptActions()}),e.$on("HANDLE_MODAL_OPENED",function(t){e.paymentModalOpened=!1,e.billingInfoModalOpened=!1});var oe=function(t){e.$emit("hideLoader"),e.refreshScroller("bill-tab-scroller");for(var a=!1,i=0;i<t.bill_number-1;i++)e.reservationBillData.bills[i]||(a=!0);if(a){var r=function(t){e.reservationBillData.bills=t.bills},s={params:e.reservationBillData.reservation_id,successCallBack:r};e.callAPI(n.fetch,s)}else{e.reservationBillData.bills[t.bill_number-1]={bill_id:t.id,bill_number:t.bill_number,total_amount:0,routed_entity_type:null,guest_image:e.reservationBillData.bills[0].guest_image};var t={};t.reviewStatus=!1,t.billNumber=(e.reservationBillData.bills.length+1).toString(),t.billIndex=e.reservationBillData.bills.length,e.isAllBillsReviewed=!1,e.reviewStatusArray.push(t);var o={billId:t.id,isOptedForEmail:!1};e.emailOptedStatusList.push(o)}};e.createNewBill=function(t){e.movedIndex=e.reservationBillData.bills.length;var a={reservation_id:e.reservationBillData.reservation_id};e.invokeApi(n.createAnotherBill,a,oe)},e.addListener("VOID_BILL_GENERATED",function(t,a){e.closeDialog(),angular.forEach(a,function(e,t){oe(e)}),e.getBillData(e.currentActiveBill)}),e.termsAndConditionsClicked=function(){e.termsAndConditionsText=u.trustAsHtml(t.termsAndConditionsText),o.open({template:"/assets/partials/validateCheckin/rvTermsAndConditionsDialog.html",className:"",controller:"RVTermsAndConditionsDialogCtrl",scope:e})},e.setScroller("billDays",T),e.refreshBillDaysScroller=function(){d(function(){e.refreshScroller("billDays")},4e3)},e.calculateBillDaysWidth=function(){angular.forEach(r.bills,function(e,t){var a=0;angular.forEach(e.days,function(e,t){a=parseInt(a)+parseInt(70)}),angular.forEach(e.addons,function(e,t){a=parseInt(a)+parseInt(70)}),angular.forEach(e.group_items,function(e,t){a=parseInt(a)+parseInt(70)}),e.billDaysWidth=a+parseInt(75)}),e.refreshBillDaysScroller()},e.setupReviewStatusArray=function(){e.reviewStatusArray=[],angular.forEach(r.bills,function(t,a){var i={};i.reviewStatus=!1,i.billNumber=t.bill_number,i.billIndex=a,e.reviewStatusArray.push(i)})},e.isSigned=function(){return"true"===e.reservationBillData.signature_details.is_signed},e.isChargeAccepted=function(){return e.reservationBillData.is_charges_accepted_from_mobile_web},e.calculateBillDaysWidth(),e.clickedReverseCheckoutButton=function(){var t=e.reservationBillData.reservation_id,i=e.reservationBillData.confirm_no,r=function(n){e.$emit("hideLoader"),"success"===n.status?a.go("rover.reservation.staycard.reservationcard.reservationdetails",{id:t,confirmationId:i,isrefresh:!0}):(e.reverseCheckoutDetails.data.is_reverse_checkout_failed=!0,e.reverseCheckoutDetails.data.errormessage=n.message,a.go("rover.reservation.staycard.reservationcard.reservationdetails",{id:t,confirmationId:i}))},s={reservation_id:e.reservationBillData.reservation_id};e.invokeApi(n.completeReverseCheckout,s,r)},e.$on("moveChargeSuccsess",function(t,a){a.message&&W(a);var i=(e.reservationBillData.reservation_status,a.toBill),r=function(t){angular.forEach(t.bills,function(t){parseInt(t.bill_id)===parseInt(i)&&(e.reservationBillData.bills[parseInt(t.bill_number)-1]={bill_id:t.bill_id,bill_number:t.bill_number,total_amount:t.total_amount,routed_entity_type:t.routed_entity_type,guest_image:t.guest_image})}),e.getBillData(e.currentActiveBill)},s={params:e.reservationBillData.reservation_id,successCallBack:r};e.callAPI(n.fetchReservationBillData,s)}),e.clickedShowRate=function(){var t=function(t){e.reservationBillData.hide_rates=!e.reservationBillData.hide_rates,e.$emit("hideLoader"),e.errorMessage=""},a=function(t){e.$emit("hideLoader"),e.errorMessage=t},i={reservation_id:e.reservationBillData.reservation_id,hide_rates:!e.reservationBillData.hide_rates};e.invokeApi(n.toggleHideRate,i,t,a)},e.$on("PAYMENT_MAP_ERROR",function(t,a){e.errorMessage=a}),e.$on("UPDATE_INFORMATIONAL_INVOICE",function(t,a){e.billFormat.isInformationalInvoice=a}),e.showFormatBillPopup=function(t){e.billNo=t,e.billFormat={},e.billFormat.isInformationalInvoice=!1,e.isSettledBill=e.reservationBillData.bills[e.currentActiveBill].is_active,e.isEmailedOnce=e.reservationBillData.bills[e.currentActiveBill].is_emailed_once,e.isPrintedOnce=e.reservationBillData.bills[e.currentActiveBill].is_printed_once,e.isFolioNumberExists=e.reservationBillData.bills[e.currentActiveBill].is_folio_number_exists,e.reservationBillData.bills[e.currentActiveBill].is_transactions_exist&&"0.00"===e.reservationBillData.bills[e.currentActiveBill].total_fees[0].balance_amount&&e.reservationBillData.is_bill_lock_enabled&&e.reservationBillData.bills[e.currentActiveBill].is_active&&("CHECKING_OUT"===e.reservationBillData.reservation_status||"CHECKEDIN"===e.reservationBillData.reservation_status||"CHECKEDOUT"===e.reservationBillData.reservation_status||"NOSHOW"===e.reservationBillData.reservation_status||"CANCELED"===e.reservationBillData.reservation_status)?(e.isInvoiceStepOneActive=!0,e.isInvoiceStepThreeActive=!1,e.shouldGenerateFinalInvoice=!0):(e.isInvoiceStepOneActive=!1,e.isInvoiceStepThreeActive=!0,e.shouldGenerateFinalInvoice=!1),e.isInvoiceStepTwoActive=!1,e.isInvoiceStepFourActive=!1,e.isInvoiceStepFiveActive=!1,o.open({template:"/assets/partials/popups/billFormat/rvBillFormatPopup.html",controller:"rvBillFormatPopupCtrl",className:"",scope:e})},e.getInvoiceButtonClass=function(){var t="blue";return!e.reservationBillData.bills[e.currentActiveBill].is_active&&e.reservationBillData.bills[e.currentActiveBill].is_folio_number_exists&&e.roverObj.noReprintReEmailInvoice&&e.reservationBillData.bills[e.currentActiveBill].is_printed_once&&e.reservationBillData.bills[e.currentActiveBill].is_emailed_once&&(t="grey"),t},e.isInvoiceButtonDisabled=function(){var t=!1;return!e.reservationBillData.bills[e.currentActiveBill].is_active&&e.reservationBillData.bills[e.currentActiveBill].is_folio_number_exists&&e.roverObj.noReprintReEmailInvoice&&e.reservationBillData.bills[e.currentActiveBill].is_printed_once&&e.reservationBillData.bills[e.currentActiveBill].is_emailed_once&&(t=!0),t},e.showEmailSentStatusPopup=function(t){o.open({template:"/assets/partials/popups/rvEmailSentStatusPopup.html",className:"",scope:e})},e.closeDialog=function(){o.close(),e.checkoutInProgress=!1},e.isBalanceShown=function(t,a){return!t||e.isSRViewRateBtnClicked},e.expandGroupedCharge=function(t){var a=function(a){t.light_speed_data=a,t.isExpanded=!0,e.$emit("hideLoader"),e.calculateHeightAndRefreshScroll()},i=function(t){e.errorMessage=t,e.emit("hideLoader")};if(t.isExpanded)t.isExpanded=!1,e.calculateHeightAndRefreshScroll();else{var r={reference_number:t.reference_number,bill_id:e.reservationBillData.bills[e.currentActiveBill].bill_id,date:t.date};e.invokeApi(n.groupChargeDetailsFetch,r,a,i)}},e.$emit("OBSERVE_FOR_SWIPE"),e.billHasCreditCard=function(){return"CC"===e.reservationBillData.bills[e.currentActiveBill].credit_card_details.payment_type},e.clickedRemoveBill=function(t){var a=function(){e.reviewStatusArray=e.reviewStatusArray.slice(0,-1),e.reservationBillData.bills.pop(),e.getBillData(t-1)},i=function(t){e.errorMessage=t},r={params:{bill_id:e.reservationBillData.bills[t].bill_id},successCallBack:a,failureCallBack:i};e.callAPI(n.hideBill,r)},e.reloadCurrentActiveBill=function(){e.getBillData(e.currentActiveBill)},e.shouldShowVoidBill=function(){var t=!1;return angular.forEach(e.reservationBillData.bills[e.currentActiveBill].total_fees[0].fees_details,function(e){"Direct Bill"===e.description[0].fees_desc&&(t=!0)}),!e.reservationBillData.bills[e.currentActiveBill].is_active&&"0.00"===e.reservationBillData.bills[e.currentActiveBill].total_fees[0].balance_amount&&"DB"!==e.reservationBillData.bills[e.currentActiveBill].credit_card_details.payment_type&&e.reservationBillData.is_void_bill_enabled&&!e.reservationBillData.bills[e.currentActiveBill].is_voided&&!e.reservationBillData.bills[e.currentActiveBill].is_void_bill&&!t},e.$on("CARD_REMOVED",function(){e.reservationBillData.bills[0].show_invoice_type_toggle=!1}),e.$on("COMPANY_ADDED",function(){e.reservationBillData.bills[0].show_invoice_type_toggle=!0}),e.clickedVoidBillButton=function(){o.open({template:"/assets/partials/bill/rvVoidBillPopup.html",controller:"RVVoidBillPopupCtrl",className:"",scope:e})};var le=function(){e.printReceiptActive=!1,$("header .logo").removeClass("logo-hide"),$("header .h2").removeClass("text-hide"),$("body #loading").html('<div id="loading-spinner" ></div>')};e.addListener("PRINT_RECEIPT",function(t,a){e.printReceiptActive=!0,e.receiptPrintData=a,e.errorMessage="",$("header .logo").addClass("logo-hide"),$("header .h2").addClass("text-hide"),$("body #loading").html(""),ie(),d(function(){sntapp.cordovaLoaded?cordova.exec(re,function(e){le()},"RVCardPlugin","printWebView",[]):(window.print(),le())},1e3)}),e.openReceiptDialog=function(t){var a=e.reservationBillData.bills[e.currentActiveBill].total_fees[0].fees_details;e.transactionId=a[t].id,e.billId=e.reservationBillData.bills[e.currentActiveBill].bill_id,e.entityType="Reservation",o.open({template:"/assets/partials/popups/rvReceiptPopup.html",controller:"RVReceiptPopupController",className:"",scope:e})},e.putInQueue=!1,e.init=function(a){e.lastResBillData=a,e.isStandAlone=t.isStandAlone;var i=!1;e.$parent&&e.$parent.reservation&&(i=e.$parent.reservation.check_in_via_queue),t.advanced_queue_flow_enabled&&i?e.putInQueue=!0:e.putInQueue=!1,t.advanced_queue_flow_enabled&&t.queuedCheckIn&&("CC"===e.reservationBillData.bills[e.currentActiveBill].credit_card_details.payment_type&&(B=!0),e.saveData.termsAndConditions=!0),F(0),e.setupReviewStatusArray(),t.isStandAlone||"checkinButton"!==e.clickedButton||B||(B=!0,d(function(){e.reservationBillData.is_disabled_cc_swipe||e.reservation.reservation_card.is_pre_checkin&&!e.hotelDetails.use_ows_opi_auth||e.openPleaseSwipe()},200)),e.reservationBillData=a,e.routingArrayCount=e.reservationBillData.routing_array.length,e.incomingRoutingArrayCount=e.reservationBillData.incoming_routing_array.length,e.setNoPostStatus(),e.calculateHeightAndRefreshScroll(),e.refreshScroller("bill-tab-scroller"),O(!1),e.emailOptedStatusList=[],_.each(e.reservationBillData.bills,function(t,a){var i={};i.billId=t.bill_id,i.isOptedForEmail=0===a&&e.reservationBillData.is_email_enabled_on_checkout,e.emailOptedStatusList.push(i)})};var ce=t.$on("CLICKED_VIEW_CHARGES",function(){e.shouldShowChargesForMobile=!0}),de=t.$on("BACK_TO_CHARGES_LIST",function(){e.shouldShowChargesForMobile=!1});e.$on("$destroy",ce),e.$on("$destroy",de),e.init(r);var ue=function(){e.isCompleteRegistration=!1,"checkinButton"!==e.clickedButton&&"checkoutButton"!==e.clickedButton&&"reverseCheckoutButton"!==e.clickedButton||(e.isCompleteRegistration=!0);
};ue()}]),sntRover.controller("rvBillCardPopupCtrl",["$scope","$rootScope","$filter","RVBillCardSrv","ngDialog","$timeout",function(e,t,a,i,n,r){BaseCtrl.call(this,e),e.newAmount="",e.warningMessage="",e.adjustmentData={};var s=function(){r(function(){e.reloadCurrentActiveBill()},700)},o=function(){n.close(),r(function(){e.HIDE_LOADER_FROM_POPUP&&e.HIDE_LOADER_FROM_POPUP()},1e3)},l=function(t){e.$emit("hideLoader"),e.errorMessage=t};e.removeCharge=function(t){var a={data:{reason:t,process:"delete"},id:e.selectedTransaction.id},n=function(e){o(),s(e)};e.invokeApi(i.transactionDelete,a,n,l)},e.showSpiltValues=function(){e.splitTypeisAmount?(e.displayFirstValue=e.selectedTransaction.amount-e.splitValue,e.displaySecondValue=e.splitValue):(e.displaySecondValue=parseFloat(e.selectedTransaction.amount*e.splitValue/100).toFixed(2),e.displayFirstValue=e.selectedTransaction.amount-e.displaySecondValue)},e.splitCharge=function(a,n){var r=n?t.currencySymbol:"%",c={id:e.selectedTransaction.id,data:{split_type:r,split_value:a}},d=function(e){o(),s(e)};e.invokeApi(i.transactionSplit,c,d,l)};var c=function(e){o(),s(e)};e.selectedAdjReason=function(){e.warningMessage=""},e.clearWarningMessage=function(){e.warningMessage=""},e.editCharge=function(){if(!e.adjustmentData.adjustmentReason&&e.showAdjustmentReason)return void(e.warningMessage="Please fill adjustment reason");var t={id:e.selectedTransaction.id,updatedData:{new_amount:e.newAmount||void 0,charge_code_id:e.selectedChargeCode.id,adjustment_reason:e.adjustmentData.adjustmentReason,reference_text:e.reference_text,show_ref_on_invoice:e.show_ref_on_invoice}};e.invokeApi(i.transactionEdit,t,c,l)},e.editChargeDescription=function(t){var a={postData:{custom_charge_description:t},id:e.selectedTransaction.id},n=function(e){o(),s(e)};e.invokeApi(i.transactionEditChargeDescription,a,n,l)},e.chargecodeData={},e.chargecodeData.chargeCodeSearchText="",e.selectedChargeCode={description:""};var d={click:!0,preventDefault:!1};e.setScroller("chargeCodesList",d),e.selectChargeCode=function(t){for(var a=0;a<e.availableChargeCodes.length;a++)e.availableChargeCodes[a].id===t&&(e.selectedChargeCode=e.availableChargeCodes[a]);e.showChargeCodes=!1,e.chargecodeData.chargeCodeSearchText=""};var u=function(){if(e.chargecodeData.chargeCodeSearchText.length<3){for(var t=0;t<e.availableChargeCodes.length;t++)e.availableChargeCodes[t].is_row_visible=!1;e.refreshScroller("chargeCodesList")}else{for(var a="",t=0;t<e.availableChargeCodes.length;t++)a=e.availableChargeCodes[t],e.escapeNull(a.name).toUpperCase().indexOf(e.chargecodeData.chargeCodeSearchText.toUpperCase())>=0||e.escapeNull(a.description).toUpperCase().indexOf(e.chargecodeData.chargeCodeSearchText.toUpperCase())>=0?e.availableChargeCodes[t].is_row_visible=!0:e.availableChargeCodes[t].is_row_visible=!1;e.refreshScroller("chargeCodesList")}};e.clearResults=function(){e.chargecodeData.chargeCodeSearchText=""},e.showAvailableChargeCodes=function(){e.clearResults(),u(),e.showChargeCodes=!e.showChargeCodes},e.chargeCodeEntered=function(){e.showChargeCodes=!1,u();var t=e.chargecodeData.chargeCodeSearchText;e.chargecodeData.chargeCodeSearchText=t.charAt(0).toUpperCase()+t.slice(1)},e.isShowChargeCodeList=function(){var t=!1,a=e.availableChargeCodes.length,i=e.chargecodeData.chargeCodeSearchText.length;if(e.showChargeCodes)t=!0;else if(i>2&&0!==a)for(var n=0;n<a;n++)if(e.availableChargeCodes[n].is_row_visible){t=!0;break}return t},e.shouldDisableEditChargeCode=function(){return e.newAmount.length>0},e.shouldDisableEditChargeAmount=function(){return e.selectedChargeCode.description.length>0},e.getEditChargeButtonText=function(){return e.chargeCodeActive?"CHANGE_CHARGE_CODE":"CHANGE_AMOUNT"}}]),sntRover.controller("rvBillingInformationPopupCtrl",["$scope","$rootScope","$filter","RVBillinginfoSrv","ngDialog","rvPermissionSrv",function(e,t,a,i,n,r){BaseCtrl.call(this,e),e.isInAddRoutesMode=!1,e.isInitialPage=!0,e.isEntitySelected=!1,e.selectedEntity={},e.results={},e.bills=[],e.isReloadNeeded=!1,e.routes=[],e.errorMessage="",e.isInitialPage=!0,e.selectedEntityChanged=!1,e.saveData={},e.saveData.payment_type="",e.saveData.payment_type_description="",e.saveData.newPaymentFormVisible=!1,e.shouldShowWaiting=!1,e.hasPermisionToDeleteGroupBillInfo=r.getPermissionValue("GROUPS"),e.$on("UPDATE_SHOULD_SHOW_WAITING",function(t,a){e.shouldShowWaiting=a}),e.closeDialog=function(){n.close(),e.$emit("routingPopupDismissed")},e.dimissLoaderAndDialog=function(){e.$emit("hideLoader"),e.closeDialog()},e.getHeaderButtonLabel=function(){return e.isInitialPage?a("translate")("ADD_ROUTES_LABEL"):a("translate")("ALL_ROUTES_LABEL")},e.setReloadOption=function(t){e.isReloadNeeded=t},e.headerButtonClicked=function(){e.isInAddRoutesMode=!0,e.isEntitySelected=!1,e.isInitialPage=!e.isInitialPage,"ALLOTMENT_DEFAULT_BILLING"!==e.billingEntity&&(s(),o()),e.isInitialPage&&e.isReloadNeeded&&(e.isReloadNeeded=!1,e.fetchRoutes()),e.isInitialPage&&l()},e.deSelectEntity=function(){e.isEntitySelected=!1},e.selectEntity=function(t,a){if("ALLOTMENT_DEFAULT_BILLING"!==e.billingEntity&&(e.routes&&e.routes[t]&&e.routes[t].from_date&&(e.arrivalDate=e.routes[t].from_date,e.departureDate=e.routes[t].to_date),o()),e.errorMessage="",e.isEntitySelected=!0,e.isInAddRoutesMode=!1,e.isInitialPage=!1,e.selectedEntityChanged=!0,"ATTACHED_ENTITY"===a||"ROUTES"===a)e.selectedEntity=e.routes[t],e.selectedEntity.is_new="ATTACHED_ENTITY"===a,"RESERVATION"!==e.selectedEntity.entity_type&&(e.selectedEntity.guest_id=null),"GROUP"===e.selectedEntity.entity_type||"HOUSE"===e.selectedEntity.entity_type||"ALLOTMENT"===e.selectedEntity.entity_type||(e.selectedEntity.images[0].guest_image=e.selectedEntity.images[0].image);else if("RESERVATIONS"===a){var i=e.results.reservations[t];e.selectedEntity={attached_charge_codes:[],attached_billing_groups:[],images:i.images,reservation_status:i.reservation_status,is_opted_late_checkout:i.is_opted_late_checkout,name:i.firstname+" "+i.lastname,entity_type:"RESERVATION",has_accompanying_guests:i.images.length>1,bill_no:"",is_new:!0,credit_card_details:{}},"ALLOTMENT_DEFAULT_BILLING"===e.billingEntity?e.selectedEntity=_.extend(e.selectedEntity,{id:e.allotmentId,allotment_id:e.allotmentId,charge_routes_recipient:{id:i.id,type:"RESERVATION"}}):e.selectedEntity=_.extend(e.selectedEntity,{id:i.id}),e.selectedEntity.split_charge_by_50=!1}else if("ACCOUNT"===a){var i=e.results.accounts[t];e.selectedEntity={id:i.id,name:i.account_name,bill_no:"",images:[{is_primary:!0,guest_image:i.company_logo}],attached_charge_codes:[],attached_billing_groups:[],is_new:!0,selected_payment:"",is_allow_direct_debit:i.is_allow_direct_debit,credit_card_details:{}},"ALLOTMENT_DEFAULT_BILLING"===e.billingEntity&&(e.selectedEntity=_.extend(e.selectedEntity,{id:e.allotmentId,allotment_id:e.allotmentId,charge_routes_recipient:{id:i.id,type:"ACCOUNT"}})),"COMPANY"===i.account_type?(e.selectedEntity.entity_type="COMPANY_CARD",e.selectedEntity.account_address=i.account_address):"TRAVELAGENT"===i.account_type&&(e.selectedEntity.entity_type="TRAVEL_AGENT",e.selectedEntity.account_address=i.account_address),e.selectedEntity.split_charge_by_50=!1}else if("GROUP"===a||"HOUSE"===a){var i=e.results.posting_accounts[t];e.selectedEntity={id:i.id,name:i.account_name,bill_no:"",attached_charge_codes:[],attached_billing_groups:[],is_new:!0,selected_payment:"",credit_card_details:{},entity_type:i.account_type},"ALLOTMENT_DEFAULT_BILLING"===e.billingEntity&&(e.selectedEntity=_.extend(e.selectedEntity,{id:e.allotmentId,allotment_id:e.allotmentId,charge_routes_recipient:{id:i.id,type:"POSTING_ACCOUNT"}})),e.selectedEntity.split_charge_by_50=!1}},e.selectAttachedEntity=function(t,a){e.errorMessage="",e.isEntitySelected=!0,e.isInitialPage=!1,e.selectedEntity={bill_no:"",has_accompanying_guests:!1,attached_charge_codes:[],attached_billing_groups:[],is_new:!0,credit_card_details:{}},"TRAVEL_AGENT_DEFAULT_BILLING"!==e.billingEntity&&"COMPANY_CARD_DEFAULT_BILLING"!==e.billingEntity&&"GROUP_DEFAULT_BILLING"!==e.billingEntity&&"ALLOTMENT_DEFAULT_BILLING"!==e.billingEntity&&(e.selectedEntity.reservation_status=e.reservationData.reservation_status,e.selectedEntity.is_opted_late_checkout=e.reservationData.is_opted_late_checkout),"GUEST"===a?(e.selectedEntity.id=e.reservationData.reservation_id,e.selectedEntity.guest_id=e.attachedEntities.primary_guest_details.id,e.selectedEntity.name=e.attachedEntities.primary_guest_details.name,e.selectedEntity.images=[{is_primary:!0,guest_image:e.attachedEntities.primary_guest_details.avatar}],e.selectedEntity.guest_type_id=e.attachedEntities.primary_guest_details.guest_type_id,e.selectedEntity.entity_type="RESERVATION"):"ACCOMPANY_GUEST"===a?(e.selectedEntity.id=e.reservationData.reservation_id,e.selectedEntity.guest_id=e.attachedEntities.accompanying_guest_details[t].id,e.selectedEntity.name=e.attachedEntities.accompanying_guest_details[t].name,e.selectedEntity.images=[{is_primary:!1,guest_image:e.attachedEntities.accompanying_guest_details[t].avatar}],e.selectedEntity.has_accompanying_guests=!0,e.selectedEntity.entity_type="RESERVATION",e.selectedEntity.guest_type_id=e.attachedEntities.accompanying_guest_details[t].guest_type_id):"COMPANY_CARD"===a?(e.selectedEntity.id=e.attachedEntities.company_card.id,e.selectedEntity.name=e.attachedEntities.company_card.name,e.selectedEntity.is_allow_direct_debit=e.attachedEntities.company_card.is_allow_direct_debit,e.selectedEntity.images=[{is_primary:!0,guest_image:e.attachedEntities.company_card.logo}],e.selectedEntity.entity_type="COMPANY_CARD",e.selectedEntity.account_address=e.attachedEntities.company_card.account_address):"TRAVEL_AGENT"===a?(e.selectedEntity.id=e.attachedEntities.travel_agent.id,e.selectedEntity.name=e.attachedEntities.travel_agent.name,e.selectedEntity.is_allow_direct_debit=e.attachedEntities.travel_agent.is_allow_direct_debit,e.selectedEntity.images=[{is_primary:!0,guest_image:e.attachedEntities.travel_agent.logo}],e.selectedEntity.entity_type="TRAVEL_AGENT",e.selectedEntity.account_address=e.attachedEntities.travel_agent.account_address):"GROUP"===a||"HOUSE"===a?(e.selectedEntity.id=e.attachedEntities.posting_account.id,e.selectedEntity.name=e.attachedEntities.posting_account.name,e.selectedEntity.entity_type=a):"ALLOTMENT"===a&&(e.allotmentId=e.attachedEntities.posting_account.id,e.selectedEntity.id=e.allotmentId,e.selectedEntity.allotment_id=e.allotmentId,e.selectedEntity.name=e.attachedEntities.posting_account.name,e.selectedEntity.entity_type=a)},e.getGuestStatusMapped=function(e,t){var a="";return t&&"CHECKING_OUT"===e?a="late-check-out":("RESERVED"===e?a="arrival":"CHECKING_IN"===e?a="check-in":"CHECKEDIN"===e?a="inhouse":"CHECKEDOUT"===e?a="departed":"CHECKING_OUT"===e?a="check-out":"CANCELED"===e?a="cancel":"NOSHOW"!==e&&"NOSHOW_CURRENT"!==e||(a="no-show"),a)},e.getEntityRole=function(e){return"RESERVATION"!==e.entity_type||e.has_accompanying_guests?"RESERVATION"===e.entity_type?"accompany":"TRAVEL_AGENT"===e.entity_type?"travel-agent":"COMPANY_CARD"===e.entity_type?"company":void 0:"guest"},e.getEntityIconClass=function(e){return"RESERVATION"===e.entity_type&&e.has_accompanying_guests?"accompany":"RESERVATION"===e.entity_type||"COMPANY_CARD"===e.entity_type?"":"TRAVEL_AGENT"===e.entity_type?"icons icon-travel-agent":void 0},e.escapeNull=function(e,t){return escapeNull(e,t)},e.fetchRoutes=function(){var t=function(t){e.routes=t,e.fetchEntities()},a=function(t){e.fetchEntities(),e.errorMessage=t};e.invokeApi(i.fetchRoutes,e.reservationData.reservation_id,t,a)};var s=function(){e.reservation&&(e.arrivalDate=e.reservation.reservation_card.arrival_date,e.departureDate=e.reservation.reservation_card.departure_date,e.arrivalDate=t.businessDate>e.arrivalDate?t.businessDate:e.arrivalDate)},o=function(){e.routeDates={from:e.arrivalDate,to:e.departureDate},e.reservation&&(e.routingDateFromOptions={dateFormat:t.jqDateFormat,minDate:tzIndependentDate(e.reservation.reservation_card.arrival_date),maxDate:tzIndependentDate(e.reservation.reservation_card.departure_date)},e.routingDateToOptions={dateFormat:t.jqDateFormat,minDate:tzIndependentDate(e.reservation.reservation_card.arrival_date),maxDate:tzIndependentDate(e.reservation.reservation_card.departure_date)})};e.fetchEntities=function(){var t=function(t){e.attachedEntities=t,e.$parent.$emit("hideLoader")},a=function(t){e.$emit("hideLoader"),e.errorMessage=t};e.invokeApi(i.fetchAttachedCards,e.reservationData.reservation_id,t,a)},e.saveRoute=function(){t.$broadcast("CALL_SAVE_ROUTE")},e.$on("displayErrorMessage",function(t,a){e.errorMessage=a}),e.handleCloseDialog=function(){e.$emit("HANDLE_MODAL_OPENED"),e.closeDialog(),e.billingData&&(e.billingData.billingInfoTitle=e.routes.length>0?a("translate")("BILLING_INFO_TITLE"):a("translate")("ADD_BILLING_INFO_TITLE"))},e.deleteDefaultRouting=function(){var t=function(t){e.$emit("hideLoader"),e.$emit("BILLINGINFODELETED"),e.closeDialog()},a=function(t){e.$emit("hideLoader"),e.$emit("displayErrorMessage",t)},n={};n.id=e.contactInformation.id,e.invokeApi(i.deleteDefaultRouting,n,t,a)},e.deleteBillingInfo=function(){e.deleteDefaultRouting()},e.isDeleteBtnShownForGroupBillingInfo=function(){return(e.selectedEntity.isBillingGroupsPresent||e.selectedEntity.isChargeCodesPresent)&&"GROUP_DEFAULT_BILLING"===e.billingEntity&&e.hasPermisionToDeleteGroupBillInfo};var l=function(){void 0===e.attachedEntities?(e.isInitialPage=!0,e.fetchRoutes(),e.attachedEntities=[]):"TRAVEL_AGENT_DEFAULT_BILLING"===e.billingEntity?e.selectAttachedEntity("","TRAVEL_AGENT"):"COMPANY_CARD_DEFAULT_BILLING"===e.billingEntity?e.selectAttachedEntity("","COMPANY_CARD"):"GROUP_DEFAULT_BILLING"===e.billingEntity?e.selectAttachedEntity("","GROUP"):"ALLOTMENT_DEFAULT_BILLING"===e.billingEntity?e.selectAttachedEntity("","ALLOTMENT"):(e.isInitialPage=!0,e.fetchRoutes(),e.attachedEntities=[])};e.getGuestTypeIconClass=function(e){var a="adult",i=_.find(t.guestTypes,{id:e.guest_type_id});return"CHILDREN"===i.value?a="student":"INFANTS"===i.value&&(a="infant"),a},l()}]),sntRover.controller("RVMoveChargeCtrl",["$scope","$timeout","RVMoveChargeSrv",function(e,t,a){BaseCtrl.call(this,e);var i=function(){e.numberQuery="",e.textQuery="",e.searchResults=[],e.targetSelected=!1,e.targetBillSelected=!1,e.searching=!1,e.selectedTarget={},e.targetBillId="",e.setScroller("search_results"),e.billOptions=[],n()},n=function(){var t=e.reservationBillData&&e.reservationBillData.bills||e.transactionsDetails&&e.transactionsDetails.bills;_.each(t,function(t,a){a!==e.currentActiveBill&&e.billOptions.push(t)})},r=function(){e.$$phase||e.$digest()};e.billSelected=function(){""!==e.selectedBillId?(e.targetBillId=parseInt(e.selectedBillId),e.targetBillSelected=!0):(e.targetBillSelected=!1,e.searching=!1)},e.getGuestStatusIcon=function(e,t,a){var i="";return t&&"CHECKING_OUT"===e?i="late-check-out":("RESERVED"!==e||a?"CHECKING_IN"!==e||a?"CHECKEDIN"===e?i="inhouse":"CHECKEDOUT"===e?i="departed":"CHECKING_OUT"===e?i="check-out":"CANCELED"===e?i="cancel":"NOSHOW"===e||"NOSHOW_CURRENT"===e?i="no-show":a&&(i="pre-check-in"):i="check-in":i="arrival",i)};var s=function(){t(function(){e.refreshScroller("search_results")},500)};e.$on("NG_REPEAT_COMPLETED_RENDERING",function(e){s()});var o=function(){e.searchResults=[],s()};e.clearTextQuery=function(){e.textQuery="",o(),e.searching=!1,e.targetSelected=!1},e.clearNumberQuery=function(){e.numberQuery="",o(),e.searching=!1,e.targetSelected=!1};var l=function(){var t=function(t){e.$emit("hideLoader"),e.searchResults=t.results,_.each(e.searchResults,function(e,t){e.entity_id=t,"RESERVATION"===e.type?e.displaytext=e.last_name+", "+e.first_name:""}),s()};e.invokeApi(a.fetchSearchedItems,{text_search:e.textQuery,number_search:e.numberQuery,bill_id:e.moveChargeData.fromBillId},t)};e.queryEntered=function(){e.searching=!0,e.targetSelected=!1,t(function(){(""===e.textQuery||e.textQuery.length<3)&&(""===e.numberQuery||e.numberQuery.length<2)?(e.searchResults=[],s()):l(),r()},200)},e.targetClicked=function(t){_.each(e.searchResults,function(a){a.entity_id===t&&(e.selectedTarget=a,e.selectedTarget.displayNumber="ACCOUNT"===a.type||"GROUP"===a.type?a.account_number:a.confirm_no,e.selectedTarget.displaytext="ACCOUNT"===a.type||"GROUP"===a.type?a.account_name:a.last_name+" ,"+a.first_name,e.targetBillId=e.selectedTarget.bills[0].id,e.targetSelected=!0)}),e.searching=!1,e.targetSelected=!0},e.changeSelection=function(){e.selectedTarget={},e.targetSelected=!1,e.searching=!0},e.showMoveButton=function(){return e.targetSelected||e.targetBillSelected},e.isAllTransactionsSelected=function(){if("ACCOUNT"===e.origin){var t=e.transactionsDetails.bills[e.currentActiveBill].transactions.length,a=e.moveChargeData.selectedTransactionIds.length;return t===a}},e.showMoveAllChargesCheckbox=function(){var t=!1;if("ACCOUNT"===e.origin){var a=e.transactionsDetails.bills[e.currentActiveBill].pageOptions.totalPages>1;t=a&&e.isAllTransactionsSelected()}return t},e.moveCharges=function(){var t={from_bill:e.moveChargeData.fromBillId,to_bill:e.targetBillId,financial_transaction_ids:e.moveChargeData.selectedTransactionIds,is_move_all_charges:e.moveChargeData.isMoveAllCharges,date:e.moveChargeData.date},i=function(t){e.$emit("hideLoader"),t.data.toBill=e.targetBillId,e.$emit("moveChargeSuccsess",t.data),t.data.is_move_charges_inprogress||e.closeDialog()},n=function(t){e.errorMessage=t,e.$emit("hideLoader")};e.invokeApi(a.moveChargesToTargetEntity,t,i,n)},i()}]),sntRover.controller("rvRouteDetailsCtrl",["$scope","$rootScope","$filter","RVBillinginfoSrv","RVCompanyCardSrv","rvPermissionSrv","RVGuestCardSrv","ngDialog","RVBillCardSrv","RVPaymentSrv",function(e,t,a,i,n,r,s,o,l,c){e.routeDetailsState={newCard:null},BaseCtrl.call(this,e),e.isAddPayment=!1,e.chargeCodeToAdd="",e.showPayment=!1,e.first_bill_id="",e.showChargeCodes=!1,e.isBillingGroup=!0,e.paymentDetails=null,e.swipedCardDataToSave={},e.showCreditCardDropDown=!1,e.isShownExistingCCPayment=!1,e.isCompanyTravelAgent=!1,e.billNumberOnAddCC="",null!==e.selectedEntity.credit_card_details&&void 0!==e.selectedEntity.credit_card_details&&e.selectedEntity.credit_card_details.hasOwnProperty("payment_type_description")&&(e.renderAddedPayment=e.selectedEntity.credit_card_details,e.renderAddedPayment.cardExpiry=e.selectedEntity.credit_card_details.card_expiry,e.renderAddedPayment.endingWith=e.selectedEntity.credit_card_details.card_number,e.renderAddedPayment.creditCardType=e.selectedEntity.credit_card_details.card_code,e.showPayment=!0,e.showCreditCardDropDown=!1,e.isShownExistingCCPayment=!0,setTimeout(function(){e.$broadcast("UPDATE_FLAG")},1e3)),e.passData={},e.passData.details={},"undefined"==typeof e.guestCardData||"undefined"==typeof e.guestCardData.contactInfo?(e.passData.details.firstName="",e.passData.details.lastName=""):(e.passData.details.firstName=e.guestCardData.contactInfo.first_name,e.passData.details.lastName=e.guestCardData.contactInfo.last_name),e.setScroller("cardsList");var d={preventDefault:!1};e.setScroller("paymentList",d),e.setScroller("billingGroups",d),e.setScroller("chargeCodes",d),e.setScroller("routeDetails",d);var u={click:!0};e.setScroller("chargeCodesList",u),e.chargeCodesListDivHgt=250,e.chargeCodesListDivTop=0,e.selectedEntity.credit_limit&&(e.selectedEntity.credit_limit=parseFloat(e.selectedEntity.credit_limit).toFixed(2));var p=function(){e.refreshScroller("paymentList"),e.refreshScroller("billingGroups"),e.refreshScroller("chargeCodes"),e.refreshScroller("chargeCodesList"),e.refreshScroller("routeDetails")};setTimeout(p,500),e.editPaymentMethod=function(){e.oldPayment=e.renderAddedPayment,e.renderAddedPayment=null,isAddPayment=!1},e.checkBillStatus=function(){return e.reservationBillData&&!e.reservationBillData.bills[0].is_active},e.showPaymentList=function(){e.isAddPayment=!1,e.refreshScroller("paymentList")},e.$on("CANCELLED_PAYMENT",function(){e.renderAddedPayment=e.oldPayment});var g=function(){var t=e.cardData.tokenDetails.isSixPayment?e.cardData.tokenDetails.expiry.substring(2,4)+" / "+e.cardData.tokenDetails.expiry.substring(0,2):e.cardData.cardDetails.expiryMonth+" / "+e.cardData.cardDetails.expiryYear;return t},m=function(){var t=e.cardData.tokenDetails.isSixPayment?e.cardData.tokenDetails.token_no.substr(e.cardData.tokenDetails.token_no.length-4):e.cardData.cardDetails.cardNumber.slice(-4);return t};e.paymentAdded=function(t){e.selectedEntity.selected_payment="",e.cardData=t,e.renderAddedPayment={},e.renderAddedPayment.payment_type="CC",e.isAddPayment=!1,e.showPayment=!0,e.renderAddedPayment.creditCardType=e.cardData.tokenDetails.isSixPayment?getSixCreditCardType(e.cardData.tokenDetails.card_type).toLowerCase():getCreditCardType(e.cardData.cardDetails.cardType).toLowerCase(),e.renderAddedPayment.cardExpiry=g(),e.renderAddedPayment.endingWith=m()},e.paymentAddedThroughMLISwipe=function(t){e.renderAddedPayment={},e.renderAddedPayment.payment_type="CC",e.swipedCardDataToSave=t,e.renderAddedPayment.creditCardType=t.cardType.toLowerCase(),e.renderAddedPayment.cardExpiry=t.cardExpiryMonth+"/"+t.cardExpiryYear,e.renderAddedPayment.endingWith=t.cardNumber.slice(-4)},e.onSaveNewCard=function(t){e.selectedEntity.selected_payment="",e.cardData=t.cardDetails,e.renderAddedPayment={},e.renderAddedPayment.payment_type="CC",e.isAddPayment=!1,e.showPayment=!0,e.renderAddedPayment.creditCardType=t.cardDetails.card_code,e.renderAddedPayment.cardExpiry=t.cardDetails.expiry_date,e.renderAddedPayment.endingWith=t.cardDetails.ending_with,e.routeDetailsState.newCard=t.cardDetails.expiry_date+t.cardDetails.ending_with+t.cardDetails.card_code},e.showAddPayment=function(){if(t.isManualCCEntryEnabled)e.billNumberOnAddCC=e.selectedEntity.is_new?e.newBillNumber:e.selectedEntity.bill_no,e.isAddPayment=!0,e.showCreditCardDropDown=!0,e.renderAddedPayment={},e.renderAddedPayment.creditCardType="",e.renderAddedPayment.cardExpiry="",e.renderAddedPayment.endingWith="",e.renderAddedPayment.payment_type="",e.isShownExistingCCPayment=!1,e.$broadcast("showaddpayment"),e.refreshScroller("routeDetails");else{e.isManualCCEntryEnabled=!1;o.open({template:"/assets/partials/payment/rvPaymentModal.html",controller:"",scope:e})}},e.$on("SHOW_SWIPED_DATA_ON_BILLING_SCREEN",function(t,a){e.isAddPayment=!0,e.$broadcast("showaddpayment"),setTimeout(function(){e.saveData.payment_type="CC",e.showCreditCardDropDown=!0,e.swippedCard=!0,e.$broadcast("RENDER_DATA_ON_BILLING_SCREEN",a),e.$digest()},2e3)}),e.$on("ngDialog.opened",function(t,a){e.ngDialogID=a[0].id}),e.closeDialog=function(){o.close(e.ngDialogID)},e.toggleChargeType=function(){e.isBillingGroup=!e.isBillingGroup,e.isBillingGroup?e.refreshScroller("billingGroups"):e.refreshScroller("chargeCodes"),e.showChargeCodes=!1},e.isBillingGroupSelected=function(t){for(var a=0;a<e.selectedEntity.attached_billing_groups.length;a++)if(e.selectedEntity.attached_billing_groups[a].id===t.id)return!0;return!1},e.toggleSelectionForBillingGroup=function(t){for(var a=0;a<e.selectedEntity.attached_billing_groups.length;a++)if(e.selectedEntity.attached_billing_groups[a].id===t.id)return void e.selectedEntity.attached_billing_groups.splice(a,1);e.selectedEntity.attached_billing_groups.push(t),e.refreshScroller("billingGroups")},e.removeChargeCode=function(t){for(var a=0;a<e.selectedEntity.attached_charge_codes.length;a++)if(e.selectedEntity.attached_charge_codes[a].id===t.id)return void e.selectedEntity.attached_charge_codes.splice(a,1)},e.showAvailableChargeCodes=function(){e.clearResults(),h(),e.showChargeCodes=!e.showChargeCodes},e.addChargeCode=function(){for(var t=0;t<e.availableChargeCodes.length;t++)if(e.availableChargeCodes[t].id===e.chargeCodeToAdd){for(var a=0;a<e.selectedEntity.attached_charge_codes.length;a++)if(e.selectedEntity.attached_charge_codes[a].id===e.chargeCodeToAdd)return;return e.selectedEntity.attached_charge_codes.push(e.availableChargeCodes[t]),void e.refreshScroller("chargeCodes")}},e.selectChargeCode=function(t){e.chargeCodeToAdd=t,e.addChargeCode(),e.chargeCodeSearchText="",e.showChargeCodes=!1},e.fetchAvailableChargeCodes=function(){var t=function(t){e.availableChargeCodes=t,e.fetchAvailableBillingGroups()},n=function(t){e.$parent.$emit("hideLoader"),e.$emit("displayErrorMessage",t)},r={};r.id=e.reservationData.reservation_id,e.reservationData.reservation_id!==e.selectedEntity.id&&"RESERVATION"===e.selectedEntity.entity_type?r.to_bill=e.first_bill_id:r.to_bill=e.selectedEntity.to_bill,r.is_new=e.selectedEntity.is_new,r.from_date=a("date")(tzIndependentDate(e.routeDates.from),"yyyy-MM-dd"),r.to_date=a("date")(tzIndependentDate(e.routeDates.to),"yyyy-MM-dd"),e.invokeApi(i.fetchAvailableChargeCodes,r,t,n)},e.showPaymentOption=function(){return!e.isAddPayment&&e.showPayment&&null==e.renderAddedPayment},e.fetchAvailableBillingGroups=function(){var t=function(t){e.availableBillingGroups=t,0===t.length&&(e.isBillingGroup=!1),"ALLOTMENT"===e.selectedEntity.entity_type||"GROUP"===e.selectedEntity.entity_type||"HOUSE"===e.selectedEntity.entity_type?(e.showPayment=!1,e.$parent.$emit("hideLoader")):"COMPANY_CARD"===e.selectedEntity.entity_type||"TRAVEL_AGENT"===e.selectedEntity.entity_type?(e.showPayment=!0,e.isCompanyTravelAgent=!0,e.accountId=e.selectedEntity.id,e.fetchAttachedPaymentTypes()):e.reservationData.reservation_id!==e.selectedEntity.id&&"RESERVATION"===e.selectedEntity.entity_type?e.$parent.$emit("hideLoader"):e.reservationData.reservation_id!==e.selectedEntity.id&&"RESERVATION"!==e.selectedEntity.entity_type?(e.showPayment=!0,e.attachedPaymentTypes=[],e.$parent.$emit("hideLoader")):e.selectedEntity.has_accompanying_guests?(e.showPayment=!0,e.$parent.$emit("hideLoader")):(e.showPayment=!0,e.fetchAttachedPaymentTypes())},n=function(t){e.$parent.$emit("hideLoader"),e.$emit("displayErrorMessage",t)},r={};r.id=e.reservationData.reservation_id,e.reservationData.reservation_id!==e.selectedEntity.id&&"RESERVATION"===e.selectedEntity.entity_type?r.to_bill=e.first_bill_id:r.to_bill=e.selectedEntity.to_bill,r.is_new=e.selectedEntity.is_new,r.from_date=a("date")(tzIndependentDate(e.routeDates.from),"yyyy-MM-dd"),r.to_date=a("date")(tzIndependentDate(e.routeDates.to),"yyyy-MM-dd"),e.invokeApi(i.fetchAvailableBillingGroups,r,t,n)},e.fetchAttachedPaymentTypes=function(){var t=function(t){e.$parent.$emit("hideLoader"),e.$emit("displayErrorMessage",t)};if(e.isCompanyTravelAgent){var a=function(t){e.attachedPaymentTypes=t.data,e.$parent.$emit("hideLoader"),p()};e.invokeApi(n.fetchAccountPaymentData,e.accountId,a,t)}else{var a=function(t){e.attachedPaymentTypes=t,e.$parent.$emit("hideLoader"),p()};e.invokeApi(s.fetchGuestPaymentData,e.reservationData.user_id,a,t)}},e.excludeExistingBills=function(t){for(var a=0;a<e.routes.length;a++)for(var i=0;i<t.length;i++)if(t[i].id===e.routes[a].to_bill&&e.selectedEntity.id!==e.routes[a].id){t.splice(i,1);break}return t},e.fetchBillsForReservation=function(){var t=function(t){e.bills=[],e.$parent.bills=[],e.first_bill_id="undefined"!=typeof t[0]?t[0].id:"";var a="undefined"!=typeof t[0]?t[0].id:"";if(e.newBillNumber=t.length+1,"undefined"!=typeof e.reservationData&&e.reservationData.reservation_id!==e.selectedEntity.id&&"RESERVATION"===e.selectedEntity.entity_type)e.bills.push(t[0]),e.bills=e.excludeExistingBills(e.bills),e.$parent.bills=e.bills;else{t.splice(0,1),e.bills=e.excludeExistingBills(t);var i={};i.id="new",i.is_active=!0,i.bill_number=""+e.newBillNumber+"(new)",e.bills.push(i),e.$parent.bills=e.bills}if(e.selectedEntity.to_bill=e.selectedEntity.is_new?e.bills[0].id:e.selectedEntity.to_bill,"GROUP_DEFAULT_BILLING"===e.billingEntity||"ALLOTMENT_DEFAULT_BILLING"===e.billingEntity)return void e.fetchAllChargeCodes();var n=e.selectedEntity.bill_no;"ALLOTMENT"===e.selectedEntity.entity_type||"GROUP"===e.selectedEntity.entity_type||"HOUSE"===e.selectedEntity.entity_type?e.selectedEntity.to_bill=a:""===n?e.selectedEntity.to_bill=_.last(e.bills).id:e.selectedEntity.to_bill=e.selectedEntity.to_bill,e.fetchAvailableChargeCodes()},a=function(t){e.$parent.$emit("hideLoader"),e.$emit("displayErrorMessage",t)},n="undefined"!=typeof e.reservationData?e.reservationData.reservation_id:"",r="";"ALLOTMENT"===e.selectedEntity.entity_type||"GROUP"===e.selectedEntity.entity_type||"HOUSE"===e.selectedEntity.entity_type?(n=e.selectedEntity.id,r=e.selectedEntity.entity_type):"RESERVATION"===e.selectedEntity.entity_type&&(n=e.selectedEntity.id);var s={id:n,entity_type:r};e.invokeApi(i.fetchBillsForReservation,s,t,a)},e.fetchDefaultAccountRouting=function(){var t=function(t){"ALLOTMENT_DEFAULT_BILLING"!==e.billingEntity&&(t.from_date&&(e.arrivalDate=t.from_date,e.departureDate=t.to_date),D()),e.selectedEntityChanged||void 0===t.charge_routes_recipient||("TRAVELAGENT"===t.type?t.type="TRAVEL_AGENT":"COMPANY"===t.type?t.type="COMPANY_CARD":t.posting_account_type?t.type=t.posting_account_type:(t.type=t.charge_routes_recipient.type,t.reservation_status=t.status,t.images&&(t.images[0].guest_image=t.images[0].image)),e.selectedEntity=_.extend(e.selectedEntity,t),e.selectedEntity.entity_type=t.type,e.attachedEntities=[e.selectedEntity]),e.selectedEntity.attached_billing_groups=t.billing_groups,e.selectedEntity.isBillingGroupsPresent=t.billing_groups.length>0,t.credit_limit&&(e.selectedEntity.credit_limit=parseFloat(t.credit_limit).toFixed(2)),e.selectedEntity.reference_number=t.reference_number,"undefined"==typeof e.selectedEntity.is_allow_direct_debit&&(e.selectedEntity.is_allow_direct_debit=t.is_allow_direct_debit),e.selectedEntity.attached_charge_codes=t.attached_charge_codes,e.selectedEntity.isChargeCodesPresent=t.attached_charge_codes.length>0,isEmptyObject(t.credit_card_details)||(e.renderAddedPayment=t.credit_card_details,e.saveData.payment_type=t.credit_card_details.payment_type,e.renderAddedPayment.cardExpiry=t.credit_card_details.card_expiry,e.renderAddedPayment.endingWith=t.credit_card_details.card_number,e.renderAddedPayment.creditCardType=t.credit_card_details.card_code,e.isAddPayment=!1,"CC"!==t.credit_card_details.payment_type?e.showCreditCardDropDown=!0:(e.showCreditCardDropDown=!1,e.isShownExistingCCPayment=!0)),e.selectedEntity.split_charge_by_guests=t.split_charge_by_guests,e.$parent.$emit("hideLoader")},a={};a.id=e.selectedEntity.id,a.entity_type=e.selectedEntity.entity_type,"ALLOTMENT_DEFAULT_BILLING"===e.billingEntity&&(a.entity_type="ALLOTMENT"),e.invokeApi(i.fetchDefaultAccountRouting,a,t)},e.fetchAttachedPayments=function(){var t=function(t){e.attachedPaymentTypes=t.data,e.$parent.$emit("hideLoader")},a=function(t){e.$parent.$emit("hideLoader"),e.$emit("displayErrorMessage",t)};e.invokeApi(n.fetchCompanyPaymentData,e.contactInformation.id,t,a)},e.fetchAllBillingGroups=function(){var t=function(t){e.availableBillingGroups=t,0===t.length&&(e.isBillingGroup=!1),e.$parent.$emit("hideLoader"),e.fetchDefaultAccountRouting(),e.fetchAttachedPayments()},a=function(t){e.$parent.$emit("hideLoader"),e.$emit("displayErrorMessage",t)};e.invokeApi(i.fetchAllBillingGroups,"",t,a)},e.fetchAllChargeCodes=function(){var t=function(t){e.availableChargeCodes=t,e.fetchAllBillingGroups()},a=function(t){e.$parent.$emit("hideLoader"),e.$emit("displayErrorMessage",t)};e.invokeApi(i.fetchAllChargeCodes,"",t,a)},"TRAVEL_AGENT_DEFAULT_BILLING"!==e.billingEntity&&"COMPANY_CARD_DEFAULT_BILLING"!==e.billingEntity&&"GROUP_DEFAULT_BILLING"!==e.billingEntity&&"ALLOTMENT_DEFAULT_BILLING"!==e.billingEntity?e.fetchBillsForReservation():e.fetchAllChargeCodes(),"TRAVEL_AGENT_DEFAULT_BILLING"!==e.billingEntity&&"COMPANY_CARD_DEFAULT_BILLING"!==e.billingEntity&&"GROUP_DEFAULT_BILLING"!==e.billingEntity&&"ALLOTMENT_DEFAULT_BILLING"!==e.billingEntity||(e.showPayment=!0),e.chargeCodeEntered=function(){e.showChargeCodes=!1,h();var t=e.chargeCodeSearchText;e.chargeCodeSearchText=t.charAt(0).toUpperCase()+t.slice(1)},e.clearResults=function(){e.chargeCodeSearchText=""};var h=function(){if(e.chargeCodeSearchText.length<3){for(var t=0;t<e.availableChargeCodes.length;t++)e.isChargeCodeSelected(e.availableChargeCodes[t])?(e.availableChargeCodes[t].is_row_visible=!1,
e.availableChargeCodes[t].is_selected=!1):(e.availableChargeCodes[t].is_row_visible=!0,e.availableChargeCodes[t].is_selected=!0);e.refreshScroller("chargeCodesList")}else{for(var a="",t=0;t<e.availableChargeCodes.length;t++)a=e.availableChargeCodes[t],(e.escapeNull(a.code).toUpperCase().indexOf(e.chargeCodeSearchText.toUpperCase())>=0||e.escapeNull(a.description).toUpperCase().indexOf(e.chargeCodeSearchText.toUpperCase())>=0)&&!e.isChargeCodeSelected(e.availableChargeCodes[t])?e.availableChargeCodes[t].is_row_visible=!0:e.availableChargeCodes[t].is_row_visible=!1;e.refreshScroller("chargeCodesList")}};e.escapeNull=function(e,t){return escapeNull(e,t)},e.isChargeCodeSelected=function(t){if(e.selectedEntity.attached_charge_codes)for(var a=0;a<e.selectedEntity.attached_charge_codes.length;a++)if(e.selectedEntity.attached_charge_codes[a].id===t.id)return!0;return!1};var y=e.$on("CALL_SAVE_ROUTE",function(t){t.preventDefault(),t.stopPropagation&&t.stopPropagation(),e.saveRoute()});e.$on("$destroy",y),e.updateCardInfo=function(){("COMPANY_CARD"!==e.selectedEntity.entity_type||"undefined"!=typeof e.reservationDetails.companyCard.id&&""!==e.reservationDetails.companyCard.id)&&("TRAVEL_AGENT"!==e.selectedEntity.entity_type||"undefined"!==e.reservationDetails.travelAgent.id&&""!==e.reservationDetails.travelAgent.id)||t.$broadcast("CardInfoUpdated",e.selectedEntity.id,e.selectedEntity.entity_type)},e.saveRoute=function(){return 0===e.selectedEntity.attached_charge_codes.length&&0===e.selectedEntity.attached_billing_groups.length?void e.$emit("displayErrorMessage",[a("translate")("ERROR_CHARGES_EMPTY")]):("TRAVEL_AGENT_DEFAULT_BILLING"!==e.billingEntity&&"COMPANY_CARD_DEFAULT_BILLING"!==e.billingEntity&&"GROUP_DEFAULT_BILLING"!==e.billingEntity&&"ALLOTMENT_DEFAULT_BILLING"!==e.billingEntity&&(e.selectedEntity.reservation_id=e.reservationData.reservation_id),"TRAVEL_AGENT_DEFAULT_BILLING"!==e.billingEntity&&"COMPANY_CARD_DEFAULT_BILLING"!==e.billingEntity&&"ALLOTMENT_DEFAULT_BILLING"!==e.billingEntity&&(e.selectedEntity.from_date=a("date")(tzIndependentDate(e.routeDates.from),"yyyy-MM-dd"),e.selectedEntity.to_date=a("date")(tzIndependentDate(e.routeDates.to),"yyyy-MM-dd")),void("new"===e.selectedEntity.to_bill?e.createNewBill():null===e.saveData.payment_type||""===e.saveData.payment_type||e.isShownExistingCCPayment||e.routeDetailsState.newCard?f():e.savePayment()))};var v=function(){o.open({template:"/assets/partials/bill/rvBillingInfoCreditLimitExceededPopup.html",className:"",closeByDocument:!1,scope:e})},f=function(){e.saveSuccessCallback=function(t){if(e.$parent.$emit("hideLoader"),e.reservationBillData&&t.bill_number&&(e.reservationBillData.bills[t.bill_number-1]={bill_id:t.id,bill_number:t.bill_number,total_amount:0,routed_entity_type:t.routed_entity_type,guest_image:t.guest_image}),null!==t.tax_exempt_warning&&t.tax_exempt_warning.length>0){var a=[];a.push(t.tax_exempt_warning),e.$emit("displayErrorMessage",a)}t.has_crossed_credit_limit?v():(e.$parent.$emit("BILLINGINFOADDED"),e.setReloadOption(!0),e.headerButtonClicked(),e.updateCardInfo(),e.$parent.$emit("REFRESH_BILLCARD_VIEW"))};var t=function(t){e.$parent.$emit("hideLoader"),e.$emit("displayErrorMessage",t)},a=function(){e.$parent.$emit("hideLoader"),e.$parent.$emit("BILLINGINFOADDED"),o.close()};if("TRAVEL_AGENT_DEFAULT_BILLING"===e.billingEntity||"COMPANY_CARD_DEFAULT_BILLING"===e.billingEntity||"GROUP_DEFAULT_BILLING"===e.billingEntity||"ALLOTMENT_DEFAULT_BILLING"===e.billingEntity){var n=angular.copy(e.selectedEntity);"GROUP_DEFAULT_BILLING"!==e.billingEntity||"GROUP"!==e.selectedEntity.entity_type&&"HOUSE"!==e.selectedEntity.entity_type||(n.entity_type=e.selectedEntity.entity_type),"ALLOTMENT_DEFAULT_BILLING"===e.billingEntity?(n.entity_type="ALLOTMENT",e.invokeApi(i.saveAllotmentDefaultAccountRouting,n,a,t)):(n.attached_payment_method_id=e.selectedEntity.selected_payment,e.invokeApi(i.saveDefaultAccountRouting,n,a,t))}else{var n=angular.copy(e.selectedEntity);e.invokeApi(i.saveRoute,n,e.saveSuccessCallback,t)}};e.hasPermissionToEditCreditLimit=function(){return r.getPermissionValue("OVERWRITE_DIRECT_BILL_MAXIMUM_AMOUNT")},e.createNewBill=function(){if("ALLOTMENT"===e.selectedEntity.entity_type||"GROUP"===e.selectedEntity.entity_type||"HOUSE"===e.selectedEntity.entity_type)var t={entity_type:e.selectedEntity.entity_type,entity_id:e.selectedEntity.id};else var t={reservation_id:e.reservationData.reservation_id};var a=function(t){e.$emit("hideLoader"),e.reservationBillData&&(e.reservationBillData.bills[t.bill_number-1]={bill_id:t.id,bill_number:t.bill_number,total_amount:0}),e.selectedEntity.to_bill=t.id,e.bills[e.bills.length-1].id=t.id,e.bills[e.bills.length-1].bill_number=t.bill_number,null!==e.saveData.payment_type&&""!==e.saveData.payment_type?e.savePayment():f()};e.invokeApi(l.createAnotherBill,t,a,e.errorCallback)};var E=function(){var t=e.cardData.tokenDetails.isSixPayment?e.passData.details.firstName+" "+e.passData.details.lastName:e.cardData.cardDetails.userName;return t},C=function(){var t=e.cardData.tokenDetails.isSixPayment?e.cardData.tokenDetails.expiry.substring(2,4):e.cardData.cardDetails.expiryMonth,a=e.cardData.tokenDetails.isSixPayment?e.cardData.tokenDetails.expiry.substring(0,2):e.cardData.cardDetails.expiryYear,i=t&&a?"20"+a+"-"+t+"-01":"";return i};e.savePayment=function(){e.saveSuccessCallback=function(t){e.$parent.$emit("hideLoader"),e.$parent.$emit("BILLINGINFOADDED")},e.errorCallback=function(t){e.$parent.$emit("hideLoader"),e.$emit("displayErrorMessage",t)},void 0!==e.reservationData&&null!==e.reservationData.reservation_id?e.savePaymentToReservationOrAccount("reservation"):"TRAVEL_AGENT_DEFAULT_BILLING"===e.billingEntity||"COMPANY_CARD_DEFAULT_BILLING"===e.billingEntity?e.savePaymentToReservationOrAccount("companyOrTA"):"GROUP_DEFAULT_BILLING"===e.billingEntity?e.savePaymentToReservationOrAccount("account"):"ALLOTMENT_DEFAULT_BILLING"===e.billingEntity?e.savePaymentToReservationOrAccount("allotment"):f()},e.savePaymentToReservationOrAccount=function(a){e.saveSuccessCallback=function(t){e.$parent.$emit("hideLoader"),t.has_crossed_credit_limit?v():(e.setReloadOption(!0),e.headerButtonClicked(),e.$parent.$emit("BILLINGINFOADDED"),e.$parent.$emit("REFRESH_BILLCARD_VIEW")),e.reservationBillData&&t.bill_number&&(e.reservationBillData.bills[t.bill_number-1]={bill_id:t.id,bill_number:t.bill_number,total_amount:0,routed_entity_type:t.routed_entity_type,guest_image:t.guest_image})},e.errorCallback=function(t){e.$parent.$emit("hideLoader"),e.$emit("displayErrorMessage",t)};var n=function(){e.$parent.$emit("hideLoader"),e.$parent.$emit("BILLINGINFOADDED"),o.close()},r=function(t){if(e.$parent.$emit("hideLoader"),"TRAVEL_AGENT_DEFAULT_BILLING"===e.billingEntity||"COMPANY_CARD_DEFAULT_BILLING"===e.billingEntity||"GROUP_DEFAULT_BILLING"===e.billingEntity||"ALLOTMENT_DEFAULT_BILLING"===e.billingEntity){var a=angular.copy(e.selectedEntity);"ALLOTMENT_DEFAULT_BILLING"===e.billingEntity?(a.entity_type="ALLOTMENT",e.invokeApi(i.saveAllotmentDefaultAccountRouting,a,n,e.errorCallback)):e.invokeApi(i.saveDefaultAccountRouting,a,n,e.errorCallback)}else e.invokeApi(i.saveRoute,e.selectedEntity,e.saveSuccessCallback,e.errorCallback)},s=function(t){e.$parent.$emit("hideLoader"),e.$emit("displayErrorMessage",t)},l=function(t){var i={token:t.token,is_swiped:!0};"reservation"===a?i.reservation_id=e.reservationData.reservation_id:"companyOrTA"===a?i.account_id=e.selectedEntity.id:"allotment"===a?i.allotment_id=e.selectedEntity.allotment_id:i.group_id=e.selectedEntity.id,e.invokeApi(c.savePaymentDetails,i,r,s)};if("CC"===e.saveData.payment_type)if("sixpayments"!==t.paymentGateway||e.sixIsManual)if(isEmptyObject(e.swipedCardDataToSave)){var d={add_to_guest_card:!1};"reservation"===a?d.reservation_id=e.reservationData.reservation_id:"companyOrTA"===a?d.account_id=e.selectedEntity.id:"allotment"===a?d.allotment_id=e.selectedEntity.allotment_id:d.group_id=e.selectedEntity.id,d.payment_type=e.saveData.payment_type,creditCardType=e.cardData.tokenDetails.isSixPayment?getSixCreditCardType(e.cardData.tokenDetails.card_type).toLowerCase():getCreditCardType(e.cardData.cardDetails.cardType),d.token=e.cardData.tokenDetails.isSixPayment?e.cardData.tokenDetails.token_no:e.cardData.tokenDetails.session,d.card_name=E(),d.bill_number=e.getSelectedBillNumber(),d.card_expiry=C(),d.card_code=e.cardData.tokenDetails.isSixPayment?getSixCreditCardType(e.cardData.tokenDetails.card_type).toLowerCase():e.cardData.cardDetails.cardType,e.invokeApi(c.savePaymentDetails,d,r,s)}else{var d=e.swipedCardDataToSave;"reservation"===a?d.reservation_id=e.reservationData.reservation_id:"companyOrTA"===a?d.account_id=e.selectedEntity.id:"allotment"===a?d.allotment_id=e.selectedEntity.allotment_id:d.group_id=e.selectedEntity.id,d.bill_number=e.getSelectedBillNumber(),d.payment_credit_type=e.swipedCardDataToSave.cardType,d.credit_card=e.swipedCardDataToSave.cardType,d.card_expiry="20"+e.swipedCardDataToSave.cardExpiryYear+"-"+e.swipedCardDataToSave.cardExpiryMonth+"-01",e.invokeApi(c.savePaymentDetails,d,r,s)}else{var d={};"reservation"===a?d.reservation_id=e.reservationData.reservation_id:"companyOrTA"===a?d.account_id=e.selectedEntity.id:"allotment"===a?d.allotment_id=e.selectedEntity.allotment_id:d.group_id=e.selectedEntity.id,d.add_to_guest_card=!1,d.bill_number=e.getSelectedBillNumber(),e.$emit("UPDATE_SHOULD_SHOW_WAITING",!0),c.chipAndPinGetToken(d).then(function(t){e.$emit("UPDATE_SHOULD_SHOW_WAITING",!1),l(t)},function(t){e.errorMessage=t,e.$emit("UPDATE_SHOULD_SHOW_WAITING",!1)})}else{var d={payment_type:e.saveData.payment_type};"reservation"===a?d.reservation_id=e.reservationData.reservation_id:"companyOrTA"===a?d.account_id=e.selectedEntity.id:"allotment"===a?d.allotment_id=e.selectedEntity.allotment_id:d.group_id=e.selectedEntity.id,d.bill_number=e.getSelectedBillNumber(),e.invokeApi(c.savePaymentDetails,d,r,s)}},e.getSelectedBillNumber=function(){for(var t=0;t<e.bills.length;t++)if(parseInt(e.bills[t].id)===parseInt(e.selectedEntity.to_bill))return e.bills[t].bill_number},e.shouldHideSplitCharge=function(){return e.isHourlyRateOn||"GROUP_DEFAULT_BILLING"===e.billingEntity||"GROUP"===e.selectedEntity.entity_type||"TRAVEL_AGENT_DEFAULT_BILLING"===e.billingEntity||"COMPANY_CARD_DEFAULT_BILLING"===e.billingEntity||"ALLOTMENT_DEFAULT_BILLING"===e.billingEntity},e.sixIsManual=!1,e.$on("CHANGE_IS_MANUAL",function(t,a){e.sixIsManual=a});var D=function(){"GROUP_DEFAULT_BILLING"==e.billingEntity&&(e.routeDates={from:e.arrivalDate,to:e.departureDate},e.routingDateFromOptions={dateFormat:t.jqDateFormat,minDate:tzIndependentDate(e.groupConfigData.summary.block_from),maxDate:tzIndependentDate(e.groupConfigData.summary.block_to)},e.routingDateToOptions={dateFormat:t.jqDateFormat,minDate:tzIndependentDate(e.groupConfigData.summary.block_from),maxDate:tzIndependentDate(e.groupConfigData.summary.block_to)})};e.onRouteDateChange=function(){e.fetchAvailableChargeCodes()},e.$on("PAYMENT_SAVE_CARD_SUCCESS",function(){p(),e.selectedPayment=""}),e.$on("PAYMENT_TYPE_CHANGED",function(){setTimeout(p,300)}),e.shouldShowSplitChargeAccompanyGuests=function(){return"GROUP_DEFAULT_BILLING"===e.billingEntity}}]),sntRover.controller("rvRoutesAddPaymentCtrl",["$scope","$rootScope","$filter","ngDialog","RVPaymentSrv",function(e,t,a,i,n){BaseCtrl.call(this,e),e.cardsList=[],e.addmode=!(e.cardsList.length>0),e.hideCancelCard=!0,e.isManual=!1;var r="";try{HostedForm.setMerchant(t.MLImerchantId)}catch(e){}e.cancelClicked=function(){e.showPaymentList(),e.saveData.payment_type="",e.saveData.payment_type_description="",e.showCCPage=!1,e.swippedCard=!1,e.addmode=!1,e.saveData.newPaymentFormVisible=!1,e.$emit("CANCELLED_PAYMENT")};var s={preventDefault:!1};e.setScroller("newpaymentview",s),e.$on("showaddpayment",function(t){e.refreshScroller("newpaymentview")}),e.fetchAvailablePaymentTypes=function(){var t=function(t){var a=null;e.creditCardTypes=[],e.availablePaymentTypes=t,e.ccPaymentDetails={};for(var i in t)"CC"===t[i].name&&(e.ccPaymentDetails=t[i],e.creditCardTypes=t[i].values);"RESERVATION"===e.selectedEntity.entity_type&&(a=_.findIndex(e.availablePaymentTypes,{name:"DB"}),a!==-1&&e.availablePaymentTypes.splice(a,1)),e.$parent.$emit("hideLoader"),e.refreshScroller("newpaymentview")},a=function(t){e.$parent.$emit("hideLoader"),e.$emit("displayErrorMessage",t)},i=!0;"COMPANY_CARD"!==e.selectedEntity.entity_type&&"TRAVEL_AGENT"!==e.selectedEntity.entity_type||!e.selectedEntity.is_allow_direct_debit||(i=e.selectedEntity.is_allow_direct_debit);var r={direct_bill:i};e.invokeApi(n.renderPaymentScreen,r,t,a)},e.fetchAvailablePaymentTypes(),e.savePaymentDetails=function(){if("CC"!==e.saveData.payment_type)return void e.savePayment();var t={};t.cardNumber=e.saveData.card_number,t.cardSecurityCode=e.saveData.cvv,t.cardExpiryMonth=e.saveData.card_expiry_month,t.cardExpiryYear=e.saveData.card_expiry_year;var a=function(t){e.$emit("hideLoader"),"ok"===t.status?(r=t.session,e.savePayment()):e.$emit("displayErrorMessage",["There is a problem with your credit card"]),e.$apply()};try{HostedForm.updateSession(t,a),e.$emit("showLoader")}catch(t){e.$emit("displayErrorMessage",["There was a problem connecting to the payment gateway."])}},e.savePayment=function(){e.saveData.reservation_id=e.reservationData.reservation_id,e.saveData.session_id=r,e.saveData.mli_token=e.saveData.card_number.substr(e.saveData.card_number.length-4),e.saveData.card_expiry=e.saveData.card_expiry_month+"/"+e.saveData.card_expiry_year,e.paymentAdded(e.saveData)},e.selectPaymentType=function(){for(var t=0;t<e.availablePaymentTypes.length;t++)e.availablePaymentTypes[t].name===e.saveData.payment_type&&(e.saveData.payment_type_description=e.availablePaymentTypes[t].description);e.refreshScroller("newpaymentview"),e.showCCPage="CC"===e.saveData.payment_type,e.swippedCard="CC"===e.saveData.payment_type,e.saveData.newPaymentFormVisible="CC"===e.saveData.payment_type,e.addmode="CC"===e.saveData.payment_type&&0===e.cardsList.length},e.changeOnsiteCallIn=function(){e.$emit("CHANGE_IS_MANUAL",e.isManual),e.showCCPage=!("CC"!==e.saveData.payment_type||!e.isManual),e.swippedCard=!("CC"!==e.saveData.payment_type||!e.isManual),e.addmode="CC"===e.saveData.payment_type&&0===e.cardsList.length,e.saveData.newPaymentFormVisible=!("CC"!==e.saveData.payment_type||!e.isManual),e.$broadcast("REFRESH_IFRAME")},e.$on("TOKEN_CREATED",function(t,a){e.showCCPage=!1,e.swippedCard=!1,e.addmode=!1,e.saveData.newPaymentFormVisible=!1,e.paymentAdded(a)}),e.$on("SUCCESS_LINK_PAYMENT",function(t,a){e.showCCPage=!1,e.swippedCard=!1,e.addmode=!1,e.saveData.newPaymentFormVisible=!1,console.log(a),e.onSaveNewCard(a)}),e.$on("RENDER_DATA_ON_BILLING_SCREEN",function(t,a){e.showCCPage=!0,e.addmode=!0,e.swippedCard=!0,e.saveData.newPaymentFormVisible=!0,e.$apply(),e.$broadcast("RENDER_SWIPED_DATA",a)}),e.$on("SWIPED_DATA_TO_SAVE",function(t,a){e.showCCPage=!1,e.swippedCard=!1,e.addmode=!1,e.saveData.newPaymentFormVisible=!1,e.paymentAddedThroughMLISwipe(a)}),e.$on("UPDATE_FLAG",function(){e.showCCPage=!1,e.swippedCard=!1}),e.$on("PAYMENT_TYPE_CHANGED",function(t,a){e.saveData.payment_type=a,e.selectPaymentType()}),e.$on("PAYMENT_ACTION_CANCELLED",e.cancelClicked),function(){e.billNumber=e.getSelectedBillNumber(),e.$watch("selectedEntity.to_bill",function(){e.billNumber=e.getSelectedBillNumber()}),e.$watch("bills",function(){e.billNumber=e.getSelectedBillNumber()})}()}]),sntRover.controller("rvSelectEntityCtrl",["$scope","$rootScope","$filter","RVBillinginfoSrv","ngDialog","RVCompanyCardSearchSrv","RVSearchSrv","$timeout",function(e,t,a,i,n,r,s,o){BaseCtrl.call(this,e),e.textInQueryBox="",e.isReservationActive=!0,e.results.accounts=[],e.results.posting_accounts=[],e.results.reservations=[],e.showPagination=!1;var l={click:!0,preventDefault:!1};e.setScroller("cards_search_scroller",l),e.setScroller("res_search_scroller",l),e.refreshScroller("cards_search_scroller"),e.refreshScroller("res_search_scroller"),e.paginationData={page:1,perPage:10,totalCount:0},e.paginationAccData={page:1,perPage:10,totalCount:0};var l={preventDefault:!1};e.setScroller("entities",l),setTimeout(function(){e.refreshScroller("entities")},500),e.hasArNumber=!1;var c=function(e){return!t.isSingleDigitSearch||isNaN(e)};e.filterArAccounts=function(){e.hasArNumber=!e.hasArNumber,e.paginationAccData={page:1,perPage:10,totalCount:0};var t={page:e.paginationAccData.page,per_page:e.paginationAccData.perPage,query:e.textInQueryBox.trim(),is_from_bill_routing:!0,has_ar_number:e.hasArNumber};e.invokeApi(r.fetch,t,d)},e.queryEntered=function(){!e.hasArNumber&&e.textInQueryBox.length<3&&c(e.textInQueryBox)?(e.results.accounts=[],e.results.posting_accounts=[],e.results.reservations=[]):e.isReservationActive?g():u();var t=e.textInQueryBox;e.textInQueryBox=t.charAt(0).toUpperCase()+t.slice(1)},e.clearResults=function(){e.textInQueryBox="",e.showPagination=!1,e.isReservationActive=!0,e.refreshScroller("entities")};var d=function(t){e.$emit("hideLoader"),e.results.accounts=[],e.results.accounts=t.accounts,e.results.posting_accounts=[],e.results.posting_accounts=t.posting_accounts,e.totalCards=angular.copy(t.total_count),e.paginationAccData.totalCount=t.total_count,e.showPagination=e.isShowPagination(),o(function(){e.$broadcast("updatePagination","ACC_PAGINATION")},100),setTimeout(function(){e.refreshScroller("cards_search_scroller")},750)},u=function(t){e.paginationAccData.page=t||1;var a={page:e.paginationAccData.page,per_page:e.paginationAccData.perPage,query:e.textInQueryBox.trim(),is_from_bill_routing:!0,has_ar_number:e.hasArNumber};e.invokeApi(r.fetch,a,d)};e.excludeActivereservationFromsSearch=function(){for(var t=[],a=0;a<e.results.reservations.length;a++)e.results.reservations[a].id===e.reservationData.reservation_id||"CHECKING_IN"!==e.results.reservations[a].reservation_status&&"CHECKEDIN"!==e.results.reservations[a].reservation_status&&"CHECKING_OUT"!==e.results.reservations[a].reservation_status&&"RESERVED"!==e.results.reservations[a].reservation_status||t.push(e.results.reservations[a]);e.results.reservations=t};var _=function(t){e.$emit("hideLoader"),e.results.reservations=[],e.results.reservations=t.results,e.paginationData.totalCount=t.total_count,e.totalReservation=t.total_count,e.showPagination=e.isShowPagination(),"TRAVEL_AGENT_DEFAULT_BILLING"!==e.billingEntity&&"COMPANY_CARD_DEFAULT_BILLING"!==e.billingEntity&&"GROUP_DEFAULT_BILLING"!==e.billingEntity&&"ALLOTMENT_DEFAULT_BILLING"!==e.billingEntity&&e.excludeActivereservationFromsSearch(),o(function(){e.$broadcast("updatePagination","RES_PAGINATION")},100),setTimeout(function(){e.refreshScroller("res_search_scroller")},750)},p=function(t){e.$emit("hideLoader"),e.errorMessage=t},g=function(){m()},m=function(a){e.paginationData.page=a||1;var i={page:e.paginationData.page,per_page:e.paginationData.perPage,is_from_bill_routing:!0,query:e.textInQueryBox.trim()};i.is_from_bill_routing=!0,t.isSingleDigitSearch&&!isNaN(e.textInQueryBox)&&e.textInQueryBox.length<3&&(i.room_search=!0),e.invokeApi(s.fetchReservationForBillingInfo,i,_,p)};e.toggleClicked=function(t){e.isReservationActive=t,e.isReservationActive?g():u()},e.reservationPaginationObj={id:"RES_PAGINATION",api:m,perPage:e.paginationData.perPage},e.accountsPaginationObj={id:"ACC_PAGINATION",api:u,perPage:e.paginationAccData.perPage},e.isShowPagination=function(){e.showPagination=!1;var t=e.results;if(e.isReservationActive)return t.reservations&&e.textInQueryBox&&t.reservations.length<e.totalReservation&&t.reservations.length>0;var a=t.accounts.length+t.posting_accounts.length;return(t.accounts||t.posting_accounts)&&e.textInQueryBox&&a<e.totalCards&&a>0}}]),sntRover.controller("RVValidateEmailOnPaymentCtrl",["$scope","$state","ngDialog","RVContactInfoSrv",function(e,t,a,i){BaseCtrl.call(this,e),e.saveData={},e.saveData.email="",e.cancelEmailUpdate=function(){a.close()},e.submitAndTriggerEmail=function(){return""!==e.saveData.email&&void e.$emit("AUTO_TRIGGER_EMAIL_AFTER_PAYMENT",e.saveData.email)}}]),sntRover.controller("RVVoidBillPopupCtrl",["$scope","$timeout","RVBillCardSrv",function(e,t,a){BaseCtrl.call(this,e),e.voidData={},e.voidBill=function(t){var i=function(t){e.$emit("VOID_BILL_GENERATED",t.bills)},n={bill_id:e.isFromAccounts?e.transactionsDetails.bills[e.currentActiveBill].bill_id:e.reservationBillData.bills[e.currentActiveBill].bill_id,data:{void_type:t,void_reason:e.voidData.reason}},r={params:n,successCallBack:i};e.callAPI(a.generateVoidBill,r)}}]),sntRover.controller("rvBillingInfoAccountsMainCtrl",["$scope","$rootScope","$filter","RVBillinginfoSrv","ngDialog",function(e,t,a,i,n){BaseCtrl.call(this,e),e.isInAddRoutesMode=!1,e.isInitialPage=!0,e.isEntitySelected=!1,e.selectedEntity={},e.results={},e.bills=[],e.isReloadNeeded=!1,e.routes=[],e.errorMessage="",e.isInitialPage=!0,e.selectedEntityChanged=!1,e.saveData={},e.saveData.payment_type="",e.saveData.payment_type_description="",e.saveData.newPaymentFormVisible=!1,e.shouldShowWaiting=!1,e.$on("UPDATE_SHOULD_SHOW_WAITING",function(t,a){e.shouldShowWaiting=a}),e.closeDialog=function(){n.close(),e.$emit("routingPopupDismissed")},e.dimissLoaderAndDialog=function(){e.$emit("hideLoader"),e.closeDialog()},e.getHeaderButtonLabel=function(){return e.isInitialPage?a("translate")("ADD_ROUTES_LABEL"):a("translate")("ALL_ROUTES_LABEL")},e.setReloadOption=function(t){e.isReloadNeeded=t};var r=function(){for(var t=!1,a=dclone(e.routes,[]),i=0;i<a.length;i++)if("GROUP"===a[i].entity_type||"HOUSE"===a[i].entity_type||"ALLOTMENT"===a[i].entity_type)return t=!0;return t};e.headerButtonClicked=function(){e.isInAddRoutesMode=!0,e.isEntitySelected=!1,e.isInitialPage=!e.isInitialPage,"ALLOTMENT_DEFAULT_BILLING"!==e.billingEntity&&(s(),o()),e.isInitialPage&&e.isReloadNeeded&&(e.isReloadNeeded=!1,e.fetchRoutes()),e.isInitialPage&&l()},e.deSelectEntity=function(){e.isEntitySelected=!1},e.selectEntity=function(t,a){if("ALLOTMENT_DEFAULT_BILLING"!==e.billingEntity&&(e.routes&&e.routes[t]&&e.routes[t].from_date&&(e.arrivalDate=e.routes[t].from_date,e.departureDate=e.routes[t].to_date),o()),e.errorMessage="",e.isEntitySelected=!0,e.isInAddRoutesMode=!1,e.isInitialPage=!1,e.selectedEntityChanged=!0,"ATTACHED_ENTITY"===a||"ROUTES"===a)e.selectedEntity=e.routes[t],e.selectedEntity.is_new="ATTACHED_ENTITY"===a,"RESERVATION"!==e.selectedEntity.entity_type&&(e.selectedEntity.guest_id=null),"GROUP"===e.selectedEntity.entity_type||"HOUSE"===e.selectedEntity.entity_type||"ALLOTMENT"===e.selectedEntity.entity_type||(e.selectedEntity.images[0].guest_image=e.selectedEntity.images[0].image);else if("RESERVATIONS"===a){var i=e.results.reservations[t];e.selectedEntity={attached_charge_codes:[],attached_billing_groups:[],images:i.images,reservation_status:i.reservation_status,is_opted_late_checkout:i.is_opted_late_checkout,name:i.firstname+" "+i.lastname,entity_type:"RESERVATION",has_accompanying_guests:i.images.length>1,bill_no:"",is_new:!0,credit_card_details:{}},"ALLOTMENT_DEFAULT_BILLING"===e.billingEntity?e.selectedEntity=_.extend(e.selectedEntity,{id:e.allotmentId,allotment_id:e.allotmentId,charge_routes_recipient:{id:i.id,type:"RESERVATION"}}):e.selectedEntity=_.extend(e.selectedEntity,{id:i.id})}else if("ACCOUNT"===a){var i=e.results.accounts[t];e.selectedEntity={id:i.id,name:i.account_name,bill_no:"",images:[{is_primary:!0,guest_image:i.company_logo}],attached_charge_codes:[],attached_billing_groups:[],is_new:!0,selected_payment:"",credit_card_details:{}},"ALLOTMENT_DEFAULT_BILLING"===e.billingEntity&&(e.selectedEntity=_.extend(e.selectedEntity,{id:e.allotmentId,allotment_id:e.allotmentId,charge_routes_recipient:{id:i.id,type:"ACCOUNT"}})),"COMPANY"===i.account_type?e.selectedEntity.entity_type="COMPANY_CARD":"TRAVELAGENT"===i.account_type&&(e.selectedEntity.entity_type="TRAVEL_AGENT")}else if("GROUP"===a||"HOUSE"===a)if(r())e.errorMessage=["Routing to account already exists for this reservation. Please edit or remove existing routing to add new."],e.isEntitySelected=!1,e.isInitialPage=!0;else{var i=e.results.posting_accounts[t];e.selectedEntity={id:i.id,name:i.account_name,bill_no:"",attached_charge_codes:[],attached_billing_groups:[],is_new:!0,selected_payment:"",credit_card_details:{},entity_type:i.account_type},"ALLOTMENT_DEFAULT_BILLING"===e.billingEntity&&(e.selectedEntity=_.extend(e.selectedEntity,{id:e.allotmentId,allotment_id:e.allotmentId,charge_routes_recipient:{id:i.id,type:"POSTING_ACCOUNT"}}))}},e.selectAttachedEntity=function(t,a){e.errorMessage="",e.isEntitySelected=!0,e.isInitialPage=!1,e.selectedEntity={bill_no:"",has_accompanying_guests:!1,attached_charge_codes:[],attached_billing_groups:[],is_new:!0,credit_card_details:{}},"TRAVEL_AGENT_DEFAULT_BILLING"!==e.billingEntity&&"COMPANY_CARD_DEFAULT_BILLING"!==e.billingEntity&&"GROUP_DEFAULT_BILLING"!==e.billingEntity&&"ALLOTMENT_DEFAULT_BILLING"!==e.billingEntity&&(e.selectedEntity.reservation_status=e.reservationData.reservation_status,e.selectedEntity.is_opted_late_checkout=e.reservationData.is_opted_late_checkout),"GUEST"===a?(e.selectedEntity.id=e.reservationData.reservation_id,e.selectedEntity.guest_id=e.attachedEntities.primary_guest_details.id,e.selectedEntity.name=e.attachedEntities.primary_guest_details.name,e.selectedEntity.images=[{is_primary:!0,guest_image:e.attachedEntities.primary_guest_details.avatar}],e.selectedEntity.entity_type="RESERVATION"):"ACCOMPANY_GUEST"===a?(e.selectedEntity.id=e.reservationData.reservation_id,e.selectedEntity.guest_id=e.attachedEntities.accompanying_guest_details[t].id,e.selectedEntity.name=e.attachedEntities.accompanying_guest_details[t].name,e.selectedEntity.images=[{is_primary:!1,guest_image:e.attachedEntities.accompanying_guest_details[t].avatar}],e.selectedEntity.has_accompanying_guests=!0,e.selectedEntity.entity_type="RESERVATION"):"COMPANY_CARD"===a?(e.selectedEntity.id=e.attachedEntities.company_card.id,e.selectedEntity.name=e.attachedEntities.company_card.name,e.selectedEntity.images=[{is_primary:!0,guest_image:e.attachedEntities.company_card.logo}],e.selectedEntity.entity_type="COMPANY_CARD"):"TRAVEL_AGENT"===a?(e.selectedEntity.id=e.attachedEntities.travel_agent.id,e.selectedEntity.name=e.attachedEntities.travel_agent.name,e.selectedEntity.images=[{is_primary:!0,guest_image:e.attachedEntities.travel_agent.logo}],e.selectedEntity.entity_type="TRAVEL_AGENT"):"GROUP"===a||"HOUSE"===a?r()?(e.errorMessage=["Routing to account already exists for this reservation. Please edit or remove existing routing to add new."],e.isEntitySelected=!1,e.isInitialPage=!0):(e.selectedEntity.id=e.attachedEntities.posting_account.id,e.selectedEntity.name=e.attachedEntities.posting_account.name,e.selectedEntity.entity_type=a):"ALLOTMENT"===a&&(r()?(e.errorMessage=["Routing to account already exists for this reservation. Please edit or remove existing routing to add new."],e.isEntitySelected=!1,e.isInitialPage=!0):(e.allotmentId=e.attachedEntities.posting_account.id,e.selectedEntity.id=e.allotmentId,e.selectedEntity.allotment_id=e.allotmentId,e.selectedEntity.name=e.attachedEntities.posting_account.name,e.selectedEntity.entity_type=a))},e.getGuestStatusMapped=function(e,t){var a="";return t&&"CHECKING_OUT"===e?a="late-check-out":("RESERVED"===e?a="arrival":"CHECKING_IN"===e?a="check-in":"CHECKEDIN"===e?a="inhouse":"CHECKEDOUT"===e?a="departed":"CHECKING_OUT"===e?a="check-out":"CANCELED"===e?a="cancel":"NOSHOW"!==e&&"NOSHOW_CURRENT"!==e||(a="no-show"),a)},e.getEntityRole=function(e){return"RESERVATION"!==e.entity_type||e.has_accompanying_guests?"RESERVATION"===e.entity_type?"accompany":"TRAVEL_AGENT"===e.entity_type?"travel-agent":"COMPANY_CARD"===e.entity_type?"company":void 0:"guest"},e.getEntityIconClass=function(e){return"RESERVATION"===e.entity_type&&e.has_accompanying_guests?"accompany":"RESERVATION"===e.entity_type||"COMPANY_CARD"===e.entity_type?"":"TRAVEL_AGENT"===e.entity_type?"icons icon-travel-agent":void 0},e.escapeNull=function(e,t){return escapeNull(e,t)},e.fetchRoutes=function(){var t=function(t){e.routes=t,e.fetchEntities()},a=function(t){e.fetchEntities(),e.errorMessage=t};e.invokeApi(i.fetchRoutes,e.reservationData.reservation_id,t,a)};var s=function(){e.reservation&&(e.arrivalDate=e.reservation.reservation_card.arrival_date,e.departureDate=e.reservation.reservation_card.departure_date,e.arrivalDate=t.businessDate>e.arrivalDate?t.businessDate:e.arrivalDate)},o=function(){e.routeDates={from:e.arrivalDate,to:e.departureDate},e.reservation&&(e.routingDateFromOptions={dateFormat:"dd-mm-yy",minDate:tzIndependentDate(e.reservation.reservation_card.arrival_date),maxDate:tzIndependentDate(e.reservation.reservation_card.departure_date)},e.routingDateToOptions={dateFormat:"dd-mm-yy",minDate:tzIndependentDate(e.reservation.reservation_card.arrival_date),maxDate:tzIndependentDate(e.reservation.reservation_card.departure_date)})};e.fetchEntities=function(){var t=function(t){e.attachedEntities=t,e.$parent.$emit("hideLoader")},a=function(t){e.$emit("hideLoader"),e.errorMessage=t};e.invokeApi(i.fetchAttachedCards,e.reservationData.reservation_id,t,a)},e.saveRoute=function(){t.$broadcast("routeSaveClicked")},e.$on("displayErrorMessage",function(t,a){e.errorMessage=a}),e.handleCloseDialog=function(){e.$emit("HANDLE_MODAL_OPENED"),e.closeDialog(),e.billingData&&(e.billingData.billingInfoTitle=e.routes.length>0?a("translate")("BILLING_INFO_TITLE"):a("translate")("ADD_BILLING_INFO_TITLE"))},e.deleteDefaultRouting=function(){var t=function(t){e.$emit("hideLoader"),e.$emit("BILLINGINFODELETED"),e.closeDialog()},a=function(t){e.$emit("hideLoader"),e.$emit("displayErrorMessage",t)},n={};n.id=e.contactInformation.id,e.invokeApi(i.deleteDefaultRouting,n,t,a)},e.deleteBillingInfo=function(){e.deleteDefaultRouting()};var l=function(){void 0===e.attachedEntities?(e.isInitialPage=!0,e.fetchRoutes(),e.attachedEntities=[]):"TRAVEL_AGENT_DEFAULT_BILLING"===e.billingEntity?e.selectAttachedEntity("","TRAVEL_AGENT"):"COMPANY_CARD_DEFAULT_BILLING"===e.billingEntity?e.selectAttachedEntity("","COMPANY_CARD"):"GROUP_DEFAULT_BILLING"===e.billingEntity?e.selectAttachedEntity("","GROUP"):"ALLOTMENT_DEFAULT_BILLING"===e.billingEntity?e.selectAttachedEntity("","ALLOTMENT"):(e.isInitialPage=!0,e.fetchRoutes(),e.attachedEntities=[])};l()}]),sntRover.controller("rvBillingInfoAccountsRouteDetailsCtrl",["$scope","$rootScope","$filter","RVBillinginfoSrv","ngDialog",function(e,t,a,i,n){BaseCtrl.call(this,e),e.isInAddRoutesMode=!1,e.isInitialPage=!0,e.isEntitySelected=!1,e.selectedEntity={},e.results={},e.bills=[],e.isReloadNeeded=!1,e.routes=[],e.errorMessage="",e.isInitialPage=!0,e.selectedEntityChanged=!1,e.saveData={},e.saveData.payment_type="",e.saveData.payment_type_description="",e.saveData.newPaymentFormVisible=!1,e.shouldShowWaiting=!1,e.$on("UPDATE_SHOULD_SHOW_WAITING",function(t,a){e.shouldShowWaiting=a}),e.closeDialog=function(){n.close(),e.$emit("routingPopupDismissed")},e.dimissLoaderAndDialog=function(){e.$emit("hideLoader"),e.closeDialog()},e.getHeaderButtonLabel=function(){return e.isInitialPage?a("translate")("ADD_ROUTES_LABEL"):a("translate")("ALL_ROUTES_LABEL")},e.setReloadOption=function(t){e.isReloadNeeded=t};var r=function(){for(var t=!1,a=dclone(e.routes,[]),i=0;i<a.length;i++)if("GROUP"===a[i].entity_type||"HOUSE"===a[i].entity_type||"ALLOTMENT"===a[i].entity_type)return t=!0;return t};e.headerButtonClicked=function(){e.isInAddRoutesMode=!0,e.isEntitySelected=!1,e.isInitialPage=!e.isInitialPage,"ALLOTMENT_DEFAULT_BILLING"!==e.billingEntity&&(s(),o()),e.isInitialPage&&e.isReloadNeeded&&(e.isReloadNeeded=!1,e.fetchRoutes()),e.isInitialPage&&l()},e.deSelectEntity=function(){e.isEntitySelected=!1},e.selectEntity=function(t,a){if("ALLOTMENT_DEFAULT_BILLING"!==e.billingEntity&&(e.routes&&e.routes[t]&&e.routes[t].from_date&&(e.arrivalDate=e.routes[t].from_date,e.departureDate=e.routes[t].to_date),o()),e.errorMessage="",e.isEntitySelected=!0,e.isInAddRoutesMode=!1,e.isInitialPage=!1,e.selectedEntityChanged=!0,"ATTACHED_ENTITY"===a||"ROUTES"===a)e.selectedEntity=e.routes[t],
e.selectedEntity.is_new="ATTACHED_ENTITY"===a,"RESERVATION"!==e.selectedEntity.entity_type&&(e.selectedEntity.guest_id=null),"GROUP"===e.selectedEntity.entity_type||"HOUSE"===e.selectedEntity.entity_type||"ALLOTMENT"===e.selectedEntity.entity_type||(e.selectedEntity.images[0].guest_image=e.selectedEntity.images[0].image);else if("RESERVATIONS"===a){var i=e.results.reservations[t];e.selectedEntity={attached_charge_codes:[],attached_billing_groups:[],images:i.images,reservation_status:i.reservation_status,is_opted_late_checkout:i.is_opted_late_checkout,name:i.firstname+" "+i.lastname,entity_type:"RESERVATION",has_accompanying_guests:i.images.length>1,bill_no:"",is_new:!0,credit_card_details:{}},"ALLOTMENT_DEFAULT_BILLING"===e.billingEntity?e.selectedEntity=_.extend(e.selectedEntity,{id:e.allotmentId,allotment_id:e.allotmentId,charge_routes_recipient:{id:i.id,type:"RESERVATION"}}):e.selectedEntity=_.extend(e.selectedEntity,{id:i.id})}else if("ACCOUNT"===a){var i=e.results.accounts[t];e.selectedEntity={id:i.id,name:i.account_name,bill_no:"",images:[{is_primary:!0,guest_image:i.company_logo}],attached_charge_codes:[],attached_billing_groups:[],is_new:!0,selected_payment:"",credit_card_details:{}},"ALLOTMENT_DEFAULT_BILLING"===e.billingEntity&&(e.selectedEntity=_.extend(e.selectedEntity,{id:e.allotmentId,allotment_id:e.allotmentId,charge_routes_recipient:{id:i.id,type:"ACCOUNT"}})),"COMPANY"===i.account_type?e.selectedEntity.entity_type="COMPANY_CARD":"TRAVELAGENT"===i.account_type&&(e.selectedEntity.entity_type="TRAVEL_AGENT")}else if("GROUP"===a||"HOUSE"===a)if(r())e.errorMessage=["Routing to account already exists for this reservation. Please edit or remove existing routing to add new."],e.isEntitySelected=!1,e.isInitialPage=!0;else{var i=e.results.posting_accounts[t];e.selectedEntity={id:i.id,name:i.account_name,bill_no:"",attached_charge_codes:[],attached_billing_groups:[],is_new:!0,selected_payment:"",credit_card_details:{},entity_type:i.account_type},"ALLOTMENT_DEFAULT_BILLING"===e.billingEntity&&(e.selectedEntity=_.extend(e.selectedEntity,{id:e.allotmentId,allotment_id:e.allotmentId,charge_routes_recipient:{id:i.id,type:"POSTING_ACCOUNT"}}))}},e.selectAttachedEntity=function(t,a){e.errorMessage="",e.isEntitySelected=!0,e.isInitialPage=!1,e.selectedEntity={bill_no:"",has_accompanying_guests:!1,attached_charge_codes:[],attached_billing_groups:[],is_new:!0,credit_card_details:{}},"TRAVEL_AGENT_DEFAULT_BILLING"!==e.billingEntity&&"COMPANY_CARD_DEFAULT_BILLING"!==e.billingEntity&&"GROUP_DEFAULT_BILLING"!==e.billingEntity&&"ALLOTMENT_DEFAULT_BILLING"!==e.billingEntity&&(e.selectedEntity.reservation_status=e.reservationData.reservation_status,e.selectedEntity.is_opted_late_checkout=e.reservationData.is_opted_late_checkout),"GUEST"===a?(e.selectedEntity.id=e.reservationData.reservation_id,e.selectedEntity.guest_id=e.attachedEntities.primary_guest_details.id,e.selectedEntity.name=e.attachedEntities.primary_guest_details.name,e.selectedEntity.images=[{is_primary:!0,guest_image:e.attachedEntities.primary_guest_details.avatar}],e.selectedEntity.entity_type="RESERVATION"):"ACCOMPANY_GUEST"===a?(e.selectedEntity.id=e.reservationData.reservation_id,e.selectedEntity.guest_id=e.attachedEntities.accompanying_guest_details[t].id,e.selectedEntity.name=e.attachedEntities.accompanying_guest_details[t].name,e.selectedEntity.images=[{is_primary:!1,guest_image:e.attachedEntities.accompanying_guest_details[t].avatar}],e.selectedEntity.has_accompanying_guests=!0,e.selectedEntity.entity_type="RESERVATION"):"COMPANY_CARD"===a?(e.selectedEntity.id=e.attachedEntities.company_card.id,e.selectedEntity.name=e.attachedEntities.company_card.name,e.selectedEntity.images=[{is_primary:!0,guest_image:e.attachedEntities.company_card.logo}],e.selectedEntity.entity_type="COMPANY_CARD"):"TRAVEL_AGENT"===a?(e.selectedEntity.id=e.attachedEntities.travel_agent.id,e.selectedEntity.name=e.attachedEntities.travel_agent.name,e.selectedEntity.images=[{is_primary:!0,guest_image:e.attachedEntities.travel_agent.logo}],e.selectedEntity.entity_type="TRAVEL_AGENT"):"GROUP"===a||"HOUSE"===a?r()?(e.errorMessage=["Routing to account already exists for this reservation. Please edit or remove existing routing to add new."],e.isEntitySelected=!1,e.isInitialPage=!0):(e.selectedEntity.id=e.attachedEntities.posting_account.id,e.selectedEntity.name=e.attachedEntities.posting_account.name,e.selectedEntity.entity_type=a):"ALLOTMENT"===a&&(r()?(e.errorMessage=["Routing to account already exists for this reservation. Please edit or remove existing routing to add new."],e.isEntitySelected=!1,e.isInitialPage=!0):(e.allotmentId=e.attachedEntities.posting_account.id,e.selectedEntity.id=e.allotmentId,e.selectedEntity.allotment_id=e.allotmentId,e.selectedEntity.name=e.attachedEntities.posting_account.name,e.selectedEntity.entity_type=a))},e.getGuestStatusMapped=function(e,t){var a="";return t&&"CHECKING_OUT"===e?a="late-check-out":("RESERVED"===e?a="arrival":"CHECKING_IN"===e?a="check-in":"CHECKEDIN"===e?a="inhouse":"CHECKEDOUT"===e?a="departed":"CHECKING_OUT"===e?a="check-out":"CANCELED"===e?a="cancel":"NOSHOW"!==e&&"NOSHOW_CURRENT"!==e||(a="no-show"),a)},e.getEntityRole=function(e){return"RESERVATION"!==e.entity_type||e.has_accompanying_guests?"RESERVATION"===e.entity_type?"accompany":"TRAVEL_AGENT"===e.entity_type?"travel-agent":"COMPANY_CARD"===e.entity_type?"company":void 0:"guest"},e.getEntityIconClass=function(e){return"RESERVATION"===e.entity_type&&e.has_accompanying_guests?"accompany":"RESERVATION"===e.entity_type||"COMPANY_CARD"===e.entity_type?"":"TRAVEL_AGENT"===e.entity_type?"icons icon-travel-agent":void 0},e.escapeNull=function(e,t){return escapeNull(e,t)},e.fetchRoutes=function(){var t=function(t){e.routes=t,e.fetchEntities()},a=function(t){e.fetchEntities(),e.errorMessage=t};e.invokeApi(i.fetchRoutes,e.reservationData.reservation_id,t,a)};var s=function(){e.reservation&&(e.arrivalDate=e.reservation.reservation_card.arrival_date,e.departureDate=e.reservation.reservation_card.departure_date,e.arrivalDate=t.businessDate>e.arrivalDate?t.businessDate:e.arrivalDate)},o=function(){e.routeDates={from:e.arrivalDate,to:e.departureDate},e.reservation&&(e.routingDateFromOptions={dateFormat:"dd-mm-yy",minDate:tzIndependentDate(e.reservation.reservation_card.arrival_date),maxDate:tzIndependentDate(e.reservation.reservation_card.departure_date)},e.routingDateToOptions={dateFormat:"dd-mm-yy",minDate:tzIndependentDate(e.reservation.reservation_card.arrival_date),maxDate:tzIndependentDate(e.reservation.reservation_card.departure_date)})};e.fetchEntities=function(){var t=function(t){e.attachedEntities=t,e.$parent.$emit("hideLoader")},a=function(t){e.$emit("hideLoader"),e.errorMessage=t};e.invokeApi(i.fetchAttachedCards,e.reservationData.reservation_id,t,a)},e.saveRoute=function(){t.$broadcast("routeSaveClicked")},e.$on("displayErrorMessage",function(t,a){e.errorMessage=a}),e.handleCloseDialog=function(){e.$emit("HANDLE_MODAL_OPENED"),e.closeDialog(),e.billingData&&(e.billingData.billingInfoTitle=e.routes.length>0?a("translate")("BILLING_INFO_TITLE"):a("translate")("ADD_BILLING_INFO_TITLE"))},e.deleteDefaultRouting=function(){var t=function(t){e.$emit("hideLoader"),e.$emit("BILLINGINFODELETED"),e.closeDialog()},a=function(t){e.$emit("hideLoader"),e.$emit("displayErrorMessage",t)},n={};n.id=e.contactInformation.id,e.invokeApi(i.deleteDefaultRouting,n,t,a)},e.deleteBillingInfo=function(){e.deleteDefaultRouting()};var l=function(){void 0===e.attachedEntities?(e.isInitialPage=!0,e.fetchRoutes(),e.attachedEntities=[]):"TRAVEL_AGENT_DEFAULT_BILLING"===e.billingEntity?e.selectAttachedEntity("","TRAVEL_AGENT"):"COMPANY_CARD_DEFAULT_BILLING"===e.billingEntity?e.selectAttachedEntity("","COMPANY_CARD"):"GROUP_DEFAULT_BILLING"===e.billingEntity?e.selectAttachedEntity("","GROUP"):"ALLOTMENT_DEFAULT_BILLING"===e.billingEntity?e.selectAttachedEntity("","ALLOTMENT"):(e.isInitialPage=!0,e.fetchRoutes(),e.attachedEntities=[])};l()}]),sntRover.controller("rvBillingInfoAllotmentMainCtrl",["$scope","$rootScope","$filter","RVBillinginfoSrv","ngDialog",function(e,t,a,i,n){BaseCtrl.call(this,e),e.$on("UPDATE_SHOULD_SHOW_WAITING",function(t,a){e.shouldShowWaiting=a}),e.closeDialog=function(){n.close(),e.$emit("routingPopupDismissed")},e.dimissLoaderAndDialog=function(){e.$emit("hideLoader"),e.closeDialog()},e.setReloadOption=function(t){e.isReloadNeeded=t},e.deSelectEntity=function(){e.billingInfoFlags.isEntitySelected=!1},e.setSelectedEntity=function(t,a){e.errorMessage="","RESERVATIONS"===a?e.selectedEntity=_.extend(t,{id:e.allotmentId,allotment_id:e.allotmentId,charge_routes_recipient:{id:t.id,type:"RESERVATION"}}):"ACCOUNT"===a?e.selectedEntity=_.extend(t,{id:e.allotmentId,allotment_id:e.allotmentId,charge_routes_recipient:{id:t.id,type:"ACCOUNT"}}):"GROUP"!==a&&"HOUSE"!==a||(e.selectedEntity=_.extend(t,{id:e.allotmentId,allotment_id:e.allotmentId,charge_routes_recipient:{id:t.id,type:"POSTING_ACCOUNT"}}))},e.getEntityRole=function(e){return"RESERVATION"!==e.entity_type||e.has_accompanying_guests?"RESERVATION"===e.entity_type?"accompany":"TRAVEL_AGENT"===e.entity_type?"travel-agent":"COMPANY_CARD"===e.entity_type?"company":void 0:"guest"},e.getEntityIconClass=function(e){return"RESERVATION"===e.entity_type&&e.has_accompanying_guests?"accompany":"RESERVATION"===e.entity_type||"COMPANY_CARD"===e.entity_type?"":"TRAVEL_AGENT"===e.entity_type?"icons icon-travel-agent":void 0},e.escapeNull=function(e,t){return escapeNull(e,t)},e.isRoutingForPostingAccountExist=function(){for(var t=!1,a=dclone(e.routes,[]),i=0;i<a.length;i++)if("GROUP"===a[i].entity_type||"HOUSE"===a[i].entity_type||"ALLOTMENT"===a[i].entity_type)return t=!0;return t},e.saveRoute=function(){t.$broadcast("routeSaveClicked")},e.$on("displayErrorMessage",function(t,a){e.errorMessage=a}),e.handleCloseDialog=function(){e.$emit("HANDLE_MODAL_OPENED"),e.closeDialog(),e.billingData&&(e.billingData.billingInfoTitle=e.routes.length>0?a("translate")("BILLING_INFO_TITLE"):a("translate")("ADD_BILLING_INFO_TITLE"))},e.deleteDefaultRouting=function(){var t=function(t){e.$emit("hideLoader"),e.$emit("BILLINGINFODELETED"),e.closeDialog()},a=function(t){e.$emit("hideLoader"),e.$emit("displayErrorMessage",t)},n={};n.id=e.contactInformation.id,e.invokeApi(i.deleteDefaultRouting,n,t,a)},e.deleteBillingInfo=function(){e.deleteDefaultRouting()},e.setDefaultRoutingDates=function(){},e.setRoutingDateOptions=function(){};var r=function(){e.selectedEntity={},e.bills=[],e.routes=[],e.errorMessage="",e.allotmentId=e.allotmentConfigData.summary.allotment_id,e.searchResults={reservations:[],cards:[],posting_accounts:[]},e.billingInfoFlags={isEntitySelected:e.billingInformationPresent||!1,shouldShowWaiting:!1,isReloadNeeded:!1},e.saveData={payment_type:"",payment_type_description:"",newPaymentFormVisible:!1}};r()}]),sntRover.controller("rvBillingInfoAllotmentRouteDetailsCtrl",["$scope","$rootScope","$filter","RVBillinginfoSrv","rvPermissionSrv","RVGuestCardSrv","ngDialog","RVBillCardSrv","RVPaymentSrv","$q",function(e,t,a,i,n,r,s,o,l,c){BaseCtrl.call(this,e),e.editPaymentMethod=function(){e.oldPayment=e.renderAddedPayment,e.renderAddedPayment=null,e.paymentFlags.isAddPayment=!1},e.showPaymentList=function(){e.paymentFlags.isAddPayment=!1,e.refreshScroller("paymentList")},e.$on("CANCELLED_PAYMENT",function(){e.renderAddedPayment=e.oldPayment,e.refreshScroller("routeDetails")}),e.$on("REFRESH_ROUTE_DETAILS_SCROLLER",function(){e.refreshScroller("routeDetails")});var d=function(){var t=e.cardData.tokenDetails.isSixPayment?e.cardData.tokenDetails.expiry.substring(2,4)+" / "+e.cardData.tokenDetails.expiry.substring(0,2):e.cardData.cardDetails.expiryMonth+" / "+e.cardData.cardDetails.expiryYear;return t},u=function(){var t=e.cardData.tokenDetails.isSixPayment?e.cardData.tokenDetails.token_no.substr(e.cardData.tokenDetails.token_no.length-4):e.cardData.cardDetails.cardNumber.slice(-4);return t};e.paymentAdded=function(t){e.selectedEntity.selected_payment="",e.cardData=t,e.renderAddedPayment={},e.renderAddedPayment.payment_type="CC",e.isAddPayment=!1,e.showPayment=!0,e.renderAddedPayment.creditCardType=e.cardData.tokenDetails.isSixPayment?getSixCreditCardType(e.cardData.tokenDetails.card_type).toLowerCase():getCreditCardType(e.cardData.cardDetails.cardType).toLowerCase(),e.renderAddedPayment.cardExpiry=d(),e.renderAddedPayment.endingWith=u()},e.paymentAddedThroughMLISwipe=function(t){e.renderAddedPayment={},e.renderAddedPayment.payment_type="CC",e.swipedCardDataToSave=t,e.renderAddedPayment.creditCardType=t.cardType.toLowerCase(),e.renderAddedPayment.cardExpiry=t.cardExpiryMonth+"/"+t.cardExpiryYear,e.renderAddedPayment.endingWith=t.cardNumber.slice(-4)},e.showAddPayment=function(){if(t.isManualCCEntryEnabled)e.renderAddedPayment={creditCardType:"",cardExpiry:"",endingWith:"",payment_type:""},e.paymentFlags.isAddPayment=!0,e.paymentFlags.showPaymentDropDown=!0,e.paymentFlags.isShownExistingCCPayment=!1,e.$broadcast("showaddpayment"),e.refreshScroller("routeDetails");else{e.isManualCCEntryEnabled=!1;s.open({template:"/assets/partials/payment/rvPaymentModal.html",controller:"",scope:e})}},e.$on("SHOW_SWIPED_DATA_ON_BILLING_SCREEN",function(t,a){e.paymentFlags.isAddPayment=!0,e.$broadcast("showaddpayment"),setTimeout(function(){e.saveData.payment_type="CC",e.paymentFlags.showPaymentDropDown=!0,e.swippedCard=!0,e.$broadcast("RENDER_DATA_ON_BILLING_SCREEN",a),e.$digest()},2e3)}),e.$on("ngDialog.opened",function(t,a){e.ngDialogID=a[0].id}),e.closeDialog=function(){s.close(e.ngDialogID)};var p=function(t){void 0!==t.charge_routes_recipient&&("TRAVELAGENT"===t.type?t.type="TRAVEL_AGENT":"COMPANY"===t.type?t.type="COMPANY_CARD":t.posting_account_type?t.type=t.posting_account_type:(t.type=t.charge_routes_recipient.type,t.reservation_status=t.status,t.images&&(t.images[0].guest_image=t.images[0].image)),e.selectedEntity=_.extend(e.selectedEntity,t),e.selectedEntity.entity_type=t.type,e.attachedEntities=[e.selectedEntity]),e.selectedEntity.attached_billing_groups=t.billing_groups,t.credit_limit&&(e.selectedEntity.credit_limit=parseFloat(t.credit_limit).toFixed(2)),e.selectedEntity.reference_number=t.reference_number,e.selectedEntity.attached_charge_codes=t.attached_charge_codes,isEmptyObject(t.credit_card_details)||(e.renderAddedPayment=t.credit_card_details,e.renderAddedPayment.cardExpiry=t.credit_card_details.card_expiry,e.renderAddedPayment.endingWith=t.credit_card_details.card_number,e.renderAddedPayment.creditCardType=t.credit_card_details.card_code,e.saveData.payment_type=t.credit_card_details.payment_type,e.paymentFlags.isAddPayment=!1,"CC"!==t.credit_card_details.payment_type?e.paymentFlags.showPaymentDropDown=!0:(e.paymentFlags.showPaymentDropDown=!1,e.paymentFlags.isShownExistingCCPayment=!0))};e.fetchDefaultAccountRouting=function(){var t={};t.id=e.allotmentId,t.entity_type="ALLOTMENT",e.invokeApi(i.fetchDefaultAccountRouting,t,p)};var g=function(t){e.availableBillingGroups=t,0===t.length&&(e.isBillingGroup=!1)},m=function(t){e.$parent.$emit("hideLoader"),e.$emit("displayErrorMessage",t)};e.fetchAllBillingGroups=function(){e.invokeApi(i.fetchAllBillingGroups,"",g,m)};var h=function(t){e.availableChargeCodes=t},y=function(t){e.$parent.$emit("hideLoader"),e.$emit("displayErrorMessage",t)};e.fetchAllChargeCodes=function(){e.invokeApi(i.fetchAllChargeCodes,"",h,y)},e.escapeNull=function(e,t){return escapeNull(e,t)},e.$on("routeSaveClicked",function(t){e.saveRoute()}),e.saveRoute=function(){var t=(e.saveData,e.selectedEntity);return 0===t.attached_charge_codes.length&&0===t.attached_billing_groups.length?void e.$emit("displayErrorMessage",[a("translate")("ERROR_CHARGES_EMPTY")]):void(null===e.saveData.payment_type||""===e.saveData.payment_type||e.paymentFlags.isShownExistingCCPayment?v():e.savePayment())},e.saveSuccessCallback=function(t){e.$parent.$emit("hideLoader"),t.has_crossed_credit_limit?s.open({template:"/assets/partials/bill/rvBillingInfoCreditLimitExceededPopup.html",className:"",closeByDocument:!1,scope:e}):(e.$parent.$emit("BILLINGINFOADDED"),e.setReloadOption(!0),e.headerButtonClicked(),e.updateCardInfo(),e.$parent.$emit("REFRESH_BILLCARD_VIEW"))};var v=function(){var t=function(){e.$parent.$emit("hideLoader"),e.$parent.$emit("BILLINGINFOADDED"),s.close()},a=angular.copy(e.selectedEntity);a.entity_type="ALLOTMENT",a.allotment_id=e.allotmentId,e.invokeApi(i.saveAllotmentDefaultAccountRouting,a,t)};e.hasPermissionToEditCreditLimit=function(){return n.getPermissionValue("OVERWRITE_DIRECT_BILL_MAXIMUM_AMOUNT")};var f=function(){var t=e.cardData.tokenDetails.isSixPayment?e.passData.details.firstName+" "+e.passData.details.lastName:e.cardData.cardDetails.userName;return t},E=function(){var t=e.cardData.tokenDetails.isSixPayment?e.cardData.tokenDetails.expiry.substring(2,4):e.cardData.cardDetails.expiryMonth,a=e.cardData.tokenDetails.isSixPayment?e.cardData.tokenDetails.expiry.substring(0,2):e.cardData.cardDetails.expiryYear,i=t&&a?"20"+a+"-"+t+"-01":"";return i};e.savePayment=function(){e.saveSuccessCallback=function(t){e.$parent.$emit("hideLoader"),e.$parent.$emit("BILLINGINFOADDED")},e.errorCallback=function(t){e.$parent.$emit("hideLoader"),e.$emit("displayErrorMessage",t)},e.savePaymentToReservationOrAccount("allotment")},e.savePaymentToReservationOrAccount=function(a){var i=function(e){v()},n=function(t){e.$parent.$emit("hideLoader"),e.$emit("displayErrorMessage",t)},r=function(t){var a={token:t.token,is_swiped:!0};a.allotment_id=e.allotmentId,e.invokeApi(l.savePaymentDetails,a,i,n)};if("CC"===e.saveData.payment_type)if("sixpayments"!==t.paymentGateway||e.paymentFlags.sixIsManual)if(isEmptyObject(e.swipedCardDataToSave)){var s={add_to_guest_card:!1};s.allotment_id=e.allotmentId,s.payment_type=e.saveData.payment_type,creditCardType=e.cardData.tokenDetails.isSixPayment?getSixCreditCardType(e.cardData.tokenDetails.card_type).toLowerCase():getCreditCardType(e.cardData.cardDetails.cardType),s.token=e.cardData.tokenDetails.isSixPayment?e.cardData.tokenDetails.token_no:e.cardData.tokenDetails.session,s.card_name=f(),s.bill_number=e.getSelectedBillNumber(),s.card_expiry=E(),s.card_code=e.cardData.tokenDetails.isSixPayment?getSixCreditCardType(e.cardData.tokenDetails.card_type).toLowerCase():e.cardData.cardDetails.cardType,e.invokeApi(l.savePaymentDetails,s,i,n)}else{var s=e.swipedCardDataToSave;s.allotment_id=e.allotmentId,s.bill_number=e.getSelectedBillNumber(),s.payment_credit_type=e.swipedCardDataToSave.cardType,s.credit_card=e.swipedCardDataToSave.cardType,s.card_expiry="20"+e.swipedCardDataToSave.cardExpiryYear+"-"+e.swipedCardDataToSave.cardExpiryMonth+"-01",e.invokeApi(l.savePaymentDetails,s,i,n)}else{var s={};s.allotment_id=e.allotmentId,s.add_to_guest_card=!1,s.bill_number=e.getSelectedBillNumber(),e.$emit("UPDATE_SHOULD_SHOW_WAITING",!0),l.chipAndPinGetToken(s).then(function(t){e.$emit("UPDATE_SHOULD_SHOW_WAITING",!1),r(t)},function(t){e.errorMessage=t,e.$emit("UPDATE_SHOULD_SHOW_WAITING",!1)})}else{var s={payment_type:e.saveData.payment_type};s.allotment_id=e.allotmentId,s.bill_number=e.getSelectedBillNumber(),e.invokeApi(l.savePaymentDetails,s,i,n)}},e.$on("CHANGE_IS_MANUAL",function(t,a){e.paymentFlags.sixIsManual=a}),e.showAvailableCreditCard=function(){return!isEmptyObject(e.renderAddedPayment)&&!e.paymentFlags.isAddPayment&&!e.saveData.newPaymentFormVisible};var C=function(){var t=e.selectedEntity;null!==t.credit_card_details&&void 0!==t.credit_card_details&&t.credit_card_details.hasOwnProperty("payment_type_description")&&(e.renderAddedPayment=t.credit_card_details,e.renderAddedPayment.cardExpiry=t.credit_card_details.card_expiry,e.renderAddedPayment.endingWith=t.credit_card_details.card_number,e.renderAddedPayment.creditCardType=t.credit_card_details.card_code,e.paymentFlags.showPaymentDropDown=!1,e.paymentFlags.isShownExistingCCPayment=!0,setTimeout(function(){e.$broadcast("UPDATE_FLAG")},1e3))},D=function(){e.passData={},e.passData.details={firstName:"",lastName:""},e.setScroller("cardsList")},A=function(){var t={preventDefault:!1};e.setScroller("paymentList",t),e.setScroller("billingGroups",t),e.setScroller("chargeCodes",t),e.setScroller("routeDetails",t);var a={click:!0};e.setScroller("chargeCodesList",a),e.chargeCodesListDivHgt=250,e.chargeCodesListDivTop=0},I=function(){setTimeout(function(){e.refreshScroller("paymentList"),e.refreshScroller("billingGroups"),e.refreshScroller("chargeCodes"),e.refreshScroller("chargeCodesList"),e.refreshScroller("routeDetails")},500)},b=function(t){e.$emit("hideLoader")},S=function(t){e.$emit("hideLoader"),e.errorMessage=t},T=function(){var t=[];if(e.$emit("showLoader"),t.push(i.fetchAllBillingGroups("").then(g,m)),t.push(i.fetchAllChargeCodes("").then(h,y)),!e.selectedEntity.entity_type){var a={};a.id=e.allotmentId,a.entity_type="ALLOTMENT",t.push(i.fetchDefaultAccountRouting(a).then(p))}c.all(t).then(b,S)},R=function(){e.chargeCodeToAdd="",e.swipedCardDataToSave={},e.paymentFlags={isAddPayment:!1,showPaymentDropDown:!1,isShownExistingCCPayment:!1,sixIsManual:!1},C(),D(),T(),A(),I()};R()}]),sntRover.controller("rvBillingInfoCardsMainCtrl",["$scope","$rootScope","$filter","RVBillinginfoSrv","ngDialog","RVBillingInfoUtilSrv",function(e,t,a,i,n,r){BaseCtrl.call(this,e);var s=function(){e.selectedEntity={},e.errorMessage="",e.billingInfoFlags={shouldShowWaiting:!1,isReloadNeeded:!1,showChargeCodes:!1,isBillingGroup:!0},e.saveData={payment_type:"",payment_type_description:"",newPaymentFormVisible:!1},o()},o=function(){"TRAVEL_AGENT_DEFAULT_BILLING"===e.billingEntity?e.setSelectedEntity("TRAVEL_AGENT"):e.setSelectedEntity("COMPANY_CARD")};e.$on("UPDATE_SHOULD_SHOW_WAITING",function(t,a){e.billingInfoFlags.shouldShowWaiting=a}),e.closeDialog=function(){n.close()},e.setReloadOption=function(t){e.billingInfoFlags.isReloadNeeded=t},e.getEntityRole=function(e){return r.getEntityRole(e)},e.getEntityIconClass=function(e){return r.getEntityIconClass(e)},e.escapeNull=function(e,t){return escapeNull(e,t)},e.setSelectedEntity=function(t){e.errorMessage="",e.selectedEntity={attached_charge_codes:[],attached_billing_groups:[],is_new:!0,credit_card_details:{}},"COMPANY_CARD"===t?(e.selectedEntity.id=e.attachedEntities.company_card.id,e.selectedEntity.name=e.attachedEntities.company_card.name,e.selectedEntity.images=[{is_primary:!0,guest_image:e.attachedEntities.company_card.logo}],e.selectedEntity.entity_type="COMPANY_CARD",e.selectedEntity.is_allow_direct_debit=e.attachedEntities.company_card.is_allow_direct_debit):(e.selectedEntity.id=e.attachedEntities.travel_agent.id,e.selectedEntity.name=e.attachedEntities.travel_agent.name,e.selectedEntity.images=[{is_primary:!0,guest_image:e.attachedEntities.travel_agent.logo}],e.selectedEntity.entity_type="TRAVEL_AGENT",e.selectedEntity.is_allow_direct_debit=e.attachedEntities.travel_agent.is_allow_direct_debit)},e.saveRoute=function(){t.$broadcast("routeSaveClicked")},e.$on("displayErrorMessage",function(t,a){e.errorMessage=a}),e.deleteDefaultRouting=function(){var t=function(t){e.$emit("hideLoader"),e.$emit("BILLINGINFODELETED"),e.closeDialog()},a=function(t){e.$emit("hideLoader"),e.$emit("displayErrorMessage",t)},n={};n.id=e.contactInformation.id,e.invokeApi(i.deleteDefaultRouting,n,t,a)},s()}]),sntRover.controller("rvBillingInfoCardsRouteDetailsCtrl",["$scope","$rootScope","$filter","RVBillinginfoSrv","RVGuestCardSrv","ngDialog","RVBillCardSrv","RVPaymentSrv","rvPermissionSrv",function(e,t,a,i,n,r,s,o,l){BaseCtrl.call(this,e);var c=function(){e.chargeCodeToAdd="",e.swipedCardDataToSave={},e.paymentFlags={isAddPayment:!1,showPaymentDropDown:!1,isShownExistingCCPayment:!1,sixIsManual:!1},u(),_(),d(),p(),g()},d=function(){e.fetchAllChargeCodes(),e.fetchDefaultAccountRouting(),e.fetchAllBillingGroups()},u=function(){var t=e.selectedEntity;null!==t.credit_card_details&&void 0!==t.credit_card_details&&t.credit_card_details.hasOwnProperty("payment_type_description")&&(e.renderAddedPayment=t.credit_card_details,e.renderAddedPayment.cardExpiry=t.credit_card_details.card_expiry,e.renderAddedPayment.endingWith=t.credit_card_details.card_number,e.renderAddedPayment.creditCardType=t.credit_card_details.card_code,e.paymentFlags.showPaymentDropDown=!1,e.paymentFlags.isShownExistingCCPayment=!0,setTimeout(function(){e.$broadcast("UPDATE_FLAG")},1e3))},_=function(){e.passData={},e.passData.details={firstName:"",lastName:""},e.setScroller("cardsList")},p=function(){var t={preventDefault:!1};e.setScroller("paymentList",t),e.setScroller("billingGroups",t),e.setScroller("chargeCodes",t),e.setScroller("routeDetails",t);var a={click:!0};e.setScroller("chargeCodesList",a),e.chargeCodesListDivHgt=250,e.chargeCodesListDivTop=0},g=function(){setTimeout(function(){e.refreshScroller("paymentList"),e.refreshScroller("billingGroups"),e.refreshScroller("chargeCodes"),e.refreshScroller("chargeCodesList"),e.refreshScroller("routeDetails")},500)};e.editPaymentMethod=function(){e.oldPayment=e.renderAddedPayment,e.renderAddedPayment=null,e.paymentFlags.isAddPayment=!1},e.showPaymentList=function(){e.paymentFlags.isAddPayment=!1,e.refreshScroller("paymentList")},e.$on("CANCELLED_PAYMENT",function(){e.renderAddedPayment=e.oldPayment,e.refreshScroller("routeDetails")});var m=function(){var t=e.cardData.tokenDetails.isSixPayment?e.cardData.tokenDetails.expiry.substring(2,4)+" / "+e.cardData.tokenDetails.expiry.substring(0,2):e.cardData.cardDetails.expiryMonth+" / "+e.cardData.cardDetails.expiryYear;return t},h=function(){var t=e.cardData.tokenDetails.isSixPayment?e.cardData.tokenDetails.token_no.substr(e.cardData.tokenDetails.token_no.length-4):e.cardData.cardDetails.cardNumber.slice(-4);return t},y=function(){var t=e.cardData.tokenDetails.isSixPayment?e.passData.details.firstName+" "+e.passData.details.lastName:e.cardData.cardDetails.userName;return t},v=function(){var t=e.cardData,a=t.tokenDetails.isSixPayment?t.tokenDetails.expiry.substring(2,4):t.cardDetails.expiryMonth,i=t.tokenDetails.isSixPayment?t.tokenDetails.expiry.substring(0,2):t.cardDetails.expiryYear,n=a&&i?"20"+i+"-"+a+"-01":"";return n};e.paymentAdded=function(t){e.selectedEntity.selected_payment="",e.cardData=t,e.renderAddedPayment={},e.renderAddedPayment.payment_type="CC",e.paymentFlags.isAddPayment=!1,e.renderAddedPayment.creditCardType=e.cardData.tokenDetails.isSixPayment?getSixCreditCardType(e.cardData.tokenDetails.card_type).toLowerCase():getCreditCardType(e.cardData.cardDetails.cardType).toLowerCase(),e.renderAddedPayment.cardExpiry=m(),e.renderAddedPayment.endingWith=h()},e.paymentAddedThroughMLISwipe=function(t){e.renderAddedPayment={},e.renderAddedPayment.payment_type="CC",e.swipedCardDataToSave=t,e.renderAddedPayment.creditCardType=t.cardType.toLowerCase(),e.renderAddedPayment.cardExpiry=t.cardExpiryMonth+"/"+t.cardExpiryYear,e.renderAddedPayment.endingWith=t.cardNumber.slice(-4)},e.showAddPayment=function(){if(t.isManualCCEntryEnabled)e.renderAddedPayment={creditCardType:"",cardExpiry:"",endingWith:"",payment_type:""},e.paymentFlags.isAddPayment=!0,e.paymentFlags.showPaymentDropDown=!0,e.paymentFlags.isShownExistingCCPayment=!1,e.$broadcast("showaddpayment"),e.refreshScroller("routeDetails");else{e.isManualCCEntryEnabled=!1;r.open({template:"/assets/partials/payment/rvPaymentModal.html",controller:"",scope:e})}},e.$on("SHOW_SWIPED_DATA_ON_BILLING_SCREEN",function(t,a){e.paymentFlags.isAddPayment=!0,e.$broadcast("showaddpayment"),setTimeout(function(){e.saveData.payment_type="CC",e.paymentFlags.showPaymentDropDown=!0,e.swippedCard=!0,e.$broadcast("RENDER_DATA_ON_BILLING_SCREEN",a),e.$digest()},2e3)}),e.$on("ngDialog.opened",function(t,a){e.ngDialogID=a[0].id}),e.closeDialog=function(){r.close(e.ngDialogID)},e.fetchDefaultAccountRouting=function(){var t=function(t){e.selectedEntity.attached_billing_groups=t.billing_groups,e.selectedEntity.attached_charge_codes=t.attached_charge_codes,e.selectedEntity.reference_number=t.reference_number,e.selectedEntity.is_allow_direct_debit=t.is_allow_direct_debit,t.credit_limit&&(e.selectedEntity.credit_limit=parseFloat(t.credit_limit).toFixed(2)),isEmptyObject(t.credit_card_details)||(e.renderAddedPayment=t.credit_card_details,e.renderAddedPayment.cardExpiry=t.credit_card_details.card_expiry,e.renderAddedPayment.endingWith=t.credit_card_details.card_number,e.renderAddedPayment.creditCardType=t.credit_card_details.card_code,e.saveData.payment_type=t.credit_card_details.payment_type,e.paymentFlags.isAddPayment=!1,"CC"!==t.credit_card_details.payment_type?e.paymentFlags.showPaymentDropDown=!0:(e.paymentFlags.showPaymentDropDown=!1,e.paymentFlags.isShownExistingCCPayment=!0)),e.$parent.$emit("hideLoader")},a={id:e.selectedEntity.id,entity_type:e.selectedEntity.entity_type};e.invokeApi(i.fetchDefaultAccountRouting,a,t)},e.fetchAllBillingGroups=function(){var t=function(t){e.availableBillingGroups=t,0===t.length&&(e.isBillingGroup=!1),e.$parent.$emit("hideLoader")},a=function(t){e.$parent.$emit("hideLoader"),e.$emit("displayErrorMessage",t)};e.invokeApi(i.fetchAllBillingGroups,"",t,a)},e.fetchAllChargeCodes=function(){var t=function(t){e.availableChargeCodes=t},a=function(t){e.$parent.$emit("hideLoader"),e.$emit("displayErrorMessage",t)};e.invokeApi(i.fetchAllChargeCodes,"",t,a)},e.escapeNull=function(e,t){return escapeNull(e,t)},e.$on("routeSaveClicked",function(t){e.saveRoute()}),e.saveRoute=function(){return 0===e.selectedEntity.attached_charge_codes.length&&0===e.selectedEntity.attached_billing_groups.length?void e.$emit("displayErrorMessage",[a("translate")("ERROR_CHARGES_EMPTY")]):void(null===e.saveData.payment_type||""===e.saveData.payment_type||e.paymentFlags.isShownExistingCCPayment?f():e.savePayment())};var f=function(){var t=function(t){e.$parent.$emit("hideLoader"),t.has_crossed_credit_limit?E():(e.$parent.$emit("BILLINGINFOADDED"),r.close())},a=function(t){e.$parent.$emit("hideLoader"),e.$emit("displayErrorMessage",t)},n=angular.copy(e.selectedEntity);e.invokeApi(i.saveDefaultAccountRouting,n,t,a)};e.savePayment=function(){e.saveSuccessCallback=function(t){e.$parent.$emit("hideLoader"),e.$parent.$emit("BILLINGINFOADDED")},e.errorCallback=function(t){e.$parent.$emit("hideLoader"),e.$emit("displayErrorMessage",t)},e.savePaymentToReservationOrAccount()},e.savePaymentToReservationOrAccount=function(){e.errorCallback=function(t){e.$parent.$emit("hideLoader"),e.$emit("displayErrorMessage",t)};var a=function(t){e.$parent.$emit("hideLoader"),t.has_crossed_credit_limit?E():(e.$parent.$emit("BILLINGINFOADDED"),r.close())},n=function(t){e.$parent.$emit("hideLoader");var n=angular.copy(e.selectedEntity);e.invokeApi(i.saveDefaultAccountRouting,n,a,e.errorCallback)},s=function(t){var a={token:t.token,is_swiped:!0};a.account_id=e.selectedEntity.id,e.invokeApi(o.savePaymentDetails,a,n,e.errorCallback)};if("CC"===e.saveData.payment_type)if("sixpayments"!==t.paymentGateway||e.paymentFlags.sixIsManual)if(isEmptyObject(e.swipedCardDataToSave)){var l={add_to_guest_card:!1};l.account_id=e.selectedEntity.id,l.payment_type=e.saveData.payment_type,creditCardType=e.cardData.tokenDetails.isSixPayment?getSixCreditCardType(e.cardData.tokenDetails.card_type).toLowerCase():getCreditCardType(e.cardData.cardDetails.cardType),l.token=e.cardData.tokenDetails.isSixPayment?e.cardData.tokenDetails.token_no:e.cardData.tokenDetails.session,l.card_name=y(),l.card_expiry=v(),l.card_code=e.cardData.tokenDetails.isSixPayment?getSixCreditCardType(e.cardData.tokenDetails.card_type).toLowerCase():e.cardData.cardDetails.cardType,e.invokeApi(o.savePaymentDetails,l,n,e.errorCallback)}else{var l=e.swipedCardDataToSave;l.account_id=e.selectedEntity.id,l.payment_credit_type=e.swipedCardDataToSave.cardType,l.credit_card=e.swipedCardDataToSave.cardType,l.card_expiry="20"+e.swipedCardDataToSave.cardExpiryYear+"-"+e.swipedCardDataToSave.cardExpiryMonth+"-01",e.invokeApi(o.savePaymentDetails,l,n,e.errorCallback)}else{var l={};l.account_id=e.selectedEntity.id,l.add_to_guest_card=!1,e.$emit("UPDATE_SHOULD_SHOW_WAITING",!0),o.chipAndPinGetToken(l).then(function(t){
e.$emit("UPDATE_SHOULD_SHOW_WAITING",!1),s(t)},function(t){e.errorMessage=t,e.$emit("UPDATE_SHOULD_SHOW_WAITING",!1)})}else{var l={payment_type:e.saveData.payment_type};l.account_id=e.selectedEntity.id,e.invokeApi(o.savePaymentDetails,l,n,e.errorCallback)}};var E=function(){r.open({template:"/assets/partials/billingInformation/sharedPartials/rvBillingInfoCreditLimitExceededPopup.html",className:"",closeByDocument:!1,scope:e})};e.hasPermissionToEditCreditLimit=function(){return l.getPermissionValue("OVERWRITE_DIRECT_BILL_MAXIMUM_AMOUNT")},e.$on("CHANGE_IS_MANUAL",function(t,a){e.paymentFlags.sixIsManual=a}),e.showAvailableCreditCard=function(){return!isEmptyObject(e.renderAddedPayment)&&!e.paymentFlags.isAddPayment&&!e.saveData.newPaymentFormVisible},c()}]),sntRover.controller("rvBillingInfoReservationMainCtrl",["$scope","$rootScope","$filter","RVBillinginfoSrv","ngDialog","RVBillingInfoUtilSrv",function(e,t,a,i,n,r){BaseCtrl.call(this,e);var s=function(){e.attachedEntities=[],e.selectedEntity={},e.searchResults={reservations:[],cards:[],posting_accounts:[]},e.bills=[],e.routes=[],e.routeDates={},e.errorMessage="",e.billingInfoFlags={isInAddRoutesMode:!1,isInitialPage:!0,isEntitySelected:!1,shouldShowWaiting:!1,isReloadNeeded:!1,showChargeCodes:!1,isBillingGroup:!0},e.saveData={payment_type:"",payment_type_description:"",newPaymentFormVisible:!1},e.fetchRoutes()};e.$on("UPDATE_SHOULD_SHOW_WAITING",function(t,a){e.billingInfoFlags.shouldShowWaiting=a}),e.closeDialog=function(){n.close(),e.$emit("routingPopupDismissed")},e.dimissLoaderAndDialog=function(){e.$emit("hideLoader"),e.closeDialog()},e.setReloadOption=function(t){e.billingInfoFlags.isReloadNeeded=t},e.isRoutingForPostingAccountExist=function(){for(var t=!1,a=dclone(e.routes,[]),i=0;i<a.length;i++)if("GROUP"===a[i].entity_type||"HOUSE"===a[i].entity_type||"ALLOTMENT"===a[i].entity_type)return t=!0;return t},e.addNewRoute=function(){e.billingInfoFlags.isInAddRoutesMode=!0,e.billingInfoFlags.isEntitySelected=!1,e.billingInfoFlags.isInitialPage=!1},e.navigateToInitialPage=function(){e.billingInfoFlags.isInitialPage=!0,e.billingInfoFlags.isReloadNeeded&&(e.billingInfoFlags.isReloadNeeded=!1,e.fetchRoutes()),s()},e.deSelectEntity=function(){e.billingInfoFlags.isEntitySelected=!1},e.setSelectedEntity=function(t){e.selectedEntity=t},e.getGuestStatusMapped=function(e,t){return r.getGuestStatusMapped(e,t)},e.getEntityRole=function(e){return r.getEntityRole(e)},e.getEntityIconClass=function(e){return r.getEntityIconClass(e)},e.escapeNull=function(e,t){return escapeNull(e,t)},e.fetchRoutes=function(){var t=function(t){e.routes=t,e.fetchEntities()},a=function(t){e.fetchEntities(),e.errorMessage=t};e.invokeApi(i.fetchRoutes,e.reservationData.reservation_id,t,a)},e.setDefaultRoutingDates=function(){e.routeDates.from=t.businessDate>e.reservation.reservation_card.arrival_date?t.businessDate:e.reservation.reservation_card.arrival_date,e.routeDates.to=e.reservation.reservation_card.departure_date},e.setRoutingDateOptions=function(){e.routingDateFromOptions={dateFormat:"dd-mm-yy",minDate:tzIndependentDate(e.reservation.reservation_card.arrival_date),maxDate:tzIndependentDate(e.reservation.reservation_card.departure_date)},e.routingDateToOptions={dateFormat:"dd-mm-yy",minDate:tzIndependentDate(e.reservation.reservation_card.arrival_date),maxDate:tzIndependentDate(e.reservation.reservation_card.departure_date)}},e.fetchEntities=function(){var t=function(t){e.attachedEntities=t,e.$parent.$emit("hideLoader")},a=function(t){e.$emit("hideLoader"),e.errorMessage=t};e.invokeApi(i.fetchAttachedCards,e.reservationData.reservation_id,t,a)},e.saveRoute=function(){t.$broadcast("routeSaveClicked")},e.$on("displayErrorMessage",function(t,a){e.errorMessage=a}),e.handleCloseDialog=function(){e.$emit("HANDLE_MODAL_OPENED"),e.closeDialog(),e.billingData.billingInfoTitle=e.routes.length>0?a("translate")("BILLING_INFO_TITLE"):a("translate")("ADD_BILLING_INFO_TITLE")},s()}]),sntRover.controller("rvBillingInfoReservationRouteDetailsCtrl",["$scope","$rootScope","$filter","RVBillinginfoSrv","RVGuestCardSrv","ngDialog","RVBillCardSrv","RVPaymentSrv","rvPermissionSrv",function(e,t,a,i,n,r,s,o,l){BaseCtrl.call(this,e);var c=function(){e.first_bill_id="",e.chargeCodeToAdd="",e.swipedCardDataToSave={},e.paymentFlags={showPayment:!1,isAddPayment:!1,showPaymentDropDown:!1,isShownExistingCCPayment:!1,sixIsManual:!1},d(),u(),p(),g(),b(),m(),h()},d=function(){var t=e.selectedEntity;null!==t.credit_card_details&&void 0!==t.credit_card_details&&t.credit_card_details.hasOwnProperty("payment_type_description")&&(e.renderAddedPayment=t.credit_card_details,e.renderAddedPayment.cardExpiry=t.credit_card_details.card_expiry,e.renderAddedPayment.endingWith=t.credit_card_details.card_number,e.renderAddedPayment.creditCardType=t.credit_card_details.card_code,e.paymentFlags.showPayment=!0,e.paymentFlags.showPaymentDropDown=!1,e.paymentFlags.isShownExistingCCPayment=!0,setTimeout(function(){e.$broadcast("UPDATE_FLAG")},1e3))},u=function(){e.passData={},e.passData.details={},"undefined"==typeof e.guestCardData||"undefined"==typeof e.guestCardData.contactInfo?(e.passData.details.firstName="",e.passData.details.lastName=""):(e.passData.details.firstName=e.guestCardData.contactInfo.first_name,e.passData.details.lastName=e.guestCardData.contactInfo.last_name),e.setScroller("cardsList")},p=function(){e.isOtherReservation=e.reservationData.reservation_id!==e.selectedEntity.id&&"RESERVATION"===e.selectedEntity.entity_type,e.isGroupOrHouse="GROUP"===e.selectedEntity.entity_type||"HOUSE"===e.selectedEntity.entity_type},g=function(){e.selectedEntity.credit_limit&&(e.selectedEntity.credit_limit=parseFloat(e.selectedEntity.credit_limit).toFixed(2))},m=function(){var t={preventDefault:!1};e.setScroller("paymentList",t),e.setScroller("billingGroups",t),e.setScroller("chargeCodes",t),e.setScroller("routeDetails",t);var a={click:!0};e.setScroller("chargeCodesList",a),e.chargeCodesListDivHgt=250,e.chargeCodesListDivTop=0},h=function(){setTimeout(function(){e.refreshScroller("paymentList"),e.refreshScroller("billingGroups"),e.refreshScroller("chargeCodes"),e.refreshScroller("chargeCodesList"),e.refreshScroller("routeDetails")},500)};e.editPaymentMethod=function(){e.oldPayment=e.renderAddedPayment,e.renderAddedPayment={},e.paymentFlags.isAddPayment=!1},e.showPaymentList=function(){e.paymentFlags.isAddPayment=!1,e.refreshScroller("paymentList")},e.$on("CANCELLED_PAYMENT",function(){e.renderAddedPayment=e.oldPayment,e.refreshScroller("routeDetails")});var y=function(){var t=e.cardData.tokenDetails.isSixPayment?e.cardData.tokenDetails.expiry.substring(2,4)+" / "+e.cardData.tokenDetails.expiry.substring(0,2):e.cardData.cardDetails.expiryMonth+" / "+e.cardData.cardDetails.expiryYear;return t},v=function(){var t=e.cardData.tokenDetails.isSixPayment?e.cardData.tokenDetails.token_no.substr(e.cardData.tokenDetails.token_no.length-4):e.cardData.cardDetails.cardNumber.slice(-4);return t},f=function(){var t=e.cardData.tokenDetails.isSixPayment?e.passData.details.firstName+" "+e.passData.details.lastName:e.cardData.cardDetails.userName;return t},E=function(){var t=e.cardData,a=t.tokenDetails.isSixPayment?t.tokenDetails.expiry.substring(2,4):t.cardDetails.expiryMonth,i=t.tokenDetails.isSixPayment?t.tokenDetails.expiry.substring(0,2):t.cardDetails.expiryYear,n=a&&i?"20"+i+"-"+a+"-01":"";return n};e.paymentAdded=function(t){e.selectedEntity.selected_payment="",e.cardData=t,e.renderAddedPayment={},e.renderAddedPayment.payment_type="CC",e.paymentFlags.isAddPayment=!1,e.paymentFlags.showPayment=!0,e.renderAddedPayment.creditCardType=e.cardData.tokenDetails.isSixPayment?getSixCreditCardType(e.cardData.tokenDetails.card_type).toLowerCase():getCreditCardType(e.cardData.cardDetails.cardType).toLowerCase(),e.renderAddedPayment.cardExpiry=y(),e.renderAddedPayment.endingWith=v()},e.paymentAddedThroughMLISwipe=function(t){e.renderAddedPayment={},e.renderAddedPayment.payment_type="CC",e.swipedCardDataToSave=t,e.renderAddedPayment.creditCardType=t.cardType.toLowerCase(),e.renderAddedPayment.cardExpiry=t.cardExpiryMonth+"/"+t.cardExpiryYear,e.renderAddedPayment.endingWith=t.cardNumber.slice(-4)},e.showAddPayment=function(){if(t.isManualCCEntryEnabled)e.renderAddedPayment={creditCardType:"",cardExpiry:"",endingWith:"",payment_type:""},e.paymentFlags.isAddPayment=!0,e.paymentFlags.showPaymentDropDown=!0,e.paymentFlags.isShownExistingCCPayment=!1,e.$broadcast("showaddpayment"),e.refreshScroller("routeDetails");else{e.isManualCCEntryEnabled=!1;r.open({template:"/assets/partials/payment/rvPaymentModal.html",controller:"",scope:e})}},e.$on("SHOW_SWIPED_DATA_ON_BILLING_SCREEN",function(t,a){e.paymentFlags.isAddPayment=!0,e.$broadcast("showaddpayment"),setTimeout(function(){e.saveData.payment_type="CC",e.paymentFlags.showPaymentDropDown=!0,e.swippedCard=!0,e.$broadcast("RENDER_DATA_ON_BILLING_SCREEN",a),e.$digest()},2e3)}),e.$on("ngDialog.opened",function(t,a){e.ngDialogID=a[0].id}),e.closeDialog=function(){r.close(e.ngDialogID)};var C=function(){var t=function(t){e.availableChargeCodes=t,D()},n=function(t){e.$parent.$emit("hideLoader"),e.$emit("displayErrorMessage",t)},r={};r.id=e.reservationData.reservation_id,e.isOtherReservation?r.to_bill=e.first_bill_id:r.to_bill=e.selectedEntity.to_bill,r.is_new=e.selectedEntity.is_new,r.from_date=a("date")(tzIndependentDate(e.routeDates.from),"yyyy-MM-dd"),r.to_date=a("date")(tzIndependentDate(e.routeDates.to),"yyyy-MM-dd"),e.invokeApi(i.fetchAvailableChargeCodes,r,t,n)},D=function(){var t=function(t){e.availableBillingGroups=t,0===t.length&&(e.billingInfoFlags.isBillingGroup=!1),e.isGroupOrHouse?(e.paymentFlags.showPayment=!1,e.$parent.$emit("hideLoader")):e.isOtherReservation?e.$parent.$emit("hideLoader"):e.reservationData.reservation_id!==e.selectedEntity.id&&"RESERVATION"!==e.selectedEntity.entity_type?(e.paymentFlags.showPayment=!0,e.attachedPaymentTypes=[],e.$parent.$emit("hideLoader")):e.selectedEntity.has_accompanying_guests?(e.paymentFlags.showPayment=!0,e.$parent.$emit("hideLoader")):(e.paymentFlags.showPayment=!0,A())},n=function(t){e.$parent.$emit("hideLoader"),e.$emit("displayErrorMessage",t)},r={};r.id=e.reservationData.reservation_id,e.isOtherReservation?r.to_bill=e.first_bill_id:r.to_bill=e.selectedEntity.to_bill,r.is_new=e.selectedEntity.is_new,r.from_date=a("date")(tzIndependentDate(e.routeDates.from),"yyyy-MM-dd"),r.to_date=a("date")(tzIndependentDate(e.routeDates.to),"yyyy-MM-dd"),e.invokeApi(i.fetchAvailableBillingGroups,r,t,n)},A=function(){var t=function(t){e.attachedPaymentTypes=t,e.$parent.$emit("hideLoader")},a=function(t){e.$parent.$emit("hideLoader"),e.$emit("displayErrorMessage",t)};e.invokeApi(n.fetchGuestPaymentData,e.reservationData.user_id,t,a)},I=function(t){for(var a=0;a<e.routes.length;a++)for(var i=0;i<t.length;i++)if(t[i].id===e.routes[a].to_bill&&e.selectedEntity.id!==e.routes[a].id){t.splice(i,1);break}return t},b=function(){var t=function(t){e.bills=[],e.$parent.bills=[],e.first_bill_id="undefined"!=typeof t[0]?t[0].id:"";var a="undefined"!=typeof t[0]?t[0].id:"";if(e.newBillNumber=t.length+1,"undefined"!=typeof e.reservationData&&e.isOtherReservation)e.bills.push(t[0]),e.bills=I(e.bills),e.$parent.bills=e.bills;else{if(t.splice(0,1),e.bills=I(t),e.newBillNumber<=10){var i={};i.id="new",i.bill_number=""+e.newBillNumber+"(new)",e.bills.push(i)}e.$parent.bills=e.bills}e.selectedEntity.to_bill=e.selectedEntity.is_new?e.bills[0].id:e.selectedEntity.to_bill;var n=e.selectedEntity.bill_no;e.isGroupOrHouse?e.selectedEntity.to_bill=a:""===n?e.selectedEntity.to_bill=_.last(e.bills).id:e.selectedEntity.to_bill=e.selectedEntity.to_bill,C()},a=function(t){e.$parent.$emit("hideLoader"),e.$emit("displayErrorMessage",t)},n="undefined"!=typeof e.reservationData?e.reservationData.reservation_id:"",r="";e.isGroupOrHouse?(n=e.selectedEntity.id,r=e.selectedEntity.entity_type):"RESERVATION"===e.selectedEntity.entity_type&&(n=e.selectedEntity.id);var s={id:n,entity_type:r};e.invokeApi(i.fetchBillsForReservation,s,t,a)};e.escapeNull=function(e,t){return escapeNull(e,t)},e.$on("routeSaveClicked",function(t){e.saveRoute()});var S=function(){("COMPANY_CARD"!==e.selectedEntity.entity_type||"undefined"!=typeof e.reservationDetails.companyCard.id&&""!==e.reservationDetails.companyCard.id)&&("TRAVEL_AGENT"!==e.selectedEntity.entity_type||"undefined"!==e.reservationDetails.travelAgent.id&&""!==e.reservationDetails.travelAgent.id)||t.$broadcast("CardInfoUpdated",e.selectedEntity.id,e.selectedEntity.entity_type)};e.saveRoute=function(){return 0===e.selectedEntity.attached_charge_codes.length&&0===e.selectedEntity.attached_billing_groups.length?void e.$emit("displayErrorMessage",[a("translate")("ERROR_CHARGES_EMPTY")]):(e.selectedEntity.reservation_id=e.reservationData.reservation_id,e.selectedEntity.from_date=a("date")(tzIndependentDate(e.routeDates.from),"yyyy-MM-dd"),e.selectedEntity.to_date=a("date")(tzIndependentDate(e.routeDates.to),"yyyy-MM-dd"),void("new"===e.selectedEntity.to_bill?e.createNewBill():null===e.saveData.payment_type||""===e.saveData.payment_type||e.paymentFlags.isShownExistingCCPayment?T():e.savePayment()))};var T=function(){e.saveSuccessCallback=function(t){e.$parent.$emit("hideLoader"),t.has_crossed_credit_limit?R():(e.$parent.$emit("BILLINGINFOADDED"),e.setReloadOption(!0),e.navigateToInitialPage(),S(),e.$parent.$emit("REFRESH_BILLCARD_VIEW"))};var t=function(t){e.$parent.$emit("hideLoader"),e.$emit("displayErrorMessage",t)},a=angular.copy(e.selectedEntity);e.invokeApi(i.saveRoute,a,e.saveSuccessCallback,t)};e.hasPermissionToEditCreditLimit=function(){return l.getPermissionValue("OVERWRITE_DIRECT_BILL_MAXIMUM_AMOUNT")},e.createNewBill=function(){if("ALLOTMENT"===e.selectedEntity.entity_type||"GROUP"===e.selectedEntity.entity_type||"HOUSE"===e.selectedEntity.entity_type)var t={entity_type:e.selectedEntity.entity_type,entity_id:e.selectedEntity.id};else var t={reservation_id:e.reservationData.reservation_id};var a=function(t){e.$emit("hideLoader"),e.selectedEntity.to_bill=t.id,e.bills[e.bills.length-1].id=t.id,null!==e.saveData.payment_type&&""!==e.saveData.payment_type?e.savePayment():T()};e.invokeApi(s.createAnotherBill,t,a,e.errorCallback)},e.savePayment=function(){e.saveSuccessCallback=function(t){e.$parent.$emit("hideLoader"),e.$parent.$emit("BILLINGINFOADDED")},e.errorCallback=function(t){e.$parent.$emit("hideLoader"),e.$emit("displayErrorMessage",t)},e.savePaymentToReservation()},e.savePaymentToReservation=function(){e.saveSuccessCallback=function(t){e.$parent.$emit("hideLoader"),t.has_crossed_credit_limit?R():(e.setReloadOption(!0),e.navigateToInitialPage(),e.$parent.$emit("BILLINGINFOADDED"),e.$parent.$emit("REFRESH_BILLCARD_VIEW"))},e.errorCallback=function(t){e.$parent.$emit("hideLoader"),e.$emit("displayErrorMessage",t)};var a=function(t){e.$parent.$emit("hideLoader"),e.invokeApi(i.saveRoute,e.selectedEntity,e.saveSuccessCallback,e.errorCallback)},n=function(t){e.$parent.$emit("hideLoader"),e.$emit("displayErrorMessage",t)},r=function(t){var i={token:t.token,is_swiped:!0};i.reservation_id=e.reservationData.reservation_id,e.invokeApi(o.savePaymentDetails,i,a,n)};if("CC"===e.saveData.payment_type)if("sixpayments"!==t.paymentGateway||e.paymentFlags.sixIsManual)if(isEmptyObject(e.swipedCardDataToSave)){var s={add_to_guest_card:!1};s.reservation_id=e.reservationData.reservation_id,s.payment_type=e.saveData.payment_type,creditCardType=e.cardData.tokenDetails.isSixPayment?getSixCreditCardType(e.cardData.tokenDetails.card_type).toLowerCase():getCreditCardType(e.cardData.cardDetails.cardType),s.token=e.cardData.tokenDetails.isSixPayment?e.cardData.tokenDetails.token_no:e.cardData.tokenDetails.session,s.card_name=f(),s.bill_number=e.getSelectedBillNumber(),s.card_expiry=E(),s.card_code=e.cardData.tokenDetails.isSixPayment?getSixCreditCardType(e.cardData.tokenDetails.card_type).toLowerCase():e.cardData.cardDetails.cardType,e.invokeApi(o.savePaymentDetails,s,a,n)}else{var s=e.swipedCardDataToSave;s.reservation_id=e.reservationData.reservation_id,s.bill_number=e.getSelectedBillNumber(),s.payment_credit_type=e.swipedCardDataToSave.cardType,s.credit_card=e.swipedCardDataToSave.cardType,s.card_expiry="20"+e.swipedCardDataToSave.cardExpiryYear+"-"+e.swipedCardDataToSave.cardExpiryMonth+"-01",e.invokeApi(o.savePaymentDetails,s,a,n)}else{var s={};s.reservation_id=e.reservationData.reservation_id,s.add_to_guest_card=!1,s.bill_number=e.getSelectedBillNumber(),e.$emit("UPDATE_SHOULD_SHOW_WAITING",!0),o.chipAndPinGetToken(s).then(function(t){e.$emit("UPDATE_SHOULD_SHOW_WAITING",!1),r(t)},function(t){e.errorMessage=t,e.$emit("UPDATE_SHOULD_SHOW_WAITING",!1)})}else{var s={payment_type:e.saveData.payment_type};s.reservation_id=e.reservationData.reservation_id,s.bill_number=e.getSelectedBillNumber(),e.invokeApi(o.savePaymentDetails,s,a,n)}};var R=function(){r.open({template:"/assets/partials/billingInformation/sharedPartials/rvBillingInfoCreditLimitExceededPopup.html",className:"",closeByDocument:!1,scope:e})};e.getSelectedBillNumber=function(){for(var t=0;t<e.bills.length;t++)if(e.bills[t].id===e.selectedEntity.to_bill)return e.bills[t].bill_number},e.$on("CHANGE_IS_MANUAL",function(t,a){e.paymentFlags.sixIsManual=a}),e.onRouteDateChange=function(){C()},e.showCreditCardOrNewPayment=function(){return!e.paymentFlags.isAddPayment&&e.paymentFlags.showPayment&&isEmptyObject(e.renderAddedPayment)},e.hideAvailableCreditCard=function(){return e.isGroupOrHouse||e.selectedEntity.has_accompanying_guests||!isEmptyObject(e.renderAddedPayment)},e.showCreditCardAddedDuringRouteCreation=function(){return!isEmptyObject(e.renderAddedPayment)&&!e.paymentFlags.isAddPayment&&e.paymentFlags.showPayment&&!e.isGroupOrHouse&&!e.saveData.newPaymentFormVisible},e.showSelectPaymentTypeDropDown=function(){return e.paymentFlags.isAddPayment&&e.paymentFlags.showPaymentDropDown&&e.paymentFlags.showPayment},e.hideNewPaymentButton=function(){return e.isOtherReservation||e.isGroupOrHouse||!isEmptyObject(e.renderAddedPayment)},c()}]),sntRover.controller("rvBillingInfoRoutesListCtrl",["$scope","$rootScope","$filter","RVBillinginfoSrv","ngDialog",function(e,t,a,i,n){BaseCtrl.call(this,e);var r=function(){var t={preventDefault:!1};e.setScroller("routes",t),setTimeout(function(){e.refreshScroller("routes")},500)};e.getCharges=function(e){return e.attached_charge_codes.length>1||e.attached_billing_groups.length>1?"Multiple":e.attached_charge_codes.length>0?e.attached_charge_codes[0].charge_code+", "+e.attached_charge_codes[0].description:e.attached_billing_groups.length>0?e.attached_billing_groups[0].name:void 0},e.getRouteType=function(e){return e.attached_charge_codes.length>0&&e.attached_billing_groups.length>0||e.attached_charge_codes.length>0?"CHARGE CODE(S)":"BILLING GROUP(S)"},e.deleteRoute=function(t){var a=function(a){e.routes.splice(t,1),e.$parent.$emit("hideLoader"),e.$parent.$emit("BILLINGINFODELETED",e.routes)},n=function(t){e.$parent.$emit("hideLoader"),e.$emit("displayErrorMessage",t)},r={};r.id=e.reservationData.reservation_id,r.from_bill=e.routes[t].from_bill,r.to_bill=e.routes[t].to_bill,e.invokeApi(i.deleteRoute,r,a,n)},e.selectEntityFromRoutesList=function(t){e.routes[t].from_date&&(e.routeDates.from=e.routes[t].from_date,e.routeDates.to=e.routes[t].to_date),e.setRoutingDateOptions(),e.billingInfoFlags.isEntitySelected=!0,e.billingInfoFlags.isInAddRoutesMode=!1,e.billingInfoFlags.isInitialPage=!1;var a=e.routes[t];e.setSelectedEntity(a),e.selectedEntity.is_new=!1,"RESERVATION"===e.selectedEntity.entity_type?e.selectedEntity.images[0].guest_image=e.selectedEntity.images[0].image:e.selectedEntity.guest_id=null},r()}]),sntRover.controller("rvBillingInfoAddPaymentCtrl",["$scope","$rootScope","$filter","ngDialog","RVPaymentSrv",function(e,t,a,i,n){BaseCtrl.call(this,e),e.cardsList=[],e.addmode=!(e.cardsList.length>0),e.hideCancelCard=!0,e.isManual=!1;var r="";try{HostedForm.setMerchant(t.MLImerchantId)}catch(e){}e.cancelClicked=function(){e.showPaymentList(),e.saveData.payment_type="",e.saveData.payment_type_description="",e.showCCPage=!1,e.swippedCard=!1,e.addmode=!1,e.saveData.newPaymentFormVisible=!1,e.$emit("CANCELLED_PAYMENT")};var s={preventDefault:!1};e.setScroller("newpaymentview",s),e.$on("showaddpayment",function(t){e.refreshScroller("newpaymentview")}),e.fetchAvailablePaymentTypes=function(){var t=function(t){e.creditCardTypes=[],e.availablePaymentTypes=t,e.ccPaymentDetails={};for(var a in t)"CC"===t[a].name&&(e.ccPaymentDetails=t[a],e.creditCardTypes=t[a].values);e.$parent.$emit("hideLoader"),e.refreshScroller("newpaymentview")},a=function(t){e.$parent.$emit("hideLoader"),e.$emit("displayErrorMessage",t)},i={direct_bill:!0};e.invokeApi(n.renderPaymentScreen,i,t,a)},e.fetchAvailablePaymentTypes(),e.savePaymentDetails=function(){if("CC"!==e.saveData.payment_type)return void e.savePayment();var t={};t.cardNumber=e.saveData.card_number,t.cardSecurityCode=e.saveData.cvv,t.cardExpiryMonth=e.saveData.card_expiry_month,t.cardExpiryYear=e.saveData.card_expiry_year;var a=function(t){e.$emit("hideLoader"),"ok"===t.status?(r=t.session,e.savePayment()):e.$emit("displayErrorMessage",["There is a problem with your credit card"]),e.$apply()};try{HostedForm.updateSession(t,a),e.$emit("showLoader")}catch(t){e.$emit("displayErrorMessage",["There was a problem connecting to the payment gateway."])}},e.savePayment=function(){e.saveData.reservation_id=e.reservationData.reservation_id,e.saveData.session_id=r,e.saveData.mli_token=e.saveData.card_number.substr(e.saveData.card_number.length-4),e.saveData.card_expiry=e.saveData.card_expiry_month+"/"+e.saveData.card_expiry_year,e.paymentAdded(e.saveData)},e.selectPaymentType=function(){for(var t=0;t<e.availablePaymentTypes.length;t++)e.availablePaymentTypes[t].name===e.saveData.payment_type&&(e.saveData.payment_type_description=e.availablePaymentTypes[t].description);e.refreshScroller("newpaymentview"),"sixpayments"!==e.paymentGateway?(e.showCCPage="CC"===e.saveData.payment_type,e.swippedCard="CC"===e.saveData.payment_type,e.saveData.newPaymentFormVisible="CC"===e.saveData.payment_type,e.addmode="CC"===e.saveData.payment_type&&0===e.cardsList.length):e.isManual=!1},e.changeOnsiteCallIn=function(){e.$emit("CHANGE_IS_MANUAL",e.isManual),e.showCCPage=!("CC"!==e.saveData.payment_type||!e.isManual),e.swippedCard=!("CC"!==e.saveData.payment_type||!e.isManual),e.addmode="CC"===e.saveData.payment_type&&0===e.cardsList.length,e.saveData.newPaymentFormVisible=!("CC"!==e.saveData.payment_type||!e.isManual),e.$broadcast("REFRESH_IFRAME")},e.$on("TOKEN_CREATED",function(t,a){e.showCCPage=!1,e.swippedCard=!1,e.addmode=!1,e.saveData.newPaymentFormVisible=!1,e.paymentAdded(a)}),e.$on("RENDER_DATA_ON_BILLING_SCREEN",function(t,a){e.showCCPage=!0,e.addmode=!0,e.swippedCard=!0,e.saveData.newPaymentFormVisible=!0,e.$apply(),e.$broadcast("RENDER_SWIPED_DATA",a)}),e.$on("SWIPED_DATA_TO_SAVE",function(t,a){e.showCCPage=!1,e.swippedCard=!1,e.addmode=!1,e.saveData.newPaymentFormVisible=!1,e.paymentAddedThroughMLISwipe(a)}),e.$on("UPDATE_FLAG",function(){e.showCCPage=!1,e.swippedCard=!1})}]);var guestStatusMappings={RESERVED:["arrival"],CHECKING_IN:["check-in"],CHECKEDIN:["inhouse"],CHECKEDOUT:["departed"],CHECKING_OUT:["check-out","late-check-out"],CANCELED:["cancel"],NOSHOW:["no-show"],NOSHOW_CURRENT:["no-show"]};sntRover.controller("rvChargeCodesAndBillingGroupCtrl",["$scope","$rootScope","$filter","RVBillinginfoSrv","RVGuestCardSrv","ngDialog","RVBillCardSrv","RVPaymentSrv",function(e,t,a,i,n,r,s,o){BaseCtrl.call(this,e),e.toggleChargeType=function(){e.billingInfoFlags.isBillingGroup=!e.billingInfoFlags.isBillingGroup,e.billingInfoFlags.isBillingGroup?e.refreshScroller("billingGroups"):e.refreshScroller("chargeCodes"),e.billingInfoFlags.showChargeCodes=!1},e.isBillingGroupSelected=function(t){if(e.selectedEntity.attached_billing_groups)for(var a=0;a<e.selectedEntity.attached_billing_groups.length;a++)if(e.selectedEntity.attached_billing_groups[a].id===t.id)return!0;return!1},e.toggleSelectionForBillingGroup=function(t){for(var a=0;a<e.selectedEntity.attached_billing_groups.length;a++)if(e.selectedEntity.attached_billing_groups[a].id===t.id)return void e.selectedEntity.attached_billing_groups.splice(a,1);e.selectedEntity.attached_billing_groups.push(t),e.refreshScroller("billingGroups")},e.removeChargeCode=function(t){for(var a=0;a<e.selectedEntity.attached_charge_codes.length;a++)if(e.selectedEntity.attached_charge_codes[a].id===t.id)return void e.selectedEntity.attached_charge_codes.splice(a,1)},e.showAvailableChargeCodes=function(){e.clearResults(),c(),e.billingInfoFlags.showChargeCodes=!e.billingInfoFlags.showChargeCodes};var l=function(){for(var t=0;t<e.availableChargeCodes.length;t++)if(e.availableChargeCodes[t].id===e.chargeCodeToAdd){for(var a=0;a<e.selectedEntity.attached_charge_codes.length;a++)if(e.selectedEntity.attached_charge_codes[a].id===e.chargeCodeToAdd)return;return e.selectedEntity.attached_charge_codes.push(e.availableChargeCodes[t]),void e.refreshScroller("chargeCodes")}};e.selectChargeCode=function(t){e.chargeCodeToAdd=t,l(),e.chargeCodeSearchText="",e.billingInfoFlags.showChargeCodes=!1},e.chargeCodeEntered=function(){e.billingInfoFlags.showChargeCodes=!1,c();var t=e.chargeCodeSearchText;e.chargeCodeSearchText=t.charAt(0).toUpperCase()+t.slice(1)},e.clearResults=function(){e.chargeCodeSearchText=""};var c=function(){if(e.chargeCodeSearchText.length<3){for(var t=0;t<e.availableChargeCodes.length;t++)e.isChargeCodeSelected(e.availableChargeCodes[t])?(e.availableChargeCodes[t].is_row_visible=!1,e.availableChargeCodes[t].is_selected=!1):(e.availableChargeCodes[t].is_row_visible=!0,e.availableChargeCodes[t].is_selected=!0);e.refreshScroller("chargeCodesList")}else{for(var a="",t=0;t<e.availableChargeCodes.length;t++)a=e.availableChargeCodes[t],(e.escapeNull(a.code).toUpperCase().indexOf(e.chargeCodeSearchText.toUpperCase())>=0||e.escapeNull(a.description).toUpperCase().indexOf(e.chargeCodeSearchText.toUpperCase())>=0)&&!e.isChargeCodeSelected(e.availableChargeCodes[t])?e.availableChargeCodes[t].is_row_visible=!0:e.availableChargeCodes[t].is_row_visible=!1;e.refreshScroller("chargeCodesList")}};e.escapeNull=function(e,t){return escapeNull(e,t)},e.isChargeCodeSelected=function(t){if(e.selectedEntity.attached_charge_codes)for(var a=0;a<e.selectedEntity.attached_charge_codes.length;a++)if(e.selectedEntity.attached_charge_codes[a].id===t.id)return!0;return!1}}]),sntRover.controller("rvSearchAndAttachEntityCtrl",["$scope","$rootScope","$filter","RVBillinginfoSrv","ngDialog","RVCompanyCardSearchSrv","RVSearchSrv",function(e,t,a,i,n,r,s){BaseCtrl.call(this,e);var o=function(){e.textInQueryBox="",e.isReservationActive=!0;var t={click:!0,preventDefault:!1};e.setScroller("cards_search_scroller",t),e.setScroller("res_search_scroller",t),e.refreshScroller("cards_search_scroller"),e.refreshScroller("res_search_scroller");var t={preventDefault:!1};e.setScroller("entities",t),setTimeout(function(){e.refreshScroller("entities")},500)},l=function(e){return!t.isSingleDigitSearch||isNaN(e)};e.queryEntered=function(){e.textInQueryBox.length<3&&l(e.textInQueryBox)?(e.searchResults.cards=[],e.searchResults.posting_accounts=[],e.searchResults.reservations=[]):(d(),g());var t=e.textInQueryBox;e.textInQueryBox=t.charAt(0).toUpperCase()+t.slice(1)},e.clearResults=function(){e.textInQueryBox="",e.refreshScroller("entities")};var c=function(t){e.$emit("hideLoader"),e.searchResults.cards=[],e.searchResults.cards=t.accounts,e.searchResults.posting_accounts=[],e.searchResults.posting_accounts=t.posting_accounts,setTimeout(function(){e.refreshScroller("cards_search_scroller")},750)},d=function(){if(e.textInQueryBox.length<3&&l(e.textInQueryBox)){for(var t=0;t<e.searchResults.cards.length;t++)e.searchResults.cards[t].is_row_visible=!0;for(var t=0;t<e.searchResults.posting_accounts.length;t++)e.searchResults.posting_accounts[t].is_row_visible=!0;e.refreshScroller("cards_search_scroller")}else{for(var a="",i=0,t=0;t<e.searchResults.cards.length;t++)a=e.searchResults.cards[t],e.escapeNull(a.account_first_name).toUpperCase().indexOf(e.textInQueryBox.toUpperCase())>=0||e.escapeNull(a.account_last_name).toUpperCase().indexOf(e.textInQueryBox.toUpperCase())>=0?(e.searchResults.cards[t].is_row_visible=!0,i++):e.searchResults.cards[t].is_row_visible=!1;for(var t=0;t<e.searchResults.posting_accounts.length;t++)a=e.searchResults.posting_accounts[t],e.escapeNull(a.account_name).toUpperCase().indexOf(e.textInQueryBox.toUpperCase())>=0?(e.searchResults.posting_accounts[t].is_row_visible=!0,i++):e.searchResults.posting_accounts[t].is_row_visible=!1;if(0===i){var n={query:e.textInQueryBox.trim()};e.invokeApi(r.fetch,n,c)}e.refreshScroller("cards_search_scroller")}},u=function(){for(var t=[],a=0;a<e.searchResults.reservations.length;a++)e.searchResults.reservations[a].id===e.reservationData.reservation_id||"CHECKING_IN"!==e.searchResults.reservations[a].reservation_status&&"CHECKEDIN"!==e.searchResults.reservations[a].reservation_status&&"CHECKING_OUT"!==e.searchResults.reservations[a].reservation_status||t.push(e.searchResults.reservations[a]);e.searchResults.reservations=t},_=function(t){e.$emit("hideLoader"),e.searchResults.reservations=[],e.searchResults.reservations=t,"TRAVEL_AGENT_DEFAULT_BILLING"!==e.billingEntity&&"COMPANY_CARD_DEFAULT_BILLING"!==e.billingEntity&&"GROUP_DEFAULT_BILLING"!==e.billingEntity&&"ALLOTMENT_DEFAULT_BILLING"!==e.billingEntity&&u(),setTimeout(function(){e.refreshScroller("res_search_scroller")},750)},p=function(t){e.$emit("hideLoader"),e.$emit("displayErrorMessage",t)},g=function(){if(e.textInQueryBox.length<3&&l(e.textInQueryBox)){for(var a=0;a<e.searchResults.length;a++)e.searchResults.reservations[a].is_row_visible=!0;e.refreshScroller("res_search_scroller")}else{if(t.isSingleDigitSearch&&!isNaN(e.textInQueryBox)&&3===e.textInQueryBox.length)return m(),!1;if(0===e.textInQueryBox.indexOf(e.textInQueryBox)&&e.searchResults.reservations.length>0){for(var i="",n=0,a=0;a<e.searchResults.reservations.length;a++)i=e.searchResults.reservations[a],e.escapeNull(i.firstname).toUpperCase().indexOf(e.textInQueryBox.toUpperCase())>=0||e.escapeNull(i.lastname).toUpperCase().indexOf(e.textInQueryBox.toUpperCase())>=0||e.escapeNull(i.group).toUpperCase().indexOf(e.textInQueryBox.toUpperCase())>=0||e.escapeNull(i.room).toString().indexOf(e.textInQueryBox)>=0||e.escapeNull(i.confirmation).toString().indexOf(e.textInQueryBox)>=0?(e.searchResults.reservations[a].is_row_visible=!0,n++):e.searchResults.reservations[a].is_row_visible=!1;0===n&&m()}else m();e.refreshScroller("res_search_scroller")}},m=function(){var a={query:e.textInQueryBox.trim()};t.isSingleDigitSearch&&!isNaN(e.textInQueryBox)&&e.textInQueryBox.length<3&&(a.room_search=!0),e.invokeApi(s.fetch,a,_,p)};e.toggleClicked=function(t){e.isReservationActive=t},e.selectEntityFromSearchResults=function(t,a){if(e.setDefaultRoutingDates(),e.setRoutingDateOptions(),e.billingInfoFlags.isEntitySelected=!0,e.billingInfoFlags.isInAddRoutesMode=!1,e.billingInfoFlags.isInitialPage=!1,"RESERVATIONS"===a){var i=e.searchResults.reservations[t],n={attached_charge_codes:[],attached_billing_groups:[],images:i.images,reservation_status:i.reservation_status,is_opted_late_checkout:i.is_opted_late_checkout,name:i.firstname+" "+i.lastname,entity_type:"RESERVATION",has_accompanying_guests:i.images.length>1,bill_no:"",is_new:!0,credit_card_details:{},id:i.id};e.setSelectedEntity(n,a)}else if("ACCOUNT"===a){var i=e.searchResults.cards[t],n={id:i.id,name:i.account_name,bill_no:"",images:[{is_primary:!0,guest_image:i.company_logo}],attached_charge_codes:[],attached_billing_groups:[],is_new:!0,is_allow_direct_debit:i.is_allow_direct_debit,selected_payment:"",credit_card_details:{}};"COMPANY"===i.account_type?n.entity_type="COMPANY_CARD":"TRAVELAGENT"===i.account_type&&(n.entity_type="TRAVEL_AGENT"),e.setSelectedEntity(n,a)}else if("GROUP"===a||"HOUSE"===a)if(e.isRoutingForPostingAccountExist()){
var r=["Routing to account already exists for this reservation. Please edit or remove existing routing to add new."];e.$emit("displayErrorMessage",r),e.billingInfoFlags.isEntitySelected=!1,e.billingInfoFlags.isInitialPage=!0}else{var i=e.searchResults.posting_accounts[t],n={id:i.id,name:i.account_name,bill_no:"",attached_charge_codes:[],attached_billing_groups:[],is_new:!0,selected_payment:"",credit_card_details:{},entity_type:i.account_type};e.setSelectedEntity(n,a)}},e.selectAttachedEntity=function(t,a){e.setDefaultRoutingDates(),e.setRoutingDateOptions(),e.billingInfoFlags.isEntitySelected=!0,e.billingInfoFlags.isInitialPage=!1;var i={bill_no:"",has_accompanying_guests:!1,attached_charge_codes:[],attached_billing_groups:[],is_new:!0,credit_card_details:{}};if(e.setSelectedEntity(i),"GUEST"===a)e.selectedEntity.id=e.reservationData.reservation_id,e.selectedEntity.guest_id=e.attachedEntities.primary_guest_details.id,e.selectedEntity.name=e.attachedEntities.primary_guest_details.name,e.selectedEntity.reservation_status=e.reservationData.reservation_status,e.selectedEntity.is_opted_late_checkout=e.reservationData.is_opted_late_checkout,e.selectedEntity.images=[{is_primary:!0,guest_image:e.attachedEntities.primary_guest_details.avatar}],e.selectedEntity.entity_type="RESERVATION";else if("ACCOMPANY_GUEST"===a)e.selectedEntity.id=e.reservationData.reservation_id,e.selectedEntity.guest_id=e.attachedEntities.accompanying_guest_details[t].id,e.selectedEntity.name=e.attachedEntities.accompanying_guest_details[t].name,e.selectedEntity.reservation_status=e.reservationData.reservation_status,e.selectedEntity.is_opted_late_checkout=e.reservationData.is_opted_late_checkout,e.selectedEntity.images=[{is_primary:!1,guest_image:e.attachedEntities.accompanying_guest_details[t].avatar}],e.selectedEntity.has_accompanying_guests=!0,e.selectedEntity.entity_type="RESERVATION";else if("COMPANY_CARD"===a)e.selectedEntity.id=e.attachedEntities.company_card.id,e.selectedEntity.name=e.attachedEntities.company_card.name,e.selectedEntity.images=[{is_primary:!0,guest_image:e.attachedEntities.company_card.logo}],e.selectedEntity.entity_type="COMPANY_CARD",e.selectedEntity.is_allow_direct_debit=e.attachedEntities.company_card.is_allow_direct_debit;else if("TRAVEL_AGENT"===a)e.selectedEntity.id=e.attachedEntities.travel_agent.id,e.selectedEntity.name=e.attachedEntities.travel_agent.name,e.selectedEntity.images=[{is_primary:!0,guest_image:e.attachedEntities.travel_agent.logo}],e.selectedEntity.entity_type="TRAVEL_AGENT",e.selectedEntity.is_allow_direct_debit=e.attachedEntities.travel_agent.is_allow_direct_debit;else if("GROUP"===a||"HOUSE"===a)if(e.isRoutingForPostingAccountExist()){var n=["Routing to account already exists for this reservation. Please edit or remove existing routing to add new."];e.$emit("displayErrorMessage",n),e.billingInfoFlags.isEntitySelected=!1,e.billingInfoFlags.isInitialPage=!0}else e.selectedEntity.id=e.attachedEntities.posting_account.id,e.selectedEntity.name=e.attachedEntities.posting_account.name,e.selectedEntity.entity_type=a},e.noSearchResultsFoundInAccountsAndCards=function(){return 0===e.searchResults.posting_accounts.length&&0===e.searchResults.cards.length&&""!==e.textInQueryBox&&!e.isReservationActive},e.noSearchResultsFoundInReservations=function(){return 0===e.searchResults.reservations.length&&""!==e.textInQueryBox&&e.isReservationActive},o()}]),sntRover.controller("RVOutsidePostChargeController",["$rootScope","$scope","RVPostChargeSrvV2","RVSearchSrv","$timeout","ngDialog","$stateParams","rvPermissionSrv",function(e,t,a,i,n,r,s,o){BaseCtrl.call(this,t),t.reservationsArray=[],t.fetchedData={},t.isOutsidePostCharge=!0,t.shouldShowChargesForMobile=!1,t.init=function(){t.itemsVisible=!0,t.firstTime=!0,t.search={},t.search.guest_company_agent="",t.search.room="",t.showInitialSearchScreen=!1,t.showSearchScreen=!1,t.isCardAttched=!1,t.noGuestOrRoomSelected=!1,t.guestHasNotCheckedin=!1,t.selectedReservationPostNotAllowed=!1,t.chargePosted=!1,t.cardAttached={},t.disableOutsidePostChargeButton=!1},t.init(),t.closeDialog=function(){e.modalOpened=!1,n(function(){r.close()},200)};var l="",c="";t.setScroller("result_showing_area_post_charg",{click:!0,tap:!0}),t.roomSearchStatus=!1,t.guestCompanySearchStatus=!1;var d=function(){n(function(){t.myScroll&&t.myScroll.result_showing_area_post_charg&&t.myScroll.result_showing_area_post_charg.refresh(),t.refreshScroller("result_showing_area_post_charg")},500)};t.searchForResultsSuccess=function(e){t.$emit("hideLoader"),t.reservationsArray=e,l=t.search.guest_company_agent,c=t.search.room,angular.forEach(t.reservationsArray,function(e,t){e.shouldShowReservation=!0}),0===t.reservationsArray.length&&(t.showNoMatches=!0),t.showInitialSearchScreen=!1,d()},t.searchForResults=function(){t.showNoMatches=!1,t.refreshApi=!0,0===t.search.guest_company_agent.length&&0===t.search.room.length&&(t.showInitialSearchScreen=!0,t.$apply()),0===t.search.guest_company_agent.length&&0===t.search.room.length&&0===t.reservationsArray.length&&(t.showInitialSearchScreen=!0);var a=!1;if(t.search.guest_company_agent.length>=3&&(a=!0),t.search.room.length>=3&&!e.isSingleDigitSearch&&(a=!0),t.search.room.length>=1&&e.isSingleDigitSearch&&(a=!0),!a)return!1;l.length>0?l.length<t.search.guest_company_agent.length&&t.search.guest_company_agent.indexOf(l)!==-1&&(t.refreshApi=!0):c.length>0&&c.length<t.search.room.length&&t.search.room.indexOf(c)!==-1&&(t.refreshApi=!1);var n={refreshApi:t.refreshApi,postData:{room_no:t.search.room,account:t.search.guest_company_agent}};t.invokeApi(i.fetchReservationsToPostCharge,n,t.searchForResultsSuccess),t.itemsVisible=!1},t.clickedCancel=function(){t.search.guest_company_agent="",t.search.room="",t.showInitialSearchScreen=!0,t.reservationsArray.length=0,t.showNoMatches=!1,t.itemsVisible=!1,t.showSearchScreen=!1},t.showHideInitialSearchScreen=function(){0===t.search.guest_company_agent.length&&0===t.search.room.length&&0===t.reservationsArray.length&&(t.showInitialSearchScreen=!0),t.showSearchScreen=!0,t.itemsVisible=!1},t.successGetBillDetails=function(a){t.$emit("hideLoader"),a.isFromOut=!0,e.$broadcast("UPDATED_BILLNUMBERS",a)},t.clickedReservationToPostCharge=function(e){t.selectedReservationId=e.id,e.restrict_post?t.selectedReservationPostNotAllowed=!0:(t.showPostChargesScreen(),t.invokeApi(a.getReservationBillDetails,t.selectedReservationId,t.successGetBillDetails))},t.proceedWithPostCharge=function(){event.stopImmediatePropagation(),t.selectedReservationPostNotAllowed=!1,t.showPostChargesScreen(),t.invokeApi(a.getReservationBillDetails,t.selectedReservationId,t.successGetBillDetails)},t.showPostChargesScreen=function(){t.showInitialSearchScreen=!1,t.showSearchScreen=!1},t.hasPermissionToAllowPostWithNoCredit=function(){return o.getPermissionValue("ALLOW_POST_WHEN_RESTRICTED")},t.getGuestStatusMapped=function(e,t){var a="";return t&&"CHECKING_OUT"===e?a="late-check-out":("RESERVED"===e?a="arrival":"CHECKING_IN"===e?a="check-in":"CHECKEDIN"===e?a="inhouse":"CHECKEDOUT"===e?a="departed":"CHECKING_OUT"===e?a="check-out":"CANCELED"===e?a="cancel":"NOSHOW"!==e&&"NOSHOW_CURRENT"!==e||(a="no-show"),a)},t.getRoomStatusMapped=function(e,t){var a="";return a="READY"===e&&"VACANT"===t?"ready":"not-ready"},t.escapeNull=function(e,t){var a="";"undefined"!=typeof t&&null!==t&&(a=t);var i=null===e||"undefined"==typeof e?a:e;return i},t.getReservationClass=function(e){var t={CHECKING_IN:"guest-check-in",CHECKEDIN:"guest-inhouse",CHECKING_OUT:"guest-check-out",CANCELED:"guest-cancel",NOSHOW:"guest-no-show",NOSHOW_CURRENT:"guest-no-show"};if(e.toUpperCase()in t)return t[e.toUpperCase()]},t.getQueueClass=function(e,t){var a="";return"true"===e&&"true"===t&&(a="queued"),a},t.getMappedClassWithResStatusAndRoomStatus=function(e,t,a,i,n){var r="room-number";if("CHECKING_IN"===e)switch(i){case"INSPECTED":r+=" room-green";break;case"CLEAN":if("true"===n){r+=" room-orange";break}r+=" room-green";break;case"PICKUP":r+=" room-orange";break;case"DIRTY":r+=" room-red"}return r},t.selectReservation=function(e){t.isCardAttched=!0,t.cardAttached=e},t.clickedDetachCard=function(e){t.isCardAttched=!1,t.cardAttached={},t.search.room="",t.search.guest_company_agent="",t.fetchedData.bill_numbers=[]},t.clickedPostCharges=function(a){a.stopImmediatePropagation(),a.stopPropagation(),t.isCardAttched?"CHECKING_IN"===t.cardAttached.reservation_status||"RESERVED"===t.cardAttached.reservation_status?t.guestHasNotCheckedin=!0:(t.reservation_id=t.cardAttached.id,t.restrict_post=t.cardAttached.restrict_post,e.$broadcast("POSTCHARGE"),t.disableOutsidePostChargeButton=!0):t.noGuestOrRoomSelected=!0},t.clickedAddGuestOrRoom=function(){t.noGuestOrRoomSelected=!1,t.showHideInitialSearchScreen()},t.clickedAddGuestOrRoomCancel=function(){t.noGuestOrRoomSelected=!1},t.clickedPostCharge=function(a){a.stopImmediatePropagation(),a.stopPropagation(),t.guestHasNotCheckedin=!1,t.reservation_id=t.cardAttached.id,t.restrict_post=t.cardAttached.restrict_post,e.$broadcast("POSTCHARGE"),t.disableOutsidePostChargeButton=!0},t.clickedPostChargeCancel=function(){t.guestHasNotCheckedin=!1,t.selectedReservationPostNotAllowed=!1,t.clickedDetachCard()},t.clickedPostAnotherCharge=function(){t.init(),t.chargePosted=!1,e.$broadcast("RESETPOSTCHARGE")},t.clickedPostAnotherChargeCancel=function(){t.chargePosted=!1,t.closeDialog()},e.$on("CHARGEPOSTED",function(e,a){t.guestHasNotCheckedin=!1,t.chargePosted=!0,t.disableOutsidePostChargeButton=!1}),t.keyDownRoom=function(){t.roomSearchStatus=!0},t.keyBlurRoom=function(){t.roomSearchStatus=!1},t.keyDownGuestCompany=function(){t.guestCompanySearchStatus=!0},t.keyBlurGuestCompany=function(){t.guestCompanySearchStatus=!1},t.escapeNullStr=function(e,t){var a="";"undefined"!=typeof t&&null!==t&&(a=t);var i=null===e||"undefined"==typeof e?a:e;return i.indexOf("null")!==-1&&(i=""),i};var u=e.$on("CLICKED_VIEW_CHARGES",function(){t.shouldShowChargesForMobile=!0}),_=e.$on("BACK_TO_CHARGES_LIST",function(){t.shouldShowChargesForMobile=!1});t.$on("$destroy",u),t.$on("$destroy",_)}]),sntRover.controller("RVPostChargeControllerV2",["$rootScope","$scope","RVSearchSrv","$timeout","RVBillCardSrv","ngDialog","rvPermissionSrv","rvAccountTransactionsSrv","RVPostChargeSrvV2",function(e,t,a,i,n,r,s,o,l){BaseCtrl.call(this,t),t.selectedChargeItem=null,t.selectedChargeItemHash={},t.callAPI(n.fetchAdjustmentReasons,{successCallBack:function(e){t.adjustmentReasonOptions=e.force_adjustment_reasons,t.showAdjustmentReason=e.force_adjustment_reason_enabled}}),t.disablePostChargeButton=!1,t.showReason=!1,t.warningMessage="";var c={preventDefault:!1};t.setScroller("items_list",c),t.setScroller("items_summary",c);var d="undefined"!=typeof t.account_id&&""!==t.account_id;t.reservation_id&&(d=!1),t.chargeGroup="FAV",t.net_total_price=0,t.calToggle="QTY";var u=null,p="";t.fetchedData.charge_groups=[],t.fetchedData.pageNo=1,t.fetchedData.perPage=50;var g=function(){var e=function(e){t.fetchedData.charge_groups=e.results,t.$emit("hideLoader")};t.invokeApi(l.fetchChargeGroups,{},e)};g();var m=function(e){t.fetchedData.pageNo=e||1;var a={query:t.query?t.query.toLowerCase():"",page:t.fetchedData.pageNo,per_page:t.fetchedData.perPage,charge_group_id:"FAV"!==t.chargeGroup?t.chargeGroup:"",is_favorite:"FAV"===t.chargeGroup?1:0},n=function(e){t.fetchedItems=[],t.fetchedItems=e.results,t.fetchedData.totalCount=e.total_result;for(var a in t.selectedChargeItemHash){var n=_.find(e.results,function(e){return t.selectedChargeItemHash[a].id===e.id});"undefined"!=typeof n&&(n.count=t.selectedChargeItemHash[a].count)}i(function(){t.$broadcast("updatePagination","POST_CHARGE_PAGINATION"),t.errorMessage="",t.$emit("hideLoader"),t.refreshScroller("items_list")},500)};t.invokeApi(l.searchChargeItems,a,n)};t.$on("$destroy",function(){t.selectedChargeItemHash={}}),t.postChargePaginationObj={id:"POST_CHARGE_PAGINATION",api:m,perPage:t.fetchedData.perPage},m(),t.hasPostChargePermission=function(){return d?s.getPermissionValue("POST_TRANSACTION"):s.getPermissionValue("ADD_CHARGE")},t.shouldDisablePostCharge=function(){return!t.hasPostChargePermission()},t.filterbyChargeGroup=function(){m()};var h=function(){setTimeout(function(){$("#items-summary li.ng-leave.ng-leave-active").remove()},100),t.query="",t.chargeGroup="FAV",m(),t.refreshScroller("items_summary"),t.refreshScroller("items_list")};t.filterByQuery=function(){e.isSingleDigitSearch?(t.chargeGroup="",m()):t.query.length>=3&&(t.chargeGroup="",m())},t.clearQuery=function(){t.query="",m(),t.refreshScroller("items_summary"),t.refreshScroller("items_list")};var y=function(){var e=0;for(var a in t.selectedChargeItemHash)e+=t.selectedChargeItemHash[a].total_price;t.net_total_price=e};t.addItem=function(e){t.showReason=!1,t.warningMessage="",t.calToggle="ITEM"===e.type?"QTY":"PR","undefined"==typeof t.selectedChargeItemHash[e.id]?(t.selectedChargeItemHash[e.id]=e,t.selectedChargeItemHash[e.id].count=1,t.selectedChargeItemHash[e.id].unit_price=parseFloat(t.selectedChargeItemHash[e.id].unit_price),t.selectedChargeItemHash[e.id].modifiedPrice=t.selectedChargeItemHash[e.id].unit_price,t.selectedChargeItemHash[e.id].userEnteredPrice="",t.selectedChargeItemHash[e.id].show_ref_on_invoice=!0,t.selectedChargeItemHash[e.id].reference_text=""):t.selectedChargeItemHash[e.id].count++,t.selectedChargeItemHash[e.id].total_price=t.selectedChargeItemHash[e.id].modifiedPrice*t.selectedChargeItemHash[e.id].count,t.selectedChargeItem=t.selectedChargeItemHash[e.id],y(),t.refreshScroller("items_summary"),angular.forEach(angular.element("#numpad-numbers button"),function(e,t){new FastClick(e)}),angular.forEach(angular.element("#numpad-options button"),function(e,t){new FastClick(e)})},t.removeItem=function(){for(var e in t.selectedChargeItemHash){var a=_.find(t.fetchedItems,function(e){return t.selectedChargeItem.id===e.id});"undefined"!=typeof a&&(a.count=0)}delete t.selectedChargeItemHash[t.selectedChargeItem.id],setTimeout(function(){angular.element(document.querySelector("#items-summary li.selected")).remove()},100),t.selectedChargeItem={},y(),t.refreshScroller("items_summary"),t.calToggle="QTY"},t.selectUnselect=function(e){t.selectedChargeItem&&t.selectedChargeItem.name===e.name?t.selectedChargeItem=null:t.selectedChargeItem=e,p="",u=null,!e.adjustmentReason&&e.total_price<0&&t.showAdjustmentReason?t.showReason=!0:t.showReason=!1},t.calNumAction=function(e){if("QTY"===t.calToggle){var a=t.selectedChargeItem.count.toString();switch(e){case 1:(1!==t.selectedChargeItem.count||null!==u&&"CLR"!==u&&"QTY"!==u)&&(1===t.selectedChargeItem.count&&1===u?t.selectedChargeItem.count=11:(a+=1,t.selectedChargeItem.count=parseInt(a)));break;case".":break;default:1===t.selectedChargeItem.count&&1!==u?"0"!==e&&(t.selectedChargeItem.count=parseInt(e)):(a+=e,t.selectedChargeItem.count=parseInt(a))}t.selectedChargeItem.total_price=t.selectedChargeItem.modifiedPrice*t.selectedChargeItem.count}else{switch(e){case".":t.selectedChargeItem.userEnteredPrice.length&&t.selectedChargeItem.userEnteredPrice.indexOf(".")===-1&&(t.selectedChargeItem.userEnteredPrice+=".");break;default:t.selectedChargeItem.modifiedPrice===t.selectedChargeItem.unit_price?(t.selectedChargeItem.userEnteredPrice+=e,t.selectedChargeItem.modifiedPrice=parseFloat(t.selectedChargeItem.userEnteredPrice)):(t.selectedChargeItem.userEnteredPrice+=e,t.selectedChargeItem.userEnteredPrice.split(".")[1]&&t.selectedChargeItem.userEnteredPrice.split(".")[1].length>2&&(t.selectedChargeItem.userEnteredPrice=t.selectedChargeItem.userEnteredPrice.slice(0,-1)),t.selectedChargeItem.modifiedPrice=parseFloat(t.selectedChargeItem.userEnteredPrice))}t.selectedChargeItem.total_price=t.selectedChargeItem.modifiedPrice*t.selectedChargeItem.count}y(),t.showReason=t.showAdjstmentDropdown(),u=e},t.showAdjstmentDropdown=function(e){return!!(t.selectedChargeItem.total_price<0&&t.showAdjustmentReason)},t.calBtnAction=function(e){if(u=e,t.warningMessage="",t.showReason=t.showAdjstmentDropdown(),"QTY"===e||"PR"===e)return void(t.calToggle=e);if("SIGN"===e)return t.selectedChargeItem.total_price<0?(t.selectedChargeItem.total_price=Math.abs(t.selectedChargeItem.total_price),t.showAdjustmentReason&&(t.showReason=!1)):(t.selectedChargeItem.total_price=-Math.abs(t.selectedChargeItem.total_price),t.showAdjustmentReason&&(t.showReason=!0)),void y();if("CLR"===e){var a="";return"QTY"===t.calToggle&&t.selectedChargeItem.count>1?(a=t.selectedChargeItem.count.toString(),a=parseInt(a.slice(0,-1)),t.selectedChargeItem.count=isNaN(a)?1:a,t.selectedChargeItem.total_price=t.selectedChargeItem.modifiedPrice*t.selectedChargeItem.count,y()):(t.selectedChargeItem.userEnteredPrice=t.selectedChargeItem.userEnteredPrice.slice(0,-1),"."===t.selectedChargeItem.userEnteredPrice.charAt(t.selectedChargeItem.userEnteredPrice.length-1)&&(t.selectedChargeItem.userEnteredPrice=t.selectedChargeItem.userEnteredPrice.slice(0,-1)),t.selectedChargeItem.userEnteredPrice.length?t.selectedChargeItem.modifiedPrice=parseFloat(t.selectedChargeItem.userEnteredPrice):t.selectedChargeItem.modifiedPrice=t.selectedChargeItem.unit_price,t.selectedChargeItem.total_price=t.selectedChargeItem.modifiedPrice*t.selectedChargeItem.count,y()),void(t.showReason=t.showAdjstmentDropdown())}},t.selectedAdjReason=function(e){t.warningMessage="",t.disablePostChargeButton=!1,t.adjustmentReason=e},t.clearWarningMessage=function(){t.warningMessage=""},t.postCharges=function(){var a=function(e){t.$emit("hideLoader"),t.errorMessage=e,t.disablePostChargeButton=!1},i=[],s={};for(var c in t.selectedChargeItemHash)if(s={},s.value=t.selectedChargeItemHash[c].id,s.is_item="ITEM"===t.selectedChargeItemHash[c].type,s.amount=t.selectedChargeItemHash[c].total_price,s.quantity=t.selectedChargeItemHash[c].count,s.reference_text=t.selectedChargeItemHash[c].reference_text,s.adjustment_reason=t.selectedChargeItemHash[c].adjustmentReason,s.show_ref_on_invoice=t.selectedChargeItemHash[c].show_ref_on_invoice,i.push(s),!s.adjustment_reason&&s.amount<0&&t.showAdjustmentReason)return t.warningMessage="Please fill adjustment reason",t.showReason=!0,void(t.disablePostChargeButton=!0);t.disablePostChargeButton=!0;var u={fetch_total_balance:t.fetchTotalBal,bill_no:t.passActiveBillNo||t.billNumber,total:t.net_total_price,items:i};d?u.account_id=t.account_id:u.reservation_id=t.reservation_id;var p=!1;t.billNumber>t.fetchedData.bill_numbers.length&&(p=!0);var g=function(a){t.$emit("hideLoader"),a.has_crossed_credit_limit?r.open({template:"/assets/partials/bill/rvBillingInfoCreditLimitAlert.html",className:"",closeByDocument:!1,scope:t}):t.isOutsidePostCharge?(e.$emit("CHARGEPOSTED"),e.$broadcast("postcharge.added")):(t.$emit("postcharge.added",a),t.closeDialog())},m=function(){t.$emit("hideLoader"),t.isOutsidePostCharge?(e.$emit("CHARGEPOSTED"),e.$broadcast("postcharge.added")):t.$emit("postcharge.added",u.total_balance_amount),t.closeDialog()};t.applyToBillOne=function(){u.bill_no="1",u.post_to_bill_one=!0,t.invokeApi(l.postCharges,u,m,a)};var h=function(e){u.response_data=e.data,t.$emit("hideLoader"),t.closeDialog(),t.$emit("UPDATE_TRANSACTION_DATA",u)};d||t.restrict_post&&t.hasPermissionToAllowPostWithNoCredit()&&(u.post_anyway=!0);var y=u,v=t.groupConfigData&&t.groupConfigData.summary.is_tax_exempt?t.groupConfigData.summary.tax_exempt_type_id:"",f=[],E=!1;if(_.each(t.taxExemptTypes,function(e){e.id===v&&_.each(e.charge_codes,function(e){f.push(e.charge_code)})}),_.each(t.selectedChargeItemHash,function(e){E=_.contains(f,e.charge_code)}),E)t.errorMessage=["Charge codes belongs to tax exempt type can not be posted"],t.disablePostChargeButton=!1;else if(p){var C={};if(d?C.account_id=t.account_id:C.reservation_id=t.reservation_id,d){var D=function(){t.$emit("hideLoader"),t.invokeApi(o.postCharges,y,h,a)};t.invokeApi(o.createAnotherBill,C,D,a)}else{var D=function(e){if(t.$emit("hideLoader"),t.invokeApi(l.postCharges,y,g),!t.isOutsidePostCharge){t.reservationBillData.bills[e.bill_number-1]={bill_id:e.id,bill_number:e.bill_number,total_amount:0};var a={};a.reviewStatus=!1,a.billNumber=t.billNumber,a.billIndex=t.reservationBillData.bills.length,t.isAllBillsReviewed=!1,t.reviewStatusArray.push(a)}};t.invokeApi(n.createAnotherBill,C,D,a)}}else d?t.invokeApi(o.postCharges,y,h,a):t.invokeApi(l.postCharges,y,g,a)},e.$on("UPDATED_BILLNUMBERS",function(e,a){t.fetchedData.bill_numbers=a.bills,t.billNumber="1",t.chargeGroup="FAV",m()}),t.convertToJSONString=function(e){return JSON.stringify(e)},t.$on("POSTCHARGE",function(e,a){t.postCharges()}),e.$on("RESETPOSTCHARGE",function(e,a){t.selectedChargeItem=null,t.fetchedData.bill_numbers=null,t.selectedChargeItemHash={},h()}),t.closeDialog=function(){e.modalOpened=!1,i(function(){r.close()},200)},t.showItemSummaryList=function(){var e=_.size(t.selectedChargeItemHash),a=!1;return e>0&&(a=!0),a},t.clickedOnViewCharges=function(){t.shouldShowChargesForMobile=!0,e.$emit("CLICKED_VIEW_CHARGES")},t.clickedOnBack=function(){t.shouldShowChargesForMobile=!1,e.$emit("BACK_TO_CHARGES_LIST")}}]),angular.module("sntRover").service("RVPostChargeSrvV2",["$http","$q","BaseWebSrvV2","RVBaseWebSrv",function(e,t,a,i){this.fetchChargeGroups=function(){var e=t.defer(),i="/api/charge_groups.json";return a.getJSON(i).then(function(t){e.resolve(t)},function(t){e.reject(t)}),e.promise},this.postCharges=function(e){var a=t.defer(),n="/staff/items/post_items_to_bill";return i.postJSON(n,e).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.getReservationBillDetails=function(e){var i=t.defer(),n="/api/reservations/"+e+"/bills";return a.getJSON(n).then(function(e){i.resolve(e)},function(e){i.reject(e)}),i.promise},this.searchChargeItems=function(e){var i=t.defer(),n="/api/charge_codes/items_and_charge_codes.json?query="+e.query+"&page="+e.page+"&per_page="+e.per_page+"&charge_group_id="+e.charge_group_id+"&is_favorite="+e.is_favorite;return a.getJSON(n).then(function(e){i.resolve(e)},function(e){i.reject(e)}),i.promise},this.postChargesFromArInvoice=function(e){var i=t.defer(),n="/api/accounts/"+e.accountId+"/ar_transactions/"+e.arTransactionId+"/post_charge_to_invoice";return a.postJSON(n,e.postChargeData).then(function(e){i.resolve(e)},function(e){i.reject(e)}),i.promise}}]),sntRover.controller("rvBillFormatPopupCtrl",["$scope","$rootScope","$filter","RVBillCardSrv","RVContactInfoSrv","ngDialog","$timeout",function(e,t,a,i,n,r,s){var o=200,l=500;BaseCtrl.call(this,e),e.isCompanyCardInvoice=!0,e.disableCompanyCardInvoice=!1,e.disableCompanyGuestToggle=!1,e.hideCompanyCardInvoiceToggle=!0,e.billFormat.isInformationalInvoice=!e.shouldGenerateFinalInvoice&&e.isSettledBill&&e.reservationBillData.is_bill_lock_enabled,e.billFormat.isInformationalInvoiceDisabled=e.isSettledBill&&e.reservationBillData.is_bill_lock_enabled,e.disableToggleAccount=!1;var c=function(){var t={};return e.reservationBillData&&e.reservationBillData.reservation_id?(t.id=e.reservationBillData.reservation_id,t.is_type="Reservation"):(e.hideCompanyCardInvoiceToggle=!1,e.isFromInvoiceSearchScreen&&(null===e.clickedInvoiceData.associated_item.company_card&&null===e.clickedInvoiceData.associated_item.travel_agent_card?e.hideCompanyCardInvoiceToggle=!0:null===e.clickedInvoiceData.associated_item.company_card&&null!==e.clickedInvoiceData.associated_item.travel_agent_card?(e.isCompanyCardInvoice=!1,e.disableCompanyCardInvoice=!0):null!==e.clickedInvoiceData.associated_item.company_card&&null===e.clickedInvoiceData.associated_item.travel_agent_card&&(e.disableCompanyCardInvoice=!0)),e.groupConfigData?(t.id=e.groupConfigData.summary.group_id,t.is_group=!0,t.is_type="Account",d(e.groupConfigData.summary)):(t.id=e.accountConfigData?e.accountConfigData.summary.posting_account_id:e.clickedInvoiceData.associated_item.item_id,t.is_group=!1,t.is_type="Account",e.accountConfigData&&d(e.accountConfigData.summary))),t.bill_no=e.billNo,t};e.closeDialog=function(){t.modalOpened=!1,s(function(){r.close()},o)};var d=function(t){(u(t.company)||u(t.travel_agent))&&(u(t.company)&&u(t.travel_agent)?e.hideCompanyCardInvoiceToggle=!0:!u(t.company)&&u(t.travel_agent)?(e.isCompanyCardInvoice=!0,e.disableCompanyCardInvoice=!0):(e.isCompanyCardInvoice=!1,e.disableCompanyCardInvoice=!0))},u=function(e){return!e||0===e.length},p=function(t){e.$emit("hideLoader"),t.languages&&(t.languages=_.filter(t.languages,{is_show_on_guest_card:!0})),e.languageData=t,e.data.locale=t.selected_language_code},g=function(){var t={};e.reservationBillData&&e.reservationBillData.reservation_id&&(t.reservation_id=e.reservationBillData.reservation_id),e.invokeApi(n.fetchGuestLanguages,t,p)},m=function(){var t=c(),a=function(t){g(),t.data&&t.data.default_bill_settings&&(t.data.default_bill_settings=t.data.default_bill_settings.toString());var a=t.data&&t.data.bill_paid_account_type;"COMPANY"===a?(e.isCompanyCardInvoice=!0,e.disableToggleAccount=!0):"TRAVELAGENT"===a&&(e.isCompanyCardInvoice=!1,e.disableToggleAccount=!0),e.data=t.data,e.setEmailAddress()};e.invokeApi(i.getBillSettingsInfo,t,a)},h=function(){var t={};return e.reservationBillData&&e.reservationBillData.reservation_id?t.reservation_id=e.reservationBillData.reservation_id:(e.groupConfigData?(t.group_id=e.groupConfigData.summary.group_id,t.is_group=!0):(t.account_id=e.isFromInvoiceSearchScreen?e.clickedInvoiceData.associated_item.item_id:e.accountConfigData.summary.posting_account_id,t.is_group=!1),t.type=e.isCompanyCardInvoice?"COMPANY":"TRAVELAGENT"),t.bill_number=e.billNo,t.locale=e.data.locale,e.$emit("hideLoader"),t};e.printBill=function(){var t=h();e.$emit("UPDATE_INFORMATIONAL_INVOICE",e.billFormat.isInformationalInvoice),t.bill_layout=e.data.default_bill_settings,t.is_informational_invoice=e.billFormat.isInformationalInvoice,e.clickedPrint(t)},e.clickedContinueButtonPrintOrEmail=function(){e.isClickedPrint?e.printBill():e.sendEmail()},e.clickedPrintBill=function(){e.shouldGenerateFinalInvoice&&!e.billFormat.isInformationalInvoice?(e.isClickedPrint=!0,e.isInvoiceStepThreeActive=!1,s(function(){e.isInvoiceStepFourActive=!0},l)):e.printBill()},e.sendEmail=function(){var t=h();t.bill_layout=e.data.default_bill_settings,t.to_address=e.data.mailto_address,t.is_informational_invoice=e.billFormat.isInformationalInvoice,e.clickedEmail(t)},e.emailBill=function(){e.shouldGenerateFinalInvoice&&!e.billFormat.isInformationalInvoice?(e.isClickedPrint=!1,e.isInvoiceStepThreeActive=!1,s(function(){e.isInvoiceStepFourActive=!0},l)):e.sendEmail()},e.clickedFinalInvoiceButton=function(){e.isInvoiceStepOneActive=!1,s(function(){e.isInvoiceStepTwoActive=!0},l)},e.clickedProceedButton=function(){e.isInvoiceStepTwoActive=!1,e.isInvoiceStepFourActive=!1,s(function(){e.isInvoiceStepThreeActive=!0},l)},e.clickedCancelButtonProceedScreen=function(){e.isInvoiceStepTwoActive=!1,s(function(){e.isInvoiceStepOneActive=!0},l)};var y=e.$on("UPDATE_WINDOW",function(){e.isInvoiceStepFourActive=!1,s(function(){e.isInvoiceStepFiveActive=!0},l)});e.getPrintButtonClass=function(){var t="blue";return!e.billFormat.isInformationalInvoice&&parseInt(e.reservationBillData.bills[e.currentActiveBill].print_counter,10)>=parseInt(e.reservationBillData.no_of_original_invoices,10)&&e.roverObj.noReprintReEmailInvoice&&0!==parseInt(e.reservationBillData.no_of_original_invoices,10)&&(t="grey"),t},e.isPrintButtonDisabled=function(){var t=!1;return!e.billFormat.isInformationalInvoice&&parseInt(e.reservationBillData.bills[e.currentActiveBill].print_counter,10)>=parseInt(e.reservationBillData.no_of_original_invoices,10)&&e.roverObj.noReprintReEmailInvoice&&0!==parseInt(e.reservationBillData.no_of_original_invoices,10)&&(t=!0),t},e.getEmailButtonClass=function(){var t="blue";return e.data.mailto_address?!e.billFormat.isInformationalInvoice&&parseInt(e.reservationBillData.bills[e.currentActiveBill].email_counter,10)>=parseInt(e.reservationBillData.no_of_original_emails,10)&&e.roverObj.noReprintReEmailInvoice&&0!==parseInt(e.reservationBillData.no_of_original_invoices,10)&&(t="grey"):t="grey",t},e.isEmailButtonDisabled=function(){var t=!1;return e.data.mailto_address?!e.billFormat.isInformationalInvoice&&parseInt(e.reservationBillData.bills[e.currentActiveBill].email_counter,10)>=parseInt(e.reservationBillData.no_of_original_emails,10)&&e.roverObj.noReprintReEmailInvoice&&0!==parseInt(e.reservationBillData.no_of_original_invoices,10)&&(t=!0):t=!0,t},e.clickedInformationalButton=function(){e.billFormat.isInformationalInvoice=!0,e.isInvoiceStepOneActive=!1,s(function(){e.isInvoiceStepThreeActive=!0},l)},e.setEmailAddress=function(){e.isCompanyCardInvoice?e.data.mailto_address=e.data.company_address?e.data.company_address:e.data.to_address:e.data.mailto_address=e.data.travel_agent_address?e.data.travel_agent_address:e.data.to_address};var v=function(){e.data={},m()};e.changeCompanyCardInvoiceToggle=function(){e.isCompanyCardInvoice=!e.isCompanyCardInvoice,e.setEmailAddress()},e.$on("$destroy",y),v()}]),sntRover.controller("RVReceiptPopupController",["$scope","$rootScope","RVBillCardSrv","RVContactInfoSrv","ngDialog","$filter",function(e,t,a,i,n,r){BaseCtrl.call(this,e),e.getEmailButtonClass=function(){var t="blue";return e.data.mailto_address||(t="grey"),t},e.isEmailButtonDisabled=function(){var t=!1;return e.data.mailto_address||(t=!0),t},e.printReceipt=function(){var t=function(t){var a=t.data;if(a.is_copy_of_receipt){var i=a.copy_counter||"";a.receiptHeading=a.receipt_translations.copy_of_receipt.replace("#count",i)}else a.receiptHeading=a.receipt_translations.payment_receipt;e.$emit("PRINT_RECEIPT",a)},i={params:{bill_id:e.billId,transaction_id:e.transactionId,locale:e.data.locale},successCallBack:t};e.callAPI(a.printReceiptData,i)},e.closeDialog=function(){n.close()},e.showEmailSentStatusPopup=function(){n.open({template:"/assets/partials/popups/rvEmailSentStatusPopup.html",className:"",scope:e})},e.emailReceipt=function(){var t=function(){e.statusMsg=r("translate")("EMAIL_SEND_FAILED"),e.status="alert",e.showEmailSentStatusPopup()},i=function(t){e.statusMsg=r("translate")("EMAIL_SENT_SUCCESSFULLY"),e.status="success",e.showEmailSentStatusPopup()},n={params:{bill_id:e.billId,transaction_id:e.transactionId,to_address:e.data.mailto_address,locale:e.data.locale},successCallBack:i,failureCallBack:t};e.callAPI(a.emailReceiptData,n)};var s=function(t){t.languages&&(t.languages=_.filter(t.languages,{is_show_on_guest_card:!0})),e.languageData=t,e.data.locale=t.selected_language_code},o=function(){e.data={};var t={successCallBack:s};e.callAPI(i.fetchGuestLanguages,t)};o()}]),angular.module("sntRover").service("RVBillCardSrv",["$http","$q","BaseWebSrvV2","RVBaseWebSrv","rvBaseWebSrvV2","sntBaseWebSrv","RVGAHelperSrv",function(e,t,a,i,n,r,s){var o=this;this.fetchReservationBillData=function(e){var a=t.defer(),i="/api/reservations/"+e+"/bills_summary";return n.getJSON(i).then(function(e){a.resolve(e.data)},function(e){a.reject(e)}),a.promise},this.fetchAllowanceData=function(e,t,a){var i="/api/bills/"+t+"/allowance_transactions";return n.getJSON(i).then(function(t){t.allowance_data&&t.allowance_data.allowance_entries&&t.allowance_data.allowance_entries.length&&(_.each(t.allowance_data.allowance_entries,function(e,a){e.entriesForTheDate=_.filter(t.allowance_data.allowance_entries,function(t){return t.date===e.date}),e.amount=e.amount?parseFloat(e.amount):e.amount}),a.allowance_data=t.allowance_data),e.resolve(a)},function(t){e.reject(t)}),e.promise},this.fetchReservationAllowanceTransactions=function(e){const t="/api/reservations/"+e+"/allowance_transactions";return n.getJSON(t).then(function(e){var t={dataByAllowance:[],dataByDate:[]};return e.allowance_data&&e.allowance_data.allowance_entries&&e.allowance_data.allowance_entries.length&&(t.dataByAllowance=_.groupBy(e.allowance_data.allowance_entries,function(e){return e.addon_id}),t.dataByDate=_.groupBy(e.allowance_data.allowance_entries,function(e){return e.date})),t.amount=e.allowance_data.amount,t},function(){})},this.searchAllowanceShares=function(e){var a=t.defer(),i="/api/reservations/"+e.reservationId+"/search_reservations_for_allowance_share";
return n.getJSON(i,{query:e.query}).then(function(e){a.resolve(e.data)},function(e){a.reject(e)}),a.promise},this.saveAllowanceShares=function(e){var i=t.defer(),n="/api/reservations/"+e.reservationId+"/route_allowance";return a.postJSON(n,e.data).then(function(e){i.resolve(e)},function(e){i.reject(e)}),i.promise},this.fetchBillData=function(e){var a=t.defer(),i="/api/bills/"+e;return n.getJSON(i).then(function(e){a.resolve(e.data)},function(e){a.reject(e)}),a.promise},this.fetch=function(e){var a="",i=t.defer(),n="",r="";return t.when().then(function(){return o.fetchReservationBillData(e).then(function(e){a=e})}).then(function(){return n=a.bills[0].bill_id,r=parseInt(a.bills[0].bill_number)-1,o.fetchBillData(n).then(function(e){a.bills[r]=e})}).then(function(){a.groupedAllowances={},i.resolve(a)},function(e){i.reject(e)}),i.promise},this.fetchBillPrintData=function(e){var a=t.defer(),n="staff/bills/print_guest_bill";return i.postJSON(n,e).then(function(e){e.charge_details_list=[],angular.forEach(e.fee_details,function(t,a){angular.forEach(t.charge_details,function(a){a.date=t.date,a.isCredit=!1,e.charge_details_list.push(a)}),angular.forEach(t.credit_details,function(a){a.date=t.date,a.isCredit=!0,e.charge_details_list.push(a)})}),a.resolve(e)},function(e){a.reject(e)}),a.promise},this.fetchRegistrationCardPrintData=function(e){var a=t.defer(),i="/api/registration_cards/"+e.reservation_id;return n.getJSON(i,e).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.movetToAnotherBill=function(e){var i=t.defer(),n="/staff/bills/transfer_transaction";return a.postJSON(n,e).then(function(e){i.resolve(e)},function(e){i.reject(e)}),i.promise},this.setBillAddressType=function(e){var i=t.defer(),n="/api/bills/"+e.bill_id+"/save_address_type";return a.postJSON(n,e.parmasToApi).then(function(e){i.resolve(e)},function(e){i.reject(e)}),i.promise},this.completeCheckin=function(e){var a=t.defer(),n="/staff/checkin";return i.postJSON(n,e).then(function(t){s.sendEventToGA("CHECKIN",e.reservation_id),a.resolve(t)},function(e){a.reject(e)}),a.promise},this.completeCheckout=function(e){var a=t.defer(),n="/staff/checkout";return i.postJSON(n,e).then(function(t){s.sendEventToGA("CHECKOUT",e.reservation_id),a.resolve(t)},function(e){a.reject(e)}),a.promise},this.getAdvanceBill=function(e){var a=t.defer(),n="api/reservations/"+e.id+"/advance_bill";return i.postJSON(n).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.transactionEdit=function(e){var i=t.defer(),n="api/financial_transactions/"+e.id;return a.putJSON(n,e.updatedData).then(function(e){i.resolve(e)},function(e){i.reject(e)}),i.promise},this.transactionEditChargeDescription=function(e){var i=t.defer(),n="api/financial_transactions/"+e.id+"/save_custom_description";return a.postJSON(n,e.postData).then(function(e){i.resolve(e)},function(e){i.reject(e)}),i.promise},this.transactionDelete=function(e){var i=t.defer(),n=e.id,r="api/financial_transactions/"+n;return a.putJSON(r,e.data).then(function(e){i.resolve(e)},function(e){i.reject(e)}),i.promise},this.transactionSplit=function(e){var i=t.defer(),n=e.id,r="api/financial_transactions/"+n;return a.putJSON(r,e.data).then(function(e){i.resolve(e)},function(e){i.reject(e)}),i.promise},this.fetchChargeCodes=function(){var e=t.defer(),i="/api/charge_codes?exclude_payments=true&per_page=1000";return a.getJSON(i).then(function(t){e.resolve(t)},function(t){e.reject(t)}),e.promise},this.fetchAdjustmentReasons=function(){var e=t.defer(),i="/admin/force_adjustment_reasons";return a.getJSON(i).then(function(t){e.resolve(t)},function(t){e.reject(t)}),e.promise},this.sendEmail=function(e){var i=t.defer(),n="api/reservations/email_guest_bill.json";return a.postJSON(n,e).then(function(e){i.resolve(e)},function(e){i.reject(e)}),i.promise},this.createAnotherBill=function(e){var i=t.defer(),n="/api/bills/create_bill";return a.postJSON(n,e).then(function(e){i.resolve(e)},function(e){i.reject(e)}),i.promise},this.changeHousekeepingStatus=function(e){var i=t.defer(),n="/house/change_house_keeping_status.json";return a.postJSON(n,e).then(function(e){i.resolve(e)},function(e){i.reject(e)}),i.promise},this.completeReverseCheckout=function(e){var i=t.defer(),n="/staff/reverse_checkout";return a.postJSON(n,e).then(function(e){i.resolve(e)},function(e){i.reject(e)}),i.promise},this.toggleHideRate=function(e){var i=t.defer(),n="api/reservations/"+e.reservation_id+"/hide_rates";return a.postJSON(n,e).then(function(e){i.resolve(e)},function(e){i.reject(e)}),i.promise},this.getBillSettingsInfo=function(e){var i=t.defer(),n="/api/bills/get_settings_info";return a.getJSON(n,e).then(function(e){i.resolve(e)},function(e){i.reject(e)}),i.promise},this.groupChargeDetailsFetch=function(e){var i=t.defer(),n="/staff/reservation/transaction_details";return a.getJSON(n,e).then(function(e){i.resolve(e.data)},function(e){i.reject(e)}),i.promise},this.hideBill=function(e){var i=t.defer(),n="/api/bills/"+e.bill_id+"/hide_bill";return a.postJSON(n).then(function(e){i.resolve(e.data)},function(e){i.reject(e)}),i.promise},this.fetchGuestLanguages=function(e){var a=t.defer(),i="/api/guest_languages";return n.getJSON(i,e).then(function(e){e.languages&&(e.languages=_.filter(e.languages,{is_show_on_guest_card:!0})),a.resolve(e)},function(e){a.reject(e)}),a.promise},this.callBlackBoxApi=function(e){var i=t.defer(),n="/api/hotel_settings/infrasec/generate_control_code";return a.postJSON(n,e).then(function(e){i.resolve(e.data)},function(e){i.reject(e)}),i.promise},this.generateFolioNumber=function(e){var i=t.defer(),n="/api/bills/"+e.bill_id+"/generate_folio_number";return a.postJSON(n,e).then(function(e){i.resolve(e.data)},function(e){i.reject(e)}),i.promise},this.generateVoidBill=function(e){var i=t.defer(),n="/api/bills/"+e.bill_id+"/void_bill";return a.postJSON(n,e.data).then(function(e){i.resolve(e.data)},function(e){i.reject(e)}),i.promise},this.settleFinalInvoice=function(e){var i=t.defer(),n="/api/bills/"+e.bill_id+"/final_invoice_settlement";return a.postJSON(n,e).then(function(e){i.resolve(e)},function(e){i.reject(e)}),i.promise},this.printReceiptData=function(e){var a=t.defer(),i="/api/bills/"+e.bill_id+"/print_payment_receipt";return r.postJSON(i,e).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise},this.emailReceiptData=function(e){var a=t.defer(),i="/api/bills/"+e.bill_id+"/email_payment_receipt";return r.postJSON(i,e).then(function(e){a.resolve(e)},function(e){a.reject(e)}),a.promise}}]),angular.module("sntRover").service("RVBillinginfoSrv",["$http","$q","BaseWebSrvV2","RVBaseWebSrv",function(e,t,a,i){this.fetchRoutes=function(e){var i=t.defer(),n="api/bill_routings/"+e+"/attached_entities";return a.getJSON(n).then(function(e){i.resolve(e)},function(e){i.reject(e)}),i.promise},this.fetchAttachedCards=function(e){var i=t.defer(),n="api/bill_routings/"+e+"/attached_cards";return a.getJSON(n).then(function(e){i.resolve(e)},function(e){i.reject(e)}),i.promise},this.fetchAvailableBillingGroups=function(e){var i=t.defer(),n="api/bill_routings/billing_groups?id="+e.id+"&to_bill="+e.to_bill+"&is_new="+e.is_new;return e.from_date&&(n=n+"&from_date="+e.from_date),e.to_date&&(n=n+"&to_date="+e.to_date),a.getJSON(n).then(function(e){i.resolve(e)},function(e){i.reject(e)}),i.promise},this.fetchAvailableChargeCodes=function(e){var i=t.defer(),n="api/bill_routings/charge_codes?id="+e.id+"&to_bill="+e.to_bill+"&is_new="+e.is_new;return e.from_date&&(n=n+"&from_date="+e.from_date),e.to_date&&(n=n+"&to_date="+e.to_date),a.getJSON(n).then(function(e){i.resolve(e)},function(e){i.reject(e)}),i.promise},this.fetchAllBillingGroups=function(){var e=t.defer(),i="/api/bill_routings/billing_groups?is_default_routing=true";return a.getJSON(i).then(function(t){e.resolve(t)},function(t){e.reject(t)}),e.promise},this.fetchAllChargeCodes=function(){var e=t.defer(),i="/api/bill_routings/charge_codes?is_default_routing=true";return a.getJSON(i).then(function(t){e.resolve(t)},function(t){e.reject(t)}),e.promise},this.fetchBillsForReservation=function(e){var i=t.defer(),n="api/bill_routings/"+e.id+"/bills.json";return""!==e.entity_type&&(n="api/bill_routings/"+e.id+"/bills.json?entity_type="+e.entity_type),a.getJSON(n).then(function(e){i.resolve(e)},function(e){i.reject(e)}),i.promise},this.saveRoute=function(e){var i=t.defer(),n="api/bill_routings/save_routing";return a.postJSON(n,e).then(function(e){i.resolve(e)},function(e){i.reject(e)}),i.promise},this.saveDefaultAccountRouting=function(e){var i=t.defer(),n="api/default_account_routings/save";return a.postJSON(n,e).then(function(e){i.resolve(e)},function(e){i.reject(e)}),i.promise},this.saveAllotmentDefaultAccountRouting=function(e){var i=t.defer(),n="api/default_account_routings/save_allotment_default_billing_info";return a.postJSON(n,e).then(function(e){i.resolve(e)},function(e){i.reject(e)}),i.promise},this.deleteRoute=function(e){var i=t.defer(),n="api//bill_routings/delete_routing";return a.postJSON(n,e).then(function(e){i.resolve(e)},function(e){i.reject(e)}),i.promise},this.fetchDefaultAccountRouting=function(e){var i=t.defer(),n="undefined"!=typeof e.entity_type&&""!==e.entity_type?"/api/default_account_routings/"+e.id+"?entity_type="+e.entity_type:"/api/default_account_routings/"+e.id;return a.getJSON(n).then(function(e){i.resolve(e)},function(e){i.reject(e)}),i.promise},this.deleteDefaultRouting=function(e){var i=t.defer(),n="api/default_account_routings/"+e.id;return a.deleteJSON(n).then(function(e){i.resolve(e)},function(e){i.reject(e)}),i.promise}}]),angular.module("sntRover").service("RVMoveChargeSrv",["$http","$q","BaseWebSrvV2",function(e,t,a){this.fetchSearchedItems=function(e){var i=t.defer(),n="/api/bills/search_for_associated?search_by_no="+e.number_search+"&search_by_name="+e.text_search+"&bill_id="+e.bill_id;return a.getJSON(n).then(function(e){i.resolve(e)},function(e){i.reject(e)}),i.promise},this.moveChargesToTargetEntity=function(e){var i=t.defer(),n="/api/bills/move_txn_diff_accounts";return a.postJSON(n,e).then(function(e){i.resolve(e)},function(e){i.reject(e)}),i.promise}}]),sntRover.controller("rvAllowancesCtrl",["$scope","RVBillCardSrv","ngDialog",function(e,t,a){BaseCtrl.call(this,e,a),e.keys=Object.keys,e.isActivitiesTabOpen=!0,e.isGroupedByDate=!0,e.shareQuery={query:""},e.shareData=[],e.filteredShareData=[],e.selectedRooms=[],e.groupedSelectedRooms={},e.sharedAllowances={},e.statusMap={RESERVED:"arrival",PRE_CHECKIN:"pre-check-in",CHECKEDIN:"check-in",CHECKEDOUT:"check-out",NOSHOW:"",CANCELED:"cancel"},e.errorMessage="",e.successMessage="",e.toggleGrouping=function(){e.isGroupedByDate=!e.isGroupedByDate},e.switchTab=function(){e.isActivitiesTabOpen=!e.isActivitiesTabOpen,e.isActivitiesTabOpen||e.onQueryUpdate()},e.closeDialog=function(){a.close()},e.filterShareData=function(){try{e.filteredShareData=_.filter(e.shareData,function(t){return!e.hasAllAllowancesShared(t)})}catch(e){console.error(e)}},e.hasAllAllowancesShared=function(t){const a=e.selectedRooms.find(function(e){return e.id===t.id});if(!a)return!1;const i=_.filter(a.allowances,function(e){return e.checked===!0}).length;return i===t.allowances_count},e.toggleCheckedRoom=function(t,a){var i=_.findIndex(e.selectedRooms,function(e){return e.id===t}),n=_.findIndex(e.selectedRooms[i].allowances,function(e){return e.id===a});e.selectedRooms[i].allowances[n].checked=!e.selectedRooms[i].allowances[n].checked},e.isRoomChecked=function(t,a){var i=_.findIndex(e.selectedRooms,function(e){return e.id===t}),n=_.findIndex(e.selectedRooms[i].allowances,function(e){return e.id===a});return e.selectedRooms[i].allowances[n]&&e.selectedRooms[i].allowances[n].checked},e.saveSharing=function(){e.error="";var a=_.flatten(_.map(e.selectedRooms,function(e){return{id:e.id,allowances:_.filter(e.allowances,function(e){return e.checked})}})),i=_.map(a,function(e){return{to_reservation_id:e.id,allowances:_.map(e.allowances,function(e){return{id:e.id,name:e.name,description:e.description}})}}),n={shared_allowances:i};e.callAPI(t.saveAllowanceShares,{params:{reservationId:e.reservationBillData.reservation_id,data:n},successCallBack:function(t){return t.errors.length?void e.errorMessage.response.errors.join(". "):(e.onQueryUpdate(),void(t.data.length&&(e.successMessage=t.data)))},failureCallBack:function(t){e.errorMessage=t}})},e.onSelectRoom=function(t,a){const i=angular.copy(t);if(a)a.preventDefault(),a.stopImmediatePropagation(),e.selectedRooms=_.filter(e.selectedRooms,function(e){return e.id!==t.id}),i.allowances=_.map(i.allowances,function(e){return e.checked=!0,e});else{const n=_.map(i.shared_allowances,function(e){return e.allowances});i.allowances=_.map(_.flatten(n),function(e){return e.checked=!0,e})}e.selectedRooms.push(i);var r;try{r=a?_.map(e.selectedRooms,function(e){var t=e.allowances;return _.each(e.allowances,function(a,i){t[i].id=a.id,t[i].room_id=e.id,t[i].firstname=e.firstname,t[i].lastname=e.lastname,t[i].room=e.room,t[i].reservation_status=e.reservation_status.value}),t}):_.map(e.selectedRooms,function(e){var a=_.flatten(_.map(e.shared_allowances,function(e){return e.allowances}));return _.each(a,function(i,n){a[n].id=i.id,a[n].room_id=t.id,a[n].firstname=e.firstname,a[n].lastname=e.lastname,a[n].room=e.room,a[n].reservation_status=e.reservation_status.value,a[n].checked=!0}),a}),e.groupedSelectedRooms=_.groupBy(_.flatten(r),function(e){return e.id})}catch(e){console.error(e)}return e.filterShareData(),!1},e.onQueryUpdate=function(){e.callAPI(t.searchAllowanceShares,{params:{reservationId:e.reservationBillData.reservation_id,query:e.shareQuery.query},successCallBack:function(t){e.selectedRooms=[],e.shareData=t.results,e.filterShareData(),_.each(t.results,function(t){t.shared_allowances.length>0&&e.onSelectRoom(t)});const a=_.map(t.results,function(e){var t=_.flatten(_.map(e.shared_allowances,function(e){return e.allowances}));return _.each(t,function(a,i){t[i].id=a.id,t[i].room_id=e.id,t[i].firstname=e.firstname,t[i].lastname=e.lastname,t[i].room=e.room,t[i].reservation_status=e.reservation_status.value,t[i].checked=!0}),t});try{e.groupedSelectedRooms=_.groupBy(_.flatten(a),function(e){return e.id}),e.successMessage=""}catch(e){console.error(e)}},failureCallBack:function(t){e.errorMessage=t,e.groupedAllowanceData=!1,e.sharedData=[]}})},e.debounceQueryUpdate=_.debounce(e.onQueryUpdate,500),e.onQueryUpdate()}]);