sntRover.controller("RVOutsidePostChargeController",["$rootScope","$scope","RVPostChargeSrvV2","RVSearchSrv","$timeout","ngDialog","$stateParams","rvPermissionSrv",function(e,t,r,n,a,o,s,i){BaseCtrl.call(this,t),t.reservationsArray=[],t.fetchedData={},t.isOutsidePostCharge=!0,t.shouldShowChargesForMobile=!1,t.init=function(){t.itemsVisible=!0,t.firstTime=!0,t.search={},t.search.guest_company_agent="",t.search.room="",t.showInitialSearchScreen=!1,t.showSearchScreen=!1,t.isCardAttched=!1,t.noGuestOrRoomSelected=!1,t.guestHasNotCheckedin=!1,t.selectedReservationPostNotAllowed=!1,t.chargePosted=!1,t.cardAttached={},t.disableOutsidePostChargeButton=!1},t.init(),t.closeDialog=function(){e.modalOpened=!1,a(function(){o.close()},200)};var c="",l="";t.setScroller("result_showing_area_post_charg",{click:!0,tap:!0}),t.roomSearchStatus=!1,t.guestCompanySearchStatus=!1;var u=function(){a(function(){t.myScroll&&t.myScroll.result_showing_area_post_charg&&t.myScroll.result_showing_area_post_charg.refresh(),t.refreshScroller("result_showing_area_post_charg")},500)};t.searchForResultsSuccess=function(e){t.$emit("hideLoader"),t.reservationsArray=e,c=t.search.guest_company_agent,l=t.search.room,angular.forEach(t.reservationsArray,function(e,t){e.shouldShowReservation=!0}),0===t.reservationsArray.length&&(t.showNoMatches=!0),t.showInitialSearchScreen=!1,u()},t.searchForResults=function(){t.showNoMatches=!1,t.refreshApi=!0,0===t.search.guest_company_agent.length&&0===t.search.room.length&&(t.showInitialSearchScreen=!0,t.$apply()),0===t.search.guest_company_agent.length&&0===t.search.room.length&&0===t.reservationsArray.length&&(t.showInitialSearchScreen=!0);var r=!1;if(t.search.guest_company_agent.length>=3&&(r=!0),t.search.room.length>=3&&!e.isSingleDigitSearch&&(r=!0),t.search.room.length>=1&&e.isSingleDigitSearch&&(r=!0),!r)return!1;c.length>0?c.length<t.search.guest_company_agent.length&&t.search.guest_company_agent.indexOf(c)!==-1&&(t.refreshApi=!0):l.length>0&&l.length<t.search.room.length&&t.search.room.indexOf(l)!==-1&&(t.refreshApi=!1);var a={refreshApi:t.refreshApi,postData:{room_no:t.search.room,account:t.search.guest_company_agent}};t.invokeApi(n.fetchReservationsToPostCharge,a,t.searchForResultsSuccess),t.itemsVisible=!1},t.clickedCancel=function(){t.search.guest_company_agent="",t.search.room="",t.showInitialSearchScreen=!0,t.reservationsArray.length=0,t.showNoMatches=!1,t.itemsVisible=!1,t.showSearchScreen=!1},t.showHideInitialSearchScreen=function(){0===t.search.guest_company_agent.length&&0===t.search.room.length&&0===t.reservationsArray.length&&(t.showInitialSearchScreen=!0),t.showSearchScreen=!0,t.itemsVisible=!1},t.successGetBillDetails=function(r){t.$emit("hideLoader"),r.isFromOut=!0,e.$broadcast("UPDATED_BILLNUMBERS",r)},t.clickedReservationToPostCharge=function(e){t.selectedReservationId=e.id,e.restrict_post?t.selectedReservationPostNotAllowed=!0:(t.showPostChargesScreen(),t.invokeApi(r.getReservationBillDetails,t.selectedReservationId,t.successGetBillDetails))},t.proceedWithPostCharge=function(){event.stopImmediatePropagation(),t.selectedReservationPostNotAllowed=!1,t.showPostChargesScreen(),t.invokeApi(r.getReservationBillDetails,t.selectedReservationId,t.successGetBillDetails)},t.showPostChargesScreen=function(){t.showInitialSearchScreen=!1,t.showSearchScreen=!1},t.hasPermissionToAllowPostWithNoCredit=function(){return i.getPermissionValue("ALLOW_POST_WHEN_RESTRICTED")},t.getGuestStatusMapped=function(e,t){var r="";return t&&"CHECKING_OUT"===e?r="late-check-out":("RESERVED"===e?r="arrival":"CHECKING_IN"===e?r="check-in":"CHECKEDIN"===e?r="inhouse":"CHECKEDOUT"===e?r="departed":"CHECKING_OUT"===e?r="check-out":"CANCELED"===e?r="cancel":"NOSHOW"!==e&&"NOSHOW_CURRENT"!==e||(r="no-show"),r)},t.getRoomStatusMapped=function(e,t){var r="";return r="READY"===e&&"VACANT"===t?"ready":"not-ready"},t.escapeNull=function(e,t){var r="";"undefined"!=typeof t&&null!==t&&(r=t);var n=null===e||"undefined"==typeof e?r:e;return n},t.getReservationClass=function(e){var t={CHECKING_IN:"guest-check-in",CHECKEDIN:"guest-inhouse",CHECKING_OUT:"guest-check-out",CANCELED:"guest-cancel",NOSHOW:"guest-no-show",NOSHOW_CURRENT:"guest-no-show"};if(e.toUpperCase()in t)return t[e.toUpperCase()]},t.getQueueClass=function(e,t){var r="";return"true"===e&&"true"===t&&(r="queued"),r},t.getMappedClassWithResStatusAndRoomStatus=function(e,t,r,n,a){var o="room-number";if("CHECKING_IN"===e)switch(n){case"INSPECTED":o+=" room-green";break;case"CLEAN":if("true"===a){o+=" room-orange";break}o+=" room-green";break;case"PICKUP":o+=" room-orange";break;case"DIRTY":o+=" room-red"}return o},t.selectReservation=function(e){t.isCardAttched=!0,t.cardAttached=e},t.clickedDetachCard=function(e){t.isCardAttched=!1,t.cardAttached={},t.search.room="",t.search.guest_company_agent="",t.fetchedData.bill_numbers=[]},t.clickedPostCharges=function(r){r.stopImmediatePropagation(),r.stopPropagation(),t.isCardAttched?"CHECKING_IN"===t.cardAttached.reservation_status||"RESERVED"===t.cardAttached.reservation_status?t.guestHasNotCheckedin=!0:(t.reservation_id=t.cardAttached.id,t.restrict_post=t.cardAttached.restrict_post,e.$broadcast("POSTCHARGE"),t.disableOutsidePostChargeButton=!0):t.noGuestOrRoomSelected=!0},t.clickedAddGuestOrRoom=function(){t.noGuestOrRoomSelected=!1,t.showHideInitialSearchScreen()},t.clickedAddGuestOrRoomCancel=function(){t.noGuestOrRoomSelected=!1},t.clickedPostCharge=function(r){r.stopImmediatePropagation(),r.stopPropagation(),t.guestHasNotCheckedin=!1,t.reservation_id=t.cardAttached.id,t.restrict_post=t.cardAttached.restrict_post,e.$broadcast("POSTCHARGE"),t.disableOutsidePostChargeButton=!0},t.clickedPostChargeCancel=function(){t.guestHasNotCheckedin=!1,t.selectedReservationPostNotAllowed=!1,t.clickedDetachCard()},t.clickedPostAnotherCharge=function(){t.init(),t.chargePosted=!1,e.$broadcast("RESETPOSTCHARGE")},t.clickedPostAnotherChargeCancel=function(){t.chargePosted=!1,t.closeDialog()},e.$on("CHARGEPOSTED",function(e,r){t.guestHasNotCheckedin=!1,t.chargePosted=!0,t.disableOutsidePostChargeButton=!1}),t.keyDownRoom=function(){t.roomSearchStatus=!0},t.keyBlurRoom=function(){t.roomSearchStatus=!1},t.keyDownGuestCompany=function(){t.guestCompanySearchStatus=!0},t.keyBlurGuestCompany=function(){t.guestCompanySearchStatus=!1},t.escapeNullStr=function(e,t){var r="";"undefined"!=typeof t&&null!==t&&(r=t);var n=null===e||"undefined"==typeof e?r:e;return n.indexOf("null")!==-1&&(n=""),n};var h=e.$on("CLICKED_VIEW_CHARGES",function(){t.shouldShowChargesForMobile=!0}),d=e.$on("BACK_TO_CHARGES_LIST",function(){t.shouldShowChargesForMobile=!1});t.$on("$destroy",h),t.$on("$destroy",d)}]),sntRover.controller("RVPostChargeControllerV2",["$rootScope","$scope","RVSearchSrv","$timeout","RVBillCardSrv","ngDialog","rvPermissionSrv","rvAccountTransactionsSrv","RVPostChargeSrvV2",function(e,t,r,n,a,o,s,i,c){BaseCtrl.call(this,t),t.selectedChargeItem=null,t.selectedChargeItemHash={},t.callAPI(a.fetchAdjustmentReasons,{successCallBack:function(e){t.adjustmentReasonOptions=e.force_adjustment_reasons,t.showAdjustmentReason=e.force_adjustment_reason_enabled}}),t.disablePostChargeButton=!1,t.showReason=!1,t.warningMessage="";var l={preventDefault:!1};t.setScroller("items_list",l),t.setScroller("items_summary",l);var u="undefined"!=typeof t.account_id&&""!==t.account_id;t.reservation_id&&(u=!1),t.chargeGroup="FAV",t.net_total_price=0,t.calToggle="QTY";var h=null,d="";t.fetchedData.charge_groups=[],t.fetchedData.pageNo=1,t.fetchedData.perPage=50;var f=function(){var e=function(e){t.fetchedData.charge_groups=e.results,t.$emit("hideLoader")};t.invokeApi(c.fetchChargeGroups,{},e)};f();var g=function(e){t.fetchedData.pageNo=e||1;var r={query:t.query?t.query.toLowerCase():"",page:t.fetchedData.pageNo,per_page:t.fetchedData.perPage,charge_group_id:"FAV"!==t.chargeGroup?t.chargeGroup:"",is_favorite:"FAV"===t.chargeGroup?1:0},a=function(e){t.fetchedItems=[],t.fetchedItems=e.results,t.fetchedData.totalCount=e.total_result;for(var r in t.selectedChargeItemHash){var a=_.find(e.results,function(e){return t.selectedChargeItemHash[r].id===e.id});"undefined"!=typeof a&&(a.count=t.selectedChargeItemHash[r].count)}n(function(){t.$broadcast("updatePagination","POST_CHARGE_PAGINATION"),t.errorMessage="",t.$emit("hideLoader"),t.refreshScroller("items_list")},500)};t.invokeApi(c.searchChargeItems,r,a)};t.$on("$destroy",function(){t.selectedChargeItemHash={}}),t.postChargePaginationObj={id:"POST_CHARGE_PAGINATION",api:g,perPage:t.fetchedData.perPage},g(),t.hasPostChargePermission=function(){return u?s.getPermissionValue("POST_TRANSACTION"):s.getPermissionValue("ADD_CHARGE")},t.shouldDisablePostCharge=function(){return!t.hasPostChargePermission()},t.filterbyChargeGroup=function(){g()};var p=function(){setTimeout(function(){$("#items-summary li.ng-leave.ng-leave-active").remove()},100),t.query="",t.chargeGroup="FAV",g(),t.refreshScroller("items_summary"),t.refreshScroller("items_list")};t.filterByQuery=function(){e.isSingleDigitSearch?(t.chargeGroup="",g()):t.query.length>=3&&(t.chargeGroup="",g())},t.clearQuery=function(){t.query="",g(),t.refreshScroller("items_summary"),t.refreshScroller("items_list")};var m=function(){var e=0;for(var r in t.selectedChargeItemHash)e+=t.selectedChargeItemHash[r].total_price;t.net_total_price=e};t.addItem=function(e){t.showReason=!1,t.warningMessage="",t.calToggle="ITEM"===e.type?"QTY":"PR","undefined"==typeof t.selectedChargeItemHash[e.id]?(t.selectedChargeItemHash[e.id]=e,t.selectedChargeItemHash[e.id].count=1,t.selectedChargeItemHash[e.id].unit_price=parseFloat(t.selectedChargeItemHash[e.id].unit_price),t.selectedChargeItemHash[e.id].modifiedPrice=t.selectedChargeItemHash[e.id].unit_price,t.selectedChargeItemHash[e.id].userEnteredPrice="",t.selectedChargeItemHash[e.id].show_ref_on_invoice=!0,t.selectedChargeItemHash[e.id].reference_text=""):t.selectedChargeItemHash[e.id].count++,t.selectedChargeItemHash[e.id].total_price=t.selectedChargeItemHash[e.id].modifiedPrice*t.selectedChargeItemHash[e.id].count,t.selectedChargeItem=t.selectedChargeItemHash[e.id],m(),t.refreshScroller("items_summary"),angular.forEach(angular.element("#numpad-numbers button"),function(e,t){new FastClick(e)}),angular.forEach(angular.element("#numpad-options button"),function(e,t){new FastClick(e)})},t.removeItem=function(){for(var e in t.selectedChargeItemHash){var r=_.find(t.fetchedItems,function(e){return t.selectedChargeItem.id===e.id});"undefined"!=typeof r&&(r.count=0)}delete t.selectedChargeItemHash[t.selectedChargeItem.id],setTimeout(function(){angular.element(document.querySelector("#items-summary li.selected")).remove()},100),t.selectedChargeItem={},m(),t.refreshScroller("items_summary"),t.calToggle="QTY"},t.selectUnselect=function(e){t.selectedChargeItem&&t.selectedChargeItem.name===e.name?t.selectedChargeItem=null:t.selectedChargeItem=e,d="",h=null,!e.adjustmentReason&&e.total_price<0&&t.showAdjustmentReason?t.showReason=!0:t.showReason=!1},t.calNumAction=function(e){if("QTY"===t.calToggle){var r=t.selectedChargeItem.count.toString();switch(e){case 1:(1!==t.selectedChargeItem.count||null!==h&&"CLR"!==h&&"QTY"!==h)&&(1===t.selectedChargeItem.count&&1===h?t.selectedChargeItem.count=11:(r+=1,t.selectedChargeItem.count=parseInt(r)));break;case".":break;default:1===t.selectedChargeItem.count&&1!==h?"0"!==e&&(t.selectedChargeItem.count=parseInt(e)):(r+=e,t.selectedChargeItem.count=parseInt(r))}t.selectedChargeItem.total_price=t.selectedChargeItem.modifiedPrice*t.selectedChargeItem.count}else{switch(e){case".":t.selectedChargeItem.userEnteredPrice.length&&t.selectedChargeItem.userEnteredPrice.indexOf(".")===-1&&(t.selectedChargeItem.userEnteredPrice+=".");break;default:t.selectedChargeItem.modifiedPrice===t.selectedChargeItem.unit_price?(t.selectedChargeItem.userEnteredPrice+=e,t.selectedChargeItem.modifiedPrice=parseFloat(t.selectedChargeItem.userEnteredPrice)):(t.selectedChargeItem.userEnteredPrice+=e,t.selectedChargeItem.userEnteredPrice.split(".")[1]&&t.selectedChargeItem.userEnteredPrice.split(".")[1].length>2&&(t.selectedChargeItem.userEnteredPrice=t.selectedChargeItem.userEnteredPrice.slice(0,-1)),t.selectedChargeItem.modifiedPrice=parseFloat(t.selectedChargeItem.userEnteredPrice))}t.selectedChargeItem.total_price=t.selectedChargeItem.modifiedPrice*t.selectedChargeItem.count}m(),t.showReason=t.showAdjstmentDropdown(),h=e},t.showAdjstmentDropdown=function(e){return!!(t.selectedChargeItem.total_price<0&&t.showAdjustmentReason)},t.calBtnAction=function(e){if(h=e,t.warningMessage="",t.showReason=t.showAdjstmentDropdown(),"QTY"===e||"PR"===e)return void(t.calToggle=e);if("SIGN"===e)return t.selectedChargeItem.total_price<0?(t.selectedChargeItem.total_price=Math.abs(t.selectedChargeItem.total_price),t.showAdjustmentReason&&(t.showReason=!1)):(t.selectedChargeItem.total_price=-Math.abs(t.selectedChargeItem.total_price),t.showAdjustmentReason&&(t.showReason=!0)),void m();if("CLR"===e){var r="";return"QTY"===t.calToggle&&t.selectedChargeItem.count>1?(r=t.selectedChargeItem.count.toString(),r=parseInt(r.slice(0,-1)),t.selectedChargeItem.count=isNaN(r)?1:r,t.selectedChargeItem.total_price=t.selectedChargeItem.modifiedPrice*t.selectedChargeItem.count,m()):(t.selectedChargeItem.userEnteredPrice=t.selectedChargeItem.userEnteredPrice.slice(0,-1),"."===t.selectedChargeItem.userEnteredPrice.charAt(t.selectedChargeItem.userEnteredPrice.length-1)&&(t.selectedChargeItem.userEnteredPrice=t.selectedChargeItem.userEnteredPrice.slice(0,-1)),t.selectedChargeItem.userEnteredPrice.length?t.selectedChargeItem.modifiedPrice=parseFloat(t.selectedChargeItem.userEnteredPrice):t.selectedChargeItem.modifiedPrice=t.selectedChargeItem.unit_price,t.selectedChargeItem.total_price=t.selectedChargeItem.modifiedPrice*t.selectedChargeItem.count,m()),void(t.showReason=t.showAdjstmentDropdown())}},t.selectedAdjReason=function(e){t.warningMessage="",t.disablePostChargeButton=!1,t.adjustmentReason=e},t.clearWarningMessage=function(){t.warningMessage=""},t.postCharges=function(){var r=function(e){t.$emit("hideLoader"),t.errorMessage=e,t.disablePostChargeButton=!1},n=[],s={};for(var l in t.selectedChargeItemHash)if(s={},s.value=t.selectedChargeItemHash[l].id,s.is_item="ITEM"===t.selectedChargeItemHash[l].type,s.amount=t.selectedChargeItemHash[l].total_price,s.quantity=t.selectedChargeItemHash[l].count,s.reference_text=t.selectedChargeItemHash[l].reference_text,s.adjustment_reason=t.selectedChargeItemHash[l].adjustmentReason,s.show_ref_on_invoice=t.selectedChargeItemHash[l].show_ref_on_invoice,n.push(s),!s.adjustment_reason&&s.amount<0&&t.showAdjustmentReason)return t.warningMessage="Please fill adjustment reason",t.showReason=!0,void(t.disablePostChargeButton=!0);t.disablePostChargeButton=!0;var h={fetch_total_balance:t.fetchTotalBal,bill_no:t.passActiveBillNo||t.billNumber,total:t.net_total_price,items:n};u?h.account_id=t.account_id:h.reservation_id=t.reservation_id;var d=!1;t.billNumber>t.fetchedData.bill_numbers.length&&(d=!0);var f=function(r){t.$emit("hideLoader"),r.has_crossed_credit_limit?o.open({template:"/assets/partials/bill/rvBillingInfoCreditLimitAlert.html",className:"",closeByDocument:!1,scope:t}):t.isOutsidePostCharge?(e.$emit("CHARGEPOSTED"),e.$broadcast("postcharge.added")):(t.$emit("postcharge.added",r),t.closeDialog())},g=function(){t.$emit("hideLoader"),t.isOutsidePostCharge?(e.$emit("CHARGEPOSTED"),e.$broadcast("postcharge.added")):t.$emit("postcharge.added",h.total_balance_amount),t.closeDialog()};t.applyToBillOne=function(){h.bill_no="1",h.post_to_bill_one=!0,t.invokeApi(c.postCharges,h,g,r)};var p=function(e){h.response_data=e.data,t.$emit("hideLoader"),t.closeDialog(),t.$emit("UPDATE_TRANSACTION_DATA",h)};u||t.restrict_post&&t.hasPermissionToAllowPostWithNoCredit()&&(h.post_anyway=!0);var m=h,v=t.groupConfigData&&t.groupConfigData.summary.is_tax_exempt?t.groupConfigData.summary.tax_exempt_type_id:"",C=[],S=!1;if(_.each(t.taxExemptTypes,function(e){e.id===v&&_.each(e.charge_codes,function(e){C.push(e.charge_code)})}),_.each(t.selectedChargeItemHash,function(e){S=_.contains(C,e.charge_code)}),S)t.errorMessage=["Charge codes belongs to tax exempt type can not be posted"],t.disablePostChargeButton=!1;else if(d){var I={};if(u?I.account_id=t.account_id:I.reservation_id=t.reservation_id,u){var A=function(){t.$emit("hideLoader"),t.invokeApi(i.postCharges,m,p,r)};t.invokeApi(i.createAnotherBill,I,A,r)}else{var A=function(e){if(t.$emit("hideLoader"),t.invokeApi(c.postCharges,m,f),!t.isOutsidePostCharge){t.reservationBillData.bills[e.bill_number-1]={bill_id:e.id,bill_number:e.bill_number,total_amount:0};var r={};r.reviewStatus=!1,r.billNumber=t.billNumber,r.billIndex=t.reservationBillData.bills.length,t.isAllBillsReviewed=!1,t.reviewStatusArray.push(r)}};t.invokeApi(a.createAnotherBill,I,A,r)}}else u?t.invokeApi(i.postCharges,m,p,r):t.invokeApi(c.postCharges,m,f,r)},e.$on("UPDATED_BILLNUMBERS",function(e,r){t.fetchedData.bill_numbers=r.bills,t.billNumber="1",t.chargeGroup="FAV",g()}),t.convertToJSONString=function(e){return JSON.stringify(e)},t.$on("POSTCHARGE",function(e,r){t.postCharges()}),e.$on("RESETPOSTCHARGE",function(e,r){t.selectedChargeItem=null,t.fetchedData.bill_numbers=null,t.selectedChargeItemHash={},p()}),t.closeDialog=function(){e.modalOpened=!1,n(function(){o.close()},200)},t.showItemSummaryList=function(){var e=_.size(t.selectedChargeItemHash),r=!1;return e>0&&(r=!0),r},t.clickedOnViewCharges=function(){t.shouldShowChargesForMobile=!0,e.$emit("CLICKED_VIEW_CHARGES")},t.clickedOnBack=function(){t.shouldShowChargesForMobile=!1,e.$emit("BACK_TO_CHARGES_LIST")}}]),angular.module("sntRover").service("RVPostChargeSrvV2",["$http","$q","BaseWebSrvV2","RVBaseWebSrv",function(e,t,r,n){this.fetchChargeGroups=function(){var e=t.defer(),n="/api/charge_groups.json";return r.getJSON(n).then(function(t){e.resolve(t)},function(t){e.reject(t)}),e.promise},this.postCharges=function(e){var r=t.defer(),a="/staff/items/post_items_to_bill";return n.postJSON(a,e).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.getReservationBillDetails=function(e){var n=t.defer(),a="/api/reservations/"+e+"/bills";return r.getJSON(a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.searchChargeItems=function(e){var n=t.defer(),a="/api/charge_codes/items_and_charge_codes.json?query="+e.query+"&page="+e.page+"&per_page="+e.per_page+"&charge_group_id="+e.charge_group_id+"&is_favorite="+e.is_favorite;return r.getJSON(a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.postChargesFromArInvoice=function(e){var n=t.defer(),a="/api/accounts/"+e.accountId+"/ar_transactions/"+e.arTransactionId+"/post_charge_to_invoice";return r.postJSON(a,e.postChargeData).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise}}]),angular.module("sntRover").service("RVBillCardSrv",["$http","$q","BaseWebSrvV2","RVBaseWebSrv","rvBaseWebSrvV2","sntBaseWebSrv","RVGAHelperSrv",function(e,t,r,n,a,o,s){var i=this;this.fetchReservationBillData=function(e){var r=t.defer(),n="/api/reservations/"+e+"/bills_summary";return a.getJSON(n).then(function(e){r.resolve(e.data)},function(e){r.reject(e)}),r.promise},this.fetchAllowanceData=function(e,t,r){var n="/api/bills/"+t+"/allowance_transactions";return a.getJSON(n).then(function(t){t.allowance_data&&t.allowance_data.allowance_entries&&t.allowance_data.allowance_entries.length&&(_.each(t.allowance_data.allowance_entries,function(e,r){e.entriesForTheDate=_.filter(t.allowance_data.allowance_entries,function(t){return t.date===e.date}),e.amount=e.amount?parseFloat(e.amount):e.amount}),r.allowance_data=t.allowance_data),e.resolve(r)},function(t){e.reject(t)}),e.promise},this.fetchReservationAllowanceTransactions=function(e){const t="/api/reservations/"+e+"/allowance_transactions";return a.getJSON(t).then(function(e){var t={dataByAllowance:[],dataByDate:[]};return e.allowance_data&&e.allowance_data.allowance_entries&&e.allowance_data.allowance_entries.length&&(t.dataByAllowance=_.groupBy(e.allowance_data.allowance_entries,function(e){return e.addon_id}),t.dataByDate=_.groupBy(e.allowance_data.allowance_entries,function(e){return e.date})),t.amount=e.allowance_data.amount,t},function(){})},this.searchAllowanceShares=function(e){var r=t.defer(),n="/api/reservations/"+e.reservationId+"/search_reservations_for_allowance_share";return a.getJSON(n,{query:e.query}).then(function(e){r.resolve(e.data)},function(e){r.reject(e)}),r.promise},this.saveAllowanceShares=function(e){var n=t.defer(),a="/api/reservations/"+e.reservationId+"/route_allowance";return r.postJSON(a,e.data).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchBillData=function(e){var r=t.defer(),n="/api/bills/"+e;return a.getJSON(n).then(function(e){r.resolve(e.data)},function(e){r.reject(e)}),r.promise},this.fetch=function(e){var r="",n=t.defer(),a="",o="";return t.when().then(function(){return i.fetchReservationBillData(e).then(function(e){r=e})}).then(function(){return a=r.bills[0].bill_id,o=parseInt(r.bills[0].bill_number)-1,i.fetchBillData(a).then(function(e){r.bills[o]=e})}).then(function(){r.groupedAllowances={},n.resolve(r)},function(e){n.reject(e)}),n.promise},this.fetchBillPrintData=function(e){var r=t.defer(),a="staff/bills/print_guest_bill";return n.postJSON(a,e).then(function(e){e.charge_details_list=[],angular.forEach(e.fee_details,function(t,r){angular.forEach(t.charge_details,function(r){r.date=t.date,r.isCredit=!1,e.charge_details_list.push(r)}),angular.forEach(t.credit_details,function(r){r.date=t.date,r.isCredit=!0,e.charge_details_list.push(r)})}),r.resolve(e)},function(e){r.reject(e)}),r.promise},this.fetchRegistrationCardPrintData=function(e){var r=t.defer(),n="/api/registration_cards/"+e.reservation_id;return a.getJSON(n,e).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.movetToAnotherBill=function(e){var n=t.defer(),a="/staff/bills/transfer_transaction";return r.postJSON(a,e).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.setBillAddressType=function(e){var n=t.defer(),a="/api/bills/"+e.bill_id+"/save_address_type";return r.postJSON(a,e.parmasToApi).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.completeCheckin=function(e){var r=t.defer(),a="/staff/checkin";return n.postJSON(a,e).then(function(t){s.sendEventToGA("CHECKIN",e.reservation_id),r.resolve(t)},function(e){r.reject(e)}),r.promise},this.completeCheckout=function(e){var r=t.defer(),a="/staff/checkout";return n.postJSON(a,e).then(function(t){s.sendEventToGA("CHECKOUT",e.reservation_id),r.resolve(t)},function(e){r.reject(e)}),r.promise},this.getAdvanceBill=function(e){var r=t.defer(),a="api/reservations/"+e.id+"/advance_bill";return n.postJSON(a).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.transactionEdit=function(e){var n=t.defer(),a="api/financial_transactions/"+e.id;return r.putJSON(a,e.updatedData).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.transactionEditChargeDescription=function(e){var n=t.defer(),a="api/financial_transactions/"+e.id+"/save_custom_description";return r.postJSON(a,e.postData).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.transactionDelete=function(e){var n=t.defer(),a=e.id,o="api/financial_transactions/"+a;return r.putJSON(o,e.data).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.transactionSplit=function(e){var n=t.defer(),a=e.id,o="api/financial_transactions/"+a;return r.putJSON(o,e.data).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchChargeCodes=function(){var e=t.defer(),n="/api/charge_codes?exclude_payments=true&per_page=1000";return r.getJSON(n).then(function(t){e.resolve(t)},function(t){e.reject(t)}),e.promise},this.fetchAdjustmentReasons=function(){var e=t.defer(),n="/admin/force_adjustment_reasons";return r.getJSON(n).then(function(t){e.resolve(t)},function(t){e.reject(t)}),e.promise},this.sendEmail=function(e){var n=t.defer(),a="api/reservations/email_guest_bill.json";return r.postJSON(a,e).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.createAnotherBill=function(e){var n=t.defer(),a="/api/bills/create_bill";return r.postJSON(a,e).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.changeHousekeepingStatus=function(e){var n=t.defer(),a="/house/change_house_keeping_status.json";return r.postJSON(a,e).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.completeReverseCheckout=function(e){var n=t.defer(),a="/staff/reverse_checkout";return r.postJSON(a,e).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.toggleHideRate=function(e){var n=t.defer(),a="api/reservations/"+e.reservation_id+"/hide_rates";return r.postJSON(a,e).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.getBillSettingsInfo=function(e){var n=t.defer(),a="/api/bills/get_settings_info";return r.getJSON(a,e).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.groupChargeDetailsFetch=function(e){var n=t.defer(),a="/staff/reservation/transaction_details";return r.getJSON(a,e).then(function(e){n.resolve(e.data)},function(e){n.reject(e)}),n.promise},this.hideBill=function(e){var n=t.defer(),a="/api/bills/"+e.bill_id+"/hide_bill";return r.postJSON(a).then(function(e){n.resolve(e.data)},function(e){n.reject(e)}),n.promise},this.fetchGuestLanguages=function(e){var r=t.defer(),n="/api/guest_languages";return a.getJSON(n,e).then(function(e){e.languages&&(e.languages=_.filter(e.languages,{is_show_on_guest_card:!0})),r.resolve(e)},function(e){r.reject(e)}),r.promise},this.callBlackBoxApi=function(e){var n=t.defer(),a="/api/hotel_settings/infrasec/generate_control_code";return r.postJSON(a,e).then(function(e){n.resolve(e.data)},function(e){n.reject(e)}),n.promise},this.generateFolioNumber=function(e){var n=t.defer(),a="/api/bills/"+e.bill_id+"/generate_folio_number";return r.postJSON(a,e).then(function(e){n.resolve(e.data)},function(e){n.reject(e)}),n.promise},this.generateVoidBill=function(e){var n=t.defer(),a="/api/bills/"+e.bill_id+"/void_bill";return r.postJSON(a,e.data).then(function(e){n.resolve(e.data)},function(e){n.reject(e)}),n.promise},this.settleFinalInvoice=function(e){var n=t.defer(),a="/api/bills/"+e.bill_id+"/final_invoice_settlement";return r.postJSON(a,e).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.printReceiptData=function(e){var r=t.defer(),n="/api/bills/"+e.bill_id+"/print_payment_receipt";return o.postJSON(n,e).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise},this.emailReceiptData=function(e){var r=t.defer(),n="/api/bills/"+e.bill_id+"/email_payment_receipt";return o.postJSON(n,e).then(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise}}]),angular.module("sntRover").service("rvAccountTransactionsSrv",["$q","rvBaseWebSrvV2","$rootScope",function(e,t,r){this.fetchGroupAllowances=function(e){const r="/api/groups/"+e.id+"/group_allowance_transactions";return t.getJSON(r,{associated_type:e.type}).then(function(e){var t={dataByAllowance:[],dataByDate:[]};e.allowance_data=_.map(e.allowance_data,function(e){return e.ptime=parseInt(e.time.replace(":",""),10),e});try{e.allowance_data&&e.allowance_data.length&&(t.dataByAllowance=_.groupBy(e.allowance_data,function(e){return e.addon_id}),t.dataByDate=_.groupBy(e.allowance_data,function(e){return e.date}),_.each(t.dataByAllowance,function(e,r){t.dataByAllowance[r]=_.sortBy(e,function(e){return e.ptime})}),_.each(t.dataByDate,function(e,r){t.dataByDate[r]=_.sortBy(e,function(e){return e.ptime})}))}catch(e){console.error(e)}return t},function(){})},this.searchAllowanceShares=function(r){var n=e.defer(),a="/api/groups/"+r.groupId+"/group_allowance_search";return t.getJSON(a,{query:r.query,associated_type:r.type}).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.saveAllowanceShares=function(r){var n=e.defer(),a="/api/groups/"+r.groupId+"/group_allowance_share";return t.postJSON(a,{shared_allowances:r.data,associated_type:r.type}).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchTransactionDetails=function(r){var n=e.defer(),a="/api/posting_accounts/"+r.account_id+"/bill_card";return t.getJSON(a).then(function(e){angular.forEach(e.bills,function(e){e.page_no=1,e.transactions=[],e.activeDate=e.days.length>0?_.last(e.days).date:null}),n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchBillTransactionDetails=function(r){var n=e.defer(),a="/api/bills/"+r.bill_id+"/transactions?date="+r.date+"&page="+r.page+"&per_page="+r.per_page;return t.getJSON(a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.createAnotherBill=function(r){var n=e.defer(),a="api/bills/create_bill";return t.postJSON(a,r).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.moveToAnotherBill=function(r){var n=e.defer(),a="api/bills/transfer_transaction";return t.postJSON(a,r).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.transactionEdit=function(r){var n=e.defer(),a=r.id,o=r.updatedDate,s="api/financial_transactions/"+a;return t.putJSON(s,o).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.transactionEditChargeDescription=function(r){var n=e.defer(),a="api/financial_transactions/"+r.id+"/save_custom_description";return t.postJSON(a,r.postData).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.transactionDelete=function(r){var n=e.defer(),a=r.id,o="api/financial_transactions/"+a;return t.putJSON(o,r.data).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.transactionSplit=function(r){var n=e.defer(),a=r.id,o="api/financial_transactions/"+a;return t.putJSON(o,r.data).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.savePaymentDetails=function(r){var n=e.defer(),a="/api/bills/"+r.bill_id+"/add_payment_method";return t.postJSON(a,r.data_to_pass).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.submitPaymentOnBill=function(n){var a=0,o=function(){a++},s=setInterval(o,1e3),i=e.defer(),c="/api/bills/"+n.bill_id+"/submit_payment",l=function(e){if(a>=r.emvTimeout){var n=["Request timed out. Unable to process the transaction"];i.reject(n)}else t.getJSONWithSpecialStatusHandling(e).then(function(t){t.status&&"processing_not_completed"===t.status||"null"===t?setTimeout(function(){console.info("POLLING::-> for emv terminal response"),l(e)},5e3):(clearInterval(s),i.resolve(t))},function(t){"undefined"==typeof t?l(e):(clearInterval(s),i.reject(t))})};return t.postJSONWithSpecialStatusHandling(c,n.data_to_pass).then(function(e){n.data_to_pass.is_emv_request&&e.status&&"processing_not_completed"===e.status?l(e.location_header):(clearInterval(s),i.resolve(e))},function(e){clearInterval(s),i.reject(e)}),i.promise},this.postCharges=function(r){var n=e.defer(),a="/staff/items/post_items_to_bill";return t.postJSON(a,r).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.checkForArAccount=function(r){var n=e.defer(),a="/api/posting_accounts/"+r.account_id+"/check_ar_account_attached";return t.getJSON(a).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.fetchAccountBillsForPrint=function(r){var n=e.defer(),a="/api/posting_accounts/print_bill_card";return t.postJSON(a,r).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise},this.groupChargeDetailsFetch=function(r){var n=e.defer(),a="/api/posting_accounts/transaction_details";return t.getJSON(a,r).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise}}]);