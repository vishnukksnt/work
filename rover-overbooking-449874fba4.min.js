"use strict";angular.module("sntRover").controller("rvAddOverBookingDatePickerCtrl",["$scope","$rootScope",function(e,o){var t=this;t.init=function(){t.minDateSelected=moment(tzIndependentDate(o.businessDate)).format(o.momentFormatForAPI),t.type=e.addOverBookingObj.type,"FROM"===t.type?e.date=e.addOverBookingObj.fromDate:"TO"===t.type&&(e.date=e.addOverBookingObj.toDate)},t.setUpData=function(){e.dateOptions={changeYear:!0,changeMonth:!0,minDate:tzIndependentDate(t.minDateSelected),yearRange:"1:+5",onSelect:function(){e.$emit("DATE_CHANGED",t.type,e.date)}}},t.init(),t.setUpData()}]),angular.module("sntRover").controller("rvAddOverBookingPopupCtrl",["$scope","$rootScope","ngDialog","rvOverBookingSrv",function(e,o,t,n){var r=this;BaseCtrl.call(this,e),r.init=function(){e.addOverBookingObj={fromDate:moment(tzIndependentDate(o.businessDate)).format(o.momentFormatForAPI),toDate:moment(tzIndependentDate(o.businessDate)).format(o.momentFormatForAPI),weekDayList:[{name:"MON",id:1,isChecked:!0},{name:"TUE",id:2,isChecked:!0},{name:"WED",id:3,isChecked:!0},{name:"THU",id:4,isChecked:!0},{name:"FRI",id:5,isChecked:!0},{name:"SAT",id:6,isChecked:!0},{name:"SUN",id:0,isChecked:!0}],applyForHouse:!0,applyForRoomTypes:!1,limitType:"RMS",roomTypeList:dclone(e.overBookingObj.completeRoomTypeListData,[]),limitValue:""},e.setScroller("roomTypeFilterList")},r.datePickerDialogId="",e.showDatePicker=function(o){e.addOverBookingObj.type=o,r.datePickerDialogId=t.open({template:"/assets/partials/overBooking/rvOverBookingDatePicker.html",controller:"rvAddOverBookingDatePickerCtrl",className:"",scope:e,closeByDocument:!0})};var i=e.$on("DATE_CHANGED",function(n,i,a){var l=moment(tzIndependentDate(a)).format(o.momentFormatForAPI);"FROM"===i?(e.addOverBookingObj.fromDate=l,e.addOverBookingObj.toDate=l):"TO"===i&&(e.addOverBookingObj.toDate=l,new tzIndependentDate(a)<new tzIndependentDate(e.addOverBookingObj.fromDate)&&(e.addOverBookingObj.fromDate=l)),t.close(r.datePickerDialogId.id)});e.clickedApplyForHouse=function(){e.addOverBookingObj.applyForHouse=!e.addOverBookingObj.applyForHouse};var a=function(){var o=e.addOverBookingObj.roomTypeList;_.each(o,function(o){o.isChecked=e.addOverBookingObj.applyForRoomTypes})};e.clickedApplyForRoomTypes=function(){e.addOverBookingObj.applyForRoomTypes=!e.addOverBookingObj.applyForRoomTypes,a(),e.refreshScroller("roomTypeFilterList")},e.clickedRoomTypeCheckbox=function(o){var t=e.addOverBookingObj.roomTypeList[o];t.isChecked=!t.isChecked},e.clickedWeekDay=function(o){var t=e.addOverBookingObj.weekDayList[o];t.isChecked=!t.isChecked},r.getSelectedIdList=function(e){var o=[];return _.map(e,function(e){e.isChecked&&o.push(e.id)}),o},e.addOverBookingApiCall=function(){var t=function(){e.errorMessage="",e.$emit("REFRESH_OVERBOOKING_GRID"),e.closeDialog()},i=function(o){e.errorMessage=o},a=r.getSelectedIdList(e.addOverBookingObj.weekDayList),l={start_date:moment(tzIndependentDate(e.addOverBookingObj.fromDate)).format(o.momentFormatForAPI),end_date:moment(tzIndependentDate(e.addOverBookingObj.toDate)).format(o.momentFormatForAPI),house_overbooking:e.addOverBookingObj.applyForHouse,wdays_selected:a,room_type_ids:r.getSelectedIdList(e.addOverBookingObj.roomTypeList),limit:e.addOverBookingObj.limitValue};0===a.length?e.errorMessage=["Please select days to apply sell limit"]:e.addOverBookingObj.applyForHouse||e.addOverBookingObj.applyForRoomTypes?e.callAPI(n.addOrEditOverBooking,{successCallBack:t,failureCallBack:i,params:l}):e.errorMessage=["Please select House or Room Type(s)"]},e.closeDialog=function(){t.close()},r.init(),e.$on("$destroy",i)}]),angular.module("sntRover").controller("rvEditOverBookingPopupCtrl",["$scope","$rootScope","ngDialog","rvOverBookingSrv",function(e,o,t,n){e.editOverBookingApiCall=function(){var t=e.overBookingObj.editData,r=function(){e.errorMessage="",e.$emit("REFRESH_OVERBOOKING_GRID"),e.closeDialog()},i=function(o){e.errorMessage=o},a={start_date:moment(tzIndependentDate(t.date)).format(o.momentFormatForAPI),end_date:moment(tzIndependentDate(t.date)).format(o.momentFormatForAPI),house_overbooking:"HOUSE"===t.type,limit:t.limitValue};"ROOM_TYPE"===t.type&&(a.room_type_ids=[t.roomTypeId]),e.callAPI(n.addOrEditOverBooking,{successCallBack:r,failureCallBack:i,params:a})},e.closeDialog=function(){t.close()}}]),angular.module("sntRover").controller("rvOverBookingDatePickerCtrl",["$scope","$rootScope","ngDialog",function(e,o,t){var n=moment(tzIndependentDate(o.businessDate)).format(o.momentFormatForAPI);e.date=moment(tzIndependentDate(e.overBookingObj.startDate)).format(o.momentFormatForAPI),e.setUpData=function(){e.dateOptions={changeYear:!0,changeMonth:!0,minDate:tzIndependentDate(n),yearRange:"1:+5",onSelect:function(){e.overBookingObj.startDate=e.date,e.$emit("DATE_CHANGED"),t.close()}}},e.setUpData()}]),angular.module("sntRover").controller("RvOverBookingHeaderCtrl",["$scope","$rootScope","ngDialog","$timeout",function(e,o,t,n){BaseCtrl.call(this,e),e.setScroller("roomTypeFilterList"),e.businessDate=o.businessDate;var r=13;e.showDatePicker=function(){t.open({template:"/assets/partials/overBooking/rvOverBookingDatePicker.html",controller:"rvOverBookingDatePickerCtrl",className:"",scope:e,closeByDocument:!0})};var i=e.$on("DATE_CHANGED",function(){var t=e.overBookingObj.startDate;e.overBookingObj.endDate=moment(tzIndependentDate(t)).add(r,"d").format(o.momentFormatForAPI),e.$emit("REFRESH_OVERBOOKING_GRID")});e.clickedShowRoomsLeftTosell=function(){e.$emit("REFRESH_SCROLLBARS"),n(function(){e.overBookingObj.isShowRoomsLeftToSell=!e.overBookingObj.isShowRoomsLeftToSell,e.$emit("REFRESH_OVERBOOKING_GRID")},300)},e.clickedPrevDateButton=function(){var t=e.overBookingObj.startDate;e.overBookingObj.startDate=moment(tzIndependentDate(t)).add(-1*r,"d").format(o.momentFormatForAPI),e.overBookingObj.endDate=moment(tzIndependentDate(t)).format(o.momentFormatForAPI),e.$emit("REFRESH_OVERBOOKING_GRID")},e.clickedNextDateButton=function(){var t=e.overBookingObj.endDate;e.overBookingObj.startDate=moment(tzIndependentDate(t)).format(o.momentFormatForAPI),e.overBookingObj.endDate=moment(tzIndependentDate(t)).add(r,"d").format(o.momentFormatForAPI),e.$emit("REFRESH_OVERBOOKING_GRID")},e.toggleRoomTypeFilter=function(){e.overBookingObj.isShowRoomTypeFilter=!e.overBookingObj.isShowRoomTypeFilter,e.refreshScroller("roomTypeFilterList")},e.clickedRoomTypeCheckbox=function(o){var t=e.overBookingObj.roomTypeList[o];t.isChecked=!t.isChecked,e.$emit("REFRESH_OVERBOOKING_GRID")},e.disablePrevDateButton=function(){var t=moment(tzIndependentDate(o.businessDate)).add(r,"d"),n=moment(tzIndependentDate(e.overBookingObj.startDate)),i=!1;return t>n&&(i=!0),i};var a=function(){var o={count:0,lastItem:""};return _.map(e.overBookingObj.roomTypeList,function(e){e.isChecked&&(o.count++,o.lastItem=e.name)}),o};e.showRoomTypeSelectionStatus=function(){var o=e.overBookingObj.roomTypeList.length,t=a(),n="";return 0===t.count?n="NOT SHOWING":t.count===o?n="SHOW ALL":1===t.count?n=t.lastItem:t.count>0&&(n=t.count+" OF "+o+" SELECTED"),n},e.clickedAddOverBookingButton=function(){t.open({template:"/assets/partials/overBooking/rvAddOverBookingPopup.html",controller:"rvAddOverBookingPopupCtrl",className:"",scope:e,closeByDocument:!1})};var l=function(){$("#print-orientation").remove()},s=function(){n(function(){var e="landscape";$("head").append("<style id='print-orientation'>@page { size: "+e+"; }</style>"),n(function(){sntapp.cordovaLoaded?cordova.exec(l,function(){l()},"RVCardPlugin","printWebView",[]):(window.print(),l())},100)},250)};e.clickedPrintButton=function(){s()},e.$on("$destroy",i)}]),angular.module("sntRover").controller("RvOverBookingMainCtrl",["$scope","rvOverBookingSrv","$rootScope","ngDialog","$filter","$timeout","completeRoomTypeListData","overBookingGridData",function(e,o,t,n,r,i,a,l){BaseCtrl.call(this,e);var s=this,d="overBookingLeftSectionScroll",c="overBookingGridScroll",m="overBookingDateScroll",p=1e3,v=13,u=function(){e.setScroller(d,{preventDefault:!1,probeType:3}),e.setScroller(c,{preventDefault:!1,probeType:3,scrollX:!0}),e.setScroller(m,{preventDefault:!1,probeType:3,scrollX:!0,scrollY:!1})},O=function(){e.myScroll[d].on("scroll",function(){e.myScroll[c].scrollTo(0,this.y)}),e.myScroll[c].on("scroll",function(){e.myScroll[d].scrollTo(0,this.y)}),e.myScroll[m].on("scroll",function(){e.myScroll[c].scrollTo(this.x,0)}),e.myScroll[c].on("scroll",function(){e.myScroll[m].scrollTo(this.x,0)})},g=function o(){e.myScroll&&e.myScroll.hasOwnProperty(d)&&e.myScroll.hasOwnProperty(c)&&e.myScroll.hasOwnProperty(m)?O():i(o,p)},k=function(){e.myScroll.hasOwnProperty(d)&&e.refreshScroller(d),e.myScroll.hasOwnProperty(c)&&e.refreshScroller(c),e.myScroll.hasOwnProperty(m)&&e.refreshScroller(m)};s.init=function(){e.heading=r("translate")("MENU_SELL_LIMITS"),e.setTitle(r("translate")("MENU_SELL_LIMITS")),e.$emit("updateRoverLeftMenu","overbooking"),u(),g(),e.overBookingObj={roomTypeList:dclone(a.isCheckedTrue,[]),completeRoomTypeListData:dclone(a.isCheckedFalse,[]),overBookingGridData:l,startDate:moment(tzIndependentDate(t.businessDate)).format(t.momentFormatForAPI),endDate:moment(tzIndependentDate(t.businessDate)).add(v,"d").format(t.momentFormatForAPI),isShowRoomsLeftToSell:!0,isShowRoomTypeFilter:!1,editData:{}}},s.getSelectedRoomTypeIdList=function(){var o=[];return _.map(e.overBookingObj.roomTypeList,function(e){e.isChecked&&o.push(e.id)}),o};var D=function(){var n=function(o){e.overBookingObj.overBookingGridData=o,i(function(){k()},p)},r=function(o){e.$errorMessage=o},a={start_date:moment(tzIndependentDate(e.overBookingObj.startDate)).format(t.momentFormatForAPI),end_date:moment(tzIndependentDate(e.overBookingObj.endDate)).format(t.momentFormatForAPI),show_rooms_left_to_sell:e.overBookingObj.isShowRoomsLeftToSell,room_type_ids:s.getSelectedRoomTypeIdList()};e.callAPI(o.fetchOverBookingGridData,{successCallBack:n,failureCallBack:r,params:a})},f=e.$on("REFRESH_OVERBOOKING_GRID",function(){D()}),B=e.$on("REFRESH_SCROLLBARS",function(){i(function(){k()},p)});e.clickedEditOverBookingCell=function(o,t,r){e.overBookingObj.editData.type=o;var i=e.overBookingObj.overBookingGridData;"HOUSE"===o?(e.overBookingObj.editData.date=i.houseSellLimits[t].date,e.overBookingObj.editData.limitValue=i.houseSellLimits[t].sell_limit):"ROOM_TYPE"===o&&(e.overBookingObj.editData.date=i.roomTypeSellLimits[t].overbooking_details[r].date,e.overBookingObj.editData.roomTypeId=i.roomTypeSellLimits[t].id,e.overBookingObj.editData.roomTypeName=i.roomTypeSellLimits[t].name,e.overBookingObj.editData.limitValue=i.roomTypeSellLimits[t].overbooking_details[r].sell_limit),n.open({template:"/assets/partials/overBooking/rvEditOverBookingPopup.html",controller:"rvEditOverBookingPopupCtrl",className:"",scope:e,closeByDocument:!1})},e.$on("$destroy",f),e.$on("$destroy",B),s.init()}]),angular.module("sntRover").service("rvOverBookingSrv",["$q","rvBaseWebSrvV2","dateFilter",function(e,o,t){var n=this;n.gridDataForOverbooking={},n.getDateRange=function(e,o){for(var n=[],r=1*new tzIndependentDate(e),i=1*new tzIndependentDate(o);r<=i;r+=864e5){var a=new tzIndependentDate(r);n.push({date:t(a,"yyyy-MM-dd"),isWeekend:0===a.getDay()||6===a.getDay()})}return n},n.fetchOverBookingGridData=function(t){var r=t.start_date,i=t.end_date,a=e.defer(),l="/api/sell_limits/sell_limits";return o.postJSON(l,t).then(function(e){n.gridDataForOverbooking={houseSellLimits:e.house_sell_limits,roomTypeSellLimits:e.room_type_sell_limits,selectedRoomTypeNameList:_.pluck(e.room_type_sell_limits,"name"),dateRangeList:n.getDateRange(r,i)},a.resolve(n.gridDataForOverbooking)},function(e){a.reject(e)}),a.promise},n.getAllRoomTypes=function(){var t=e.defer(),n="/api/room_types.json?exclude_pseudo=true&exclude_suite=true",r=[],i=[];return o.getJSON(n).then(function(e){e.results&&e.results.length>0&&_.each(e.results,function(e){r.push(_.extend(_.pick(e,"name","id"),{isChecked:!0})),i.push(_.extend(_.pick(e,"name","id"),{isChecked:!1}))});var o={isCheckedTrue:r,isCheckedFalse:i};t.resolve(o)},function(e){t.reject(e)}),t.promise},n.addOrEditOverBooking=function(t){var n=e.defer(),r="/api/sell_limits";return o.postJSON(r,t).then(function(e){n.resolve(e)},function(e){n.reject(e)}),n.promise}}]);